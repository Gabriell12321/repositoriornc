(function(){'use strict';const CONFIG={API_BASE:'/api',RETRY_ATTEMPTS:2,RETRY_DELAY:500};try{const _origError=console.error.bind(console);const _origWarn=console.warn.bind(console);function _shouldSilence(args){const msg=args&&args.length?String(args[0]||''):'';return/attribute d:\s*expected number/i.test(msg)||/translatecontent\.js/i.test(msg)||(/jquery-3\.4\.1\.min\.js/i.test(msg)&&/attribute d/i.test(msg));}
console.error=function(...args){if(_shouldSilence(args))return;return _origError(...args);};console.warn=function(...args){if(_shouldSilence(args))return;return _origWarn(...args);};window.addEventListener('unhandledrejection',function(ev){try{const reason=ev&&(ev.reason||ev.detail);const msg=reason?String(reason):'';if(/attribute d:\s*expected number/i.test(msg)){ev.preventDefault();}}catch{}});}catch{}
window.addEventListener('error',function(event){if(event.filename&&(event.filename.includes('content.js')||event.filename.includes('extension')||event.filename.includes('chrome-extension'))){event.preventDefault();console.warn('Erro de extensão do navegador ignorado:',event.message);return false;}
try{const isJQueryFile=event.filename&&event.filename.toLowerCase().includes('jquery');const isForeignOrigin=event.filename&&typeof location!=='undefined'&&!event.filename.includes(location.host);const isSvgPathError=event.message&&event.message.toLowerCase().includes('attribute d: expected number');if(isSvgPathError||(isJQueryFile&&isForeignOrigin)){event.preventDefault();console.warn('Erro de terceiros ignorado:',event.message,'em',event.filename);return false;}}catch(e){}
console.warn('Erro capturado:',event.message);return false;});async function fetchWithRetry(url,options={},retries=CONFIG.RETRY_ATTEMPTS){for(let i=0;i<retries;i++){try{const response=await fetch(url,{credentials:'same-origin',...options});if(!response.ok){throw new Error(`HTTP ${response.status}: ${response.statusText}`);}
return response;}catch(error){if(i===retries-1){throw error;}
await new Promise(resolve=>setTimeout(resolve,CONFIG.RETRY_DELAY*(i+1)));}}}
function loadFormData(){try{const savedData=localStorage.getItem('rncFormData');if(savedData){const formData=JSON.parse(savedData);Object.keys(formData).forEach(key=>{const field=document.getElementById(key)||document.querySelector(`[name="${key}"]`);if(field){if(field.type==='checkbox'){field.checked=formData[key];}else{field.value=formData[key];}}});}}catch(error){console.warn('Erro ao carregar dados do formulário:',error);}}
function saveFormData(){try{const form=document.querySelector('form');if(!form)return;const formData={};const fields=form.querySelectorAll('input, textarea, select');fields.forEach(field=>{if(field.type==='checkbox'){formData[field.id]=field.checked;}else{formData[field.name||field.id]=field.value;}});localStorage.setItem('rncFormData',JSON.stringify(formData));}catch(error){console.warn('Erro ao salvar dados do formulário:',error);}}
async function loadUserInfo(){try{const response=await fetch(`${CONFIG.API_BASE}/user/info`,{credentials:'include'});if(response.status===401){const path=(location&&location.pathname)?location.pathname:'';if(path&&path!=='/'&&!/login/i.test(path)){window.location.href='/';}
return;}
const data=await response.json();if(data.success){const userArea=document.getElementById('userArea');if(userArea)userArea.style.display='block';const userName=document.getElementById('userName');const userDepartment=document.getElementById('userDepartment');if(userName)userName.textContent=data.user.name;if(userDepartment)userDepartment.textContent=data.user.department;try{const dcRaw=localStorage.getItem('dashboardCacheV1');const dc=dcRaw?JSON.parse(dcRaw):{};localStorage.setItem('dashboardCacheV1',JSON.stringify({...dc,user:data.user,ts:Date.now()}));}catch(e){}
const assinaturaGerente=document.getElementById('assinatura_gerente');const nomeResponsavel=document.getElementById('nome_responsavel');if(assinaturaGerente&&!assinaturaGerente.value){assinaturaGerente.value=data.user.name;}
if(nomeResponsavel&&!nomeResponsavel.value){nomeResponsavel.value=data.user.name;}
const dataEmissao=document.getElementById('data_emissao');if(dataEmissao&&!dataEmissao.value){const hoje=new Date();const dia=hoje.getDate().toString().padStart(2,'0');const mes=(hoje.getMonth()+1).toString().padStart(2,'0');const ano=hoje.getFullYear();dataEmissao.value=`${dia}/${mes}/${ano}`;}
const areaResponsavel=document.getElementById('area_responsavel');if(areaResponsavel&&!areaResponsavel.value){areaResponsavel.value=data.user.department;}
loadUserRNCs();}else{const path=(location&&location.pathname)?location.pathname:'';if(path&&path!=='/'&&!/login/i.test(path)){window.location.href='/';}}}catch(error){console.warn('Erro ao carregar informações do usuário:',error);}}
async function loadUserRNCs(){try{const response=await fetchWithRetry(`${CONFIG.API_BASE}/rnc/list`);const data=await response.json();if(data.success){const rncCount=data.rncs.length;const userRNCs=document.getElementById('userRNCs');if(userRNCs)userRNCs.textContent=`${rncCount} RNC(s) criado(s)`;}}catch(error){console.warn('Erro ao carregar RNCs do usuário:',error);}}
document.addEventListener('DOMContentLoaded',function(){try{loadFormData();if(document.getElementById('userArea')||document.getElementById('userName')||/dashboard/i.test(document.title)){loadUserInfo();}
document.addEventListener('input',saveFormData);document.addEventListener('change',saveFormData);}catch(error){console.warn('Erro ao inicializar aplicação:',error);}});window.IPPELApp={loadFormData,saveFormData,loadUserInfo,loadUserRNCs,fetchWithRetry};})();