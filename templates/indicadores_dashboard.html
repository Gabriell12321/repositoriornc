<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IPPEL - Indicadores de N√£o Conformidades e Garantias</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'Noto Sans', 'Liberation Sans', sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji';
            background: #f8fafc;
            color: #1e293b;
            line-height: 1.6;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 0;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .logo {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            object-fit: cover;
            background: white;
            padding: 8px;
        }

        .header-title {
            flex: 1;
        }

        .header-title h1 {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .header-title p {
            opacity: 0.9;
            font-size: 16px;
        }

        .back-button {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
        }

        .back-button:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-2px);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 30px 20px;
        }

        .controls {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 15px;
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .filter-group label {
            font-weight: 600;
            color: #475569;
        }

        .filter-group select,
        .filter-group input {
            padding: 8px 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .filter-group select:focus,
        .filter-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .refresh-button {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .refresh-button:hover {
            background: #5a67d8;
            transform: translateY(-2px);
        }
        
        .btn-filter {
            background: #e2e8f0;
            color: #475569;
            border: none;
            padding: 8px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s ease;
        }
        
        .btn-filter:hover {
            background: #cbd5e1;
        }
        
        .btn-filter.active {
            background: #dc2626;
            color: white;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .chart-container {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            position: relative;
        }

        .chart-header {
            background: #dc2626;
            color: white;
            padding: 15px 20px;
            margin: -25px -25px 20px -25px;
            border-radius: 12px 12px 0 0;
            font-weight: 600;
            font-size: 16px;
        }

        .chart-canvas {
            position: relative;
            height: 400px;
        }

        .chart-canvas canvas {
            max-height: 100%;
        }

        .summary-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        }

        .summary-header {
            color: #1e293b;
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 20px;
            text-align: center;
        }

        .kpi-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 25px;
        }

        .kpi-item {
            text-align: center;
            padding: 15px;
            border-radius: 8px;
            background: #f8fafc;
        }

        .kpi-value {
            font-size: 24px;
            font-weight: 700;
            color: #dc2626;
        }

        .kpi-label {
            font-size: 12px;
            color: #64748b;
            margin-top: 4px;
        }

        .department-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #e2e8f0;
        }

        .department-item:last-child {
            border-bottom: none;
        }

        .department-name {
            font-weight: 600;
            color: #374151;
        }

        .department-value {
            font-weight: 700;
            color: #dc2626;
        }

        .data-table {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            overflow-x: auto;
        }

        .data-table h3 {
            color: #1e293b;
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 20px;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        .table th {
            background: #f1f5f9;
            padding: 12px 8px;
            text-align: center;
            font-weight: 600;
            color: #475569;
            border: 1px solid #e2e8f0;
        }

        .table td {
            padding: 10px 8px;
            text-align: center;
            border: 1px solid #e2e8f0;
        }

        .table tbody tr:hover {
            background: #f8fafc;
        }

        .value-positive {
            color: #059669;
            font-weight: 600;
        }

        .value-negative {
            color: #dc2626;
            font-weight: 600;
        }

        .value-neutral {
            color: #6b7280;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e2e8f0;
            border-radius: 10px;
            overflow: hidden;
            margin-top: 8px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #dc2626 0%, #ef4444 100%);
            transition: width 0.8s ease;
        }

        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 60px;
            color: #64748b;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #e2e8f0;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .no-data {
            text-align: center;
            padding: 60px 20px;
            color: #64748b;
        }

        .no-data i {
            font-size: 48px;
            margin-bottom: 15px;
            display: block;
        }

        @media (max-width: 1024px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                text-align: center;
                gap: 15px;
            }

            .controls {
                flex-direction: column;
                align-items: stretch;
            }

            .kpi-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Responsividade da tabela */
        @media (max-width: 600px) {
            .table {
                font-size: 11px;
            }
            
            .table th,
            .table td {
                padding: 6px 4px;
            }
        }

        /* Estilo especial para gr√°fico de rosca */
        .donut-chart-container {
            position: relative;
            width: 100%;
            height: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .accumulated-chart {
            height: 200px;
        }

        /* Painel de Setores */
        .sector-panel {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        }

        .sector-panel h3 {
            color: #1e293b;
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 15px;
            text-align: center;
        }

        .sector-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .sector-button {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            border: 2px solid #e2e8f0;
            color: #475569;
            padding: 15px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            text-align: center;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .sector-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .sector-button.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
        }

        .sector-button.engenharia {
            border-left: 4px solid #3b82f6;
        }

        .sector-button.producao {
            border-left: 4px solid #10b981;
        }

        .sector-button.suprimentos {
            border-left: 4px solid #f59e0b;
        }

        .sector-button.pcp {
            border-left: 4px solid #ef4444;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content" style="display:flex;align-items:center;gap:12px;">
            <img src="{{ url_for('static', filename='LOGOSQI.jpg') }}" alt="SQI Logo" class="logo">
            <img src="/IPPELLOGO.jpg" alt="IPPEL Logo" class="logo apply-logo"
                 data-logo-primary="/IPPELLOGO.jpg"
                 data-logo-fallback1="/IPPELLOGO.jpg"
                 data-logo-fallback2="{{ url_for('static', filename='LOGOSQI.jpg') }}"
                 onerror="if(this.dataset.try1!=='1'){this.dataset.try1='1'; this.src=this.dataset.logoFallback1;} else if(this.dataset.try2!=='1'){this.dataset.try2='1'; this.src=this.dataset.logoFallback2;} else {this.style.display='none';}">
            <div class="header-title">
                <h1>Evid√™ncias Indicadores <span id="headerTitle">RNC - Relat√≥rio de N√£o Conformidade</span></h1>
                <p>Monitoramento e an√°lise em tempo real</p>
            </div>
            <a href="/dashboard" class="back-button">
                ‚Üê Voltar ao Dashboard
            </a>
        </div>
    </header>

    <div class="container">
        <!-- Painel de Setores -->
        <div class="sector-panel">
            <h3>Selecionar Setor</h3>
            <div class="sector-buttons">
                <button class="sector-button engenharia active" onclick="selectSector('ENGENHARIA', this)">
                    üîß ENGENHARIA
                </button>
                <button class="sector-button producao" onclick="selectSector('PRODU√á√ÉO', this)">
                    üè≠ PRODU√á√ÉO
                </button>
                <button class="sector-button suprimentos" onclick="selectSector('SUPRIMENTOS', this)">
                    üì¶ SUPRIMENTOS
                </button>
                <button class="sector-button pcp" onclick="selectSector('PCP', this)">
                    üìã PCP
                </button>
            </div>
        </div>

        <!-- Controles -->
        <div class="controls">
            <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                <div class="filter-group">
                    <label>Departamento:</label>
                    <select id="departmentFilter">
                        <option value="">Todos</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Ano:</label>
                    <select id="yearFilter">
                        <option value="2024">2024</option>
                        <option value="2023">2023</option>
                        <option value="">Todos</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Respons√°vel:</label>
                    <select id="responsibleFilter">
                        <option value="">Todos</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Tipo:</label>
                    <div style="display: flex; gap: 8px;">
                        <button id="rncFilterBtn" class="btn-filter active" onclick="setDataTypeFilter('rnc')">RNC</button>
                        <button id="garantiaFilterBtn" class="btn-filter" onclick="setDataTypeFilter('garantia')">Garantia</button>
                    </div>
                </div>
            </div>
            <button class="refresh-button" onclick="refreshData()">
                üîÑ Atualizar Dados
            </button>
        </div>

        <!-- Grid Principal -->
        <div class="main-grid">
            <!-- Gr√°fico Principal (Lado Esquerdo) -->
            <div class="chart-container">
                <div class="chart-header">
                    RNC - RELAT√ìRIO DE N√ÉO CONFORMIDADES
                </div>
                <div style="margin-bottom: 20px; font-size: 14px; color: #64748b;">
                    <strong>APONTAR QUANTIDADE DE N√ÉO CONFORMIDADE E ESTRAT√âGICOS</strong>
                </div>
                <div class="chart-canvas">
                    <canvas id="mainChart"></canvas>
                </div>
            </div>

            <!-- Resumo Lateral (Lado Direito) -->
            <div class="summary-card">
                <div class="summary-header">TOTAL</div>
                
                <!-- KPIs Principais -->
                <div class="kpi-grid">
                    <div class="kpi-item">
                        <div class="kpi-value" id="metaValue">15,00</div>
                        <div class="kpi-label">META</div>
                    </div>
                    <div class="kpi-item">
                        <div class="kpi-value" id="realizadoValue">6,33</div>
                        <div class="kpi-label">REALIZADO</div>
                    </div>
                    <div class="kpi-item">
                        <div class="kpi-value" id="variacaoValue">8,67</div>
                        <div class="kpi-label">VARIA√á√ÉO</div>
                    </div>
                    <div class="kpi-item">
                        <div class="kpi-value" id="acumuladoValue">15</div>
                        <div class="kpi-label">ACUMULADO</div>
                    </div>
                </div>

                <!-- Lista de Departamentos -->
                <div class="department-list" id="departmentList">
                    <!-- Ser√° preenchido dinamicamente -->
                </div>

                <!-- Gr√°fico de Rosca Acumulado -->
                <div style="margin-top: 25px;">
                    <div style="text-align: center; font-weight: 600; margin-bottom: 15px; color: #374151;">
                        ACUMULADO
                    </div>
                    <div class="donut-chart-container accumulated-chart">
                        <canvas id="accumulatedChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Grid Secund√°rio com Gr√°ficos Adicionais -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 30px;">
            <!-- Gr√°fico de Tend√™ncias Mensais -->
            <div class="chart-container">
                <div class="chart-header">
                    üìà Tend√™ncias Mensais
                </div>
                <div class="chart-canvas">
                    <canvas id="trendsChart"></canvas>
                </div>
            </div>
            
            <!-- Gr√°fico de Distribui√ß√£o -->
            <div class="chart-container">
                <div class="chart-header">
                    üìä Distribui√ß√£o de Metas vs Realizados
                </div>
                <div class="chart-canvas">
                    <canvas id="distributionChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Grid Terci√°rio -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 30px;">
            <!-- Gr√°fico de Efici√™ncia -->
            <div class="chart-container">
                <div class="chart-header">
                    ‚ö° Efici√™ncia por Departamento
                </div>
                <div class="chart-canvas">
                    <canvas id="efficiencyChart"></canvas>
                </div>
            </div>
            
            <!-- Ranking de Departamentos -->
            <div class="chart-container">
                <div class="chart-header">
                    üèÜ Ranking de Departamentos
                </div>
                <div class="chart-canvas">
                    <canvas id="rankingChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Estat√≠sticas Detalhadas -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 30px;">
            <!-- Resumo Geral -->
            <div class="summary-card">
                <div class="summary-header">üìã Resumo Geral</div>
                <div id="generalSummary">
                    <div class="department-item">
                        <span class="department-name">Total de Departamentos:</span>
                        <span class="department-value" id="totalDepartments">0</span>
                    </div>
                    <div class="department-item">
                        <span class="department-name">Total de Metas:</span>
                        <span class="department-value" id="totalMetas">0</span>
                    </div>
                    <div class="department-item">
                        <span class="department-name">Total Realizado:</span>
                        <span class="department-value" id="totalRealizado">0</span>
                    </div>
                    <div class="department-item">
                        <span class="department-name">Efici√™ncia M√©dia:</span>
                        <span class="department-value" id="avgEfficiency">N/A%</span>
                    </div>
                </div>
            </div>
            
            <!-- Performance -->
            <div class="summary-card">
                <div class="summary-header">üéØ Performance</div>
                <div id="performanceSummary">
                    <div class="department-item">
                        <span class="department-name">Melhor Depto:</span>
                        <span class="department-value" id="bestDepartment">N/A</span>
                    </div>
                    <div class="department-item">
                        <span class="department-name">Pior Depto:</span>
                        <span class="department-value" id="worstDepartment">N/A</span>
                    </div>
                    <div class="department-item">
                        <span class="department-name">Varia√ß√£o:</span>
                        <span class="department-value" id="performanceVariation">0%</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabela de Dados Detalhados -->
        <div class="data-table">
            <h3>üìä Dados Detalhados por Per√≠odo</h3>
            <table class="table">
                <thead>
                    <tr>
                        <th>JAN</th>
                        <th>FEV</th>
                        <th>MAR</th>
                        <th>ABR</th>
                        <th>MAI</th>
                        <th>JUN</th>
                        <th>JUL</th>
                        <th>AGO</th>
                        <th>SET</th>
                        <th>OUT</th>
                        <th>NOV</th>
                        <th>DEZ</th>
                        <th>ACUMULADO</th>
                        <th>TOTAL</th>
                    </tr>
                </thead>
                <tbody id="dataTableBody">
                    <!-- Ser√° preenchido dinamicamente -->
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // Vari√°veis globais
        let mainChart = null;
        let accumulatedChart = null;
        let currentData = null;
        let currentDataType = 'rnc'; // 'rnc' ou 'garantia'

        // Configura√ß√£o do Chart.js
        Chart.register(ChartDataLabels);

        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Iniciando p√°gina de indicadores...');
            
            // Verificar se elementos existem
            const mainChartEl = document.getElementById('mainChart');
            const metaValueEl = document.getElementById('metaValue');
            
            if (!mainChartEl) {
                console.error('‚ùå Elemento mainChart n√£o encontrado!');
                return;
            }
            
            if (!metaValueEl) {
                console.error('‚ùå Elemento metaValue n√£o encontrado!');
                return;
            }
            
            console.log('‚úÖ Elementos encontrados, carregando dados...');
            
            try {
                loadFallbackData(); // Carregar dados padr√£o primeiro
                setupEventListeners();
                console.log('‚úÖ Dados carregados e eventos configurados');
            } catch (error) {
                console.error('‚ùå Erro na inicializa√ß√£o:', error);
            }
        });

        function setupEventListeners() {
            document.getElementById('departmentFilter').addEventListener('change', filterData);
            document.getElementById('yearFilter').addEventListener('change', filterData);
            document.getElementById('responsibleFilter').addEventListener('change', filterData);
        }
        
        function setDataTypeFilter(type) {
            if (currentDataType === type) return; // No change needed
            
            currentDataType = type;
            
            // Update button states
            document.getElementById('rncFilterBtn').classList.toggle('active', type === 'rnc');
            document.getElementById('garantiaFilterBtn').classList.toggle('active', type === 'garantia');
            
            // Reload data with the new filter
            refreshData();
        }

        async function loadData() {
            try {
                showLoading();
                
                const response = await fetch(`/api/indicadores-detalhados?tipo=${currentDataType}`);
                const data = await response.json();
                
                currentData = data;
                updateDashboard(data);
                hideLoading();
                
            } catch (error) {
                console.error('Erro ao carregar dados:', error);
                hideLoading();
                loadFallbackData();
            }
        }

        function loadFallbackData() {
            console.log('üìä Carregando dados de fallback...');
            // Dados baseados na imagem fornecida
            const fallbackData = {
                totals: {
                    meta: 15.00,
                    realizado: 6.33,
                    variacao: 8.67,
                    acumulado: 15
                },
                departments: [
                    { name: '√ÅREA CORPORATIVO', realizado: 5, meta: 12 },
                    { name: 'CONTROLE', realizado: 13, meta: 15 },
                    { name: 'ALAN', realizado: 6, meta: 8 },
                    { name: 'MARCELO', realizado: 6, meta: 10 }
                ],
                monthlyData: [
                    { month: 'JAN', meta: 15, realizado: 0, acumulado: 0 },
                    { month: 'FEV', meta: 15, realizado: 0, acumulado: 0 },
                    { month: 'MAR', meta: 15, realizado: 0, acumulado: 0 },
                    { month: 'ABR', meta: 15, realizado: 0, acumulado: 0 },
                    { month: 'MAI', meta: 15, realizado: 0, acumulado: 0 },
                    { month: 'JUN', meta: 15, realizado: 5, acumulado: 5 },
                    { month: 'JUL', meta: 15, realizado: 12, acumulado: 17 },
                    { month: 'AGO', meta: 15, realizado: 13, acumulado: 30 },
                    { month: 'SET', meta: 15, realizado: 0, acumulado: 30 },
                    { month: 'OUT', meta: 15, realizado: 0, acumulado: 30 },
                    { month: 'NOV', meta: 15, realizado: 0, acumulado: 30 },
                    { month: 'DEZ', meta: 15, realizado: 0, acumulado: 30 }
                ]
            };

            currentData = fallbackData;
            updateDashboard(fallbackData);
        }

        function updateDashboard(data) {
            // Atualizar t√≠tulo baseado no tipo de dados atual
            const headerTitle = document.getElementById('headerTitle');
            if (headerTitle) {
                if (currentDataType === 'rnc') {
                    headerTitle.textContent = 'RNC - Relat√≥rio de N√£o Conformidade';
                } else {
                    headerTitle.textContent = 'Garantia';
                }
            }
            
            updateKPIs(data.totals);
            updateDepartmentList(data.departments);
            createMainChart(data.monthlyData);
            createAccumulatedChart(data);
            
            // Criar todos os novos gr√°ficos
            createTrendsChart(data);
            createDistributionChart(data);
            createEfficiencyChart(data);
            createRankingChart(data);
            
            updateDataTable(data.monthlyData);
            populateFilters(data);
            
            // Atualizar estat√≠sticas resumo
            updateSummaryStats(data);
        }

        function updateKPIs(totals) {
            console.log('üìà Atualizando KPIs...', totals);
            
            const metaEl = document.getElementById('metaValue');
            const realizadoEl = document.getElementById('realizadoValue');
            const variacaoEl = document.getElementById('variacaoValue');
            const acumuladoEl = document.getElementById('acumuladoValue');
            
            if (metaEl) metaEl.textContent = totals.meta.toFixed(2);
            if (realizadoEl) realizadoEl.textContent = totals.realizado.toFixed(2);
            if (variacaoEl) variacaoEl.textContent = totals.variacao.toFixed(2);
            if (acumuladoEl) acumuladoEl.textContent = totals.acumulado;
            
            console.log('‚úÖ KPIs atualizados');
        }

        function updateDepartmentList(departments) {
            const container = document.getElementById('departmentList');
            container.innerHTML = '';

            departments.forEach(dept => {
                const item = document.createElement('div');
                item.className = 'department-item';
                item.innerHTML = `
                    <span class="department-name">${dept.name}</span>
                    <span class="department-value">${dept.realizado}</span>
                `;
                container.appendChild(item);
            });
        }

        function createMainChart(monthlyData) {
            console.log('üìä Criando gr√°fico principal...', monthlyData);
            
            const chartElement = document.getElementById('mainChart');
            if (!chartElement) {
                console.error('‚ùå Elemento mainChart n√£o encontrado!');
                return;
            }
            
            const ctx = chartElement.getContext('2d');
            
            if (mainChart) {
                mainChart.destroy();
            }

            const months = monthlyData.map(d => d.month);
            const realizadoData = monthlyData.map(d => d.realizado);
            const metaData = monthlyData.map(d => d.meta);

            try {
                mainChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: months,
                        datasets: [
                            {
                                label: 'REALIZADO 1¬∫ QZ',
                                data: realizadoData,
                                backgroundColor: '#93c5fd',
                                borderColor: '#3b82f6',
                                borderWidth: 1
                            },
                            {
                                label: 'REALIZADO 2¬∫ QZ',
                                data: realizadoData.map(v => v * 0.8),
                                backgroundColor: '#1e40af',
                                borderColor: '#1e3a8a',
                                borderWidth: 1
                            },
                            {
                                label: 'META 2025',
                                data: metaData,
                                type: 'line',
                                borderColor: '#dc2626',
                                backgroundColor: 'transparent',
                                borderWidth: 3,
                                pointBackgroundColor: '#dc2626',
                                pointBorderColor: '#dc2626',
                                pointRadius: 5
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: false
                            },
                            legend: {
                                display: true,
                                position: 'bottom'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: Math.max(...metaData) + 5
                            }
                        }
                    }
                });
                
                console.log('‚úÖ Gr√°fico principal criado');
            } catch (error) {
                console.error('‚ùå Erro ao criar gr√°fico:', error);
            }
        }

        function createAccumulatedChart(data) {
            console.log('üìä Criando gr√°fico acumulado...', data);
            
            const chartElement = document.getElementById('accumulatedChart');
            if (!chartElement) {
                console.error('‚ùå Elemento accumulatedChart n√£o encontrado!');
                return;
            }
            
            const ctx = chartElement.getContext('2d');
            
            if (accumulatedChart) {
                accumulatedChart.destroy();
            }

            const total = data.totals.acumulado;
            const realizado = data.totals.realizado;
            const restante = total - realizado;

            try {
                accumulatedChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Realizado', 'Restante'],
                        datasets: [{
                            data: [realizado, restante],
                            backgroundColor: ['#dc2626', '#e5e7eb'],
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        cutout: '70%',
                        plugins: {
                            legend: {
                                display: false
                            }
                        }
                    }
                });
                
                console.log('‚úÖ Gr√°fico acumulado criado');
            } catch (error) {
                console.error('‚ùå Erro ao criar gr√°fico acumulado:', error);
            }
        }

        function createTrendsChart(data) {
            console.log('üìà Criando gr√°fico de tend√™ncias...');
            
            const chartElement = document.getElementById('trendsChart');
            if (!chartElement) {
                console.error('‚ùå Elemento trendsChart n√£o encontrado!');
                return;
            }
            
            const ctx = chartElement.getContext('2d');
            
            if (window.trendsChart) {
                window.trendsChart.destroy();
            }

            const months = data.monthlyData.map(d => d.month);
            const rncData = data.monthlyData.map(d => d.realizado / 15 * 100); // Convertendo para percentual

            try {
                window.trendsChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: months,
                        datasets: [{
                            label: 'RNCs por M√™s',
                            data: rncData,
                            borderColor: '#4facfe',
                            backgroundColor: 'rgba(79, 172, 254, 0.1)',
                            fill: true,
                            tension: 0.4,
                            pointBackgroundColor: '#4facfe',
                            pointBorderColor: '#fff',
                            pointRadius: 5
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100
                            }
                        }
                    }
                });
                
                console.log('‚úÖ Gr√°fico de tend√™ncias criado');
            } catch (error) {
                console.error('‚ùå Erro ao criar gr√°fico de tend√™ncias:', error);
            }
        }

        function createDistributionChart(data) {
            console.log('üìä Criando gr√°fico de distribui√ß√£o...');
            
            const chartElement = document.getElementById('distributionChart');
            if (!chartElement) {
                console.error('‚ùå Elemento distributionChart n√£o encontrado!');
                return;
            }
            
            const ctx = chartElement.getContext('2d');
            
            if (window.distributionChart) {
                window.distributionChart.destroy();
            }

            try {
                window.distributionChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['Meta', 'Realizado'],
                        datasets: [{
                            label: 'Valores',
                            data: [data.totals.meta, data.totals.realizado],
                            backgroundColor: ['#93c5fd', '#dc2626'],
                            borderColor: ['#3b82f6', '#b91c1c'],
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
                
                console.log('‚úÖ Gr√°fico de distribui√ß√£o criado');
            } catch (error) {
                console.error('‚ùå Erro ao criar gr√°fico de distribui√ß√£o:', error);
            }
        }

        function createEfficiencyChart(data) {
            console.log('‚ö° Criando gr√°fico de efici√™ncia...');
            
            const chartElement = document.getElementById('efficiencyChart');
            if (!chartElement) {
                console.error('‚ùå Elemento efficiencyChart n√£o encontrado!');
                return;
            }
            
            const ctx = chartElement.getContext('2d');
            
            if (window.efficiencyChart) {
                window.efficiencyChart.destroy();
            }

            const departments = data.departments.map(d => d.name);
            const efficiency = data.departments.map(d => (d.realizado / 15 * 100).toFixed(1)); // Simulando efici√™ncia

            try {
                window.efficiencyChart = new Chart(ctx, {
                    type: 'radar',
                    data: {
                        labels: departments,
                        datasets: [{
                            label: 'Efici√™ncia (%)',
                            data: efficiency,
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.2)',
                            pointBackgroundColor: '#10b981',
                            pointBorderColor: '#fff',
                            pointRadius: 6
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            r: {
                                beginAtZero: true,
                                max: 100
                            }
                        }
                    }
                });
                
                console.log('‚úÖ Gr√°fico de efici√™ncia criado');
            } catch (error) {
                console.error('‚ùå Erro ao criar gr√°fico de efici√™ncia:', error);
            }
        }

        function createRankingChart(data) {
            console.log('üèÜ Criando gr√°fico de ranking...');
            
            const chartElement = document.getElementById('rankingChart');
            if (!chartElement) {
                console.error('‚ùå Elemento rankingChart n√£o encontrado!');
                return;
            }
            
            const ctx = chartElement.getContext('2d');
            
            if (window.rankingChart) {
                window.rankingChart.destroy();
            }

            // Ordenar departamentos por realizado
            const sortedDepts = [...data.departments].sort((a, b) => b.realizado - a.realizado);
            const departments = sortedDepts.map(d => d.name);
            const values = sortedDepts.map(d => d.realizado);

            try {
                // Chart.js v3+ n√£o suporta mais 'horizontalBar'; usar bar + indexAxis:'y'
                window.rankingChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: departments,
                        datasets: [{
                            label: 'RNCs',
                            data: values,
                            backgroundColor: ['#ffd700', '#c0c0c0', '#cd7f32', '#667eea'],
                            borderColor: ['#ffed4e', '#d4d4d4', '#e68900', '#5a67d8'],
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        indexAxis: 'y',
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            x: {
                                beginAtZero: true
                            }
                        }
                    }
                });
                
                console.log('‚úÖ Gr√°fico de ranking criado');
            } catch (error) {
                console.error('‚ùå Erro ao criar gr√°fico de ranking:', error);
            }
        }

        function updateSummaryStats(data) {
            console.log('üìä Atualizando estat√≠sticas resumo...');
            
            // Resumo Geral
            const totalDepartments = data.departments.length;
            const totalMetas = data.departments.reduce((sum, d) => sum + d.meta, 0);
            const totalRealizado = data.departments.reduce((sum, d) => sum + d.realizado, 0);
            const avgEfficiency = totalMetas > 0 ? (totalRealizado / totalMetas * 100).toFixed(1) : 0;
            
            document.getElementById('totalDepartments').textContent = totalDepartments;
            document.getElementById('totalMetas').textContent = totalMetas;
            document.getElementById('totalRealizado').textContent = totalRealizado;
            document.getElementById('avgEfficiency').textContent = avgEfficiency + '%';
            
            // Performance
            const sortedDepts = [...data.departments].sort((a, b) => b.realizado - a.realizado);
            const bestDept = sortedDepts[0]?.name || 'N/A';
            const worstDept = sortedDepts[sortedDepts.length - 1]?.name || 'N/A';
            const variation = data.totals.variacao ? data.totals.variacao.toFixed(1) + '%' : '0%';
            
            document.getElementById('bestDepartment').textContent = bestDept;
            document.getElementById('worstDepartment').textContent = worstDept;
            document.getElementById('performanceVariation').textContent = variation;
            
            console.log('‚úÖ Estat√≠sticas resumo atualizadas');
        }

        function updateDataTable(monthlyData) {
            const tbody = document.getElementById('dataTableBody');
            tbody.innerHTML = '';

            // Linha de Metas
            const metaRow = document.createElement('tr');
            metaRow.innerHTML = `
                ${monthlyData.map(d => `<td class="value-neutral">${d.meta}</td>`).join('')}
                <td class="value-neutral">${monthlyData.reduce((sum, d) => sum + d.meta, 0)}</td>
                <td class="value-neutral">${monthlyData.reduce((sum, d) => sum + d.meta, 0)}</td>
            `;
            tbody.appendChild(metaRow);

            // Linha de Realizados
            const realizadoRow = document.createElement('tr');
            realizadoRow.innerHTML = `
                ${monthlyData.map(d => `<td class="${d.realizado > 0 ? 'value-positive' : 'value-neutral'}">${d.realizado}</td>`).join('')}
                <td class="value-positive">${monthlyData.reduce((sum, d) => sum + d.realizado, 0)}</td>
                <td class="value-positive">${monthlyData.reduce((sum, d) => sum + d.realizado, 0)}</td>
            `;
            tbody.appendChild(realizadoRow);

            // Linha de Acumulado
            const acumuladoRow = document.createElement('tr');
            let acumulado = 0;
            acumuladoRow.innerHTML = `
                ${monthlyData.map(d => {
                    acumulado += d.realizado;
                    return `<td class="value-neutral">${acumulado}</td>`;
                }).join('')}
                <td class="value-neutral">${acumulado}</td>
                <td class="value-neutral">${acumulado}</td>
            `;
            tbody.appendChild(acumuladoRow);
        }

        function populateFilters(data) {
            // Preencher filtro de departamentos
            const deptFilter = document.getElementById('departmentFilter');
            deptFilter.innerHTML = '<option value="">Todos</option>';
            
            if (data.departments) {
                data.departments.forEach(dept => {
                    const option = document.createElement('option');
                    option.value = dept.name;
                    option.textContent = dept.name;
                    deptFilter.appendChild(option);
                });
            }

            // Preencher filtro de respons√°veis (se houver dados)
            const respFilter = document.getElementById('responsibleFilter');
            respFilter.innerHTML = '<option value="">Todos</option>';
            // Adicionar respons√°veis quando dispon√≠veis
        }

        function filterData() {
            // Implementar filtros quando necess√°rio
            console.log('Aplicando filtros...');
        }

        function refreshData() {
            loadData();
        }

        function setDataTypeFilter(type) {
            console.log(`üîÑ Alterando tipo de dados para: ${type}`);
            
            // Atualizar o tipo atual
            currentDataType = type;
            
            // Atualizar estado visual dos bot√µes
            document.getElementById('rncFilterBtn').classList.toggle('active', type === 'rnc');
            document.getElementById('garantiaFilterBtn').classList.toggle('active', type === 'garantia');
            
            // Recarregar dados com o novo tipo
            loadData();
        }

        function showLoading() {
            // Implementar loading se necess√°rio
        }

        function hideLoading() {
            // Implementar loading se necess√°rio
        }

        // Fun√ß√£o para exportar dados
        function exportData() {
            if (!currentData) return;
            
            // Implementar exporta√ß√£o CSV/Excel
            console.log('Exportando dados...', currentData);
        }

        // Fun√ß√£o para selecionar setor
        function selectSector(sectorName, buttonElement) {
            // Remover active de todos os bot√µes
            document.querySelectorAll('.sector-button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Adicionar active ao bot√£o clicado
            buttonElement.classList.add('active');
            
            // Atualizar dados baseado no setor selecionado
            console.log('Setor selecionado:', sectorName);
            
            // Aqui voc√™ pode implementar a l√≥gica para filtrar dados por setor
            // Por exemplo, chamar uma API espec√≠fica do setor
            loadSectorData(sectorName);
        }

        // Fun√ß√£o para carregar dados espec√≠ficos do setor
        async function loadSectorData(sector) {
            try {
                showLoading();
                
                // Chamar API com filtro de setor e tipo
                const response = await fetch(`/api/indicadores?sector=${encodeURIComponent(sector)}&tipo=${currentDataType}`);
                if (response.ok) {
                    const data = await response.json();
                    updateDashboard(data);
                } else {
                    console.log('Erro ao carregar dados do setor, usando dados padr√£o');
                    loadFallbackDataForSector(sector);
                }
            } catch (error) {
                console.error('Erro ao buscar dados do setor:', error);
                loadFallbackDataForSector(sector);
            } finally {
                hideLoading();
            }
        }

        // Dados de fallback espec√≠ficos para cada setor
        function loadFallbackDataForSector(sector) {
            let sectorData;
            
            switch(sector) {
                case 'ENGENHARIA':
                    sectorData = {
                        monthly: [
                            {month: 'JAN', meta: 15, realizado: 0, accumulated: 0},
                            {month: 'FEV', meta: 15, realizado: 0, accumulated: 0},
                            {month: 'MAR', meta: 15, realizado: 0, accumulated: 0},
                            {month: 'ABR', meta: 15, realizado: 0, accumulated: 0},
                            {month: 'MAI', meta: 15, realizado: 0, accumulated: 0},
                            {month: 'JUN', meta: 15, realizado: 5, accumulated: 5},
                            {month: 'JUL', meta: 15, realizado: 12, accumulated: 17},
                            {month: 'AGO', meta: 15, realizado: 0, accumulated: 17},
                            {month: 'SET', meta: 15, realizado: 0, accumulated: 17},
                            {month: 'OUT', meta: 15, realizado: 0, accumulated: 17},
                            {month: 'NOV', meta: 15, realizado: 0, accumulated: 17},
                            {month: 'DEZ', meta: 15, realizado: 0, accumulated: 17}
                        ],
                        departments: [
                            {name: 'ENGENHARIA', count: 17}
                        ],
                        totals: {
                            meta_total: 180,
                            realizado_total: 17,
                            acumulado: 17,
                            variacao: 8.67
                        }
                    };
                    break;
                case 'PRODU√á√ÉO':
                    sectorData = {
                        monthly: [
                            {month: 'JAN', meta: 10, realizado: 0, accumulated: 0},
                            {month: 'FEV', meta: 10, realizado: 2, accumulated: 2},
                            {month: 'MAR', meta: 10, realizado: 3, accumulated: 5},
                            {month: 'ABR', meta: 10, realizado: 1, accumulated: 6},
                            {month: 'MAI', meta: 10, realizado: 4, accumulated: 10},
                            {month: 'JUN', meta: 10, realizado: 2, accumulated: 12},
                            {month: 'JUL', meta: 10, realizado: 5, accumulated: 17},
                            {month: 'AGO', meta: 10, realizado: 3, accumulated: 20},
                            {month: 'SET', meta: 10, realizado: 0, accumulated: 20},
                            {month: 'OUT', meta: 10, realizado: 0, accumulated: 20},
                            {month: 'NOV', meta: 10, realizado: 0, accumulated: 20},
                            {month: 'DEZ', meta: 10, realizado: 0, accumulated: 20}
                        ],
                        departments: [
                            {name: 'PRODU√á√ÉO', count: 20}
                        ],
                        totals: {
                            meta_total: 120,
                            realizado_total: 20,
                            acumulado: 20,
                            variacao: 16.67
                        }
                    };
                    break;
                case 'SUPRIMENTOS':
                    sectorData = {
                        monthly: [
                            {month: 'JAN', meta: 8, realizado: 1, accumulated: 1},
                            {month: 'FEV', meta: 8, realizado: 2, accumulated: 3},
                            {month: 'MAR', meta: 8, realizado: 1, accumulated: 4},
                            {month: 'ABR', meta: 8, realizado: 3, accumulated: 7},
                            {month: 'MAI', meta: 8, realizado: 2, accumulated: 9},
                            {month: 'JUN', meta: 8, realizado: 4, accumulated: 13},
                            {month: 'JUL', meta: 8, realizado: 3, accumulated: 16},
                            {month: 'AGO', meta: 8, realizado: 2, accumulated: 18},
                            {month: 'SET', meta: 8, realizado: 0, accumulated: 18},
                            {month: 'OUT', meta: 8, realizado: 0, accumulated: 18},
                            {month: 'NOV', meta: 8, realizado: 0, accumulated: 18},
                            {month: 'DEZ', meta: 8, realizado: 0, accumulated: 18}
                        ],
                        departments: [
                            {name: 'SUPRIMENTOS', count: 18}
                        ],
                        totals: {
                            meta_total: 96,
                            realizado_total: 18,
                            acumulado: 18,
                            variacao: 18.75
                        }
                    };
                    break;
                case 'PCP':
                    sectorData = {
                        monthly: [
                            {month: 'JAN', meta: 5, realizado: 0, accumulated: 0},
                            {month: 'FEV', meta: 5, realizado: 1, accumulated: 1},
                            {month: 'MAR', meta: 5, realizado: 0, accumulated: 1},
                            {month: 'ABR', meta: 5, realizado: 2, accumulated: 3},
                            {month: 'MAI', meta: 5, realizado: 1, accumulated: 4},
                            {month: 'JUN', meta: 5, realizado: 1, accumulated: 5},
                            {month: 'JUL', meta: 5, realizado: 2, accumulated: 7},
                            {month: 'AGO', meta: 5, realizado: 1, accumulated: 8},
                            {month: 'SET', meta: 5, realizado: 0, accumulated: 8},
                            {month: 'OUT', meta: 5, realizado: 0, accumulated: 8},
                            {month: 'NOV', meta: 5, realizado: 0, accumulated: 8},
                            {month: 'DEZ', meta: 5, realizado: 0, accumulated: 8}
                        ],
                        departments: [
                            {name: 'PCP', count: 8}
                        ],
                        totals: {
                            meta_total: 60,
                            realizado_total: 8,
                            acumulado: 8,
                            variacao: 13.33
                        }
                    };
                    break;
                default:
                    sectorData = loadFallbackData();
            }
            
            currentData = sectorData;
            updateDashboard(sectorData);
        }
    </script>
</body>
</html>
