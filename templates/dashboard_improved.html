<!DOCTYPE html>
<html>
<head>
    <title>IPPEL - Sistema de RNC</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script>
        // Tratamento precoce de erros de extensões do navegador
        (function() {
            const originalError = console.error;
            const originalWarn = console.warn;
            
            console.error = function(...args) {
                const msg = args && args[0] ? String(args[0]) : '';
                // Silenciar erros conhecidos de extensões (SVG, translateContent, etc)
                if (msg.includes('attribute d') || 
                    msg.includes('Expected number') ||
                    msg.includes('translateContent') ||
                    msg.includes('tc0.2,0,0.4-0.2,0') ||
                    msg.includes('jquery.js') ||
                    msg.includes('SVG') ||
                    msg.includes('path') ||
                    msg.includes('d: Expected')) {
                    return;
                }
                return originalError.apply(console, args);
            };
            
            console.warn = function(...args) {
                const msg = args && args[0] ? String(args[0]) : '';
                if (msg.includes('attribute d') || 
                    msg.includes('Expected number') ||
                    msg.includes('translateContent') ||
                    msg.includes('tc0.2,0,0.4-0.2,0') ||
                    msg.includes('jquery.js') ||
                    msg.includes('SVG') ||
                    msg.includes('path')) {
                    return;
                }
                return originalWarn.apply(console, args);
            };
        })();
    </script>
    <script>
        async function openClientSuggestions() {
            const clients = await ensureClientsLoaded();
            const box = document.getElementById('filterClientSuggestions');
            if (!box) return;
            populateClientSuggestions(clients);
            box.style.display = 'block';
            setTimeout(()=>{
                document.addEventListener('click', _closeClientSuggestionsOnClick);
            }, 10);
        }

        function _closeClientSuggestionsOnClick(e){
            const box = document.getElementById('filterClientSuggestions');
            const input = document.getElementById('filterClient');
            if (!box || !input) return;
            if (box.contains(e.target) || input === e.target) return;
            box.style.display = 'none';
            document.removeEventListener('click', _closeClientSuggestionsOnClick);
        }

        function populateClientSuggestions(list){
            const box = document.getElementById('filterClientSuggestions');
            if (!box) return;
            box.innerHTML = '';
            if (!Array.isArray(list) || list.length === 0) {
                box.innerHTML = '<div style="padding:10px;color:#666">Nenhum cliente</div>';
                return;
            }
            list.slice(0,200).forEach(c=>{
                const row = document.createElement('div');
                row.style.padding = '8px 10px';
                row.style.cursor = 'pointer';
                row.style.borderBottom = '1px solid #f3f3f3';
                row.textContent = c.name || '';
                row.onclick = function(){
                    const input = document.getElementById('filterClient');
                    if (input) input.value = c.name || '';
                    const sug = document.getElementById('filterClientSuggestions');
                    if (sug) sug.style.display = 'none';
                    applyFilters();
                };
                box.appendChild(row);
            });
        }

        function filterClientSuggestions(q){
            const list = window._allClientsForFilters || [];
            if (!q) return populateClientSuggestions(list);
            const lower = q.toLowerCase();
            const filtered = list.filter(c => (c.name||'').toLowerCase().includes(lower));
            populateClientSuggestions(filtered);
        }

        async function ensureClientsLoaded() {
            if (window._allClientsForFilters && window._allClientsForFilters.length > 0) {
                console.log(' Clientes já carregados:', window._allClientsForFilters.length);
                return window._allClientsForFilters;
            }
            
            try {
                console.log(' Buscando clientes das RNCs...');
                const response = await fetch('/api/rnc/list?tab=finalized&limit=5000');
                const data = await response.json();
                
                console.log(' Resposta recebida:', data);
                console.log(' Total de RNCs:', data?.rncs?.length || 0);
                
                if (data && Array.isArray(data.rncs)) {
                    const clientsSet = new Set();
                    
                    data.rncs.forEach((rnc, index) => {
                        if (index === 0) {
                            console.log(' Amostra da primeira RNC:', rnc);
                        }
                        
                        const clientName = rnc.cliente || rnc.client || rnc.client_name;
                        if (clientName && clientName.trim() !== '') {
                            clientsSet.add(clientName.trim());
                        }
                    });
                    
                    window._allClientsForFilters = Array.from(clientsSet).sort().map(name => ({
                        name: name
                    }));
                    
                    console.log(' Clientes únicos encontrados:', window._allClientsForFilters.length);
                    console.log(' Lista de clientes:', window._allClientsForFilters);
                    
                    return window._allClientsForFilters;
                }
            } catch(err) {
                console.error(' Erro ao carregar clientes:', err);
            }
            
            return [];
        }

        async function ensureClientsLoadedSelect() {
            const select = document.getElementById('filterClientSelect');
            if (!select) return;
            
            if (select.options.length > 1) return;
            
            const clients = await ensureClientsLoaded();
            
            clients.forEach(c => {
                const opt = document.createElement('option');
                opt.value = c.name || '';
                opt.textContent = c.name || '';
                select.appendChild(opt);
            });
        }

        async function ensureSectorsLoaded() {
            if (window._allSectorsForFilters && window._allSectorsForFilters.length > 0) {
                console.log(' Setores já carregados:', window._allSectorsForFilters.length);
                return window._allSectorsForFilters;
            }
            
            try {
                console.log(' Buscando setores das RNCs...');
                const response = await fetch('/api/rnc/list?tab=finalized&limit=5000');
                const data = await response.json();
                
                console.log(' Resposta recebida para setores:', data);
                console.log(' Total de RNCs:', data?.rncs?.length || 0);
                
                if (data && Array.isArray(data.rncs)) {
                    const sectorsSet = new Set();
                    
                    data.rncs.forEach((rnc, index) => {
                        if (index === 0) {
                            console.log(' Amostra da primeira RNC (setores):', rnc);
                        }
                        
                        const sectorName = rnc.setor || rnc.department || rnc.sector;
                        if (sectorName && sectorName.trim() !== '') {
                            sectorsSet.add(sectorName.trim());
                        }
                    });
                    
                    window._allSectorsForFilters = Array.from(sectorsSet).sort().map(name => ({
                        name: name
                    }));
                    
                    console.log(' Setores únicos encontrados:', window._allSectorsForFilters.length);
                    console.log(' Lista de setores:', window._allSectorsForFilters);
                    
                    return window._allSectorsForFilters;
                }
            } catch(err) {
                console.error(' Erro ao carregar setores:', err);
            }
            
            return [];
        }

        async function ensureSectorsLoadedSelect() {
            const select = document.getElementById('filterDepartment');
            if (!select) return;
            
            if (select.options.length > 1) return;
            
            const sectors = await ensureSectorsLoaded();
            
            sectors.forEach(s => {
                const opt = document.createElement('option');
                opt.value = s.name || '';
                opt.textContent = s.name || '';
                select.appendChild(opt);
            });
        }

        async function ensureResponsiblesLoaded() {
            if (window._allResponsiblesForFilters && window._allResponsiblesForFilters.length > 0) {
                console.log(' Responsáveis já carregados:', window._allResponsiblesForFilters.length);
                return window._allResponsiblesForFilters;
            }
            
            try {
                console.log(' Buscando responsáveis das RNCs...');
                const response = await fetch('/api/rnc/list?tab=finalized&limit=5000');
                const data = await response.json();
                
                console.log(' Resposta recebida para responsáveis:', data);
                
                if (data && Array.isArray(data.rncs)) {
                    const responsiblesMap = new Map();
                    
                    data.rncs.forEach((rnc, index) => {
                        if (index === 0) {
                            console.log(' Amostra da primeira RNC (responsáveis):', rnc);
                            console.log(' Campos disponíveis na RNC:', Object.keys(rnc));
                        }
                        
                        const responsibleName = rnc.user_name || rnc.responsible || rnc.responsavel || rnc.assigned_user_name || rnc.responsible_user;
                        const sectorName = rnc.setor || rnc.department || rnc.sector || rnc.user_department;
                        
                        console.log(` RNC ${index + 1}: responsibleName="${responsibleName}", sectorName="${sectorName}"`);
                        
                        if (responsibleName && responsibleName.trim() !== '') {
                            const key = responsibleName.trim();
                            if (!responsiblesMap.has(key)) {
                                responsiblesMap.set(key, {
                                    name: key,
                                    setor: sectorName ? sectorName.trim() : null
                                });
                                console.log(` Adicionado responsável: ${key} (setor: ${sectorName || 'N/A'})`);
                            }
                        } else {
                            console.log(` RNC ${index + 1} sem responsável válido`);
                        }
                    });
                    
                    window._allResponsiblesForFilters = Array.from(responsiblesMap.values()).sort((a, b) => 
                        a.name.localeCompare(b.name)
                    );
                    
                    console.log(' Responsáveis únicos encontrados:', window._allResponsiblesForFilters.length);
                    console.log(' Lista de responsáveis:', window._allResponsiblesForFilters);
                    
                    // Se não encontrou responsáveis nas RNCs, tentar API de usuários
                    if (window._allResponsiblesForFilters.length === 0) {
                        console.log(' Tentando buscar usuários da API...');
                        try {
                            const usersResponse = await fetch('/api/users');
                            const usersData = await usersResponse.json();
                            
                            if (usersData && Array.isArray(usersData.users)) {
                                window._allResponsiblesForFilters = usersData.users.map(user => ({
                                    name: user.name || user.username || user.email,
                                    setor: user.department || user.setor || null
                                }));
                                console.log(' Usuários carregados da API:', window._allResponsiblesForFilters.length);
                            }
                        } catch(usersErr) {
                            console.warn(' Erro ao carregar usuários da API:', usersErr);
                        }
                    }
                    
                    return window._allResponsiblesForFilters;
                }
            } catch(err) {
                console.error(' Erro ao carregar responsáveis:', err);
            }
            
            return [];
        }

        async function ensureResponsiblesLoadedSelect() {
            const select = document.getElementById('filterResponsible');
            if (!select) return;
            
            const sectorSelect = document.getElementById('filterDepartment');
            const selectedSector = sectorSelect ? sectorSelect.value : '';
            
            const responsibles = await ensureResponsiblesLoaded();
            
            // Limpar opções antigas (exceto a primeira)
            while (select.options.length > 1) {
                select.remove(1);
            }
            
            // Filtrar responsáveis por setor se um setor estiver selecionado
            let filteredResponsibles = responsibles;
            if (selectedSector && selectedSector !== '') {
                filteredResponsibles = responsibles.filter(r => r.setor === selectedSector);
                console.log(` Filtrando responsáveis do setor "${selectedSector}":`, filteredResponsibles.length);
            }
            
            filteredResponsibles.forEach(r => {
                const opt = document.createElement('option');
                opt.value = r.name || '';
                const displayText = r.setor ? `${r.name} (${r.setor})` : r.name;
                opt.textContent = displayText;
                select.appendChild(opt);
            });
            
            if (filteredResponsibles.length === 0 && selectedSector) {
                const opt = document.createElement('option');
                opt.value = '';
                opt.textContent = 'Nenhum responsável neste setor';
                opt.disabled = true;
                select.appendChild(opt);
            }
        }

        function updateResponsiblesBySelectedSector() {
            const sectorSelect = document.getElementById('filterDepartment');
            const responsibleSelect = document.getElementById('filterResponsible');
            
            if (!sectorSelect || !responsibleSelect) return;
            
            ensureResponsiblesLoadedSelect();
        }

        // Função de teste para debug
        async function testResponsiblesLoad() {
            console.log(' TESTE: Iniciando carregamento de responsáveis...');
            const responsibles = await ensureResponsiblesLoaded();
            console.log(' TESTE: Responsáveis carregados:', responsibles);
            
            const select = document.getElementById('filterResponsible');
            if (select) {
                console.log(' TESTE: Select encontrado, populando...');
                ensureResponsiblesLoadedSelect();
            } else {
                console.log(' TESTE: Select não encontrado!');
            }
        }

        // Expor função globalmente para teste
        window.testResponsiblesLoad = testResponsiblesLoad;
    </script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
            color: #333;
            margin: 0;
            padding: 0;
        }

        .left-section {
            flex: 1 1 auto;
            padding: 20px;
            background: white;
            overflow-y: visible;
            overflow-x: hidden;
            min-height: 100vh;
        }
        
        .right-section {
            flex: 0 0 380px;
            background: #f8f9fa;
            border-left: 1px solid #dee2e6;
            padding: 20px;
            overflow-y: auto;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e9ecef;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .logo img {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            object-fit: contain;
        }
        
        .logo h1 {
            color: #dc3545;
            font-size: 24px;
            font-weight: 700;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
            background: #f8f9fa;
            padding: 10px 15px;
            border-radius: 10px;
            border: 1px solid #dee2e6;
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #dc3545, #b21f35);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 18px;
        }
        
        .user-details h3 {
            font-size: 16px;
        }
        
        /* Estilos para notificações */
        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #dc3545;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes slideOutRight {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
        
        @keyframes modalFadeIn {
            from { 
                opacity: 0;
                transform: scale(0.9) translateY(-20px);
            }
            to { 
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .main-container {
            display: flex;
            height: 100vh;
            min-height: 100vh;
            width: 100%;
        }
        
        @keyframes progressBar {
            from { width: 100%; }
            to { width: 0%; }
        }
        
        .user-details p {
            font-size: 12px;
            color: #666;
        }
        
        /* Sistema de Abas */
        .tabs-container {
            margin-bottom: 30px;
        }
        
        .tabs-header {
            display: flex;
            background: #f8f9fa;
            border-radius: 10px;
            padding: 5px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .tab-button {
            flex: 1;
            padding: 12px 20px;
            border: none;
            background: transparent;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s ease;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .tab-button.active {
            background: linear-gradient(135deg, #dc3545, #b21f35);
            color: white;
            box-shadow: 0 4px 15px rgba(220,53,69,0.3);
        }
        
        .tab-button:hover:not(.active) {
            background: #e9ecef;
            transform: translateY(-1px);
        }
        
        .tab-button .count {
            background: rgba(255,255,255,0.2);
            color: inherit;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .tab-button.active .count {
            background: rgba(255,255,255,0.3);
        }
        
        /* Cards de RNC */
        
        /* Estilos para Gráficos */
        .charts-container {
            margin-top: 20px;
        }
        
        .charts-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .charts-header h3 {
            color: #333;
            font-size: 18px;
            font-weight: 600;
        }
        
        .chart-controls select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            background: white;
            font-size: 14px;
            cursor: pointer;
        }
        
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .chart-card {
            background: linear-gradient(145deg, #ffffff 0%, #f8f9fa 100%);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.12);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid rgba(255,255,255,0.8);
            position: relative;
            overflow: hidden;
        }
        
        .chart-card:before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #007bff, #28a745, #ffc107, #dc3545);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .chart-card:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
        }
        
        .chart-card:hover:before {
            opacity: 1;
        }
        
        .chart-card h4 {
            color: #2c3e50;
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 20px;
            text-align: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .chart-card canvas {
            width: 100% !important;
            height: 280px !important;
            max-height: 320px;
            border-radius: 12px;
            transition: all 0.3s ease;
            background: linear-gradient(145deg, #ffffff 0%, #f8fafc 100%);
            box-shadow: inset 0 2px 8px rgba(0,0,0,0.05);
            position: relative;
            z-index: 1;
        }
        
        .chart-card canvas:hover {
            transform: scale(1.01);
            box-shadow: inset 0 4px 12px rgba(0,0,0,0.08), 0 0 20px rgba(255,255,255,0.3);
        }
        
        /* Canvas específicos para gráficos especiais */
        .performance-chart canvas,
        .radar-chart canvas {
            background: rgba(255,255,255,0.1) !important;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
        }
        
        .performance-chart canvas:hover,
        .radar-chart canvas:hover {
            box-shadow: inset 0 4px 12px rgba(0,0,0,0.1), 0 0 25px rgba(255,255,255,0.4);
        }
        
        /* ===== ESTILOS APRIMORADOS PARA OS NOVOS ELEMENTOS ===== */
        
        /* KPI Dashboard */
        .kpi-dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .kpi-card {
            padding: 25px;
            border-radius: 16px;
            text-align: center;
            box-shadow: 0 6px 20px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .kpi-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, transparent 30%, rgba(255,255,255,0.1) 50%, transparent 70%);
            opacity: 0;
            transition: opacity 0.3s ease;
            transform: translateX(-100%);
        }

        .kpi-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
        }

        .kpi-card:hover::before {
            opacity: 1;
            transform: translateX(100%);
            transition: transform 0.6s ease;
        }

        /* Controles Aprimorados */
        .chart-controls {
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
        }

        .chart-controls select {
            padding: 10px 14px !important;
            border: 1px solid #ddd !important;
            border-radius: 8px !important;
            background: #fff !important;
            color: #555 !important;
            font-size: 14px !important;
            min-width: 150px;
            transition: all 0.3s ease;
        }

        .chart-controls select:hover {
            border-color: #667eea;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.15);
        }

        .chart-controls button {
            padding: 10px 16px;
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .chart-controls button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        /* Botões dos Cards */
        .chart-card button {
            padding: 8px 14px;
            border: none;
            border-radius: 20px;
            color: white;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .chart-card button:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        /* Animações de Entrada */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .chart-card {
            animation: fadeInUp 0.6s ease-out;
        }

        .chart-card:nth-child(1) { animation-delay: 0.1s; }
        .chart-card:nth-child(2) { animation-delay: 0.2s; }
        .chart-card:nth-child(3) { animation-delay: 0.3s; }
        .chart-card:nth-child(4) { animation-delay: 0.4s; }
        .chart-card:nth-child(5) { animation-delay: 0.5s; }
        .chart-card:nth-child(6) { animation-delay: 0.6s; }

        /* Modal Aprimorado */
        .chart-modal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.8);
            backdrop-filter: blur(5px);
        }

        .chart-modal-content {
            background-color: #fff;
            margin: 3% auto;
            padding: 30px;
            border-radius: 20px;
            width: 90%;
            max-width: 1200px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-50px) scale(0.9);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .chart-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .chart-modal-header h2 {
            margin: 0;
            color: #2c3e50;
            font-size: 24px;
            font-weight: 700;
        }

        .chart-modal-close {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 50%;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .chart-modal-close:hover {
            background: #c0392b;
            transform: rotate(90deg);
        }

        .chart-modal-body {
            position: relative;
            height: 600px;
        }

        /* Indicadores de Loading */
        .chart-loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
            color: #666;
            font-size: 16px;
        }

        .chart-loading::before {
            content: '';
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsividade Aprimorada */
        @media (max-width: 768px) {
            .kpi-dashboard {
                grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
                gap: 15px;
            }

            .chart-controls {
                flex-direction: column;
                align-items: stretch;
            }

            .chart-controls select,
            .chart-controls button {
                width: 100%;
                margin-bottom: 10px;
            }

            .chart-modal-content {
                width: 95%;
                margin: 10% auto;
                padding: 20px;
            }

            .chart-modal-body {
                height: 400px;
            }
            
            .charts-header {
                flex-direction: column;
                gap: 10px;
                text-align: center;
            }
        }
        
        /* Estilos específicos para gráficos especiais */
        .performance-chart {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            position: relative;
            overflow: hidden;
        }
        
        .performance-chart:before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 1px, transparent 1px);
            background-size: 30px 30px;
            animation: float 20s linear infinite;
            opacity: 0.3;
        }
        
        .performance-chart:after {
            content: '';
            position: absolute;
            top: -10px;
            right: -10px;
            font-size: 60px;
            opacity: 0.1;
            transform: rotate(15deg);
            animation: pulse 3s ease-in-out infinite;
        }
        
        .performance-chart h4 {
            color: white !important;
            -webkit-text-fill-color: white !important;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
            position: relative;
            z-index: 2;
        }
        
        .radar-chart {
            background: linear-gradient(135deg, #ff6b6b 0%, #ffa726 100%);
            color: white;
            position: relative;
            overflow: hidden;
        }
        
        .radar-chart:before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 2px, transparent 2px);
            background-size: 40px 40px;
            animation: float 25s linear infinite reverse;
            opacity: 0.3;
        }
        
        .radar-chart:after {
            content: '';
            position: absolute;
            top: -10px;
            right: -10px;
            font-size: 60px;
            opacity: 0.1;
            transform: rotate(-15deg);
            animation: bounce 4s ease-in-out infinite;
        }
        
        .radar-chart h4 {
            color: white !important;
            -webkit-text-fill-color: white !important;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
            position: relative;
            z-index: 2;
        }
        
        @keyframes float {
            0% { transform: translate(0, 0) rotate(0deg); }
            33% { transform: translate(30px, -30px) rotate(120deg); }
            66% { transform: translate(-20px, 20px) rotate(240deg); }
            100% { transform: translate(0, 0) rotate(360deg); }
        }
        
        @keyframes pulse {
            0%, 100% { transform: rotate(15deg) scale(1); opacity: 0.1; }
            50% { transform: rotate(15deg) scale(1.1); opacity: 0.2; }
        }
        
        @keyframes bounce {
            0%, 100% { transform: rotate(-15deg) translateY(0); }
            50% { transform: rotate(-15deg) translateY(-10px); }
        }
        .rnc-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
            min-height: auto;
            height: auto;
            max-height: none;
            overflow: visible;
        }
        
        /* Quando estiver na aba finalizados, usar layout de tabela */
        .rnc-grid.table-mode {
            display: block;
            grid-template-columns: none;
            gap: 0;
        }
        
        .rnc-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
            border: 2px solid transparent;
            position: relative;
            overflow: hidden;
        }
        
        .rnc-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.15);
        }
        
        .rnc-card.finalized {
            border-color: #28a745;
            background: linear-gradient(135deg, #f8fff9 0%, #ffffff 100%);
        }
        
        /* Estilos antigos para 'deleted' removidos (mantidos vazios para evitar referências) */
        
        .rnc-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }
        
        .rnc-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: white;
            font-weight: bold;
        }
        
        .rnc-icon.active {
            background: linear-gradient(135deg, #dc3545, #b21f35);
        }
        
        .rnc-icon.finalized {
            background: linear-gradient(135deg, #28a745, #1e7e34);
        }
        
        /* Ícone 'deleted' removido */
        
        .rnc-number {
            font-size: 14px;
            font-weight: bold;
            color: #dc3545;
            margin-bottom: 5px;
        }
        
        .rnc-title {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin-bottom: 10px;
            line-height: 1.3;
        }
        
        .rnc-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .detail-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            color: #666;
        }
        
        .detail-item .icon {
            width: 16px;
            height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 3px;
            font-size: 10px;
        }
        
        .priority-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
            text-transform: uppercase;
        }
        
        .priority-baixa { background: #d4edda; color: #155724; }
        .priority-média { background: #fff3cd; color: #856404; }
        .priority-alta { background: #f8d7da; color: #721c24; }
        .priority-crítica { background: #f5c6cb; color: #721c24; }
        
        .rnc-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .action-btn {
            padding: 8px 12px;
            border: none;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 5px;
            text-decoration: none;
            color: white;
        }
        
        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        /* Ensure primary/secondary mapped classes also follow IPPEL red */
        .action-btn.btn-primary,
        .action-btn.btn-secondary {
            background: linear-gradient(135deg, #dc3545, #b21f35);
            color: #fff;
        }
        
        /* Tema vermelho IPPEL para botões principais */
        .btn-view,
        .btn-chat,
        .btn-edit,
        .btn-reply {
            background: linear-gradient(135deg, #dc3545, #b21f35);
            color: #fff;
        }
        .btn-view:hover,
        .btn-chat:hover,
        .btn-edit:hover,
        .btn-reply:hover {
            background: linear-gradient(135deg, #b21f35, #8b1538);
        }
        .btn-finalize { background: #28a745; }
        .btn-delete { background: #dc3545; }
        /* Botões de lixeira removidos */
        
        /* Status específicos */
        .days-remaining {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #dc3545;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
        }
        
        .finalized-date {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #28a745;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
        }
        
        /* Loading e estados vazios */
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }
        
        .empty-state .icon {
            font-size: 48px;
            margin-bottom: 20px;
            opacity: 0.5;
        }
        
        .empty-state h3 {
            margin-bottom: 10px;
            color: #333;
        }
        
        .empty-state p {
            color: #666;
            line-height: 1.5;
        }
        
        /* Estilos para os filtros */
        .filters-container {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            border: 1px solid #dee2e6;
        }
        
        .filters-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .filters-header h3 {
            color: #333;
            font-size: 16px;
            font-weight: 600;
            margin: 0;
        }
        
        .clear-filters-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .clear-filters-btn:hover {
            background: #5a6268;
            transform: translateY(-1px);
        }
        
        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
        }
        
        .filter-group label {
            font-size: 12px;
            font-weight: 600;
            color: #495057;
            margin-bottom: 5px;
        }
        
        .filter-group input {
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        .filter-group input:focus {
            outline: none;
            border-color: #dc3545;
            box-shadow: 0 0 0 3px rgba(220,53,69,0.15);
        }
        
        /* Estilos para a tabela de RNCs finalizados */
        .table-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
            overflow-x: auto; /* Scroll horizontal se necessário */
            overflow-y: visible;
            margin-top: 20px;
            width: 100%;
            max-width: 100%;
            min-width: 100%;
            max-height: none;
            height: auto;
        }
        
        .rnc-table {
            width: 100%;
            min-width: 1400px; /* Largura mínima para garantir que todas as colunas apareçam */
            border-collapse: collapse;
            font-size: 14px;
            table-layout: auto;
            height: auto;
            max-height: none;
        }
        
        .rnc-table thead {
            background: linear-gradient(135deg, #dc3545, #b21f35);
            color: white;
        }
        
        .rnc-table th {
            padding: 15px 12px;
            text-align: left;
            font-weight: 600;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        /* Definir larguras específicas para cada coluna */
        .rnc-table th:nth-child(1) { width: 6%; } /* ID */
        .rnc-table th:nth-child(2) { width: 10%; } /* N° RNC */
        .rnc-table th:nth-child(3) { width: 15%; } /* Título */
        .rnc-table th:nth-child(4) { width: 10%; } /* Cliente */
        .rnc-table th:nth-child(5) { width: 10%; } /* Equipamento */
        .rnc-table th:nth-child(6) { width: 8%; } /* CV */
        .rnc-table th:nth-child(7) { width: 8%; } /* Desenho */
        .rnc-table th:nth-child(8) { width: 10%; } /* Área Responsável */
        .rnc-table th:nth-child(9) { width: 8%; } /* Setor */
        .rnc-table th:nth-child(10) { width: 9%; } /* Responsável */
        .rnc-table th:nth-child(11) { width: 8%; } /* Data Emissão */
        .rnc-table th:nth-child(12) { width: 6%; } /* Ações */
        
        .rnc-table tbody tr {
            border-bottom: 1px solid #e9ecef;
            transition: all 0.3s ease;
        }
        
        .rnc-table tbody tr:hover {
            background: #f8f9fa;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .rnc-table td {
            padding: 12px;
            vertical-align: middle;
        }
        
        .rnc-number-cell {
            font-weight: 600;
            color: #dc3545;
            font-family: 'Courier New', monospace;
        }
        
        .rnc-title-cell {
            font-weight: 500;
            color: #333;
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .rnc-client-cell,
        .rnc-equipment-cell,
        .rnc-department-cell,
        .rnc-user-cell {
            color: #666;
            font-size: 13px;
        }
        
        .rnc-date-cell {
            color: #28a745;
            font-weight: 500;
            font-size: 13px;
        }
        
        .rnc-actions-cell {
            text-align: center;
            white-space: nowrap;
        }
        
        .rnc-actions-cell .action-btn {
            padding: 6px 8px;
            margin: 0 2px;
            font-size: 12px;
            border-radius: 6px;
            text-decoration: none;
            display: inline-block;
            transition: all 0.3s ease;
        }
        
        .rnc-actions-cell .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        
        .btn-print {
            background: linear-gradient(135deg, #dc3545, #b21f35);
            color: white;
        }
        
        /* Estilos para ordenação */
        .sortable {
            cursor: pointer;
            user-select: none;
            position: relative;
        }
        
        .sortable:hover {
            background: rgba(255,255,255,0.1);
        }
        
        .sort-icon {
            font-size: 10px;
            margin-left: 5px;
            opacity: 0.7;
        }
        
        .sortable.asc .sort-icon::after {
            content: "↑";
        }
        
        .sortable.desc .sort-icon::after {
            content: "↓";
        }
        
        /* Responsividade da tabela */
        @media (max-width: 1200px) {
            .rnc-table {
                font-size: 12px;
            }
            
            .rnc-table th,
            .rnc-table td {
                padding: 8px 6px;
            }
            
            .rnc-title-cell {
                max-width: 150px;
            }
        }
        
        @media (max-width: 768px) {
            .table-container {
                overflow-x: auto;
                margin: 10px -10px;
                border-radius: 8px;
            }
            
            .rnc-table {
                min-width: 800px;
                font-size: 11px;
            }
            
            .rnc-table th,
            .rnc-table td {
                padding: 6px 4px;
            }
        }
        
        /* Responsividade */
        @media (max-width: 768px) {
            .main-container {
                flex-direction: column;
            }
            
            .right-section {
                width: 100%;
                min-width: auto;
                border-left: none;
                border-top: 1px solid #dee2e6;
            }
            
            .rnc-grid {
                grid-template-columns: 1fr;
            }
            
            .tabs-header {
                flex-direction: column;
                gap: 5px;
            }
            
            .tab-button {
                width: 100%;
            }
        }
        
        /* Animações */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .rnc-card {
            animation: fadeIn 0.5s ease-out;
        }
        
        /* Estatísticas */
        .stats-container {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
        }
        
        .stat-item {
            text-align: center;
            padding: 15px;
            border-radius: 10px;
            background: #f8f9fa;
        }
        
        .stat-number {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
        }
        
    .stat-active .stat-number { color: #dc3545; }
        .stat-finalized .stat-number { color: #28a745; }
        
    </style>
</head>
<body>
    <!-- Chart.js para gráficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <!-- jsPDF para exportação de relatórios -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
        // Logo safety: ensure preferred IPPEL logo is used everywhere
        (function(){
            function applyLogo(img){
                if(!img) return;
                if(!img.dataset.logoPrimary){
                    img.dataset.logoPrimary = '/LOGOIPPEL.JPEG';
                    img.dataset.logoFallback1 = '/IPPELLOGO.jpg';
                    img.dataset.logoFallback2 = (typeof flaskUrlForStatic !== 'undefined') ? flaskUrlForStatic('LOGOSQI.jpg') : '/static/LOGOSQI.jpg';
                }
                if(!/LOGOIPPEL\.JPEG$/i.test(img.src)){
                    img.src = img.dataset.logoPrimary;
                }
                img.onerror = function(){
                    if(this.dataset.try1!=='1'){ this.dataset.try1='1'; this.src=this.dataset.logoFallback1; }
                    else if(this.dataset.try2!=='1'){ this.dataset.try2='1'; this.src=this.dataset.logoFallback2; }
                    else { this.style.display='none'; }
                };
            }
            window.addEventListener('DOMContentLoaded', function(){
                // Apply the auto-swap logic ONLY to explicitly marked images,
                // so we can show multiple logos (e.g., IPPEL + SQI) side by side without overriding.
                document.querySelectorAll('img.apply-logo, img[data-apply-logo="1"]').forEach(applyLogo);
            });
        })();
    </script>
    <div class="main-container">
        <div class="left-section">
            <!-- Header -->
            <div class="header">
                <div class="logo">
                    <!-- SQI logo (à esquerda) -->
                    <img src="{{ url_for('static', filename='LOGOSQI.jpg') }}" alt="SQI Logo">
                    <!-- IPPEL logo (à direita da SQI) -->
                    <img class="apply-logo" src="/IPPELLOGO.jpg"
                        alt="IPPEL Logo"
                        data-logo-primary="/IPPELLOGO.jpg"
                        data-logo-fallback1="/IPPELLOGO.jpg"
                        data-logo-fallback2="{{ url_for('static', filename='LOGOSQI.jpg') }}"
                        onerror="if(this.dataset.try1!=='1'){this.dataset.try1='1'; this.src=this.dataset.logoFallback1;} else if(this.dataset.try2!=='1'){this.dataset.try2='1'; this.src=this.dataset.logoFallback2;} else {this.style.display='none';}">
                    <h1>IPPEL RNC System</h1>
                </div>
                <div style="display: flex; align-items: center; gap: 15px;">
                    <!-- Botão de Notificações -->
                    <div style="position: relative; cursor: pointer;" onclick="toggleNotifications()">
                        <div style="
                            width: 40px;
                            height: 40px;
                            background: linear-gradient(135deg, #ffc107, #ff8c00);
                            border-radius: 50%;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            color: white;
                            font-size: 18px;
                            box-shadow: 0 2px 10px rgba(255,193,7,0.3);
                            transition: all 0.3s ease;
                        "></div>
                        <div id="notificationBadge" class="notification-badge" style="display: none;">0</div>
                    </div>
                    
                    <div class="user-info">
                        <div class="user-avatar ava ava-ippel" id="userAvatar" title="Clique para trocar seu avatar" data-initial="1" role="button" tabindex="0" onclick="if(window.IPPELAvatar){ IPPELAvatar.show(); } else { window.__OPEN_AVATAR_ON_READY__=true; }" onkeydown="if(event.key==='Enter'||event.key===' '){ event.preventDefault(); if(window.IPPELAvatar){ IPPELAvatar.show(); } else { window.__OPEN_AVATAR_ON_READY__=true; }}">U</div>
                        <div class="user-details">
                            <h3 id="userName">Carregando...</h3>
                            <p id="userDepartment">Departamento</p>
                        </div>
                        <button onclick="logout()" style="background: #dc3545; color: white; border: none; padding: 8px 15px; border-radius: 8px; cursor: pointer;">
                            Sair
                        </button>
                    </div>
                </div>
            </div>
            <div id="avatarModal"></div>
            
            <!-- Sistema de Abas -->
            <div class="tabs-container">
                <div class="tabs-header">
                    <button class="tab-button active" data-tab="active" onclick="switchTab('active')">
                        Ativos
                        <span class="count" id="count-active">0</span>
                    </button>
                    {% if user_permissions.canViewEngineeringRncs %}
                    <button class="tab-button" data-tab="setores" onclick="switchTab('setores')">
                        RNCs Mensais por Setor
                    </button>
                    {% endif %}
                    {% if user_permissions.canViewFinalizedRncs %}
                    <button class="tab-button" data-tab="finalized" onclick="switchTab('finalized')">
                         Finalizados
                        <span class="count" id="count-finalized">0</span>
                    </button>
                    {% endif %}
                    {% if user_permissions.canViewCharts %}
                    <!-- STANDBY: Aba Evidências temporariamente oculta - Remova o style="display:none;" para reativar -->
                    <button class="tab-button" data-tab="evidencias" onclick="switchTab('evidencias')" style="display:none;">
                         Evidências
                    </button>
                    {% endif %}
                    {% if user_permissions.canViewLevantamento1415 %}
                    <button class="tab-button" data-tab="lev1415" onclick="switchTab('lev1415')">
                        Levantamento 14-15
                    </button>
                    {% endif %}
                </div>
                
                <!-- Subtópicos para RNCs Ativas -->
                <div id="activeSubtopicsContainer" class="subtopics-container" style="display: none;">
                    <div class="subtopics-header">
                        <button class="subtopic-button active" data-subtopic="all" onclick="switchActiveSubtopic('all')">
                            Todos
                            <span class="count" id="count-subtopic-all">0</span>
                        </button>
                        <button class="subtopic-button" data-subtopic="awaiting-response" onclick="switchActiveSubtopic('awaiting-response')">
                            Aguardando Resposta
                            <span class="count" id="count-subtopic-awaiting-response">0</span>
                        </button>
                        <button class="subtopic-button" data-subtopic="awaiting-value" onclick="switchActiveSubtopic('awaiting-value')">
                            Aguardando Valor
                            <span class="count" id="count-subtopic-awaiting-value">0</span>
                        </button>
                        <button class="subtopic-button" data-subtopic="awaiting-finalization" onclick="switchActiveSubtopic('awaiting-finalization')">
                             Aguardando Finalização
                            <span class="count" id="count-subtopic-awaiting-finalization">0</span>
                        </button>
                    </div>
                </div>
                
                <style>
                    /* Estilo para subtópicos */
                    .subtopics-container {
                        background: #f8f9fa;
                        padding: 12px 20px;
                        border-bottom: 1px solid #dee2e6;
                    }
                    
                    .subtopics-header {
                        display: flex;
                        gap: 10px;
                        flex-wrap: wrap;
                    }
                    
                    .subtopic-button {
                        padding: 8px 16px;
                        border: 2px solid #dee2e6;
                        background: white;
                        border-radius: 8px;
                        cursor: pointer;
                        font-size: 13px;
                        font-weight: 600;
                        color: #495057;
                        transition: all 0.3s;
                        display: flex;
                        align-items: center;
                        gap: 6px;
                    }
                    
                    .subtopic-button:hover {
                        background: #e9ecef;
                        border-color: #adb5bd;
                    }
                    
                    .subtopic-button.active {
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                        border-color: #667eea;
                        color: white;
                    }
                    
                    .subtopic-button .count {
                        background: rgba(255,255,255,0.2);
                        padding: 2px 8px;
                        border-radius: 12px;
                        font-size: 11px;
                        font-weight: 700;
                    }
                    
                    .subtopic-button.active .count {
                        background: rgba(255,255,255,0.3);
                    }
                    
                    /* Badge de status na RNC */
                    .rnc-status-badge {
                        display: inline-block;
                        padding: 4px 10px;
                        border-radius: 12px;
                        font-size: 11px;
                        font-weight: 600;
                        margin-bottom: 8px;
                    }
                    
                    .rnc-status-badge.awaiting-response {
                        background: #fff3cd;
                        color: #856404;
                        border: 1px solid #ffeaa7;
                    }
                    
                    .rnc-status-badge.awaiting-value {
                        background: #d1ecf1;
                        color: #0c5460;
                        border: 1px solid #bee5eb;
                    }
                    
                    .rnc-status-badge.awaiting-finalization {
                        background: #d4edda;
                        color: #155724;
                        border: 1px solid #c3e6cb;
                    }
                </style>
                
                <!-- Filtros para aba Finalizados -->
                <div id="filtersContainer" class="filters-container" style="display: none;">
                    <div class="filters-header">
                        <h3>Filtros de Pesquisa</h3>
                        <div style="display:flex; gap:8px; align-items:center;">
                            <label style="font-size:12px; color:#495057;">De:</label>
                            <input type="date" id="filterDateStart" onchange="applyFilters()" style="padding:6px 8px; border:1px solid #ddd; border-radius:6px;">
                            <label style="font-size:12px; color:#495057;">Até:</label>
                            <input type="date" id="filterDateEnd" onchange="applyFilters()" style="padding:6px 8px; border:1px solid #ddd; border-radius:6px;">
                            <select id="pageSizeSelect" onchange="changePageSize(this.value)" style="padding:6px 8px; border:1px solid #ddd; border-radius:6px;">
                                <option value="10">10 por página</option>
                                <option value="25">25 por página</option>
                                <option value="50">50 por página</option>
                                <option value="100">100 por página</option>
                            </select>
                            <button onclick="exportCSV()" class="clear-filters-btn" style="background:#198754">Exportar CSV</button>
                            <button onclick="clearFilters()" class="clear-filters-btn">Limpar Filtros</button>
                        </div>
                    </div>
                    <div class="filters-grid">
                        <div class="filter-group">
                            <label for="filterRncNumber">N° RNC:</label>
                            <input type="text" id="filterRncNumber" placeholder="Digite o número do RNC" onkeyup="applyFilters()">
                        </div>
                        <div class="filter-group" style="position:relative;">
                            <label for="filterClientSelect">Cliente:</label>
                            <select id="filterClientSelect" style="padding:6px 8px; border:1px solid #ddd; border-radius:6px; min-width:220px;" onchange="applyFilters()" onfocus="ensureClientsLoadedSelect()">
                                <option value="">Selecione o cliente</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="filterEquipment">Equipamento:</label>
                            <input type="text" id="filterEquipment" placeholder="Digite o equipamento" onkeyup="applyFilters()">
                        </div>
                        <div class="filter-group">
                            <label for="filterDepartment">Setor:</label>
                            <select id="filterDepartment" style="padding:6px 8px; border:1px solid #ddd; border-radius:6px; min-width:220px;" onchange="updateResponsiblesBySelectedSector(); applyFilters();" onfocus="ensureSectorsLoadedSelect()">
                                <option value="">Selecione o setor</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="filterPriority">Prioridade:</label>
                            <input type="text" id="filterPriority" placeholder="Baixa/Média/Alta/Crítica" onkeyup="applyFilters()">
                        </div>
                        <div class="filter-group">
                            <label for="filterResponsible">Responsável:</label>
                            <select id="filterResponsible" style="padding:6px 8px; border:1px solid #ddd; border-radius:6px; min-width:220px;" onchange="applyFilters()" onfocus="ensureResponsiblesLoadedSelect()">
                                <option value="">Selecione o responsável</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="filterCV">CV:</label>
                            <input type="text" id="filterCV" placeholder="Digite o CV" onkeyup="applyFilters()">
                        </div>
                        <div class="filter-group">
                            <label for="filterDrawing">Desenho:</label>
                            <input type="text" id="filterDrawing" placeholder="Digite o desenho" onkeyup="applyFilters()">
                        </div>
                    </div>
                </div>
                
                <!-- Estatísticas -->
                <div class="stats-container">
                    <div class="stats-grid">
                        <div class="stat-item stat-active">
                            <div class="stat-number" id="stat-active">0</div>
                            <div class="stat-label">Ativos</div>
                        </div>
                        {% if user_permissions.canViewFinalizedRncs %}
                        <div class="stat-item stat-finalized">
                            <div class="stat-number" id="stat-finalized">0</div>
                            <div class="stat-label">Finalizados</div>
                        </div>
                        {% endif %}
                        
                    </div>
                </div>
                


                <!-- Aba Evidências (Percentuais mensais por responsável) -->
                <div id="evidenciasContainer" class="charts-container" style="display:none;">
                    <!-- Cabeçalho com gradiente e estatísticas -->
                    <div style="background:linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius:8px; padding:16px; margin-bottom:16px; color:white; box-shadow:0 4px 15px rgba(102,126,234,0.4);">
                        <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:12px;">
                            <div>
                                <h3 style="margin:0 0 4px 0; font-size:18px; font-weight:600;"> Evidências - Percentuais por Mês</h3>
                                <p id="evidenciasSubtitle" style="margin:0; font-size:12px; opacity:0.9;">Relatório de Não Conformidades - Engenharia</p>
                            </div>
                            <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
                                <select id="evidenciasYearSelect" style="padding:8px 12px; border:none; border-radius:6px; font-size:13px; background:rgba(255,255,255,0.95); cursor:pointer; font-weight:500;">
                                <option value="">Todos os Anos</option>
                            </select>
                                <button onclick="printEvidencias()" style="padding:8px 14px; border:none; border-radius:6px; background:#fff; color:#667eea; cursor:pointer; font-size:13px; font-weight:600; transition:all 0.3s; box-shadow:0 2px 8px rgba(0,0,0,0.15);" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'"> Imprimir</button>
                                <button onclick="exportEvidenciasCSV()" style="padding:8px 14px; border:none; border-radius:6px; background:#198754; color:#fff; cursor:pointer; font-size:13px; font-weight:600; transition:all 0.3s;" onmouseover="this.style.background='#157347'" onmouseout="this.style.background='#198754'"> CSV</button>
                                <button onclick="refreshEvidencias()" style="padding:8px 14px; border:none; border-radius:6px; background:rgba(255,255,255,0.2); color:#fff; cursor:pointer; font-size:13px; font-weight:600; transition:all 0.3s; backdrop-filter:blur(10px);" onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'"> Atualizar</button>
                        </div>
                    </div>
                    
                        <!-- Cards de estatísticas rápidas -->
                        <div id="evidenciasStats" style="display:grid; grid-template-columns:repeat(auto-fit, minmax(140px, 1fr)); gap:10px; margin-top:16px;">
                            <!-- Será preenchido dinamicamente -->
                        </div>
                    </div>
                    
                    <!-- Info do Indicador (compacta e estilizada) -->
                    <div class="no-print" style="background:linear-gradient(to right, #f8f9fa, #e9ecef); border-left:4px solid #667eea; border-radius:6px; padding:10px 12px; margin-bottom:12px; font-size:11px; display:grid; grid-template-columns:repeat(auto-fit, minmax(140px, 1fr)); gap:10px; box-shadow:0 1px 3px rgba(0,0,0,0.1);">
                        <div><strong style="color:#667eea;"> Indicador:</strong> <span style="color:#495057;">RNC - Não Conformidade</span></div>
                        <div><strong style="color:#667eea;"> Departamento:</strong> <span style="color:#495057;">Engenharia</span></div>
                        <div><strong style="color:#667eea;"> Responsável:</strong> <span style="color:#495057;">Guilherme / Cíntia</span></div>
                        <div><strong style="color:#667eea;"> Meta:</strong> <span style="color:#495057;">30 RNCs/mês</span></div>
                        <div><strong style="color:#667eea;"> Objetivo:</strong> <span style="color:#495057;">Apontar não conformidades</span></div>
                        <div><strong style="color:#667eea;"> Parâmetro:</strong> <span style="color:#495057;">Quando - Melhor</span></div>
                    </div>
                    
                    <!-- Tabela de Evidências Mensais (compacta e moderna) -->
                    <div id="evidenciasTable" style="background:white; border-radius:8px; padding:16px; box-shadow:0 2px 12px rgba(0,0,0,0.08); overflow-x:auto;">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                            <h4 style="margin:0; color:#2c3e50; font-size:15px; font-weight:600;"> Percentuais de Cumprimento por Mês</h4>
                            <span id="evidenciasTableCount" style="background:#e9ecef; padding:4px 10px; border-radius:12px; font-size:11px; color:#495057; font-weight:600;"></span>
                        </div>
                        <div id="evidenciasTableContent">
                            <!-- Conteúdo será gerado dinamicamente -->
                        </div>
                    </div>
                    
                    <!-- Nova seção: Gráficos por Funcionário (compacto e moderno) -->
                    <div class="no-print" style="background:white; border-radius:8px; padding:16px; margin-top:12px; box-shadow:0 2px 12px rgba(0,0,0,0.08);">
                        <!-- Cabeçalho compacto -->
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px; flex-wrap:wrap; gap:10px;">
                            <div>
                                <h4 style="margin:0; color:#2c3e50; font-size:15px; font-weight:600;"> Desempenho por Funcionário</h4>
                                <p style="margin:2px 0 0 0; color:#6c757d; font-size:11px;">Análise individual de produtividade</p>
                            </div>
                            <div style="display:flex; gap:6px; align-items:center; flex-wrap:wrap;">
                                <select id="employeeYearSelect" onchange="loadEmployeePerformance()" style="padding:6px 10px; border:1px solid #dee2e6; border-radius:6px; font-size:12px; background:#fff; cursor:pointer;">
                                    <option value="">Carregando anos...</option>
                                </select>
                                <select id="employeeMonthSelect" onchange="loadEmployeePerformance()" style="padding:6px 10px; border:1px solid #dee2e6; border-radius:6px; font-size:12px; background:#fff; cursor:pointer;">
                                    <option value="">Carregando meses...</option>
                                </select>
                                <button onclick="loadEmployeePerformance()" style="padding:6px 12px; border:none; border-radius:6px; background:linear-gradient(135deg,#667eea,#764ba2); color:#fff; cursor:pointer; font-size:12px; font-weight:600; transition:all 0.3s;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'"></button>
                                <button onclick="forceUpdateSelectors()" style="padding:6px 12px; border:none; border-radius:6px; background:#28a745; color:#fff; cursor:pointer; font-size:12px; font-weight:600; transition:all 0.3s;" onmouseover="this.style.background='#218838'" onmouseout="this.style.background='#28a745'" title="Forçar atualização dos seletores de ano e mês"></button>
                            </div>
                        </div>
                        
                        <!-- Gráfico de Barras Horizontais com Percentuais (compacto) -->
                        <div style="margin-bottom:16px; background:#f8f9fa; border-radius:6px; padding:12px;">
                            <canvas id="employeePerformanceChart" height="250"></canvas>
                        </div>
                        
                        <!-- Tabela de dados detalhados (compacta) -->
                        <div id="employeePerformanceTable" style="margin-top:16px;">
                            <!-- Será preenchida dinamicamente -->
                        </div>
                    </div>
                    
                    <!-- Gráfico de Evolução (compacto) -->
                    <div class="no-print" style="background:white; border-radius:6px; padding:12px; margin-top:12px; box-shadow:0 2px 8px rgba(0,0,0,0.1);">
                        <h4 style="margin:0 0 12px 0; color:#333; font-size:14px;"> Evolução dos Percentuais</h4>
                        <canvas id="evidenciasChart" style="max-height:300px;"></canvas>
                    </div>
                </div>

                <!-- Aba Levantamento 14-15 (dashboard dinâmico) -->
                <div id="lev1415Container" class="charts-container" style="display:none;">
                    <div class="charts-header">
                        <h3> Levantamento RNC 2014-2015</h3>
                        <div class="chart-controls" style="display:flex; gap:8px; align-items:center;">
                            <button onclick="exportLev1415CSV()" style="padding:8px 10px; border:none; border-radius:6px; background:#198754; color:#fff; cursor:pointer;">Exportar CSV</button>
                        </div>
                    </div>
                    <div class="charts-grid">
                        <div class="chart-card">
                            <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
                                <h4 style="margin:0;"> Total por Mês</h4>
                                <div style="display:flex; align-items:center; gap:8px;">
                                    <label for="levYearSelect" style="font-size:12px; color:#666; margin-right:6px;">Ano:</label>
                                    <select id="levYearSelect" onchange="loadLevByYear()" style="padding:6px 8px; border:1px solid #dee2e6; border-radius:6px;"></select>
                                    <button onclick="resetLevView()" style="padding:6px 10px; border:1px solid #6c757d; border-radius:6px; background:#f8f9fa; color:#6c757d; font-size:11px; cursor:pointer;" title="Voltar para visualização 2014-2015">
                                        Reset
                                    </button>
                                </div>
                            </div>
                            <canvas id="levTotalMes"></canvas>
                        </div>
                        <div class="chart-card">
                            <h4> Por Departamento (mês selecionado)</h4>
                            <canvas id="levPorDept"></canvas>
                        </div>
                    </div>
                    <!-- Nova seção para o gráfico de porcentagens anuais -->
                    <div class="charts-grid" style="margin-top:20px;">
                        <div class="chart-card">
                            <h4 id="deptPercentTitle"> Porcentagem por Departamento - Ano Completo</h4>
                            <div id="deptPercentLegend" style="display:flex; flex-wrap:wrap; margin:10px 0; gap:10px; justify-content:center; font-size:12px;"></div>
                            <canvas id="deptPercentChart" style="max-height:280px;"></canvas>
                        </div>
                        <div class="chart-card">
                            <h4> Distribuição de RNCs por Departamento</h4>
                            <div id="deptPercentStats" style="font-size:14px; padding:10px;"></div>
                        </div>
                    </div>
                    <div class="chart-card" style="margin-top:12px;">
                        <h4 id="levTableTitle"> Tabela de Dados</h4>
                        <div id="lev1415TableWrap" style="overflow:auto;"></div>
                    </div>
                </div>

                <!-- Modal informações do Levantamento -->
                <div id="levInfoModal" class="modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.45); z-index:3000;">
                    <div style="background:#fff; border-radius:12px; width:90%; max-width:720px; margin:6% auto; box-shadow:0 10px 30px rgba(0,0,0,0.25);">
                        <div style="display:flex; justify-content:space-between; align-items:center; padding:14px 18px; border-bottom:1px solid #e9ecef;">
                            <h3 style="margin:0; color:#333;"> Informações — Levantamento RNC e Garantias 14-15</h3>
                            <button onclick="closeLevInfo()" style="background:#dc3545; color:#fff; border:none; border-radius:6px; padding:6px 10px; cursor:pointer;">Fechar</button>
                        </div>
                        <div id="levInfoBody" style="padding:16px; max-height:60vh; overflow:auto; color:#495057; line-height:1.6;">
                             <div id="levInfoPlaceholder" style="text-align:center; color:#6c757d;">Nenhuma informação cadastrada. Clique em "Editar" ou em "Carregar TXT".</div>
                        </div>
                        <div style="display:flex; justify-content:flex-end; gap:8px; padding:12px 16px; border-top:1px solid #e9ecef;">
                            <button onclick="editLevInfo()" style="background:linear-gradient(135deg,#dc3545,#b21f35); color:#fff; border:none; border-radius:6px; padding:8px 12px; cursor:pointer;">Editar</button>
                            <button onclick="exportLevInfo()" style="background:#198754; color:#fff; border:none; border-radius:6px; padding:8px 12px; cursor:pointer;">Exportar TXT</button>
                        </div>
                    </div>
                </div>

                <!-- Modal de Campos Obrigatórios Pendentes -->
                <div id="missingFieldsModal" class="modal" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 5000; align-items: center; justify-content: center;">
                    <div class="modal-content" style="max-width: 650px; border-radius: 16px; overflow: hidden; box-shadow: 0 20px 50px rgba(0,0,0,0.3); background: white;">
                        <div class="modal-header" style="background: linear-gradient(135deg, #dc2626, #ef4444); padding: 25px; border-bottom: none; display: flex; justify-content: space-between; align-items: center;">
                            <div style="display: flex; align-items: center; gap: 15px;">
                                <div style="background: rgba(255,255,255,0.2); width: 50px; height: 50px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 28px;">
                                   
                                </div>
                                <h2 class="modal-title" style="margin: 0; font-size: 22px; color: white; font-weight: 700;">
                                    Campos Obrigatórios Pendentes
                                </h2>
                            </div>
                            <span class="close" onclick="closeMissingFieldsModal()" style="color: white; font-size: 32px; cursor: pointer; opacity: 0.9; transition: opacity 0.2s;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.9'">&times;</span>
                        </div>
                        
                        <div class="modal-body" style="padding: 30px;">
                            <div style="background: linear-gradient(135deg, #fef2f2, #fee2e2); border-left: 5px solid #dc2626; padding: 20px; margin-bottom: 25px; border-radius: 12px; box-shadow: 0 2px 8px rgba(220,38,38,0.1);">
                                <div style="display: flex; align-items: center; gap: 12px;">
                                    <div style="font-size: 32px;"></div>
                                    <div>
                                        <p style="margin: 0; color: #7f1d1d; font-weight: 700; font-size: 16px; margin-bottom: 5px;">
                                            Não é possível finalizar
                                        </p>
                                        <p style="margin: 0; color: #991b1b; font-weight: 600; font-size: 18px;">
                                            <span id="missingRncNumber" style="color: #dc2626; font-weight: 800;"></span>
                                        </p>
                                    </div>
                                </div>
                            </div>
                            
                            <div style="margin-bottom: 20px;">
                                <p style="margin: 0 0 15px 0; font-size: 15px; color: #4b5563; font-weight: 600;">
                                    Para finalizar esta RNC, você precisa preencher os seguintes campos:
                                </p>
                            </div>
                            
                            <div id="missingFieldsList" style="margin: 0; padding: 0;">
                                <!-- Lista será preenchida dinamicamente -->
                            </div>
                            
                            <div style="background: linear-gradient(135deg, #eff6ff, #dbeafe); border-left: 5px solid #3b82f6; padding: 18px; margin-top: 25px; border-radius: 12px; box-shadow: 0 2px 8px rgba(59,130,246,0.1);">
                                <div style="display: flex; align-items: start; gap: 12px;">
                                    <div style="font-size: 24px; margin-top: -2px;"></div>
                                    <p style="margin: 0; color: #1e40af; font-size: 14px; line-height: 1.6;">
                                        <strong style="font-weight: 700;">Importante:</strong> Para finalizar esta RNC, você precisa primeiro preencher todos os campos obrigatórios listados acima. Acesse a RNC, preencha os campos pendentes e tente finalizar novamente.
                                    </p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="modal-actions" style="padding: 20px 30px; background: #f9fafb; border-top: 1px solid #e5e7eb; display: flex; justify-content: center;">
                            <button onclick="closeMissingFieldsModal()" class="action-btn btn-secondary" style="padding: 14px 32px; border-radius: 10px; font-weight: 700; font-size: 15px; transition: all 0.2s; background: linear-gradient(135deg, #6b7280, #4b5563); color: white; border: none; cursor: pointer; box-shadow: 0 4px 12px rgba(75, 85, 99, 0.3);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(75, 85, 99, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(75, 85, 99, 0.3)'">
                                 Entendido
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Modal de Confirmação Personalizado -->
                <div id="customConfirmModal" class="modal" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 6000; align-items: center; justify-content: center;">
                    <div class="modal-content" style="max-width: 500px; border-radius: 16px; overflow: hidden; box-shadow: 0 20px 50px rgba(0,0,0,0.3); background: white; animation: modalFadeIn 0.3s ease-out;">
                        <div class="modal-header" style="background: linear-gradient(135deg, #3b82f6, #2563eb); padding: 25px; border-bottom: none; display: flex; align-items: center; gap: 15px;">
                            <div id="confirmModalIcon" style="background: rgba(255,255,255,0.2); width: 50px; height: 50px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 28px;">
                                
                            </div>
                            <h2 id="confirmModalTitle" class="modal-title" style="margin: 0; font-size: 22px; color: white; font-weight: 700;">
                                Confirmação
                            </h2>
                        </div>
                        
                        <div class="modal-body" style="padding: 30px;">
                            <p id="confirmModalMessage" style="margin: 0 0 15px 0; font-size: 17px; color: #1f2937; font-weight: 600; line-height: 1.5;">
                                Tem certeza?
                            </p>
                            <p id="confirmModalDescription" style="margin: 0; font-size: 14px; color: #6b7280; line-height: 1.6;">
                                Esta ação não poderá ser desfeita.
                            </p>
                        </div>
                        
                        <div class="modal-actions" style="padding: 20px 30px; background: #f9fafb; border-top: 1px solid #e5e7eb; gap: 12px; display: flex; justify-content: flex-end;">
                            <button id="confirmModalCancel" class="action-btn btn-secondary" style="padding: 12px 24px; border-radius: 10px; font-weight: 600; font-size: 14px; transition: all 0.2s; background: #6b7280; color: white; border: none; cursor: pointer;" onmouseover="this.style.background='#4b5563'" onmouseout="this.style.background='#6b7280'">
                                Cancelar
                            </button>
                            <button id="confirmModalConfirm" class="action-btn btn-primary" style="padding: 12px 28px; border-radius: 10px; font-weight: 700; font-size: 14px; transition: all 0.2s; background: linear-gradient(135deg, #3b82f6, #2563eb); color: white; border: none; cursor: pointer; box-shadow: 0 4px 12px rgba(37,99,235,0.3);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(37,99,235,0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(37,99,235,0.3)'">
                                Confirmar
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Modal de detalhes/gráficos do Levantamento -->
                <div id="levDetailModal" class="modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:4000;">
                    <div style="background:#fff; border-radius:14px; width:95%; max-width:900px; margin:4% auto; box-shadow:0 20px 60px rgba(0,0,0,0.3);">
                        <div style="display:flex; justify-content:space-between; align-items:center; padding:14px 18px; border-bottom:1px solid #e9ecef;">
                            <h3 id="levDetailTitle" style="margin:0; color:#333;">Detalhes do Levantamento</h3>
                            <button onclick="closeLevDetail()" style="background:#dc3545; color:#fff; border:none; border-radius:6px; padding:6px 10px; cursor:pointer;">Fechar</button>
                        </div>
                        <div style="padding:16px; max-height:70vh; overflow:auto;">
                            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap:16px;">
                                <div style="background:#f8f9fa; border:1px solid #e9ecef; border-radius:10px; padding:12px;">
                                    <h4 style="margin:0 0 8px 0; color:#495057;">Status</h4>
                                    <canvas id="levStatusChart"></canvas>
                                </div>
                                <div style="background:#f8f9fa; border:1px solid #e9ecef; border-radius:10px; padding:12px;">
                                    <h4 style="margin:0 0 8px 0; color:#495057;">Prioridade</h4>
                                    <canvas id="levPriorityChart"></canvas>
                                </div>
                                <div style="grid-column: 1 / -1; background:#f8f9fa; border:1px solid #e9ecef; border-radius:10px; padding:12px;">
                                    <h4 style="margin:0 0 8px 0; color:#495057;">RNCs por Mês</h4>
                                    <canvas id="levMonthlyChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Conteúdo da aba Setores -->
            <div id="setoresContent" style="display: none;">
                <div style="background: white; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                    <h3 id="setorTitle" style="margin-bottom: 20px; color: #333;"> RNCs Mensais por Setor</h3>
                    <div style="display:flex; gap:12px; align-items:center; margin-bottom:12px;">
                        <div style="display:flex; gap:8px; align-items:center;">
                            <label style="font-size:13px; color:#495057; margin-right:6px;">Ano:</label>
                            <select id="filterYear" style="padding:6px 8px; border:1px solid #ddd; border-radius:6px; min-width:120px;"></select>
                        </div>
                        <div style="display:flex; gap:8px; align-items:center;">
                            <label style="font-size:13px; color:#495057; margin-right:6px;">Status:</label>
                            <select id="filterStatus" style="padding:6px 8px; border:1px solid #ddd; border-radius:6px; min-width:160px;"></select>
                        </div>
                        <div>
                            <button id="applySetorFilters" onclick="applySetorFilters()" style="padding:8px 12px; border:none; border-radius:6px; background:#198754; color:#fff; font-weight:600; cursor:pointer;">Aplicar</button>
                        </div>
                    </div>
                    <div style="background: #f8f9fa; border-radius: 8px; padding: 20px;">
                        <canvas id="setorSingleChart" style="max-height: 400px;"></canvas>
                    </div>
                </div>
            </div>

            <!-- Grid de RNCs -->
            <div id="rncGrid" class="rnc-grid">
                <div class="loading">
                    <div> Carregando RNCs...</div>
                </div>
            </div>
        </div>
        
        <div class="right-section">
            <h2 style="margin-bottom: 20px; color: #333;"> Dashboard</h2>
            
            <!-- Notificações -->
            <div id="notificationsContainer" style="margin-bottom: 20px; display: none;">
                <div style="background: white; border-radius: 12px; padding: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <h3 style="color: #333; font-size: 16px;"> Notificações</h3>
                        <button onclick="markAllNotificationsRead()" style="
                            background: #6c757d;
                            color: white;
                            border: none;
                            padding: 5px 10px;
                            border-radius: 5px;
                            font-size: 12px;
                            cursor: pointer;
                        ">Marcar todas</button>
                    </div>
                    <div id="notificationsList" style="max-height: 200px; overflow-y: auto;">
                        <!-- Notificações serão inseridas aqui -->
                    </div>
                </div>
            </div>
            
            <!-- Botões de Ação -->
            <div style="margin-bottom: 30px; display: flex; flex-direction: column; gap: 10px;">
                {% if user_permissions and user_permissions.canCreateRnc %}
                <button onclick="window.location.href='/form'" style="
                    width: 100%;
                    padding: 15px;
                    background: linear-gradient(135deg, #dc3545, #b21f35);
                    color: white;
                    border: none;
                    border-radius: 12px;
                    font-size: 16px;
                    font-weight: 600;
                    cursor: pointer;
                    transition: all 0.3s ease;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    gap: 10px;
                ">
                    Novo RNC
                </button>
                {% endif %}
                {% if user_permissions and user_permissions.canViewCharts %}
                <button onclick="window.location.href='/chat'" style="
                    width: 100%;
                    padding: 15px;
                    background: linear-gradient(135deg, #dc3545, #b21f35);
                    color: white;
                    border: none;
                    border-radius: 12px;
                    font-size: 16px;
                    font-weight: 600;
                    cursor: pointer;
                    transition: all 0.3s ease;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    gap: 10px;
                ">
                     Mensagens
                </button>
                {% endif %}
                
                <!-- Botão de Atualizar sempre visível -->
                <button onclick="forceRefreshDashboard()" style="
                    width: 100%;
                    padding: 12px;
                    background: linear-gradient(135deg, #6c757d, #495057);
                    color: white;
                    border: none;
                    border-radius: 12px;
                    font-size: 14px;
                    font-weight: 600;
                    cursor: pointer;
                    transition: all 0.3s ease;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    gap: 8px;
                ">
                    Atualizar Dashboard
                </button>
            </div>
            
            <!-- Informações do Sistema -->
            <div style="background: white; border-radius: 12px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                <h3 style="margin-bottom: 15px; color: #333;"> Informações</h3>
                <div style="font-size: 14px; line-height: 1.6; color: #666;">
                    <p><strong>RNCs Finalizados:</strong> Movidos para histórico após conclusão</p>
                    <p><strong>Exclusão:</strong> Agora é definitiva (sem lixeira)</p>
                </div>
            </div>

            
            
            <!-- Ações Rápidas -->
            <div style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                <h3 style="margin-bottom: 15px; color: #333;"> Ações Rápidas</h3>
                <div style="display: flex; flex-direction: column; gap: 10px;">
                    <button id="manageUsersBtn" onclick="window.location.href='/admin/users'" style="
                        padding: 10px;
                        background: #17a2b8;
                        color: white;
                        border: none;
                        border-radius: 8px;
                        cursor: pointer;
                        font-size: 14px;
                        display: flex;
                        align-items: center;
                        gap: 8px;
                        display: none;
                    ">
                        Gerenciar Usuários
                    </button>
                    <button id="manageGroupsBtn" onclick="window.location.href='/admin/groups'" style="
                        padding: 10px;
                        background: #28a745;
                        color: white;
                        border: none;
                        border-radius: 8px;
                        cursor: pointer;
                        font-size: 14px;
                        display: flex;
                        align-items: center;
                        gap: 8px;
                        display: none;
                    ">
                        Gerenciar Grupos
                    </button>
                    <button id="managePermissionsBtn" onclick="window.location.href='/admin/permissions'" style="
                        padding: 10px;
                        background: linear-gradient(135deg, #6f42c1, #563d7c);
                        color: white;
                        border: none;
                        border-radius: 10px;
                        cursor: pointer;
                        font-size: 14px;
                        display: flex;
                        align-items: center;
                        gap: 8px;
                        box-shadow: 0 8px 20px rgba(111, 66, 193, 0.25);
                        transition: transform .15s ease, box-shadow .15s ease;
                        display: none;
                    " onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 10px 22px rgba(111,66,193,.3)';" onmouseout="this.style.transform=''; this.style.boxShadow='0 8px 20px rgba(111,66,193,.25)';">
                        Gerenciar Permissões
                    </button>
                    <button id="manageFieldLocksBtn" onclick="window.location.href='/admin/field-locks/'" style="
                        padding: 10px;
                        background: linear-gradient(135deg, #e74c3c, #c0392b);
                        color: white;
                        border: none;
                        border-radius: 10px;
                        cursor: pointer;
                        font-size: 14px;
                        display: none;
                        align-items: center;
                        gap: 8px;
                        box-shadow: 0 8px 20px rgba(231, 76, 60, 0.25);
                        transition: transform .15s ease, box-shadow .15s ease;
                    " onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 10px 22px rgba(231,76,60,.3)';" onmouseout="this.style.transform=''; this.style.boxShadow='0 8px 20px rgba(231,76,60,.25)';">
                        Gerenciar Permissões Criação RNC
                    </button>
                    <button id="manageClientsBtn" onclick="window.location.href='/admin/clients'" style="
                        padding: 10px;
                        background: #8b1538;
                        color: white;
                        border: none;
                        border-radius: 8px;
                        cursor: pointer;
                        font-size: 14px;
                        display: flex;
                        align-items: center;
                        gap: 8px;
                        display: none;
                    ">
                        Cadastro de Clientes
                    </button>
                    <button id="manageOperatorsBtn" onclick="window.location.href='/admin/operators'" style="
                        padding: 10px;
                        background: #5b21b6;
                        color: white;
                        border: none;
                        border-radius: 8px;
                        cursor: pointer;
                        font-size: 14px;
                        display: flex;
                        align-items: center;
                        gap: 8px;
                        display: none;
                    ">
                        Cadastro de Operador
                    </button>
                    <button id="manageAreasBtn" onclick="window.location.href='/admin/areas'" style="
                        padding: 10px;
                        background: linear-gradient(135deg, #6f42c1, #4b2ca1);
                        color: white;
                        border: none;
                        border-radius: 10px;
                        cursor: pointer;
                        font-size: 14px;
                        display: flex;
                        align-items: center;
                        gap: 8px;
                        box-shadow: 0 8px 20px rgba(111, 66, 193, 0.25);
                        transition: transform .15s ease, box-shadow .15s ease;
                        display: none;
                    " onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 10px 22px rgba(111,66,193,.3)';" onmouseout="this.style.transform=''; this.style.boxShadow='0 8px 20px rgba(111,66,193,.25)';">
                        Cadastro de Área
                    </button>
                    <button id="manageSectorsBtn" onclick="window.location.href='/admin/sectors'" style="
                        padding: 10px;
                        background: linear-gradient(135deg, #5b21b6, #4c1d95);
                        color: white;
                        border: none;
                        border-radius: 10px;
                        cursor: pointer;
                        font-size: 14px;
                        display: flex;
                        align-items: center;
                        gap: 8px;
                        box-shadow: 0 8px 20px rgba(91, 33, 182, 0.25);
                        transition: transform .15s ease, box-shadow .15s ease;
                        display: none;
                    " onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 10px 22px rgba(91,33,182,.3)';" onmouseout="this.style.transform=''; this.style.boxShadow='0 8px 20px rgba(91,33,182,.25)';">
                        Cadastro de Setor
                    </button>
                                                <button id="generateReportBtn" onclick="window.location.href='/reports/menu'" style="
                        padding: 10px;
                        background: linear-gradient(135deg, #dc3545, #c82333);
                        color: white;
                        border: none;
                        border-radius: 10px;
                        cursor: pointer;
                        font-size: 14px;
                        display: none;
                        align-items: center;
                        gap: 8px;
                        box-shadow: 0 8px 20px rgba(220, 53, 69, 0.25);
                        transition: transform .15s ease, box-shadow .15s ease;
                    " onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 10px 22px rgba(220,53,69,.3)';" onmouseout="this.style.transform=''; this.style.boxShadow='0 8px 20px rgba(220,53,69,.25)';">
                         Gerar Relatório
                    </button>
                    <button id="manageValoresBtn" onclick="openValoresModal()" style="
                        padding: 10px;
                        background: linear-gradient(135deg, #f39c12, #e67e22);
                        color: white;
                        border: none;
                        border-radius: 10px;
                        cursor: pointer;
                        font-size: 14px;
                        display: none;
                        align-items: center;
                        gap: 8px;
                        box-shadow: 0 8px 20px rgba(243, 156, 18, 0.25);
                        transition: transform .15s ease, box-shadow .15s ease;
                    " onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 10px 22px rgba(243,156,18,.3)';" onmouseout="this.style.transform=''; this.style.boxShadow='0 8px 20px rgba(243,156,18,.25)';">
                        Tabela de Valores/Hora
                    </button>
                    <!-- Botão 'Gastos por Funcionário' removido conforme solicitação -->
                </div>
            </div>
        </div>
    </div>

    <script>
            function saveDashboardCache(data) {
                try {
                    localStorage.setItem('dashboardCache', JSON.stringify(data));
                } catch(e) {
                    console.warn('Erro ao salvar cache:', e);
                }
            }

            function loadDashboardCache() {
                try {
                    const cached = localStorage.getItem('dashboardCache');
                    if (cached) {
                        return JSON.parse(cached);
                    }
                } catch(e) {
                    console.warn('Erro ao carregar cache:', e);
                }
                return null;
            }

            async function loadLevFromTxt() {
                try {
                    const base = window.location.origin; // Usar mesmo protocolo (HTTP ou HTTPS)
                    const resp = await fetch(base + '/api/levantamentos/ano-sumario?file=' + encodeURIComponent('relatorio rnc 14-15.txt'), { credentials: 'include' });
                    const data = await resp.json();
                    if (!data.success) throw new Error('Falha ao carregar levantamento');
                    renderLevInfo(data.data);
                    // Preencher tabela com dados agregados
                    const cont = document.getElementById('levTableContainer');
                    const d = data.data || {};
                    const status = d.por_status || {};
                    const prioridade = d.por_prioridade || {};
                    const porMes = d.por_mes || {};
                    const rows = [];
                    rows.push(`<tr><th style="text-align:left; padding:6px;">Período</th><td style="padding:6px;">${d.periodo || '—'}</td></tr>`);
                    rows.push(`<tr><th style="text-align:left; padding:6px;">Total RNCs</th><td style="padding:6px;">${d.total || 0}</td></tr>`);
                    rows.push(`<tr><th style="text-align:left; padding:6px;">Por Status</th><td style="padding:6px;">${Object.keys(status).map(k=>`${k}: ${status[k]}`).join(' | ') || '—'}</td></tr>`);
                    rows.push(`<tr><th style="text-align:left; padding:6px;">Por Prioridade</th><td style="padding:6px;">${Object.keys(prioridade).map(k=>`${k}: ${prioridade[k]}`).join(' | ') || '—'}</td></tr>`);
                    rows.push(`<tr><th style="text-align:left; padding:6px;">Por Mês</th><td style="padding:6px;">${Object.keys(porMes).map(k=>`${k}: ${porMes[k]}`).join(' | ') || '—'}</td></tr>`);
                    cont.innerHTML = `<div style="overflow:auto;"><table style="width:100%; border-collapse:collapse; font-size:14px;"><tbody>${rows.join('')}</tbody></table></div>`;
                    showLevTable();
                    renderLevCards(d);
                } catch (e) {
                    alert('Erro ao carregar TXT: ' + (e && e.message ? e.message : e));
                }
            }
            
            function renderLevInfo(d) {
                const el = document.getElementById('levInfoBody');
                const ph = document.getElementById('levInfoPlaceholder');
                if (!d) { if (ph) ph.style.display='block'; return; }
                if (ph) ph.style.display='none';
                const status = d.por_status || {};
                const prioridade = d.por_prioridade || {};
                const porMes = d.por_mes || {};
                el.innerHTML = `
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px;">
                        <div style="background:#f8f9fa; border:1px solid #e9ecef; border-radius:8px; padding:10px;">
                            <div><strong>Período:</strong> ${d.periodo || '—'}</div>
                            <div><strong>Total RNCs:</strong> ${d.total || 0}</div>
                        </div>
                        <div style="background:#f8f9fa; border:1px solid #e9ecef; border-radius:8px; padding:10px;">
                            <div><strong>Por Status:</strong></div>
                            <div>${Object.keys(status).map(k=>`<span style='display:inline-block; margin:2px 6px 2px 0; padding:3px 8px; background:#e9ecef; border-radius:999px;'>${k}: ${status[k]}</span>`).join('')}</div>
                            <div style="margin-top:6px;"><strong>Por Prioridade:</strong></div>
                            <div>${Object.keys(prioridade).map(k=>`<span style='display:inline-block; margin:2px 6px 2px 0; padding:3px 8px; background:#e9ecef; border-radius:999px;'>${k}: ${prioridade[k]}</span>`).join('')}</div>
                        </div>
                        <div style="grid-column: 1 / -1; background:#f8f9fa; border:1px solid #e9ecef; border-radius:8px; padding:10px;">
                            <div style="margin-bottom:6px;"><strong>Por Mês:</strong></div>
                            <div>${Object.keys(porMes).map(k=>`<span style='display:inline-block; margin:2px 6px 2px 0; padding:3px 8px; background:#e9ecef; border-radius:999px;'>${k}: ${porMes[k]}</span>`).join('')}</div>
                        </div>
                    </div>
                `;
            }
            function renderLevCards(d) {
                const grid = document.getElementById('levCardsGrid');
                if (!grid) return;
                const status = d.por_status || {};
                const prioridade = d.por_prioridade || {};
                const total = d.total || 0;
                const periodo = d.periodo || '—';
                const cards = [];
                cards.push(`
                    <div class="rnc-card completed" onclick="openLevDetail()">
                        <div class="card-header">
                            <div class="profile-icon"></div>
                            <div class="card-info">
                                <div class="card-name" title="Levantamento Anual">Levantamento Anual</div>
                                <div class="card-dept" title="Período"> ${periodo}</div>
                                <div class="card-assigned" title="Total RNCs"> Total: ${total}</div>
                            </div>
                            <div class="card-status status-completed">Levantamento</div>
                        </div>
                        <div class="card-details">
                            <div class="detail-row"><span class="detail-label">Status:</span>
                                <span class="detail-value">${Object.keys(status).map(k=>`${k}: ${status[k]}`).join(' | ') || '—'}</span></div>
                            <div class="detail-row"><span class="detail-label">Prioridade:</span>
                                <span class="detail-value">${Object.keys(prioridade).map(k=>`${k}: ${prioridade[k]}`).join(' | ') || '—'}</span></div>
                        </div>
                        <div class="card-actions">
                            <button onclick="event.stopPropagation(); openLevDetail()" class="action-btn btn-primary"> Ver Detalhes</button>
                            <button onclick="event.stopPropagation(); openLevInfo()" class="action-btn btn-secondary"> Informações</button>
                        </div>
                    </div>
                `);
                grid.innerHTML = cards.join('');
            }
            function openLevDetail() {
                const modal = document.getElementById('levDetailModal');
                if (!modal) return; modal.style.display = 'block';
                try {
                    const base = window.location.origin; // Usar mesmo protocolo (HTTP ou HTTPS)
                    fetch(base + '/api/levantamentos/ano-sumario?file=' + encodeURIComponent('relatorio rnc 14-15.txt'), { credentials: 'include' })
                        .then(r => r.json()).then(({data}) => { if (data) createLevCharts(data); });
                } catch {}
            }
            function closeLevDetail() { const modal = document.getElementById('levDetailModal'); if (modal) modal.style.display = 'none'; }
            function createLevCharts(d) {
                const status = d.por_status || {};
                const prioridade = d.por_prioridade || {};
                const months = d.por_mes || {};
                if (window._levStatus) window._levStatus.destroy();
                if (window._levPriority) window._levPriority.destroy();
                if (window._levMonthly) window._levMonthly.destroy();
                const stx = document.getElementById('levStatusChart')?.getContext('2d');
                if (stx) window._levStatus = new Chart(stx, { type: 'doughnut', data:{ labels:Object.keys(status), datasets:[{ data:Object.values(status), backgroundColor:['#ffc107','#17a2b8','#007bff','#28a745','#6c757d'] }] }, options:{ responsive:true, maintainAspectRatio:false } });
                const ptx = document.getElementById('levPriorityChart')?.getContext('2d');
                if (ptx) window._levPriority = new Chart(ptx, { type: 'bar', data:{ labels:Object.keys(prioridade), datasets:[{ data:Object.values(prioridade), backgroundColor:['#28a745','#ffc107','#fd7e14','#dc3545'] }] }, options:{ responsive:true, maintainAspectRatio:false } });
                const mtx = document.getElementById('levMonthlyChart')?.getContext('2d');
                if (mtx) window._levMonthly = new Chart(mtx, { type: 'line', data:{ labels:Object.keys(months), datasets:[{ label:'RNCs', data:Object.values(months), borderColor:'#0d6efd', backgroundColor:'rgba(13,110,253,0.1)', tension:.4 }] }, options:{ responsive:true, maintainAspectRatio:false } });
            }
        
        // PROTEÇÃO CONTRA INICIALIZAÇÃO DUPLICADA
        if (window.DASHBOARD_INITIALIZED) {
            console.error(' DASHBOARD JÁ INICIALIZADO! Evitando duplicação de intervalos e notificações.');
            throw new Error('Dashboard já inicializado - prevenindo duplicação');
        }
        window.DASHBOARD_INITIALIZED = true;
        console.log('Dashboard inicializando pela primeira vez...');
        
        let currentTab = 'active';
        let rncsData = { 
            active: [], 
            finalized: [] 
        };
        
        {% if user_permissions.canViewEngineeringRncs %}
        rncsData.engenharia = [];
        {% endif %}
        
        // Variáveis para filtros
        let currentFilters = {
            rncNumber: '',
            client: '',
            equipment: '',
            department: ''
        };
        let filteredRNCs = [];
        
        // Carregar informações do usuário
        async function loadUserInfo() {
            console.log(' Iniciando carregamento de informações do usuário...');
            try {
                console.log(' Fazendo requisição para /api/user/info...');
                const response = await fetch('/api/user/info', { credentials: 'include' });
                console.log(`Resposta recebida - Status: ${response.status}`);
                
                const data = await response.json();
                console.log(' Dados do usuário recebidos:', data);
                
                if (data && data.success) {
                    console.log(` Usuário carregado: ${data.user.name} (${data.user.department})`);
                    
                    const userNameElement = document.getElementById('userName');
                    const userDepartmentElement = document.getElementById('userDepartment');
                    const userAvatarElement = document.getElementById('userAvatar');
                    
                    if (userNameElement) userNameElement.textContent = data.user.name;
                    if (userDepartmentElement) userDepartmentElement.textContent = data.user.department;
                    if (userAvatarElement) {
                        window.__USER_NAME__ = data.user.name || '';
                        const avKey = (data.user.avatar || 'ava-ippel');
                        const avPrefs = (data.user.avatarPrefs || null);
                        // Aplicar avatar animado se o helper estiver disponível
                        if (window.IPPELAvatar && typeof IPPELAvatar.applyToHeader === 'function') {
                            IPPELAvatar.applyToHeader(avKey, avPrefs);
                        } else {
                            // Fallback: ajustar classes manualmente
                            userAvatarElement.className = 'user-avatar ava ' + avKey;
                            userAvatarElement.textContent = (window.__USER_NAME__||'U').charAt(0).toUpperCase();
                        }
                    }
                    
                    // Verificar permissões para mostrar botões específicos
                    const role = (data.user.role || '').toLowerCase();
                    const perms = (data.user.permissions || []).map(p => (p || '').toLowerCase());
                    // Mostrar botão de relatório conforme permissão específica
                    try {
                        const __grp = (data.user.groupPermissions || []).map(p => (p || '').toLowerCase());
                        const __dept = (data.user.departmentPermissions || {});
                        const __canReport = perms.includes('view_reports') || __grp.includes('view_reports') || (__dept && __dept.canViewReports === true) || role === 'admin';
                        const _btnReport = document.getElementById('generateReportBtn');
                        if (_btnReport && __canReport) {
                            _btnReport.style.display = 'flex';
                        }
                    } catch (_) {}
                    if (role === 'admin' || perms.includes('manage_users')) {
                        const manageUsersBtn = document.getElementById('manageUsersBtn');
                        const manageGroupsBtn = document.getElementById('manageGroupsBtn');
                        const managePermissionsBtn = document.getElementById('managePermissionsBtn');
                        const manageFieldLocksBtn = document.getElementById('manageFieldLocksBtn');
                        const manageClientsBtn = document.getElementById('manageClientsBtn');
                        const manageAreasBtn = document.getElementById('manageAreasBtn');
                        const manageOperatorsBtn = document.getElementById('manageOperatorsBtn');
                        const manageSectorsBtn = document.getElementById('manageSectorsBtn');
                        const generateReportBtn = document.getElementById('generateReportBtn');
                        const expensesReportBtn = document.getElementById('expensesReportBtn');
                        const manageValoresBtn = document.getElementById('manageValoresBtn');
                        
                        if (manageUsersBtn) manageUsersBtn.style.display = 'flex';
                        if (manageGroupsBtn) manageGroupsBtn.style.display = 'flex';
                        if (managePermissionsBtn) managePermissionsBtn.style.display = 'flex';
                        if (manageFieldLocksBtn) {
                            manageFieldLocksBtn.style.display = 'flex';
                            console.log(' Botão Permissões Criação RNC ativado');
                        } else {
                            console.log(' Botão manageFieldLocksBtn não encontrado');
                        }
                        if (manageClientsBtn) manageClientsBtn.style.display = 'flex';
                        if (manageAreasBtn) manageAreasBtn.style.display = 'flex';
                        if (manageOperatorsBtn) manageOperatorsBtn.style.display = 'flex';
                        if (manageSectorsBtn) manageSectorsBtn.style.display = 'flex';
                        if (generateReportBtn) generateReportBtn.style.display = 'flex';
                        if (expensesReportBtn) expensesReportBtn.style.display = 'flex';
                        if (manageValoresBtn) manageValoresBtn.style.display = 'flex';
                    }
                    
                    // REGRA ESPECIAL: Ronaldo (ID 11) sempre vê a Tabela de Valores
                    // Ronaldo é o valorista responsável por gerenciar os valores/hora
                    if (data.user.id === 11) {
                        const manageValoresBtn = document.getElementById('manageValoresBtn');
                        if (manageValoresBtn) {
                            manageValoresBtn.style.display = 'flex';
                            console.log(' Ronaldo (Valorista) - Botão Tabela de Valores ativado');
                        }
                        
                        console.log(' Usuário tem permissões de administrador');
                    }
                    // Flag global e permissões detalhadas para uso em botões/ações
                    window.isAdmin = (role === 'admin' || perms.includes('manage_users'));
                    window.currentUserId = data.user.id;
                    window.userPerms = (data.user.departmentPermissions || {});
                    // Mostrar botões adicionais conforme permissões não-admin
                    if (perms.includes('view_clients_admin') || perms.includes('view_operators_admin') || perms.includes('manage_areas') || perms.includes('view_areas_admin') || perms.includes('manage_sectors') || perms.includes('view_sectors_admin')) {
                        const manageClientsBtn = document.getElementById('manageClientsBtn');
                        const manageAreasBtn = document.getElementById('manageAreasBtn');
                        const manageOperatorsBtn = document.getElementById('manageOperatorsBtn');
                        const manageSectorsBtn = document.getElementById('manageSectorsBtn');
                        if (manageClientsBtn && perms.includes('view_clients_admin')) manageClientsBtn.style.display = 'flex';
                        if (manageOperatorsBtn && perms.includes('view_operators_admin')) manageOperatorsBtn.style.display = 'flex';
                        if (manageAreasBtn && (perms.includes('manage_areas') || perms.includes('view_areas_admin'))) manageAreasBtn.style.display = 'flex';
                        if (manageSectorsBtn && (perms.includes('manage_sectors') || perms.includes('view_sectors_admin'))) manageSectorsBtn.style.display = 'flex';
                    }
                } else {
                    console.error(' Erro na resposta da API:', data && data.message);
                    // evita loop de redirect se sessão não existir
                    const el = document.getElementById('userName');
                    if (el) el.textContent = 'Não autenticado';
                }
            } catch (error) {
                console.error(' Erro ao carregar informações do usuário:', error);
                const el = document.getElementById('userName');
                if (el) el.textContent = 'Não autenticado';
            }
        }
        

        

        
    // Estado de paginação do dashboard melhorado
    let __nextCursor = null;
    let __hasMore = false;
    let __isLoading = false;
    const __PAGE_LIMIT = 50000;

    // Carregar RNCs
    async function loadRNCs(tab = 'active', forceRefresh = false) {
            console.log(` Carregando RNCs para aba: ${tab} ${forceRefresh ? '(FORCE REFRESH)' : ''}`);
            currentTab = tab;
            
            try {
                // Se for aba Setores, não carregar nada até selecionar um setor
                if (tab === 'setores') {
                    console.log(' Aba setores ativada. Aguardando seleção de setor...');
                    rncsData[tab] = [];
                    updateTotalCount(0);
                    renderRNCs(tab);
                    return;
                }
                
                // Se for aba Engenharia (legado), redirecionar para setores
                    if (tab === 'engenharia') {
                        console.log(' Carregando dados específicos da engenharia...');
                        try {
                            const engineeringResponse = await fetch('/api/indicadores/engenharia');
                        console.log(' [DEBUG] Response status:', engineeringResponse.status);
                            const engineeringData = await engineeringResponse.json();
                        console.log(' [DEBUG] Dados recebidos:', engineeringData);
                            
                            if (engineeringData.success) {
                                console.log(' Dados da engenharia recebidos:', engineeringData);
                            console.log(' [DEBUG] Total RNCs engenharia:', engineeringData.rncs_count);
                            
                            // Construir gráficos
                                buildEngineeringCharts(engineeringData);
                            
                            // IMPORTANTE: Usar APENAS os dados da API de engenharia
                                rncsData[tab] = engineeringData.rncs || [];
                            console.log(` ${rncsData[tab].length} RNCs da engenharia carregados`);
                            
                            // Atualizar contador no topo da página
                            updateTotalCount(rncsData[tab].length);
                            
                            // Renderizar tabela
                            renderRNCs(tab);
                            
                            // Atualizar TODOS os badges (incluindo engenharia)
                                    updateCounts();
                            
                            // GARANTIR que o badge de engenharia está correto (após updateCounts)
                                    const badge = document.getElementById('count-engenharia');
                            if (badge) {
                                badge.textContent = rncsData[tab].length;
                                console.log(` Badge de engenharia atualizado para: ${rncsData[tab].length}`);
                                    }
                            } else {
                                console.error(' Erro ao carregar dados da engenharia:', engineeringData.message);
                                rncsData[tab] = [];
                            updateTotalCount(0);
                            renderRNCs(tab);
                            }
                        } catch (error) {
                            console.error(' Erro na API da engenharia:', error);
                            rncsData[tab] = [];
                        updateTotalCount(0);
                        renderRNCs(tab);
                    }
                    return; // Sair da função, não continuar com /api/rnc/list
                }
                
                // Para outras abas, usar /api/rnc/list
                const apiTab = tab;
                console.log(` Fazendo requisição para: /api/rnc/list?tab=${apiTab}&limit=${__PAGE_LIMIT}`);
                const url = `/api/rnc/list?tab=${encodeURIComponent(apiTab)}&limit=${__PAGE_LIMIT}${forceRefresh ? '&_t=' + Date.now() : ''}`;
                const response = await fetch(url, { 
                    credentials: 'include',
                    cache: forceRefresh ? 'no-cache' : 'default',
                    headers: forceRefresh ? {
                        'Cache-Control': 'no-cache, no-store, must-revalidate',
                        'Pragma': 'no-cache',
                        'Expires': '0'
                    } : {}
                });
                console.log(`Resposta recebida - Status: ${response.status}`);
                
                const data = await response.json();
                console.log(` Dados recebidos para aba ${tab}:`, data);
                
                if (data.success) {
                    __nextCursor = data.next_cursor || null;
                    __hasMore = !!data.has_more;
                    
                    // VALIDAÇÃO CRÍTICA: Verificar se os dados são da aba correta
                    const expectedStatus = tab === 'finalized' ? 'Finalizado' : (tab === 'active' ? ['Pendente', 'Em Andamento', 'Aguardando', 'Cancelado'] : null);
                    
                    if (expectedStatus) {
                        const invalidRncs = data.rncs.filter(rnc => {
                            if (tab === 'finalized') {
                                return rnc.status !== 'Finalizado';
                            } else if (tab === 'active') {
                                return rnc.status === 'Finalizado';
                            }
                            return false;
                        });
                        
                        if (invalidRncs.length > 0) {
                            console.error(` ERRO: Recebidos ${invalidRncs.length} RNCs com status inválido para aba ${tab}!`, invalidRncs);
                        }
                    }
                    
                    // CORREÇÃO: Filtrar RNCs finalizadas da aba ATIVOS (problema de cache/permissões)
                    if (tab === 'active') {
                        const beforeFilter = data.rncs.length;
                        data.rncs = data.rncs.filter(rnc => rnc.status !== 'Finalizado');
                        const afterFilter = data.rncs.length;
                        if (beforeFilter !== afterFilter) {
                            console.warn(` FILTRADO: ${beforeFilter - afterFilter} RNCs finalizadas removidas da aba ATIVOS`);
                        }
                    }
                    
                    rncsData[tab] = data.rncs;
                    console.log(` RNCs carregados para ${tab}: ${data.rncs.length} itens`);
                    
                    // Debug adicional: verificar tipos de dados carregados
                    if (data.rncs.length > 0) {
                        const sample = data.rncs[0];
                        console.log(` Amostra de dados para ${tab}:`, {
                            id: sample.id,
                            status: sample.status,
                            finalized_at: sample.finalized_at
                        });
                    }
                    
                    // Salvar no cache
                    if (data.rncs && data.rncs.length >= 0) {
                        saveDashboardCache({ user: null, rncs: rncsData });
                    }
                    
                    // Aplicar filtros se necessário
                    if (tab === 'finalized' && (currentFilters.rncNumber || currentFilters.client || currentFilters.equipment || currentFilters.department)) {
                        console.log(` Aplicando filtros para aba finalizados`);
                        applyFilters();
                    } else {
                        console.log(` Renderizando RNCs para aba ${tab}`);
                        renderRNCs(tab);
                        renderImprovedLoadMore();
                    }
                    updateCounts();
                } else {
                    console.error(' Erro ao carregar RNCs:', data.message);
                    if (!rncsData[tab] || rncsData[tab].length === 0) {
                        try { renderRNCs(tab, []); } catch (_) {}
                    }
                    renderImprovedLoadMore();
                }
            } catch (error) {
                console.error(' Erro ao carregar RNCs:', error);
                if (!rncsData[tab] || rncsData[tab].length === 0) {
                    try { renderRNCs(tab, []); } catch (_) {}
                }
                renderImprovedLoadMore();
            }
        }
        
        // Expor loadRNCs globalmente
        window.loadRNCs = loadRNCs;

        async function loadMoreImproved() {
            if (!__hasMore || __isLoading) return;
            __isLoading = true;
            renderImprovedLoadMore();
            const apiTab = currentTab === 'engenharia' ? 'finalized' : currentTab;
            const url = `/api/rnc/list?tab=${encodeURIComponent(apiTab)}&limit=${__PAGE_LIMIT}${__nextCursor ? `&cursor=${encodeURIComponent(__nextCursor)}` : ''}`;
            try {
                const resp = await fetch(url, { credentials: 'include' });
                const data = await resp.json();
                if (data && data.success) {
                    __nextCursor = data.next_cursor || null;
                    __hasMore = !!data.has_more;
                    const chunk = currentTab === 'engenharia'
                        ? (data.rncs || []).filter(r => {
                            // Usar o mesmo filtro da função loadRNCs
                            const isEngineering = (
                                (r.responsavel && r.responsavel.toLowerCase().includes('guilherme')) ||
                                (r.responsavel && r.responsavel.toLowerCase().includes('cintia')) ||
                                (r.responsavel && r.responsavel.toLowerCase().includes('cíntia')) ||
                                (r.area_responsavel && r.area_responsavel.toLowerCase().includes('engenharia')) ||
                                (r.department && r.department.toLowerCase().includes('engenharia')) ||
                                (r.setor && r.setor.toLowerCase().includes('engenharia')) ||
                                (r.finalized_at !== null && r.finalized_at !== undefined)
                            );
                            return isEngineering;
                        })
                        : (data.rncs || []);
                    rncsData[currentTab] = (rncsData[currentTab] || []).concat(chunk);
                    renderRNCs(currentTab);
                    updateCounts();
                }
            } catch (e) {
                console.error('Falha no load more', e);
            } finally {
                __isLoading = false;
                renderImprovedLoadMore();
            }
        }

        function renderImprovedLoadMore() {
            const el = document.getElementById('improvedLoadMore');
            if (!el) return;
            if (__isLoading) { el.innerHTML = '<div class="load-more-info">Carregando...</div>'; return; }
            if (!__hasMore) { el.innerHTML = ''; return; }
            el.innerHTML = '<div class="load-more-wrap"><button class="btn btn-primary" onclick="loadMoreImproved()">Carregar mais</button></div>';
        }

        // Função para forçar refresh completo
        async function forceRefreshDashboard() {
            console.log(' Iniciando refresh completo do dashboard...');
            
            try {
                // 1. Limpar cache do servidor
                console.log(' Limpando cache do servidor...');
                await fetch('/api/cache/clear', {
                    method: 'POST',
                    credentials: 'include'
                });
                
                // 2. Limpar cache local
                localStorage.removeItem('dashboardCacheV1');
                console.log(' Cache local limpo');
                
                // 3. Limpar dados em memória
                rncsData = { 
                    active: [], 
                    finalized: [] 
                };
                
                {% if user_permissions.canViewEngineeringRncs %}
                rncsData.engenharia = [];
                {% endif %}
                
                // 4. Recarregar todas as abas com forceRefresh
                console.log(' Recarregando aba ativa...');
                // CORRIGIDO: Carregar a aba ATIVOS, não finalizados!
                await loadRNCs('active', true);
                
                {% if user_permissions.canViewEngineeringRncs %}
                console.log(' Recarregando aba engenharia...');
                await loadRNCs('engenharia', true);
                {% endif %}
                
                console.log(' Recarregando aba finalizados...');
                await loadRNCs('finalized', true);
                
                console.log(' Recarregando informações do usuário...');
                await loadUserInfo();
                
                console.log(' Refresh completo concluído!');
                
                // Mostrar notificação de sucesso
                showNotification(' Dashboard atualizado com sucesso!', 'success');
                
            } catch (error) {
                console.error(' Erro durante refresh:', error);
                showNotification(' Erro ao atualizar dashboard', 'error');
            }
        }
        
        // Expor função globalmente
        window.forceRefreshDashboard = forceRefreshDashboard;

        // Função de debug para verificar contagens reais
        async function debugRNCCount() {
            try {
                const response = await fetch('/api/debug/rnc-count', { credentials: 'include' });
                const data = await response.json();
                
                if (data.success) {
                    console.log(' CONTAGENS REAIS DO BANCO:', data.counts);
                    alert(`CONTAGENS REAIS:
Total: ${data.counts.total}
Finalizados: ${data.counts.finalizados}
Finalizados Ativos: ${data.counts.finalizados_ativos}
Ativos: ${data.counts.ativos}`);
                } else {
                    console.error('Erro no debug:', data.message);
                }
            } catch (error) {
                console.error('Erro ao buscar debug:', error);
            }
        }
        
        // Expor função de debug globalmente
        window.debugRNCCount = debugRNCCount;

        // Função de debug para verificar RNCs do usuário atual
        async function debugUserRNCs() {
            try {
                const response = await fetch('/api/debug/user-rncs', { credentials: 'include' });
                const data = await response.json();
                
                if (data.success) {
                    console.log(' RNCs DO USUÁRIO:', data);
                    alert(`RNCs de ${data.user_name} (ID: ${data.user_id}):

Criados por mim: ${data.counts.created_by_user}
Atribuídos a mim: ${data.counts.assigned_to_user}
Ativos (total): ${data.counts.active_total}
Finalizados (total): ${data.counts.finalized_total}

Exemplos recentes:
${data.examples.map(ex => 
  `${ex.rnc_number}: ${ex.title} (${ex.status}) ${ex.is_creator ? '[CRIADO]' : ''} ${ex.is_assigned ? '[ATRIBUÍDO]' : ''}`
).join('\n')}`);
                } else {
                    console.error('Erro no debug:', data.message);
                }
            } catch (error) {
                console.error('Erro ao buscar debug do usuário:', error);
            }
        }
        
        // Expor função de debug do usuário globalmente
        window.debugUserRNCs = debugUserRNCs;

        // Função de debug para verificar compartilhamentos
        async function debugUserShares() {
            try {
                const response = await fetch('/api/debug/user-shares', { credentials: 'include' });
                const data = await response.json();
                
                if (data.success) {
                    console.log(' COMPARTILHAMENTOS DO USUÁRIO:', data);
                    alert(`Compartilhamentos de ${data.user_name} (ID: ${data.user_id}):

Compartilhadas COMIGO: ${data.totals.shared_with_me}
Compartilhadas POR MIM: ${data.totals.shared_by_me}

Últimas compartilhadas comigo:
${data.shared_with_me.map(share => 
  `${share.rnc_number}: ${share.title} (${share.status}) - Por: ${share.shared_by}`
).join('\n') || 'Nenhuma'}

Últimas compartilhadas por mim:
${data.shared_by_me.map(share => 
  `${share.rnc_number}: ${share.title} (${share.status}) - Para: ${share.shared_with}`
).join('\n') || 'Nenhuma'}`);
                } else {
                    console.error('Erro no debug:', data.message);
                }
            } catch (error) {
                console.error('Erro ao buscar debug de compartilhamentos:', error);
            }
        }
        
        // Expor função de debug de compartilhamentos globalmente
        window.debugUserShares = debugUserShares;

        // Função de debug para verificar assinaturas de uma RNC específica
        async function debugRNCSignatures(rncId) {
            try {
                const response = await fetch(`/api/debug/rnc-signatures/${rncId}`, { credentials: 'include' });
                const data = await response.json();
                
                if (data.success) {
                    console.log(' ASSINATURAS DA RNC:', data);
                    alert(`Assinaturas da RNC ${data.rnc_number}:

INSPEÇÃO (Coluna 1):
Nome: "${data.signatures.inspection_name || 'VAZIO'}"
Data: "${data.signatures.inspection_date || 'VAZIO'}"
Status: ${data.debug_info.inspection_empty ? ' VAZIO' : ' PREENCHIDO'}

ENGENHARIA (Coluna 2):
Nome: "${data.signatures.engineering_name || 'VAZIO'}"
Data: "${data.signatures.engineering_date || 'VAZIO'}"
Status: ${data.debug_info.engineering_empty ? ' VAZIO' : ' PREENCHIDO'}

INSPEÇÃO 2 (Coluna 3):
Nome: "${data.signatures.inspection2_name || 'VAZIO'}"
Data: "${data.signatures.inspection2_date || 'VAZIO'}"
Status: ${data.debug_info.inspection2_empty ? ' VAZIO' : ' PREENCHIDO'}`);
                } else {
                    console.error('Erro no debug:', data.message);
                    alert('Erro: ' + data.message);
                }
            } catch (error) {
                console.error('Erro ao buscar debug de assinaturas:', error);
                alert('Erro ao buscar debug de assinaturas');
            }
        }
        
        // Expor função de debug de assinaturas globalmente
        window.debugRNCSignatures = debugRNCSignatures;

        // Sistema de debounce para evitar requisições múltiplas
        const loadingStates = {};
        function debounceLoad(key, fn, delay = 300) {
            if (loadingStates[key]) {
                console.log(` ${key} já está carregando, ignorando...`);
                return Promise.resolve();
            }
            
            loadingStates[key] = true;
            return fn().finally(() => {
                setTimeout(() => {
                    loadingStates[key] = false;
                }, delay);
            });
        }

        // Preload crítico - carregar dados essenciais imediatamente
        function preloadCriticalData() {
            const promises = [];
            
            // Preload dados essenciais de forma sequencial para evitar sobrecarga
            promises.push(loadUserInfo().catch(() => {}));
            
            // Carregar dados ativos E finalizados separadamente para garantir dados corretos
            promises.push(
                loadRNCs('active', false).then(() => {
                    console.log(' Dados ativos carregados:', rncsData.active?.length || 0);
                }).catch(() => {})
            );
            
            promises.push(
                loadRNCs('finalized', false).then(() => {
                    console.log(' Dados finalizados carregados:', rncsData.finalized?.length || 0);
                }).catch(() => {})
            );
            
            // Carregar dados de engenharia apenas se o usuário tiver permissão
            {% if user_permissions.canViewEngineeringRncs %}
            promises.push(loadRNCs('engenharia', false).catch(() => {}));
            {% endif %}
            
            return Promise.allSettled(promises);
        }

        // Renderizar RNCs
        function renderRNCs(tab, rncsArray = null) {
            if (typeof window.isAdmin === 'undefined') {
                window.isAdmin = false;
            }
            const grid = document.getElementById('rncGrid');
            let rncs = rncsArray || rncsData[tab];
            
            // FILTRO DE SEGURANÇA CRÍTICO: Remover RNCs com status incorreto
            if (rncs && rncs.length > 0) {
                const originalCount = rncs.length;
                if (tab === 'active') {
                    // Aba ATIVOS: remover qualquer RNC finalizada
                    rncs = rncs.filter(rnc => rnc.status !== 'Finalizado');
                    if (rncs.length !== originalCount) {
                        console.warn(` FILTRO DE SEGURANÇA: Removidos ${originalCount - rncs.length} RNCs finalizadas da aba ATIVOS`);
                    }
                } else if (tab === 'finalized') {
                    // Aba FINALIZADOS: manter apenas RNCs finalizadas
                    rncs = rncs.filter(rnc => rnc.status === 'Finalizado');
                    if (rncs.length !== originalCount) {
                        console.warn(` FILTRO DE SEGURANÇA: Removidos ${originalCount - rncs.length} RNCs não-finalizadas da aba FINALIZADOS`);
                    }
                }
            }
            
            // Ajustar classe do grid baseado na aba
            if (tab === 'finalized' || tab === 'engenharia') {
                grid.classList.add('table-mode');
            } else {
                grid.classList.remove('table-mode');
            }
            
            if (!rncs || rncs.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">${getEmptyStateIcon(tab)}</div>
                        <h3>${getEmptyStateTitle(tab)}</h3>
                        <p>${getEmptyStateMessage(tab)}</p>
                    </div>
                `;
                return;
            }
            
            // Se for a aba finalizados ou engenharia, mostrar como tabela
            if (tab === 'finalized' || tab === 'engenharia') {
                grid.innerHTML = createRNCTable(rncs, tab);
            } else {
                // Aplicar filtros extras para 'active' também
                let filtered = tab === 'active' ? filterActive(rncs) : rncs;
                
                // Atualizar contadores de subtópicos para tab active
                if (tab === 'active' && typeof window.updateSubtopicCounts === 'function') {
                    window.updateSubtopicCounts(filtered);
                }
                
                // Aplicar filtro de subtópico se estiver na aba active
                if (tab === 'active' && typeof window.filterBySubtopic === 'function') {
                    filtered = window.filterBySubtopic(filtered);
                }
                
                grid.innerHTML = filtered.map(rnc => safeCreateRNCCard(rnc, tab)).join('');
            }
        }
        function safeCreateRNCCard(rnc, tab) {
            try {
                if (!rnc) return '';
                if (!rnc.priority) rnc.priority = 'N/A';
                return createRNCCard(rnc, tab);
            } catch (e) {
                console.error('Falha ao criar card RNC', rnc && rnc.id, e);
                return '';
            }
        }
        
        // Criar tabela de RNCs finalizados
        function createRNCTable(rncs, tab) {
            const total = rncs.length;
            const pageSize = currentPageSize;
            const totalPages = Math.max(1, Math.ceil(total / pageSize));
            if (currentPage > totalPages) currentPage = totalPages;
            const startIndex = (currentPage - 1) * pageSize;
            const pageItems = rncs.slice(startIndex, startIndex + pageSize);
            return `
                <div class="table-container">
                    <table class="rnc-table">
                        <thead>
                            <tr>
                                <th class="sortable" onclick="sortTable('id')">
                                    ID <span class="sort-icon"></span>
                                </th>
                                <th class="sortable" onclick="sortTable('rnc_number')">
                                    N° RNC <span class="sort-icon"></span>
                                </th>
                                <th class="sortable" onclick="sortTable('title')">
                                    Título <span class="sort-icon"></span>
                                </th>
                                <th class="sortable" onclick="sortTable('client')">
                                    Cliente <span class="sort-icon"></span>
                                </th>
                                <th class="sortable" onclick="sortTable('equipment')">
                                    Equipamento <span class="sort-icon"></span>
                                </th>
                                <th class="sortable" onclick="sortTable('cv')">
                                    CV <span class="sort-icon"></span>
                                </th>
                                <th class="sortable" onclick="sortTable('drawing')">
                                    Desenho <span class="sort-icon"></span>
                                </th>
                                <th class="sortable" onclick="sortTable('setor')">
                                    Setor <span class="sort-icon"></span>
                                </th>
                                <th class="sortable" onclick="sortTable('user_name')">
                                    Responsável <span class="sort-icon"></span>
                                </th>
                                <th class="sortable" onclick="sortTable('created_at')">
                                    Data Emissão <span class="sort-icon"></span>
                                </th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${pageItems.map(rnc => createRNCTableRow(rnc, tab)).join('')}
                        </tbody>
                    </table>
                    ${renderPagination(total, currentPage, totalPages)}
                </div>
            `;
        }
        
        // Criar linha da tabela
        function createRNCTableRow(rnc, tab) {
            const createdDate = rnc.created_at ? new Date(rnc.created_at).toLocaleDateString('pt-BR') : 'N/A';
            
            // Limpar título removendo "RNC XXXXX - " no início
            let cleanTitle = rnc.title || '';
            if (cleanTitle.includes(' - ')) {
                // Remove a parte "RNC 34461 - " e mantém apenas "Rebobinadeira / ..."
                const parts = cleanTitle.split(' - ');
                if (parts.length > 1) {
                    cleanTitle = parts.slice(1).join(' - ');
                }
            }
            
            // Formatar número RNC garantindo que sempre tenha "RNC-"
            let cleanRncNumber = rnc.rnc_number || '';
            if (!cleanRncNumber.startsWith('RNC-')) {
                cleanRncNumber = 'RNC-' + cleanRncNumber;
            }

            // Preparar identificação de responsável real
            // Preferência: campo textual 'responsavel' vindo da RNC → usuário atribuído → criador da RNC
            const _respTxt = (rnc.responsavel || '').toString().trim();
            const responsibleName = (_respTxt && _respTxt.toUpperCase() !== 'N/A' && _respTxt !== '-')
                ? _respTxt
                : (rnc.assigned_user_name && String(rnc.assigned_user_name).trim())
                    ? rnc.assigned_user_name
                    : (rnc.user_name || 'N/I');
            
            return `
                <tr class="rnc-table-row" data-rnc-id="${rnc.id}" id="rnc-${rnc.id}">
                    <td class="rnc-id-cell">${rnc.id}</td>
                    <td class="rnc-number-cell"><a href="/rnc/${rnc.id}" title="Abrir RNC">${cleanRncNumber}</a></td>
                    <td class="rnc-title-cell">${cleanTitle}</td>
                    <td class="rnc-client-cell">${rnc.client || 'N/A'}</td>
                    <td class="rnc-equipment-cell">${rnc.equipment || 'N/A'}</td>
                    <td class="rnc-cv-cell">${rnc.cv || 'N/A'}</td>
                    <td class="rnc-drawing-cell">${rnc.drawing || 'N/A'}</td>
                    <td class="rnc-setor-cell">${rnc.setor || 'N/A'}</td>
                    <td class="rnc-user-cell">${responsibleName}</td>
                    <td class="rnc-date-cell">${createdDate}</td>
                    <td class="rnc-actions-cell">
                        <a href="/rnc/${rnc.id}" class="action-btn btn-view" title="Ver RNC"></a>
                        ${tab !== 'active' 
                            ? `<a href="/rnc/${rnc.id}/chat" class="action-btn btn-chat" title="Histórico de Mensagens"></a>`
                            : `<a href="/rnc/${rnc.id}/chat" class="action-btn btn-chat" title="Chat"></a>`
                        }
                    </td>
                </tr>
            `;
        }
        
        // Criar card de RNC
        function createRNCCard(rnc, tab) {
            const statusClass = tab === 'finalized' ? 'finalized' : 'active';
            const iconClass = statusClass;
            
            let statusBadge = '';
            if (tab === 'finalized' && rnc.finalized_at) {
                const date = new Date(rnc.finalized_at).toLocaleDateString('pt-BR');
                statusBadge = `<div class="finalized-date">Finalizado em ${date}</div>`;
            } else if (tab === 'active' && typeof window.getRNCStatus === 'function' && typeof window.getStatusBadgeHTML === 'function') {
                // Adicionar badge de status para RNCs ativas
                const rncStatus = window.getRNCStatus(rnc);
                statusBadge = window.getStatusBadgeHTML(rncStatus);
            }
            
            const actions = getActionsForTab(rnc, tab);
            
            // Limpar número RNC removendo "RNC-" duplicado
            let displayNumber = rnc.rnc_number || '';
            if (!displayNumber.startsWith('RNC-')) {
                displayNumber = 'RNC-' + displayNumber;
            }
            
            return `
                <div class="rnc-card ${statusClass}" data-rnc-id="${rnc.id}" id="rnc-${rnc.id}">
                    ${statusBadge}
                    <div class="rnc-header">
                        <div>
                            <div class="rnc-number">${displayNumber}</div>
                            <div class="rnc-title">${rnc.title}</div>
                        </div>
                        <div class="rnc-icon ${iconClass}">R</div>
                    </div>
                    
                    <div class="rnc-details">

                        <div class="detail-item">
                            <div class="icon">�</div>
                            <span>${rnc.created_at ? new Date(rnc.created_at).toLocaleDateString('pt-BR') : 'N/A'}</span>
                        </div>
                        <div class="detail-item">
                            <div class="icon">�</div>
                            <span>${rnc.equipment || 'N/A'}</span>
                        </div>
                        <div class="detail-item">
                            <div class="icon"></div>
                            <span>${rnc.client || 'N/A'}</span>
                        </div>
                        <div class="detail-item">
                            <div class="icon"></div>
                            <span>${rnc.responsavel || rnc.assigned_user_name || rnc.user_name || 'Sistema'}</span>
                        </div>
                    </div>
                    
                    <div class="rnc-actions">
                        ${actions}
                    </div>
                </div>
            `;
        }

        // Paginação e Exportação para Finalizados
        let currentPage = 1;
        let currentPageSize = 10;
        function changePage(page) { currentPage = page; renderRNCs(currentTab); }
        function changePageSize(size) { currentPageSize = parseInt(size, 10) || 10; currentPage = 1; if (currentTab === 'finalized') renderRNCs('finalized'); }
        function renderPagination(total, page, totalPages) {
            if (total <= currentPageSize) return '';
            const btn = (p, lbl, active=false) => `<button onclick=\"changePage(${p})\" style=\"margin:6px 4px; padding:6px 10px; border:1px solid #dee2e6; background:${active?'#dc3545':'#fff'}; color:${active?'#fff':'#333'}; border-radius:6px; cursor:pointer;\">${lbl}</button>`;
            let html = '<div style="display:flex; justify-content:center; padding:10px;">';
            html += btn(Math.max(1, page-1), '‹');
            const start = Math.max(1, page-2);
            const end = Math.min(totalPages, start+4);
            for (let p=start; p<=end; p++) html += btn(p, p, p===page);
            html += btn(Math.min(totalPages, page+1), '›');
            html += '</div>';
            return html;
        }

        function exportCSV() {
            let rows;
            if (currentTab === 'finalized') {
                rows = (filteredRNCs.length > 0 ? filteredRNCs : rncsData.finalized) || [];
            } else if (currentTab === 'engenharia') {
                {% if user_permissions.canViewEngineeringRncs %}
                rows = rncsData.engenharia || [];
                {% else %}
                rows = [];
                {% endif %}
            } else {
                rows = (filteredRNCs.length > 0 ? filteredRNCs : rncsData.active) || [];
            }
            if (!rows.length) { alert('Nenhum RNC para exportar.'); return; }
            const header = ['ID','N° RNC','Título','Cliente','Equipamento','CV','Desenho','Setor','Responsável','Data Finalização'];
            const csvRows = [header.join(';')];
            rows.forEach(r => {
                const finalizedDate = r.finalized_at ? new Date(r.finalized_at).toLocaleDateString('pt-BR') : '';
                csvRows.push([
                    r.id,
                    r.rnc_number,
                    (r.title || '').replace(/;/g, ','),
                    (r.client || '').replace(/;/g, ','),
                    (r.equipment || '').replace(/;/g, ','),
                    (r.cv || '').replace(/;/g, ','),
                    (r.drawing || '').replace(/;/g, ','),
                    (r.setor || '').replace(/;/g, ','),
                    (r.responsavel || '').replace(/;/g, ','),
                    finalizedDate
                ].join(';'));
            });
            const blob = new Blob(["\ufeff" + csvRows.join('\n')], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            const ts = new Date().toISOString().slice(0,10);
            const name = currentTab === 'finalized' ? 'rnc_finalizados' : 'rnc_ativos';
            a.download = `${name}_${ts}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        // Obter ações baseadas na aba
        function getActionsForTab(rnc, tab) {
            // Para aba de finalizados, manter ações mínimas
            if (tab !== 'active') {
                return `
                    <button onclick="window.location.href='/rnc/${rnc.id}'" class="action-btn btn-view"> Ver</button>
                    <button onclick="window.location.href='/rnc/${rnc.id}/chat'" class="action-btn btn-chat" title="Histórico de Mensagens">� Histórico</button>
                    <button onclick="window.location.href='/rnc/${rnc.id}/reply'" class="action-btn btn-reply"> Responder</button>
                `;
            }

            const isCreator = rnc.is_creator || (window.currentUserId && rnc.user_id && String(rnc.user_id) === String(window.currentUserId));
            const perms = window.userPerms || {};

                        // Admin vê tudo
            if (window.isAdmin) {
                return `
                    <a href="/rnc/${rnc.id}" class="action-btn btn-view"> Ver</a>
                    <a href="/rnc/${rnc.id}/chat" class="action-btn btn-chat"> Chat</a>
                    <a href="/rnc/${rnc.id}/reply" class="action-btn btn-reply"> Responder</a>
                    <button onclick="finalizeRNC(${rnc.id})" class="action-btn btn-finalize"> Finalizar</button>
                    <button onclick="deleteRNC(${rnc.id})" class="action-btn btn-delete"> Excluir</button>
                `;
            }

            const actions = [];
            actions.push(`<button onclick=\"window.location.href='/rnc/${rnc.id}'\" class=\"action-btn btn-view\"> Ver</button>`);
            actions.push(`<button onclick=\"window.location.href='/rnc/${rnc.id}/chat'\" class=\"action-btn btn-chat\"> Chat</button>`);
            // Responder: disponível para qualquer usuário autenticado
            actions.push(`<button onclick=\"window.location.href='/rnc/${rnc.id}/reply'\" class=\"action-btn btn-reply\"> Responder</button>`);
            // Finalizar
            if (perms.canFinalizeRnc) {
                actions.push(`<button onclick="finalizeRNC(${rnc.id})" class="action-btn btn-finalize"> Finalizar</button>`);
            }
            // Excluir
            if (perms.canDeleteRncs) {
                actions.push(`<button onclick="deleteRNC(${rnc.id})" class="action-btn btn-delete"> Excluir</button>`);
            }

            return actions.join('\n');
        }
        
        // Funções de ação
        async function finalizeRNC(rncId) {
            // Mostrar modal de confirmação personalizado
            const confirmed = await showConfirmModal(
                ' Finalizar RNC',
                'Tem certeza que deseja finalizar este RNC?',
                'Esta ação marcará a RNC como finalizada.',
                'Sim, Finalizar',
                'Cancelar'
            );
            
            if (!confirmed) return;
            
            try {
                const response = await fetch(`/api/rnc/${rncId}/finalize`, { method: 'POST' });
                const data = await response.json();
                
                if (data.success) {
                    alert('RNC finalizado com sucesso!');
                    loadRNCs(currentTab);
                } else {
                    // Se houver campos pendentes, mostrar modal específico
                    if (data.missing_fields && data.missing_fields.length > 0) {
                        // Buscar número da RNC em todas as abas
                        let rncNumber = `#${rncId}`;
                        for (const tab in rncsData) {
                            const rnc = rncsData[tab].find(r => r.id === rncId);
                            if (rnc && rnc.rnc_number) {
                                rncNumber = rnc.rnc_number;
                                break;
                            }
                        }
                        showMissingFieldsModal(rncId, rncNumber, data.missing_fields);
                } else {
                    alert('Erro ao finalizar RNC: ' + data.message);
                    }
                }
            } catch (error) {
                console.error('Erro:', error);
                alert('Erro ao conectar com o servidor');
            }
        }

        async function replyRNCFromList(rncId) {
            try {
                const resp = await fetch(`/api/rnc/${rncId}/reply`, { method: 'POST' });
                const data = await resp.json();
                if (data.success) {
                    alert('RNC reenviada com sucesso!');
                    loadRNCs(currentTab, true);
                } else {
                    alert('Erro: ' + (data.message || 'Falha ao responder RNC'));
                }
            } catch (e) {
                alert('Erro ao conectar com o servidor');
            }
        }
        
        async function deleteRNC(rncId) {
            if (!confirm('Tem certeza que deseja excluir definitivamente este RNC? Esta ação não poderá ser desfeita.')) return;
            
            console.log(` Excluindo RNC ${rncId}...`);
            
            try {
                // 1. REMOÇÃO IMEDIATA da interface (otimistic update)
                removeRNCFromInterface(rncId);
                
                // 2. Fazer requisição para o servidor
                const base = window.location.origin; // Usar mesmo protocolo (HTTP ou HTTPS)
                const response = await fetch(`${base}/api/rnc/${rncId}/delete`, { 
                    method: 'DELETE',
                    credentials: 'include'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    console.log(` RNC ${rncId} excluído com sucesso no servidor`);
                    
                    // 3. Atualizar dados locais imediatamente
                    if (rncsData.active) {
                        rncsData.active = rncsData.active.filter(rnc => rnc.id != rncId);
                    }
                    {% if user_permissions.canViewEngineeringRncs %}
                    if (rncsData.engenharia) {
                        rncsData.engenharia = rncsData.engenharia.filter(rnc => rnc.id != rncId);
                    }
                    {% endif %}
                    if (rncsData.finalized) {
                        rncsData.finalized = rncsData.finalized.filter(rnc => rnc.id != rncId);
                    }
                    
                    // 4. Atualizar contadores imediatamente
                    updateCounts();
                    
                    // 5. Mostrar notificação de sucesso
                    showNotification('RNC excluído definitivamente!', 'success');
                    
                    console.log(' RNC removido instantaneamente da interface');
                    
                } else {
                    console.error(` Erro ao excluir RNC ${rncId}:`, data.message);
                    
                    // 6. Em caso de erro, recarregar a lista para restaurar
                    showNotification(`Erro ao excluir: ${data.message}`, 'error');
                    loadRNCs(currentTab); // Recarregar para mostrar estado real
                }
                
            } catch (error) {
                console.error(` Erro de rede ao excluir RNC ${rncId}:`, error);
                showNotification('Erro de conexão. Verifique sua internet.', 'error');
                
                // Em caso de erro de rede, recarregar para mostrar estado real
                loadRNCs(currentTab);
            }
        }
        
        function removeRNCFromInterface(rncId) {
            console.log(` Removendo RNC ${rncId} da interface...`);
            
            // Encontrar o elemento da RNC na interface
            const rncElement = document.querySelector(`[data-rnc-id="${rncId}"]`) || 
                              document.querySelector(`#rnc-${rncId}`) ||
                              Array.from(document.querySelectorAll('.rnc-card')).find(card => 
                                  card.textContent.includes(`RNC-${rncId}`) || 
                                  card.innerHTML.includes(`deleteRNC(${rncId})`)
                              );
            
            if (rncElement) {
                // Animação suave de remoção
                rncElement.style.transition = 'all 0.3s ease-out';
                rncElement.style.transform = 'translateX(-100%)';
                rncElement.style.opacity = '0';
                
                // Remover elemento após animação
                setTimeout(() => {
                    rncElement.remove();
                    console.log(` Elemento RNC ${rncId} removido da DOM`);
                }, 300);
            } else {
                console.log(` Elemento RNC ${rncId} não encontrado na interface`);
            }
        }
        
        // Função para mostrar notificações modernas
        function showNotification(message, type = 'info') {
            // Remover notificação existente se houver
            const existing = document.querySelector('.notification-toast');
            if (existing) {
                existing.remove();
            }
            
            // Criar elemento de notificação
            const notification = document.createElement('div');
            notification.className = `notification-toast ${type}`;
            notification.innerHTML = `
                <div class="notification-content">
                    <span class="notification-icon">
                        ${type === 'success' ? '' : type === 'error' ? '' : type === 'warning' ? '' : ''}
                    </span>
                    <span class="notification-message">${message}</span>
                    <button class="notification-close" onclick="this.parentElement.parentElement.remove()">×</button>
                </div>
            `;
            
            // Adicionar estilos
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                z-index: 10000;
                background: ${type === 'success' ? '#28a745' : type === 'error' ? '#dc3545' : type === 'warning' ? '#ffc107' : '#17a2b8'};
                color: white;
                padding: 15px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                transform: translateX(400px);
                transition: transform 0.3s ease-out;
                max-width: 400px;
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            `;
            
            notification.querySelector('.notification-content').style.cssText = `
                display: flex;
                align-items: center;
                gap: 10px;
            `;
            
            notification.querySelector('.notification-close').style.cssText = `
                background: none;
                border: none;
                color: white;
                font-size: 18px;
                cursor: pointer;
                padding: 0;
                margin-left: auto;
                opacity: 0.7;
            `;
            
            // Adicionar ao DOM
            document.body.appendChild(notification);
            
            // Animar entrada
            setTimeout(() => {
                notification.style.transform = 'translateX(0)';
            }, 10);
            
            // Auto-remover após 4 segundos
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.style.transform = 'translateX(400px)';
                    setTimeout(() => {
                        if (notification.parentElement) {
                            notification.remove();
                        }
                    }, 300);
                }
            }, 4000);
        }
        
        // Funções de restauração, exclusão permanente e limpeza foram removidas (lixeira desativada)
        
        // Atualizar contadores
        function updateCounts() {
            const countActiveEl = document.getElementById('count-active');
            const countEngenhariaEl = document.getElementById('count-engenharia');
            const countFinalizedEl = document.getElementById('count-finalized');
            const statActiveEl = document.getElementById('stat-active');
            const statFinalizedEl = document.getElementById('stat-finalized');
            
            // FILTRO DE SEGURANÇA: Contar apenas RNCs do status correto
            const activeCount = (rncsData.active || []).filter(rnc => rnc.status !== 'Finalizado').length;
            const finalizedCount = (rncsData.finalized || []).filter(rnc => rnc.status === 'Finalizado').length;
            const engenhariaCount = (rncsData.engenharia || []).length;
            
            // Debug: verificar dados antes de atualizar
            console.log(' Atualizando contadores:', {
                active: activeCount,
                finalized: finalizedCount,
                engenharia: engenhariaCount
            });
            
            if (countActiveEl) countActiveEl.textContent = activeCount;
            {% if user_permissions.canViewEngineeringRncs %}
            if (countEngenhariaEl) countEngenhariaEl.textContent = engenhariaCount;
            {% else %}
            if (countEngenhariaEl) countEngenhariaEl.textContent = 0;
            {% endif %}
            if (countFinalizedEl) countFinalizedEl.textContent = finalizedCount;
            
            // Corrigir: usar dados corretos para cada contador
            if (statActiveEl) statActiveEl.textContent = activeCount;
            if (statFinalizedEl) statFinalizedEl.textContent = finalizedCount;
        }
        
        // Funções auxiliares
        function getEmptyStateIcon(tab) {
            switch(tab) {
                case 'active': return '';
                case 'engenharia': return '';
                case 'finalized': return '';
                
                default: return '';
            }
        }
        
        function getEmptyStateTitle(tab) {
            switch(tab) {
                case 'active': return 'Nenhum RNC Ativo';
                case 'engenharia': return 'Nenhum RNC de Engenharia';
                case 'finalized': return 'Nenhum RNC Finalizado';
                
                default: return 'Nenhum RNC';
            }
        }
        
        function getEmptyStateMessage(tab) {
            switch(tab) {
                case 'active': return 'Crie seu primeiro RNC para começar a trabalhar.';
                case 'engenharia': return 'RNCs específicos do setor de Engenharia aparecerão aqui.';
                case 'finalized': return 'RNCs finalizados aparecerão aqui para consulta.';
                
                default: return 'Nenhum RNC encontrado.';
            }
        }
        
        async function logout() {
            try {
                const base = window.location.origin; // Usar mesmo protocolo (HTTP ou HTTPS)
                const response = await fetch(base + '/api/logout', { credentials: 'include' });
                const data = await response.json();
                
                if (data.success) {
                    window.location.href = '/';
                }
            } catch (error) {
                console.error('Erro no logout:', error);
                window.location.href = '/';
            }
        }
        
        // Sistema de notificações
        let notifications = [];
        let notificationCount = 0;
        
        // Carregar notificações não lidas
        async function loadNotifications() {
            try {
                console.log(' Carregando notificações...');
                // Usar o mesmo protocolo da página (HTTP ou HTTPS)
                const base = window.location.origin;
                console.log(' Base URL:', base);
                const response = await fetch(base + '/api/notifications/unread', { credentials: 'include' });
                const data = await response.json();
                
                console.log(' Resposta da API de notificações:', data);
                
                if (data.success) {
                    const oldCount = notificationCount;
                    notifications = data.notifications;
                    notificationCount = data.count;
                    
                    console.log(` Notificações: ${oldCount} → ${notificationCount} (${data.notifications.length} itens)`);
                    
                    // Se há novas notificações, mostrar notificação do navegador
                    if (notificationCount > oldCount && data.notifications.length > 0) {
                        const newNotifications = data.notifications.slice(0, notificationCount - oldCount);
                        newNotifications.forEach(notification => {
                            console.log(' Nova notificação detectada:', notification);
                            showBrowserNotification(notification); // Notificação nativa do Windows
                        });
                    }
                    
                    renderNotifications();
                } else {
                    console.error(' Erro na API de notificações:', data.message);
                }
            } catch (error) {
                console.error(' Erro ao carregar notificações:', error);
            }
        }
        
        // Renderizar notificações
        function renderNotifications() {
            const container = document.getElementById('notificationsContainer');
            const list = document.getElementById('notificationsList');
            
            if (notificationCount === 0) {
                container.style.display = 'none';
                updateNotificationBadge();
                return;
            }
            
            container.style.display = 'block';
            list.innerHTML = '';
            
            notifications.forEach(notification => {
                const notificationElement = document.createElement('div');
                notificationElement.style.cssText = `
                    padding: 10px;
                    margin-bottom: 8px;
                    background: ${notification.is_read ? '#f8f9fa' : '#fff3cd'};
                    border-left: 4px solid ${notification.is_read ? '#6c757d' : '#ffc107'};
                    border-radius: 5px;
                    font-size: 12px;
                    cursor: pointer;
                    transition: all 0.3s ease;
                `;
                
                notificationElement.innerHTML = `
                    <div style="font-weight: 600; margin-bottom: 3px;">${notification.title}</div>
                    <div style="color: #666; margin-bottom: 5px;">${notification.message}</div>
                    <div style="font-size: 10px; color: #999;">
                        ${new Date(notification.created_at).toLocaleString('pt-BR')}
                    </div>
                `;
                
                notificationElement.onclick = () => {
                    if (notification.rnc_id) {
                        window.location.href = `/rnc/${notification.rnc_id}/chat`;
                    }
                };
                
                list.appendChild(notificationElement);
            });
            
            updateNotificationBadge();
        }
        
        // Marcar todas as notificações como lidas
        async function markAllNotificationsRead() {
            if (notifications.length === 0) return;
            
            try {
                const notificationIds = notifications.map(n => n.id);
                const response = await fetch('/api/notifications/mark-read', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ notification_ids: notificationIds })
                });
                
                const data = await response.json();
                if (data.success) {
                    notifications = [];
                    notificationCount = 0;
                    renderNotifications();
                    updateNotificationBadge();
                }
            } catch (error) {
                console.error('Erro ao marcar notificações como lidas:', error);
            }
        }
        
        //  Mostrar notificação nativa do Windows (FORÇADA - funciona em segundo plano)
        function showBrowserNotification(notification) {
            console.log(' ===== INICIANDO showBrowserNotification =====');
            console.log(' Notification support:', 'Notification' in window);
            console.log(' Permission:', Notification?.permission);
            console.log(' Window focused:', document.hasFocus());
            console.log(' Dados recebidos:', notification);
            
            // Verificar se o navegador suporta notificações
            if (!('Notification' in window)) {
                console.error(' Este navegador NÃO suporta Notification API!');
                return;
            }
            
            // Se não tiver permissão, solicitar
            if (Notification.permission === 'default') {
                console.log(' Permissão não concedida ainda. Solicitando...');
                Notification.requestPermission().then(permission => {
                    console.log(' Resultado da solicitação:', permission);
                    if (permission === 'granted') {
                        console.log(' Permissão concedida! Tentando novamente...');
                        showBrowserNotification(notification);
                    } else {
                        console.error(' Permissão NEGADA pelo usuário');
                    }
                });
                return;
            }
            
            // Se permissão negada, apenas tocar som
            if (Notification.permission === 'denied') {
                console.error(' PERMISSÃO NEGADA! Notificações estão bloqueadas!');
                console.log('� Solução: Clique no cadeado na barra de endereços e permita notificações');
                try {
                    if (typeof playNotificationSound === 'function') {
                        playNotificationSound();
                    }
                } catch (e) {
                    console.error(' Erro ao tocar som:', e);
                }
                return;
            }
            
            // Se temos permissão (granted), FORÇAR notificação
            if (Notification.permission === 'granted') {
                console.log(' ===== PERMISSÃO CONCEDIDA - CRIANDO NOTIFICAÇÃO =====');
                
                const title = notification.title || ' IPPEL RNC System';
                const body = notification.message || 'Nova atualização disponível';
                
                console.log(' Título da notificação:', title);
                console.log(' Corpo da notificação:', body);
                
                // TOCAR SOM IMEDIATAMENTE!
                try {
                    if (typeof playNotificationSound === 'function') {
                        playNotificationSound();
                        console.log(' Som tocado!');
                    }
                } catch (e) {
                    console.error(' Erro ao tocar som:', e);
                }
                
                // ESTRATÉGIA DE MÚLTIPLAS TENTATIVAS PARA FORÇAR NOTIFICAÇÃO
                let notifShown = false;
                let attempts = 0;
                const maxAttempts = 3;
                
                // Função para criar notificação com diferentes configurações
                function tryCreateNotification(attempt) {
                    console.log(` Tentativa ${attempt}/${maxAttempts} de criar notificação...`);
                    
                    try {
                        // Tentativa 1: Notificação COMPLETA (todas as opções)
                        // Tentativa 2: Notificação MÉDIA (sem requireInteraction)
                        // Tentativa 3: Notificação MÍNIMA (só título e corpo)
                        let options = {};
                        
                        if (attempt === 1) {
                            console.log(' Tentativa 1: Notificação COMPLETA');
                            options = {
                                body: body,
                                icon: '/LOGOIPPEL.JPEG',
                                badge: '/LOGOIPPEL.JPEG',
                                tag: `rnc-${notification.id || Date.now()}`,
                                requireInteraction: true,
                                silent: false,
                                vibrate: [200, 100, 200],
                                data: notification,
                                timestamp: Date.now(),
                                renotify: true
                            };
                        } else if (attempt === 2) {
                            console.log(' Tentativa 2: Notificação MÉDIA (sem requireInteraction)');
                            options = {
                                body: body,
                                icon: '/LOGOIPPEL.JPEG',
                                tag: `rnc-${notification.id || Date.now()}-${attempt}`,
                                silent: false,
                                renotify: true
                            };
                        } else {
                            console.log(' Tentativa 3: Notificação MÍNIMA (só essencial)');
                            options = {
                                body: body,
                                tag: `rnc-simple-${Date.now()}`
                            };
                        }
                        
                        const notif = new Notification(title, options);
                        
                        console.log(` Objeto Notification criado (tentativa ${attempt}):`, notif);
                        console.log(' Propriedades:', {
                            title: notif.title,
                            body: notif.body,
                            tag: notif.tag,
                            icon: notif.icon
                        });
                        
                        // Callbacks
                        notif.onshow = function() {
                            console.log(` ===== SUCESSO! NOTIFICAÇÃO EXIBIDA (tentativa ${attempt}) =====`);
                            notifShown = true;
                        };
                        
                        notif.onclick = function(event) {
                            console.log(' Notificação clicada!');
                            event.preventDefault();
                            window.focus();
                            
                            if (notification.rnc_id) {
                                window.location.href = `/rnc/${notification.rnc_id}`;
                            }
                            
                            notif.close();
                        };
                        
                        notif.onerror = function(error) {
                            console.error(` Erro na tentativa ${attempt}:`, error);
                            
                            // Tentar próxima configuração
                            if (attempt < maxAttempts && !notifShown) {
                                setTimeout(() => tryCreateNotification(attempt + 1), 500);
                            }
                        };
                        
                        notif.onclose = function() {
                            console.log(`� Notificação fechada (tentativa ${attempt})`);
                            
                            if (!notifShown) {
                                console.warn(` Notificação FECHOU mas onshow NUNCA foi chamado (tentativa ${attempt})`);
                                console.warn(' Isso significa que o Windows BLOQUEOU a notificação!');
                                console.warn(' Verifique: Win+N → Modo Foco → Desativar "Não Perturbe"');
                                
                                // Tentar próxima configuração
                                if (attempt < maxAttempts) {
                                    setTimeout(() => tryCreateNotification(attempt + 1), 500);
                                } else {
                                    console.error(' TODAS AS TENTATIVAS FALHARAM!');
                                    console.error(' Soluções possíveis:');
                                    console.error('   1. Pressione Win+N e desative "Não Perturbe"');
                                    console.error('   2. Configurações → Sistema → Notificações → Ativar navegador');
                                    console.error('   3. Limpe a Central de Ações (Win+N → Limpar tudo)');
                                }
                            }
                        };
                        
                        // Timeout de 2 segundos para verificar se mostrou
                        setTimeout(() => {
                            if (!notifShown && attempt < maxAttempts) {
                                console.warn(` Timeout de 2s (tentativa ${attempt}) - notificação não foi exibida`);
                                tryCreateNotification(attempt + 1);
                            } else if (!notifShown && attempt >= maxAttempts) {
                                console.error(' FALHA TOTAL: Notificação não apareceu após todas as tentativas');
                                console.error(' O Windows está bloqueando TODAS as notificações deste site!');
                            }
                        }, 2000);
                        
                    } catch (error) {
                        console.error(` EXCEÇÃO na tentativa ${attempt}:`, error);
                        console.error('Stack:', error.stack);
                        
                        // Tentar próxima configuração
                        if (attempt < maxAttempts) {
                            setTimeout(() => tryCreateNotification(attempt + 1), 500);
                        }
                    }
                }
                
                // Iniciar primeira tentativa
                tryCreateNotification(1);
            }
        }
        
        // Solicitar permissão OBRIGATÓRIA para notificações do Windows
        async function requestNotificationPermission() {
            if (!('Notification' in window)) {
                showNotificationNotSupportedModal();
                return false;
            }
            
            // Se já concedida, retornar true
            if (Notification.permission === 'granted') {
                console.log(' Permissão de notificação já concedida');
                
                // Enviar notificação de teste
                setTimeout(() => {
                    new Notification(' Notificações Ativas!', {
                        body: 'Você receberá alertas em tempo real de novas RNCs.',
                        icon: '/LOGOIPPEL.JPEG',
                        requireInteraction: false
                    });
                }, 1000);
                
                return true;
            }
            
            // Se negada ou padrão, mostrar instruções DETALHADAS
            if (Notification.permission === 'denied' || Notification.permission === 'default') {
                console.warn(' Notificações bloqueadas ou não configuradas');
                
                // Mostrar modal com GIF animado e instruções
                showDetailedNotificationInstructions();
                
                // Tentar solicitar mesmo assim
                try {
                    const permission = await Notification.requestPermission();
                    
                    if (permission === 'granted') {
                        console.log(' Permissão de notificação concedida!');
                        
                        // Fechar modal de instruções
                        const modal = document.getElementById('notificationInstructionsModal');
                        if (modal) modal.remove();
                        
                        // Enviar notificação de teste
                        new Notification(' Notificações Ativadas!', {
                            body: 'Você receberá alertas de novas RNCs mesmo com a aba em segundo plano.',
                            icon: '/LOGOIPPEL.JPEG',
                            requireInteraction: false
                        });
                        
                        return true;
                    } else {
                        console.error(' Permissão negada pelo usuário');
                        return false;
                    }
                } catch (error) {
                    console.error('Erro ao solicitar permissão:', error);
                    return false;
                }
            }
            
            return false;
        }
        
        // Modal explicativo para pedir permissão
        function showNotificationPermissionModal() {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                z-index: 999999;
                display: flex;
                align-items: center;
                justify-content: center;
                animation: fadeIn 0.3s;
            `;
            
            modal.innerHTML = `
                <div style="background: white; padding: 40px; border-radius: 15px; max-width: 500px; text-align: center; box-shadow: 0 10px 40px rgba(0,0,0,0.3);">
                    <div style="font-size: 60px; margin-bottom: 20px;"></div>
                    <h2 style="color: #dc3545; margin-bottom: 20px; font-size: 24px;">Ativar Notificações do Windows</h2>
                    <p style="color: #666; font-size: 16px; line-height: 1.6; margin-bottom: 30px;">
                        Para receber <strong>alertas instantâneos</strong> de novas RNCs mesmo com a aba em segundo plano, 
                        você precisa <strong>permitir notificações</strong>.
                    </p>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px; text-align: left;">
                        <strong> Você receberá:</strong><br>
                        • Notificações de novas RNCs<br>
                        • Atualizações de RNCs existentes<br>
                        • Mensagens importantes<br>
                        • Alertas mesmo em segundo plano
                    </div>
                    <p style="color: #ff6b6b; font-weight: bold; font-size: 14px;">
                        Clique em "Permitir" quando o navegador solicitar!
                    </p>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            setTimeout(() => modal.remove(), 5000);
        }
        
        // Modal com instruções DETALHADAS e VISUAIS para desbloquear notificações
        function showDetailedNotificationInstructions() {
            const existingModal = document.getElementById('notificationInstructionsModal');
            if (existingModal) existingModal.remove();
            
            const modal = document.createElement('div');
            modal.id = 'notificationInstructionsModal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.95);
                z-index: 9999999;
                display: flex;
                align-items: center;
                justify-content: center;
                animation: fadeIn 0.3s;
                overflow-y: auto;
            `;
            
            modal.innerHTML = `
                <div style="background: white; padding: 40px; border-radius: 20px; max-width: 800px; width: 90%; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.5);">
                    <div style="text-align: center; margin-bottom: 30px;">
                        <div style="font-size: 80px; margin-bottom: 15px; animation: bounce 1s infinite;">�</div>
                        <h1 style="color: #dc3545; margin: 0; font-size: 32px;">ATIVAR NOTIFICAÇÕES</h1>
                        <p style="color: #666; font-size: 16px; margin-top: 10px;">Obrigatório para receber alertas de RNC em tempo real</p>
                    </div>
                    
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 12px; margin-bottom: 30px; text-align: center;">
                        <strong style="font-size: 18px;"> Por que é importante?</strong><br>
                        <p style="margin: 10px 0 0 0; font-size: 15px;">Você receberá notificações do Windows INSTANTÂNEAS quando houver novas RNCs, mesmo com o navegador minimizado!</p>
                    </div>
                    
                    <div style="background: #f8f9fa; padding: 25px; border-radius: 12px; margin-bottom: 25px;">
                        <h3 style="color: #333; margin-top: 0; font-size: 20px; display: flex; align-items: center;">
                            <span style="background: #dc3545; color: white; width: 35px; height: 35px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; margin-right: 12px; font-weight: bold;">1</span>
                            Clique no ícone de CADEADO
                        </h3>
                        <p style="color: #666; margin: 10px 0 15px 47px; font-size: 15px;">
                            Localize o <strong>ícone de cadeado</strong> ou <strong>ícone de informações (ⓘ)</strong> na barra de endereço do navegador (lado esquerdo)
                        </p>
                        <div style="background: white; padding: 15px; border-radius: 8px; border: 2px dashed #dc3545; margin-left: 47px;">
                            <div style="font-family: monospace; color: #666; font-size: 14px; display: flex; align-items: center;">
                                <span style="font-size: 24px; margin-right: 10px;"></span>
                                <span style="color: #999;">|</span>
                                <span style="margin: 0 10px; color: #0066cc;">http://192.168.3.11:5001/dashboard</span>
                                <span style="color: #999;">...</span>
                            </div>
                        </div>
                    </div>
                    
                    <div style="background: #f8f9fa; padding: 25px; border-radius: 12px; margin-bottom: 25px;">
                        <h3 style="color: #333; margin-top: 0; font-size: 20px; display: flex; align-items: center;">
                            <span style="background: #dc3545; color: white; width: 35px; height: 35px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; margin-right: 12px; font-weight: bold;">2</span>
                            Encontre "Notificações"
                        </h3>
                        <p style="color: #666; margin: 10px 0 15px 47px; font-size: 15px;">
                            No menu que abrir, procure por <strong>"Notificações"</strong>
                        </p>
                        <div style="background: white; padding: 15px; border-radius: 8px; margin-left: 47px; border: 1px solid #ddd;">
                            <div style="display: flex; align-items: center; justify-content: space-between; padding: 8px 0;">
                                <span style="display: flex; align-items: center;">
                                    <span style="font-size: 20px; margin-right: 10px;">�</span>
                                    <strong>Notificações</strong>
                                </span>
                                <span style="color: #dc3545; font-weight: bold;">Bloquear ▼</span>
                            </div>
                        </div>
                    </div>
                    
                    <div style="background: #f8f9fa; padding: 25px; border-radius: 12px; margin-bottom: 25px;">
                        <h3 style="color: #333; margin-top: 0; font-size: 20px; display: flex; align-items: center;">
                            <span style="background: #28a745; color: white; width: 35px; height: 35px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; margin-right: 12px; font-weight: bold;">3</span>
                            Selecione "PERMITIR"
                        </h3>
                        <p style="color: #666; margin: 10px 0 15px 47px; font-size: 15px;">
                            Clique no dropdown e selecione <strong>"Permitir"</strong>
                        </p>
                        <div style="background: white; padding: 15px; border-radius: 8px; margin-left: 47px; border: 2px solid #28a745;">
                            <div style="padding: 8px; background: #d4edda; border-radius: 6px; color: #155724; font-weight: bold; text-align: center;">
                                 Permitir (recomendado)
                            </div>
                            <div style="padding: 8px; color: #666; text-align: center; margin-top: 5px;">
                                Perguntar (padrão)
                            </div>
                            <div style="padding: 8px; color: #999; text-align: center;">
                                Bloquear
                            </div>
                        </div>
                    </div>
                    
                    <div style="background: #fff3cd; padding: 20px; border-radius: 12px; border-left: 5px solid #ffc107; margin-bottom: 25px;">
                        <strong style="color: #856404; font-size: 16px;"> DICA IMPORTANTE:</strong>
                        <p style="color: #856404; margin: 10px 0 0 0; font-size: 14px; line-height: 1.6;">
                            Se o botão "Permitir" não aparecer, pode ser que as notificações já estejam bloqueadas. 
                            Neste caso, você precisa ir em <strong>Configurações do Navegador → Privacidade → Notificações</strong> 
                            e adicionar manualmente o endereço do site à lista de permissões.
                        </p>
                    </div>
                    
                    <div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
                        <button onclick="location.reload()" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 18px 40px; border-radius: 12px; font-size: 18px; font-weight: bold; cursor: pointer; box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4); transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                            Recarregar e Tentar Novamente
                        </button>
                        <button onclick="window.open('chrome://settings/content/notifications', '_blank')" style="background: #6c757d; color: white; border: none; padding: 18px 30px; border-radius: 12px; font-size: 16px; font-weight: bold; cursor: pointer;">
                            Abrir Configurações do Chrome
                        </button>
                    </div>
                    
                    <div style="text-align: center; margin-top: 20px;">
                        <button onclick="this.parentElement.parentElement.parentElement.remove()" style="background: transparent; color: #999; border: none; padding: 10px 20px; font-size: 14px; cursor: pointer; text-decoration: underline;">
                            Fechar (sistema não funcionará completamente)
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Adicionar animação bounce
            const style = document.createElement('style');
            style.textContent = `
                @keyframes bounce {
                    0%, 100% { transform: translateY(0); }
                    50% { transform: translateY(-10px); }
                }
                @keyframes fadeIn {
                    from { opacity: 0; }
                    to { opacity: 1; }
                }
            `;
            document.head.appendChild(style);
        }
        
        // Modal quando navegador não suporta notificações
        function showNotificationNotSupportedModal() {
            alert(' Seu navegador não suporta notificações!\n\nPor favor, use Chrome, Edge ou Firefox atualizado.');
        }
        
        // Modal quando notificações estão bloqueadas
        function showNotificationBlockedModal() {
            showDetailedNotificationInstructions();
        }
        
        // Variáveis para controle de notificações
        let notificationSound = null;
        let lastNotificationCount = 0;
        let notificationPollingInterval = null;
        
        // Carregar som de notificação
        function loadNotificationSound() {
            try {
                // Usar Web Audio API em vez de data URI para evitar CSP
                console.log(' Som de notificação configurado (Web Audio API)');
            } catch (e) {
                console.log('Som de notificação não pôde ser carregado');
            }
        }
        
        // Tocar som de notificação (estilo Minecraft XP)
        function playNotificationSound() {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                
                // Recriar o som icônico de XP do Minecraft
                const playMinecraftNote = (frequency, startTime, duration, volume = 0.3) => {
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    
                    // Onda quadrada para som mais "pixelado" (estilo retro)
                    oscillator.type = 'square';
                    oscillator.frequency.setValueAtTime(frequency, startTime);
                    
                    // Envelope ADSR para som característico do Minecraft
                    gainNode.gain.setValueAtTime(0, startTime);
                    gainNode.gain.linearRampToValueAtTime(volume, startTime + 0.01); // Attack
                    gainNode.gain.exponentialRampToValueAtTime(0.01, startTime + duration); // Decay/Release
                    
                    oscillator.start(startTime);
                    oscillator.stop(startTime + duration);
                };
                
                // Sequência de notas do som de XP do Minecraft
                // Notas: E5, B5, C#6 (659.25, 987.77, 1108.73 Hz)
                const now = audioContext.currentTime;
                playMinecraftNote(659.25, now, 0.15, 0.35);        // E5 - primeira nota
                playMinecraftNote(987.77, now + 0.08, 0.15, 0.3);  // B5 - segunda nota (overlap)
                playMinecraftNote(1108.73, now + 0.15, 0.2, 0.25); // C#6 - nota final
                
                console.log(' Som Minecraft XP tocado! ');
            } catch (error) {
                console.error(' Erro ao tocar som:', error);
            }
        }
        
        // Polling automático para notificações
        function startNotificationPolling() {
            // Verificar novas notificações a cada 3 segundos (reduzido de 1s para evitar rate limit)
            notificationPollingInterval = setInterval(async () => {
                try {
                    const response = await fetch('/api/notifications/unread');
                    
                    // Verificar se resposta é OK antes de parsear JSON
                    if (!response.ok) {
                        if (response.status === 429) {
                            console.warn(' Rate limit atingido para notificações, aguardando...');
                            return; // Pular esta verificação
                        }
                        console.error(`Erro HTTP ${response.status} ao verificar notificações`);
                        return;
                    }
                    
                    const contentType = response.headers.get('content-type');
                    if (!contentType || !contentType.includes('application/json')) {
                        console.error('Resposta não é JSON:', await response.text());
                        return;
                    }
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        const newCount = data.count;
                        
                        // Se há novas notificações
                        if (newCount > lastNotificationCount) {
                            const newNotifications = data.notifications.slice(0, newCount - lastNotificationCount);
                            
                            // Adicionar novas notificações
                            newNotifications.forEach(notification => {
                                notifications.unshift(notification);
                                notificationCount++;
                                
                                // Tocar som
                                playNotificationSound();
                                
                                // Mostrar notificação toast
                                showToastNotification(notification);
                                
                                // Mostrar notificação do navegador
                                showBrowserNotification(notification);
                            });
                            
                            renderNotifications();
                            updateNotificationBadge();
                        }
                        
                        lastNotificationCount = newCount;
                    }
                } catch (error) {
                    // Silenciar erros de parsing para não poluir o console
                    if (error instanceof SyntaxError) {
                        console.warn(' Resposta inválida do servidor (provavelmente rate limit), ignorando...');
                    } else {
                        console.error('Erro ao verificar notificações:', error);
                    }
                }
            }, 3000); // 3 segundos (aumentado de 1s para reduzir carga)
        }
        
        // Atualização automática das RNCs a cada 5 segundos (funciona em segundo plano)
        let autoUpdateRNCsInterval = null;
        let lastRNCCounts = { active: 0, finalized: 0, engenharia: 0 };
        
        function startAutoUpdateRNCs() {
            // Limpar intervalo anterior se existir
            if (autoUpdateRNCsInterval) {
                console.log(' Limpando intervalo anterior de atualização');
                clearInterval(autoUpdateRNCsInterval);
            }
            
            console.log(' Iniciando atualização automática de RNCs a cada 5 segundos (com notificações Windows)...');
            
            // Atualizar a cada 5 segundos (5000ms) - FUNCIONA MESMO EM SEGUNDO PLANO
            autoUpdateRNCsInterval = setInterval(async () => {
                try {
                    // Buscar dados atualizados da aba atual
                    const response = await fetch(`/api/rnc/list?tab=${currentTab}`);
                    const data = await response.json();
                    
                    if (data.success && data.rncs) {
                        const newRNCs = data.rncs || [];
                        const currentCount = newRNCs.length;
                        const previousCount = lastRNCCounts[currentTab] || 0;
                        
                        // Se houver mudança no número de RNCs, atualizar
                        if (currentCount !== previousCount) {
                            console.log(` Auto-update [${currentTab}]: ${previousCount} → ${currentCount} RNCs`);
                            
                            // Atualizar dados
                            rncsData[currentTab] = newRNCs;
                            lastRNCCounts[currentTab] = currentCount;
                            
                            // Re-renderizar apenas se a aba estiver visível
                            if (!document.hidden) {
                                renderRNCs(currentTab);
                                updateCounts();
                            }
                            
                            // Salvar no cache
                            saveDashboardCache({ user: null, rncs: rncsData });
                            
                            //  Se houver NOVAS RNCs (não quando diminuir)
                            if (currentCount > previousCount) {
                                const diff = currentCount - previousCount;
                                
                                // NOTIFICAÇÃO NATIVA DO WINDOWS (funciona em segundo plano)
                                const newestRNCs = newRNCs.slice(0, diff);
                                newestRNCs.forEach(rnc => {
                                    showBrowserNotification({
                                        id: rnc.id,
                                        rnc_id: rnc.id,
                                        title: ' Nova RNC Criada!',
                                        message: `RNC #${rnc.rnc_number || rnc.id}\n${rnc.title || 'Sem título'}\nResponsável: ${rnc.assigned_user_name || 'Não atribuído'}`
                                    });
                                });
                                
                                // Tocar som (funciona em segundo plano)
                                if (window.SoundSystem) {
                                    window.SoundSystem.playNotification();
                                } else {
                                    playNotificationSound();
                                }
                                
                                // Mostrar toast apenas se aba estiver visível
                                if (!document.hidden) {
                                    showToastMessage(` ${diff} nova${diff > 1 ? 's' : ''} RNC${diff > 1 ? 's' : ''} detectada${diff > 1 ? 's' : ''}!`, 'success');
                                }
                                
                                console.log(` ${diff} notificação(ões) do Windows enviada(s)`);
                            }
                        }
                    }
                } catch (error) {
                    // Silenciar erros de rede para não poluir console
                    if (!error.message.includes('Failed to fetch')) {
                        console.warn(' Erro na atualização automática:', error.message);
                    }
                }
            }, 5000); // 5 segundos - CONTINUA EXECUTANDO EM SEGUNDO PLANO
            
            console.log(' Atualização automática de RNCs ativada a cada 5 segundos (funciona em segundo plano)');
        }
        
        function stopAutoUpdateRNCs() {
            if (autoUpdateRNCsInterval) {
                clearInterval(autoUpdateRNCsInterval);
                autoUpdateRNCsInterval = null;
                console.log(' Atualização automática de RNCs pausada');
            }
        }
        
        // MANTÉM ATUALIZAÇÃO ATIVA MESMO EM SEGUNDO PLANO (background)
        // Ao invés de pausar, apenas ajusta a renderização visual
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                console.log(' Aba em segundo plano - notificações Windows ATIVAS');
            } else {
                console.log(' Aba visível - renderizando atualizações');
                // Re-renderizar quando voltar para a aba
                renderRNCs(currentTab);
                updateCounts();
                
                // Verificar se notificações ainda estão permitidas
                if (Notification.permission !== 'granted') {
                    showNotificationBlockedModal();
                }
            }
        });
        
        //  Verificador periódico de permissão de notificação (a cada 30 segundos)
        setInterval(() => {
            if ('Notification' in window && Notification.permission === 'denied') {
                console.warn(' Notificações bloqueadas! Usuário não receberá alertas.');
                
                // Mostrar aviso discreto se aba estiver visível
                if (!document.hidden) {
                    const existingWarning = document.getElementById('notificationWarningBar');
                    if (!existingWarning) {
                        const warningBar = document.createElement('div');
                        warningBar.id = 'notificationWarningBar';
                        warningBar.style.cssText = `
                            position: fixed;
                            top: 0;
                            left: 0;
                            width: 100%;
                            background: linear-gradient(135deg, #dc3545, #c82333);
                            color: white;
                            padding: 12px 20px;
                            z-index: 99999;
                            text-align: center;
                            font-weight: bold;
                            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
                            cursor: pointer;
                        `;
                        warningBar.innerHTML = `
                            NOTIFICAÇÕES BLOQUEADAS - Clique aqui para ativar e receber alertas de RNC
                        `;
                        warningBar.onclick = () => {
                            showNotificationBlockedModal();
                        };
                        document.body.appendChild(warningBar);
                    }
                }
            }
        }, 30000); // 30 segundos
        
        // Função auxiliar para mostrar mensagens toast
        function showToastMessage(message, type = 'info') {
            // Criar elemento toast se não existir
            let toastContainer = document.getElementById('toastContainer');
            if (!toastContainer) {
                toastContainer = document.createElement('div');
                toastContainer.id = 'toastContainer';
                toastContainer.style.cssText = 'position:fixed;top:80px;right:20px;z-index:99999;display:flex;flex-direction:column;gap:10px;max-width:350px;';
                document.body.appendChild(toastContainer);
            }
            
            // Criar toast
            const toast = document.createElement('div');
            const colors = {
                success: '#10b981',
                error: '#ef4444',
                warning: '#f59e0b',
                info: '#3b82f6'
            };
            
            toast.style.cssText = `
                background: ${colors[type] || colors.info};
                color: white;
                padding: 15px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                font-size: 14px;
                font-weight: 500;
                animation: slideInRight 0.3s ease-out;
                cursor: pointer;
                transition: opacity 0.3s;
            `;
            
            toast.textContent = message;
            
            // Remover ao clicar
            toast.onclick = () => {
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 300);
            };
            
            toastContainer.appendChild(toast);
            
            // Auto-remover após 4 segundos
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 300);
            }, 4000);
        }
        
        // Adicionar animação de slide
        if (!document.getElementById('toastAnimation')) {
            const style = document.createElement('style');
            style.id = 'toastAnimation';
            style.textContent = `
                @keyframes slideInRight {
                    from { transform: translateX(100%); opacity: 0; }
                    to { transform: translateX(0); opacity: 1; }
                }
            `;
            document.head.appendChild(style);
        }
        
        // Atualizar badge de notificações
        function updateNotificationBadge() {
            const badge = document.getElementById('notificationBadge');
            if (badge) {
                if (notificationCount > 0) {
                    badge.textContent = notificationCount;
                    badge.style.display = 'block';
                    badge.style.animation = 'pulse 1s infinite';
                } else {
                    badge.style.display = 'none';
                }
            }
        }
        
        // Alternar visibilidade das notificações
        function toggleNotifications() {
            const container = document.getElementById('notificationsContainer');
            if (container.style.display === 'none' || container.style.display === '') {
                container.style.display = 'block';
                // Marcar todas como lidas quando abrir
                if (notificationCount > 0) {
                    markAllNotificationsRead();
                }
            } else {
                container.style.display = 'none';
            }
        }
        
        // ===== FUNÇÃO PARA PARAR TODOS OS INTERVALOS =====
        function stopAllIntervals() {
            console.log(' Parando todos os intervalos...');
            
            // Parar polling de notificações
            if (notificationPollingInterval) {
                clearInterval(notificationPollingInterval);
                notificationPollingInterval = null;
                console.log(' Intervalo de polling de notificações parado');
            }
            
            // Parar atualização automática de RNCs
            if (autoUpdateRNCsInterval) {
                clearInterval(autoUpdateRNCsInterval);
                autoUpdateRNCsInterval = null;
                console.log(' Intervalo de atualização automática de RNCs parado');
            }
            
            // Parar atualização automática de setores
            if (typeof stopSetorAutoRefresh === 'function') {
                stopSetorAutoRefresh();
            }
            
            // Parar som de notificação se houver
            if (typeof notificationSoundInterval !== 'undefined' && notificationSoundInterval) {
                clearInterval(notificationSoundInterval);
                notificationSoundInterval = null;
                console.log(' Intervalo de som de notificação parado');
            }
            
            // Parar auto refresh se houver
            if (typeof autoRefreshInterval !== 'undefined' && autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
                console.log(' Intervalo de auto refresh parado');
            }
        }
        
        // ===== FUNÇÃO GLOBAL PARA ALTERNAR ABAS =====
        // Declarada globalmente para ser acessível pelos eventos onclick
        function switchTab(tab) {
            console.log(` Alternando para aba: ${tab}`);
            
            // PARAR TODOS OS INTERVALOS ANTES DE TROCAR DE ABA
            stopAllIntervals();
            
            // Remover classe active de todos os botões
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Adicionar classe active ao botão clicado
            const activeButton = document.querySelector(`[data-tab="${tab}"]`);
            if (activeButton) {
                activeButton.classList.add('active');
                console.log(` Botão ${tab} ativado`);
            } else {
                console.error(` Botão ${tab} não encontrado`);
            }
            
            // Atualizar variável global da aba atual
            currentTab = tab;
            
            // Mostrar/ocultar filtros baseado na aba
            const filtersContainer = document.getElementById('filtersContainer');
            if (filtersContainer) {
                // Exibir filtros tanto para a aba 'finalized' (lista de finalizados)
                // quanto para 'setores' (gráficos por setor) — usuários esperam
                // poder filtrar quando visualizam RNCs por setor.
                if (tab === 'finalized' || tab === 'setores') {
                    filtersContainer.style.display = 'block';
                    console.log(` Filtros mostrados para aba ${tab}`);
                } else {
                    filtersContainer.style.display = 'none';
                    // Limpar filtros apenas quando saindo de abas que usam lista
                    if (typeof clearFilters === 'function') clearFilters();
                    console.log(` Filtros ocultados para aba ${tab}`);
                }
            } else {
                console.error(` Container de filtros não encontrado`);
            }
            
            // Mostrar/ocultar contêineres baseado na aba
            const containers = {
                'active': 'rncsContainer',
                'finalized': 'rncsContainer', 
                'setores': 'rncsContainer',
                'evidencias': 'evidenciasContainer',
                'lev1415': 'lev1415Container'
            };
            
            // Ocultar todos os contêineres
            Object.values(containers).forEach(containerId => {
                const container = document.getElementById(containerId);
                if (container) {
                    container.style.display = 'none';
                }
            });
            
            // Mostrar contêiner da aba ativa
            const activeContainerId = containers[tab];
            const activeContainer = document.getElementById(activeContainerId);
            if (activeContainer) {
                activeContainer.style.display = 'block';
                console.log(` Container ${activeContainerId} exibido`);
            }
            
            // Mostrar/ocultar conteúdo de setores e RNC grid
            const setoresContent = document.getElementById('setoresContent');
            const rncGrid = document.getElementById('rncGrid');
            
            if (tab === 'setores') {
                if (setoresContent) {
                    setoresContent.style.display = 'block';
                    console.log(' Área de setores exibida');
                }
                if (rncGrid) rncGrid.style.display = 'none';
                
                // Ativar atualização automática
                if (typeof startSetorAutoRefresh === 'function') {
                    startSetorAutoRefresh();
                }
            } else {
                if (setoresContent) {
                    setoresContent.style.display = 'none';
                    console.log(' Área de setores ocultada');
                }
                if (rncGrid && (tab === 'active' || tab === 'finalized')) {
                    rncGrid.style.display = 'grid';
                }
                
                // Desativar atualização automática
                if (typeof stopSetorAutoRefresh === 'function') {
                    stopSetorAutoRefresh();
                }
            }
            
            // Manter compatibilidade com setoresCharts antigo (se existir)
            const setoresCharts = document.getElementById('setoresCharts');
            if (setoresCharts) {
                setoresCharts.style.display = tab === 'setores' ? 'block' : 'none';
            }
            
            // Ações específicas por aba
            if (tab === 'evidencias') {
                console.log(' Carregando evidências mensais...');
                if (typeof loadEvidencias === 'function') {
                    loadEvidencias();
                } else {
                    console.error(' Função loadEvidencias não disponível!');
                }
                // Carregar gráfico de funcionários
                setTimeout(() => {
                    if (typeof loadEmployeePerformance === 'function') {
                        loadEmployeePerformance();
                    }
                }, 500);
            } else if (tab === 'lev1415') {
                console.log(' Carregando levantamento 14-15...');
                if (typeof fillYearSelect === 'function') fillYearSelect();
                if (typeof loadLev1415 === 'function') loadLev1415();
                if (typeof loadLevByYear === 'function') loadLevByYear();
            } else if (tab === 'setores') {
                console.log(' Carregando visualização por setores...');
                // Garantir que os seletores de setor sejam populados e carregar dados
                try {
                    // Preencher lista de setores para seleção
                    if (typeof ensureSectorsLoadedSelect === 'function') ensureSectorsLoadedSelect();
                } catch(e) { console.warn('ensureSectorsLoadedSelect falhou', e); }

                // Dar um pequeno atraso para o DOM e select atualizarem
                setTimeout(() => {
                    if (typeof loadSetorData === 'function') {
                        loadSetorData();
                    } else if (typeof loadDefaultSectorChart === 'function') {
                        loadDefaultSectorChart();
                    }
                }, 150);
            } else {
                // Carregar RNCs para abas active/finalized
                console.log(` Carregando RNCs para aba ${tab}`);
                if (typeof loadRNCs === 'function') {
                    loadRNCs(tab);
                }
            }
            
            // REINICIAR INTERVALOS APENAS PARA ABAS QUE PRECISAM DE NOTIFICAÇÕES
            if (tab === 'active') {
                console.log(' Reiniciando intervalos para aba ACTIVE...');
                // Aguardar um pouco para garantir que os dados carregaram
                setTimeout(() => {
                    startNotificationPolling();
                    startAutoUpdateRNCs();
                }, 1000);
            } else {
                console.log(' Intervalos não serão reiniciados para aba:', tab);
            }
        }
        
        // Função para resetar a visualização para 2014-2015
        function resetLevView() {
            console.log(' Resetando visualização para 2014-2015...');
            
            // Limpar seleção do ano
            const yearSelect = document.getElementById('levYearSelect');
            if (yearSelect) {
                yearSelect.value = '';
            }
            
            // Restaurar título da tabela
            const tableTitle = document.getElementById('levTableTitle');
            if (tableTitle) {
                tableTitle.textContent = ' Tabela 2014-2015 (Histórico)';
            }
            
            // Restaurar título do gráfico de porcentagens
            const percentTitle = document.getElementById('deptPercentTitle');
            if (percentTitle) {
                percentTitle.textContent = ' Porcentagem por Departamento - Anos Combinados';
            }
            
            // Recarregar dados padrão 2014-2015
            if (typeof loadLev1415 === 'function') {
                loadLev1415();
            }
        }
        
        // Função para renderizar o gráfico de porcentagem por departamento
        function renderDepartmentPercentChart(departamentos, totais, porcentagens, year, isDadosReais, grandTotalValue) {
            // Destruir gráfico existente se houver
            if (window._deptPercentChart) {
                window._deptPercentChart.destroy();
            }
            
            // Calcular o total geral se não for fornecido
            const grandTotal = grandTotalValue || departamentos.reduce((sum, dept) => sum + (totais[dept] || 0), 0);
            
            // Cores para cada departamento
            const coresDepartamentos = {
                'Produção': '#0d6efd',     // Azul
                'Engenharia': '#fd7e14',   // Laranja
                'Terceiros': '#dc3545',    // Vermelho
                'Compras': '#198754',      // Verde
                'Comercial': '#ffc107',    // Amarelo
                'Cliente': '#17a2b8',      // Azul claro
                'PCP': '#6610f2',          // Roxo
                'Expedição': '#20c997',    // Verde água
                'Qualidade': '#d63384',    // Rosa
                'Transporte': '#6c757d',   // Cinza
                'Não definido': '#343a40'  // Cinza escuro
            };
            
            // Preparar dados para o gráfico
            const cores = departamentos.map(dept => coresDepartamentos[dept] || '#000000');
            const valores = departamentos.map(dept => totais[dept]);
            const labels = departamentos.map(dept => `${dept}: ${porcentagens[dept]}%`);
            
            // Renderizar gráfico de pizza
            const ctx = document.getElementById('deptPercentChart');
            if (ctx) {
                window._deptPercentChart = new Chart(ctx.getContext('2d'), {
                    type: 'pie',
                    data: {
                        labels: departamentos,
                        datasets: [{
                            data: valores,
                            backgroundColor: cores,
                            borderColor: '#ffffff',
                            borderWidth: 1.5,
                            hoverOffset: 15
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false // Não mostrar legenda aqui - vamos criar uma personalizada
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const dept = context.label;
                                        const value = context.raw;
                                        const percent = porcentagens[dept];
                                        const isMonetary = isDadosReais && value > 1000;
                                        
                                        if (isMonetary) {
                                            return `${dept}: ${percent}% (R$ ${value.toLocaleString('pt-BR', {minimumFractionDigits: 2})})`;
                                        } else {
                                            return `${dept}: ${percent}% (${value} RNCs)`;
                                        }
                                    }
                                }
                            }
                        }
                    }
                });
            }
            
            // Criar legenda personalizada
            const legendEl = document.getElementById('deptPercentLegend');
            if (legendEl) {
                legendEl.innerHTML = departamentos.map((dept, i) => {
                    return `
                        <div style="display:flex; align-items:center; margin-right:8px;">
                            <div style="width:12px; height:12px; background:${cores[i]}; margin-right:4px; border-radius:2px;"></div>
                            <span>${dept}: <b>${porcentagens[dept]}%</b></span>
                        </div>
                    `;
                }).join('');
            }
            
            // Exibir estatísticas mais detalhadas
            const statsEl = document.getElementById('deptPercentStats');
            if (statsEl) {
                // Ordenar departamentos por porcentagem (do maior para o menor)
                const isMonetary = isDadosReais && Math.max(...Object.values(totais)) > 1000;
                const ordenados = [...departamentos].sort((a, b) => totais[b] - totais[a]);
                
                let html = `
                    <h4 style="margin-top:0;"> ${year} - Top Departamentos</h4>
                    <div style="margin-bottom:15px;">
                        <div style="color:#666; margin-bottom:6px;">
                            ${isMonetary ? 
                                'Ranking com base nos valores financeiros totais:' : 
                                'Ranking com base na quantidade total de RNCs:'}
                        </div>
                        <div style="font-weight:bold; font-size:16px; color:#198754;">
                            Líder: ${ordenados[0]} (${porcentagens[ordenados[0]]}%)
                        </div>
                    </div>
                `;
                
                // Mostrar tabela de ranking
                html += `
                    <table style="width:100%; border-collapse:collapse; font-size:13px;">
                        <thead>
                            <tr>
                                <th style="text-align:left; padding:6px; border-bottom:1px solid #e9ecef;">Rank</th>
                                <th style="text-align:left; padding:6px; border-bottom:1px solid #e9ecef;">Departamento</th>
                                <th style="text-align:right; padding:6px; border-bottom:1px solid #e9ecef;">%</th>
                                <th style="text-align:right; padding:6px; border-bottom:1px solid #e9ecef;">Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${ordenados.map((dept, i) => `
                                <tr>
                                    <td style="text-align:left; padding:6px; border-bottom:1px solid #f8f9fa;">#${i+1}</td>
                                    <td style="text-align:left; padding:6px; border-bottom:1px solid #f8f9fa;">${dept}</td>
                                    <td style="text-align:right; padding:6px; border-bottom:1px solid #f8f9fa; font-weight:bold;">${porcentagens[dept]}%</td>
                                    <td style="text-align:right; padding:6px; border-bottom:1px solid #f8f9fa;">
                                        ${isMonetary ? 
                                            `R$ ${totais[dept].toLocaleString('pt-BR', {minimumFractionDigits: 2})}` : 
                                            `${totais[dept]} RNCs`}
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    <div style="margin-top:15px; font-size:12px; color:#6c757d; text-align:center;">
                        ${isMonetary ? 'Valores totais do ano ' : 'RNCs totais do ano '} ${year}: 
                        <b>${isMonetary ? 
                            `R$ ${grandTotal.toLocaleString('pt-BR', {minimumFractionDigits: 2})}` : 
                            `${grandTotal} RNCs`}</b>
                    </div>
                `;
                
                statsEl.innerHTML = html;
            }
        }
        
        // Teste de disponibilidade da função
        console.log(' switchTab function available:', typeof switchTab === 'function');
        
        // FUNÇÃO GLOBAL PARA TESTAR NOTIFICAÇÃO NATIVA
        window.testarNotificacaoNativa = async function() {
            console.log(' ========================================');
            console.log(' TESTANDO NOTIFICAÇÃO NATIVA DO WINDOWS');
            console.log(' ========================================');
            
            // Verificar suporte
            if (!('Notification' in window)) {
                alert(' Seu navegador não suporta notificações desktop!');
                console.error(' Notification API não disponível');
                return;
            }
            
            console.log(' Notification API disponível');
            console.log(' Permissão atual:', Notification.permission);
            
            // Se não tiver permissão, solicitar
            if (Notification.permission === 'default') {
                console.log(' Solicitando permissão...');
                try {
                    const permission = await Notification.requestPermission();
                    console.log(' Resultado da solicitação:', permission);
                    
                    if (permission !== 'granted') {
                        alert(' Você precisa permitir notificações para o teste funcionar!\n\nVá em Configurações do navegador e permita notificações para este site.');
                        return;
                    }
                } catch (error) {
                    console.error(' Erro ao solicitar permissão:', error);
                    alert(' Erro ao solicitar permissão: ' + error.message);
                    return;
                }
            }
            
            // Se permissão negada
            if (Notification.permission === 'denied') {
                alert(' Notificações BLOQUEADAS!\n\nPara desbloquear:\n\n1. Clique no ícone do cadeado na barra de endereços\n2. Permita notificações\n3. Recarregue a página\n4. Tente novamente');
                console.error(' Permissão negada pelo usuário');
                return;
            }
            
            // Se temos permissão, criar notificação
            if (Notification.permission === 'granted') {
                console.log(' Permissão concedida! Criando notificação...');
                console.log(' Tipo de Notification:', typeof Notification);
                console.log(' Notification constructor:', Notification);
                
                try {
                    // Criar notificação COM MENOS OPÇÕES (algumas podem bloquear)
                    const notif = new Notification(' TESTE - Nova RNC Criada', {
                        body: 'RNC-2025-TEST-001 - Sistema de Qualidade IPPEL\n\nClique aqui para visualizar',
                        icon: '/LOGOIPPEL.JPEG',
                        tag: 'test-' + Date.now(),
                        requireInteraction: false, // MUDADO: false permite que apareça e suma
                        silent: false
                    });
                    
                    console.log(' Notificação criada:', notif);
                    console.log(' Propriedades da notificação:', {
                        title: notif.title,
                        body: notif.body,
                        tag: notif.tag,
                        icon: notif.icon
                    });
                    
                    // IMPORTANTE: Aguardar um pouco antes de mostrar o alert
                    let notificationShown = false;
                    
                    notif.onshow = function() {
                        console.log(' ===== NOTIFICAÇÃO EXIBIDA NO WINDOWS! =====');
                        notificationShown = true;
                        setTimeout(() => {
                            if (notificationShown) {
                                alert(' SUCESSO! A notificação do Windows apareceu!\n\n' +
                                      'Agora minimize esta janela e peça para alguém criar uma RNC.\n' +
                                      'Você receberá a notificação mesmo com a janela minimizada!');
                            }
                        }, 500);
                    };
                    
                    notif.onclick = function() {
                        console.log(' Notificação clicada!');
                        window.focus();
                        notif.close();
                    };
                    
                    notif.onerror = function(error) {
                        console.error(' Erro ao exibir notificação:', error);
                        alert(' ERRO ao exibir notificação!\n\n' +
                              'Possíveis causas:\n' +
                              '1. Notificações do Windows estão desativadas\n' +
                              '2. Modo "Não Perturbe" ativado\n' +
                              '3. O navegador não tem permissão no Windows\n\n' +
                              'Verifique: Configurações do Windows → Sistema → Notificações');
                    };
                    
                    notif.onclose = function() {
                        console.log(' Notificação fechada');
                        if (!notificationShown) {
                            console.warn(' Notificação foi fechada mas onshow nunca foi chamado!');
                            alert(' A notificação foi criada mas não apareceu!\n\n' +
                                  'Verifique se:\n' +
                                  '1. O Windows está em modo "Não Perturbe"\n' +
                                  '2. As notificações do navegador estão ativadas no Windows\n' +
                                  '3. Central de Ações do Windows está funcionando\n\n' +
                                  'Pressione Win+N para ver a Central de Ações');
                        }
                    };
                    
                    // TIMEOUT: Se não mostrar em 3 segundos, avisar
                    setTimeout(() => {
                        if (!notificationShown) {
                            console.warn(' Notificação não foi exibida após 3 segundos');
                            alert(' A notificação foi criada mas ainda não apareceu!\n\n' +
                                  'Verifique:\n' +
                                  '1. Central de Ações do Windows (Win+N)\n' +
                                  '2. Configurações → Sistema → Notificações\n' +
                                  '3. Se o modo "Não Perturbe" está DESATIVADO\n\n' +
                                  'A notificação pode estar na Central de Ações!');
                        }
                    }, 3000);
                    
                    // Tocar som também
                    if (typeof playNotificationSound === 'function') {
                        playNotificationSound();
                        console.log(' Som tocado!');
                    }
                    
                } catch (error) {
                    console.error(' Erro ao criar notificação:', error);
                    console.error('Stack trace:', error.stack);
                    alert(' ERRO ao criar notificação:\n\n' + error.message + '\n\nVerifique o console (F12) para mais detalhes.');
                }
            }
            
            console.log(' ========================================');
        };
        
        // Classe AdvancedCharts (placeholder)
        class AdvancedCharts {
            constructor() {
                this.charts = {};
            }
            createHeatmapChart(canvasId, data, options) {
                console.log('Heatmap chart não implementado');
                return null;
            }
            createGaugeChart(canvasId, value, options) {
                console.log('Gauge chart não implementado');
                return null;
            }
            createAdvancedRadarChart(canvasId, data, options) {
                console.log('Radar chart não implementado');
                return null;
            }
        }

        // Renderização imediata a partir do cache local e prefetch paralelo
        document.addEventListener('DOMContentLoaded', function() {
            console.log(' Iniciando dashboard...');
            
            // Inicializar AdvancedCharts
            console.log(' Inicializando AdvancedCharts...');
            if (typeof AdvancedCharts !== 'undefined') {
                window.advancedCharts = new AdvancedCharts();
                
                // Criar funções globais para compatibilidade
                window.createHeatmap = function(canvasId, data, options) {
                    return window.advancedCharts.createHeatmapChart(canvasId, data, options);
                };
                
                window.createGauge = function(canvasId, value, options) {
                    return window.advancedCharts.createGaugeChart(canvasId, value, options);
                };
                
                window.createAdvancedRadar = function(canvasId, data, options) {
                    return window.advancedCharts.createAdvancedRadarChart(canvasId, data, options);
                };
                
                console.log(' AdvancedCharts inicializado com sucesso');
            } else {
                console.error(' AdvancedCharts não disponível!');
            }
            
            // Pré-carregar clientes, setores e responsáveis para os filtros
            setTimeout(() => {
                ensureClientsLoaded().then(() => {
                    console.log(' Clientes pré-carregados para filtros');
                });
                ensureSectorsLoaded().then(() => {
                    console.log(' Setores pré-carregados para filtros');
                });
                ensureResponsiblesLoaded().then(() => {
                    console.log(' Responsáveis pré-carregados para filtros');
                });
            }, 1000);
            
            try {
                // 1) Pintar imediatamente a partir do cache (se houver)
                const dc = loadDashboardCache();
                if (dc) {
                    console.log(' Pintando UI com cache local');
                    if (dc.user) {
                        const userNameElement = document.getElementById('userName');
                        const userDepartmentElement = document.getElementById('userDepartment');
                        if (userNameElement) userNameElement.textContent = dc.user.name || 'Usuário';
                        if (userDepartmentElement) userDepartmentElement.textContent = dc.user.department || '';
                    }
                    if (dc.rncs) {
                        // IMPORTANTE: Carregar dados do cache MAS não renderizar ainda
                        // Aguardar o preload crítico para garantir dados atualizados
                        
                        // CORREÇÃO: Filtrar RNCs finalizadas do cache da aba ATIVOS
                        let activeFromCache = dc.rncs.active || [];
                        const beforeCacheFilter = activeFromCache.length;
                        activeFromCache = activeFromCache.filter(rnc => rnc.status !== 'Finalizado');
                        if (beforeCacheFilter !== activeFromCache.length) {
                            console.warn(` CACHE FILTRADO: ${beforeCacheFilter - activeFromCache.length} RNCs finalizadas removidas do cache da aba ATIVOS`);
                        }
                        
                        rncsData.active = activeFromCache;
                        rncsData.finalized = dc.rncs.finalized || [];
                        {% if user_permissions.canViewEngineeringRncs %}
                        rncsData.engenharia = dc.rncs.engenharia || [];
                        {% endif %}
                        console.log(' Dados do cache carregados (aguardando atualização)');
                    }
                }

                // 2) Preload crítico primeiro, depois dados secundários
                console.log(' Iniciando preload crítico...');
                
                // GARANTIR que currentTab seja 'active' ANTES de qualquer carregamento
                currentTab = 'active';
                
                preloadCriticalData().then(results => {
                    console.log(' Dados críticos carregados:', results);
                    
                    // APÓS carregar dados, renderizar APENAS a aba ATIVOS
                    currentTab = 'active';
                    renderRNCs('active');
                    updateCounts();
                    
                    // Inicializar contadores para auto-update (evitar falsos positivos)
                    lastRNCCounts.active = (rncsData.active || []).length;
                    lastRNCCounts.finalized = (rncsData.finalized || []).length;
                    {% if user_permissions.canViewEngineeringRncs %}
                    lastRNCCounts.engenharia = (rncsData.engenharia || []).length;
                    {% endif %}
                    console.log(' Contadores iniciais:', lastRNCCounts);
                    
                    saveDashboardCache({ user: null, rncs: rncsData });
                    
                    // Carregar dados secundários após dados críticos
                    setTimeout(() => {
                        loadNotifications().catch(err => console.warn('Erro ao carregar notificações:', err));
                    }, 100);
                });
                
                // SOLICITAR PERMISSÃO DE NOTIFICAÇÃO IMEDIATAMENTE
                (async () => {
                    console.log(' Solicitando permissão de notificações automaticamente...');
                    
                    // Verificar se já tem permissão
                    if ('Notification' in window) {
                        console.log(' Status atual:', Notification.permission);
                        
                        // Se não tiver permissão ainda, solicitar IMEDIATAMENTE
                        if (Notification.permission === 'default') {
                            console.log(' Solicitando permissão automaticamente...');
                            try {
                                const permission = await Notification.requestPermission();
                                console.log(' Resultado da solicitação:', permission);
                                
                                if (permission === 'granted') {
                                    console.log(' Permissão concedida!');
                                    // Enviar notificação de boas-vindas
                                    setTimeout(() => {
                                        new Notification(' Notificações Ativadas!', {
                                            body: 'Você receberá alertas em tempo real de novas RNCs e mensagens.',
                                            icon: '/LOGOIPPEL.JPEG',
                                            requireInteraction: false
                                        });
                                    }, 1000);
                                } else {
                                    console.warn(' Permissão negada pelo usuário');
                                }
                            } catch (error) {
                                console.error(' Erro ao solicitar permissão:', error);
                            }
                        } else if (Notification.permission === 'granted') {
                            console.log(' Permissão já concedida anteriormente');
                        } else if (Notification.permission === 'denied') {
                            console.warn(' Permissão foi negada pelo usuário');
                        }
                    } else {
                        console.warn(' Este navegador não suporta notificações desktop');
                    }
                })();
                
                // VERIFICAR permissão novamente após 2 segundos (para mostrar avisos se necessário)
                setTimeout(async () => {
                    console.log(' Verificando permissão de notificações...');
                    console.log(' Status atual:', Notification.permission);
                    
                    // Solicitar permissão OBRIGATÓRIA (se ainda não tiver)
                    const permissionGranted = await requestNotificationPermission();
                    
                    if (!permissionGranted) {
                        console.error(' Sistema não pode funcionar plenamente sem notificações!');
                        
                        // Mostrar aviso persistente
                        const warningBar = document.createElement('div');
                        warningBar.style.cssText = `
                            position: fixed;
                            top: 0;
                            left: 0;
                            width: 100%;
                            background: linear-gradient(135deg, #dc3545, #c82333);
                            color: white;
                            padding: 15px 20px;
                            z-index: 999998;
                            text-align: center;
                            font-weight: bold;
                            font-size: 16px;
                            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
                            cursor: pointer;
                            animation: pulse 2s infinite;
                        `;
                        warningBar.innerHTML = `
                            <span style="font-size: 20px;"></span>
                            <strong>NOTIFICAÇÕES DESATIVADAS</strong> - 
                            Clique aqui para ativar e receber alertas de RNC em tempo real
                        `;
                        warningBar.onclick = () => {
                            showDetailedNotificationInstructions();
                        };
                        
                        // Adicionar animação pulse
                        const style = document.createElement('style');
                        style.textContent = `
                            @keyframes pulse {
                                0%, 100% { transform: scale(1); }
                                50% { transform: scale(1.02); }
                            }
                        `;
                        document.head.appendChild(style);
                        
                        document.body.appendChild(warningBar);
                    }
                    
                    // Configurações assíncronas
                    loadNotificationSound();
                    // REMOVIDO: startNotificationPolling() - Agora controlado pelo switchTab()
                    
                    // REMOVIDO: startAutoUpdateRNCs() - Agora controlado pelo switchTab()
                    // setTimeout(() => {
                    //     startAutoUpdateRNCs();
                    // }, 2000); // Aguardar 2 segundos após o carregamento inicial
                    
                    // Verificação imediata adicional
                    setTimeout(() => {
                        console.log(' Verificação imediata de notificações...');
                        loadNotifications();
                    }, 1000);
                }, 500); // Aguardar 500ms para garantir que DOM está pronto
                
                // Atualizar contadores após carregamento completo
                setTimeout(() => {
                    console.log('� Atualizando contadores finais...');
                        updateCounts();
                        saveDashboardCache({ user: null, rncs: rncsData });
                    console.log(' Contadores atualizados');
                    
                }, 300);
                
                // Garantir que a aba ativa seja mostrada IMEDIATAMENTE
                console.log(' Forçando exibição da aba ATIVOS...');
                switchTab('active');
                
                // Inicializar seletores de ano e mês para desempenho por funcionário
                console.log(' Inicializando seletores de ano e mês...');
                setTimeout(() => {
                    initializeEmployeeSelectors();
                }, 500);
                
            } catch (error) {
                console.error(' Erro na inicialização:', error);
            }
            
            // Conectar ao WebSocket para notificações em tempo real
            if (typeof io !== 'undefined') {
                console.log(' Inicializando SocketIO...');
                const socket = io({
                    transports: ['websocket', 'polling'],
                    reconnection: true,
                    reconnectionDelay: 1000,
                    reconnectionAttempts: 10
                });
                
                // Tornar socket global para debug
                window.socket = socket;
                
                // Log de eventos de conexão
                socket.on('connect_error', function(error) {
                    console.error(' Erro de conexão SocketIO:', error);
                });
                
                socket.on('disconnect', function(reason) {
                    console.log(' SocketIO desconectado:', reason);
                });
                
                socket.on('reconnect', function(attemptNumber) {
                    console.log(' SocketIO reconectado após', attemptNumber, 'tentativas');
                    tryJoinUserRoom();
                });
                
                // Variável para controlar som repetitivo
                let notificationSoundInterval = null;
                let currentNotifications = [];
                
                // Quando conectar, entrar na room do usuário
                socket.on('connect', function() {
                    console.log(' SocketIO conectado!');
                    // Tentar entrar na room imediatamente se userId já estiver disponível
                    tryJoinUserRoom();
                    
                    // Tentar novamente após 2 segundos para garantir que currentUserId foi definido
                    setTimeout(() => {
                        console.log(' Tentando entrar na room novamente...');
                        tryJoinUserRoom();
                    }, 2000);
                });
                
                // Função para tentar entrar na room do usuário
                function tryJoinUserRoom() {
                    if (window.currentUserId) {
                        console.log(` ========================================`);
                        console.log(` TENTANDO ENTRAR NA ROOM DO USUÁRIO`);
                        console.log(` User ID: ${window.currentUserId}`);
                        console.log(` Room: user_${window.currentUserId}`);
                        console.log(` Socket conectado: ${socket.connected}`);
                        console.log(` ========================================`);
                        
                        socket.emit('join_room', { room: `user_${window.currentUserId}` });
                        console.log(` Emitindo join_room para: user_${window.currentUserId}`);
                    } else {
                        // Se não tem userId ainda, tentar novamente em 500ms
                        console.log(' Aguardando currentUserId...');
                        setTimeout(tryJoinUserRoom, 500);
                    }
                }
                
                // Confirmar entrada na room
                socket.on('room_joined', function(data) {
                    console.log(' Entrou na room com sucesso:', data.room);
                });
                
                // DEBUG: Capturar TODOS os eventos SocketIO
                socket.onAny(function(eventName, ...args) {
                    console.log(` Evento SocketIO recebido: ${eventName}`, args);
                });
                
                // Listener para notificações de RNC compartilhada
                socket.on('rnc_notification', function(data) {
                    console.log(' ========================================');
                    console.log(' NOVA NOTIFICAÇÃO DE RNC RECEBIDA!');
                    console.log(' Dados:', data);
                    console.log(' ========================================');
                    
                    // Adicionar à lista de notificações pendentes
                    currentNotifications.push(data);
                    
                    // Adicionar nova notificação
                    notifications.unshift(data);
                    notificationCount++;
                    renderNotifications();
                    updateNotificationBadge();
                    
                    // Mostrar notificação grande e chamativa
                    showEnhancedRNCNotification(data);
                    
                    // Iniciar som repetitivo (a cada 3 segundos)
                    if (!notificationSoundInterval) {
                        playNotificationSound();
                        notificationSoundInterval = setInterval(() => {
                            if (currentNotifications.length > 0) {
                                playNotificationSound();
                            } else {
                                clearInterval(notificationSoundInterval);
                                notificationSoundInterval = null;
                            }
                        }, 3000); // Repetir a cada 3 segundos
                    }
                    
                    // Mostrar notificação do navegador
                    showBrowserNotification(data);
                });
                
                socket.on('notification', function(data) {
                    console.log(' ========================================');
                    console.log(' NOTIFICAÇÃO GERAL RECEBIDA!');
                    console.log(' Dados:', data);
                    console.log(' ========================================');
                    
                    // Adicionar nova notificação
                    notifications.unshift(data);
                    notificationCount++;
                    renderNotifications();
                    updateNotificationBadge();
                    
                    // Tocar som IMEDIATAMENTE
                    playNotificationSound();
                    
                    // Mostrar pop-up lateral IMEDIATAMENTE
                    showSidePopupNotification(data);
                    
                    // Mostrar notificação do navegador
                    showBrowserNotification(data);
                    
                    console.log(' Notificação processada com sucesso!');
                });
                
                socket.on('global_notification', function(data) {
                    console.log(' Notificação global recebida:', data);
                    
                    // Adicionar nova notificação global
                    notifications.unshift(data);
                    notificationCount++;
                    renderNotifications();
                    updateNotificationBadge();
                    
                    // Tocar som
                    playNotificationSound();
                    
                    // Mostrar pop-up lateral chamativo
                    showSidePopupNotification(data);
                    
                    // Mostrar notificação do navegador
                    showBrowserNotification(data);
                });
                
                // Listener para notificações de edição de RNC
                socket.on('rnc_updated', function(data) {
                    console.log(' RNC foi atualizada:', data);
                    
                    // Adicionar nova notificação
                    notifications.unshift(data);
                    notificationCount++;
                    renderNotifications();
                    updateNotificationBadge();
                    
                    // Tocar som
                    playNotificationSound();
                    
                    // Mostrar pop-up lateral
                    showSidePopupNotification(data);
                    
                    // Atualizar lista de RNCs se necessário
                    if (currentTab) {
                        loadRNCs(currentTab);
                    }
                });
                
                // Listener para notificações de criação de RNC
                socket.on('rnc_created', function(data) {
                    console.log(' Nova RNC criada:', data);
                    
                    // Adicionar nova notificação
                    notifications.unshift(data);
                    notificationCount++;
                    renderNotifications();
                    updateNotificationBadge();
                    
                    // Tocar som
                    playNotificationSound();
                    
                    // Mostrar pop-up lateral
                    showSidePopupNotification(data);
                    
                    // Atualizar lista de RNCs
                    if (currentTab) {
                        loadRNCs(currentTab);
                    }
                });
                
                // Função para testar notificações
                window.testNotification = function() {
                    console.log(' Testando sistema de notificações...');
                    
                    // Testar som
                    playNotificationSound();
                    
                    // Testar pop-up lateral
                    const testNotification = {
                        type: 'test',
                        title: ' Teste de Notificação',
                        message: 'Esta é uma notificação de teste!',
                        timestamp: new Date().toISOString()
                    };
                    
                    showSidePopupNotification(testNotification);
                    
                    console.log(' Teste de notificação executado!');
                };
                
                // Função para forçar verificação de notificações
                window.forceCheckNotifications = function() {
                    console.log(' Forçando verificação de notificações...');
                    loadNotifications();
                };
                
                // Função para verificar status da conexão
                window.checkConnectionStatus = function() {
                    console.log(' ========================================');
                    console.log(' VERIFICANDO STATUS DA CONEXÃO');
                    console.log(` User ID: ${window.currentUserId}`);
                    console.log(` Socket conectado: ${socket.connected}`);
                    console.log(` Room esperada: user_${window.currentUserId}`);
                    console.log(' ========================================');
                    
                    // Tentar entrar na room novamente
                    if (window.currentUserId && socket.connected) {
                        console.log(' Tentando entrar na room novamente...');
                        socket.emit('join_room', { room: `user_${window.currentUserId}` });
                    }
                };
                
                // Função para simular notificação de mensagem
                window.simulateMessageNotification = function() {
                    console.log(' Simulando notificação de mensagem...');
                    
                    const testNotification = {
                        type: 'new_message',
                        title: ' Nova mensagem no RNC RNC-2025-10-11-182945',
                        message: 'Administrador: teste',
                        rnc_id: 14839,
                        rnc_number: 'RNC-2025-10-11-182945',
                        rnc_title: 'dwad',
                        user_name: 'Administrador',
                        department: 'Administradores',
                        timestamp: new Date().toISOString()
                    };
                    
                    // Simular recebimento de notificação diretamente
                    console.log(' ========================================');
                    console.log(' NOTIFICAÇÃO GERAL RECEBIDA!');
                    console.log(' Dados:', testNotification);
                    console.log(' ========================================');
                    
                    // Adicionar nova notificação
                    notifications.unshift(testNotification);
                    notificationCount++;
                    renderNotifications();
                    updateNotificationBadge();
                    
                    // Tocar som IMEDIATAMENTE
                    playNotificationSound();
                    
                    // Mostrar pop-up lateral IMEDIATAMENTE
                    showSidePopupNotification(testNotification);
                    
                    console.log(' Notificação simulada processada!');
                };
                
                // Função para limpar notificação pendente
                window.clearRNCNotification = function(rncId) {
                    currentNotifications = currentNotifications.filter(n => n.rnc_id !== rncId);
                    if (currentNotifications.length === 0 && notificationSoundInterval) {
                        clearInterval(notificationSoundInterval);
                        notificationSoundInterval = null;
                    }
                };
            }
            
            // Limpar intervalo quando a página for fechada
            window.addEventListener('beforeunload', () => {
                if (notificationPollingInterval) {
                    clearInterval(notificationPollingInterval);
                }
            });
        });
        
        // Mostrar notificação GRANDE e CHAMATIVA para RNC compartilhada
        function showEnhancedRNCNotification(notification) {
            // Remover notificação anterior se existir
            const existingNotif = document.getElementById('enhancedRNCNotification');
            if (existingNotif) {
                existingNotif.remove();
            }
            
            const notifContainer = document.createElement('div');
            notifContainer.id = 'enhancedRNCNotification';
            notifContainer.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: linear-gradient(135deg, #dc3545, #c82333);
                color: white;
                padding: 35px 45px;
                border-radius: 20px;
                box-shadow: 0 20px 60px rgba(220,53,69,0.6);
                z-index: 10000;
                animation: pulseScale 1.5s ease-in-out infinite;
                max-width: 500px;
                min-width: 400px;
                border: 5px solid rgba(255,255,255,0.3);
            `;
            
            notifContainer.innerHTML = `
                <div style="text-align: center;">
                    <div style="font-size: 64px; margin-bottom: 15px; animation: bounce 1s ease-in-out infinite;">
                        
                    </div>
                    <div style="font-weight: 800; font-size: 24px; margin-bottom: 10px; text-shadow: 2px 2px 4px rgba(0,0,0,0.3);">
                        ${notification.title}
                    </div>
                    <div style="font-size: 16px; margin-bottom: 20px; line-height: 1.5; opacity: 0.95;">
                        ${notification.message}
                    </div>
                    <div style="display: flex; gap: 15px; justify-content: center; margin-top: 25px;">
                        <button onclick="viewRNC(${notification.rnc_id})" style="
                            background: white;
                            color: #dc3545;
                            border: none;
                            padding: 14px 28px;
                border-radius: 10px;
                            font-weight: 700;
                            font-size: 15px;
                cursor: pointer;
                            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                            transition: transform 0.2s;
                        " onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                            Ver RNC
                        </button>
                        <button onclick="dismissRNCNotification(${notification.rnc_id})" style="
                            background: rgba(255,255,255,0.2);
                            color: white;
                            border: 2px solid white;
                            padding: 14px 28px;
                            border-radius: 10px;
                            font-weight: 700;
                            font-size: 15px;
                            cursor: pointer;
                            transition: all 0.2s;
                        " onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">
                             Entendi
                        </button>
                    </div>
                    <div style="margin-top: 15px; font-size: 12px; opacity: 0.8;">
                        RNC: <strong>${notification.rnc_number}</strong>
                    </div>
                </div>
            `;
            
            // Adicionar backdrop escuro
            const backdrop = document.createElement('div');
            backdrop.id = 'notificationBackdrop';
            backdrop.style.cssText = `
                position: fixed;
                inset: 0;
                background: rgba(0,0,0,0.7);
                z-index: 9999;
                backdrop-filter: blur(5px);
            `;
            
            document.body.appendChild(backdrop);
            document.body.appendChild(notifContainer);
            
            // Adicionar estilos de animação
            const style = document.createElement('style');
            style.textContent = `
                @keyframes pulseScale {
                    0%, 100% { transform: translate(-50%, -50%) scale(1); }
                    50% { transform: translate(-50%, -50%) scale(1.03); }
                }
                @keyframes bounce {
                    0%, 100% { transform: translateY(0); }
                    50% { transform: translateY(-10px); }
                }
            `;
            document.head.appendChild(style);
        }
        
        // Função para visualizar RNC
        function viewRNC(rncId) {
            clearRNCNotification(rncId);
            const notif = document.getElementById('enhancedRNCNotification');
            const backdrop = document.getElementById('notificationBackdrop');
            if (notif) notif.remove();
            if (backdrop) backdrop.remove();
            window.location.href = `/rnc/${rncId}/chat`;
        }
        
        // Função para dispensar notificação
        function dismissRNCNotification(rncId) {
            clearRNCNotification(rncId);
            const notif = document.getElementById('enhancedRNCNotification');
            const backdrop = document.getElementById('notificationBackdrop');
            if (notif) {
                notif.style.animation = 'fadeOut 0.3s ease-out';
                setTimeout(() => notif.remove(), 300);
            }
            if (backdrop) {
                backdrop.style.animation = 'fadeOut 0.3s ease-out';
                setTimeout(() => backdrop.remove(), 300);
            }
            
            // Atualizar dashboard para mostrar nova RNC
            forceRefreshDashboard();
        }
        
        // Contador para gerenciar múltiplos pop-ups
        let popupQueue = [];
        let currentPopupCount = 0;
        const MAX_POPUPS = 5;
        
        // Mostrar pop-up lateral MODERNO e CHAMATIVO
        function showSidePopupNotification(notification) {
            console.log(' showSidePopupNotification chamada:', notification);
            console.log(' Contagem atual de popups:', currentPopupCount, '/', MAX_POPUPS);
            
            // Limitar número de pop-ups simultâneos
            if (currentPopupCount >= MAX_POPUPS) {
                console.log(' Limite de popups atingido, adicionando à fila');
                popupQueue.push(notification);
                return;
            }
            
            currentPopupCount++;
            console.log(' Criando popup... Contagem agora:', currentPopupCount);
            
            // Determinar ícone e cor baseado no tipo
            let icon = '';
            let gradientColor = 'linear-gradient(135deg, #3b82f6, #2563eb)';
            let borderColor = '#3b82f6';
            
            if (notification.type === 'new_message') {
                icon = '';
                gradientColor = 'linear-gradient(135deg, #8b5cf6, #7c3aed)';
                borderColor = '#8b5cf6';
            } else if (notification.type === 'rnc_shared') {
                icon = '';
                gradientColor = 'linear-gradient(135deg, #dc3545, #c82333)';
                borderColor = '#dc3545';
            } else if (notification.type === 'rnc_updated') {
                icon = '';
                gradientColor = 'linear-gradient(135deg, #f59e0b, #d97706)';
                borderColor = '#f59e0b';
            } else if (notification.type === 'rnc_created') {
                icon = '';
                gradientColor = 'linear-gradient(135deg, #10b981, #059669)';
                borderColor = '#10b981';
            }
            
            const popup = document.createElement('div');
            popup.className = 'side-popup-notification';
            popup.style.cssText = `
                position: fixed;
                top: ${80 + (currentPopupCount - 1) * 140}px;
                right: -400px;
                width: 380px;
                background: white;
                border-radius: 16px;
                box-shadow: 0 10px 40px rgba(0,0,0,0.2);
                z-index: 5000;
                transition: right 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
                border-left: 6px solid ${borderColor};
                overflow: hidden;
            `;
            
            popup.innerHTML = `
                <div style="background: ${gradientColor}; padding: 12px 16px; display: flex; align-items: center; gap: 12px;">
                    <div style="font-size: 28px; animation: bounce 1s ease-in-out infinite;">${icon}</div>
                    <div style="flex: 1;">
                        <div style="color: white; font-weight: 700; font-size: 15px;">${notification.title || 'Notificação'}</div>
                        <div style="color: rgba(255,255,255,0.9); font-size: 12px; margin-top: 2px;">
                            ${notification.user_name || ''} ${notification.department ? `• ${notification.department}` : ''}
                        </div>
                    </div>
                    <button onclick="this.closest('.side-popup-notification').remove(); popupClosed();" style="
                        background: rgba(255,255,255,0.2);
                        border: none;
                        color: white;
                        width: 28px;
                        height: 28px;
                        border-radius: 50%;
                        cursor: pointer;
                        font-size: 18px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        transition: all 0.2s;
                    " onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">
                        ×
                    </button>
                </div>
                <div style="padding: 16px;">
                    <div style="color: #374151; font-size: 14px; line-height: 1.5; margin-bottom: 12px;">
                        ${notification.message || ''}
                    </div>
                    ${notification.rnc_number ? `
                        <div style="background: #f3f4f6; padding: 8px 12px; border-radius: 8px; font-size: 13px; color: #6b7280; margin-bottom: 12px;">
                            <strong>RNC:</strong> ${notification.rnc_number}
                        </div>
                    ` : ''}
                    <div style="display: flex; gap: 8px; justify-content: flex-end;">
                        ${notification.rnc_id ? `
                            <button onclick="window.location.href='/rnc/${notification.rnc_id}/chat'" style="
                                background: ${gradientColor};
                                color: white;
                                border: none;
                                padding: 8px 16px;
                                border-radius: 8px;
                                font-weight: 600;
                                font-size: 13px;
                                cursor: pointer;
                                transition: all 0.2s;
                            " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.15)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                                Ver Agora
                            </button>
                        ` : ''}
                        <button onclick="this.closest('.side-popup-notification').remove(); popupClosed();" style="
                            background: #f3f4f6;
                            color: #6b7280;
                            border: none;
                            padding: 8px 16px;
                            border-radius: 8px;
                            font-weight: 600;
                            font-size: 13px;
                            cursor: pointer;
                            transition: all 0.2s;
                        " onmouseover="this.style.background='#e5e7eb'" onmouseout="this.style.background='#f3f4f6'">
                            Dispensar
                        </button>
                    </div>
                </div>
                <div style="
                    position: absolute;
                    bottom: 0;
                    left: 0;
                    height: 4px;
                    background: ${borderColor};
                    width: 100%;
                    animation: progressBar 8s linear forwards;
                "></div>
            `;
            
            console.log(' Popup HTML criado, adicionando ao body...');
            document.body.appendChild(popup);
            console.log(' Popup adicionado ao body!');
            console.log(' Posição do popup:', popup.style.top, popup.style.right);
            
            // Animar entrada
            setTimeout(() => {
                console.log(' Animando entrada do popup...');
                popup.style.right = '20px';
                console.log(' Popup deve estar visível agora em right: 20px');
            }, 10);
            
            // Auto-remover após 8 segundos
                setTimeout(() => {
                console.log(' 8 segundos passados, removendo popup...');
                if (document.body.contains(popup)) {
                    popup.style.right = '-400px';
                    setTimeout(() => {
                        if (document.body.contains(popup)) {
                            popup.remove();
                            popupClosed();
                        }
                    }, 400);
                }
            }, 8000);
        }
        
        // Função chamada quando popup é fechado
        function popupClosed() {
            currentPopupCount = Math.max(0, currentPopupCount - 1);
            
            // Reposicionar pop-ups restantes
            const popups = document.querySelectorAll('.side-popup-notification');
            popups.forEach((popup, index) => {
                popup.style.top = `${80 + index * 140}px`;
            });
            
            // Mostrar próximo da fila se houver
            if (popupQueue.length > 0 && currentPopupCount < MAX_POPUPS) {
                const nextNotification = popupQueue.shift();
                showSidePopupNotification(nextNotification);
            }
        }
        
        // Mostrar notificação toast (mantida para compatibilidade)
        function showToastNotification(notification) {
            showSidePopupNotification(notification);
        }
        

        
        // Função para aplicar filtros
        function applyFilters() {
            const rncNumber = document.getElementById('filterRncNumber').value.toLowerCase();
            const clientElem = document.getElementById('filterClientSelect');
            const client = clientElem ? (clientElem.value || '').toLowerCase() : (document.getElementById('filterClient') ? document.getElementById('filterClient').value.toLowerCase() : '');
            const equipment = document.getElementById('filterEquipment').value.toLowerCase();
            const department = document.getElementById('filterDepartment').value.toLowerCase();
            const priority = document.getElementById('filterPriority') ? document.getElementById('filterPriority').value.toLowerCase() : '';
            const responsible = document.getElementById('filterResponsible') ? document.getElementById('filterResponsible').value.toLowerCase() : '';
            const dateStart = document.getElementById('filterDateStart') ? document.getElementById('filterDateStart').value : '';
            const dateEnd = document.getElementById('filterDateEnd') ? document.getElementById('filterDateEnd').value : '';
            const cv = document.getElementById('filterCV') ? document.getElementById('filterCV').value.toLowerCase() : '';
            const drawing = document.getElementById('filterDrawing') ? document.getElementById('filterDrawing').value.toLowerCase() : '';
            
            currentFilters = {
                rncNumber,
                client,
                equipment,
                department,
                priority,
                responsible,
                dateStart,
                dateEnd,
                cv,
                drawing
            };
            
            // Filtrar RNCs finalizados
            if (currentTab === 'finalized' && rncsData.finalized) {
                filteredRNCs = rncsData.finalized.filter(rnc => {
                    const matchesRncNumber = !rncNumber || rnc.rnc_number.toLowerCase().includes(rncNumber);
                    const clientField = rnc.cliente || rnc.client || '';
                    const matchesClient = !client || (clientField && clientField.toLowerCase().includes(client));
                    const matchesEquipment = !equipment || (rnc.equipment && rnc.equipment.toLowerCase().includes(equipment));
                    const matchesDepartment = !department || (rnc.setor && rnc.setor.toLowerCase().includes(department));
                    const matchesCV = !cv || (rnc.cv && rnc.cv.toLowerCase().includes(cv));
                    const matchesDrawing = !drawing || (rnc.drawing && rnc.drawing.toLowerCase().includes(drawing));
                    
                    let matchesDate = true;
                    if (dateStart || dateEnd) {
                        const d = rnc.finalized_at ? new Date(rnc.finalized_at) : null;
                        if (!d) {
                            matchesDate = false;
                        } else {
                            if (dateStart) {
                                const s = new Date(dateStart); s.setHours(0,0,0,0);
                                if (d < s) matchesDate = false;
                            }
                            if (dateEnd) {
                                const e = new Date(dateEnd); e.setHours(23,59,59,999);
                                if (d > e) matchesDate = false;
                            }
                        }
                    }
                    
                    return matchesRncNumber && matchesClient && matchesEquipment && matchesDepartment && matchesCV && matchesDrawing && matchesDate;
                });
                
                // Usar a função de tabela para RNCs finalizados
                const grid = document.getElementById('rncGrid');
                grid.innerHTML = createRNCTable(filteredRNCs, 'finalized');
                
                // Mostrar contador de resultados filtrados
                showFilteredResultsCount(filteredRNCs.length, rncsData.finalized.length);
            }
        }

        function filterActive(list) {
            const f = currentFilters || {};
            return (list || []).filter(rnc => {
                const matchesNumber = !f.rncNumber || rnc.rnc_number?.toLowerCase().includes(f.rncNumber);
                const clientField = rnc.cliente || rnc.client || '';
                const matchesClient = !f.client || (clientField && clientField.toLowerCase().includes(f.client));
                const matchesEquip = !f.equipment || (rnc.equipment && rnc.equipment.toLowerCase().includes(f.equipment));
                const matchesDept = !f.department || (rnc.setor && rnc.setor.toLowerCase().includes(f.department));
                const matchesPriority = !f.priority || (rnc.priority && rnc.priority.toLowerCase().includes(f.priority));
                const matchesResp = !f.responsible || (rnc.user_name && rnc.user_name.toLowerCase().includes(f.responsible));
                return matchesNumber && matchesClient && matchesEquip && matchesDept && matchesPriority && matchesResp;
            });
        }
        
        // Função para mostrar contador de resultados filtrados
        function showFilteredResultsCount(filteredCount, totalCount) {
            const filtersContainer = document.getElementById('filtersContainer');
            let resultsCounter = filtersContainer.querySelector('.results-counter');
            
            if (!resultsCounter) {
                resultsCounter = document.createElement('div');
                resultsCounter.className = 'results-counter';
                resultsCounter.style.cssText = `
                    text-align: center;
                    padding: 10px;
                    background: #e9ecef;
                    border-radius: 6px;
                    margin-top: 10px;
                    font-size: 14px;
                    color: #495057;
                `;
                filtersContainer.appendChild(resultsCounter);
            }
            
            if (filteredCount !== totalCount) {
                if (filteredCount === 0) {
                    resultsCounter.textContent = `Nenhum RNC encontrado com os filtros aplicados`;
                    resultsCounter.style.background = '#f8d7da';
                    resultsCounter.style.color = '#721c24';
                } else {
                    resultsCounter.textContent = `Mostrando ${filteredCount} de ${totalCount} RNCs finalizados`;
                    resultsCounter.style.background = '#e9ecef';
                    resultsCounter.style.color = '#495057';
                }
                resultsCounter.style.display = 'block';
            } else {
                resultsCounter.style.display = 'none';
            }
        }
        
        // Variáveis para ordenação
        let currentSortColumn = '';
        let currentSortDirection = 'asc';
        
        // Função para ordenar tabela
        function sortTable(column) {
            const rncs = currentTab === 'finalized' ? (filteredRNCs.length > 0 ? filteredRNCs : rncsData.finalized) : rncsData[currentTab];
            
            if (!rncs || rncs.length === 0) return;
            
            // Alternar direção se clicar na mesma coluna
            if (currentSortColumn === column) {
                currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                currentSortColumn = column;
                currentSortDirection = 'asc';
            }
            
            // Ordenar os dados
            const sortedRNCs = [...rncs].sort((a, b) => {
                let aValue = a[column] || '';
                let bValue = b[column] || '';
                
                // Converter para string para comparação
                aValue = String(aValue).toLowerCase();
                bValue = String(bValue).toLowerCase();
                
                if (currentSortDirection === 'asc') {
                    return aValue.localeCompare(bValue);
                } else {
                    return bValue.localeCompare(aValue);
                }
            });
            
            // Atualizar dados
            if (currentTab === 'finalized') {
                if (filteredRNCs.length > 0) {
                    filteredRNCs = sortedRNCs;
                } else {
                    rncsData.finalized = sortedRNCs;
                }
            } else {
                rncsData[currentTab] = sortedRNCs;
            }
            
            // Re-renderizar tabela
            renderRNCs(currentTab);
            
            // Atualizar ícones de ordenação
            updateSortIcons(column, currentSortDirection);
        }
        
        // Função para atualizar ícones de ordenação
        function updateSortIcons(activeColumn, direction) {
            const headers = document.querySelectorAll('.sortable');
            headers.forEach(header => {
                header.classList.remove('asc', 'desc');
                if (header.onclick.toString().includes(activeColumn)) {
                    header.classList.add(direction);
                }
            });
        }
        
        // Função para limpar filtros
        function clearFilters() {
            document.getElementById('filterRncNumber').value = '';
            const clientSel = document.getElementById('filterClientSelect');
            if (clientSel) clientSel.value = '';
            else if (document.getElementById('filterClient')) document.getElementById('filterClient').value = '';
            document.getElementById('filterEquipment').value = '';
            document.getElementById('filterDepartment').value = '';
            if (document.getElementById('filterPriority')) document.getElementById('filterPriority').value = '';
            if (document.getElementById('filterResponsible')) document.getElementById('filterResponsible').value = '';
            if (document.getElementById('filterDateStart')) document.getElementById('filterDateStart').value = '';
            if (document.getElementById('filterDateEnd')) document.getElementById('filterDateEnd').value = '';
            if (document.getElementById('filterCV')) document.getElementById('filterCV').value = '';
            if (document.getElementById('filterDrawing')) document.getElementById('filterDrawing').value = '';
            
            currentFilters = {
                rncNumber: '',
                client: '',
                equipment: '',
                department: '',
                priority: '',
                responsible: '',
                dateStart: '',
                dateEnd: '',
                cv: '',
                drawing: ''
            };
            
            filteredRNCs = [];
            
            // Esconder contador de resultados
            const filtersContainer = document.getElementById('filtersContainer');
            const resultsCounter = filtersContainer.querySelector('.results-counter');
            if (resultsCounter) {
                resultsCounter.style.display = 'none';
            }
            
            // Recarregar RNCs sem filtros
            if (currentTab === 'finalized') {
                loadRNCs('finalized');
            }
        }
        
        // ===== FUNÇÕES PARA GRÁFICOS =====
        
        // Função para atualizar contador de RNCs
        function updateTotalCount(count) {
            // Atualizar badges de contadores se existirem
            const badges = document.querySelectorAll('.rnc-count-badge');
            badges.forEach(badge => {
                if (badge && currentTab) {
                    badge.textContent = count;
                }
            });
        }
        
        // ===== SISTEMA DE GRÁFICOS AVANÇADO =====
        let charts = {};
        let chartsData = null;
        let autoRefreshInterval = null;
        let isAutoRefreshing = false;

        function initializeCharts() {
            console.log(' INICIANDO SISTEMA DE GRÁFICOS...');
            
            // Verificar se estamos na aba correta
            const chartsContainer = document.getElementById('chartsContainer');
            if (!chartsContainer) {
                console.error(' Container de gráficos não encontrado!');
                return;
            }
            
            console.log(' Container de gráficos encontrado');
            console.log(' Estado atual do container:', chartsContainer.style.display);
            
            if (chartsContainer.style.display === 'none' || chartsContainer.style.display === '') {
                console.log(' Container estava oculto, exibindo...');
                chartsContainer.style.display = 'block';
                console.log(' Container agora está visível:', chartsContainer.style.display);
            }
            
            // Verificar se os elementos de canvas existem
            const canvasElements = [
                'trendChart', 'statusChart', 'priorityChart', 'usersChart', 'equipmentChart',
                'areaChart', 'scatterChart', 'stackedChart', 'heatmapChart', 'gaugeChart', 'radarChart'
            ];
            
            console.log(' Verificando elementos de canvas:');
            canvasElements.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    console.log(`   ${id}: encontrado`);
                } else {
                    console.error(`  ${id}: NÃO encontrado`);
                }
            });
            
            // Delay para garantir renderização
            console.log(' Aguardando renderização...');
            setTimeout(() => {
                console.log(' Iniciando carregamento de dados...');
                loadChartData();
                updateKPIs();
            }, 200);
        }

        function updateKPIs() {
            fetch('/dashboard/api/kpis')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('kpi-total').textContent = data.total.toLocaleString('pt-BR');
                    document.getElementById('kpi-avgtime').textContent = data.avgTime + ' dias';
                    document.getElementById('kpi-resolution').textContent = data.resolution + '%';
                    document.getElementById('kpi-efficiency').textContent = data.efficiency + '%';
                    
                    // Mudanças percentuais
                    updateKPIChange('kpi-total-change', data.totalChange);
                    updateKPIChange('kpi-avgtime-change', data.avgTimeChange);
                    updateKPIChange('kpi-resolution-change', data.resolutionChange);
                    updateKPIChange('kpi-efficiency-change', data.efficiencyChange);
                })
                .catch(error => {
                    console.log('KPIs usando dados simulados');
                    // Dados simulados
                    document.getElementById('kpi-total').textContent = '2,856';
                    document.getElementById('kpi-avgtime').textContent = '7.2 dias';
                    document.getElementById('kpi-resolution').textContent = '87%';
                    document.getElementById('kpi-efficiency').textContent = '92%';
                    
                    updateKPIChange('kpi-total-change', 12);
                    updateKPIChange('kpi-avgtime-change', -8);
                    updateKPIChange('kpi-resolution-change', 5);
                    updateKPIChange('kpi-efficiency-change', 3);
                });
        }

        function updateKPIChange(elementId, change) {
            const element = document.getElementById(elementId);
            if (change > 0) {
                element.innerHTML = ` +${change}%`;
                element.style.color = '#4ade80';
            } else if (change < 0) {
                element.innerHTML = ` ${change}%`;
                element.style.color = '#f87171';
            } else {
                element.innerHTML = '→ Estável';
                element.style.color = '#64748b';
            }
        }

        // Função para carregar dados dos gráficos APRIMORADA
        function loadChartData() {
            const period = document.getElementById('chartPeriod').value;
            const department = document.getElementById('chartDepartment').value;
            console.log(` Carregando dados avançados para ${period} dias, departamento: ${department}`);
            
            const params = new URLSearchParams({
                period: period,
                department: department
            });

            // Tentar carregar dados reais primeiro
            fetch(`/api/charts/simple-data?${params}`)
                .then(r => r.json())
                .then(resp => {
                    if (!resp || resp.success === false) {
                        console.log('API não disponível, usando dados simulados');
                        loadSimulatedData();
                        return;
                    }
                    const data = resp.data || resp;
                    console.log(' Dados dos gráficos avançados:', data);
                    console.log(' Verificando dados específicos:');
                    console.log('  - users:', data.users);
                    console.log('  - equipment:', data.equipment);
                    createAdvancedCharts(data);
                })
                .catch(error => {
                    console.log('API não disponível, usando dados simulados:', error);
                    loadSimulatedData();
                });
        }

        // Expor loadChartData globalmente
        window.loadChartData = loadChartData;

        function loadSimulatedData() {
            console.log(' Carregando dados simulados para gráficos');
            // Dados simulados mais realistas baseados no banco
            const simulatedData = {
                trend: Array.from({length: 30}, (_, i) => ({
                    date: new Date(Date.now() - (29-i) * 24 * 60 * 60 * 1000).toISOString(),
                    count: Math.floor(Math.random() * 15) + 5
                })),
                status: [
                    { label: 'Aberta', count: 125, color: '#ff6b6b' },
                    { label: 'Em Análise', count: 89, color: '#4ecdc4' },
                    { label: 'Aguardando', count: 34, color: '#45b7d1' },
                    { label: 'Finalizada', count: 342, color: '#96ceb4' }
                ],
                priority: [
                    { label: 'Baixa', count: 180, color: '#4ade80' },
                    { label: 'Média', count: 250, color: '#fbbf24' },
                    { label: 'Alta', count: 120, color: '#f97316' },
                    { label: 'Crítica', count: 40, color: '#ef4444' }
                ],
                users: [
                    { label: 'João Silva', count: 25 },
                    { label: 'Maria Santos', count: 18 },
                    { label: 'Carlos Lima', count: 22 },
                    { label: 'Ana Costa', count: 15 },
                    { label: 'Pedro Rocha', count: 12 }
                ],
                equipment: [
                    { label: 'Torno CNC', count: 8 },
                    { label: 'Prensa Hidráulica', count: 12 },
                    { label: 'Soldadora MIG', count: 6 },
                    { label: 'Compressor', count: 9 },
                    { label: 'Fresa', count: 7 }
                ],
                kpis: { total: 590, resolved: 512 },
                departments: [
                    { label: 'Produção', count: 45, efficiency: 85 },
                    { label: 'Qualidade', count: 32, efficiency: 92 },
                    { label: 'Manutenção', count: 28, efficiency: 78 },
                    { label: 'Comercial', count: 15, efficiency: 95 }
                ],
                heatmap: [],
                area: {
                    dates: ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun'],
                    datasets: [
                        { label: 'Abertas', data: [20, 25, 18, 30, 22, 28] },
                        { label: 'Em Análise', data: [15, 20, 12, 25, 18, 22] },
                        { label: 'Finalizadas', data: [35, 40, 30, 45, 38, 42] }
                    ]
                },
                scatter: {
                    data: [
                        { x: 1, y: 5 }, { x: 2, y: 8 }, { x: 3, y: 12 }, { x: 4, y: 15 },
                        { x: 1, y: 3 }, { x: 2, y: 6 }, { x: 3, y: 9 }, { x: 4, y: 18 }
                    ]
                },
                stacked: {
                    labels: ['Produção', 'Qualidade', 'Manutenção', 'Comercial'],
                    datasets: [
                        { label: 'Abertas', data: [12, 8, 15, 6] },
                        { label: 'Em Análise', data: [8, 12, 10, 4] },
                        { label: 'Finalizadas', data: [25, 18, 22, 12] }
                    ]
                }
            };

            // Gerar dados do heatmap
            for (let day = 0; day < 7; day++) {
                for (let hour = 0; hour < 24; hour++) {
                    simulatedData.heatmap.push({
                        x: hour,
                        y: day,
                        v: Math.floor(Math.random() * 20) + 1
                    });
                }
            }

            createAdvancedCharts(simulatedData);
        }

        // Função para criar todos os gráficos APRIMORADA
        function createAdvancedCharts(data) {
            console.log(' Iniciando criação de gráficos avançados:', data);
            console.log(' Tipo de dados recebidos:', typeof data);
            console.log(' Data é objeto?', data && typeof data === 'object');
            
            chartsData = data;
            
            // Destruir gráficos anteriores
            console.log(' Destruindo gráficos existentes...');
            Object.values(charts).forEach(c => { 
                try { 
                    if (c && c.destroy) {
                        console.log(' Destruindo gráfico:', c);
                        c.destroy();
                    }
                } catch(e){
                    console.log(' Erro ao destruir gráfico:', e);
                } 
            });
            charts = {};

            // Verificar se Chart.js está disponível
            if (typeof Chart === 'undefined') {
                console.error(' Chart.js não está carregado!');
                return;
            }
            console.log(' Chart.js disponível:', Chart.version);

            // Verificar se elementos existem
            console.log(' Verificando elementos de canvas...');
            const elements = ['trendChart', 'statusChart', 'priorityChart', 'usersChart', 'equipmentChart', 'areaChart', 'scatterChart', 'stackedChart', 'heatmapChart', 'gaugeChart', 'radarChart'];
            let foundElements = 0;
            elements.forEach(id => {
                const el = document.getElementById(id);
                if (!el) {
                    console.error(` Elemento ${id} não encontrado!`);
                } else {
                    console.log(` Elemento ${id} encontrado`);
                    foundElements++;
                }
            });
            
            console.log(` Total de elementos encontrados: ${foundElements}/${elements.length}`);
            
            if (foundElements === 0) {
                console.error(' NENHUM elemento de canvas foi encontrado! Os gráficos não podem ser criados.');
                return;
            }

            console.log(' Iniciando criação individual dos gráficos...');

            // 1. Gráfico de Tendência Aprimorado
            console.log(' Criando gráfico de tendência...');
            createTrendChart(data);
            
            // 2. Gráfico de Status
            console.log(' Criando gráfico de status...');
            createStatusChart(data);
            
            // 3. Gráfico de Prioridade
            createPriorityChart(data);
            
            // 4. Gráfico de Usuários
            console.log(' Chamando createUsersChart com data:', data);
            createUsersChart(data);
            
            // 5. Gráfico de Equipamentos
            console.log(' Chamando createEquipmentChart com data:', data);
            createEquipmentChart(data);
            
            // 6. Gráfico de Área
            createAreaChart(data);
            
            // 7. Scatter Plot
            createScatterChart(data);
            
            // 8. Gráfico Empilhado
            createStackedChart(data);
            
            // 9. Heatmap
            createHeatmapChart(data);
            
            // 10. Gauge
            createGaugeChart(data);
            
            // 11. Radar
            createRadarChart(data);
            
            console.log(' Gráficos criados:', Object.keys(charts));
        }

        function createTrendChart(data) {
            console.log(' INICIANDO createTrendChart');
            const ctx = document.getElementById('trendChart');
            if (!ctx) {
                console.error(' Elemento trendChart não encontrado!');
                return;
            }
            console.log(' Canvas trendChart encontrado');
            
            if (!data || !data.trend) {
                console.error(' Dados de tendência não disponíveis:', data);
                return;
            }
            console.log(' Dados de tendência disponíveis:', data.trend);
            
            try {
            charts.trendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.trend.map(it => new Date(it.date).toLocaleDateString('pt-BR')),
                    datasets: [{
                        label: 'RNCs por Período',
                        data: data.trend.map(it => it.count),
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: '#667eea',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointRadius: 6,
                        pointHoverRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: '#fff',
                            bodyColor: '#fff',
                            borderColor: '#667eea',
                            borderWidth: 1,
                            cornerRadius: 8
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: 'rgba(0, 0, 0, 0.1)' },
                            ticks: { font: { size: 12 } }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { font: { size: 12 } }
                        }
                    },
                    animation: {
                        duration: 1000,
                        easing: 'easeInOutQuart'
                    }
                }
            });
            
            console.log(' Gráfico de tendência criado com sucesso:', charts.trendChart);
            
        } catch (error) {
            console.error(' Erro ao criar gráfico de tendência:', error);
            console.error(' Stack trace:', error.stack);
        }
        }

        function createStatusChart(data) {
            const ctx = document.getElementById('statusChart');
            if (!ctx) return;
            
            charts.statusChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: data.status.map(it => it.label),
                    datasets: [{
                        data: data.status.map(it => it.count),
                        backgroundColor: data.status.map(it => it.color),
                        borderWidth: 0,
                        hoverOffset: 10
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { 
                                usePointStyle: true, 
                                padding: 20,
                                font: { size: 12 }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((context.parsed * 100) / total).toFixed(1);
                                    return `${context.label}: ${context.parsed} (${percentage}%)`;
                                }
                            }
                        }
                    },
                    animation: {
                        animateRotate: true,
                        duration: 1500
                    }
                }
            });
        }

        function createPriorityChart(data) {
            const ctx = document.getElementById('priorityChart');
            if (!ctx) return;
            
            charts.priorityChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.priority.map(it => it.label),
                    datasets: [{
                        data: data.priority.map(it => it.count),
                        backgroundColor: data.priority.map(it => it.color),
                        borderRadius: 8,
                        borderSkipped: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: '#fff',
                            bodyColor: '#fff'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: 'rgba(0, 0, 0, 0.1)' }
                        },
                        x: {
                            grid: { display: false }
                        }
                    },
                    animation: {
                        delay: (context) => context.dataIndex * 100,
                        duration: 800
                    }
                }
            });
        }

        function createUsersChart(data) {
            console.log(' Iniciando createUsersChart com data:', data);
            const ctx = document.getElementById('usersChart');
            if (!ctx) {
                console.error(' Elemento usersChart não encontrado!');
                return;
            }
            
            const context = ctx.getContext('2d');
            if (!context) {
                console.error(' Contexto 2D não disponível para usersChart!');
                return;
            }
            
            console.log(' Criando gráfico de usuários:', data.users);
            console.log(' Canvas usersChart encontrado e contexto 2D disponível');
            
            charts.usersChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.users ? data.users.map(it => it.label) : ['Sem dados'],
                    datasets: [{
                        data: data.users ? data.users.map(it => it.count) : [0],
                        backgroundColor: '#6f42c1',
                        borderRadius: 6,
                        borderSkipped: false
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            grid: { color: 'rgba(0, 0, 0, 0.1)' }
                        },
                        y: {
                            grid: { display: false }
                        }
                    }
                }
            });
            console.log(' Gráfico de usuários criado com sucesso!', charts.usersChart);
        }

        function createEquipmentChart(data) {
            console.log(' Iniciando createEquipmentChart com data:', data);
            const ctx = document.getElementById('equipmentChart');
            if (!ctx) {
                console.error(' Elemento equipmentChart não encontrado!');
                return;
            }
            
            const context = ctx.getContext('2d');
            if (!context) {
                console.error(' Contexto 2D não disponível para equipmentChart!');
                return;
            }
            
            console.log(' Criando gráfico de equipamentos:', data.equipment);
            console.log(' Canvas equipmentChart encontrado e contexto 2D disponível');
            
            charts.equipmentChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: data.equipment ? data.equipment.map(it => it.label) : ['Sem dados'],
                    datasets: [{
                        data: data.equipment ? data.equipment.map(it => it.count) : [0],
                        backgroundColor: ['#fd7e14', '#20c997', '#6610f2', '#e83e8c', '#ffc107'],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { 
                                usePointStyle: true, 
                                padding: 15,
                                font: { size: 11 }
                            }
                        }
                    }
                }
            });
            console.log(' Gráfico de equipamentos criado com sucesso!', charts.equipmentChart);
        }

        function createAreaChart(data) {
            const ctx = document.getElementById('areaChart');
            if (!ctx) return;
            
            const colors = ['#ff6b6b', '#4ecdc4', '#45b7d1'];
            
            charts.areaChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.area.dates,
                    datasets: data.area.datasets.map((dataset, index) => ({
                        label: dataset.label,
                        data: dataset.data,
                        backgroundColor: colors[index] + '30',
                        borderColor: colors[index],
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }))
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { intersect: false },
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: { usePointStyle: true }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            stacked: true,
                            grid: { color: 'rgba(0, 0, 0, 0.1)' }
                        },
                        x: {
                            grid: { display: false }
                        }
                    }
                }
            });
        }

        function createScatterChart(data) {
            const ctx = document.getElementById('scatterChart');
            if (!ctx) return;
            
            charts.scatterChart = new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'RNCs',
                        data: data.scatter.data,
                        backgroundColor: '#e83e8c',
                        borderColor: '#e83e8c',
                        pointRadius: 8,
                        pointHoverRadius: 12
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `Prioridade: ${context.parsed.x}, Tempo: ${context.parsed.y} dias`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            type: 'linear',
                            position: 'bottom',
                            title: { display: true, text: 'Prioridade (1-4)' },
                            min: 0,
                            max: 5
                        },
                        y: {
                            title: { display: true, text: 'Tempo (dias)' },
                            min: 0
                        }
                    }
                }
            });
        }

        function createStackedChart(data) {
            const ctx = document.getElementById('stackedChart');
            if (!ctx) return;
            
            const colors = ['#ff6b6b', '#4ecdc4', '#45b7d1'];
            
            charts.stackedChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.stacked.labels,
                    datasets: data.stacked.datasets.map((dataset, index) => ({
                        label: dataset.label,
                        data: dataset.data,
                        backgroundColor: colors[index],
                        borderRadius: {
                            topLeft: index === data.stacked.datasets.length - 1 ? 6 : 0,
                            topRight: index === data.stacked.datasets.length - 1 ? 6 : 0,
                            bottomLeft: index === 0 ? 6 : 0,
                            bottomRight: index === 0 ? 6 : 0
                        }
                    }))
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { stacked: true },
                        y: { 
                            stacked: true,
                            beginAtZero: true
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: { usePointStyle: true }
                        }
                    }
                }
            });
        }

        function createHeatmapChart(data) {
            const ctx = document.getElementById('heatmapChart');
            if (!ctx) {
                console.error(' Elemento heatmapChart não encontrado!');
                return;
            }
            
            console.log(' Criando heatmap:', data.heatmap.length, 'pontos');
            
            const departments = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb'];
            const hours = Array.from({length:24}, (_, i) => `${i}h`);
            
            charts.heatmapChart = new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'RNCs',
                        data: data.heatmap,
                        backgroundColor: function(context) {
                            const value = context.parsed.v || 0;
                            const alpha = Math.min(1, Math.max(0.2, value / 20));
                            return `rgba(102, 126, 234, ${alpha})`;
                        },
                        pointRadius: function(context) {
                            return Math.max(8, Math.min(20, (context.parsed.v || 0) * 1.5));
                        }
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            type: 'linear',
                            position: 'bottom',
                            ticks: {
                                callback: function(value) {
                                    return hours[Math.round(value)] || '';
                                },
                                stepSize: 2,
                                max: 23,
                                min: 0
                            },
                            title: { display: true, text: 'Hora do Dia' }
                        },
                        y: {
                            type: 'linear',
                            ticks: {
                                callback: function(value) {
                                    return departments[Math.round(value)] || '';
                                },
                                stepSize: 1,
                                max: 6,
                                min: 0
                            },
                            title: { display: true, text: 'Dia da Semana' }
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                title: function(context) {
                                    const point = context[0];
                                    const dayIndex = Math.round(point.parsed.y);
                                    const hourIndex = Math.round(point.parsed.x);
                                    return `${departments[dayIndex]} - ${hours[hourIndex]}`;
                                },
                                label: function(context) {
                                    return `RNCs: ${context.parsed.v || 0}`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function createGaugeChart(data) {
            const ctx = document.getElementById('gaugeChart');
            if (!ctx) return;
            
            const total = Math.max(1, parseInt(data.kpis.total || 0, 10));
            const resolved = Math.max(0, parseInt(data.kpis.resolved || 0, 10));
            const value = Math.round((resolved/total)*100);
            
            charts.gaugeChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    datasets: [{
                        data: [value, 100 - value],
                        backgroundColor: ['#4ade80', 'rgba(255, 255, 255, 0.2)'],
                        borderWidth: 0,
                        cutout: '75%'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    rotation: -90,
                    circumference: 180,
                    plugins: {
                        legend: { display: false },
                        tooltip: { enabled: false }
                    }
                },
                plugins: [{
                    beforeDraw: function(chart) {
                        const ctx = chart.ctx;
                        ctx.save();
                        
                        const centerX = chart.chartArea.left + (chart.chartArea.right - chart.chartArea.left) / 2;
                        const centerY = chart.chartArea.top + (chart.chartArea.bottom - chart.chartArea.top) / 2;
                        
                        ctx.font = 'bold 24px Arial';
                        ctx.fillStyle = '#fff';
                        ctx.textAlign = 'center';
                        ctx.fillText(`${value}%`, centerX, centerY + 10);
                        
                        ctx.restore();
                    }
                }]
            });
        }

        function createRadarChart(data) {
            const ctx = document.getElementById('radarChart');
            if (!ctx) return;
            
            charts.radarChart = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: data.departments.map(d => d.label),
                    datasets: [{
                        label: 'Performance',
                        data: data.departments.map(d => d.efficiency),
                        borderColor: 'rgba(255, 255, 255, 0.8)',
                        backgroundColor: 'rgba(255, 255, 255, 0.2)',
                        borderWidth: 2,
                        pointBackgroundColor: '#fff',
                        pointBorderColor: 'rgba(255, 255, 255, 0.8)',
                        pointRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        r: {
                            angleLines: { color: 'rgba(255, 255, 255, 0.3)' },
                            grid: { color: 'rgba(255, 255, 255, 0.3)' },
                            pointLabels: { color: '#fff', font: { size: 12 } },
                            ticks: { 
                                color: 'rgba(255, 255, 255, 0.7)',
                                backdropColor: 'transparent'
                            },
                            min: 0,
                            max: 100
                        }
                    }
                }
            });
        }

        function toggleChartType(chartId) {
            const chart = charts[chartId];
            if (!chart) return;
            
            const currentType = chart.config.type;
            const newType = currentType === 'line' ? 'bar' : 'line';
            
            chart.config.type = newType;
            chart.update();
        }

        function autoRefreshCharts() {
            const btn = document.getElementById('autoRefreshBtn');
            
            if (isAutoRefreshing) {
                clearInterval(autoRefreshInterval);
                isAutoRefreshing = false;
                btn.innerHTML = ' Auto';
                btn.style.background = '#17a2b8';
            } else {
                autoRefreshInterval = setInterval(() => {
                    loadChartData();
                    updateKPIs();
                }, 30000); // 30 segundos
                isAutoRefreshing = true;
                btn.innerHTML = ' Parar';
                btn.style.background = '#dc3545';
            }
        }

        function updateHeatmap() {
            const period = document.getElementById('heatmapPeriod').value;
            loadChartData(); // Recarregar com novo período
        }
        
        // Função para carregar dados dos gráficos
        function loadChartData() {
            const period = document.getElementById('chartPeriod').value;
            console.log(` Carregando dados (enhanced) para ${period} dias`);
            
            fetch(`/api/charts/simple-data?period=${period}`)
                .then(r => r.json())
                .then(resp => {
                    if (!resp || resp.success === false) {
                        console.error(' Erro ao carregar dados dos gráficos:', resp && (resp.message || resp.error));
                        return;
                    }
                    const data = resp.data || resp; // compatibilidade
                    console.log(' Dados dos gráficos (enhanced):', data);
                    createCharts(data);
                })
                .catch(error => {
                    console.error(' Erro ao carregar dados dos gráficos:', error);
                });
        }
        
        // Função para criar todos os gráficos
        function createCharts(data) {
            chartsData = data;
            
            // Destruir gráficos Chart.js anteriores de forma mais robusta
            Object.values(charts).forEach(c => { 
                try { 
                    if (c && typeof c.destroy === 'function') {
                        c.destroy(); 
                    }
                } catch(e){
                    console.warn('Erro ao destruir gráfico Chart.js:', e);
                } 
            });
            charts = {};
            
            // Destruir gráficos avançados de forma mais robusta
            try { 
                if (window.advancedCharts && typeof window.advancedCharts.destroyChart === 'function') { 
                    ['heatmapChart','gaugeChart','radarChart','sankeyChart','treemapChart'].forEach(id => {
                        try {
                            advancedCharts.destroyChart(id);
                        } catch(e) {
                            console.warn(`Erro ao destruir gráfico avançado ${id}:`, e);
                        }
                    }); 
                } 
            } catch(e){
                console.warn('Erro ao destruir gráficos avançados:', e);
            }

            // Tendência
            if (data.trend && data.trend.length) {
                const el = document.getElementById('trendChart');
                if (el) {
                    charts.trendChart = new Chart(el, {
                        type: 'line',
                        data: {
                            labels: data.trend.map(it => new Date(it.date).toLocaleDateString('pt-BR')),
                            datasets: [{
                                label: 'RNCs Criados',
                                data: data.trend.map(it => it.count),
                                borderColor: '#0d6efd',
                                backgroundColor: 'rgba(13, 110, 253, .12)',
                                borderWidth: 3,
                                tension: .35,
                                fill: true
                            }]
                        },
                        options: { responsive:true, maintainAspectRatio:false, plugins:{ legend:{ display:false } }, scales:{ y:{ beginAtZero:true } } }
                    });
                }
            }

            // Status
            if (data.status && data.status.length) {
                const el = document.getElementById('statusChart');
                if (el) {
                    const colors = data.status.map(it => it.color || '#6c757d');
                    charts.statusChart = new Chart(el, {
                        type: 'doughnut',
                        data: { labels: data.status.map(it => it.label), datasets: [{ data: data.status.map(it => it.count), backgroundColor: colors, borderWidth: 2, borderColor: '#fff' }] },
                        options: { responsive:true, maintainAspectRatio:false, plugins:{ legend:{ position:'bottom', labels:{ usePointStyle:true, padding:16 } } } }
                    });
                }
            }

            // Prioridade
            if (data.priority && data.priority.length) {
                const el = document.getElementById('priorityChart');
                if (el) {
                    const colors = data.priority.map(it => it.color || '#6c757d');
                    charts.priorityChart = new Chart(el, {
                        type: 'bar',
                        data: { labels: data.priority.map(it => it.label), datasets: [{ label:'RNCs', data: data.priority.map(it => it.count), backgroundColor: colors }] },
                        options: { responsive:true, maintainAspectRatio:false, plugins:{ legend:{ display:false } }, scales:{ y:{ beginAtZero:true } } }
                    });
                }
            }

            // Heatmap (departamentos vs tempo) — construir matriz 7x24
            if (data.heatmap && data.heatmap.length && window.createHeatmap) {
                const yLabels = ['Dom','Seg','Ter','Qua','Qui','Sex','Sáb'];
                const xLabels = Array.from({length:24},(_,h)=> `${h}h`);
                const values = Array.from({length:7},()=> Array.from({length:24},()=>0));
                data.heatmap.forEach(p => {
                    const y = Math.max(0, Math.min(6, parseInt(p.y||0,10)));
                    const x = Math.max(0, Math.min(23, parseInt(p.x||0,10)));
                    const v = parseInt(p.v||0,10);
                    values[y][x] = v;
                });
                
                // Criar heatmap garantindo destruição prévia e sem concorrência
                try {
                    if (window.advancedCharts && typeof window.advancedCharts.destroyChart === 'function') {
                        window.advancedCharts.destroyChart('heatmapChart');
                    }
                } catch(_){}
                setTimeout(() => {
                    try {
                        createHeatmap('heatmapChart', { xLabels, yLabels, values }, {});
                    } catch (error) {
                        console.error('Erro ao criar heatmap:', error);
                    }
                }, 50);
            }

            // Gauge — taxa de resolução
            if (data.kpis && typeof data.kpis.resolved !== 'undefined') {
                const total = Math.max(1, parseInt(data.kpis.total || 0, 10));
                const resolved = Math.max(0, parseInt(data.kpis.resolved || 0, 10));
                const value = Math.round((resolved/total)*100);
                if (window.createGauge) {
                    // Destruir o gráfico anterior se existir para evitar sobreposição
                    try {
                        if (window.advancedCharts && typeof window.advancedCharts.destroyChart === 'function') {
                            window.advancedCharts.destroyChart('gaugeChart');
                        }
                    } catch(_){}
                    
                    // Usar await para aguardar a criação do gráfico
                    (async () => {
                        try {
                            await createGauge('gaugeChart', value, { 
                                title: 'Taxa de Resolução', 
                                label: `${resolved}/${total} resolvidos`, 
                                unit: '%',
                                animation: {
                                    animateRotate: true,
                                    duration: 2000,
                                    easing: 'easeInOutQuart'
                                },
                                colors: {
                                    track: 'rgba(255,255,255,0.2)',
                                    progress: value >= 80 ? '#28a745' : value >= 60 ? '#ffc107' : '#dc3545',
                                    background: 'rgba(255,255,255,0.1)'
                                },
                                fontSize: 28,
                                valueSize: 72,
                                shadow: {
                                    shadowColor: 'rgba(0,0,0,0.3)',
                                    shadowBlur: 15,
                                    shadowOffsetX: 0,
                                    shadowOffsetY: 5
                                }
                            });
                        } catch (error) {
                            console.error('Erro ao criar gauge:', error);
                        }
                    })();
                }
            }

            // Radar — performance por departamento (quantidade vs eficiência)
            if (data.departments && data.departments.length && window.createAdvancedRadar) {
                const labels = data.departments.map(d => d.label || d.department || '');
                const ds = [
                    { 
                        label: 'Quantidade', 
                        data: data.departments.map(d => d.count),
                        backgroundColor: 'rgba(102, 126, 234, 0.25)',
                        borderColor: '#667eea',
                        pointBackgroundColor: '#667eea',
                        pointBorderColor: '#ffffff',
                        pointBorderWidth: 3
                    },
                    { 
                        label: 'Eficiência', 
                        data: data.departments.map(d => Math.round(d.efficiency || 0)),
                        backgroundColor: 'rgba(118, 75, 162, 0.25)',
                        borderColor: '#764ba2',
                        pointBackgroundColor: '#764ba2',
                        pointBorderColor: '#ffffff',
                        pointBorderWidth: 3
                    }
                ];
                // Destruir o gráfico anterior se existir para evitar sobreposição
                const oldChart = window.advancedCharts && window.advancedCharts.charts.get('radarChart');
                if (oldChart) {
                    oldChart.destroy();
                    window.advancedCharts.charts.delete('radarChart');
                }
                
                // Usar await para aguardar a criação do gráfico
                (async () => {
                    try {
                        await createAdvancedRadar('radarChart', { labels, datasets: ds }, { 
                            maxValue: 100,
                            animation: {
                                duration: 2000,
                                easing: 'easeInOutElastic'
                            },
                            plugins: {
                                legend: {
                                    position: 'bottom',
                                    labels: {
                                        color: 'white',
                                        font: {
                                            size: 14,
                                            weight: 'bold'
                                        },
                                        padding: 20,
                                        usePointStyle: true
                                    }
                                },
                                tooltip: {
                                    backgroundColor: 'rgba(0,0,0,0.8)',
                                    titleColor: 'white',
                                    bodyColor: 'white',
                                    borderColor: 'rgba(255,255,255,0.3)',
                                    borderWidth: 1
                        }
                    },
                    scales: {
                        r: {
                            ticks: {
                                stepSize: 20,
                                showLabelBackdrop: false,
                                backdropColor: 'rgba(255, 255, 255, 0.1)',
                                color: 'rgba(255,255,255,0.8)',
                                font: {
                                    size: 12,
                                    weight: 'bold'
                                }
                            },
                            grid: {
                                color: 'rgba(255,255,255,0.3)',
                                lineWidth: 2
                            },
                            angleLines: {
                                color: 'rgba(255,255,255,0.4)',
                                lineWidth: 2
                            },
                            pointLabels: {
                                color: 'white',
                                font: {
                                    size: 13,
                                    weight: 'bold'
                                }
                            }
                        }
                    }
                        });
                    } catch (error) {
                        console.error('Erro ao criar radar chart:', error);
                    }
                })();
            }
        }

        // Funções para o modal de ampliação de gráficos
        let currentModalChart = null;
        
        function openChartModal(title, chartId) {
            // Definir o título do modal
            document.getElementById('chartModalTitle').textContent = title;
            
            // Exibir o modal
            document.getElementById('chartModal').style.display = 'block';
            
            // Destruir gráfico anterior se existir
            if (currentModalChart) {
                currentModalChart.destroy();
                currentModalChart = null;
            }
            
            // Criar uma cópia ampliada do gráfico
            const canvas = document.getElementById('chartModalCanvas');
            const ctx = canvas.getContext('2d');
            
            // Verificar o tipo de gráfico e recriar no modal
            if (chartId === 'heatmapChart' && window.createHeatmap && chartsData.heatmap) {
                const yLabels = ['Dom','Seg','Ter','Qua','Qui','Sex','Sáb'];
                const xLabels = Array.from({length:24},(_,h)=> `${h}h`);
                const values = Array.from({length:7},()=> Array.from({length:24},()=>0));
                chartsData.heatmap.forEach(p => {
                    const y = Math.max(0, Math.min(6, parseInt(p.y||0,10)));
                    const x = Math.max(0, Math.min(23, parseInt(p.x||0,10)));
                    const v = parseInt(p.v||0,10);
                    values[y][x] = v;
                });
                
                (async () => {
                    try {
                        currentModalChart = await createHeatmap('chartModalCanvas', { xLabels, yLabels, values }, {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Mapa de Calor - RNCs por Período',
                            font: {
                                size: 18,
                                weight: 'bold'
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.data[context.dataIndex]} RNCs`;
                                }
                            }
                        }
                    }
                        });
                    } catch (error) {
                        console.error('Erro ao criar heatmap modal:', error);
                    }
                })();
                
            } else if (chartId === 'gaugeChart' && window.createGauge && chartsData.kpis) {
                const total = Math.max(1, parseInt(chartsData.kpis.total || 0, 10));
                const resolved = Math.max(0, parseInt(chartsData.kpis.resolved || 0, 10));
                const value = Math.round((resolved/total)*100);
                
                (async () => {
                    try {
                        currentModalChart = await createGauge('chartModalCanvas', value, { 
                    title: 'Taxa de Resolução', 
                    label: `${resolved}/${total} resolvidos`, 
                    unit: '%',
                    animation: {
                        animateRotate: true,
                        duration: 2500,
                        easing: 'easeInOutBounce'
                    },
                    colors: {
                        track: 'rgba(200,200,200,0.3)',
                        progress: value >= 80 ? '#28a745' : value >= 60 ? '#ffc107' : '#dc3545',
                        background: '#f8f9fa'
                    },
                    fontSize: 32,
                    valueSize: 80,
                    shadow: {
                        shadowColor: 'rgba(0,0,0,0.2)',
                        shadowBlur: 20,
                        shadowOffsetX: 0,
                        shadowOffsetY: 8
                    }
                        });
                    } catch (error) {
                        console.error('Erro ao criar gauge modal:', error);
                    }
                })();
                
            } else if (chartId === 'radarChart' && window.createAdvancedRadar && chartsData.departments) {
                const labels = chartsData.departments.map(d => d.label);
                const ds = [
                    { 
                        label: 'Quantidade', 
                        data: chartsData.departments.map(d => d.count),
                        backgroundColor: 'rgba(102, 126, 234, 0.3)',
                        borderColor: '#667eea',
                        borderWidth: 3,
                        pointBackgroundColor: '#667eea',
                        pointBorderColor: '#ffffff',
                        pointBorderWidth: 4,
                        pointRadius: 8
                    },
                    { 
                        label: 'Eficiência', 
                        data: chartsData.departments.map(d => Math.round(d.efficiency || 0)),
                        backgroundColor: 'rgba(118, 75, 162, 0.3)',
                        borderColor: '#764ba2',
                        borderWidth: 3,
                        pointBackgroundColor: '#764ba2',
                        pointBorderColor: '#ffffff',
                        pointBorderWidth: 4,
                        pointRadius: 8
                    }
                ];
                
                (async () => {
                    try {
                        currentModalChart = await createAdvancedRadar('chartModalCanvas', { labels, datasets: ds }, { 
                            maxValue: 100,
                            animation: {
                                duration: 2500,
                                easing: 'easeInOutElastic'
                            },
                            plugins: {
                                legend: {
                                    position: 'bottom',
                                    labels: {
                                        font: {
                                            size: 16,
                                            weight: 'bold'
                                        },
                                        padding: 25,
                                        usePointStyle: true
                                    }
                                },
                                tooltip: {
                                    backgroundColor: 'rgba(0,0,0,0.9)',
                                    titleColor: 'white',
                                    bodyColor: 'white',
                                    borderColor: 'rgba(255,255,255,0.3)',
                                    borderWidth: 2,
                                    cornerRadius: 10
                                },
                                title: {
                                    display: true,
                                    text: 'Análise Comparativa de Departamentos',
                                    font: {
                                        size: 22,
                                        weight: 'bold'
                                    },
                                    padding: 25
                                }
                            },
                            scales: {
                                r: {
                                    ticks: {
                                        stepSize: 20,
                                        showLabelBackdrop: false,
                                        backdropColor: 'rgba(255, 255, 255, 0.1)',
                                        font: {
                                            size: 14,
                                            weight: 'bold'
                                        }
                                    },
                                    grid: {
                                        color: 'rgba(0,0,0,0.2)',
                                        lineWidth: 2
                                    },
                                    angleLines: {
                                        color: 'rgba(0,0,0,0.3)',
                                        lineWidth: 2
                                    },
                                    pointLabels: {
                                        font: {
                                            size: 15,
                                            weight: 'bold'
                                        }
                                    }
                                }
                            }
                        });
                    } catch (error) {
                        console.error('Erro ao criar radar modal:', error);
                    }
                })();
                
            } else {
                // Para gráficos Chart.js padrão (tendência, status, prioridade)
                const originalChart = charts[chartId];
                if (originalChart) {
                    // Clonar configurações do gráfico original
                    const config = {
                        type: originalChart.config.type,
                        data: JSON.parse(JSON.stringify(originalChart.config.data)),
                        options: JSON.parse(JSON.stringify(originalChart.config.options))
                    };
                    
                    // Melhorar as opções para o modal
                    config.options.responsive = true;
                    config.options.maintainAspectRatio = false;
                    
                    // Aumentar tamanho das fontes
                    if (config.options.plugins && config.options.plugins.legend) {
                        config.options.plugins.legend.labels = config.options.plugins.legend.labels || {};
                        config.options.plugins.legend.labels.font = { size: 16 };
                        config.options.plugins.legend.labels.padding = 20;
                    } else {
                        config.options.plugins = config.options.plugins || {};
                        config.options.plugins.legend = {
                            position: 'bottom',
                            labels: {
                                font: { size: 16 },
                                padding: 20
                            }
                        };
                    }
                    
                    // Adicionar título
                    config.options.plugins.title = {
                        display: true,
                        text: title,
                        font: {
                            size: 20,
                            weight: 'bold'
                        },
                        padding: 20
                    };
                    
                    // Melhorar animações
                    config.options.animation = {
                        duration: 1500,
                        easing: 'easeOutQuart'
                    };
                    
                    // Criar o gráfico no modal
                    currentModalChart = new Chart(ctx, config);
                }
            }
        }
        
        function closeChartModal() {
            document.getElementById('chartModal').style.display = 'none';
            if (currentModalChart) {
                currentModalChart.destroy();
                currentModalChart = null;
            }
        }
        
        // Fechar o modal ao clicar fora do conteúdo
        window.onclick = function(event) {
            const modal = document.getElementById('chartModal');
            if (event.target === modal) {
                closeChartModal();
            }
        };
        
        // ===== Exportação de Gráficos =====
        function exportChartsPDF() {
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('p', 'mm', 'a4');
                const margin = 12;
                let y = margin;

                // Cabeçalho
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(16);
                doc.text('Relatório de Gráficos - IPPEL RNC', 105, y, { align: 'center' });
                y += 8;
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(10);
                const period = document.getElementById('chartPeriod').value;
                const dateStr = new Date().toLocaleString('pt-BR');
                doc.text(`Período: últimos ${period} dias | Gerado em: ${dateStr}`, 105, y, { align: 'center' });
                y += 10;

                // Resumo (se disponível)
                if (chartsData && chartsData.status && chartsData.status.length) {
                    doc.setFont('helvetica', 'bold');
                    doc.text('Resumo por Status', margin, y);
                    y += 6;
                    doc.setFont('helvetica', 'normal');
                    chartsData.status.forEach(item => {
                        doc.text(`- ${item.label}: ${item.count}`, margin, y);
                        y += 5;
                    });
                }

                // Função para inserir um gráfico por página
                const addChart = (chart, title) => {
                    if (!chart) return;
                    const img = chart.toBase64Image();
                    doc.addPage();
                    doc.setFont('helvetica', 'bold');
                    doc.setFontSize(14);
                    doc.text(title, 105, 14, { align: 'center' });
                    // Ajustar imagem mantendo margens
                    const imgWidth = 180; // mm
                    const imgHeight = 110; // proporcional para caber
                    doc.addImage(img, 'PNG', (210 - imgWidth) / 2, 22, imgWidth, imgHeight);
                };

                addChart(charts.statusChart, 'Status dos RNCs');
                addChart(charts.trendChart, 'Tendência Temporal');
                addChart(charts.clientChart, 'RNCs por Cliente');
                addChart(charts.equipmentChart, 'RNCs por Equipamento');
                addChart(charts.departmentChart, 'RNCs por Departamento');
                addChart(charts.priorityChart, 'RNCs por Prioridade');
                addChart(charts.dispositionChart, 'Disposição dos RNCs');
                addChart(charts.userChart, 'RNCs por Usuário');

                doc.save(`Relatorio_Graficos_RNC.pdf`);
            } catch (e) {
                console.error('Erro ao exportar PDF:', e);
                alert('Erro ao exportar PDF');
            }
        }

        function downloadURI(uri, filename) {
            const link = document.createElement('a');
            link.href = uri;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function exportChartsPNGs() {
            try {
                const items = [
                    { c: charts.trendChart, n: 'tendencia' },
                    { c: charts.statusChart, n: 'status' },
                    { c: charts.priorityChart, n: 'prioridade' },
                ];
                const ts = new Date().toISOString().slice(0,19).replace(/[:T]/g,'-');
                items.forEach(it => {
                    if (it.c && typeof it.c.toBase64Image === 'function') {
                        const uri = it.c.toBase64Image();
                        downloadURI(uri, `grafico_${it.n}_${ts}.png`);
                    }
                });
                // Avançados: export via canvas toDataURL
                ['heatmapChart','gaugeChart','radarChart'].forEach(id => {
                    const canvas = document.getElementById(id);
                    if (canvas) {
                        const uri = canvas.toDataURL('image/png');
                        downloadURI(uri, `grafico_${id}_${ts}.png`);
                    }
                });
            } catch (e) {
                console.error('Erro ao exportar PNGs:', e);
                alert('Erro ao exportar PNGs');
            }
        }
        
        // Modificar a função switchTab para incluir gráficos APRIMORADOS
        const originalSwitchTab = switchTab;
        switchTab = function(tab) {
            originalSwitchTab(tab);
            
            // Mostrar/ocultar container de gráficos
            const chartsContainer = document.getElementById('chartsContainer');
            if (chartsContainer) {
                if (tab === 'charts') {
                    chartsContainer.style.display = 'block';
                    console.log(' Inicializando sistema de gráficos avançado...');
                    setTimeout(() => {
                        initializeCharts();
                    }, 100); // Pequeno delay para garantir que os elementos estejam visíveis
                } else {
                    chartsContainer.style.display = 'none';
                    // Parar atualização automática quando sair da aba
                    if (isAutoRefreshing) {
                        autoRefreshCharts();
                    }
                }
            }
            
            // Mostrar/ocultar Levantamento 14-15
            const lev1415 = document.getElementById('lev1415Container');
            if (lev1415) {
                lev1415.style.display = (tab === 'lev1415') ? 'block' : 'none';
                if (tab === 'lev1415') {
                    if (typeof fillYearSelect === 'function') fillYearSelect();
                    if (typeof loadLev1415 === 'function') loadLev1415();
                    if (typeof loadLevByYear === 'function') loadLevByYear();
                }
            }
        };
        
        // ===== Aba Levantamento: exibir imagem enviada =====
        let levZoom = 1;
        function levZoomIn() { levZoom = Math.min(2.5, levZoom + 0.1); applyLevZoom(); }
        function levZoomOut() { levZoom = Math.max(0.5, levZoom - 0.1); applyLevZoom(); }
        function levZoomReset() { levZoom = 1; applyLevZoom(); }
        function applyLevZoom() {
            const img = document.getElementById('levantamentoImage');
            if (img) img.style.transform = `scale(${levZoom})`;
        }
        function downloadLevImage() {
            const a = document.createElement('a');
            a.href = document.getElementById('levantamentoImage').src;
            a.download = 'levantamento_rnc.png';
            document.body.appendChild(a); a.click(); document.body.removeChild(a);
        }

        // Upload/erro de imagem do Levantamento (client-side only)
        function triggerLevUpload() {
            const input = document.getElementById('levUpload');
            if (input) input.click();
        }
        function handleLevUpload(evt) {
            const file = evt.target.files && evt.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = e => {
                const img = document.getElementById('levantamentoImage');
                if (img) img.src = e.target.result;
                const msg = document.getElementById('levEmptyMsg');
                if (msg) msg.style.display = 'none';
            };
            reader.readAsDataURL(file);
        }
        function levImageError() {
            const msg = document.getElementById('levEmptyMsg');
            if (msg) msg.style.display = 'block';
        }

        // CSV -> Tabela (para ver os dados clicando)
        function openLevCsv() {
            const input = document.getElementById('levCsvUpload');
            if (input) input.click();
        }
        function handleLevCsvUpload(evt) {
            const file = evt.target.files && evt.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = e => {
                const text = e.target.result || '';
                const rows = text.split(/\r?\n/).filter(l => l.trim().length > 0).map(l => l.split(/;|\t|,/));
                renderLevTable(rows);
            };
            reader.readAsText(file, 'utf-8');
        }
        function renderLevTable(rows) {
            const tableDiv = document.getElementById('levTableContainer');
            const imgDiv = document.getElementById('levImageWrapper');
            if (!rows || rows.length === 0) {
                tableDiv.style.display = 'block';
                imgDiv.style.display = 'none';
                tableDiv.innerHTML = '<div style="padding:14px; color:#666; text-align:center;">CSV vazio</div>';
                return;
            }
            const header = rows[0];
            const body = rows.slice(1);
            const html = `
                <table style="width:100%; border-collapse:collapse; font-size:12px;">
                  <thead>
                    <tr>${header.map(h => `<th style="position:sticky; top:0; background:#f8f9fa; border-bottom:1px solid #e9ecef; padding:8px; text-align:left;">${h}</th>`).join('')}</tr>
                  </thead>
                  <tbody>
                    ${body.map(r => `<tr>${r.map(c => `<td style=\"border-top:1px solid #f1f3f5; padding:8px; white-space:nowrap;\">${c}</td>`).join('')}</tr>`).join('')}
                  </tbody>
                </table>`;
            tableDiv.innerHTML = html;
            tableDiv.style.display = 'block';
            imgDiv.style.display = 'none';
        }
        function showLevTable() {
            const tableDiv = document.getElementById('levTableContainer');
            const imgDiv = document.getElementById('levImageWrapper');
            tableDiv.style.display = 'block';
            imgDiv.style.display = 'none';
        }
        function showLevImage() {
            const tableDiv = document.getElementById('levTableContainer');
            const imgDiv = document.getElementById('levImageWrapper');
            tableDiv.style.display = 'none';
            imgDiv.style.display = 'block';
        }

        // Modal de informações do Levantamento (conteúdo local em memória)
        let levInfoText = '';
        function openLevInfo() {
            document.getElementById('levInfoModal').style.display = 'block';
            const body = document.getElementById('levInfoBody');
            body.innerHTML = levInfoText
                ? `<div style=\"white-space:pre-wrap;\">${levInfoText}</div>`
                : '<div style="text-align:center; color:#6c757d;">Nenhuma informação cadastrada. Clique em "Editar" para inserir.</div>';
        }
        function closeLevInfo() {
            document.getElementById('levInfoModal').style.display = 'none';
        }

        // Funções do modal de campos obrigatórios pendentes
        function showMissingFieldsModal(rncId, rncNumber, missingFields) {
            // Mapear ícones para cada tipo de campo
            const fieldIcons = {
                'Titulo': '',
                'Descricao': '',
                'Equipamento': '',
                'Cliente': '',
                'Prioridade': '',
                'Disposicao': '',
                'Assinatura': '',
                'Data': ''
            };
            
            // Função para obter ícone baseado no nome do campo
            function getFieldIcon(fieldName) {
                for (const [key, icon] of Object.entries(fieldIcons)) {
                    if (fieldName.includes(key)) {
                        return icon;
                    }
                }
                return ''; // Ícone padrão
            }
            
            // Criar HTML da lista de campos com cards bonitos
            let fieldsHTML = '<div style="display: flex; flex-direction: column; gap: 10px;">';
            missingFields.forEach((field, index) => {
                const icon = getFieldIcon(field);
                fieldsHTML += `
                    <div style="
                        background: linear-gradient(135deg, #ffffff, #fef2f2);
                        border: 2px solid #fca5a5;
                        border-radius: 10px;
                        padding: 14px 18px;
                        display: flex;
                        align-items: center;
                        gap: 14px;
                        transition: all 0.2s;
                        box-shadow: 0 2px 4px rgba(220, 38, 38, 0.1);
                    " onmouseover="this.style.transform='translateX(5px)'; this.style.borderColor='#dc2626'; this.style.boxShadow='0 4px 8px rgba(220, 38, 38, 0.2)'" onmouseout="this.style.transform='translateX(0)'; this.style.borderColor='#fca5a5'; this.style.boxShadow='0 2px 4px rgba(220, 38, 38, 0.1)'">
                        <div style="
                            background: linear-gradient(135deg, #dc2626, #b91c1c);
                            color: white;
                            width: 32px;
                            height: 32px;
                            border-radius: 8px;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            font-weight: 700;
                            font-size: 12px;
                            flex-shrink: 0;
                            box-shadow: 0 2px 6px rgba(220, 38, 38, 0.3);
                        ">${index + 1}</div>
                        <div style="
                            font-size: 26px;
                            flex-shrink: 0;
                        ">${icon}</div>
                        <div style="flex: 1;">
                            <strong style="color: #7f1d1d; font-size: 15px; font-weight: 700;">${field}</strong>
                        </div>
                        <div style="
                            color: #dc2626;
                            font-size: 24px;
                            flex-shrink: 0;
                        "></div>
                    </div>
                `;
            });
            fieldsHTML += '</div>';
            
            // Adicionar contagem de campos
            const countHTML = `
                <div style="
                    background: linear-gradient(135deg, #fff7ed, #fed7aa);
                    border: 2px solid #fb923c;
                    border-radius: 10px;
                    padding: 12px 16px;
                    margin-bottom: 15px;
                    text-align: center;
                    box-shadow: 0 2px 4px rgba(251, 146, 60, 0.15);
                ">
                    <strong style="color: #9a3412; font-size: 16px;">
                        Total de campos pendentes: <span style="color: #dc2626; font-size: 20px; font-weight: 800;">${missingFields.length}</span>
                    </strong>
                </div>
            `;
            
            // Preencher modal
            document.getElementById('missingRncNumber').textContent = rncNumber;
            document.getElementById('missingFieldsList').innerHTML = countHTML + fieldsHTML;
            
            // Mostrar modal
            const modal = document.getElementById('missingFieldsModal');
            if (modal) {
                modal.style.display = 'flex';
            }
        }

        function closeMissingFieldsModal() {
            const modal = document.getElementById('missingFieldsModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        // Função para mostrar modal de confirmação personalizado
        function showConfirmModal(title, message, description, confirmText, cancelText) {
            return new Promise((resolve) => {
                const modal = document.getElementById('customConfirmModal');
                const titleEl = document.getElementById('confirmModalTitle');
                const iconEl = document.getElementById('confirmModalIcon');
                const messageEl = document.getElementById('confirmModalMessage');
                const descriptionEl = document.getElementById('confirmModalDescription');
                const confirmBtn = document.getElementById('confirmModalConfirm');
                const cancelBtn = document.getElementById('confirmModalCancel');
                
                // Extrair emoji do título se houver
                const emojiMatch = title.match(/^([\u{1F300}-\u{1F9FF}]|[\u{2600}-\u{26FF}])\s*/u);
                if (emojiMatch) {
                    iconEl.textContent = emojiMatch[0].trim();
                    titleEl.textContent = title.replace(emojiMatch[0], '').trim();
                } else {
                    iconEl.textContent = '';
                    titleEl.textContent = title;
                }
                
                messageEl.textContent = message;
                descriptionEl.textContent = description;
                confirmBtn.textContent = confirmText || 'Confirmar';
                cancelBtn.textContent = cancelText || 'Cancelar';
                
                // Função para fechar modal
                const closeModal = (result) => {
                    modal.style.display = 'none';
                    confirmBtn.onclick = null;
                    cancelBtn.onclick = null;
                    resolve(result);
                };
                
                // Eventos dos botões
                confirmBtn.onclick = () => closeModal(true);
                cancelBtn.onclick = () => closeModal(false);
                
                // Mostrar modal
                modal.style.display = 'flex';
            });
        }
        function editLevInfo() {
            const current = levInfoText || '';
            const hint = 'Digite/cole abaixo as informações do levantamento (texto livre).';
            const next = prompt(hint, current);
            if (next !== null) {
                levInfoText = next.trim();
                openLevInfo();
            }
        }

        // ===== Levantamento 2014-2015 (dados fixos) =====
        const LEV1415_HEADER = ['Data','Produção','Engenharia','Terceiros','Compras','Comercial','Cliente','PCP','Expedição','Qualidade','Transporte','Não definido','Total'];
        const LEV1415_ROWS = [
            ['01/14','R$ 3,489.00','R$ 16,198.42','R$ 1,285.00','R$ 0.00','R$ 0.00','R$ 10.00','R$ 0.00','R$ 0.00','R$ 0.00','R$ 20,982.42'],
            ['02/14','R$ 5,141.00','R$ 4,037.50','R$ 3,922.50','R$ 1,040.00','R$ 0.00','R$ 170.00','R$ 0.00','R$ 0.00','R$ 0.00','R$ 14,311.00'],
            ['03/14','R$ 11,737.23','R$ 43,226.84','R$ 4,858.00','R$ 12.50','R$ 0.00','R$ 25.00','R$ 0.00','R$ 0.00','R$ 0.00','R$ 59,859.57'],
            ['04/14','R$ 12,414.55','R$ 3,886.94','R$ 1,110.00','R$ 0.00','R$ 0.00','R$ 0.00','R$ 5,200.00','R$ 0.00','R$ 0.00','R$ 22,611.49'],
            ['05/14','R$ 4,692.44','R$ 7,957.66','R$ 826.48','R$ 125.63','R$ 0.00','R$ 0.00','R$ 0.00','R$ 0.00','R$ 0.00','R$ 13,602.21'],
            ['06/14','R$ 7,253.83','R$ 3,355.55','R$ 410.00','R$ 642.17','R$ 0.00','R$ 0.00','R$ 0.00','R$ 25.00','R$ 45.00','R$ 11,731.55'],
            ['07/14','R$ 5,660.89','R$ 3,568.30','R$ 2,827.50','R$ 0.00','R$ 0.00','R$ 0.00','R$ 0.00','R$ 0.00','R$ 0.00','R$ 12,056.69'],
            ['08/14','R$ 5,485.08','R$ 3,439.44','R$ 565.00','R$ 25.00','R$ 0.00','R$ 0.00','R$ 0.00','R$ 0.00','R$ 0.00','R$ 9,514.52'],
            ['09/14','R$ 6,670.13','R$ 5,804.72','R$ 715.00','R$ 50.00','R$ 0.00','R$ 0.00','R$ 0.00','R$ 0.00','R$ 0.00','R$ 13,239.85'],
            ['10/14','R$ 5,288.41','R$ 3,392.45','R$ 4,050.15','R$ 0.00','R$ 0.00','R$ 25.00','R$ 0.00','R$ 0.00','R$ 0.00','R$ 12,756.01'],
            ['11/14','R$ 5,542.73','R$ 5,124.36','R$ 445.00','R$ 135.70','R$ 0.00','R$ 0.00','R$ 0.00','R$ 0.00','R$ 0.00','R$ 11,247.79'],
            ['12/14','R$ 4,162.06','R$ 2,188.26','R$ 524.00','R$ 0.00','R$ 0.00','R$ 0.00','R$ 0.00','R$ 0.00','R$ 0.00','R$ 6,874.32'],
            ['Total ano:','R$ 208,787.42','','','','','','','','','']
        ];
        const LEV1515_ROWS = [
            ['01/15','R$ 5,568.84','R$ 13,800.60','R$ 485.00','R$ 0.00','R$ 0.00','R$ 0.00','R$ 0.00','R$ 0.00','R$ 0.00','R$ 19,854.44'],
            ['02/15','R$ 6,910.13','R$ 9,794.85','R$ 930.00','R$ 0.00','R$ 0.00','R$ 0.00','R$ 0.00','R$ 0.00','R$ 0.00','R$ 17,634.98'],
            ['03/15','R$ 5,861.84','R$ 13,610.00','R$ 1,495.00','R$ 40.00','R$ 0.00','R$ 0.00','R$ 0.00','R$ 0.00','R$ 0.00','R$ 21,006.84'],
            ['04/15','R$ 5,619.41','R$ 7,847.50','R$ 3,120.00','R$ 100.00','R$ 0.00','R$ 0.00','R$ 0.00','R$ 0.00','R$ 0.00','R$ 16,686.91'],
            ['05/15','R$ 7,179.15','R$ 18,663.29','R$ 4,485.00','R$ 0.00','R$ 0.00','R$ 0.00','R$ 0.00','R$ 0.00','R$ 0.00','R$ 30,327.44'],
            ['06/15','R$ 6,060.86',' R$ 21,383.46 ','R$ 4,153.82','R$ 0.00','R$ 0.00','R$ 0.00','R$ 0.00','R$ 0.00','R$ 0.00','R$ 31,598.14'],
            ['07/15','R$ 6,779.85','R$ 5,282.84','R$ 505.00','R$ 0.00','R$ 25.00','R$ 0.00','R$ 0.00','R$ 0.00','R$ 0.00','R$ 12,592.69'],
            ['08/15','R$ 4,540.19','R$ 3,879.49','R$ 460.00','R$ 0.00','R$ 0.00','R$ 0.00','R$ 0.00','R$ 0.00','R$ 0.00','R$ 8,879.68'],
            ['09/15','R$ 1,812.38','R$ 927.50','R$ 215.53','R$ 0.00','R$ 0.00','R$ 100.00','R$ 0.00','R$ 0.00','R$ 0.00','R$ 3,055.41'],
            ['10/15','R$ 42,897.78','R$ 1,165.64','R$ 295.00','R$ 0.00','R$ 0.00','R$ 0.00','R$ 0.00','R$ 0.00','R$ 0.00','R$ 44,358.42'],
            ['11/15','R$ 3,198.75','R$ 1,257.83','R$ 215.00','R$ 0.00','R$ 0.00','R$ 0.00','R$ 0.00','R$ 0.00','R$ 0.00','R$ 4,671.58'],
            ['12/15','R$ 1,099.10','R$ 1,898.02','R$ 25.00','R$ 0.00','R$ 0.00','R$ 0.00','R$ 0.00','R$ 0.00','R$ 50.00','R$ 3,072.12']
        ];
        function renderLev1415(data2014 = [], data2015 = [], selectedYear = null) {
            const wrap = document.getElementById('lev1415TableWrap');
            if (!wrap) return;
            
            // Formatação BR para números vindos em vários formatos (ex.: 1521.66, 1,521.66, 1.521,66, 'R$ 1,521.66')
            const toNumberBR = (val) => {
                if (val == null) return 0;
                if (typeof val === 'number') return val;
                let s = String(val).trim().replace(/\s|R\$|\u00A0/g, '');
                // Padrão US: 1,234.56
                if (/^\d{1,3}(,\d{3})+(\.\d+)?$/.test(s)) {
                    return parseFloat(s.replace(/,/g, '')) || 0;
                }
                // Padrão BR: 1.234,56
                if (/^\d{1,3}(\.\d{3})+(,\d+)?$/.test(s)) {
                    return parseFloat(s.replace(/\./g, '').replace(',', '.')) || 0;
                }
                // Somente vírgula como decimal
                if (s.includes(',') && !s.includes('.')) {
                    return parseFloat(s.replace(',', '.')) || 0;
                }
                // Somente ponto ou número puro
                const n = parseFloat(s);
                return isNaN(n) ? 0 : n;
            };

            const fmtCellBR = (val, isFirstCol) => {
                if (isFirstCol) return val;
                const n = toNumberBR(val);
                // Exibir 0 sem casas; valores >0 com 2 casas
                if (!n) return '0';
                return n.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            };

            const makeTable = (rows) => `
                <table style="width:100%; border-collapse:collapse; font-size:12px;">
                  <thead>
                    <tr>${LEV1415_HEADER.map(h => `<th style="position:sticky; top:0; background:#f8f9fa; border-bottom:1px solid #e9ecef; padding:8px; text-align:left;">${h}</th>`).join('')}</tr>
                  </thead>
                  <tbody>
                    ${rows.map(r => `<tr>${r.map((c,i) => `<td style=\"border-top:1px solid #f1f3f5; padding:8px; white-space:nowrap; ${i===0?'font-weight:600;':''}\">${fmtCellBR(c, i===0)}</td>`).join('')}</tr>`).join('')}
                  </tbody>
                </table>`;
            
            // Se um ano específico foi selecionado, mostrar apenas esse ano
            if (selectedYear && selectedYear >= 2016) {
                wrap.innerHTML = `
                  <h4 style="margin:6px 0;"> Ano ${selectedYear}</h4>
                  ${makeTable(data2014)}
                `;
            } else if (selectedYear) {
                // Para anos 2013-2015, mostrar dados simulados
                wrap.innerHTML = `
                  <h4 style="margin:6px 0;"> Ano ${selectedYear} (Dados Simulados)</h4>
                  ${makeTable(data2014)}
                `;
            } else {
                // Exibição padrão dos anos 2014 e 2015
                wrap.innerHTML = `
                  <h4 style="margin:6px 0;"> Ano 2014</h4>
                  ${makeTable(LEV1415_ROWS)}
                  <h4 style="margin:18px 0 6px;"> Ano 2015</h4>
                  ${makeTable(LEV1515_ROWS)}
                `;
            }
        }
        // Carregar dados fixos (14-15) inicialmente; ao trocar o ano mostrar somente o ano escolhido
        let _levTotalMesChart, _levPorDeptChart;
        
                function fillYearSelect() {
            const sel = document.getElementById('levYearSelect');
            if (!sel) return;
            
            sel.innerHTML = '';
            
            // Carregar anos dinamicamente da API
            loadAvailableYears(sel);
        }
        
        function parseCurrency(v){
            if (typeof v !== 'string') return Number(v||0);
            const s = v.replace(/R\$|\s/g,'').replace(/\./g,'').replace(',', '.');
            const n = parseFloat(s); return isNaN(n)?0:n;
        }
        
        // Funções da aba Indicadores removidas - funcionalidade descontinuada
        
        function loadAvailableYears(selectElement) {
            console.log(' Carregando anos disponíveis da API...');
            
            fetch('/api/available-years')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        console.log(' Anos disponíveis recebidos:', data.years);
                        
                        // Limpar opções existentes
                        selectElement.innerHTML = '';
                        
                        // Adicionar opção "Todos os anos"
                        const allOption = document.createElement('option');
                        allOption.value = '';
                        allOption.textContent = 'Todos os anos';
                        selectElement.appendChild(allOption);
                        
                        // Adicionar anos da API
                        data.years.forEach(year => {
                            const option = document.createElement('option');
                            option.value = year;
                            option.textContent = year;
                            
                            // Selecionar o ano atual por padrão
                            if (year === data.current_year) {
                                option.selected = true;
                            }
                            
                            selectElement.appendChild(option);
                        });
                        
                        console.log(` ${data.years.length} anos carregados dinamicamente`);
                    } else {
                        console.error(' Erro na API de anos:', data.message);
                        loadYearsFallback(selectElement);
                    }
                })
                .catch(error => {
                    console.error(' Erro ao carregar anos da API:', error);
                    loadYearsFallback(selectElement);
                });
        }
        
        function loadAvailableMonths(selectElement) {
            console.log(' Carregando meses disponíveis da API...');
            
            fetch('/api/available-months')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        console.log(' Meses disponíveis recebidos:', data.months);
                        
                        // Limpar opções existentes
                        selectElement.innerHTML = '';
                        
                        // Adicionar opção "Todos os meses"
                        const allOption = document.createElement('option');
                        allOption.value = '';
                        allOption.textContent = 'Todos os meses';
                        selectElement.appendChild(allOption);
                        
                        // Adicionar meses da API
                        data.months.forEach(month => {
                            const option = document.createElement('option');
                            option.value = month.value;
                            option.textContent = month.name;
                            selectElement.appendChild(option);
                        });
                        
                        console.log(` ${data.months.length} meses carregados dinamicamente`);
                    } else {
                        console.error(' Erro na API de meses:', data.message);
                        loadMonthsFallback(selectElement);
                    }
                })
                .catch(error => {
                    console.error(' Erro ao carregar meses da API:', error);
                    loadMonthsFallback(selectElement);
                });
        }
        
        function loadYearsFallback(selectElement) {
            console.log(' Carregando anos de fallback...');
            
            // Fallback com anos padrão (2013-2025)
            const fallbackYears = [2025, 2024, 2023, 2022, 2021, 2020, 2019, 2018, 2017, 2016, 2015, 2014, 2013];
            
            selectElement.innerHTML = '';
            
            // Opção "Todos os anos"
            const allOption = document.createElement('option');
            allOption.value = '';
            allOption.textContent = 'Todos os anos';
            selectElement.appendChild(allOption);
            
            // Anos de fallback
            fallbackYears.forEach(year => {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                if (year === 2025) option.selected = true;
                selectElement.appendChild(option);
            });
        }
        
        function loadMonthsFallback(selectElement) {
            console.log(' Carregando meses de fallback...');
            
            // Fallback com meses padrão
            const fallbackMonths = [
                {value: '01', name: 'Janeiro'},
                {value: '02', name: 'Fevereiro'},
                {value: '03', name: 'Março'},
                {value: '04', name: 'Abril'},
                {value: '05', name: 'Maio'},
                {value: '06', name: 'Junho'},
                {value: '07', name: 'Julho'},
                {value: '08', name: 'Agosto'},
                {value: '09', name: 'Setembro'},
                {value: '10', name: 'Outubro'},
                {value: '11', name: 'Novembro'},
                {value: '12', name: 'Dezembro'}
            ];
            
            selectElement.innerHTML = '';
            
            // Opção "Todos os meses"
            const allOption = document.createElement('option');
            allOption.value = '';
            allOption.textContent = 'Todos os meses';
            selectElement.appendChild(allOption);
            
            // Meses de fallback
            fallbackMonths.forEach(month => {
                const option = document.createElement('option');
                option.value = month.value;
                option.textContent = month.name;
                selectElement.appendChild(option);
            });
        }
        
        
        // Todas as funções dos indicadores foram removidas - funcionalidade descontinuada
        
        function refreshIndicadores() {
            console.log(' Função removida - funcionalidade de indicadores descontinuada');
        }
        
        function exportIndicadoresCSV() {
            console.log(' Função removida - funcionalidade de indicadores descontinuada');
        }
        
        // ================== FUNÇÕES DA ABA EVIDÊNCIAS ==================
        let evidenciasData = null;
        let evidenciasChart = null;
        
        function loadEvidencias() {
            console.log(' Carregando evidências mensais...');
            
            // Buscar dados das RNCs finalizadas para calcular percentuais
            // Tentar primeiro dados de engenharia, depois finalizadas, depois todas
            let sourceData = [];
            
            // CORREÇÃO CRÍTICA: Usar TODAS as RNCs finalizadas (3694), não apenas engenharia (2763)
            if (rncsData && rncsData.finalized && rncsData.finalized.length > 0) {
                sourceData = rncsData.finalized;
                console.log(' Usando TODAS as RNCs Finalizadas para Evidências:', sourceData.length);
            } else if (rncsData && rncsData.engenharia && rncsData.engenharia.length > 0) {
                sourceData = rncsData.engenharia;
                console.log(' Fallback: Usando apenas dados de Engenharia:', sourceData.length);
            } else if (rncsData && rncsData.active && rncsData.active.length > 0) {
                sourceData = rncsData.active;
                console.log(' Fallback: Usando dados de RNCs Ativas:', sourceData.length);
            } else {
                console.log(' Aguardando dados de RNCs...');
                setTimeout(loadEvidencias, 1000);
                return;
            }
            
            try {
                const allRncs = sourceData;
                console.log(` Processando ${allRncs.length} RNCs para Evidências`);
                
                // Agrupar por mês/ano e responsável usando finalized_at
                const byMonth = {};
                const byResponsible = {};
                
                // CORREÇÃO: Meta dinâmica baseada no histórico real
                const meta = Math.max(30, Math.ceil(allRncs.length / 12)); // Mínimo 30 ou média mensal
                console.log(` Meta calculada: ${meta} RNCs/mês (total: ${allRncs.length} RNCs)`)
                
                allRncs.forEach(rnc => {
                    const date = rnc.finalized_at || rnc.created_at || rnc.updated_at;
                    if (!date) return;
                    
                    const d = new Date(date);
                    if (isNaN(d)) return;
                    
                    const key = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
                    // CORRIGIDO: Usar o campo 'responsavel' da RNC que contém o nome do responsável
                    const responsible = rnc.responsavel || rnc.assigned_user_name || rnc.user_name || 'Não Informado';
                    
                    // Agrupar por mês
                    if (!byMonth[key]) {
                        byMonth[key] = { 
                            count: 0, 
                            year: d.getFullYear(), 
                            month: d.getMonth() + 1,
                            responsibles: {}
                        };
                    }
                    byMonth[key].count++;
                    
                    // Agrupar por responsável dentro do mês
                    if (!byMonth[key].responsibles[responsible]) {
                        byMonth[key].responsibles[responsible] = 0;
                    }
                    byMonth[key].responsibles[responsible]++;
                    
                    // Agrupar totais por responsável
                    if (!byResponsible[responsible]) {
                        byResponsible[responsible] = 0;
                    }
                    byResponsible[responsible]++;
                });
                
                // Calcular percentuais e organizar dados
                const months = Object.keys(byMonth).sort();
                evidenciasData = {
                    months: months.map(key => {
                        const data = byMonth[key];
                        const percentage = Math.round((data.count / meta) * 100);
                        const monthNames = ['JAN', 'FEV', 'MAR', 'ABR', 'MAI', 'JUN', 'JUL', 'AGO', 'SET', 'OUT', 'NOV', 'DEZ'];
                        
                        return {
                            key,
                            year: data.year,
                            month: data.month,
                            monthName: monthNames[data.month - 1],
                            count: data.count,
                            meta,
                            percentage,
                            status: percentage >= 100 ? 'acima' : percentage >= 80 ? 'adequado' : 'abaixo',
                            responsibles: data.responsibles
                        };
                    }),
                    responsibles: byResponsible
                };
                
                populateEvidenciasYearSelect();
                generateEvidenciasTable();
                generateResponsiblesTable();
                createEvidenciasChart();
                
                console.log(' Evidências carregadas com sucesso!');
            } catch (error) {
                console.error(' Erro ao carregar evidências:', error);
            }
        }
        
        function populateEvidenciasYearSelect() {
            const select = document.getElementById('evidenciasYearSelect');
            if (!select || !evidenciasData || !evidenciasData.months) return;
            
            // Limpar opções existentes (manter "Todos os Anos")
            while (select.children.length > 1) {
                select.removeChild(select.lastChild);
            }
            
            // Obter anos únicos
            const years = [...new Set(evidenciasData.months.map(item => item.year))].sort((a, b) => b - a);
            
            years.forEach(year => {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                select.appendChild(option);
            });
            
            // Adicionar event listener
            select.onchange = () => {
                generateEvidenciasTable();
                generateResponsiblesTable();
                createEvidenciasChart();
            };
        }
        
        function generateEvidenciasTable() {
            const container = document.getElementById('evidenciasTableContent');
            if (!container || !evidenciasData || !evidenciasData.months) return;
            
            const yearFilter = document.getElementById('evidenciasYearSelect')?.value;
            let filteredData = evidenciasData.months;
            
            if (yearFilter) {
                filteredData = evidenciasData.months.filter(item => item.year == yearFilter);
            }
            
            if (filteredData.length === 0) {
                container.innerHTML = '<p style="text-align:center; color:#666;">Nenhum dado encontrado.</p>';
                return;
            }
            
            // Atualizar contador
            const countEl = document.getElementById('evidenciasTableCount');
            if (countEl) {
                countEl.textContent = `${filteredData.length} ${filteredData.length === 1 ? 'mês' : 'meses'}`;
            }
            
            // Calcular estatísticas
            let totalRNCs = 0;
            let totalMeta = 0;
            let acima = 0;
            let adequado = 0;
            let abaixo = 0;
            
            filteredData.forEach(item => {
                totalRNCs += item.count || 0;
                totalMeta += item.meta || 0;
                if (item.status === 'acima') acima++;
                else if (item.status === 'adequado') adequado++;
                else if (item.status === 'abaixo') abaixo++;
            });
            
            const mediaPercentual = filteredData.length > 0 ? Math.round(filteredData.reduce((sum, item) => sum + (item.percentage || 0), 0) / filteredData.length) : 0;
            
            // Atualizar cards de estatísticas
            const statsEl = document.getElementById('evidenciasStats');
            if (statsEl) {
                statsEl.innerHTML = `
                    <div style="background:rgba(255,255,255,0.15); backdrop-filter:blur(10px); border-radius:8px; padding:12px; border:1px solid rgba(255,255,255,0.2);">
                        <div style="font-size:11px; opacity:0.85; margin-bottom:4px;">Total RNCs</div>
                        <div style="font-size:24px; font-weight:700;">${totalRNCs}</div>
                    </div>
                    <div style="background:rgba(255,255,255,0.15); backdrop-filter:blur(10px); border-radius:8px; padding:12px; border:1px solid rgba(255,255,255,0.2);">
                        <div style="font-size:11px; opacity:0.85; margin-bottom:4px;">Meta Total</div>
                        <div style="font-size:24px; font-weight:700;">${totalMeta}</div>
                    </div>
                    <div style="background:rgba(255,255,255,0.15); backdrop-filter:blur(10px); border-radius:8px; padding:12px; border:1px solid rgba(255,255,255,0.2);">
                        <div style="font-size:11px; opacity:0.85; margin-bottom:4px;">Média %</div>
                        <div style="font-size:24px; font-weight:700;">${mediaPercentual}%</div>
                    </div>
                    <div style="background:rgba(255,255,255,0.15); backdrop-filter:blur(10px); border-radius:8px; padding:12px; border:1px solid rgba(255,255,255,0.2);">
                        <div style="font-size:11px; opacity:0.85; margin-bottom:4px;">🟢 Acima</div>
                        <div style="font-size:20px; font-weight:700;">${acima} <span style="font-size:12px; opacity:0.8;">| 🟡 ${adequado} | ${abaixo}</span></div>
                    </div>
                `;
            }
            
            // Criar cabeçalho da tabela (moderna e compacta)
            let html = `
                <table style="width:100%; border-collapse:collapse; font-size:11px; border-radius:6px; overflow:hidden;">
                    <thead>
                        <tr style="background:linear-gradient(135deg, #667eea 0%, #764ba2 100%); color:white;">
                            <th style="padding:10px 8px; text-align:left; border:none; font-size:11px; font-weight:600;">Mês</th>
                            <th style="padding:10px 8px; text-align:center; border:none; font-size:11px; font-weight:600;">RNCs</th>
                            <th style="padding:10px 8px; text-align:center; border:none; font-size:11px; font-weight:600;">Meta</th>
                            <th style="padding:10px 8px; text-align:center; border:none; font-size:11px; font-weight:600;">%</th>
                            <th style="padding:10px 8px; text-align:center; border:none; font-size:11px; font-weight:600;">Status</th>
                            <th style="padding:10px 8px; text-align:left; border:none; font-size:11px; font-weight:600;">Responsáveis</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            // Adicionar linhas de dados
            filteredData.forEach(item => {
                const bgColor = item.status === 'acima' ? '#d1f2eb' : 
                               item.status === 'adequado' ? '#fff3cd' : '#f8d7da';
                const textColor = item.status === 'acima' ? '#0c5460' : 
                                 item.status === 'adequado' ? '#856404' : '#721c24';
                
                // Criar string dos responsáveis
                let responsiblesStr = '';
                if (item.responsibles && Object.keys(item.responsibles).length > 0) {
                    responsiblesStr = Object.entries(item.responsibles)
                        .sort((a, b) => b[1] - a[1])
                        .map(([name, count]) => `${name}: ${count}`)
                        .join('<br>');
                } else {
                    responsiblesStr = 'Não informado';
                }
                
                const rowIndex = filteredData.indexOf(item);
                const isEven = rowIndex % 2 === 0;
                const rowBg = isEven ? '#ffffff' : '#f8f9fa';
                
                html += `
                    <tr style="background:${rowBg}; transition:all 0.2s;" onmouseover="this.style.background='#e7f3ff'" onmouseout="this.style.background='${rowBg}'">
                        <td style="padding:8px 10px; border:none; border-bottom:1px solid #e9ecef; font-weight:600; font-size:11px; color:#2c3e50;">
                            ${item.monthName} ${item.year}
                        </td>
                        <td style="padding:8px 10px; text-align:center; border:none; border-bottom:1px solid #e9ecef; font-size:11px; font-weight:600; color:#495057;">
                            ${item.count}
                        </td>
                        <td style="padding:8px 10px; text-align:center; border:none; border-bottom:1px solid #e9ecef; font-size:11px; color:#6c757d;">
                            ${item.meta}
                        </td>
                        <td style="padding:8px 10px; text-align:center; border:none; border-bottom:1px solid #e9ecef;">
                            <span style="display:inline-block; padding:4px 10px; border-radius:12px; background:${bgColor}; color:${textColor}; font-weight:700; font-size:11px;">
                            ${item.percentage}%
                            </span>
                        </td>
                        <td style="padding:8px 10px; text-align:center; border:none; border-bottom:1px solid #e9ecef; font-size:16px;">
                            ${item.status === 'acima' ? '🟢' : item.status === 'adequado' ? '🟡' : ''}
                        </td>
                        <td style="padding:8px 10px; border:none; border-bottom:1px solid #e9ecef; font-size:10px; line-height:1.5; color:#495057;">
                            ${responsiblesStr}
                        </td>
                    </tr>
                `;
            });
            
            // Adicionar rodapé com totais
            html += `
                    </tbody>
                    <tfoot>
                        <tr style="background:linear-gradient(135deg, #667eea 0%, #764ba2 100%); color:white; font-weight:700;">
                            <td style="padding:10px 10px; border:none; font-size:12px;">TOTAL</td>
                            <td style="padding:10px 10px; text-align:center; border:none; font-size:12px;">${totalRNCs}</td>
                            <td style="padding:10px 10px; text-align:center; border:none; font-size:12px;">${totalMeta}</td>
                            <td style="padding:10px 10px; text-align:center; border:none; font-size:12px;">${mediaPercentual}%</td>
                            <td style="padding:10px 10px; text-align:center; border:none; font-size:11px;">🟢${acima} 🟡${adequado} ${abaixo}</td>
                            <td style="padding:10px 10px; border:none; font-size:11px;">${filteredData.length} ${filteredData.length === 1 ? 'mês' : 'meses'} analisados</td>
                        </tr>
                    </tfoot>
                </table>
            `;
            container.innerHTML = html;
        }
        
        function generateResponsiblesTable() {
            // Remover resumo anterior se existir
            const existingSummary = document.querySelector('#responsiblesSummary');
            if (existingSummary) {
                existingSummary.remove();
            }
            
            const summaryContainer = document.getElementById('evidenciasTableContent');
            if (!summaryContainer || !evidenciasData || !evidenciasData.responsibles) return;
            
            const yearFilter = document.getElementById('evidenciasYearSelect')?.value;
            let responsiblesData = evidenciasData.responsibles;
            
            // Se há filtro de ano, recalcular para o ano específico
            if (yearFilter) {
                responsiblesData = {};
                const filteredMonths = evidenciasData.months.filter(item => item.year == yearFilter);
                
                filteredMonths.forEach(month => {
                    if (month.responsibles) {
                        Object.entries(month.responsibles).forEach(([name, count]) => {
                            if (!responsiblesData[name]) responsiblesData[name] = 0;
                            responsiblesData[name] += count;
                        });
                    }
                });
            }
            
            // Criar resumo por responsável
            const responsiblesSorted = Object.entries(responsiblesData)
                .sort((a, b) => b[1] - a[1])
                .filter(([name, count]) => name !== 'Não Informado');
            
            if (responsiblesSorted.length > 0) {
                let summaryHtml = `
                    <div id="responsiblesSummary" style="margin-top:20px; padding:15px; background:#f8f9fa; border-radius:8px;">
                        <h4 style="margin:0 0 15px 0; color:#495057;">� Resumo por Responsável</h4>
                        <div style="display:flex; gap:20px; flex-wrap:wrap;">
                `;
                
                responsiblesSorted.forEach(([name, count]) => {
                    summaryHtml += `
                        <div style="background:white; padding:12px 16px; border-radius:6px; border:1px solid #dee2e6; min-width:150px;">
                            <div style="font-weight:600; color:#495057; margin-bottom:4px;">${name}</div>
                            <div style="font-size:18px; font-weight:700; color:#dc3545;">${count} RNCs</div>
                            <div style="font-size:12px; color:#6c757d;">Total no período</div>
                        </div>
                    `;
                });
                
                summaryHtml += '</div></div>';
                summaryContainer.insertAdjacentHTML('afterend', summaryHtml);
            }
        }
        
        function createEvidenciasChart() {
            const canvas = document.getElementById('evidenciasChart');
            if (!canvas || !evidenciasData || !evidenciasData.months) return;
            
            // Destruir gráfico existente
            if (evidenciasChart) {
                evidenciasChart.destroy();
            }
            
            const yearFilter = document.getElementById('evidenciasYearSelect')?.value;
            let filteredData = evidenciasData.months;
            
            if (yearFilter) {
                filteredData = evidenciasData.months.filter(item => item.year == yearFilter);
            }
            
            const labels = filteredData.map(item => `${item.monthName} ${item.year}`);
            const percentages = filteredData.map(item => item.percentage);
            const counts = filteredData.map(item => item.count);
            
            const ctx = canvas.getContext('2d');
            evidenciasChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels,
                    datasets: [
                        {
                            label: 'Percentual (%)',
                            data: percentages,
                            borderColor: '#0d6efd',
                            backgroundColor: 'rgba(13, 110, 253, 0.1)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.3,
                            pointBackgroundColor: percentages.map(p => p >= 100 ? '#28a745' : p >= 80 ? '#ffc107' : '#dc3545'),
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2,
                            pointRadius: 6
                        },
                        {
                            label: 'Meta (100%)',
                            data: filteredData.map(() => 100),
                            borderColor: '#28a745',
                            borderDash: [5, 5],
                            borderWidth: 2,
                            fill: false,
                            pointRadius: 0
                        }
                    ]
                },
                options: {
                    responsive: true,
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    plugins: {
                        legend: {
                            position: 'top'
                        },
                        tooltip: {
                            callbacks: {
                                afterLabel: function(context) {
                                    if (context.datasetIndex === 0) {
                                        const index = context.dataIndex;
                                        const monthData = filteredData[index];
                                        let tooltipLines = [`RNCs: ${counts[index]}`, `Meta: 30`];
                                        
                                        if (monthData.responsibles && Object.keys(monthData.responsibles).length > 0) {
                                            tooltipLines.push('Responsáveis:');
                                            Object.entries(monthData.responsibles)
                                                .sort((a, b) => b[1] - a[1])
                                                .forEach(([name, count]) => {
                                                    tooltipLines.push(`  ${name}: ${count}`);
                                                });
                                        }
                                        
                                        return tooltipLines;
                                    }
                                    return null;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Percentual (%)'
                            },
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Período'
                            }
                        }
                    }
                }
            });
        }
        
        function refreshEvidencias() {
            console.log(' Atualizando evidências...');
            loadEvidencias();
        }
        
        function exportEvidenciasCSV() {
            if (!evidenciasData || !evidenciasData.months) {
                alert('Dados não carregados ainda. Tente novamente.');
                return;
            }
            
            const yearFilter = document.getElementById('evidenciasYearSelect')?.value;
            let filteredData = evidenciasData.months;
            
            if (yearFilter) {
                filteredData = evidenciasData.months.filter(item => item.year == yearFilter);
            }
            
            let csv = 'Mês,Ano,RNCs,Meta,Percentual,Status,Responsáveis\n';
            
            filteredData.forEach(item => {
                let responsiblesStr = '';
                if (item.responsibles && Object.keys(item.responsibles).length > 0) {
                    responsiblesStr = Object.entries(item.responsibles)
                        .sort((a, b) => b[1] - a[1])
                        .map(([name, count]) => `${name}:${count}`)
                        .join(';');
                } else {
                    responsiblesStr = 'Não informado';
                }
                
                csv += `${item.monthName},${item.year},${item.count},${item.meta},${item.percentage}%,${item.status},"${responsiblesStr}"\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `evidencias_rnc_${yearFilter || 'todos_anos'}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
        }
        
        function printEvidencias() {
            // Salvar estado atual da página
            const originalTitle = document.title;
            const yearFilter = document.getElementById('evidenciasYearSelect')?.value;
            
            // Definir título para impressão
            document.title = `Evidências RNC ${yearFilter || 'Todos os Anos'}`;
            
            // Aplicar estilos de impressão
            const printStyles = document.createElement('style');
            printStyles.id = 'evidencias-print-styles';
            printStyles.textContent = `
                @media print {
                    body * {
                        visibility: hidden;
                    }
                    
                    #evidenciasContainer,
                    #evidenciasContainer * {
                        visibility: visible;
                    }
                    
                    #evidenciasContainer {
                        position: absolute;
                        left: 0;
                        top: 0;
                        width: 100%;
                        padding: 5px;
                        background: white;
                        max-width: 190mm; /* Largura A4 retrato */
                    }
                    
                    .no-print {
                        display: none !important;
                    }
                    
                    .charts-header {
                        margin-bottom: 5px;
                        page-break-after: avoid;
                    }
                    
                    .charts-header h3 {
                        font-size: 14px !important;
                        margin: 0 !important;
                        padding: 4px 0 !important;
                    }
                    
                    /* Mostrar cabeçalho com gradiente na impressão */
                    #evidenciasContainer > div:first-child {
                        display: block !important;
                        visibility: visible !important;
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
                        -webkit-print-color-adjust: exact !important;
                        print-color-adjust: exact !important;
                        page-break-after: avoid;
                        margin-bottom: 8px !important;
                        padding: 10px !important;
                    }
                    
                    #evidenciasStats {
                        display: grid !important;
                        grid-template-columns: repeat(4, 1fr) !important;
                        gap: 6px !important;
                        margin-top: 8px !important;
                    }
                    
                    #evidenciasStats > div {
                        font-size: 7px !important;
                        padding: 4px !important;
                        background: rgba(255,255,255,0.2) !important;
                        border: 1px solid rgba(255,255,255,0.3) !important;
                        -webkit-print-color-adjust: exact !important;
                        print-color-adjust: exact !important;
                    }
                    
                    #evidenciasStats > div > div:first-child {
                        font-size: 6px !important;
                    }
                    
                    #evidenciasStats > div > div:last-child {
                        font-size: 14px !important;
                    }
                    
                    #evidenciasTable {
                        page-break-inside: auto;
                        box-shadow: none !important;
                        padding: 4px !important;
                        margin: 0 !important;
                        border-radius: 0 !important;
                    }
                    
                    #evidenciasTable h4 {
                        font-size: 10px !important;
                        margin: 0 0 4px 0 !important;
                        padding: 0 !important;
                    }
                    
                    #evidenciasTableCount {
                        font-size: 8px !important;
                        padding: 2px 6px !important;
                    }
                    
                    #evidenciasTable table {
                        font-size: 7px !important;
                        width: 100%;
                        border-collapse: collapse;
                        page-break-inside: auto;
                    }
                    
                    #evidenciasTable thead {
                        display: table-header-group;
                    }
                    
                    #evidenciasTable tbody tr {
                        page-break-inside: avoid;
                        page-break-after: auto;
                    }
                    
                    #evidenciasTable thead tr {
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
                        -webkit-print-color-adjust: exact !important;
                        print-color-adjust: exact !important;
                        color: white !important;
                    }
                    
                    #evidenciasTable th {
                        padding: 4px 3px !important;
                        border: none !important;
                        font-size: 7px !important;
                        font-weight: bold !important;
                        line-height: 1.1 !important;
                        color: white !important;
                    }
                    
                    #evidenciasTable tbody tr:nth-child(even) {
                        background: #f8f9fa !important;
                        -webkit-print-color-adjust: exact !important;
                        print-color-adjust: exact !important;
                    }
                    
                    #evidenciasTable tbody tr:nth-child(odd) {
                        background: #ffffff !important;
                    }
                    
                    #evidenciasTable td {
                        padding: 3px 3px !important;
                        border: none !important;
                        border-bottom: 0.5px solid #e9ecef !important;
                        font-size: 6px !important;
                        line-height: 1.2 !important;
                        vertical-align: top !important;
                    }
                    
                    #evidenciasTable td span {
                        padding: 2px 6px !important;
                        border-radius: 8px !important;
                        -webkit-print-color-adjust: exact !important;
                        print-color-adjust: exact !important;
                    }
                    
                    #evidenciasTable tfoot tr {
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
                        -webkit-print-color-adjust: exact !important;
                        print-color-adjust: exact !important;
                        color: white !important;
                    }
                    
                    #evidenciasTable tfoot td {
                        border: none !important;
                        padding: 4px 3px !important;
                        font-size: 7px !important;
                        color: white !important;
                    }
                    
                    /* Ajustar larguras das colunas */
                    #evidenciasTable td:nth-child(1) { width: 12%; } /* Mês */
                    #evidenciasTable td:nth-child(2) { width: 8%; }  /* RNCs */
                    #evidenciasTable td:nth-child(3) { width: 8%; }  /* Meta */
                    #evidenciasTable td:nth-child(4) { width: 10%; } /* % */
                    #evidenciasTable td:nth-child(5) { width: 8%; }  /* Status */
                    #evidenciasTable td:nth-child(6) { width: 54%; } /* Responsáveis */
                    
                    /* Resumo por responsável - compacto */
                    #responsiblesSummary {
                        margin-top: 8px !important;
                        page-break-before: auto;
                    }
                    
                    #responsiblesSummary h4 {
                        font-size: 10px !important;
                        margin: 4px 0 !important;
                    }
                    
                    #responsiblesSummary .responsible-cards {
                        display: grid !important;
                        grid-template-columns: repeat(4, 1fr) !important;
                        gap: 4px !important;
                    }
                    
                    #responsiblesSummary .responsible-card {
                        padding: 3px 4px !important;
                        border: 0.5px solid #999 !important;
                        border-radius: 2px !important;
                        font-size: 7px !important;
                        background: #fafafa !important;
                    }
                    
                    #responsiblesSummary .responsible-card h5 {
                        font-size: 8px !important;
                        margin: 0 0 2px 0 !important;
                    }
                    
                    #responsiblesSummary .responsible-card p {
                        font-size: 9px !important;
                        margin: 0 !important;
                    }
                    
                    @page {
                        size: A4 portrait;
                        margin: 10mm 8mm;
                    }
                }
            `;
            document.head.appendChild(printStyles);
            
            // Aguardar um pouco e imprimir
            setTimeout(() => {
                window.print();
                
                // Remover estilos de impressão e restaurar título
                setTimeout(() => {
                    const styleEl = document.getElementById('evidencias-print-styles');
                    if (styleEl) styleEl.remove();
                    document.title = originalTitle;
                }, 500);
            }, 300);
        }
        
        function loadLev1415(){
            try{
                // Criar dados simulados baseados nos dados reais do banco
                const data2014 = [];
                const data2015 = [];
                const months = ['01', '02', '03', '04', '05', '06', '07', '08', '09', '10', '11', '12'];
                const depts = ['Produção','Engenharia','Terceiros','Compras','Comercial','PCP','Expedição','Qualidade','Transporte'];
                
                // Dados reais de contagem por mês
                const counts2014 = [133, 117, 163, 110, 142, 109, 136, 121, 108, 117, 131, 98];
                const counts2015 = [100, 120, 137, 107, 137, 205, 148, 102, 53, 61, 55, 53];
                
                // Gerar dados para 2014
                for(let i = 0; i < 12; i++) {
                    const total = counts2014[i];
                    const row = [
                        `${months[i]}/14`,
                        Math.floor(total * 0.25), // Produção
                        Math.floor(total * 0.20), // Engenharia
                        Math.floor(total * 0.12), // Terceiros
                        Math.floor(total * 0.10), // Compras
                        Math.floor(total * 0.08), // Comercial
                        0, // Cliente
                        Math.floor(total * 0.05), // PCP
                        Math.floor(total * 0.03), // Expedição
                        Math.floor(total * 0.15), // Qualidade
                        Math.floor(total * 0.02), // Transporte
                        0, // Não definido
                        total
                    ];
                    data2014.push(row);
                }
                
                // Gerar dados para 2015
                for(let i = 0; i < 12; i++) {
                    const total = counts2015[i];
                    const row = [
                        `${months[i]}/15`,
                        Math.floor(total * 0.25), // Produção
                        Math.floor(total * 0.20), // Engenharia
                        Math.floor(total * 0.12), // Terceiros
                        Math.floor(total * 0.10), // Compras
                        Math.floor(total * 0.08), // Comercial
                        0, // Cliente
                        Math.floor(total * 0.05), // PCP
                        Math.floor(total * 0.03), // Expedição
                        Math.floor(total * 0.15), // Qualidade
                        Math.floor(total * 0.02), // Transporte
                        0, // Não definido
                        total
                    ];
                    data2015.push(row);
                }
                
                window.LEV1415_ROWS = data2014;
                window.LEV1515_ROWS = data2015;
                
                // Atualizar título da tabela para exibição padrão
                const tableTitle = document.getElementById('levTableTitle');
                if (tableTitle) {
                    tableTitle.textContent = ' Tabela 2014-2015 (Histórico)';
                }
                
                // Atualizar título do gráfico de porcentagens para histórico
                const percentTitle = document.getElementById('deptPercentTitle');
                if (percentTitle) {
                    percentTitle.textContent = ' Porcentagem de RNCs por Departamento - Histórico 2014-2015';
                }
                
                renderLev1415(data2014, data2015);
                
                // Calcular totais e porcentagens por departamento para os dados combinados 2014-2015
                const departamentos = ['Produção', 'Engenharia', 'Terceiros', 'Compras', 'Comercial', 'Cliente', 'PCP', 'Expedição', 'Qualidade', 'Transporte', 'Não definido'];
                const totaisPorDepartamento = {};
                let grandTotal = 0;
                
                // Inicializar totais
                departamentos.forEach(dept => totaisPorDepartamento[dept] = 0);
                
                // Combinar dados 2014 + 2015
                const todasLinhas = [...data2014, ...data2015];
                
                // Calcular totais por departamento (índices fixos na tabela)
                todasLinhas.forEach(row => {
                    // Índices: 1=Produção, 2=Engenharia, 3=Terceiros, 4=Compras, 5=Comercial, 6=Cliente, 7=PCP, 8=Expedição, 9=Qualidade, 10=Transporte, 11=Não definido
                    totaisPorDepartamento['Produção'] += row[1];
                    totaisPorDepartamento['Engenharia'] += row[2];
                    totaisPorDepartamento['Terceiros'] += row[3];
                    totaisPorDepartamento['Compras'] += row[4];
                    totaisPorDepartamento['Comercial'] += row[5];
                    totaisPorDepartamento['Cliente'] += row[6] || 0;
                    totaisPorDepartamento['PCP'] += row[7];
                    totaisPorDepartamento['Expedição'] += row[8];
                    totaisPorDepartamento['Qualidade'] += row[9];
                    totaisPorDepartamento['Transporte'] += row[10];
                    totaisPorDepartamento['Não definido'] += row[11] || 0;
                });
                
                // Calcular o grandTotal somando os totais de cada departamento
                grandTotal = departamentos.reduce((sum, dept) => sum + totaisPorDepartamento[dept], 0);
                
                // Calcular porcentagens
                const porcentagens = {};
                departamentos.forEach(dept => {
                    porcentagens[dept] = (totaisPorDepartamento[dept] / grandTotal * 100).toFixed(1);
                });
                
                // Ordenar departamentos por porcentagem (do maior para o menor)
                const departamentosOrdenados = [...departamentos].sort((a, b) => 
                    totaisPorDepartamento[b] - totaisPorDepartamento[a]
                );
                
                // Renderizar gráfico de pizza de porcentagens
                renderDepartmentPercentChart(departamentosOrdenados, totaisPorDepartamento, porcentagens, '2014-2015', false, grandTotal);
                
                // Gráfico Total por Mês (2014)
                const labels = data2014.map(r => r[0]);
                const totals = data2014.map(r => r[10]);
                const ctx1 = document.getElementById('levTotalMes');
                if (ctx1){
                    if (window._levTotalMesChart) window._levTotalMesChart.destroy();
                    window._levTotalMesChart = new Chart(ctx1.getContext('2d'), {
                        type:'line', 
                        data:{ 
                            labels, 
                            datasets:[{ 
                                label:'Total RNCs 2014', 
                                data: totals, 
                                borderColor:'#0d6efd', 
                                backgroundColor:'rgba(13,110,253,0.1)', 
                                tension:.35,
                                pointBackgroundColor: '#0d6efd',
                                pointBorderColor: '#ffffff',
                                pointBorderWidth: 2,
                                pointRadius: 5,
                                pointHoverRadius: 7,
                                fill: true
                            }] 
                        }, 
                        options:{ 
                            responsive: true, 
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    display: true,
                                    position: 'top'
                                },
                                title: {
                                    display: true,
                                    text: 'Total de RNCs por Mês - 2014',
                                    color: '#333',
                                    font: { size: 14, weight: 'bold' }
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    grid: { color: 'rgba(0,0,0,0.1)' },
                                    title: {
                                        display: true,
                                        text: 'Quantidade de RNCs'
                                    }
                                },
                                x: {
                                    grid: { color: 'rgba(0,0,0,0.1)' },
                                    title: {
                                        display: true,
                                        text: 'Mês/Ano'
                                    }
                                }
                            }
                        }
                    });
                }
                
                // Gráfico por departamento (último mês de 2014)
                const lastRow = data2014[data2014.length-1];
                const deptVals = [1,2,3,4,5,6,7,8,9].map(i => lastRow[i] || 0);
                const ctx2 = document.getElementById('levPorDept');
                if (ctx2){
                    if (window._levPorDeptChart) window._levPorDeptChart.destroy();
                    window._levPorDeptChart = new Chart(ctx2.getContext('2d'), {
                        type:'bar', 
                        data:{ 
                            labels: depts, 
                            datasets:[{ 
                                label:'RNCs por Departamento (12/14)', 
                                data: deptVals, 
                                backgroundColor:[
                                    'rgba(13,110,253,0.8)',
                                    'rgba(102,16,242,0.8)', 
                                    'rgba(111,66,193,0.8)',
                                    'rgba(214,51,132,0.8)',
                                    'rgba(220,53,69,0.8)',
                                    'rgba(253,126,20,0.8)',
                                    'rgba(255,193,7,0.8)',
                                    'rgba(25,135,84,0.8)',
                                    'rgba(32,201,151,0.8)'
                                ],
                                borderColor:[
                                    '#0d6efd','#6610f2','#6f42c1','#d63384','#dc3545','#fd7e14','#ffc107','#198754','#20c997'
                                ],
                                borderWidth: 1
                            }] 
                        }, 
                        options:{ 
                            responsive: true, 
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    display: true,
                                    position: 'top'
                                },
                                title: {
                                    display: true,
                                    text: 'RNCs por Departamento - Dezembro 2014',
                                    color: '#333',
                                    font: { size: 14, weight: 'bold' }
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    grid: { color: 'rgba(0,0,0,0.1)' },
                                    title: {
                                        display: true,
                                        text: 'Quantidade de RNCs'
                                    }
                                },
                                x: {
                                    grid: { color: 'rgba(0,0,0,0.1)' },
                                    title: {
                                        display: true,
                                        text: 'Departamentos'
                                    }
                                }
                            }
                        }
                    });
                }
            }catch(e){ console.error('Erro loadLev1415:', e); }
        }

                
        //  Dados Reais das Planilhas ODS (2016-2025)
        // Gerado automaticamente a partir das planilhas de levantamento
        
    window.REAL_LEVANTAMENTO_DATA = {
            "2016": {
                "year": 2016,
                "months": [
                    {
                        "month": "01",
                        "data": "01/16",
                        "total": 1521.66,
                        "Produção": 0.0,
                        "Engenharia": 1521.66,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0,
                        "Cliente": 0.0,
                        "Não definido": 0.0
                    },
                    {
                        "month": "02",
                        "data": "02/16",
                        "total": 13390.06,
                        "Produção": 0.0,
                        "Engenharia": 13390.06,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0,
                        "Cliente": 0.0,
                        "Não definido": 0.0
                    },
                    {
                        "month": "03",
                        "data": "03/16",
                        "total": 449.60,
                        "Produção": 0.0,
                        "Engenharia": 0.0,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 449.60,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0,
                        "Cliente": 0.0,
                        "Não definido": 0.0
                    },
                    {
                        "month": "04",
                        "data": "04/16",
                        "total": 536.67,
                        "Produção": 536.67,
                        "Engenharia": 0.0,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0,
                        "Cliente": 0.0,
                        "Não definido": 0.0
                    },
                    {
                        "month": "05",
                        "data": "05/16",
                        "total": 0.0,
                        "Produção": 0.0,
                        "Engenharia": 0.0,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0,
                        "Cliente": 0.0,
                        "Não definido": 0.0
                    },
                    {
                        "month": "06",
                        "data": "06/16",
                        "total": 2003.33,
                        "Produção": 0.0,
                        "Engenharia": 2003.33,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0,
                        "Cliente": 0.0,
                        "Não definido": 0.0
                    },
                    {
                        "month": "07",
                        "data": "07/16",
                        "total": 3039.77,
                        "Produção": 239.25,
                        "Engenharia": 2800.52,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0,
                        "Cliente": 0.0,
                        "Não definido": 0.0
                    },
                    {
                        "month": "08",
                        "data": "08/16",
                        "total": 0.0,
                        "Produção": 0.0,
                        "Engenharia": 0.0,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0,
                        "Cliente": 0.0,
                        "Não definido": 0.0
                    },
                    {
                        "month": "09",
                        "data": "09/16",
                        "total": 8673.00,
                        "Produção": 1961.00,
                        "Engenharia": 0.0,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0,
                        "Cliente": 0.0,
                        "Não definido": 6712.00
                    },
                    {
                        "month": "10",
                        "data": "10/16",
                        "total": 845.14,
                        "Produção": 0.0,
                        "Engenharia": 845.14,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0,
                        "Cliente": 0.0,
                        "Não definido": 0.0
                        // Total: R$ 845,14
                    },
                    {
                        "month": "11",
                        "data": "11/16",
                        "total": 369.81,
                        "Produção": 0.0,
                        "Engenharia": 369.81,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0,
                        "Cliente": 0.0,
                        "Não definido": 0.0
                    },
                    {
                        "month": "12",
                        "data": "12/16",
                        "total": 0.0,
                        "Produção": 0.0,
                        "Engenharia": 0.0,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0,
                        "Cliente": 0.0,
                        "Não definido": 0.0
                    }
                ]
            },
            "2017": {
                "year": 2017,
                "months": [
                    {
                        "month": "01",
                        "data": "01/17",
                        "total": 25849.82,
                        "Produção": 7039.95,
                        "Engenharia": 17515.87,
                        "Terceiros": 1060.0,
                        "Compras": 234.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "02",
                        "data": "02/17",
                        "total": 22418.02,
                        "Produção": 4083.98,
                        "Engenharia": 17624.04,
                        "Terceiros": 510.0,
                        "Compras": 0.0,
                        "Comercial": 200.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "03",
                        "data": "03/17",
                        "total": 25699.47,
                        "Produção": 7011.57,
                        "Engenharia": 18007.9,
                        "Terceiros": 680.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "04",
                        "data": "04/17",
                        "total": 19501.08,
                        "Produção": 2849.6,
                        "Engenharia": 14351.48,
                        "Terceiros": 2300.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "05",
                        "data": "05/17",
                        "total": 22831.0,
                        "Produção": 13125.0,
                        "Engenharia": 9106.0,
                        "Terceiros": 450.0,
                        "Compras": 150.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "06",
                        "data": "06/17",
                        "total": 28719.34,
                        "Produção": 8493.7,
                        "Engenharia": 17085.47,
                        "Terceiros": 2970.17,
                        "Compras": 170.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "07",
                        "data": "07/17",
                        "total": 42365.8,
                        "Produção": 7833.47,
                        "Engenharia": 30081.8,
                        "Terceiros": 3070.53,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 1380.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "08",
                        "data": "08/17",
                        "total": 28082.41,
                        "Produção": 10510.38,
                        "Engenharia": 13483.36,
                        "Terceiros": 4065.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "09",
                        "data": "09/17",
                        "total": 31805.41,
                        "Produção": 10186.04,
                        "Engenharia": 20195.2,
                        "Terceiros": 1424.17,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "10",
                        "data": "10/17",
                        "total": 50710.03,
                        "Produção": 10506.16,
                        "Engenharia": 38362.87,
                        "Terceiros": 1360.0,
                        "Compras": 80.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 401.0
                    },
                    {
                        "month": "11",
                        "data": "11/17",
                        "total": 29337.31,
                        "Produção": 6700.94,
                        "Engenharia": 21366.37,
                        "Terceiros": 1270.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "12",
                        "data": "12/17",
                        "total": 31264.46,
                        "Produção": 9805.5,
                        "Engenharia": 19621.96,
                        "Terceiros": 1495.0,
                        "Compras": 342.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    }
                ]
            },
            "2018": {
                "year": 2018,
                "months": [
                    {
                        "month": "01",
                        "data": "01/18",
                        "total": 24282.22,
                        "Produção": 7834.7,
                        "Engenharia": 15902.52,
                        "Terceiros": 420.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 125.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "02",
                        "data": "02/18",
                        "total": 71470.35,
                        "Produção": 12770.43,
                        "Engenharia": 48204.67,
                        "Terceiros": 10495.25,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "03",
                        "data": "03/18",
                        "total": 31295.56,
                        "Produção": 13960.56,
                        "Engenharia": 16217.0,
                        "Terceiros": 970.0,
                        "Compras": 148.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "04",
                        "data": "04/18",
                        "total": 12531.0,
                        "Produção": 1896.0,
                        "Engenharia": 9130.0,
                        "Terceiros": 1505.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "05",
                        "data": "05/18",
                        "total": 32258.82,
                        "Produção": 15281.89,
                        "Engenharia": 16016.93,
                        "Terceiros": 800.0,
                        "Compras": 160.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "06",
                        "data": "06/18",
                        "total": 49993.09,
                        "Produção": 4771.0,
                        "Engenharia": 14102.09,
                        "Terceiros": 2340.0,
                        "Compras": 0.0,
                        "Comercial": 28780.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "07",
                        "data": "07/18",
                        "total": 27401.2,
                        "Produção": 11291.67,
                        "Engenharia": 14110.53,
                        "Terceiros": 1295.0,
                        "Compras": 0.0,
                        "Comercial": 704.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "08",
                        "data": "08/18",
                        "total": 28640.52,
                        "Produção": 9777.98,
                        "Engenharia": 15784.94,
                        "Terceiros": 790.8,
                        "Compras": 140.0,
                        "Comercial": 1500.0,
                        "PCP": 646.8,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "09",
                        "data": "09/18",
                        "total": 19117.35,
                        "Produção": 4978.0,
                        "Engenharia": 12942.64,
                        "Terceiros": 636.71,
                        "Compras": 0.0,
                        "Comercial": 560.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "10",
                        "data": "10/18",
                        "total": 27563.1,
                        "Produção": 5405.36,
                        "Engenharia": 20977.74,
                        "Terceiros": 380.0,
                        "Compras": 80.0,
                        "Comercial": 720.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "11",
                        "data": "11/18",
                        "total": 25504.66,
                        "Produção": 6362.24,
                        "Engenharia": 17167.42,
                        "Terceiros": 1495.0,
                        "Compras": 0.0,
                        "Comercial": 480.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "12",
                        "data": "12/18",
                        "total": 24272.2,
                        "Produção": 3087.98,
                        "Engenharia": 14850.22,
                        "Terceiros": 6334.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "01",
                        "data": "01/18",
                        "total": 5968.75,
                        "Produção": 0.0,
                        "Engenharia": 5968.75,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "02",
                        "data": "02/18",
                        "total": 2009.08,
                        "Produção": 2009.08,
                        "Engenharia": 0.0,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "03",
                        "data": "03/18",
                        "total": 2859.67,
                        "Produção": 0.0,
                        "Engenharia": 2859.67,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "04",
                        "data": "04/18",
                        "total": 109186.0,
                        "Produção": 4035.45,
                        "Engenharia": 103931.58,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 1218.97,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "05",
                        "data": "05/18",
                        "total": 0.0,
                        "Produção": 0.0,
                        "Engenharia": 0.0,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "06",
                        "data": "06/18",
                        "total": 43822.47,
                        "Produção": 0.0,
                        "Engenharia": 43822.47,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "07",
                        "data": "07/18",
                        "total": 44928.34,
                        "Produção": 2375.83,
                        "Engenharia": 25973.43,
                        "Terceiros": 16579.08,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "08",
                        "data": "08/18",
                        "total": 6456.8,
                        "Produção": 5989.11,
                        "Engenharia": 467.69,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "09",
                        "data": "09/18",
                        "total": 21333.88,
                        "Produção": 0.0,
                        "Engenharia": 21333.88,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "10",
                        "data": "10/18",
                        "total": 14567.52,
                        "Produção": 1889.12,
                        "Engenharia": 12678.4,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "11",
                        "data": "11/18",
                        "total": 19964.71,
                        "Produção": 0.0,
                        "Engenharia": 19964.71,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "12",
                        "data": "12/18",
                        "total": 8781.06,
                        "Produção": 0.0,
                        "Engenharia": 8781.06,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    }
                ]
            },
            "2019": {
                "year": 2019,
                "months": [
                    {
                        "month": "01",
                        "data": "01/19",
                        "total": 32070.25,
                        "Produção": 5930.84,
                        "Engenharia": 15766.38,
                        "Terceiros": 9774.63,
                        "Compras": 278.4,
                        "Comercial": 320.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "02",
                        "data": "02/19",
                        "total": 32482.62,
                        "Produção": 1981.79,
                        "Engenharia": 27363.45,
                        "Terceiros": 2275.38,
                        "Compras": 202.0,
                        "Comercial": 660.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "03",
                        "data": "03/19",
                        "total": 29266.67,
                        "Produção": 4264.75,
                        "Engenharia": 20830.92,
                        "Terceiros": 3771.0,
                        "Compras": 0.0,
                        "Comercial": 400.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "04",
                        "data": "04/19",
                        "total": 15708.17,
                        "Produção": 3756.17,
                        "Engenharia": 11392.0,
                        "Terceiros": 240.0,
                        "Compras": 80.0,
                        "Comercial": 240.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "05",
                        "data": "05/19",
                        "total": 23394.53,
                        "Produção": 3389.0,
                        "Engenharia": 13223.19,
                        "Terceiros": 486.22,
                        "Compras": 80.0,
                        "Comercial": 5916.12,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 300.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "06",
                        "data": "06/19",
                        "total": 53466.2,
                        "Produção": 15242.44,
                        "Engenharia": 36901.86,
                        "Terceiros": 1241.9,
                        "Compras": 0.0,
                        "Comercial": 80.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "07",
                        "data": "07/19",
                        "total": 53888.16,
                        "Produção": 9869.5,
                        "Engenharia": 41906.66,
                        "Terceiros": 240.0,
                        "Compras": 312.0,
                        "Comercial": 1560.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "08",
                        "data": "08/19",
                        "total": 71222.07,
                        "Produção": 13424.11,
                        "Engenharia": 52410.96,
                        "Terceiros": 2534.0,
                        "Compras": 1433.0,
                        "Comercial": 1420.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "09",
                        "data": "09/19",
                        "total": 28256.93,
                        "Produção": 3869.22,
                        "Engenharia": 21591.71,
                        "Terceiros": 2556.0,
                        "Compras": 0.0,
                        "Comercial": 240.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "10",
                        "data": "10/19",
                        "total": 26257.72,
                        "Produção": 9046.84,
                        "Engenharia": 15068.88,
                        "Terceiros": 1464.0,
                        "Compras": 160.0,
                        "Comercial": 518.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "11",
                        "data": "11/19",
                        "total": 26646.25,
                        "Produção": 3196.0,
                        "Engenharia": 20250.25,
                        "Terceiros": 2480.0,
                        "Compras": 320.0,
                        "Comercial": 400.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "12",
                        "data": "12/19",
                        "total": 23527.76,
                        "Produção": 4458.76,
                        "Engenharia": 18669.0,
                        "Terceiros": 240.0,
                        "Compras": 0.0,
                        "Comercial": 160.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "01",
                        "data": "01/19",
                        "total": 54403.84,
                        "Produção": 4917.0,
                        "Engenharia": 44005.92,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 5480.92
                    },
                    {
                        "month": "02",
                        "data": "02/19",
                        "total": 0.0,
                        "Produção": 0.0,
                        "Engenharia": 0.0,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "03",
                        "data": "03/19",
                        "total": 2934.68,
                        "Produção": 0.0,
                        "Engenharia": 2867.68,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 67.0
                    },
                    {
                        "month": "04",
                        "data": "04/19",
                        "total": 1815.97,
                        "Produção": 0.0,
                        "Engenharia": 1815.97,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "05",
                        "data": "05/19",
                        "total": 19962.15,
                        "Produção": 4113.98,
                        "Engenharia": 0.0,
                        "Terceiros": 0.0,
                        "Compras": 9511.78,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 6336.39
                    },
                    {
                        "month": "06",
                        "data": "06/19",
                        "total": 43852.54,
                        "Produção": 1449.17,
                        "Engenharia": 1323.65,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 41079.72
                    },
                    {
                        "month": "07",
                        "data": "07/19",
                        "total": 0.0,
                        "Produção": 0.0,
                        "Engenharia": 0.0,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "08",
                        "data": "08/19",
                        "total": 42831.15,
                        "Produção": 0.0,
                        "Engenharia": 21126.96,
                        "Terceiros": 21704.19,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "09",
                        "data": "09/19",
                        "total": 2557.32,
                        "Produção": 0.0,
                        "Engenharia": 2137.32,
                        "Terceiros": 0.0,
                        "Compras": 420.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "10",
                        "data": "10/19",
                        "total": 2485.93,
                        "Produção": 840.93,
                        "Engenharia": 1645.0,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "11",
                        "data": "11/19",
                        "total": 0.0,
                        "Produção": 0.0,
                        "Engenharia": 0.0,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "12",
                        "data": "12/19",
                        "total": 15020.8,
                        "Produção": 0.0,
                        "Engenharia": 1934.21,
                        "Terceiros": 13086.59,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    }
                ]
            },
            "2020": {
                "year": 2020,
                "months": [
                    {
                        "month": "01",
                        "data": "01/20",
                        "total": 30092.64,
                        "Produção": 7086.0,
                        "Engenharia": 19481.64,
                        "Terceiros": 3285.0,
                        "Compras": 0.0,
                        "Comercial": 240.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "02",
                        "data": "02/20",
                        "total": 30084.54,
                        "Produção": 2993.0,
                        "Engenharia": 24791.54,
                        "Terceiros": 1000.0,
                        "Compras": 200.0,
                        "Comercial": 600.0,
                        "PCP": 0.0,
                        "Expedição": 500.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "03",
                        "data": "03/20",
                        "total": 27655.88,
                        "Produção": 2452.0,
                        "Engenharia": 23748.9,
                        "Terceiros": 1374.98,
                        "Compras": 0.0,
                        "Comercial": 80.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "04",
                        "data": "04/20",
                        "total": 26694.89,
                        "Produção": 3138.52,
                        "Engenharia": 16664.37,
                        "Terceiros": 5580.0,
                        "Compras": 1072.0,
                        "Comercial": 240.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "05",
                        "data": "05/20",
                        "total": 21093.77,
                        "Produção": 5195.16,
                        "Engenharia": 15088.61,
                        "Terceiros": 570.0,
                        "Compras": 0.0,
                        "Comercial": 240.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "06",
                        "data": "06/20",
                        "total": 21630.69,
                        "Produção": 5176.92,
                        "Engenharia": 12855.0,
                        "Terceiros": 0.0,
                        "Compras": 200.0,
                        "Comercial": 160.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 3238.77,
                        "Transporte": 0.0
                    },
                    {
                        "month": "07",
                        "data": "07/20",
                        "total": 43963.55,
                        "Produção": 2849.38,
                        "Engenharia": 39593.17,
                        "Terceiros": 1361.0,
                        "Compras": 0.0,
                        "Comercial": 160.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "08",
                        "data": "08/20",
                        "total": 26269.42,
                        "Produção": 2696.84,
                        "Engenharia": 23172.58,
                        "Terceiros": 240.0,
                        "Compras": 80.0,
                        "Comercial": 80.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "09",
                        "data": "09/20",
                        "total": 15694.6,
                        "Produção": 4291.6,
                        "Engenharia": 10523.0,
                        "Terceiros": 400.0,
                        "Compras": 0.0,
                        "Comercial": 480.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "10",
                        "data": "10/20",
                        "total": 17271.38,
                        "Produção": 5841.71,
                        "Engenharia": 10179.67,
                        "Terceiros": 1250.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "11",
                        "data": "11/20",
                        "total": 17432.64,
                        "Produção": 3074.0,
                        "Engenharia": 13558.64,
                        "Terceiros": 480.0,
                        "Compras": 80.0,
                        "Comercial": 160.0,
                        "PCP": 80.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "12",
                        "data": "12/20",
                        "total": 26574.0,
                        "Produção": 1321.0,
                        "Engenharia": 15361.0,
                        "Terceiros": 9892.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "01",
                        "data": "01/20",
                        "total": 23385.43,
                        "Produção": 313.0,
                        "Engenharia": 23072.43,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "02",
                        "data": "02/20",
                        "total": 103147.91,
                        "Produção": 0.0,
                        "Engenharia": 86520.71,
                        "Terceiros": 16627.2,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "03",
                        "data": "03/20",
                        "total": 103664.63,
                        "Produção": 0.0,
                        "Engenharia": 103664.63,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "04",
                        "data": "04/20",
                        "total": 258.06,
                        "Produção": 0.0,
                        "Engenharia": 258.06,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "05",
                        "data": "05/20",
                        "total": 30682.04,
                        "Produção": 591.13,
                        "Engenharia": 30090.91,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "06",
                        "data": "06/20",
                        "total": 47080.56,
                        "Produção": 0.0,
                        "Engenharia": 47080.56,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "07",
                        "data": "07/20",
                        "total": 5598.69,
                        "Produção": 0.0,
                        "Engenharia": 5598.69,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "08",
                        "data": "08/20",
                        "total": 34787.37,
                        "Produção": 0.0,
                        "Engenharia": 34787.37,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "09",
                        "data": "09/20",
                        "total": 15762.38,
                        "Produção": 0.0,
                        "Engenharia": 15762.38,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "10",
                        "data": "10/20",
                        "total": 8920.36,
                        "Produção": 8190.83,
                        "Engenharia": 0.0,
                        "Terceiros": 729.53,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "11",
                        "data": "11/20",
                        "total": 9696.88,
                        "Produção": 1505.98,
                        "Engenharia": 8190.9,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "12",
                        "data": "12/20",
                        "total": 3062.3,
                        "Produção": 2153.07,
                        "Engenharia": 909.23,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    }
                ]
            },
            "2021": {
                "year": 2021,
                "months": [
                    {
                        "month": "01",
                        "data": "01/21",
                        "total": 30931.98,
                        "Produção": 5472.3,
                        "Engenharia": 24579.68,
                        "Terceiros": 800.0,
                        "Compras": 0.0,
                        "Comercial": 80.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "02",
                        "data": "02/21",
                        "total": 14778.47,
                        "Produção": 6975.39,
                        "Engenharia": 7323.08,
                        "Terceiros": 480.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "03",
                        "data": "03/21",
                        "total": 9168.65,
                        "Produção": 1642.5,
                        "Engenharia": 7076.15,
                        "Terceiros": 450.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "04",
                        "data": "04/21",
                        "total": 19516.14,
                        "Produção": 5071.5,
                        "Engenharia": 12446.64,
                        "Terceiros": 1998.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "05",
                        "data": "05/21",
                        "total": 16709.15,
                        "Produção": 4495.75,
                        "Engenharia": 9111.4,
                        "Terceiros": 3102.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "06",
                        "data": "06/21",
                        "total": 17765.98,
                        "Produção": 3253.37,
                        "Engenharia": 13952.61,
                        "Terceiros": 320.0,
                        "Compras": 80.0,
                        "Comercial": 160.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "07",
                        "data": "07/21",
                        "total": 80437.78,
                        "Produção": 8888.85,
                        "Engenharia": 16808.93,
                        "Terceiros": 54433.0,
                        "Compras": 307.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "08",
                        "data": "08/21",
                        "total": 72621.17,
                        "Produção": 4780.97,
                        "Engenharia": 51746.35,
                        "Terceiros": 12822.5,
                        "Compras": 2226.35,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 1045.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "09",
                        "data": "09/21",
                        "total": 58246.85,
                        "Produção": 22043.23,
                        "Engenharia": 32961.77,
                        "Terceiros": 3161.85,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 80.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "10",
                        "data": "10/21",
                        "total": 24739.88,
                        "Produção": 6556.75,
                        "Engenharia": 16023.13,
                        "Terceiros": 2160.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "11",
                        "data": "11/21",
                        "total": 20742.85,
                        "Produção": 5388.53,
                        "Engenharia": 14110.32,
                        "Terceiros": 1124.0,
                        "Compras": 120.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "12",
                        "data": "12/21",
                        "total": 10872.69,
                        "Produção": 7650.69,
                        "Engenharia": 2348.0,
                        "Terceiros": 874.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "01",
                        "data": "01/21",
                        "total": 20397.67,
                        "Produção": 8111.26,
                        "Engenharia": 11986.41,
                        "Terceiros": 300.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "02",
                        "data": "02/21",
                        "total": 16692.06,
                        "Produção": 0.0,
                        "Engenharia": 16692.06,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "03",
                        "data": "03/21",
                        "total": 23217.17,
                        "Produção": 0.0,
                        "Engenharia": 12215.61,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 11001.56,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "04",
                        "data": "04/21",
                        "total": 8103.06,
                        "Produção": 4984.56,
                        "Engenharia": 2931.5,
                        "Terceiros": 187.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "05",
                        "data": "05/21",
                        "total": 11530.86,
                        "Produção": 0.0,
                        "Engenharia": 11530.86,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "06",
                        "data": "06/21",
                        "total": 145719.26,
                        "Produção": 0.0,
                        "Engenharia": 3320.28,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 142398.98
                    },
                    {
                        "month": "07",
                        "data": "07/21",
                        "total": 12910.62,
                        "Produção": 5476.4,
                        "Engenharia": 7434.22,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "08",
                        "data": "08/21",
                        "total": 5922.52,
                        "Produção": 0.0,
                        "Engenharia": 4771.19,
                        "Terceiros": 1151.33,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "09",
                        "data": "09/21",
                        "total": 27707.18,
                        "Produção": 703.6,
                        "Engenharia": 656.76,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 26346.82,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "10",
                        "data": "10/21",
                        "total": 10521.8,
                        "Produção": 0.0,
                        "Engenharia": 10521.8,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "11",
                        "data": "11/21",
                        "total": 13413.35,
                        "Produção": 0.0,
                        "Engenharia": 13413.35,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "12",
                        "data": "12/21",
                        "total": 12454.14,
                        "Produção": 1238.2,
                        "Engenharia": 11215.94,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    }
                ]
            },
            "2022": {
                "year": 2022,
                "months": [
                    {
                        "month": "01",
                        "data": "01/22",
                        "total": 48242.02,
                        "Produção": 3744.35,
                        "Engenharia": 44186.67,
                        "Terceiros": 311.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "02",
                        "data": "02/22",
                        "total": 13783.85,
                        "Produção": 2432.0,
                        "Engenharia": 11351.85,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "03",
                        "data": "03/22",
                        "total": 26984.85,
                        "Produção": 3174.6,
                        "Engenharia": 22510.25,
                        "Terceiros": 1000.0,
                        "Compras": 200.0,
                        "Comercial": 0.0,
                        "PCP": 100.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "04",
                        "data": "04/22",
                        "total": 24508.57,
                        "Produção": 3863.05,
                        "Engenharia": 20345.52,
                        "Terceiros": 100.0,
                        "Compras": 200.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "05",
                        "data": "05/22",
                        "total": 21783.94,
                        "Produção": 1587.98,
                        "Engenharia": 18979.96,
                        "Terceiros": 1116.0,
                        "Compras": 0.0,
                        "Comercial": 100.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "06",
                        "data": "06/22",
                        "total": 23450.21,
                        "Produção": 3940.49,
                        "Engenharia": 11682.76,
                        "Terceiros": 7826.96,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "07",
                        "data": "07/22",
                        "total": 14819.55,
                        "Produção": 2175.23,
                        "Engenharia": 9297.86,
                        "Terceiros": 3346.46,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "08",
                        "data": "08/22",
                        "total": 29329.94,
                        "Produção": 2772.61,
                        "Engenharia": 24859.05,
                        "Terceiros": 1698.28,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "09",
                        "data": "09/22",
                        "total": 31224.88,
                        "Produção": 3216.56,
                        "Engenharia": 23460.5,
                        "Terceiros": 1947.82,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 2600.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "10",
                        "data": "10/22",
                        "total": 19277.78,
                        "Produção": 2452.2,
                        "Engenharia": 14353.0,
                        "Terceiros": 2472.58,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "11",
                        "data": "11/22",
                        "total": 13161.12,
                        "Produção": 1491.54,
                        "Engenharia": 11055.58,
                        "Terceiros": 614.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "12",
                        "data": "12/22",
                        "total": 6889.02,
                        "Produção": 2209.02,
                        "Engenharia": 4380.0,
                        "Terceiros": 300.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "01",
                        "data": "01/22",
                        "total": 12253.81,
                        "Produção": 0.0,
                        "Engenharia": 12253.81,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "02",
                        "data": "02/22",
                        "total": 21205.12,
                        "Produção": 1827.77,
                        "Engenharia": 19377.35,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "03",
                        "data": "03/22",
                        "total": 38979.13,
                        "Produção": 0.0,
                        "Engenharia": 37694.13,
                        "Terceiros": 0.0,
                        "Compras": 1285.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "04",
                        "data": "04/22",
                        "total": 9418.68,
                        "Produção": 0.0,
                        "Engenharia": 9418.68,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "05",
                        "data": "05/22",
                        "total": 84779.89,
                        "Produção": 0.0,
                        "Engenharia": 84779.89,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "06",
                        "data": "06/22",
                        "total": 13740.91,
                        "Produção": 0.0,
                        "Engenharia": 13740.91,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "07",
                        "data": "07/22",
                        "total": 34131.03,
                        "Produção": 0.0,
                        "Engenharia": 34131.03,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "08",
                        "data": "08/22",
                        "total": 47963.4,
                        "Produção": 6671.84,
                        "Engenharia": 33841.04,
                        "Terceiros": 0.0,
                        "Compras": 7450.52,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "09",
                        "data": "09/22",
                        "total": 54623.32,
                        "Produção": 1585.37,
                        "Engenharia": 53037.95,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "10",
                        "data": "10/22",
                        "total": 17828.71,
                        "Produção": 2565.41,
                        "Engenharia": 15263.3,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "11",
                        "data": "11/22",
                        "total": 24776.78,
                        "Produção": 462.77,
                        "Engenharia": 15802.39,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 8511.62,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "12",
                        "data": "12/22",
                        "total": 3121.25,
                        "Produção": 0.0,
                        "Engenharia": 3121.25,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    }
                ]
            },
            "2023": {
                "year": 2023,
                "months": [
                    {
                        "month": "01",
                        "data": "01/23",
                        "total": 12704.28,
                        "Produção": 1695.85,
                        "Engenharia": 8659.87,
                        "Terceiros": 1751.42,
                        "Compras": 0.0,
                        "Comercial": 300.0,
                        "PCP": 297.14,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "02",
                        "data": "02/23",
                        "total": 16367.53,
                        "Produção": 2804.6,
                        "Engenharia": 10790.6,
                        "Terceiros": 2772.33,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "03",
                        "data": "03/23",
                        "total": 25085.1,
                        "Produção": 1979.0,
                        "Engenharia": 21656.98,
                        "Terceiros": 1449.12,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "04",
                        "data": "04/23",
                        "total": 13480.0,
                        "Produção": 1100.0,
                        "Engenharia": 11580.0,
                        "Terceiros": 800.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "05",
                        "data": "05/23",
                        "total": 18159.48,
                        "Produção": 1989.04,
                        "Engenharia": 12879.8,
                        "Terceiros": 3290.64,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "06",
                        "data": "06/23",
                        "total": 13272.98,
                        "Produção": 1763.52,
                        "Engenharia": 10609.46,
                        "Terceiros": 900.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "07",
                        "data": "07/23",
                        "total": 14815.52,
                        "Produção": 2692.6,
                        "Engenharia": 8685.0,
                        "Terceiros": 3437.92,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "08",
                        "data": "08/23",
                        "total": 11448.48,
                        "Produção": 1356.32,
                        "Engenharia": 9000.0,
                        "Terceiros": 1092.16,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "09",
                        "data": "09/23",
                        "total": 18526.86,
                        "Produção": 2960.97,
                        "Engenharia": 10820.03,
                        "Terceiros": 4745.86,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "10",
                        "data": "10/23",
                        "total": 26855.17,
                        "Produção": 4224.27,
                        "Engenharia": 14874.9,
                        "Terceiros": 7756.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "11",
                        "data": "11/23",
                        "total": 21012.0,
                        "Produção": 1810.0,
                        "Engenharia": 15743.43,
                        "Terceiros": 3458.57,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "12",
                        "data": "12/23",
                        "total": 19793.84,
                        "Produção": 300.0,
                        "Engenharia": 15641.84,
                        "Terceiros": 3852.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "01",
                        "data": "01/23",
                        "total": 144807.65,
                        "Produção": 0.0,
                        "Engenharia": 14247.75,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 130559.9
                    },
                    {
                        "month": "02",
                        "data": "02/23",
                        "total": 32900.9,
                        "Produção": 7781.78,
                        "Engenharia": 23519.49,
                        "Terceiros": 1599.63,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "03",
                        "data": "03/23",
                        "total": 34197.03,
                        "Produção": 0.0,
                        "Engenharia": 34197.03,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "04",
                        "data": "04/23",
                        "total": 159557.66,
                        "Produção": 0.0,
                        "Engenharia": 159557.66,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "05",
                        "data": "05/23",
                        "total": 15380.56,
                        "Produção": 0.0,
                        "Engenharia": 15380.56,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "06",
                        "data": "06/23",
                        "total": 2485.35,
                        "Produção": 976.78,
                        "Engenharia": 1508.57,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "07",
                        "data": "07/23",
                        "total": 17047.87,
                        "Produção": 0.0,
                        "Engenharia": 17047.87,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "08",
                        "data": "08/23",
                        "total": 5017.02,
                        "Produção": 354.54,
                        "Engenharia": 4662.48,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "09",
                        "data": "09/23",
                        "total": 40466.8,
                        "Produção": 0.0,
                        "Engenharia": 18838.71,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 21628.09
                    },
                    {
                        "month": "10",
                        "data": "10/23",
                        "total": 26392.41,
                        "Produção": 0.0,
                        "Engenharia": 5450.17,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 20942.24
                    },
                    {
                        "month": "11",
                        "data": "11/23",
                        "total": 48392.65,
                        "Produção": 0.0,
                        "Engenharia": 38206.23,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 10186.42
                    },
                    {
                        "month": "12",
                        "data": "12/23",
                        "total": 291569.0,
                        "Produção": 805.93,
                        "Engenharia": 25942.67,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 264820.4
                    }
                ]
            },
            "2024": {
                "year": 2024,
                "months": [
                    {
                        "month": "01",
                        "data": "01/24",
                        "total": 42896.659999999996,
                        "Produção": 2925.6,
                        "Engenharia": 38471.06,
                        "Terceiros": 1400.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0
                    },
                    {
                        "month": "02",
                        "data": "02/24",
                        "total": 11707.0,
                        "Produção": 3257.0,
                        "Engenharia": 6900.0,
                        "Terceiros": 1550.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0
                    },
                    {
                        "month": "03",
                        "data": "03/24",
                        "total": 8000.0,
                        "Produção": 1000.0,
                        "Engenharia": 5300.0,
                        "Terceiros": 1700.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0
                    },
                    {
                        "month": "04",
                        "data": "04/24",
                        "total": 9114.0,
                        "Produção": 2014.0,
                        "Engenharia": 4700.0,
                        "Terceiros": 2400.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0
                    },
                    {
                        "month": "05",
                        "data": "05/24",
                        "total": 11712.0,
                        "Produção": 900.0,
                        "Engenharia": 7400.0,
                        "Terceiros": 3412.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0
                    },
                    {
                        "month": "06",
                        "data": "06/24",
                        "total": 5604.0,
                        "Produção": 900.0,
                        "Engenharia": 4104.0,
                        "Terceiros": 600.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0
                    },
                    {
                        "month": "07",
                        "data": "07/24",
                        "total": 11511.0,
                        "Produção": 1200.0,
                        "Engenharia": 9811.0,
                        "Terceiros": 300.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 200.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0
                    },
                    {
                        "month": "08",
                        "data": "08/24",
                        "total": 10800.0,
                        "Produção": 800.0,
                        "Engenharia": 9000.0,
                        "Terceiros": 700.0,
                        "Compras": 300.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0
                    },
                    {
                        "month": "09",
                        "data": "09/24",
                        "total": 9422.39,
                        "Produção": 1570.39,
                        "Engenharia": 7210.0,
                        "Terceiros": 642.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0
                    },
                    {
                        "month": "10",
                        "data": "10/24",
                        "total": 23369.79,
                        "Produção": 4457.0,
                        "Engenharia": 15406.79,
                        "Terceiros": 3406.0,
                        "Compras": 100.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0
                    },
                    {
                        "month": "11",
                        "data": "11/24",
                        "total": 22094.160000000003,
                        "Produção": 100.0,
                        "Engenharia": 20522.08,
                        "Terceiros": 1472.08,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0
                    },
                    {
                        "month": "12",
                        "data": "12/24",
                        "total": 17327.14,
                        "Produção": 1826.0,
                        "Engenharia": 14122.14,
                        "Terceiros": 1379.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0
                    },
                    {
                        "month": "01",
                        "data": "01/24",
                        "total": 8170.86,
                        "Produção": 0.0,
                        "Engenharia": 0.0,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0
                    },
                    {
                        "month": "02",
                        "data": "02/24",
                        "total": 36552.83,
                        "Produção": 6412.83,
                        "Engenharia": 30140.0,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0
                    },
                    {
                        "month": "03",
                        "data": "03/24",
                        "total": 39912.23,
                        "Produção": 775.15,
                        "Engenharia": 39137.08,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0
                    },
                    {
                        "month": "04",
                        "data": "04/24",
                        "total": 30362.97,
                        "Produção": 2462.5,
                        "Engenharia": 27900.47,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0
                    },
                    {
                        "month": "05",
                        "data": "05/24",
                        "total": 2357.79,
                        "Produção": 0.0,
                        "Engenharia": 984.51,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 1373.28,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0
                    },
                    {
                        "month": "06",
                        "data": "06/24",
                        "total": 6848.46,
                        "Produção": 0.0,
                        "Engenharia": 220.97,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0
                    },
                    {
                        "month": "07",
                        "data": "07/24",
                        "total": 17476.34,
                        "Produção": 1461.0,
                        "Engenharia": 4606.11,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0
                    },
                    {
                        "month": "08",
                        "data": "08/24",
                        "total": 29121.270000000004,
                        "Produção": 19.99,
                        "Engenharia": 27004.06,
                        "Terceiros": 0.0,
                        "Compras": 2097.22,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0
                    },
                    {
                        "month": "09",
                        "data": "09/24",
                        "total": 178416.84,
                        "Produção": 834.43,
                        "Engenharia": 177582.41,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0
                    },
                    {
                        "month": "10",
                        "data": "10/24",
                        "total": 62600.81,
                        "Produção": 940.92,
                        "Engenharia": 51595.73,
                        "Terceiros": 0.0,
                        "Compras": 7062.03,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0
                    },
                    {
                        "month": "11",
                        "data": "11/24",
                        "total": 39676.95,
                        "Produção": 0.0,
                        "Engenharia": 39676.95,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0
                    },
                    {
                        "month": "12",
                        "data": "12/24",
                        "total": 18519.149999999998,
                        "Produção": 0.0,
                        "Engenharia": 6715.08,
                        "Terceiros": 0.0,
                        "Compras": 9944.95,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0
                    }
                ]
            },
            "2025": {
                "year": 2025,
                "months": [
                    {
                        "month": "01",
                        "data": "01/25",
                        "total": 16850.0,
                        "Produção": 5750.0,
                        "Engenharia": 10200.0,
                        "Terceiros": 400.0,
                        "Compras": 300.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 200.0,
                        "Transporte": 0
                    },
                    {
                        "month": "02",
                        "data": "02/25",
                        "total": 21109.14,
                        "Produção": 7834.19,
                        "Engenharia": 11800.0,
                        "Terceiros": 1274.95,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 200.0,
                        "Transporte": 0
                    },
                    {
                        "month": "03",
                        "data": "03/25",
                        "total": 10200.0,
                        "Produção": 2500.0,
                        "Engenharia": 7000.0,
                        "Terceiros": 500.0,
                        "Compras": 0.0,
                        "Comercial": 100.0,
                        "PCP": 100.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0
                    },
                    {
                        "month": "04",
                        "data": "04/25",
                        "total": 15498.99,
                        "Produção": 3103.94,
                        "Engenharia": 9785.99,
                        "Terceiros": 2309.06,
                        "Compras": 300.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0
                    },
                    {
                        "month": "05",
                        "data": "05/25",
                        "total": 16279.06,
                        "Produção": 2674.22,
                        "Engenharia": 7199.93,
                        "Terceiros": 4936.5,
                        "Compras": 200.0,
                        "Comercial": 0.0,
                        "PCP": 1268.41,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0
                    },
                    {
                        "month": "06",
                        "data": "06/25",
                        "total": 17064.3,
                        "Produção": 3458.24,
                        "Engenharia": 12298.4,
                        "Terceiros": 1207.66,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 100.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0
                    },
                    {
                        "month": "07",
                        "data": "07/25",
                        "total": 0,
                        "Produção": 0.0,
                        "Engenharia": 0.0,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0
                    },
                    {
                        "month": "08",
                        "data": "08/25",
                        "total": 0,
                        "Produção": 0.0,
                        "Engenharia": 0.0,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0
                    },
                    {
                        "month": "09",
                        "data": "09/25",
                        "total": 0,
                        "Produção": 0.0,
                        "Engenharia": 0.0,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0
                    },
                    {
                        "month": "10",
                        "data": "10/25",
                        "total": 0,
                        "Produção": 0.0,
                        "Engenharia": 0.0,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0
                    },
                    {
                        "month": "11",
                        "data": "11/25",
                        "total": 0,
                        "Produção": 0.0,
                        "Engenharia": 0.0,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0
                    },
                    {
                        "month": "12",
                        "data": "12/25",
                        "total": 0,
                        "Produção": 0.0,
                        "Engenharia": 0.0,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0
                    },
                    {
                        "month": "01",
                        "data": "01/25",
                        "total": 12589.35,
                        "Produção": 2712.84,
                        "Engenharia": 0.0,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0
                    },
                    {
                        "month": "02",
                        "data": "02/25",
                        "total": 31749.440000000002,
                        "Produção": 725.25,
                        "Engenharia": 10383.09,
                        "Terceiros": 7820.0,
                        "Compras": 0.0,
                        "Comercial": 12821.1,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0
                    },
                    {
                        "month": "03",
                        "data": "03/25",
                        "total": 29637.64,
                        "Produção": 0.0,
                        "Engenharia": 23992.64,
                        "Terceiros": 0.0,
                        "Compras": 5645.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0
                    },
                    {
                        "month": "04",
                        "data": "04/25",
                        "total": 17772.34,
                        "Produção": 0.0,
                        "Engenharia": 16686.49,
                        "Terceiros": 62.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0
                    },
                    {
                        "month": "05",
                        "data": "05/25",
                        "total": 56087.51,
                        "Produção": 851.14,
                        "Engenharia": 55236.37,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0
                    },
                    {
                        "month": "06",
                        "data": "06/25",
                        "total": 82183.11,
                        "Produção": 970.36,
                        "Engenharia": 51530.98,
                        "Terceiros": 17766.77,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0
                    },
                    {
                        "month": "07",
                        "data": "07/25",
                        "total": 0,
                        "Produção": 0.0,
                        "Engenharia": 0.0,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0
                    },
                    {
                        "month": "08",
                        "data": "08/25",
                        "total": 0,
                        "Produção": 0.0,
                        "Engenharia": 0.0,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0
                    },
                    {
                        "month": "09",
                        "data": "09/25",
                        "total": 0,
                        "Produção": 0.0,
                        "Engenharia": 0.0,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0
                    },
                    {
                        "month": "10",
                        "data": "10/25",
                        "total": 0,
                        "Produção": 0.0,
                        "Engenharia": 0.0,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0
                    },
                    {
                        "month": "11",
                        "data": "11/25",
                        "total": 0,
                        "Produção": 0.0,
                        "Engenharia": 0.0,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0
                    },
                    {
                        "month": "12",
                        "data": "12/25",
                        "total": 0,
                        "Produção": 0.0,
                        "Engenharia": 0.0,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0
                    }
                ]
            }
        };
        
        // Função para obter dados de um ano específico
        function getRealLevantamentoData(year) {
            const yearStr = year.toString();
            if (REAL_LEVANTAMENTO_DATA[yearStr]) {
                return REAL_LEVANTAMENTO_DATA[yearStr].months;
            }
            return null;
        }
        
        // Função para obter anos disponíveis
        function getAvailableYears() {
            return Object.keys(REAL_LEVANTAMENTO_DATA).map(y => parseInt(y)).sort();
        }
        
        async function loadLevByYear(){
            try{
                const sel = document.getElementById('levYearSelect');
                const year = parseInt(sel && sel.value ? sel.value : '2016', 10);
                
                // Tentar usar dados reais primeiro
                const realData = getRealLevantamentoData(year);
                let mockData = [];
                
                if (realData) {
                    // Usar dados reais das planilhas
                    mockData = realData.map(monthData => ({
                        'Data': monthData.data,
                        'Total': monthData.total,
                        'Produção': monthData.Produção,
                        'Engenharia': monthData.Engenharia,
                        'Terceiros': monthData.Terceiros,
                        'Compras': monthData.Compras,
                        'Comercial': monthData.Comercial,
                        'PCP': monthData.PCP,
                        'Expedição': monthData.Expedição,
                        'Qualidade': monthData.Qualidade,
                        'Transporte': monthData.Transporte
                    }));
                    
                    console.log(` Dados reais carregados para ${year}: ${realData.length} meses`);
                } else {
                    // Fallback para dados simulados
                    const months = ['01', '02', '03', '04', '05', '06', '07', '08', '09', '10', '11', '12'];
                    const baseData = {
                        2013: [120, 110, 150, 100, 130, 95, 125, 110, 100, 105, 120, 85],
                        2014: [133, 117, 163, 110, 142, 109, 136, 121, 108, 117, 131, 98],
                        2015: [100, 120, 137, 107, 137, 205, 148, 102, 53, 61, 55, 53]
                    };
                    
                    const counts = baseData[year] || baseData[2014];
                    
                    for(let i = 0; i < 12; i++) {
                        const monthData = {
                            'Data': `${months[i]}/${String(year).slice(-2)}`,
                            'Total': counts[i] || 0
                        };
                        const total = monthData.Total;
                        monthData['Produção'] = Math.floor(total * 0.28);
                        monthData['Engenharia'] = Math.floor(total * 0.18);
                        monthData['Qualidade'] = Math.floor(total * 0.16);
                        monthData['Terceiros'] = Math.floor(total * 0.12);
                        monthData['Compras'] = Math.floor(total * 0.08);
                        monthData['Comercial'] = Math.floor(total * 0.06);
                        monthData['PCP'] = Math.floor(total * 0.05);
                        monthData['Expedição'] = Math.floor(total * 0.04);
                        monthData['Transporte'] = Math.floor(total * 0.03);
                        
                        mockData.push(monthData);
                    }
                    
                    console.log(` Dados simulados carregados para ${year}`);
                }
                
                // Atualizar título da tabela
                const tableTitle = document.getElementById('levTableTitle');
                if (tableTitle) {
                    if (realData) {
                        tableTitle.textContent = ` Tabela ${year} (Dados Reais)`;
                    } else {
                        tableTitle.textContent = ` Tabela ${year} (Dados Simulados)`;
                    }
                }
                
                // Atualizar tabela com dados do ano selecionado
                const rows = mockData.map(obj => [obj['Data'], obj['Produção'], obj['Engenharia'], obj['Terceiros'], obj['Compras'], obj['Comercial'], obj['Cliente'] || 0, obj['PCP'], obj['Expedição'], obj['Qualidade'], obj['Transporte'], obj['Não definido'] || 0, obj['Total']]);
                renderLev1415(rows, [], year);
                
                // Calcular totais e porcentagens por departamento para o ano inteiro
                const departamentos = ['Produção', 'Engenharia', 'Terceiros', 'Compras', 'Comercial', 'Cliente', 'PCP', 'Expedição', 'Qualidade', 'Transporte', 'Não definido'];
                const totaisPorDepartamento = {};
                let grandTotal = 0;
                
                // Inicializar totais
                departamentos.forEach(dept => totaisPorDepartamento[dept] = 0);
                
                // Somar todos os valores por departamento
                mockData.forEach(month => {
                    departamentos.forEach(dept => {
                        const valor = month[dept] || 0;
                        totaisPorDepartamento[dept] += valor;
                    });
                });
                
                // Calcular o grandTotal somando os totais de cada departamento
                grandTotal = departamentos.reduce((sum, dept) => sum + totaisPorDepartamento[dept], 0);
                
                // Calcular porcentagens
                const porcentagens = {};
                departamentos.forEach(dept => {
                    porcentagens[dept] = (totaisPorDepartamento[dept] / grandTotal * 100).toFixed(1);
                });
                
                // Ordenar departamentos por porcentagem (do maior para o menor)
                const departamentosOrdenados = [...departamentos].sort((a, b) => 
                    totaisPorDepartamento[b] - totaisPorDepartamento[a]
                );
                
                // Atualizar título do gráfico de porcentagens
                const percentTitle = document.getElementById('deptPercentTitle');
                if (percentTitle) {
                    const isMonetary = realData && Object.values(totaisPorDepartamento).some(v => v > 1000);
                    const titleText = isMonetary ? 
                        ` Porcentagem de Valores por Departamento - ${year}` : 
                        ` Porcentagem de RNCs por Departamento - ${year}`;
                    percentTitle.textContent = titleText;
                }
                
                // Renderizar gráfico de pizza de porcentagens
                renderDepartmentPercentChart(departamentosOrdenados, totaisPorDepartamento, porcentagens, year, realData, grandTotal);
                
                // Atualizar gráfico Total por Mês
                const labels = mockData.map(o => o['Data']);
                const totals = mockData.map(o => o['Total']);
                const ctx1 = document.getElementById('levTotalMes');
                if (ctx1){
                    if (window._levTotalMesChart) window._levTotalMesChart.destroy();
                    
                    // Cores baseadas no ano
                    const colors = {
                        2013: '#6c757d', 2014: '#0d6efd', 2015: '#198754', 2016: '#fd7e14',
                        2017: '#dc3545', 2018: '#6610f2', 2019: '#20c997', 2020: '#ffc107',
                        2021: '#d63384', 2022: '#6f42c1', 2023: '#e83e8c', 2024: '#17a2b8', 2025: '#28a745'
                    };
                    const color = colors[year] || '#0d6efd';
                    
                    // Determinar tipo de dados (valores ou contagem)
                    const isMonetary = realData && totals.some(t => t > 1000);
                    const dataLabel = isMonetary ? `Total (R$) ${year}` : `Total RNCs ${year}`;
                    const yAxisLabel = isMonetary ? 'Valores (R$)' : 'Quantidade de RNCs';
                    
                    window._levTotalMesChart = new Chart(ctx1.getContext('2d'), { 
                        type:'line', 
                        data:{ 
                            labels, 
                            datasets:[{ 
                                label: dataLabel, 
                                data: totals, 
                                borderColor: color, 
                                backgroundColor: color.replace(')', ',0.1)').replace('rgb', 'rgba'), 
                                tension:.35,
                                pointBackgroundColor: color,
                                pointBorderColor: '#ffffff',
                                pointBorderWidth: 2,
                                pointRadius: 5,
                                pointHoverRadius: 8,
                                fill: true
                            }] 
                        }, 
                        options:{ 
                            responsive: true, 
                            maintainAspectRatio: false,
                            interaction: {
                                intersect: false,
                                mode: 'index'
                            },
                            plugins: {
                                legend: {
                                    display: true,
                                    position: 'top',
                                    labels: {
                                        font: { size: 12, weight: 'bold' },
                                        color: '#333'
                                    }
                                },
                                title: {
                                    display: true,
                                    text: ` ${dataLabel.replace('Total', 'Total por Mês')}`,
                                    color: '#333',
                                    font: { size: 16, weight: 'bold' }
                                },
                                tooltip: {
                                    backgroundColor: 'rgba(0,0,0,0.8)',
                                    titleColor: '#fff',
                                    bodyColor: '#fff',
                                    borderColor: color,
                                    borderWidth: 1,
                                    callbacks: {
                                        label: function(context) {
                                            const value = context.parsed.y;
                                            if (isMonetary) {
                                                return `${context.dataset.label}: R$ ${value.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
                                            } else {
                                                return `${context.dataset.label}: ${value} RNCs`;
                                            }
                                        }
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    grid: { 
                                        color: 'rgba(0,0,0,0.1)',
                                        drawBorder: false
                                    },
                                    title: {
                                        display: true,
                                        text: yAxisLabel,
                                        font: { size: 12, weight: 'bold' }
                                    },
                                    ticks: {
                                        font: { size: 11 },
                                        callback: function(value) {
                                            if (isMonetary) {
                                                return 'R$ ' + value.toLocaleString('pt-BR');
                                            } else {
                                                return value;
                                            }
                                        }
                                    }
                                },
                                x: {
                                    grid: { 
                                        color: 'rgba(0,0,0,0.1)',
                                        drawBorder: false
                                    },
                                    title: {
                                        display: true,
                                        text: 'Mês/Ano',
                                        font: { size: 12, weight: 'bold' }
                                    },
                                    ticks: {
                                        font: { size: 11 }
                                    }
                                }
                            }
                        } 
                    });
                }
                
                // Atualizar gráfico por departamento do último mês com dados não zero
                const last = mockData.slice().reverse().find(r => (r && r['Total'] > 0)) || mockData[mockData.length - 1] || {};
                const depts = ['Produção','Engenharia','Terceiros','Compras','Comercial','PCP','Expedição','Qualidade','Transporte'];
                const ctx2 = document.getElementById('levPorDept');
                if (ctx2){
                    if (window._levPorDeptChart) window._levPorDeptChart.destroy();
                    
                    const isMonetary = realData && Object.values(last).some(v => typeof v === 'number' && v > 1000);
                    const deptLabel = isMonetary ? `Valores por Departamento (${last['Data']||''})` : `RNCs por Departamento (${last['Data']||''})`;
                    const yAxisLabel = isMonetary ? 'Valores (R$)' : 'Quantidade de RNCs';
                    
                    window._levPorDeptChart = new Chart(ctx2.getContext('2d'), { 
                        type:'bar', 
                        data:{ 
                            labels: depts, 
                            datasets:[{ 
                                label: deptLabel, 
                                data: depts.map(d => last[d]||0), 
                                backgroundColor:[
                                    'rgba(13,110,253,0.8)',
                                    'rgba(102,16,242,0.8)', 
                                    'rgba(111,66,193,0.8)',
                                    'rgba(214,51,132,0.8)',
                                    'rgba(220,53,69,0.8)',
                                    'rgba(253,126,20,0.8)',
                                    'rgba(255,193,7,0.8)',
                                    'rgba(25,135,84,0.8)',
                                    'rgba(32,201,151,0.8)'
                                ],
                                borderColor:[
                                    '#0d6efd','#6610f2','#6f42c1','#d63384','#dc3545','#fd7e14','#ffc107','#198754','#20c997'
                                ],
                                borderWidth: 2,
                                borderRadius: 4,
                                borderSkipped: false
                            }] 
                        }, 
                        options:{ 
                            responsive: true, 
                            maintainAspectRatio: false,
                            interaction: {
                                intersect: false,
                                mode: 'index'
                            },
                            plugins: {
                                legend: {
                                    display: true,
                                    position: 'top',
                                    labels: {
                                        font: { size: 12, weight: 'bold' },
                                        color: '#333'
                                    }
                                },
                                title: {
                                    display: true,
                                    text: ` ${deptLabel}`,
                                    color: '#333',
                                    font: { size: 16, weight: 'bold' }
                                },
                                tooltip: {
                                    backgroundColor: 'rgba(0,0,0,0.8)',
                                    titleColor: '#fff',
                                    bodyColor: '#fff',
                                    borderWidth: 1,
                                    callbacks: {
                                        label: function(context) {
                                            const value = context.parsed.y;
                                            if (isMonetary) {
                                                return `${context.dataset.label.split(' ')[0]}: R$ ${value.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
                                            } else {
                                                return `${context.dataset.label.split(' ')[0]}: ${value} RNCs`;
                                            }
                                        }
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    grid: { 
                                        color: 'rgba(0,0,0,0.1)',
                                        drawBorder: false
                                    },
                                    title: {
                                        display: true,
                                        text: yAxisLabel,
                                        font: { size: 12, weight: 'bold' }
                                    },
                                    ticks: {
                                        font: { size: 11 },
                                        callback: function(value) {
                                            if (isMonetary) {
                                                return 'R$ ' + value.toLocaleString('pt-BR');
                                            } else {
                                                return value;
                                            }
                                        }
                                    }
                                },
                                x: {
                                    grid: { 
                                        display: false
                                    },
                                    title: {
                                        display: true,
                                        text: 'Departamentos',
                                        font: { size: 12, weight: 'bold' }
                                    },
                                    ticks: {
                                        font: { size: 10 },
                                        maxRotation: 45,
                                        minRotation: 0
                                    }
                                }
                            }
                        } 
                    });
                }
            }catch(e){ console.error('Erro loadLevByYear:', e); }
        }
        function exportLev1415CSV() {
            const toCSV = (rows) => [LEV1415_HEADER.join(';')].concat(rows.map(r => r.join(';'))).join('\n');
            const csv = `2014\n${toCSV(LEV1415_ROWS)}\n\n2015\n${toCSV(LEV1515_ROWS)}`;
            const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = 'levantamento_2014_2015.csv'; a.click(); URL.revokeObjectURL(url);
        }
        function exportLevInfo() {
            const text = levInfoText || '';
            const blob = new Blob([text], { type: 'text/plain;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = 'informacoes_levantamento_14_15.txt';
            document.body.appendChild(a); a.click(); document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        // ================== FUNÇÕES GRÁFICOS ENGENHARIA (fallback se não definidas) ==================
        if (typeof buildEngineeringCharts === 'undefined') {
            var engMonthlyChartInstance = null;
            var engAccumChartInstance = null;
            function buildEngineeringCharts(apiData){
                try {
                    console.log(' [DEBUG] buildEngineeringCharts chamado com:', apiData);
                    console.log(' [DEBUG] currentTab:', currentTab);
                    
                    // CORRIGIDO: Usar container de setores que existe no HTML
                    const container = document.getElementById('setoresCharts');
                    if (!container) {
                        console.log(' Container setoresCharts não encontrado, gráficos não serão exibidos');
                        return;
                    }
                    
                    // Exibir container apenas se estivermos na aba de setores ou se houver um setor selecionado
                    const setorSelectEl = document.getElementById('setorSelect');
                    const setorSelected = setorSelectEl && setorSelectEl.value;
                    if (window.currentTab === 'setores' || setorSelected) {
                        container.style.display = 'block';
                        console.log(' Container de gráficos encontrado e exibido');
                    } else {
                        console.log(' Dados de engenharia recebidos mas container de setores permanecerá oculto (não estamos na aba setores)');
                    }
                    
                    console.log(' Construindo gráficos da engenharia com dados da API:', apiData);
                    
                    // Verificar se temos dados da API ou dados RNC tradicional
                    if (apiData && apiData.monthly_trend && apiData.stats) {
                        // Usar dados da API específica
                        console.log(' Usando dados estruturados da API');
                        const { monthly_trend, stats } = apiData;
                        
                        const months = monthly_trend.map(item => item.month);
                        const shortNames = ['JAN','FEV','MAR','ABR','MAI','JUN','JUL','AGO','SET','OUT','NOV','DEZ'];
                        const labels = monthly_trend.map(item => {
                            const [year, month] = item.month.split('-');
                            return shortNames[parseInt(month)-1] + '/' + year.slice(-2);
                        });
                        const values = monthly_trend.map(item => item.count);
                        const cumulative = monthly_trend.map(item => item.accumulated_count);
                        
                        // Informações estatísticas
                        const totalCount = stats.total_rncs || 0;
                        const finalizedCount = stats.finalized_rncs || 0;
                        const totalValue = stats.total_value || 0;
                        
                        console.log(` Total RNCs: ${totalCount}, Finalizadas: ${finalizedCount}, Valor Total: R$ ${totalValue.toLocaleString()}`);
                        
                        const goal = 30; 
                        const goalArr = values.map(() => goal);
                        
                        // Popular select de meses se ainda não
                        const sel = document.getElementById('engineeringMonthSelect');
                        if (sel && sel.options.length <= 1) {
                            months.forEach((m,idx) => {
                                const opt = document.createElement('option');
                                opt.value = m; 
                                opt.textContent = labels[idx];
                                sel.appendChild(opt);
                            });
                        }
                        
                        // Guardar dataset para filtros
                        window._engDataCache = { months, labels, values, cumulative, goal, goalArr };
                        
                        // Sanitizar dados para prevenir Infinity/NaN
                        const sanitizeValues = values.map(v => {
                            const num = Number(v);
                            return (isFinite(num) && !isNaN(num)) ? Math.max(0, num) : 0;
                        });
                        const sanitizeCumulative = cumulative.map(v => {
                            const num = Number(v);
                            return (isFinite(num) && !isNaN(num)) ? Math.max(0, num) : 0;
                        });
                        const sanitizeGoalArr = goalArr.map(v => {
                            const num = Number(v);
                            return (isFinite(num) && !isNaN(num)) ? Math.max(0, num) : 0;
                        });
                        
                        // Calcular escalas máximas inteligentes
                        const allValuesY = [...sanitizeValues, ...sanitizeGoalArr].filter(v => v > 0);
                        const maxValueY = allValuesY.length > 0 ? Math.max(...allValuesY) : 50;
                        const suggestedMaxY = Math.ceil(maxValueY * 1.15);
                        
                        const allValuesY2 = sanitizeCumulative.filter(v => v > 0);
                        const maxValueY2 = allValuesY2.length > 0 ? Math.max(...allValuesY2) : 100;
                        const suggestedMaxY2 = Math.ceil(maxValueY2 * 1.15);
                        
                        // Gráfico mensal - CORRIGIDO: usar canvas que existe
                        const c1 = document.getElementById('setorMonthlyChart');
                        console.log(' [DEBUG] Canvas setorMonthlyChart:', c1);
                        if (c1) {
                            console.log(' Canvas encontrado, criando gráfico mensal...');
                            // Definir altura fixa para evitar gráfico gigante
                            c1.style.height = '170px';
                            c1.style.maxHeight = '170px';
                            c1.parentElement.style.height = '170px';
                            c1.parentElement.style.maxHeight = '170px';
                            if (engMonthlyChartInstance) {
                                console.log(' Destruindo gráfico anterior...');
                                engMonthlyChartInstance.destroy();
                            }
                            engMonthlyChartInstance = new Chart(c1.getContext('2d'), {
                                type:'bar',
                                data:{ 
                                    labels, 
                                    datasets:[
                                        { 
                                            label:'RNCs Finalizadas', 
                                            data:sanitizeValues, 
                                            backgroundColor:'#2b6cb0', 
                                            borderRadius:4 
                                        },
                                        { 
                                            label:'Meta 30', 
                                            data:sanitizeGoalArr, 
                                            type:'line', 
                                            borderColor:'#28a745', 
                                            borderWidth:2, 
                                            pointRadius:0, 
                                            tension:0, 
                                            fill:false 
                                        },
                                        { 
                                            label:'Acumulado', 
                                            data:sanitizeCumulative, 
                                            type:'line', 
                                            borderColor:'#0d6efd', 
                                            backgroundColor:'rgba(13,110,253,0.15)', 
                                            borderWidth:2, 
                                            tension:.25, 
                                            yAxisID:'y2' 
                                        }
                                    ]
                                },
                                options:{ 
                                    responsive:true, 
                                    maintainAspectRatio:false,
                                    interaction:{mode:'index', intersect:false}, 
                                    stacked:false,
                                    scales:{ 
                                        y:{ 
                                            beginAtZero:true, 
                                            suggestedMax: suggestedMaxY,
                                            title:{display:true,text:'RNCs / Meta'},
                                            ticks: {
                                                callback: function(value) {
                                                    return isFinite(value) ? value : 0;
                                                }
                                            }
                                        }, 
                                        y2:{ 
                                            beginAtZero:true, 
                                            suggestedMax: suggestedMaxY2,
                                            position:'right', 
                                            grid:{drawOnChartArea:false}, 
                                            title:{display:true,text:'Acumulado'},
                                            ticks: {
                                                callback: function(value) {
                                                    return isFinite(value) ? value : 0;
                                                }
                                            }
                                        } 
                                    },
                                    plugins:{ 
                                        legend:{ position:'top' },
                                        tooltip: {
                                            callbacks: {
                                                label: function(context) {
                                                    const value = context.parsed.y;
                                                    return `${context.dataset.label}: ${isFinite(value) ? value : 0}`;
                                                }
                                            }
                                        }
                                    }
                                }
                            });
                        }
                        
                        // Gráfico acumulado - ÚLTIMOS 12 MESES
                        // CORRIGIDO: Mostrar apenas últimos 12 meses para evitar valores gigantes
                        const last12Months = monthly_trend.slice(-12);
                        
                        // Recalcular acumulado começando do zero para os últimos 12 meses
                        let accumCount = 0;
                        const last12Data = last12Months.map((item, idx) => {
                            accumCount += item.count;
                            return {
                                year: item.month.split('-')[0],
                                month: item.month,
                                count: item.count,
                                accumulated: accumCount
                            };
                        });
                        
                        // Agrupar por ano (dos últimos 12 meses)
                        const byYear = {};
                        last12Data.forEach(item => {
                            if (!byYear[item.year]) {
                                byYear[item.year] = {
                                    count: 0,
                                    accumulated: 0
                                };
                            }
                            byYear[item.year].count += item.count;
                            byYear[item.year].accumulated = item.accumulated; // último valor do ano
                        });
                        
                        const years = Object.keys(byYear).sort();
                        const yearCumulative = years.map(y => byYear[y].accumulated);
                        
                        // Meta acumulada para os últimos 12 meses
                        const yearGoalAccum = years.map((y, idx) => {
                            // Contar quantos meses temos até este ano (nos últimos 12 meses)
                            let monthsUntilYear = 0;
                            for (let i = 0; i <= idx; i++) {
                                const yearKey = years[i];
                                monthsUntilYear += last12Data.filter(d => d.year === yearKey).length;
                            }
                            return monthsUntilYear * goal;
                        });
                        
                        // Sanitizar dados acumulados anuais
                        const sanitizeYearCumulative = yearCumulative.map(v => {
                            const num = Number(v);
                            return (isFinite(num) && !isNaN(num)) ? Math.max(0, num) : 0;
                        });
                        const sanitizeYearGoalAccum = yearGoalAccum.map(v => {
                            const num = Number(v);
                            return (isFinite(num) && !isNaN(num)) ? Math.max(0, num) : 0;
                        });
                        
                        // Calcular escala máxima para gráfico anual
                        const allYearValues = [...sanitizeYearCumulative, ...sanitizeYearGoalAccum].filter(v => v > 0);
                        const maxYearValue = allYearValues.length > 0 ? Math.max(...allYearValues) : 100;
                        const suggestedMaxYear = Math.ceil(maxYearValue * 1.15);
                        
                        // Gráfico acumulado - CORRIGIDO: usar canvas que existe
                        const c2 = document.getElementById('setorAccumChart');
                        console.log(' [DEBUG] Canvas setorAccumChart:', c2);
                        if (c2){
                            console.log(' Canvas acumulado encontrado, criando gráfico...');
                            // Definir altura fixa para evitar gráfico gigante
                            c2.style.height = '170px';
                            c2.style.maxHeight = '170px';
                            c2.parentElement.style.height = '170px';
                            c2.parentElement.style.maxHeight = '170px';
                            if (engAccumChartInstance) {
                                console.log(' Destruindo gráfico acumulado anterior...');
                                engAccumChartInstance.destroy();
                            }
                            engAccumChartInstance = new Chart(c2.getContext('2d'), {
                                type:'line',
                                data:{ 
                                    labels: years, 
                                    datasets:[
                                        { 
                                            label:'Acumulado (Ano)', 
                                            data:sanitizeYearCumulative, 
                                            borderColor:'#0d6efd', 
                                            backgroundColor:'rgba(13,110,253,0.15)', 
                                            borderWidth:3, 
                                            tension:.25, 
                                            fill:true 
                                        },
                                        { 
                                            label:'Meta Acum. (Ano)', 
                                            data:sanitizeYearGoalAccum, 
                                            borderColor:'#28a745', 
                                            borderDash:[6,4], 
                                            borderWidth:2, 
                                            pointRadius:0, 
                                            tension:0, 
                                            fill:false 
                                        }
                                    ]
                                },
                                options:{ 
                                    responsive:true, 
                                    maintainAspectRatio:false,
                                    scales:{ 
                                        y:{ 
                                            beginAtZero:true,
                                            suggestedMax: suggestedMaxYear,
                                            ticks: {
                                                callback: function(value) {
                                                    return isFinite(value) ? value : 0;
                                                }
                                            }
                                        } 
                                    }, 
                                    plugins:{ 
                                        legend:{ position:'top' },
                                        tooltip: {
                                            callbacks: {
                                                label: function(context) {
                                                    const value = context.parsed.y;
                                                    return `${context.dataset.label}: ${isFinite(value) ? value : 0}`;
                                                }
                                            }
                                        }
                                    } 
                                }
                            });
                            console.log(' Gráfico acumulado criado com sucesso!');
                        }
                        
                        console.log(' Gráficos de Engenharia construídos com sucesso!');
                        
                    } else {
                        // Fallback para dados RNC tradicionais (se apiData for array de RNCs)
                        console.log(' Usando dados RNC tradicionais como fallback');
                        const rncs = Array.isArray(apiData) ? apiData : [];
                        
                        const byMonth = {};
                        rncs.forEach(r => {
                            const raw = r.finalized_at;
                            if(!raw) return; 
                            const d = new Date(raw); 
                            if(isNaN(d)) return;
                            const k = d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0');
                            byMonth[k] = (byMonth[k]||0)+1;
                        });
                        
                        const months = Object.keys(byMonth).sort();
                        if (!months.length) {
                            console.warn(' Nenhum dado de engenharia encontrado');
                            return;
                        }
                        
                        const shortNames = ['JAN','FEV','MAR','ABR','MAI','JUN','JUL','AGO','SET','OUT','NOV','DEZ'];
                        const labels = months.map(m=> shortNames[parseInt(m.split('-')[1])-1]);
                        const values = months.map(m=> byMonth[m]);
                        const cumulative = values.reduce((a,v,i)=>{ a.push((a[i-1]||0)+v); return a; },[]);
                        const goal = 30; 
                        const goalArr = values.map(()=>goal);
                        
                        window._engDataCache = { months, labels, values, cumulative, goal, goalArr };
                        
                        // Construir gráficos com dados tradicionais
                        const c1 = document.getElementById('engineeringMonthlyChart');
                        if (c1) {
                            if (engMonthlyChartInstance) engMonthlyChartInstance.destroy();
                            engMonthlyChartInstance = new Chart(c1.getContext('2d'), {
                                type:'bar',
                                data:{ labels, datasets:[
                                    { label:'Realizado', data:values, backgroundColor:'#2b6cb0', borderRadius:4 },
                                    { label:'Meta 30', data:goalArr, type:'line', borderColor:'#28a745', borderWidth:2, pointRadius:0, tension:0, fill:false }
                                ]},
                                options:{ responsive:true, scales:{ y:{ beginAtZero:true } }, plugins:{ legend:{ position:'top' } } }
                            });
                        }
                    }
                    
                    updateEngineeringMonthInfo();
                } catch(e){ 
                    console.error(' Erro ao construir gráficos da engenharia:', e); 
                }
            }
            function updateEngineeringMonth(){
                if(!window._engDataCache) return; const sel=document.getElementById('engineeringMonthSelect'); if(!sel) return;
                const { months, labels, values, cumulative, goal, goalArr, goalAccum } = window._engDataCache;
                const monthKey = sel.value;
                // Reset
                if(!monthKey){ 
                    if (currentTab === 'engenharia') {
                        {% if user_permissions.canViewEngineeringRncs %}
                        buildEngineeringCharts((rncsData && rncsData.engenharia)||[]);
                        {% endif %} 
                    }
                    return; 
                }
                const idx=months.indexOf(monthKey); if(idx===-1) return;
                // Recolor monthly chart (keep all months for contexto)
                if(engMonthlyChartInstance){
                    engMonthlyChartInstance.data.datasets[0].backgroundColor = values.map((_,i)=> i===idx ? '#1f5b96' : 'rgba(43,108,176,0.25)');
                    engMonthlyChartInstance.update();
                }
                // Não alteramos mais o gráfico acumulado anual ao selecionar o mês; foco apenas em destacar o mês no gráfico mensal.
                // Daily detail chart with cumulative inside month
                const c3=document.getElementById('engineeringMonthDetailChart');
                if(c3){
                    // Filter month RNCs
                    let monthRncs = [];
                    {% if user_permissions.canViewEngineeringRncs %}
                    monthRncs = (rncsData.engenharia||[]).filter(r=>{ const raw=r.finalized_at||r.created_at||r.updated_at; if(!raw) return false; const d=new Date(raw); if(isNaN(d)) return false; const key=d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0'); return key===monthKey; });
                    {% endif %}
                    const byDay={}; monthRncs.forEach(r=>{ const d=new Date(r.finalized_at||r.created_at||r.updated_at); const day=String(d.getDate()).padStart(2,'0'); byDay[day]=(byDay[day]||0)+1; });
                    const days=Object.keys(byDay).sort((a,b)=>parseInt(a)-parseInt(b));
                    const dayValues=days.map(d=>byDay[d]);
                    const dayCumulative=dayValues.reduce((a,v,i)=>{ a.push((a[i-1]||0)+v); return a; },[]);
                    if(window._engDetailChart) window._engDetailChart.destroy();
                    window._engDetailChart = new Chart(c3.getContext('2d'), {
                        type:'bar',
                        data:{ labels:days, datasets:[
                            { label:'RNCs (Dia)', data:dayValues, backgroundColor:'rgba(43,108,176,0.65)', borderRadius:3 },
                            { label:'Acum. Mês', data:dayCumulative, type:'line', borderColor:'#0d6efd', borderWidth:2, tension:.25, pointRadius:2, fill:false }
                        ]},
                        options:{ responsive:true, interaction:{mode:'index', intersect:false}, plugins:{ legend:{ position:'top' }, tooltip:{ callbacks:{ label(ctx){ return ctx.dataset.label+': '+ctx.formattedValue; } } } }, scales:{ y:{ beginAtZero:true } } }
                    });
                }
                updateEngineeringMonthInfo(idx);
            }
            function resetEngineeringSelection(){
                const sel=document.getElementById('engineeringMonthSelect'); if(sel) sel.value='';
                if(window._engDataCache && currentTab === 'engenharia'){
                    {% if user_permissions.canViewEngineeringRncs %}
                    buildEngineeringCharts((rncsData && rncsData.engenharia)||[]);
                    {% endif %}
                }
            }
            function updateEngineeringMonthInfo(idx){
                const box = document.getElementById('engineeringMonthInfo'); if(!box || !window._engDataCache) return;
                const { months, labels, values, cumulative, goal, goalArr, goalAccum } = window._engDataCache;
                if(typeof idx==='number'){ 
                    const pct = ((values[idx]/goal)*100).toFixed(1);
                    const variacao = values[idx]-goal; // positivo se acima da meta
                    box.innerHTML = `<strong>Mês:</strong> ${labels[idx]} (${months[idx]}) • <strong>Realizado:</strong> ${values[idx]} • Meta: ${goal} • Cumprimento: ${pct}% • Acumulado: ${cumulative[idx]} / Meta Acum.: ${goalAccum[idx]}`;
                    const rv=document.getElementById('engInfoRealizadoVal'); if(rv) rv.textContent=values[idx];
                    const vv=document.getElementById('engInfoVariacaoVal'); if(vv) vv.textContent= (variacao>=0? '+' : '') + variacao;
                } else {
                    const total = cumulative[cumulative.length-1];
                    const metaTotal = goalAccum[goalAccum.length-1];
                    const pctTotal = ((total/metaTotal)*100).toFixed(1);
                    box.innerHTML = `<strong>Visão Geral:</strong> ${months.length} meses • Total: ${total} • Meta Total: ${metaTotal} • Cumprimento: ${pctTotal}%`;
                    const rv=document.getElementById('engInfoRealizadoVal'); if(rv) rv.textContent=total;
                    const vv=document.getElementById('engInfoVariacaoVal'); if(vv) vv.textContent= ((total-metaTotal)>=0?'+':'') + (total-metaTotal);
                }
            }
        }
        
        // ================== FUNÇÕES PARA GRÁFICOS POR SETOR ==================
        // REMOVIDO: variáveis locais, agora usando window.setorMonthlyChart e window.setorAccumChart
        let setorMonthDetailChart = null;
        
        // Função para carregar dados padrão (engenharia) quando nenhum setor está selecionado
        async function loadDefaultSectorChart() {
            try {
                console.log(' Carregando gráfico padrão (engenharia)...');
                
                // Verificar se Chart.js está carregado
                if (typeof Chart === 'undefined') {
                    console.error('Chart.js não carregado! Aguardando...');
                    setTimeout(loadDefaultSectorChart, 500);
                    return;
                }
                
                // Destruir gráficos anteriores ANTES de carregar novos
                destroyAllSetorCharts();
                
                // Mostrar container de gráficos somente se estamos na aba 'setores' ou se um setor foi selecionado
                const chartsContainer = document.getElementById('setorChartsContainer');
                const setorSelect = document.getElementById('setorSelect');
                const setorSelected = setorSelect && setorSelect.value;
                if (chartsContainer) {
                    if (window.currentTab === 'setores' || setorSelected) {
                        chartsContainer.style.display = 'block';
                        console.log(' Container de gráficos exibido');
                    } else {
                        // Manter oculto por padrão ao inicializar o dashboard
                        console.log(' Container de gráficos permanece oculto (inicialização)');
                    }
                }
                
                const response = await fetch('/api/indicadores/engenharia');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                console.log(' Dados recebidos da API:', data);
                
                if (data.success && data.rncs && data.rncs.length > 0) {
                    console.log(' Dados carregados:', data.rncs.length, 'RNCs');
                    
                    // Se monthly_trend estiver vazio mas temos RNCs, processar manualmente
                    if (!data.monthly_trend || data.monthly_trend.length === 0) {
                        console.log(' Processando monthly_trend a partir das RNCs...');
                        console.log(' Amostra da primeira RNC:', data.rncs[0]);
                        
                        const monthlyData = {};
                        data.rncs.forEach(rnc => {
                            // Tentar diferentes campos de data
                            const dateField = rnc.data_abertura || rnc.date || rnc.created_at || rnc.data_criacao;
                            if (dateField) {
                                const month = dateField.substring(0, 7);
                                monthlyData[month] = (monthlyData[month] || 0) + 1;
                            }
                        });
                        
                        data.monthly_trend = Object.keys(monthlyData).sort().map(month => ({
                            month: month,
                            count: monthlyData[month]
                        }));
                        
                        console.log(' monthly_trend gerado com', data.monthly_trend.length, 'meses');
                        console.log(' monthly_trend:', data.monthly_trend);
                    }
                    
                    console.log(' Total de meses:', data.monthly_trend?.length || 0);
                    console.log(' Total de RNCs:', data.stats?.total_rncs || data.rncs.length);
                    console.log(' monthly_trend final:', data.monthly_trend);
                    
                    // Atualizar título
                    const titleEl = document.getElementById('setorTitle');
                    if (titleEl) {
                        titleEl.textContent = ' Engenharia – RNCs Mensais (Padrão)';
                    }
                    
                    // Aguardar o DOM renderizar
                    await new Promise(resolve => setTimeout(resolve, 100));
                    
                    console.log('Verificando elementos do DOM...');
                    const checkCanvas = ['setorMonthlyChart', 'setorAccumChart', 'setorStatusChart'];
                    checkCanvas.forEach(function(id) {
                        const el = document.getElementById(id);
                        console.log(`  - ${id}: ${el ? 'encontrado' : 'NÃO ENCONTRADO'}`);
                    });
                    
                    // Construir gráficos
                    buildSetorCharts(data, 'engenharia');
                    
                    console.log(' Gráficos construídos!');
                    
                } else {
                    console.warn(' Sem dados disponíveis');
                    console.warn('Data received:', data);
                    // Tentativa fallback: buscar todas as RNCs finalizadas diretamente do endpoint de listagem
                    try {
                        console.log(' Tentando fallback: buscando RNCs finalizadas via /api/rnc/list?tab=finalized');
                        const fallback = await fetch(`/api/rnc/list?tab=finalized&limit=5000`);
                        if (fallback && fallback.ok) {
                            const fb = await fallback.json();
                            if (fb && Array.isArray(fb.rncs) && fb.rncs.length) {
                                const fallbackData = { success: true, rncs: fb.rncs, monthly_trend: [], stats: { total_rncs: fb.rncs.length } };
                                window._setorDataCache = Object.assign({}, fallbackData, { setor: 'engenharia' });
                                console.log(' Fallback RNCs finalizadas carregadas:', fb.rncs.length);
                                try { setupSetorFiltersAndRender(fallbackData); }
                                catch(err) { console.error('Erro ao configurar filtros com fallback:', err); buildSetorSingleChart(); }
                                return;
                            }
                        }
                        console.warn(' Fallback não encontrou RNCs finalizadas ou falhou.');
                    } catch(fbErr) {
                        console.error(' Erro no fallback de finalizados:', fbErr);
                    }
                }
            } catch (error) {
                console.error(' Erro ao carregar gráfico padrão:', error);
                console.error('Stack:', error.stack);
            }
        }
        
        // Mapeamento de nome do setor para exibição
        const setorNames = {
            'engenharia': 'Engenharia',
            'producao': 'Produção',
            'pcp': 'PCP',
            'qualidade': 'Qualidade',
            'compras': 'Compras',
            'comercial': 'Comercial',
            'terceiros': 'Terceiros',
            'usinagem_plana': 'Usinagem Plana',
            'usin_cilindrica_cnc': 'Usin. Cilíndrica CNC',
            'usin_cilindrica_convencional': 'Usin. Cilíndrica Convencional',
            'caldeiraria_carbono': 'Caldeiraria de Carbono',
            'caldeiraria_inox': 'Caldeiraria de Inox',
            'corte': 'Corte',
            'montagem': 'Montagem',
            'pintura': 'Pintura',
            'balanceamento': 'Balanceamento'
        };
        
        // Mapeamento de metas por setor
        const setorMetas = {
            'engenharia': 30,
            'producao': 50,
            'pcp': 20,
            'qualidade': 15,
            'compras': 10,
            'comercial': 10,
            'terceiros': 25,
            'usinagem_plana': 20,
            'usin_cilindrica_cnc': 15,
            'usin_cilindrica_convencional': 20,
            'caldeiraria_carbono': 5,
            'caldeiraria_inox': 2,
            'corte': 3,
            'montagem': 2,
            'pintura': 1,
            'balanceamento': 1
        };
        
        async function loadSetorData() {
            const select = document.getElementById('setorSelect');
            const setor = select ? select.value : '';
            
            if (!setor) {
                console.log(' Nenhum setor selecionado');
                
                // Destruir gráficos antes de ocultar
                destroyAllSetorCharts();
                
                document.getElementById('setorIndicadorInfo').style.display = 'none';
                document.getElementById('setorChartsContainer').style.display = 'none';
                // Carregar dados de engenharia como padrão
                await loadDefaultSectorChart();
                return;
            }
            
            // Verificar se Chart.js está carregado
            if (typeof Chart === 'undefined') {
                console.error('Chart.js não carregado! Aguardando...');
                setTimeout(loadSetorData, 500);
                return;
            }
            
            console.log(` Carregando dados do setor: ${setor}`);
            
            // Mostrar indicador de carregamento
            const chartsContainer = document.getElementById('setorChartsContainer');
            if (chartsContainer) {
                chartsContainer.style.display = 'block';
                if (!chartsContainer.dataset.original) {
                    chartsContainer.dataset.original = chartsContainer.innerHTML;
                }
                chartsContainer.innerHTML = `
                    <div style="background:#fff; border-radius:12px; padding:40px; text-align:center; box-shadow:0 2px 15px rgba(0,0,0,0.1);">
                        <div style="font-size:48px; margin-bottom:16px;"></div>
                        <div style="font-size:18px; color:#333; font-weight:600; margin-bottom:8px;">Carregando dados...</div>
                        <div style="font-size:14px; color:#666;">Processando RNCs do setor ${setorNames[setor] || setor}</div>
                        <div style="margin-top:20px;">
                            <div style="width:200px; height:4px; background:#f0f0f0; border-radius:2px; margin:0 auto; overflow:hidden;">
                                <div style="width:100%; height:100%; background:linear-gradient(90deg, #667eea, #764ba2); animation:loading 1.5s ease-in-out infinite;"></div>
                            </div>
                        </div>
                    </div>
                    <style>
                        @keyframes loading {
                            0% { transform: translateX(-100%); }
                            100% { transform: translateX(100%); }
                        }
                    </style>
                `;
            }
            
            // CRÍTICO: Destruir TODOS os gráficos anteriores
            console.log(' Limpando cache e gráficos anteriores...');
            destroyAllSetorCharts();
            window._setorDataCache = null;
            
            try {
                // Buscar dados do setor (usar a mesma API de engenharia como base)
                let apiEndpoint = '';
                if (setor === 'engenharia') {
                    apiEndpoint = '/api/indicadores/engenharia';
                } else {
                    // Para outros setores, usar a API genérica com filtro
                    apiEndpoint = `/api/indicadores/setor?setor=${setor}`;
                }
                
                console.log(` Buscando dados em: ${apiEndpoint}`);
                const response = await fetch(apiEndpoint);
                console.log(` Response status: ${response.status}`);
                const data = await response.json();
                console.log(` Dados recebidos:`, data);
                
                if (data.success) {
                    console.log(` Dados do setor ${setor} carregados:`, data);
                    
                    // Atualizar informações do indicador com verificação de null
                    const setorNomeEl = document.getElementById('setorNome');
                    const setorMetaEl = document.getElementById('setorMeta');
                    const setorIndicadorInfoEl = document.getElementById('setorIndicadorInfo');
                    const setorTitleEl = document.getElementById('setorTitle');
                    const setorChartsContainerEl = document.getElementById('setorChartsContainer');
                    
                    if (setorNomeEl) setorNomeEl.textContent = setorNames[setor] || setor;
                    if (setorMetaEl) setorMetaEl.textContent = setorMetas[setor] || 30;
                    if (setorIndicadorInfoEl) setorIndicadorInfoEl.style.display = 'flex';
                    
                    // Atualizar título
                    const icon = document.querySelector(`#setorSelect option[value="${setor}"]`)?.text?.split(' ')[0] || '';
                    if (setorTitleEl) setorTitleEl.textContent = `${icon} ${setorNames[setor] || setor} – RNCs Mensais`;
                    
                    // Mostrar container de gráficos ANTES de construir os gráficos
                    if (setorChartsContainerEl) {
                        if (setorChartsContainerEl.dataset.original) {
                            setorChartsContainerEl.innerHTML = setorChartsContainerEl.dataset.original;
                        }
                        setorChartsContainerEl.style.display = 'block';
                        console.log('Container de gráficos exibido. Display:', setorChartsContainerEl.style.display);
                    }
                    
                    // Armazenar cache para filtros cliente
                    window._setorDataCache = Object.assign({}, data, { setor: setor });
                    console.log('Cache de dados do setor armazenado (rncs count=', (data.rncs||[]).length, ')');

                    // Se não vierem RNCs nesta resposta, tentar fallback para listar RNCs finalizadas
                    if (!Array.isArray(data.rncs) || data.rncs.length === 0) {
                        try {
                            console.log(' Nenhuma RNC presente na resposta do indicador, tentando buscar /api/rnc/list?tab=finalized');
                            const fallbackResp = await fetch(`/api/rnc/list?tab=finalized&limit=5000`);
                            if (fallbackResp && fallbackResp.ok) {
                                const fbData = await fallbackResp.json();
                                if (fbData && Array.isArray(fbData.rncs) && fbData.rncs.length) {
                                    // Atualizar cache e usar fallback
                                    window._setorDataCache.rncs = fbData.rncs;
                                    console.log(' Fallback para RNCs finalizadas obteve', fbData.rncs.length);
                                    setTimeout(() => {
                                        try { setupSetorFiltersAndRender(window._setorDataCache); }
                                        catch(err) { console.error('Erro ao configurar filtros com fallback:', err); buildSetorSingleChart(); }
                                    }, 120);
                                    return;
                                }
                            }
                            console.warn(' Fallback não retornou RNCs finalizadas');
                        } catch(fbErr) {
                            console.error(' Erro ao executar fallback de finalizados:', fbErr);
                        }
                    }

                    // configurar filtros e renderizar gráfico inicial com dados reais
                    setTimeout(() => {
                        try {
                            setupSetorFiltersAndRender(data);
                            console.log('Filtros configurados e gráfico inicial renderizado.');
                        } catch (err) {
                            console.error('Erro ao configurar filtros ou renderizar:', err);
                            // fallback visual
                            buildSetorSingleChart();
                        }
                    }, 100);
                } else {
                    console.error(' Erro ao carregar dados do setor:', data.message);
                    const setorChartsContainerEl = document.getElementById('setorChartsContainer');
                    if (setorChartsContainerEl && setorChartsContainerEl.dataset.original) {
                        setorChartsContainerEl.innerHTML = setorChartsContainerEl.dataset.original;
                    }
                    alert(`Erro ao carregar dados: ${data.message}`);
                }
            } catch (error) {
                console.error(' Erro ao buscar dados do setor:', error);
                const chartsContainer = document.getElementById('setorChartsContainer');
                if (chartsContainer && chartsContainer.dataset.original) {
                    chartsContainer.innerHTML = chartsContainer.dataset.original;
                }
                alert('Erro ao carregar dados do setor. Tente novamente.');
            }
        }
        
        // Função stub: destruir gráficos de setor (no-op)
        function destroyAllSetorCharts() {
            // Intencionalmente vazio — gráficos de setor foram removidos do DOM.
            console.log(' destroyAllSetorCharts chamado (no-op): gráficos de setor desativados.');
            try {
                // limpar referências conhecidas caso ainda existam
                ['setorMonthlyChart','setorAccumChart','setorComparisonChart','setorPieChart','setorEfficiencyChart','setorPriorityChart','setorValueChart','setorClientChart','setorEquipmentChart','setorHeatmapChart','setorMonthDetailChart'].forEach(function(k){ if(window[k]){ try{ window[k].destroy && window[k].destroy(); }catch(e){}; window[k]=null; }});
            } catch(e) {}
        }
        
        // Função stub: construir gráficos de setor (no-op)
        function buildSetorCharts(apiData, setor) {
            console.log(' buildSetorCharts chamado para setor:', setor);
            console.log(' apiData recebido:', apiData);

            // Normalizar possíveis variações de chave retornadas pela API
            let monthly = apiData?.monthly_trend || apiData?.monthly_trends || apiData?.tendencia || null;

            // Se não veio monthly_* mas temos lista de rncs, gerar uma monthly_trend a partir delas
            if ((!monthly || monthly.length === 0) && Array.isArray(apiData?.rncs) && apiData.rncs.length > 0) {
                console.log(' Gerando monthly_trend a partir de apiData.rncs (fallback)');
                const monthlyMap = {};
                apiData.rncs.forEach(rnc => {
                    const dateField = rnc.finalized_at || rnc.created_at || rnc.data_abertura || rnc.date || rnc.createdAt;
                    if (!dateField) return;
                    const key = ('' + dateField).substring(0,7); // YYYY-MM or similar
                    monthlyMap[key] = (monthlyMap[key] || 0) + 1;
                });
                const months = Object.keys(monthlyMap).sort();
                monthly = months.map(m => ({ month: m, count: monthlyMap[m] }));
            }

            if (!monthly || monthly.length === 0) {
                console.warn(' Sem monthly_trend para construir gráficos (nenhum dado disponível)');
                return;
            }

            const labels = monthly.map(m => m.month);
            const values = monthly.map(m => m.count);
            
            console.log(' Labels:', labels);
            console.log(' Values:', values);
            
            // Armazenar cache
            window._setorDataCache = {
                setor: setor,
                months: apiData.monthly_trend,
                labels: labels,
                values: values,
                apiData: apiData
            };
            
            // Construir gráfico principal
            buildSetorSingleChart(labels, values);
        }

        // Função concreta para construir um único gráfico de linha de setor (usada para iteração visual)
        function buildSetorSingleChart(labels, values) {
            try {
                console.log('buildSetorSingleChart called', labels, values);
                const canvas = document.getElementById('setorSingleChart');
                if (!canvas) { console.warn('setorSingleChart canvas not found'); return; }

                // Ensure visible size
                if (!canvas.style.height || canvas.style.height === '') {
                    canvas.style.height = '280px';
                }

                // try to get 2d context
                const ctx = canvas.getContext && canvas.getContext('2d');
                if (!ctx) { console.warn('Canvas 2D context not available'); return; }

                // fallback to sensible data if empty
                let finalLabels = Array.isArray(labels) ? labels.slice() : [];
                let finalValues = Array.isArray(values) ? values.slice() : [];
                if (!finalLabels.length || !finalValues.length) {
                    // produce last 6 months labels and zero values
                    const now = new Date();
                    finalLabels = [];
                    for (let i = 5; i >= 0; i--) {
                        const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
                        finalLabels.push(d.toLocaleString('default', { month: 'short' }));
                    }
                    finalValues = [0,0,0,0,0,0];
                    console.log('buildSetorSingleChart: usando fallback de labels/values (vazio recebido)');
                }

                // destroy previous chart
                if (window.setorSingleChart && window.setorSingleChart.destroy) {
                    try { window.setorSingleChart.destroy(); } catch(e) { console.warn('destroy previous chart failed', e); }
                }

                if (typeof Chart === 'undefined') { console.error('Chart.js não disponível no momento'); return; }

                window.setorSingleChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: finalLabels,
                        datasets: [{
                            label: 'RNCs Mensais — Gráfico de Linha',
                            data: finalValues,
                            borderColor: '#dc3545',
                            backgroundColor: 'rgba(220,53,69,0.06)',
                            fill: true,
                            tension: 0.25,
                            pointRadius: 3
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: { x: { display: true }, y: { display: true, beginAtZero: true } }
                    }
                });
                // force resize/update
                try { window.setorSingleChart.resize(); window.setorSingleChart.update(); } catch(e){}
                console.log('setorSingleChart built (finalLabels length=', finalLabels.length, ')');
                return window.setorSingleChart;
            } catch (err) {
                console.error('buildSetorSingleChart error', err);
            }
        }

        // UTIL: tenta converter várias formas de datas usadas nas RNCs para Date
        function parseRncDate(dtStr) {
            if (!dtStr) return null;
            // se já for Date
            if (dtStr instanceof Date) return dtStr;
            // tentar ISO direto
            let d = new Date(dtStr);
            if (!isNaN(d)) return d;
            // tentar format YYYY-MM-DD or YYYY/MM/DD
            const iso = dtStr.replace(/\//g,'-').split('T')[0];
            const parts = iso.match(/(\d{4})-(\d{1,2})-(\d{1,2})/);
            if (parts) {
                const y = parseInt(parts[1],10); const m = parseInt(parts[2],10)-1; const day = parseInt(parts[3],10);
                const dd = new Date(y,m,day);
                if (!isNaN(dd)) return dd;
            }
            // tentar timestamps numéricos
            if (/^\d+$/.test(dtStr)) {
                const asNum = parseInt(dtStr,10);
                // se provavelmente em ms
                if (asNum > 1e12) return new Date(asNum);
                // se em segundos
                if (asNum > 1e9) return new Date(asNum * 1000);
            }
            // fallback: null
            return null;
        }

        // Setup filter controls and initial render based on API rncs data
        function setupSetorFiltersAndRender(apiData) {
            const rncs = apiData.rncs || [];
            // store cache if not stored
            window._setorDataCache = window._setorDataCache || {};
            window._setorDataCache.rncs = window._setorDataCache.rncs || rncs;
            const years = new Set();
            const months = new Set();
            const days = new Set();
            const statuses = new Set();

            rncs.forEach(r => {
                const finalized_at = r.finalized_at || r.created_at;
                let d = parseRncDate(finalized_at);
                // if no date but status indicates finalized, still add status
                if (!d && r.status) {
                    statuses.add(r.status || 'Desconhecido');
                    return;
                }
                if (!d) return;
                years.add(d.getFullYear());
                months.add(d.getMonth()+1);
                days.add(d.getDate());
                statuses.add(r.status || 'Desconhecido');
            });

            const yearSelect = document.getElementById('filterYear');
            const statusSelect = document.getElementById('filterStatus');

            if (yearSelect) {
                if (years.size === 0) {
                    const cy = new Date().getFullYear();
                    yearSelect.innerHTML = `<option value="">Todos</option><option value="${cy}">${cy}</option>`;
                } else {
                    yearSelect.innerHTML = '<option value="">Todos</option>' + Array.from(years).sort((a,b)=>b-a).map(y=>`<option value="${y}">${y}</option>`).join('');
                }
            }
            // month/day filters removed — keep status and year only
            if (statusSelect) {
                if (statuses.size === 0) {
                    statusSelect.innerHTML = '<option value="">Todos</option><option value="Finalizado">Finalizado</option>';
                } else {
                    statusSelect.innerHTML = '<option value="">Todos</option>' + Array.from(statuses).sort().map(s=>`<option value="${s}">${s}</option>`).join('');
                }
            }

            // attach apply handler
            const applyBtn = document.getElementById('applySetorFilters');
            if (applyBtn) {
                applyBtn.onclick = () => applySetorFilters();
            }

            // initial render: aggregate monthly counts of finalized RNCs
            aggregateAndRender(rncs);
        }

        // Apply filters (reads selects) and re-render chart
        function applySetorFilters() {
            const rncs = (window._setorDataCache && window._setorDataCache.rncs) || [];
            const year = document.getElementById('filterYear')?.value || '';
            const status = document.getElementById('filterStatus')?.value || '';

            console.log('applySetorFilters called', { totalRncs: rncs.length, year, status });

            const filtered = rncs.filter(r => {
                // normalize status comparison (allow case-insensitive partial matches)
                if (status) {
                    if (!r.status || String(r.status).toLowerCase().indexOf(String(status).toLowerCase()) === -1) return false;
                }

                // date parsing tolerant; only filter by year if selected
                const dtStr = r.finalized_at || r.created_at;
                const d = parseRncDate(dtStr);
                if (!d) return false;
                if (year && Number(d.getFullYear()) !== Number(year)) return false;
                return true;
            });

            console.log('applySetorFilters -> filtered count:', filtered.length);

            aggregateAndRender(filtered);
            // Atualizar lista de detalhes abaixo do gráfico
            try { renderSetorDetails(filtered); } catch(e) { console.warn('renderSetorDetails falhou', e); }
        }

        // Aggregate RNCs into monthly counts (YYYY-MM) and render chart
        function aggregateAndRender(rncsList) {
            // Only finalized RNCs should count
            const counts = {};
            rncsList.forEach(r => {
                // consider finalized either by finalized_at present OR status containing 'finaliz' (case-insensitive)
                const isFinalized = Boolean(r.finalized_at) || (r.status && /finaliz/i.test(String(r.status)));
                if (!isFinalized) return;

                const dtStr = r.finalized_at || r.created_at;
                const d = parseRncDate(dtStr);
                if (!d || isNaN(d)) return;
                const key = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
                counts[key] = (counts[key] || 0) + 1;
            });

            console.log('aggregateAndRender -> monthly keys:', Object.keys(counts).sort(), 'counts:', counts);

            // sort months
            const keys = Object.keys(counts).sort();
            if (!keys.length) {
                // fallback to last 6 months zeros
                const now = new Date();
                const labels = [];
                const values = [];
                for (let i=5;i>=0;i--) { const d=new Date(now.getFullYear(), now.getMonth()-i,1); labels.push(d.toLocaleString('default',{month:'short', year:'numeric'})); values.push(0); }
                buildSetorSingleChart(labels, values);
                // também exibir os detalhes das RNCs usadas para esta agregação, se houver cache
                try { renderSetorDetails(rncsList); } catch(e) { /* non-blocking */ }
                return;
            }

            const labels = keys.map(k => {
                const parts = k.split('-');
                const d = new Date(parseInt(parts[0]), parseInt(parts[1])-1, 1);
                return d.toLocaleString('default', { month: 'short', year: 'numeric' });
            });
            const values = keys.map(k => counts[k]);

            buildSetorSingleChart(labels, values);
        }

        // Renderiza a tabela de detalhes das RNCs abaixo do gráfico
        function renderSetorDetails(rncs) {
            const wrapper = document.getElementById('setorDetailsTableWrapper');
            const empty = document.getElementById('setorDetailsEmpty');
            const tbody = document.getElementById('setorDetailsTbody');
            if (!tbody || !wrapper || !empty) return;

            // limpar
            tbody.innerHTML = '';

            if (!Array.isArray(rncs) || rncs.length === 0) {
                wrapper.style.display = 'none';
                empty.style.display = 'block';
                return;
            }

            empty.style.display = 'none';
            wrapper.style.display = 'block';

            // ordenar por data finalização desc (se disponível) ou criação
            const sorted = rncs.slice().sort((a,b)=>{
                const da = parseRncDate(a.finalized_at || a.created_at) || new Date(0);
                const db = parseRncDate(b.finalized_at || b.created_at) || new Date(0);
                return db - da;
            });

            // preencher linhas
            sorted.forEach(r => {
                const tr = document.createElement('tr');
                tr.style.borderBottom = '1px solid #f1f1f1';
                tr.style.verticalAlign = 'top';

                const numTd = document.createElement('td'); numTd.style.padding='8px 10px'; numTd.textContent = r.rnc_number || r.number || r.id || '';
                const titleTd = document.createElement('td'); titleTd.style.padding='8px 10px'; titleTd.textContent = r.title || r.summary || r.subject || '';
                const setorTd = document.createElement('td'); setorTd.style.padding='8px 10px'; setorTd.textContent = r.setor || r.department || r.area || '';
                const statusTd = document.createElement('td'); statusTd.style.padding='8px 10px'; statusTd.textContent = r.status || '';
                const createdTd = document.createElement('td'); createdTd.style.padding='8px 10px';
                const finTd = document.createElement('td'); finTd.style.padding='8px 10px';
                const respTd = document.createElement('td'); respTd.style.padding='8px 10px'; respTd.textContent = r.responsible || r.owner || r.assigned_to || '';
                const actionsTd = document.createElement('td'); actionsTd.style.padding='8px 10px';

                const createdDate = parseRncDate(r.created_at) || null;
                const finalizedDate = parseRncDate(r.finalized_at) || null;
                createdTd.textContent = createdDate ? createdDate.toLocaleString() : '';
                finTd.textContent = finalizedDate ? finalizedDate.toLocaleString() : '';

                // ações: visualizar (abre viewRNC se disponível) e link para edição
                const viewBtn = document.createElement('button');
                viewBtn.textContent = 'Visualizar';
                viewBtn.style.padding='6px 8px'; viewBtn.style.border='1px solid #ddd'; viewBtn.style.borderRadius='6px'; viewBtn.style.background='#fff'; viewBtn.style.cursor='pointer'; viewBtn.style.fontSize='12px';
                viewBtn.onclick = function(e){ e.preventDefault(); if (typeof viewRNC === 'function') { viewRNC(r.id || r.rnc_id || r._id || r.number); } else if (r.id) { window.location.href = '/rnc/' + r.id; } };

                actionsTd.appendChild(viewBtn);

                tr.appendChild(numTd);
                tr.appendChild(titleTd);
                tr.appendChild(setorTd);
                tr.appendChild(statusTd);
                tr.appendChild(createdTd);
                tr.appendChild(finTd);
                tr.appendChild(respTd);
                tr.appendChild(actionsTd);

                tbody.appendChild(tr);
            });
        }

        // Comparação entre setores (stub)
        function buildSetorComparisonChart(cache) {
            console.log('buildSetorComparisonChart chamado (no-op): gráficos de setor desativados.');
            return null;
        }

        // Pie chart para participação (stub)
        function buildSetorPieChart(cache) {
            console.log('buildSetorPieChart chamado (no-op): gráficos de setor desativados.');
            return null;
        }
        
        function buildSetorMonthlyChart(labels, values, goalArr, cumulative) {
            console.log('buildSetorMonthlyChart chamado (no-op): gráficos de setor desativados.');
            return null;
        }
        
        function buildSetorAccumChart(labels, cumulative, goalAccum) {
            console.log('buildSetorAccumChart chamado (no-op): gráficos de setor desativados.');
            return null;
        }
        
        function updateSetorMonth(monthValue) {
            if (!window._setorDataCache) return;
            
            const { months, labels, values, cumulative, goal, goalAccum, apiData } = window._setorDataCache;
            
            // Converter valor para índice numérico ou undefined
            const monthIdx = monthValue === '' || monthValue === undefined ? undefined : parseInt(monthValue);
            
            const monthSelect = document.getElementById('setorMonthSelect');
            if (monthSelect) {
                monthSelect.value = monthValue !== undefined ? monthValue : '';
            }
            
            console.log(' Filtro de mês atualizado:', monthIdx !== undefined ? labels[monthIdx] : 'Todos');
            
            // Atualizar título
            const setorTitle = document.getElementById('setorTitle');
            const currentSetor = apiData.setor || 'Setor';
            
            if (monthIdx !== undefined && !isNaN(monthIdx)) {
                // Filtrar dados para o mês específico
                const filteredLabels = [labels[monthIdx]];
                const filteredValues = [values[monthIdx]];
                const filteredGoal = [goal];
                const filteredCumulative = [cumulative[monthIdx]];
                const filteredGoalAccum = [goalAccum[monthIdx]];
                
                // Atualizar título com mês selecionado
                if (setorTitle) {
                    setorTitle.textContent = `${currentSetor} - ${labels[monthIdx]}`;
                }
                
                // Atualizar gráfico mensal
                if (window.setorMonthlyChart) {
                    window.setorMonthlyChart.data.labels = filteredLabels;
                    window.setorMonthlyChart.data.datasets[0].data = filteredValues;
                    window.setorMonthlyChart.data.datasets[1].data = filteredGoal;
                    window.setorMonthlyChart.update();
                }
                
                // Atualizar gráfico acumulado
                if (window.setorAccumChart) {
                    window.setorAccumChart.data.labels = filteredLabels;
                    window.setorAccumChart.data.datasets[0].data = filteredCumulative;
                    window.setorAccumChart.data.datasets[1].data = filteredGoalAccum;
                    window.setorAccumChart.update();
                }
                
                // Atualizar detalhe do mês específico
                updateSetorMonthDetail(monthIdx);
                updateSetorInfo(monthIdx);
            } else {
                // Visão geral (todos os meses) - restaurar dados completos
                
                // Restaurar título
                if (setorTitle) {
                    setorTitle.textContent = `RNCs Mensais - ${currentSetor}`;
                }
                
                if (window.setorMonthlyChart) {
                    window.setorMonthlyChart.data.labels = labels;
                    window.setorMonthlyChart.data.datasets[0].data = values;
                    window.setorMonthlyChart.data.datasets[1].data = Array(labels.length).fill(goal);
                    window.setorMonthlyChart.update();
                }
                
                if (window.setorAccumChart) {
                    window.setorAccumChart.data.labels = labels;
                    window.setorAccumChart.data.datasets[0].data = cumulative;
                    window.setorAccumChart.data.datasets[1].data = goalAccum;
                    window.setorAccumChart.update();
                }
                
                // Limpar detalhe mensal
                if (setorMonthDetailChart) {
                    setorMonthDetailChart.destroy();
                    setorMonthDetailChart = null;
                }
                document.getElementById('setorMonthInfo').innerHTML = '';
                updateSetorInfo();
            }
        }
        
        function updateSetorMonthDetail(monthIdx) {
            if (!window._setorDataCache) return;
            
            const { months, apiData } = window._setorDataCache;
            const monthData = apiData.monthly_trend?.[monthIdx];
            
            if (!monthData || !monthData.daily_details) {
                document.getElementById('setorMonthInfo').innerHTML = '<em>Sem detalhes diários para este mês.</em>';
                return;
            }
            
            // Preparar dados diários
            const dailyLabels = monthData.daily_details.map(d => {
                const day = d.day.toString().padStart(2, '0');
                return `Dia ${day}`;
            });
            const dailyValues = monthData.daily_details.map(d => d.count);
            
            // Construir gráfico de detalhes diários
            const ctx = document.getElementById('setorMonthDetailChart');
            if (!ctx) return;
            
            ctx.style.maxHeight = '150px';
            ctx.style.height = '150px';
            
            if (setorMonthDetailChart) {
                setorMonthDetailChart.destroy();
            }
            
            setorMonthDetailChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: dailyLabels,
                    datasets: [{
                        label: 'RNCs por Dia',
                        data: dailyValues,
                        backgroundColor: 'rgba(255, 159, 64, 0.7)',
                        borderColor: 'rgba(255, 159, 64, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: true, ticks: { stepSize: 1 } }
                    }
                }
            });
            
            // Atualizar info
            const totalDias = dailyValues.reduce((a, b) => a + b, 0);
            document.getElementById('setorMonthInfo').innerHTML = `
                <strong>Detalhamento de ${months[monthIdx]}:</strong><br>
                Total de dias com RNCs: ${monthData.daily_details.length} • Total RNCs: ${totalDias}
            `;
        }
        
        function updateSetorInfo(monthIdx) {
            if (!window._setorDataCache) return;
            
            const { values, cumulative, goal, goalAccum, labels } = window._setorDataCache;
            
            if (monthIdx !== undefined) {
                const realizado = values[monthIdx];
                const variacao = realizado - goal;
                document.getElementById('setorInfoRealizadoVal').textContent = realizado;
                document.getElementById('setorInfoVariacaoVal').textContent = (variacao >= 0 ? '+' : '') + variacao;
            } else {
                const total = cumulative[cumulative.length - 1] || 0;
                const metaTotal = goalAccum[goalAccum.length - 1] || 0;
                const variacao = total - metaTotal;
                document.getElementById('setorInfoRealizadoVal').textContent = total;
                document.getElementById('setorInfoVariacaoVal').textContent = (variacao >= 0 ? '+' : '') + variacao;
            }
        }
        
        function resetSetorSelection() {
            console.log(' Resetando seleção de setor...');
            
            // Destruir gráficos
            destroyAllSetorCharts();
            
            const monthSelect = document.getElementById('setorMonthSelect');
            if (monthSelect) {
                monthSelect.value = '';
                monthSelect.innerHTML = '<option value="">Todos os Meses</option>';
            }
            
            // Resetar seletor de setor
            const setorSelect = document.getElementById('setorSelect');
            if (setorSelect) {
                setorSelect.value = '';
            }
            
            // Ocultar informações
            const setorIndicadorInfo = document.getElementById('setorIndicadorInfo');
            if (setorIndicadorInfo) {
                setorIndicadorInfo.style.display = 'none';
            }
            
            const setorChartsContainer = document.getElementById('setorChartsContainer');
            if (setorChartsContainer) {
                setorChartsContainer.style.display = 'none';
            }
            
            // Limpar cache
            window._setorDataCache = null;
            
            // Restaurar título
            const setorTitle = document.getElementById('setorTitle');
            if (setorTitle) {
                setorTitle.textContent = 'RNCs Mensais por Setor';
            }
            
            // Carregar gráfico padrão
            loadDefaultSectorChart();
        }
        
        // Atualização automática dos gráficos
        let setorAutoRefreshInterval = null;
        let setorCountdownInterval = null;
        let setorNextRefreshTime = null;
        
        function startSetorAutoRefresh() {
            // Limpar intervalos anteriores se existirem
            if (setorAutoRefreshInterval) {
                clearInterval(setorAutoRefreshInterval);
            }
            if (setorCountdownInterval) {
                clearInterval(setorCountdownInterval);
            }
            
            // Definir tempo da próxima atualização
            setorNextRefreshTime = Date.now() + 30000;
            
            // Atualizar badge com contagem regressiva
            setorCountdownInterval = setInterval(function() {
                const timeLeft = Math.max(0, Math.ceil((setorNextRefreshTime - Date.now()) / 1000));
                const badge = document.getElementById('setorAutoRefreshBadge');
                if (badge) {
                    badge.textContent = `Auto-refresh ${timeLeft}s`;
                }
            }, 1000);
            
            // Atualizar a cada 30 segundos
            setorAutoRefreshInterval = setInterval(function() {
                const setorSelect = document.getElementById('setorSelect');
                const setor = setorSelect ? setorSelect.value : '';
                
                if (setor) {
                    console.log(' Atualizando automaticamente dados do setor:', setor);
                    loadSetorData();
                } else {
                    console.log(' Atualizando automaticamente setor padrão');
                    loadDefaultSectorChart();
                }
                
                // Resetar contador
                setorNextRefreshTime = Date.now() + 30000;
            }, 30000);
            
            console.log(' Auto-refresh ativado (30s)');
        }
        
        function stopSetorAutoRefresh() {
            if (setorAutoRefreshInterval) {
                clearInterval(setorAutoRefreshInterval);
                setorAutoRefreshInterval = null;
            }
            if (setorCountdownInterval) {
                clearInterval(setorCountdownInterval);
                setorCountdownInterval = null;
            }
            console.log(' Auto-refresh desativado');
        }
        
        // ================== NOVOS GRÁFICOS ADICIONAIS ==================
        
        // Gráfico de Eficiência vs Meta (%) (stub)
        function buildSetorEfficiencyChart(cache) {
            console.log('buildSetorEfficiencyChart chamado (no-op): gráficos de setor desativados.');
            return null;
        }
        
        // Gráfico de Prioridades por Setor (stub)
        function buildSetorPriorityChart(cache) {
            console.log('buildSetorPriorityChart chamado (no-op): gráficos de setor desativados.');
            return null;
        }
        
        // Gráfico de Status das RNCs
        function buildSetorStatusChart(cache) {
            const ctx = document.getElementById('setorStatusChart');
            if (!ctx) return;
            
            ctx.style.maxHeight = '250px';
            ctx.style.height = '250px';
            
            if (window.setorStatusChart) {
                try { window.setorStatusChart.destroy(); window.setorStatusChart = null; } catch(e){/*ignore*/}
            }
            
            // Usar dados reais da API (backend já filtra por período)
            const apiData = cache?.apiData || {};
            const rncs = apiData.rncs || [];
            
            // Contar RNCs por status
            const statusData = {
                'Pendente': 0,
                'Em Andamento': 0,
                'Finalizado': 0,
                'Cancelado': 0
            };
            
            rncs.forEach(rnc => {
                const status = rnc.status || 'Pendente';
                if (status === 'Finalizado' || status === 'Finalizada') {
                    statusData['Finalizado']++;
                } else if (statusData.hasOwnProperty(status)) {
                    statusData[status]++;
                } else {
                    statusData['Pendente']++;
                }
            });
            
            // Se não houver dados, mostrar gráfico vazio com mensagem
            const hasData = Object.values(statusData).some(v => v > 0);
            if (!hasData) {
                statusData['Pendente'] = 1;
                statusData['Em Andamento'] = 1;
                statusData['Finalizado'] = 1;
                statusData['Cancelado'] = 1;
            }
            
            console.log(' [Status] Contagem:', statusData);
            
            const labels = Object.keys(statusData);
            const data = Object.values(statusData);
            const colors = [
                'rgba(255, 99, 132, 0.8)',
                'rgba(255, 206, 86, 0.8)',
                'rgba(75, 192, 192, 0.8)',
                'rgba(153, 102, 255, 0.8)'
            ];
            
            window.setorStatusChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'RNCs por Status',
                        data: data,
                        backgroundColor: colors,
                        borderColor: colors.map(c => c.replace('0.8', '1')),
                        borderWidth: 2,
                        borderRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.label}: ${context.parsed.y} RNCs`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: { 
                            beginAtZero: true, 
                            max: Math.min(Math.max(...data) * 1.2, 600), // Limitar escala máxima
                            ticks: { 
                                stepSize: 1,
                                callback: function(value) {
                                    return Number.isInteger(value) ? value : '';
                                }
                            },
                            title: {
                                display: true,
                                text: 'Quantidade de RNCs',
                                font: { size: 12, weight: 'bold' }
                            }
                        }
                    }
                }
            });
        }
        
        // Gráfico de Valores Monetários (stub)
        function buildSetorValueChart(cache) {
            console.log('buildSetorValueChart chamado (no-op): gráficos de setor desativados.');
            return null;
        }
        
        // Gráfico de Top Clientes (stub)
        function buildSetorClientChart(cache) {
            console.log('buildSetorClientChart chamado (no-op): gráficos de setor desativados.');
            return null;
        }
        
        // Gráfico de Equipamentos (stub)
        function buildSetorEquipmentChart(cache) {
            console.log('buildSetorEquipmentChart chamado (no-op): gráficos de setor desativados.');
            return null;
        }
        
        // Heatmap de Dias da Semana (stub)
        function buildSetorHeatmapChart(cache) {
            console.log('buildSetorHeatmapChart chamado (no-op): heatmap desativado.');
            return null;
        }
        
        // ================== FUNÇÕES PARA GRÁFICOS DE FUNCIONÁRIOS ==================
        let employeePerformanceChart = null;
        
        function loadEmployeePerformance() {
            console.log(' Carregando desempenho por funcionário...');
            
            const year = document.getElementById('employeeYearSelect').value;
            const month = document.getElementById('employeeMonthSelect').value;
            
            // Construir URL com parâmetros
            let url = '/api/employee-performance';
            const params = new URLSearchParams();
            if (year) params.append('year', year);
            if (month) params.append('month', month);
            if (params.toString()) {
                url += '?' + params.toString();
            }
            
            // Buscar dados reais da API
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        console.log(' Dados de funcionários carregados:', data.data);
                        updateEmployeeChart(data.data);
                        updateEmployeeTable(data.data);
                    } else {
                        console.error(' Erro ao carregar dados:', data.message);
                        // Fallback para dados vazios
                        updateEmployeeChart([]);
                        updateEmployeeTable([]);
                    }
                })
                .catch(error => {
                    console.error(' Erro na requisição:', error);
                    // Fallback para dados vazios
                    updateEmployeeChart([]);
                    updateEmployeeTable([]);
                });
        }
        
        function generateEmployeeData(year, month) {
            // Esta função não é mais usada - dados vêm da API
            console.log(' generateEmployeeData foi chamada, mas dados vêm da API agora');
            return [];
        }
        
        function updateEmployeeChart(data) {
            const ctx = document.getElementById('employeePerformanceChart');
            if (!ctx) return;
            
            // Destruir gráfico existente
            if (employeePerformanceChart) {
                employeePerformanceChart.destroy();
            }
            
            // Se não há dados, mostrar gráfico vazio
            if (!data || data.length === 0) {
                employeePerformanceChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['Nenhum dado encontrado'],
                        datasets: [{
                            label: 'Sem dados',
                            data: [0],
                            backgroundColor: '#dee2e6',
                            borderColor: '#dee2e6',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        indexAxis: 'y',
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: { enabled: false }
                        },
                        scales: {
                            x: { display: false },
                            y: { display: false }
                        }
                    }
                });
                return;
            }
            
            const labels = data.map(emp => emp.name);
            const percentages = data.map(emp => emp.percentage);
            const colors = data.map(emp => emp.percentage >= 100 ? '#28a745' : '#dc3545');
            
            employeePerformanceChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Percentual de Cumprimento (%)',
                        data: percentages,
                        backgroundColor: colors,
                        borderColor: colors,
                        borderWidth: 1,
                        borderRadius: 4
                    }]
                },
                options: {
                    indexAxis: 'y', // Barras horizontais
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const emp = data[context.dataIndex];
                                    return [
                                        `${emp.name}`,
                                        `RNCs: ${emp.rncs}`,
                                        `Meta: ${emp.meta}`,
                                        `Percentual: ${emp.percentage}%`,
                                        `Status: ${emp.status}`
                                    ];
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            max: Math.max(150, Math.max(...percentages) + 20),
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            },
                            grid: {
                                color: 'rgba(0,0,0,0.1)'
                            }
                        },
                        y: {
                            ticks: {
                                font: {
                                    size: 11
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function updateEmployeeTable(data) {
            const tableContainer = document.getElementById('employeePerformanceTable');
            if (!tableContainer) return;
            
            const year = document.getElementById('employeeYearSelect').value || 'Todos';
            const month = document.getElementById('employeeMonthSelect').value;
            const monthName = month ? ['', 'Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho', 
                                           'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'][parseInt(month)] : 'Todos';
            
            if (!data || data.length === 0) {
                tableContainer.innerHTML = `
                    <h5 style="margin:0 0 12px 0; color:#333;"> Dados Detalhados - ${monthName} ${year}</h5>
                    <div style="text-align:center; padding:40px; color:#666;">
                        <div style="font-size:48px; margin-bottom:16px;"></div>
                        <h4 style="margin:0 0 8px 0;">Nenhum dado encontrado</h4>
                        <p style="margin:0;">Tente selecionar um período diferente ou verifique se há RNCs finalizadas no sistema.</p>
                    </div>
                `;
                return;
            }
            
            // Calcular estatísticas
            const totalEmployees = data.length;
            const aboveTarget = data.filter(emp => emp.percentage >= 100).length;
            const belowTarget = data.filter(emp => emp.percentage < 100).length;
            const avgPercentage = totalEmployees > 0 ? Math.round(data.reduce((sum, emp) => sum + emp.percentage, 0) / totalEmployees) : 0;
            
            let html = `
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; flex-wrap:wrap; gap:8px;">
                    <h5 style="margin:0; color:#2c3e50; font-size:14px; font-weight:600;"> Dados Detalhados - ${monthName} ${year}</h5>
                    <div style="display:flex; gap:12px; font-size:11px; color:#6c757d;">
                        <span> ${totalEmployees} funcionários</span>
                        <span> ${aboveTarget} acima</span>
                        <span> ${belowTarget} abaixo</span>
                        <span> ${avgPercentage}% média</span>
                    </div>
                </div>
                <div style="overflow-x:auto; border-radius:6px; border:1px solid #e9ecef;">
                    <table style="width:100%; border-collapse:collapse; font-size:12px;">
                        <thead>
                            <tr style="background:linear-gradient(135deg, #667eea 0%, #764ba2 100%); color:white;">
                                <th style="padding:8px 10px; text-align:left; border:none; font-size:11px; font-weight:600;">Funcionário</th>
                                <th style="padding:8px 10px; text-align:center; border:none; font-size:11px; font-weight:600;">RNCs</th>
                                <th style="padding:8px 10px; text-align:center; border:none; font-size:11px; font-weight:600;">Meta</th>
                                <th style="padding:8px 10px; text-align:center; border:none; font-size:11px; font-weight:600;">%</th>
                                <th style="padding:8px 10px; text-align:center; border:none; font-size:11px; font-weight:600;">Status</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            data.forEach((emp, index) => {
                const statusColor = emp.percentage >= 100 ? '#28a745' : '#dc3545';
                const statusIcon = emp.percentage >= 100 ? '' : '';
                const bgColor = index % 2 === 0 ? '#ffffff' : '#f8f9fa';
                const percentageBg = emp.percentage >= 100 ? '#d1f2eb' : '#f8d7da';
                const percentageTextColor = emp.percentage >= 100 ? '#0c5460' : '#721c24';
                
                html += `
                    <tr style="background:${bgColor}; transition:all 0.2s;" onmouseover="this.style.background='#e7f3ff'" onmouseout="this.style.background='${bgColor}'">
                        <td style="padding:8px 10px; border:none; border-bottom:1px solid #e9ecef; font-weight:600; font-size:12px; color:#2c3e50;">${emp.name}</td>
                        <td style="padding:8px 10px; text-align:center; border:none; border-bottom:1px solid #e9ecef; font-size:12px; font-weight:600; color:#495057;">${emp.rncs}</td>
                        <td style="padding:8px 10px; text-align:center; border:none; border-bottom:1px solid #e9ecef; font-size:12px; color:#6c757d;">${emp.meta}</td>
                        <td style="padding:8px 10px; text-align:center; border:none; border-bottom:1px solid #e9ecef;">
                            <span style="display:inline-block; padding:4px 10px; border-radius:12px; background:${percentageBg}; color:${percentageTextColor}; font-weight:700; font-size:11px;">
                                ${emp.percentage}%
                            </span>
                        </td>
                        <td style="padding:8px 10px; text-align:center; border:none; border-bottom:1px solid #e9ecef; font-size:16px; color:${statusColor};">${statusIcon}</td>
                    </tr>
                `;
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
            `;
            
            tableContainer.innerHTML = html;
        }
        
        // Função para inicializar os seletores de ano e mês para desempenho por funcionário
        function initializeEmployeeSelectors() {
            console.log(' Inicializando seletores de ano e mês para desempenho por funcionário...');
            
            const yearSelect = document.getElementById('employeeYearSelect');
            const monthSelect = document.getElementById('employeeMonthSelect');
            
            if (yearSelect && monthSelect) {
                console.log(' Seletores encontrados, carregando dados...');
                
                // Carregar anos disponíveis
                loadAvailableYears(yearSelect);
                
                // Carregar meses disponíveis
                loadAvailableMonths(monthSelect);
                
                // Após carregar os dados, definir valores padrão
                setTimeout(() => {
                    // Definir ano atual como padrão
                    const currentYear = new Date().getFullYear().toString();
                    if (yearSelect.querySelector(`option[value="${currentYear}"]`)) {
                        yearSelect.value = currentYear;
                    }
                    
                    // Definir mês atual como padrão
                    const currentMonth = (new Date().getMonth() + 1).toString().padStart(2, '0');
                    if (monthSelect.querySelector(`option[value="${currentMonth}"]`)) {
                        monthSelect.value = currentMonth;
                    }
                    
                    console.log(' Seletores inicializados com valores padrão');
                    
                    // Carregar dados iniciais
                    loadEmployeePerformance();
                }, 1000);
                
            } else {
                console.error(' Seletores não encontrados:', { yearSelect, monthSelect });
            }
        }
        
        // Função para forçar atualização dos seletores (resolve problemas de cache)
        function forceUpdateSelectors() {
            console.log(' Forçando atualização dos seletores...');
            
            const yearSelect = document.getElementById('employeeYearSelect');
            const monthSelect = document.getElementById('employeeMonthSelect');
            
            if (yearSelect && monthSelect) {
                // Limpar seletores
                yearSelect.innerHTML = '<option value="">Carregando anos...</option>';
                monthSelect.innerHTML = '<option value="">Carregando meses...</option>';
                
                // Forçar recarregamento
                setTimeout(() => {
                    loadAvailableYears(yearSelect);
                    loadAvailableMonths(monthSelect);
                    
                    // Após carregar, definir valores padrão
                    setTimeout(() => {
                        const currentYear = new Date().getFullYear().toString();
                        const currentMonth = (new Date().getMonth() + 1).toString().padStart(2, '0');
                        
                        if (yearSelect.querySelector(`option[value="${currentYear}"]`)) {
                            yearSelect.value = currentYear;
                        }
                        
                        if (monthSelect.querySelector(`option[value="${currentMonth}"]`)) {
                            monthSelect.value = currentMonth;
                        }
                        
                        console.log(' Seletores forçadamente atualizados!');
                        
                        // Recarregar dados
                        loadEmployeePerformance();
                    }, 500);
                }, 100);
                
            } else {
                console.error(' Seletores não encontrados para atualização forçada');
            }
        }
    </script>

    <!-- Modal para Visualização Ampliada de Gráficos -->
    <div id="chartModal" style="
        display: none;
        position: fixed;
        z-index: 10000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.8);
        backdrop-filter: blur(5px);
    ">
        <div style="
            position: relative;
            background: linear-gradient(145deg, #ffffff 0%, #f8f9fa 100%);
            margin: 2% auto;
            padding: 0;
            border-radius: 20px;
            width: 90%;
            max-width: 1000px;
            height: 90%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
            animation: modalSlideIn 0.3s ease-out;
        ">
            <!-- Cabeçalho do Modal -->
            <div style="
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                   color: white;
                padding: 20px 30px;
                border-radius: 20px 20px 0 0;
                display: flex;
                justify-content: space-between;
                align-items: center;
            ">
                <h2 id="chartModalTitle" style="
                    margin: 0;
                    font-size: 24px;
                    font-weight: 700;
                    text-shadow: 0 2px 4px rgba(0,0,0,0.3);
                ">Gráfico Ampliado</h2>
                <button onclick="closeChartModal()" style="
                    background: rgba(255,255,255,0.2);
                    border: none;
                    color: white;
                    font-size: 24px;
                    width: 40px;
                    height: 40px;
                    border-radius: 50%;
                    cursor: pointer;
                    transition: all 0.3s ease;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                " onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">×</button>
            </div>
            
            <!-- Conteúdo do Modal -->
            <div style="
                padding: 30px;
                height: calc(100% - 80px);
                display: flex;
                align-items: center;
                justify-content: center;
            ">
                <canvas id="chartModalCanvas" style="
                    max-width: 100%;
                    max-height: 100%;
                    border-radius: 15px;
                    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
                "></canvas>
            </div>
        </div>
    </div>

    <style>
        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: scale(0.7) translateY(-50px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }
    </style>

    <!-- Modal de Tabela de Valores -->
    <div id="valoresModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 10000; overflow-y: auto;">
        <div style="max-width: 1200px; margin: 40px auto; background: white; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.3);">
            <!-- Cabeçalho -->
            <div style="background: linear-gradient(135deg, #f39c12, #e67e22); padding: 20px; border-radius: 12px 12px 0 0; display: flex; justify-content: space-between; align-items: center;">
                <h2 style="color: white; margin: 0; font-size: 24px;"> Tabela de Valores por Hora</h2>
                <button onclick="closeValoresModal()" style="background: rgba(255,255,255,0.2); border: none; color: white; font-size: 24px; cursor: pointer; width: 40px; height: 40px; border-radius: 50%; transition: background 0.3s;" onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">×</button>
            </div>
            
            <!-- Conteúdo -->
            <div style="padding: 30px; max-height: 70vh; overflow-y: auto;">
                <!-- Filtros -->
                <div style="margin-bottom: 20px;">
                    <!-- Filtro por texto -->
                    <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 15px;">
                        <input type="text" id="valoresSearch" placeholder="Pesquisar por código ou descrição..." style="flex: 1; padding: 10px 15px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px;" oninput="filterValoresTable()">
                        <button onclick="document.getElementById('valoresSearch').value=''; filterValoresTable()" style="padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px;">Limpar</button>
                    </div>
                    
                    <!-- Filtro por categoria/setor -->
                    <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                        <label style="font-weight: bold; color: #495057;">Filtrar por categoria:</label>
                        <select id="setorFilter" onchange="filterValoresBySetor()" style="padding: 8px 12px; border: 2px solid #ddd; border-radius: 6px; font-size: 14px; min-width: 200px;">
                            <option value="">Todas as categorias</option>
                            <option value="ENGENHARIA">ENGENHARIA</option>
                            <option value="CORTE">CORTE</option>
                            <option value="CONFORMAÇÃO">CONFORMAÇÃO</option>
                            <option value="CALDEIRARIA DE CARBONO">CALDEIRARIA DE CARBONO</option>
                            <option value="CALDEIRARIA DE INOX">CALDEIRARIA DE INOX</option>
                            <option value="JATO">JATO</option>
                            <option value="PREPARAÇÃO E PINTURA">PREPARAÇÃO E PINTURA</option>
                            <option value="USINAGEM PLANA">USINAGEM PLANA</option>
                            <option value="USINAGEM CILINDRICA">USINAGEM CILINDRICA</option>
                            <option value="FURAÇÃO">FURAÇÃO</option>
                            <option value="MONTAGEM">MONTAGEM</option>
                            <option value="CÉLULA DE SECADORES">CÉLULA DE SECADORES</option>
                            <option value="EXPEDIÇÃO">EXPEDIÇÃO</option>
                            <option value="BALANCEAMENTO">BALANCEAMENTO</option>
                            <option value="INSPEÇÃO">INSPEÇÃO</option>
                            <option value="ELÉTRICA">ELÉTRICA</option>
                            <option value="TERCEIROS">TERCEIROS</option>
                            <option value="MATÉRIA PRIMA" style="background: #e8f5e8;">MATÉRIA PRIMA (NOVO)</option>
                            <option value="COMERCIAL" style="background: #e3f2fd;">COMERCIAL (NOVO)</option>
                            <option value="OUTROS" style="background: #f5f5f5;">OUTROS (NOVO)</option>
                        </select>
                        <button onclick="document.getElementById('setorFilter').value=''; filterValoresBySetor()" style="padding: 8px 15px; background: #28a745; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px;">Mostrar Todos</button>
                        <div id="setorCount" style="margin-left: 10px; padding: 6px 12px; background: #f8f9fa; border-radius: 4px; font-size: 13px; color: #6c757d;"></div>
                    </div>
                </div>

                <!-- Tabela -->
                <div style="overflow-x: auto;">
                    <style>
                        #valoresTable [contenteditable="true"] {
                            cursor: text;
                            padding: 8px !important;
                            transition: background-color 0.2s, box-shadow 0.2s;
                        }
                        #valoresTable [contenteditable="true"]:hover {
                            background-color: #fff3cd !important;
                            box-shadow: inset 0 0 0 2px #ffc107;
                        }
                        #valoresTable [contenteditable="true"]:focus {
                            background-color: #fff !important;
                            box-shadow: inset 0 0 0 2px #007bff;
                            outline: none;
                        }
                        #valoresTable .valor-row {
                            border-bottom: 1px solid #e9ecef;
                            transition: background-color 0.2s;
                        }
                        #valoresTable .valor-row:hover {
                            background-color: #f8f9fa;
                        }
                        #valoresTable .valor-row td {
                            padding: 10px 12px;
                        }
                        #valoresTable .setor-header td {
                            position: sticky;
                            top: 0;
                            z-index: 10;
                        }
                        
                        @keyframes slideIn {
                            from {
                                transform: translateX(100%);
                                opacity: 0;
                            }
                            to {
                                transform: translateX(0);
                                opacity: 1;
                            }
                        }
                        
                        @keyframes slideOut {
                            from {
                                transform: translateX(0);
                                opacity: 1;
                            }
                            to {
                                transform: translateX(100%);
                                opacity: 0;
                            }
                        }
                    </style>
                    <table id="valoresTable" style="width: 100%; border-collapse: collapse; font-size: 14px;">
                        <thead>
                            <tr style="background: #f8f9fa; position: sticky; top: 0; z-index: 20;">
                                <th style="padding: 12px; text-align: left; border-bottom: 2px solid #dee2e6; font-weight: 600; color: #495057; background: #f8f9fa;">Código</th>
                                <th style="padding: 12px; text-align: left; border-bottom: 2px solid #dee2e6; font-weight: 600; color: #495057; background: #f8f9fa;">Descrição</th>
                                <th style="padding: 12px; text-align: right; border-bottom: 2px solid #dee2e6; font-weight: 600; color: #495057; background: #f8f9fa;">Valor/Hora </th>
                                <th style="padding: 12px; text-align: center; border-bottom: 2px solid #dee2e6; font-weight: 600; color: #495057; background: #f8f9fa; width: 80px;">Ações</th>
                            </tr>
                        </thead>
                        <tbody id="valoresTableBody">
                            <!-- ENGENHARIA -->
                            <tr class="setor-header"><td colspan="4" style="background: #8b1538; color: white; font-weight: bold; padding: 10px;"> ENGENHARIA</td></tr>
                            <tr class="valor-row"><td>00.00</td><td contenteditable="true">Engenharia</td><td contenteditable="true" style="text-align: right;">R$ 60,50</td></tr>
                            <tr class="valor-row"><td>00.01</td><td contenteditable="true">Engenheiro master</td><td contenteditable="true" style="text-align: right;">R$ 357,62</td></tr>
                            <tr class="valor-row"><td>00.02</td><td contenteditable="true">Engenheiro</td><td contenteditable="true" style="text-align: right;">R$ 97,98</td></tr>
                            <tr class="valor-row"><td>00.03</td><td contenteditable="true">Projetista</td><td contenteditable="true" style="text-align: right;">R$ 58,03</td></tr>
                            <tr class="valor-row"><td>00.04</td><td contenteditable="true">Projetista júnior</td><td contenteditable="true" style="text-align: right;">R$ 58,03</td></tr>
                            <tr class="valor-row"><td>00.05</td><td contenteditable="true">Desenhista júnior</td><td contenteditable="true" style="text-align: right;">R$ 38,36</td></tr>
                            <tr class="valor-row"><td>00.06</td><td contenteditable="true">Aprendiz</td><td contenteditable="true" style="text-align: right;">R$ 25,00</td></tr>
                            
                            <!-- CORTE -->
                            <tr class="setor-header"><td colspan="3" style="background: #8b1538; color: white; font-weight: bold; padding: 10px;"> CORTE</td></tr>
                            <tr class="valor-row"><td>01.01</td><td contenteditable="true">Traçagem/Desenvolvimento</td><td contenteditable="true" style="text-align: right;">R$ 31,00</td></tr>
                            <tr class="valor-row"><td>01.02</td><td contenteditable="true">Serra Franho FM 1600</td><td contenteditable="true" style="text-align: right;">R$ 45,00</td></tr>
                            <tr class="valor-row"><td>01.03</td><td contenteditable="true">Serra Franho FM 1600</td><td contenteditable="true" style="text-align: right;">R$ 45,00</td></tr>
                            <tr class="valor-row"><td>01.04</td><td contenteditable="true">Máquina Oxicorte</td><td contenteditable="true" style="text-align: right;">R$ 103,00</td></tr>
                            <tr class="valor-row"><td>01.05</td><td contenteditable="true">Máquina Oxicorte</td><td contenteditable="true" style="text-align: right;">R$ 103,00</td></tr>
                            <tr class="valor-row"><td>01.06</td><td contenteditable="true">Máquina Corte CNC Plasma Lincolm IM 595</td><td contenteditable="true" style="text-align: right;">R$ 115,00</td></tr>
                            <tr class="valor-row"><td>01.07</td><td contenteditable="true">Crt Man-Caneta Maçarico Man Prostar PD531</td><td contenteditable="true" style="text-align: right;">R$ 72,00</td></tr>
                            <tr class="valor-row"><td>01.08</td><td contenteditable="true">Acabamento/Rebarbação</td><td contenteditable="true" style="text-align: right;">R$ 43,00</td></tr>
                            <tr class="valor-row"><td>01.09</td><td contenteditable="true">Serviços Manuais</td><td contenteditable="true" style="text-align: right;">R$ 43,00</td></tr>
                            <tr class="valor-row"><td>01.10</td><td contenteditable="true">Máquina Corte CNC Jato d'água Waterjet PRIME PRÓ 3060</td><td contenteditable="true" style="text-align: right;">R$ 201,65</td></tr>
                            
                            <!-- CONFORMAÇÃO -->
                            <tr class="setor-header"><td colspan="3" style="background: #8b1538; color: white; font-weight: bold; padding: 10px;"> CONFORMAÇÃO</td></tr>
                            <tr class="valor-row"><td>02.01</td><td contenteditable="true">Calandra Piramidal ½'' x 1500mm</td><td contenteditable="true" style="text-align: right;">R$ 55,00</td></tr>
                            <tr class="valor-row"><td>02.02</td><td contenteditable="true">Calandra p/ Laminado Redondo</td><td contenteditable="true" style="text-align: right;">R$ 61,00</td></tr>
                            <tr class="valor-row"><td>02.03</td><td contenteditable="true">Prensa 40t</td><td contenteditable="true" style="text-align: right;">R$ 60,50</td></tr>
                            <tr class="valor-row"><td>02.04</td><td contenteditable="true">Prensa 200t</td><td contenteditable="true" style="text-align: right;">R$ 97,00</td></tr>
                            <tr class="valor-row"><td>02.05</td><td contenteditable="true">Serviços Manuais</td><td contenteditable="true" style="text-align: right;">R$ 43,00</td></tr>
                            <tr class="valor-row"><td>02.06</td><td contenteditable="true">Dobradeira de tubos Bonfim</td><td contenteditable="true" style="text-align: right;">R$ 50,00</td></tr>
                            <tr class="valor-row"><td>02.07</td><td contenteditable="true">Dobradeira de chapa manual</td><td contenteditable="true" style="text-align: right;">R$ 30,00</td></tr>
                            <tr class="valor-row"><td>02.08</td><td contenteditable="true">Calandra piramidal AGA 1000</td><td contenteditable="true" style="text-align: right;">R$ 40,00</td></tr>
                            
                            <!-- CALDEIRARIA DE CARBONO -->
                            <tr class="setor-header"><td colspan="3" style="background: #8b1538; color: white; font-weight: bold; padding: 10px;"> CALDEIRARIA DE CARBONO</td></tr>
                            <tr class="valor-row"><td>03.01</td><td contenteditable="true">Montagem de Caldeiraria</td><td contenteditable="true" style="text-align: right;">R$ 61,00</td></tr>
                            <tr class="valor-row"><td>03.02</td><td contenteditable="true">Acabamento Final</td><td contenteditable="true" style="text-align: right;">R$ 55,00</td></tr>
                            <tr class="valor-row"><td>03.03</td><td contenteditable="true">Chanfro</td><td contenteditable="true" style="text-align: right;">R$ 55,00</td></tr>
                            <tr class="valor-row"><td>03.04</td><td contenteditable="true">Solda MIG</td><td contenteditable="true" style="text-align: right;">R$ 67,00</td></tr>
                            <tr class="valor-row"><td>03.05</td><td contenteditable="true">Solda TIG</td><td contenteditable="true" style="text-align: right;">R$ 55,00</td></tr>
                            <tr class="valor-row"><td>03.06</td><td contenteditable="true">Solda ER</td><td contenteditable="true" style="text-align: right;">R$ 43,00</td></tr>
                            <tr class="valor-row"><td>03.07</td><td contenteditable="true">Serviços Manuais</td><td contenteditable="true" style="text-align: right;">R$ 43,00</td></tr>
                            
                            <!-- CALDEIRARIA DE INOX -->
                            <tr class="setor-header"><td colspan="3" style="background: #8b1538; color: white; font-weight: bold; padding: 10px;"> CALDEIRARIA DE INOX</td></tr>
                            <tr class="valor-row"><td>04.01</td><td contenteditable="true">Montagem de Caldeiraria</td><td contenteditable="true" style="text-align: right;">R$ 85,00</td></tr>
                            <tr class="valor-row"><td>04.02</td><td contenteditable="true">Acabamento</td><td contenteditable="true" style="text-align: right;">R$ 67,00</td></tr>
                            <tr class="valor-row"><td>04.03</td><td contenteditable="true">Chanfro</td><td contenteditable="true" style="text-align: right;">R$ 67,00</td></tr>
                            <tr class="valor-row"><td>04.04</td><td contenteditable="true">Solda MIG</td><td contenteditable="true" style="text-align: right;">R$ 73,00</td></tr>
                            <tr class="valor-row"><td>04.05</td><td contenteditable="true">Solda TIG</td><td contenteditable="true" style="text-align: right;">R$ 61,00</td></tr>
                            <tr class="valor-row"><td>04.06</td><td contenteditable="true">Solda ER</td><td contenteditable="true" style="text-align: right;">R$ 49,00</td></tr>
                            <tr class="valor-row"><td>04.07</td><td contenteditable="true">Serviços Manuais</td><td contenteditable="true" style="text-align: right;">R$ 43,00</td></tr>
                            <tr class="valor-row"><td>04.08</td><td contenteditable="true">Plasma manual Hyper Therm</td><td contenteditable="true" style="text-align: right;">R$ 50,00</td></tr>
                            
                            <!-- JATO -->
                            <tr class="setor-header"><td colspan="3" style="background: #8b1538; color: white; font-weight: bold; padding: 10px;"> JATO</td></tr>
                            <tr class="valor-row"><td>05.01</td><td contenteditable="true">Jato de Granalha de Carbono</td><td contenteditable="true" style="text-align: right;">R$ 73,00</td></tr>
                            <tr class="valor-row"><td>05.02</td><td contenteditable="true">Jato de Granalha de Inox</td><td contenteditable="true" style="text-align: right;">R$ 157,00</td></tr>
                            <tr class="valor-row"><td>05.03</td><td contenteditable="true">Serviços Manuais</td><td contenteditable="true" style="text-align: right;">R$ 43,00</td></tr>
                            
                            <!-- PREPARAÇÃO E PINTURA -->
                            <tr class="setor-header"><td colspan="3" style="background: #8b1538; color: white; font-weight: bold; padding: 10px;"> PREPARAÇÃO E PINTURA</td></tr>
                            <tr class="valor-row"><td>06.01</td><td contenteditable="true">Preparação</td><td contenteditable="true" style="text-align: right;">R$ 36,00</td></tr>
                            <tr class="valor-row"><td>06.02</td><td contenteditable="true">Pintura de Fundo</td><td contenteditable="true" style="text-align: right;">R$ 36,00</td></tr>
                            <tr class="valor-row"><td>06.03</td><td contenteditable="true">Pintura de Acabamento</td><td contenteditable="true" style="text-align: right;">R$ 55,00</td></tr>
                            <tr class="valor-row"><td>06.04</td><td contenteditable="true">Serviços Manuais</td><td contenteditable="true" style="text-align: right;">R$ 43,00</td></tr>
                            <tr class="valor-row"><td>06.05</td><td contenteditable="true">Revestimento</td><td contenteditable="true" style="text-align: right;">R$ 40,00</td></tr>
                            
                            <!-- USINAGEM CILINDRICA -->
                            <tr class="setor-header"><td colspan="3" style="background: #8b1538; color: white; font-weight: bold; padding: 10px;"> USINAGEM CILINDRICA</td></tr>
                            <tr class="valor-row"><td>07.01</td><td contenteditable="true">Torno ROMI Tormax 20 - Leve</td><td contenteditable="true" style="text-align: right;">R$ 49,00</td></tr>
                            <tr class="valor-row"><td>07.02</td><td contenteditable="true">Torno Narnidi ND 325-CE - Leve</td><td contenteditable="true" style="text-align: right;">R$ 49,00</td></tr>
                            <tr class="valor-row"><td>07.03</td><td contenteditable="true">Torno ROMI Tormax 30A - Leve</td><td contenteditable="true" style="text-align: right;">R$ 60,00</td></tr>
                            <tr class="valor-row"><td>07.04</td><td contenteditable="true">Torno ROMI Tormax 30A - Leve</td><td contenteditable="true" style="text-align: right;">R$ 60,00</td></tr>
                            <tr class="valor-row"><td>07.05</td><td contenteditable="true">Torno ROMI Tormax 30B - Média</td><td contenteditable="true" style="text-align: right;">R$ 60,00</td></tr>
                            <tr class="valor-row"><td>07.06</td><td contenteditable="true">Torno ROMI Tormax 30B - Média</td><td contenteditable="true" style="text-align: right;">R$ 60,00</td></tr>
                            <tr class="valor-row"><td>07.07</td><td contenteditable="true">Torno ROMI Tormax I30-B - Média</td><td contenteditable="true" style="text-align: right;">R$ 60,00</td></tr>
                            <tr class="valor-row"><td>07.08</td><td contenteditable="true">Torno ROMI ES40-B - Pesada</td><td contenteditable="true" style="text-align: right;">R$ 97,00</td></tr>
                            <tr class="valor-row"><td>07.09</td><td contenteditable="true">Torno ROMI ES40-B - Pesada</td><td contenteditable="true" style="text-align: right;">R$ 97,00</td></tr>
                            <tr class="valor-row"><td>07.10</td><td contenteditable="true">Torno ROMI ES40-B - Pesada</td><td contenteditable="true" style="text-align: right;">R$ 97,00</td></tr>
                            <tr class="valor-row"><td>07.11</td><td contenteditable="true">Torno ROMI MKD I - Pesada</td><td contenteditable="true" style="text-align: right;">R$ 175,00</td></tr>
                            <tr class="valor-row"><td>07.12</td><td contenteditable="true">Torno ROMI MKD II - Pesada</td><td contenteditable="true" style="text-align: right;">R$ 170,00</td></tr>
                            <tr class="valor-row"><td>07.13</td><td contenteditable="true">Torno TONANI Plato 1200Z - Pesada</td><td contenteditable="true" style="text-align: right;">R$ 85,00</td></tr>
                            <tr class="valor-row"><td>07.14</td><td contenteditable="true">Serviços Manuais</td><td contenteditable="true" style="text-align: right;">R$ 43,00</td></tr>
                            <tr class="valor-row"><td>07.15</td><td contenteditable="true">Embutimento</td><td contenteditable="true" style="text-align: right;">R$ 66,96</td></tr>
                            <tr class="valor-row"><td>08.01</td><td contenteditable="true">Centro de Usin. Discovery 760 ROMI</td><td contenteditable="true" style="text-align: right;">R$ 182,00</td></tr>
                            <tr class="valor-row"><td>08.02</td><td contenteditable="true">Centro de Usinagem ROMI E800</td><td contenteditable="true" style="text-align: right;">R$ 182,00</td></tr>
                            <tr class="valor-row"><td>08.03</td><td contenteditable="true">Torno ROMI Multiplic 30S</td><td contenteditable="true" style="text-align: right;">R$ 182,00</td></tr>
                            <tr class="valor-row"><td>08.04</td><td contenteditable="true">Torno ROMI Multiplic 30D</td><td contenteditable="true" style="text-align: right;">R$ 182,00</td></tr>
                            <tr class="valor-row"><td>08.05</td><td contenteditable="true">Torno ROMI Multiplic 40</td><td contenteditable="true" style="text-align: right;">R$ 182,00</td></tr>
                            <tr class="valor-row"><td>08.06</td><td contenteditable="true">Programação CNC</td><td contenteditable="true" style="text-align: right;">R$ 42,35</td></tr>
                            <tr class="valor-row"><td>08.07</td><td contenteditable="true">Torno ROMI Centur 30D</td><td contenteditable="true" style="text-align: right;">R$ 182,00</td></tr>
                            <tr class="valor-row"><td>08.08</td><td contenteditable="true">Gravadora EGX-600</td><td contenteditable="true" style="text-align: right;">R$ 97,00</td></tr>
                            <tr class="valor-row"><td>08.09</td><td contenteditable="true">CNC Centur 40</td><td contenteditable="true" style="text-align: right;">R$ 182,00</td></tr>
                            <tr class="valor-row"><td>08.10</td><td contenteditable="true">Serviços Manuais</td><td contenteditable="true" style="text-align: right;">R$ 43,00</td></tr>
                            <tr class="valor-row"><td>08.11</td><td contenteditable="true">Centro de Usin. Discovery 1250ROMI</td><td contenteditable="true" style="text-align: right;">R$ 182,00</td></tr>
                            <tr class="valor-row"><td>08.12</td><td contenteditable="true">Torno Romi MHS III</td><td contenteditable="true" style="text-align: right;">R$ 200,00</td></tr>
                            <tr class="valor-row"><td>08.13</td><td contenteditable="true">Centro de Usin. Discovery 1250</td><td contenteditable="true" style="text-align: right;">R$ 132,27</td></tr>
                            <tr class="valor-row"><td>08.14</td><td contenteditable="true">Torno vertical Stankimport</td><td contenteditable="true" style="text-align: right;">R$ 150,00</td></tr>
                            
                            <!-- USINAGEM PLANA -->
                            <tr class="setor-header"><td colspan="3" style="background: #8b1538; color: white; font-weight: bold; padding: 10px;"> USINAGEM PLANA</td></tr>
                            <tr class="valor-row"><td>09.01</td><td contenteditable="true">Plaina Zocca 800mm - Leve</td><td contenteditable="true" style="text-align: right;">R$ 61,00</td></tr>
                            <tr class="valor-row"><td>09.02</td><td contenteditable="true">Plaina Rocco - Leve</td><td contenteditable="true" style="text-align: right;">R$ 61,00</td></tr>
                            <tr class="valor-row"><td>09.03</td><td contenteditable="true">Plaina Hid. OMIL Mod. PLH 200 - Média</td><td contenteditable="true" style="text-align: right;">R$ 79,00</td></tr>
                            <tr class="valor-row"><td>09.04</td><td contenteditable="true">Plaina Mayer & Schaedler 3500mm - Pesada</td><td contenteditable="true" style="text-align: right;">R$ 75,00</td></tr>
                            <tr class="valor-row"><td>09.05</td><td contenteditable="true">Plaina de Mesa Boehringer - Pesada</td><td contenteditable="true" style="text-align: right;">R$ 97,00</td></tr>
                            <tr class="valor-row"><td>09.06</td><td contenteditable="true">Plaina Della Santa 5000mm - Pesada</td><td contenteditable="true" style="text-align: right;">R$ 75,00</td></tr>
                            <tr class="valor-row"><td>09.07</td><td contenteditable="true">Plaina de Mesa Aschersleben - MWM - Pesada</td><td contenteditable="true" style="text-align: right;">R$ 85,00</td></tr>
                            <tr class="valor-row"><td>09.08</td><td contenteditable="true">Plaina Rocco 10m - Pesada</td><td contenteditable="true" style="text-align: right;">R$ 194,00</td></tr>
                            <tr class="valor-row"><td>09.09</td><td contenteditable="true">Fresadora MS 4000mm - Pesada</td><td contenteditable="true" style="text-align: right;">R$ 157,00</td></tr>
                            <tr class="valor-row"><td>09.10</td><td contenteditable="true">Fresadora Chinellato MS 5000mm - Pesada</td><td contenteditable="true" style="text-align: right;">R$ 157,00</td></tr>
                            <tr class="valor-row"><td>09.11</td><td contenteditable="true">Mandrilhadora San Rocco Mad 330 - Leve</td><td contenteditable="true" style="text-align: right;">R$ 60,00</td></tr>
                            <tr class="valor-row"><td>09.12</td><td contenteditable="true">Mandrilhadora Defum - Media</td><td contenteditable="true" style="text-align: right;">R$ 133,00</td></tr>
                            <tr class="valor-row"><td>09.13</td><td contenteditable="true">Mandrilhadora VWF Planert Wetzel - Pesada</td><td contenteditable="true" style="text-align: right;">R$ 157,00</td></tr>
                            <tr class="valor-row"><td>09.14</td><td contenteditable="true">Serviços Manuais</td><td contenteditable="true" style="text-align: right;">R$ 43,00</td></tr>
                            <tr class="valor-row"><td>09.15</td><td contenteditable="true">Mandrilhadora Votan</td><td contenteditable="true" style="text-align: right;">R$ 133,00</td></tr>
                            <tr class="valor-row"><td>09.16</td><td contenteditable="true">Chaveteira vertical</td><td contenteditable="true" style="text-align: right;">R$ 75,35</td></tr>
                            <tr class="valor-row"><td>09.17</td><td contenteditable="true">Fresadora Portal CNC Sfac Line 6000mm</td><td contenteditable="true" style="text-align: right;">R$ 187,00</td></tr>
                            
                            <!-- FURAÇÃO -->
                            <tr class="setor-header"><td colspan="3" style="background: #8b1538; color: white; font-weight: bold; padding: 10px;"> FURAÇÃO</td></tr>
                            <tr class="valor-row"><td>10.01</td><td contenteditable="true">Furadeira de Bancada Schultz 5/8</td><td contenteditable="true" style="text-align: right;">R$ 30,00</td></tr>
                            <tr class="valor-row"><td>10.02</td><td contenteditable="true">Furadeira Fresadora FF PR-30A</td><td contenteditable="true" style="text-align: right;">R$ 43,00</td></tr>
                            <tr class="valor-row"><td>10.03</td><td contenteditable="true">Furadeira Radial Rocco R-40/1300</td><td contenteditable="true" style="text-align: right;">R$ 49,00</td></tr>
                            <tr class="valor-row"><td>10.04</td><td contenteditable="true">Furadeira Radial H & Kolb mod. NKR 434</td><td contenteditable="true" style="text-align: right;">R$ 49,00</td></tr>
                            <tr class="valor-row"><td>10.05</td><td contenteditable="true">Furadeira Radial Askuith-arckdale</td><td contenteditable="true" style="text-align: right;">R$ 61,00</td></tr>
                            <tr class="valor-row"><td>10.06</td><td contenteditable="true">Rosqueadeira</td><td contenteditable="true" style="text-align: right;">R$ 49,00</td></tr>
                            <tr class="valor-row"><td>10.07</td><td contenteditable="true">Rosca Manual</td><td contenteditable="true" style="text-align: right;">R$ 36,00</td></tr>
                            <tr class="valor-row"><td>10.08</td><td contenteditable="true">Traçagem de Furação Manual</td><td contenteditable="true" style="text-align: right;">R$ 30,00</td></tr>
                            <tr class="valor-row"><td>10.09</td><td contenteditable="true">Serviços Manuais</td><td contenteditable="true" style="text-align: right;">R$ 43,00</td></tr>
                            <tr class="valor-row"><td>10.10</td><td contenteditable="true">Furadeira base magnética</td><td contenteditable="true" style="text-align: right;">R$ 40,22</td></tr>
                            
                            <!-- CÉLULA DE SECADORES -->
                            <tr class="setor-header"><td colspan="3" style="background: #8b1538; color: white; font-weight: bold; padding: 10px;"> CÉLULA DE SECADORES</td></tr>
                            <tr class="valor-row"><td>11.01</td><td contenteditable="true">Centragem</td><td contenteditable="true" style="text-align: right;">R$ 27,00</td></tr>
                            <tr class="valor-row"><td>11.02</td><td contenteditable="true">Usinagem Lateral</td><td contenteditable="true" style="text-align: right;">R$ 73,00</td></tr>
                            <tr class="valor-row"><td>11.03</td><td contenteditable="true">Torno de Acabamento 1</td><td contenteditable="true" style="text-align: right;">R$ 73,00</td></tr>
                            <tr class="valor-row"><td>11.04</td><td contenteditable="true">Torno de Acabamento 2</td><td contenteditable="true" style="text-align: right;">R$ 73,00</td></tr>
                            <tr class="valor-row"><td>11.05</td><td contenteditable="true">Montagem de Secadores</td><td contenteditable="true" style="text-align: right;">R$ 61,00</td></tr>
                            <tr class="valor-row"><td>11.06</td><td contenteditable="true">Balanceamento Estático</td><td contenteditable="true" style="text-align: right;">R$ 48,00</td></tr>
                            <tr class="valor-row"><td>11.07</td><td contenteditable="true">Testes</td><td contenteditable="true" style="text-align: right;">R$ 55,00</td></tr>
                            <tr class="valor-row"><td>11.08</td><td contenteditable="true">Serviços Manuais</td><td contenteditable="true" style="text-align: right;">R$ 43,00</td></tr>
                            <tr class="valor-row"><td>11.09</td><td contenteditable="true">Torno de acabamento 3</td><td contenteditable="true" style="text-align: right;">R$ 84,73</td></tr>
                            
                            <!-- MONTAGEM -->
                            <tr class="setor-header"><td colspan="3" style="background: #8b1538; color: white; font-weight: bold; padding: 10px;"> MONTAGEM</td></tr>
                            <tr class="valor-row"><td>12.01</td><td contenteditable="true">Montagem Final</td><td contenteditable="true" style="text-align: right;">R$ 67,00</td></tr>
                            <tr class="valor-row"><td>12.02</td><td contenteditable="true">Acabamento Final de Montagem</td><td contenteditable="true" style="text-align: right;">R$ 31,00</td></tr>
                            <tr class="valor-row"><td>12.03</td><td contenteditable="true">Serviços Manuais</td><td contenteditable="true" style="text-align: right;">R$ 43,00</td></tr>
                            <tr class="valor-row"><td>12.04</td><td contenteditable="true">Montagem de painéis</td><td contenteditable="true" style="text-align: right;">R$ 40,00</td></tr>
                            <tr class="valor-row"><td>12.05</td><td contenteditable="true">Montagem Hidr./Pneum.</td><td contenteditable="true" style="text-align: right;">R$ 40,00</td></tr>
                            <tr class="valor-row"><td>12.06</td><td contenteditable="true">Montagem elétrica</td><td contenteditable="true" style="text-align: right;">R$ 40,00</td></tr>
                            <tr class="valor-row"><td>12.07</td><td contenteditable="true">Lavador</td><td contenteditable="true" style="text-align: right;">R$ 50,00</td></tr>
                            
                            <!-- BALANCEAMENTO -->
                            <tr class="setor-header"><td colspan="3" style="background: #8b1538; color: white; font-weight: bold; padding: 10px;"> BALANCEAMENTO</td></tr>
                            <tr class="valor-row"><td>13.01</td><td contenteditable="true">Balanceadora Schenck HM 50 BU</td><td contenteditable="true" style="text-align: right;">R$ 182,00</td></tr>
                            <tr class="valor-row"><td>13.02</td><td contenteditable="true">Balanceadora Schenck HU 40</td><td contenteditable="true" style="text-align: right;">R$ 182,00</td></tr>
                            <tr class="valor-row"><td>13.03</td><td contenteditable="true">Serviços Manuais</td><td contenteditable="true" style="text-align: right;">R$ 25,00</td></tr>
                            
                            <!-- EXPEDIÇÃO -->
                            <tr class="setor-header"><td colspan="3" style="background: #8b1538; color: white; font-weight: bold; padding: 10px;"> EXPEDIÇÃO</td></tr>
                            <tr class="valor-row"><td>14.01</td><td contenteditable="true">Embalagem</td><td contenteditable="true" style="text-align: right;">R$ 20,00</td></tr>
                            
                            <!-- INSPEÇÃO -->
                            <tr class="setor-header"><td colspan="3" style="background: #8b1538; color: white; font-weight: bold; padding: 10px;"> INSPEÇÃO</td></tr>
                            <tr class="valor-row"><td>15.01</td><td contenteditable="true">Inspeção</td><td contenteditable="true" style="text-align: right;">R$ 50,00</td></tr>
                            
                            <!-- ELÉTRICA -->
                            <tr class="setor-header"><td colspan="3" style="background: #8b1538; color: white; font-weight: bold; padding: 10px;"> ELÉTRICA</td></tr>
                            <tr class="valor-row"><td>16.01</td><td contenteditable="true">Engenheiro Elétrico</td><td contenteditable="true" style="text-align: right;">R$ 86,97</td></tr>
                            <tr class="valor-row"><td>16.02</td><td contenteditable="true">Técnico projeto elétrico</td><td contenteditable="true" style="text-align: right;">R$ 27,29</td></tr>
                            <tr class="valor-row"><td>16.03</td><td contenteditable="true">Técnico elétrico</td><td contenteditable="true" style="text-align: right;">R$ 44,34</td></tr>
                            
                            <!-- TERCEIROS -->
                            <tr class="setor-header"><td colspan="3" style="background: #8b1538; color: white; font-weight: bold; padding: 10px;"> TERCEIROS</td></tr>
                            <tr class="valor-row"><td>17.01</td><td contenteditable="true">Plaina</td><td contenteditable="true" style="text-align: right;">R$ 41,50</td></tr>
                            <tr class="valor-row"><td>17.02</td><td contenteditable="true">Furadeira</td><td contenteditable="true" style="text-align: right;">R$ 39,40</td></tr>
                            <tr class="valor-row"><td>17.03</td><td contenteditable="true">Montagem</td><td contenteditable="true" style="text-align: right;">R$ 513,00</td></tr>
                        </tbody>
                    </table>
                </div>

                <!-- Informações sobre edição -->
                <div style="margin-top: 20px; padding: 15px; background: linear-gradient(135deg, #e3f2fd, #bbdefb); border-left: 4px solid #2196f3; border-radius: 8px;">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                        <span style="font-size: 24px;"></span>
                        <strong style="color: #1976d2; font-size: 15px;">Campos Editáveis</strong>
                    </div>
                    <div style="color: #0d47a1; font-size: 13px; line-height: 1.6;">
                        • <strong>Descrição</strong> e <strong>Valor/Hora</strong> podem ser editados clicando diretamente sobre eles<br>
                        • As alterações são salvas automaticamente no navegador<br>
                        • Os campos editáveis ficam destacados em amarelo ao passar o mouse<br>
                        • Use a pesquisa para encontrar rapidamente códigos ou descrições
                    </div>
                </div>

                <div style="margin-top: 15px; text-align: center; color: #6c757d; font-size: 13px;">
                    <strong>Total de Itens:</strong> <span id="valoresCount">0</span> serviços cadastrados
                </div>
            </div>

            <!-- Rodapé -->
            <div style="background: #f8f9fa; padding: 15px 30px; border-radius: 0 0 12px 12px; display: flex; justify-content: space-between; align-items: center;">
                <div style="display: flex; gap: 10px;">
                    <button onclick="openAddValorForm()" style="padding: 10px 25px; background: #6f42c1; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600; display: flex; align-items: center; gap: 8px;" onmouseover="this.style.background='#5a32a3'" onmouseout="this.style.background='#6f42c1'">
                        Adicionar Valor
                    </button>
                    <button onclick="exportValoresTable()" style="padding: 10px 25px; background: #28a745; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600; display: flex; align-items: center; gap: 8px;" onmouseover="this.style.background='#218838'" onmouseout="this.style.background='#28a745'">
                        Exportar
                    </button>
                    <button onclick="initializeValoresDatabase(event)" style="padding: 10px 25px; background: #17a2b8; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600; display: flex; align-items: center; gap: 8px;" onmouseover="this.style.background='#138496'" onmouseout="this.style.background='#17a2b8'">
                        Sincronizar BD
                    </button>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button onclick="saveValoresChanges(event)" style="padding: 10px 25px; background: #007bff; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600;" onmouseover="this.style.background='#0056b3'" onmouseout="this.style.background='#007bff'"> Salvar</button>
                    <button onclick="closeValoresModal()" style="padding: 10px 30px; background: #6c757d; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600;" onmouseover="this.style.background='#5a6268'" onmouseout="this.style.background='#6c757d'">Fechar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Adicionar Novo Valor -->
    <div id="addValorModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 99999; overflow-y: auto; pointer-events: auto;" onclick="if(event.target.id==='addValorModal') closeAddValorForm()">
        <div style="max-width: 600px; margin: 80px auto; background: white; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); pointer-events: auto;">
            <!-- Cabeçalho -->
            <div style="background: linear-gradient(135deg, #6f42c1, #5a32a3); padding: 20px; border-radius: 12px 12px 0 0; display: flex; justify-content: space-between; align-items: center;">
                <h2 style="color: white; margin: 0; font-size: 22px;"> Adicionar Novo Valor</h2>
                <button onclick="closeAddValorForm()" style="background: rgba(255,255,255,0.2); border: none; color: white; font-size: 24px; cursor: pointer; width: 40px; height: 40px; border-radius: 50%; transition: background 0.3s;" onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">×</button>
            </div>
            
            <!-- Formulário -->
            <div style="padding: 30px;">
                <form id="addValorForm" style="display: flex; flex-direction: column; gap: 20px;">
                    <!-- Código -->
                    <div>
                        <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #333;">
                            Código <span style="color: #dc3545;">*</span>
                        </label>
                        <input type="text" id="newValorCodigo" placeholder="Ex: 05.10" required style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px; transition: border-color 0.3s; pointer-events: auto; user-select: auto;" onfocus="this.style.borderColor='#6f42c1'" onblur="this.style.borderColor='#ddd'">
                        <small style="color: #6c757d; font-size: 12px;">Formato sugerido: XX.YY (setor.item)</small>
                    </div>
                    
                    <!-- Setor -->
                    <div>
                        <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #333;">
                            Setor <span style="color: #dc3545;">*</span>
                        </label>
                        <select id="newValorSetor" required style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px; transition: border-color 0.3s; pointer-events: auto; user-select: auto;" onfocus="this.style.borderColor='#6f42c1'" onblur="this.style.borderColor='#ddd'">
                            <option value="">Selecione um setor...</option>
                            <option value="ENGENHARIA">ENGENHARIA</option>
                            <option value="CORTE">CORTE</option>
                            <option value="CONFORMAÇÃO">CONFORMAÇÃO</option>
                            <option value="CALDEIRARIA DE CARBONO">CALDEIRARIA DE CARBONO</option>
                            <option value="CALDEIRARIA DE INOX">CALDEIRARIA DE INOX</option>
                            <option value="JATO">JATO</option>
                            <option value="PREPARAÇÃO E PINTURA">PREPARAÇÃO E PINTURA</option>
                            <option value="USINAGEM PLANA">USINAGEM PLANA</option>
                            <option value="USINAGEM CILINDRICA">USINAGEM CILINDRICA</option>
                            <option value="FURAÇÃO">FURAÇÃO</option>
                            <option value="MONTAGEM">MONTAGEM</option>
                            <option value="CÉLULA DE SECADORES">CÉLULA DE SECADORES</option>
                            <option value="EXPEDIÇÃO">EXPEDIÇÃO</option>
                            <option value="BALANCEAMENTO">BALANCEAMENTO</option>
                            <option value="INSPEÇÃO">INSPEÇÃO</option>
                            <option value="ELÉTRICA">ELÉTRICA</option>
                            <option value="TERCEIROS">TERCEIROS</option>
                            <option value="MATÉRIA PRIMA">MATÉRIA PRIMA</option>
                            <option value="COMERCIAL">COMERCIAL</option>
                            <option value="OUTROS">OUTROS</option>
                        </select>
                    </div>
                    
                    <!-- Descrição -->
                    <div>
                        <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #333;">
                            Descrição <span style="color: #dc3545;">*</span>
                        </label>
                        <textarea id="newValorDescricao" placeholder="Ex: Solda MIG com eletrodo ER70S-6" required rows="3" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px; resize: vertical; transition: border-color 0.3s; pointer-events: auto; user-select: auto;" onfocus="this.style.borderColor='#6f42c1'" onblur="this.style.borderColor='#ddd'"></textarea>
                    </div>
                    
                    <!-- Valor por Hora -->
                    <div>
                        <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #333;">
                            Valor por Hora (R$) <span style="color: #dc3545;">*</span>
                        </label>
                        <input type="text" id="newValorValor" placeholder="Ex: 123,45" required style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px; transition: border-color 0.3s; pointer-events: auto; user-select: auto;" onfocus="this.style.borderColor='#6f42c1'" onblur="this.style.borderColor='#ddd'" oninput="formatCurrency(this)">
                        <small style="color: #6c757d; font-size: 12px;">Apenas números e vírgula (ex: 123,45)</small>
                    </div>
                    
                    <!-- Botões -->
                    <div style="display: flex; gap: 10px; margin-top: 10px;">
                        <button type="submit" style="flex: 1; padding: 12px; background: #6f42c1; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; transition: background 0.3s;" onmouseover="this.style.background='#5a32a3'" onmouseout="this.style.background='#6f42c1'">
                             Salvar Novo Valor
                        </button>
                        <button type="button" onclick="closeAddValorForm()" style="flex: 0.3; padding: 12px; background: #6c757d; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; transition: background 0.3s;" onmouseover="this.style.background='#5a6268'" onmouseout="this.style.background='#6c757d'">
                            Cancelar
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Formatar input de moeda
        function formatCurrency(input) {
            let value = input.value.replace(/\D/g, ''); // Remove tudo exceto números
            if (value === '') {
                input.value = '';
                return;
            }
            value = (parseInt(value) / 100).toFixed(2); // Divide por 100 para ter centavos
            value = value.replace('.', ','); // Troca ponto por vírgula
            input.value = value;
        }
    
        async function openValoresModal() {
            document.getElementById('valoresModal').style.display = 'block';
            document.body.style.overflow = 'hidden';
            
            // Tentar carregar dados do banco, mas não falhar se não conseguir
            try {
                await loadSavedValores();
            } catch (e) {
                console.warn(' Não foi possível carregar dados do banco, usando dados estáticos');
                // Adicionar coluna de ações se não existir
                addActionColumnToExistingRows();
            }
            
            // Depois atualizar contadores
            updateValoresCount();
            
            // Resetar filtros
            document.getElementById('valoresSearch').value = '';
            document.getElementById('setorFilter').value = '';
            filterValoresTable();
        }
        
        function addActionColumnToExistingRows() {
            const rows = document.querySelectorAll('#valoresTableBody .valor-row');
            rows.forEach((row, index) => {
                if (row.cells.length === 3) {
                    const actionCell = document.createElement('td');
                    actionCell.style.cssText = 'padding: 8px; border-bottom: 1px solid #eee; text-align: center;';
                    actionCell.innerHTML = `
                        <button onclick="alert('Funcionalidade de exclusão requer conexão com banco de dados')" 
                                style="background: #6c757d; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 12px;"
                                title="Exclusão indisponível (sem conexão com BD)">
                            
                        </button>
                    `;
                    row.appendChild(actionCell);
                }
            });
        }

        function closeValoresModal() {
            document.getElementById('valoresModal').style.display = 'none';
            document.body.style.overflow = 'auto';
        }
        
        function openAddValorForm() {
            document.getElementById('addValorModal').style.display = 'block';
            document.body.style.overflow = 'hidden'; // Prevenir scroll do body
            // Limpar formulário
            document.getElementById('addValorForm').reset();
            // Focar no primeiro campo após um pequeno delay
            setTimeout(() => {
                const firstInput = document.getElementById('newValorCodigo');
                if (firstInput) {
                    firstInput.focus();
                }
            }, 100);
        }
        
        function closeAddValorForm() {
            document.getElementById('addValorModal').style.display = 'none';
            document.body.style.overflow = 'auto'; // Restaurar scroll do body
        }
        
        // Submeter formulário de novo valor
        document.getElementById('addValorForm')?.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const codigo = document.getElementById('newValorCodigo').value.trim();
            const setor = document.getElementById('newValorSetor').value;
            const descricao = document.getElementById('newValorDescricao').value.trim();
            const valor = document.getElementById('newValorValor').value.trim();
            
            // Validações
            if (!codigo || !setor || !descricao || !valor) {
                alert(' Por favor, preencha todos os campos obrigatórios!');
                return;
            }
            
            try {
                const response = await fetch('/api/valores-hora/save', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        codigo: codigo,
                        setor: setor,
                        descricao: descricao,
                        valor_hora: valor
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert(' Valor adicionado com sucesso!');
                    closeAddValorForm();
                    
                    // Recarregar a tabela de valores
                    await loadSavedValores();
                    
                    // Se o modal de valores estiver aberto, adicionar a nova linha manualmente
                    if (document.getElementById('valoresModal').style.display === 'block') {
                        // Encontrar o setor correto
                        const setorHeaders = document.querySelectorAll('#valoresTableBody .setor-header');
                        let targetSetor = null;
                        
                        for (const header of setorHeaders) {
                            if (header.textContent.includes(setor)) {
                                targetSetor = header;
                                break;
                            }
                        }
                        
                        if (targetSetor) {
                            // Encontrar a última linha do setor
                            let currentRow = targetSetor.nextElementSibling;
                            let lastRowOfSetor = targetSetor;
                            
                            while (currentRow && currentRow.classList.contains('valor-row')) {
                                lastRowOfSetor = currentRow;
                                currentRow = currentRow.nextElementSibling;
                            }
                            
                            // Criar nova linha
                            const newRow = document.createElement('tr');
                            newRow.className = 'valor-row';
                            newRow.innerHTML = `
                                <td>${codigo}</td>
                                <td contenteditable="true">${descricao}</td>
                                <td contenteditable="true" style="text-align: right;">R$ ${valor.replace('.', ',')}</td>
                            `;
                            
                            // Inserir após a última linha do setor
                            lastRowOfSetor.parentNode.insertBefore(newRow, lastRowOfSetor.nextSibling);
                            
                            // Feedback visual
                            newRow.style.background = '#d4edda';
                            setTimeout(() => {
                                newRow.style.background = '';
                            }, 2000);
                        }
                        
                        updateValoresCount();
                    }
                } else {
                    alert(' Erro ao adicionar valor: ' + result.message);
                }
            } catch (error) {
                console.error('Erro ao adicionar valor:', error);
                alert(' Erro ao adicionar valor: ' + error.message);
            }
        });

        function filterValoresTable() {
            const searchValue = document.getElementById('valoresSearch').value.toLowerCase();
            const setorFilter = document.getElementById('setorFilter').value;
            const rows = document.querySelectorAll('#valoresTableBody .valor-row');
            const headers = document.querySelectorAll('#valoresTableBody .setor-header');
            let visibleCount = 0;
            
            // Primeiro, aplicar filtro de setor se selecionado
            if (setorFilter) {
                headers.forEach(header => {
                    // Extrair nome do setor removendo emojis e espaços extras
                    const setorName = header.textContent.replace(/[]/g, '').trim();
                    if (setorName === setorFilter) {
                        header.style.display = '';
                    } else {
                        header.style.display = 'none';
                    }
                });
            } else {
                headers.forEach(header => {
                    header.style.display = '';
                });
            }
            
            // Aplicar filtro de texto e setor
            let currentSetor = '';
            document.querySelectorAll('#valoresTableBody tr').forEach(row => {
                if (row.classList.contains('setor-header')) {
                    // Extrair nome do setor removendo emojis e espaços extras
                    currentSetor = row.textContent.replace(/[]/g, '').trim();
                } else if (row.classList.contains('valor-row')) {
                    const codigo = row.cells[0].textContent.toLowerCase();
                    const descricao = row.cells[1].textContent.toLowerCase();
                    
                    let showRow = true;
                    
                    // Filtro por setor
                    if (setorFilter && currentSetor !== setorFilter) {
                        showRow = false;
                    }
                    
                    // Filtro por texto
                    if (searchValue && showRow) {
                        if (!codigo.includes(searchValue) && !descricao.includes(searchValue)) {
                            showRow = false;
                        }
                    }
                    
                    if (showRow) {
                        row.style.display = '';
                        visibleCount++;
                    } else {
                        row.style.display = 'none';
                    }
                }
            });
            
            // Atualizar contador
            updateSetorCount(visibleCount, setorFilter);
        }
        
        function filterValoresBySetor() {
            const setorFilter = document.getElementById('setorFilter').value;
            const searchValue = document.getElementById('valoresSearch').value;
            
            // Limpar busca por texto se mudou setor
            if (setorFilter && searchValue) {
                document.getElementById('valoresSearch').value = '';
            }
            
            filterValoresTable();
        }
        
        function updateSetorCount(count, setor) {
            const countDiv = document.getElementById('setorCount');
            if (setor) {
                countDiv.textContent = `${count} itens em ${setor}`;
                countDiv.style.background = '#e3f2fd';
                countDiv.style.color = '#1976d2';
            } else if (count > 0) {
                countDiv.textContent = `${count} itens encontrados`;
                countDiv.style.background = '#f8f9fa';
                countDiv.style.color = '#6c757d';
            } else {
                countDiv.textContent = 'Nenhum item encontrado';
                countDiv.style.background = '#ffebee';
                countDiv.style.color = '#d32f2f';
            }
        }

        function updateValoresCount() {
            const rows = document.querySelectorAll('#valoresTableBody .valor-row');
            document.getElementById('valoresCount').textContent = rows.length;
        }

        async function autoSaveValores() {
            const rows = document.querySelectorAll('#valoresTableBody .valor-row');
            const valores = [];
            
            // Obter setor atual
            let currentSetor = '';
            document.querySelectorAll('#valoresTableBody tr').forEach(row => {
                if (row.classList.contains('setor-header')) {
                    currentSetor = row.cells[0].textContent.trim();
                } else if (row.classList.contains('valor-row')) {
                    valores.push({
                        codigo: row.cells[0].textContent.trim(),
                        setor: currentSetor,
                        descricao: row.cells[1].textContent.trim(),
                        valor_hora: row.cells[2].textContent.trim()
                    });
                }
            });
            
            try {
                const response = await fetch('/api/valores-hora/save-bulk', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ valores: valores })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    console.log(` Auto-save: ${result.saved_count} valores salvos`);
                } else {
                    throw new Error(result.message || 'Erro ao salvar');
                }
                
            } catch (e) {
                console.error('Erro no auto-save:', e);
            }
        }

        async function saveValoresChanges(event) {
            const rows = document.querySelectorAll('#valoresTableBody .valor-row');
            const valores = [];
            
            // Obter setor atual
            let currentSetor = '';
            document.querySelectorAll('#valoresTableBody tr').forEach(row => {
                if (row.classList.contains('setor-header')) {
                    currentSetor = row.cells[0].textContent.trim();
                } else if (row.classList.contains('valor-row')) {
                    valores.push({
                        codigo: row.cells[0].textContent.trim(),
                        setor: currentSetor,
                        descricao: row.cells[1].textContent.trim(),
                        valor_hora: row.cells[2].textContent.trim()
                    });
                }
            });
            
            try {
                const btn = event.target;
                const originalText = btn.innerHTML;
                btn.innerHTML = ' Salvando...';
                btn.disabled = true;
                
                const response = await fetch('/api/valores-hora/save-bulk', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ valores: valores })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    btn.innerHTML = ' Salvo!';
                    btn.style.background = '#28a745';
                    
                    // Mostrar mensagem de sucesso
                    if (result.saved_count) {
                        console.log(` ${result.saved_count} valores salvos com sucesso`);
                    }
                    
                    setTimeout(() => {
                        btn.innerHTML = originalText;
                        btn.style.background = '#007bff';
                        btn.disabled = false;
                    }, 2000);
                } else {
                    throw new Error(result.message || 'Erro ao salvar');
                }
                
            } catch (e) {
                console.error('Erro ao salvar valores:', e);
                alert('Erro ao salvar alterações: ' + e.message);
                
                if (event && event.target) {
                    event.target.innerHTML = ' Erro';
                    event.target.style.background = '#dc3545';
                    setTimeout(() => {
                        event.target.innerHTML = ' Salvar Alterações';
                        event.target.style.background = '#007bff';
                        event.target.disabled = false;
                    }, 2000);
                }
            }
        }

        async function initializeValoresDatabase(event) {
            if (!confirm('Sincronizar todos os valores da tabela com o banco de dados?\n\nIsso irá atualizar todos os registros.')) {
                return;
            }
            
            const btn = event.target;
            const originalText = btn.innerHTML;
            btn.innerHTML = ' Sincronizando...';
            btn.disabled = true;
            
            try {
                // Coletar todos os valores da tabela
                const valores = [];
                let currentSetor = '';
                
                document.querySelectorAll('#valoresTableBody tr').forEach(row => {
                    if (row.classList.contains('setor-header')) {
                        currentSetor = row.cells[0].textContent.trim();
                    } else if (row.classList.contains('valor-row')) {
                        valores.push({
                            codigo: row.cells[0].textContent.trim(),
                            setor: currentSetor,
                            descricao: row.cells[1].textContent.trim(),
                            valor_hora: row.cells[2].textContent.trim()
                        });
                    }
                });
                
                const response = await fetch('/api/valores-hora/save-bulk', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ valores: valores })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    btn.innerHTML = ' Sincronizado!';
                    btn.style.background = '#28a745';
                    alert(` ${result.saved_count} registros sincronizados com sucesso!`);
                    
                    setTimeout(() => {
                        btn.innerHTML = originalText;
                        btn.style.background = '#17a2b8';
                        btn.disabled = false;
                    }, 3000);
                } else {
                    throw new Error(result.message || 'Erro ao sincronizar');
                }
                
            } catch (e) {
                console.error('Erro ao sincronizar:', e);
                alert('Erro ao sincronizar com banco de dados: ' + e.message);
                
                btn.innerHTML = ' Erro';
                btn.style.background = '#dc3545';
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.style.background = '#17a2b8';
                    btn.disabled = false;
                }, 3000);
            }
        }

        async function loadSavedValores() {
            try {
                const response = await fetch('/api/valores-hora/list');
                const result = await response.json();
                
                if (result.success && result.valores && result.valores.length > 0) {
                    // Criar mapa de valores por código
                    const valoresMap = {};
                    result.valores.forEach(v => {
                        valoresMap[v.codigo] = v;
                    });
                    
                    // Atualizar apenas os valores existentes na tabela
                    const rows = document.querySelectorAll('#valoresTableBody .valor-row');
                    rows.forEach(row => {
                        const codigo = row.cells[0].textContent.trim();
                        if (valoresMap[codigo]) {
                            row.cells[1].textContent = valoresMap[codigo].descricao;
                            row.cells[2].textContent = 'R$ ' + parseFloat(valoresMap[codigo].valor_hora).toFixed(2).replace('.', ',');
                            
                            // Adicionar ID do valor e botão de exclusão se não existir
                            row.setAttribute('data-valor-id', valoresMap[codigo].id);
                            if (row.cells.length === 3) {
                                // Adicionar coluna de ações se não existir
                                const actionCell = document.createElement('td');
                                actionCell.style.cssText = 'padding: 8px; border-bottom: 1px solid #eee; text-align: center;';
                                actionCell.innerHTML = `
                                    <button onclick="deleteValor(${valoresMap[codigo].id}, '${codigo}', '${valoresMap[codigo].descricao}')" 
                                            style="background: #dc3545; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 12px;" 
                                            title="Excluir ${codigo} - ${valoresMap[codigo].descricao}" 
                                            onmouseover="this.style.background='#c82333'" 
                                            onmouseout="this.style.background='#dc3545'">
                                        
                                    </button>
                                `;
                                row.appendChild(actionCell);
                            }
                        }
                    });
                    
                    // Adicionar novas categorias que não existem na tabela estática
                    const tbody = document.getElementById('valoresTableBody');
                    const novasCategorias = ['MATÉRIA PRIMA', 'COMERCIAL', 'OUTROS'];
                    const coresNovas = {
                        'MATÉRIA PRIMA': '#2ebf91',
                        'COMERCIAL': '#3498db', 
                        'OUTROS': '#95a5a6'
                    };
                    const iconesNovos = {
                        'MATÉRIA PRIMA': '',
                        'COMERCIAL': '',
                        'OUTROS': ''
                    };
                    
                    novasCategorias.forEach(categoria => {
                        const valoresCategoria = result.valores.filter(v => v.setor === categoria);
                        if (valoresCategoria.length > 0) {
                            // Verificar se categoria já existe na tabela
                            const existeCategoria = Array.from(document.querySelectorAll('.setor-header')).some(header => 
                                header.textContent.includes(categoria)
                            );
                            
                            if (!existeCategoria) {
                                // Adicionar header da nova categoria
                                const headerRow = document.createElement('tr');
                                headerRow.className = 'setor-header';
                                headerRow.innerHTML = `<td colspan="4" style="background: ${coresNovas[categoria]}; color: white; font-weight: bold; padding: 10px;">${iconesNovos[categoria]} ${categoria}</td>`;
                                tbody.appendChild(headerRow);
                                
                                // Ordenar e adicionar valores da categoria
                                valoresCategoria.sort((a, b) => a.codigo.localeCompare(b.codigo));
                                valoresCategoria.forEach(valor => {
                                    const row = document.createElement('tr');
                                    row.className = 'valor-row';
                                    row.setAttribute('data-valor-id', valor.id);
                                    row.innerHTML = `
                                        <td style="padding: 8px; border-bottom: 1px solid #eee;">${valor.codigo}</td>
                                        <td contenteditable="true" style="padding: 8px; border-bottom: 1px solid #eee;">${valor.descricao}</td>
                                        <td contenteditable="true" style="padding: 8px; border-bottom: 1px solid #eee; text-align: right;">R$ ${parseFloat(valor.valor_hora).toFixed(2).replace('.', ',')}</td>
                                        <td style="padding: 8px; border-bottom: 1px solid #eee; text-align: center;">
                                            <button onclick="deleteValor(${valor.id}, '${valor.codigo}', '${valor.descricao}')" 
                                                    style="background: #dc3545; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 12px;"
                                                    title="Excluir ${valor.codigo} - ${valor.descricao}"
                                                    onmouseover="this.style.background='#c82333'"
                                                    onmouseout="this.style.background='#dc3545'">
                                                
                                            </button>
                                        </td>
                                    `;
                                    tbody.appendChild(row);
                                });
                            }
                        }
                    });
                    
                    console.log(' Valores carregados do banco:', result.valores.length, 'itens');
                    updateValoresCount();
                }
            } catch (e) {
                console.warn(' Erro ao carregar valores do banco:', e);
            }
        }

        async function deleteValor(valorId, codigo, descricao) {
            // Confirmar exclusão
            const confirmMessage = ` Tem certeza que deseja excluir?\n\n Código: ${codigo}\n Descrição: ${descricao}\n\n Esta ação não pode ser desfeita!`;
            
            if (!confirm(confirmMessage)) {
                return;
            }
            
            try {
                console.log(` Excluindo valor: ${codigo} - ${descricao}`);
                
                const response = await fetch(`/api/valores-hora/delete/${valorId}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    console.log(` Valor excluído: ${codigo}`);
                    
                    // Remover linha da tabela
                    const row = document.querySelector(`tr[data-valor-id="${valorId}"]`);
                    if (row) {
                        row.remove();
                        updateValoresCount();
                    }
                    
                    // Mostrar notificação de sucesso
                    showNotification(' Valor excluído com sucesso!', 'success');
                    
                } else {
                    console.error(' Erro ao excluir:', result.message);
                    alert(` Erro ao excluir valor:\n${result.message}`);
                }
                
            } catch (error) {
                console.error(' Erro na requisição:', error);
                alert(` Erro de conexão:\n${error.message}`);
            }
        }
        
        function showNotification(message, type = 'info') {
            // Criar elemento de notificação
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 12px 20px;
                border-radius: 6px;
                color: white;
                font-weight: bold;
                z-index: 9999;
                animation: slideIn 0.3s ease;
                ${type === 'success' ? 'background: #28a745;' : 
                  type === 'error' ? 'background: #dc3545;' : 'background: #007bff;'}
            `;
            notification.textContent = message;
            
            // Adicionar ao body
            document.body.appendChild(notification);
            
            // Remover após 3 segundos
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }

        function exportValoresTable() {
            const rows = document.querySelectorAll('#valoresTableBody .valor-row');
            let csv = 'Código;Descrição;Valor/Hora\n';
            
            rows.forEach(row => {
                const codigo = row.cells[0].textContent.trim();
                const descricao = row.cells[1].textContent.trim();
                const valor = row.cells[2].textContent.trim();
                csv += `${codigo};${descricao};${valor}\n`;
            });
            
            // Adicionar setores como comentários
            const setores = document.querySelectorAll('#valoresTableBody .setor-header');
            let csvWithHeaders = 'Código;Descrição;Valor/Hora\n';
            
            document.querySelectorAll('#valoresTableBody tr').forEach(row => {
                if (row.classList.contains('setor-header')) {
                    csvWithHeaders += '\n' + row.cells[0].textContent.trim() + '\n';
                } else if (row.classList.contains('valor-row')) {
                    csvWithHeaders += `${row.cells[0].textContent.trim()};${row.cells[1].textContent.trim()};${row.cells[2].textContent.trim()}\n`;
                }
            });
            
            // Download
            const blob = new Blob([csvWithHeaders], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', 'valores_hora_ippel_' + new Date().toISOString().split('T')[0] + '.csv');
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            // Feedback
            const btn = event.target;
            const originalText = btn.innerHTML;
            btn.innerHTML = ' Exportado!';
            setTimeout(() => {
                btn.innerHTML = originalText;
            }, 2000);
        }

        // Fechar modal ao clicar fora
        document.getElementById('valoresModal')?.addEventListener('click', function(e) {
            if (e.target === this) {
                closeValoresModal();
            }
        });

        // Fechar modal com ESC
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && document.getElementById('valoresModal').style.display === 'block') {
                closeValoresModal();
            }
        });

        // Auto-save quando o usuário edita
        document.addEventListener('DOMContentLoaded', function() {
            const valoresTable = document.getElementById('valoresTableBody');
            if (valoresTable) {
                let saveTimeout;
                
                valoresTable.addEventListener('input', function(e) {
                    if (e.target.hasAttribute('contenteditable')) {
                        // Se for coluna de valor (terceira coluna), validar apenas números
                        if (e.target.cellIndex === 2) {
                            let text = e.target.textContent;
                            
                            // Permitir apenas números, vírgula, ponto, espaço e R$
                            let cleanText = text.replace(/[^\d,.\sR$]/g, '');
                            
                            // Se o texto mudou, atualizar
                            if (cleanText !== text) {
                                const selection = window.getSelection();
                                const range = selection.getRangeAt(0);
                                const offset = range.startOffset;
                                
                                e.target.textContent = cleanText;
                                
                                // Restaurar posição do cursor
                                try {
                                    const newRange = document.createRange();
                                    newRange.setStart(e.target.firstChild || e.target, Math.min(offset, cleanText.length));
                                    newRange.collapse(true);
                                    selection.removeAllRanges();
                                    selection.addRange(newRange);
                                } catch (err) {
                                    console.warn('Erro ao restaurar cursor:', err);
                                }
                            }
                        }
                        
                        // Marcar célula como editada
                        e.target.style.borderLeft = '3px solid #ffc107';
                        
                        // Auto-save com debounce (salva 3 segundos após parar de editar)
                        clearTimeout(saveTimeout);
                        saveTimeout = setTimeout(async () => {
                            e.target.style.borderLeft = '3px solid #28a745';
                            await autoSaveValores();
                            // Remover marcação após salvar
                            setTimeout(() => {
                                e.target.style.borderLeft = '';
                            }, 1500);
                        }, 3000);
                    }
                });
                
                // Validação ao sair do campo
                valoresTable.addEventListener('blur', function(e) {
                    if (e.target.hasAttribute('contenteditable') && e.target.cellIndex === 2) {
                        let text = e.target.textContent.trim();
                        
                        // Formatar valor ao sair do campo
                        if (text) {
                            // Remover tudo exceto números, vírgula e ponto
                            let numerico = text.replace(/[^\d,.]/g, '').replace(',', '.');
                            
                            try {
                                let valor = parseFloat(numerico);
                                if (!isNaN(valor)) {
                                    e.target.textContent = 'R$ ' + valor.toFixed(2).replace('.', ',');
                                }
                            } catch (err) {
                                console.warn('Erro ao formatar valor:', err);
                            }
                        }
                    }
                }, true);
            }
        });

        // Atalho Ctrl+S para salvar
        document.addEventListener('keydown', function(e) {
            if ((e.ctrlKey || e.metaKey) && e.key === 's' && document.getElementById('valoresModal').style.display === 'block') {
                e.preventDefault();
                saveValoresChanges();
            }
        });
        
        // Função para limpar notificações antigas
        function clearOldNotifications() {
            const notifications = document.querySelectorAll('.side-popup-notification');
            notifications.forEach(notification => {
                const timestamp = notification.dataset.timestamp;
                if (timestamp) {
                    const notificationTime = new Date(timestamp);
                    const now = new Date();
                    const diffMinutes = (now - notificationTime) / (1000 * 60);
                    
                    // Remover notificações com mais de 5 minutos
                    if (diffMinutes > 5) {
                        notification.remove();
                        currentPopupCount--;
                    }
                }
            });
        }
        
        // Função para limpar notificações duplicadas
        function clearDuplicateNotifications() {
            const notifications = document.querySelectorAll('.side-popup-notification');
            const seenNotifications = new Set();
            
            notifications.forEach(notification => {
                const rncId = notification.dataset.rncId;
                const message = notification.dataset.message;
                const key = `${rncId}-${message}`;
                
                if (seenNotifications.has(key)) {
                    // Notificação duplicada, remover
                    notification.remove();
                    currentPopupCount--;
                } else {
                    seenNotifications.add(key);
                }
            });
        }
        
        // Limpar notificações a cada 2 minutos
        setInterval(() => {
            clearOldNotifications();
            clearDuplicateNotifications();
        }, 120000); // 2 minutos
        
        // Função para garantir que os gráficos de setores funcionem
        function initializeSetoresCharts(retries = 5, skipTabCheck = false) {
            // Só inicializar se estivermos na aba 'setores', a menos que o chamador force a inicialização
            if (!skipTabCheck && window.currentTab !== 'setores') {
                console.log('initializeSetoresCharts: aba atual não é "setores" (', window.currentTab, '), abortando.');
                return;
            }

            console.log(' Inicializando gráficos de setores...');

            var setoresCharts = document.getElementById('setoresCharts');
            if (!setoresCharts) {
                console.log(' Container setoresCharts não encontrado — nada a inicializar');
                return;
            }

            // Mostrar container apenas quando estiver na aba correta
            setoresCharts.style.display = 'block';
            console.log(' Container de gráficos de setores exibido');

            // Dados exemplo: últimos 6 meses
            const labels = ['Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out'];
            const values = [2, 5, 3, 6, 4, 7];

            // Garantir que Chart.js esteja disponível; caso não, tentar algumas vezes
            if (typeof Chart === 'undefined') {
                if (retries > 0) {
                    console.log(' Chart.js ainda não carregado, tentando novamente em 300ms (tentativas restantes:', retries, ')');
                    setTimeout(function() { initializeSetoresCharts(retries - 1); }, 300);
                } else {
                    console.error(' Chart.js não carregou após várias tentativas.');
                }
                return;
            }

            try {
                buildSetorSingleChart(labels, values);
                console.log(' setorSingleChart criado com sucesso');
                return window.setorSingleChart;
            } catch(e) {
                console.error('Erro ao inicializar Chart:', e);
                return null;
            }
        }

        // Robust initializer: wait for Chart.js, ensure container visible, and build chart.
        function initializeSetorSingleChartWhenVisible(retries = 8, retryDelay = 300) {
            const container = document.getElementById('setoresCharts');
            const canvas = document.getElementById('setorSingleChart');
            console.log('initializeSetorSingleChartWhenVisible called, container:', !!container, 'canvas:', !!canvas);

            function tryBuild() {
                try {
                    if (typeof Chart === 'undefined') {
                        console.log('Chart.js not ready, retries left:', retries);
                        if (retries-- > 0) setTimeout(tryBuild, retryDelay);
                        return;
                    }

                    // only build if setores tab active and container visible
                    if (window.currentTab && window.currentTab !== 'setores') {
                        console.log('currentTab is not setores, skipping build');
                        return;
                    }

                    // If container exists but is hidden, wait for visibility via IntersectionObserver
                    if (container) {
                        const style = window.getComputedStyle(container);
                        if (style && style.display === 'none') {
                            console.log('setoresCharts is hidden; attaching observer to wait for visibility');
                            observeVisibility(container);
                            return;
                        }
                    }

                    // Fallback labels/values for initial render
                    const labels = ['Jan','Feb','Mar','Apr','May','Jun'];
                    const values = [0,0,0,0,0,0];
                    buildSetorSingleChart(labels, values);
                } catch (e) {
                    console.error('initializeSetorSingleChartWhenVisible error', e);
                }
            }

            function observeVisibility(el) {
                if (!('IntersectionObserver' in window)) {
                    console.log('IntersectionObserver not supported, will retry build in ' + retryDelay + 'ms');
                    if (retries-- > 0) setTimeout(tryBuild, retryDelay);
                    return;
                }
                const io = new IntersectionObserver((entries, observer) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            console.log('setoresCharts became visible via IntersectionObserver');
                            observer.disconnect();
                            // small delay to allow styles/layout to settle
                            setTimeout(() => tryBuild(), 80);
                        }
                    });
                }, { threshold: 0.1 });
                io.observe(el);
                // safety timeout to stop observing after a while and attempt build anyway
                setTimeout(() => { tryBuild(); try { io.disconnect(); } catch(e){} }, 5000);
            }

            tryBuild();
        }

        // Ensure we attempt initialization when switchTab activates 'setores'
        (function attachSetoresTabHook(){
            // attach a click listener to the tab button as a reliable fallback
            try {
                // original switchTab may be overwritten later; add both hook and click listener
                const original = window.switchTab;
                window.switchTab = function(tab) {
                    try { if (typeof original === 'function') original(tab); } catch(e) { console.warn('original switchTab failed', e); }
                    if (tab === 'setores') {
                        // small delay to let the tab DOM update
                        setTimeout(() => initializeSetorSingleChartWhenVisible(), 120);
                    }
                };

                // find tab button by text content as fallback and attach click listener
                setTimeout(() => {
                    try {
                        const tabButtons = Array.from(document.querySelectorAll('.tab-button, button'));
                        for (const b of tabButtons) {
                            if (b.textContent && b.textContent.trim().includes('RNCs Mensais por Setor')) {
                                b.addEventListener('click', () => setTimeout(() => initializeSetorSingleChartWhenVisible(), 120));
                                console.log('Attached click listener to RNCs Mensais por Setor tab button');
                                break;
                            }
                        }
                    } catch(e) { /* ignore */ }
                }, 400);
            } catch(e) { console.warn('setores tab hook attach failed', e); }
            console.log('setores tab hook attached');
        })();
        
        // Inicializar quando a página carregar
        document.addEventListener('DOMContentLoaded', function() {
                setTimeout(function() {
                    if (window.currentTab === 'setores') initializeSetoresCharts();
                }, 500);
                // Carregar gráfico padrão de engenharia
                setTimeout(() => {
                    loadDefaultSectorChart();
                }, 1000);

                // debug button handler removed

                // Garantir que o botão Aplicar e selects acionem applySetorFilters mesmo que setupSetorFiltersAndRender não rode ainda
                setTimeout(() => {
                    const applyBtn = document.getElementById('applySetorFilters');
                    if (applyBtn) applyBtn.addEventListener('click', (e) => { e.preventDefault(); try { applySetorFilters(); } catch(err){ console.error(err); } });
                    ['filterYear','filterStatus'].forEach(id => {
                        const el = document.getElementById(id);
                        if (el) el.addEventListener('change', () => { try { applySetorFilters(); } catch(e){ console.error(e); } });
                    });
                }, 700);
            });
    </script>

</body>
</html>
