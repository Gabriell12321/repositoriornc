<!DOCTYPE html>
<html>
<head>
    <title>IPPEL - Sistema de RNC</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script>
        // Tratamento precoce de erros de extensões do navegador
        (function() {
            const originalError = console.error;
            const originalWarn = console.warn;
            
            console.error = function(...args) {
                const msg = args && args[0] ? String(args[0]) : '';
                // Silenciar erros conhecidos de extensões (SVG, translateContent, etc)
                if (msg.includes('attribute d') || 
                    msg.includes('Expected number') ||
                    msg.includes('translateContent') ||
                    msg.includes('tc0.2,0,0.4-0.2,0') ||
                    msg.includes('jquery.js') ||
                    msg.includes('SVG') ||
                    msg.includes('path') ||
                    msg.includes('d: Expected')) {
                    return;
                }
                return originalError.apply(console, args);
            };
            
            console.warn = function(...args) {
                const msg = args && args[0] ? String(args[0]) : '';
                // Silenciar warnings de extensões também
                if (msg.includes('attribute d') || 
                    msg.includes('Expected number') ||
                    msg.includes('translateContent') ||
                    msg.includes('tc0.2,0,0.4-0.2,0') ||
                    msg.includes('jquery.js') ||
                    msg.includes('SVG') ||
                    msg.includes('path')) {
                    return;
                }
                return originalWarn.apply(console, args);
            };
        })();
    </script>
    <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
    <link rel="dns-prefetch" href="https://cdn.jsdelivr.net">
    <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
    <link rel="dns-prefetch" href="https://cdnjs.cloudflare.com">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js" defer crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="{{ asset_url('js/charts-advanced.js') }}" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.min.js" defer crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="{{ asset_url('js/app.js') }}" defer></script>
    <link rel="stylesheet" href="{{ asset_url('css/avatar.css') }}">
    <script src="{{ asset_url('js/avatar.js') }}" defer></script>
    <!-- Permissões do usuário são usadas diretamente via Jinja nas seções abaixo -->
    <script>
      // Utilidades de cache para carregamento imediato
      const DASH_CACHE_KEY = 'dashboardCacheV1';
      function saveDashboardCache(payload){
        try { localStorage.setItem(DASH_CACHE_KEY, JSON.stringify({ ...payload, ts: Date.now() })); } catch(e) {}
      }
      function loadDashboardCache(){
        try {
          const raw = localStorage.getItem(DASH_CACHE_KEY);
          if (!raw) return null;
          const data = JSON.parse(raw);
          return data; // sem expirar agressivamente; servidor já tem cache próprio
        } catch(e) { return null; }
      }
    </script>
    <script>
      // Fallback seguro: garantir que switchTab exista ANTES dos botões usarem onclick
      // Esta versão será automaticamente substituída por uma implementação mais completa
      // definida posteriormente neste arquivo, se disponível.
      (function(){
        if (typeof window.switchTab === 'function') return;
        window.switchTab = function(tab){
          try {
            // Atualiza estado visual dos botões
            document.querySelectorAll('.tab-button').forEach(function(btn){ btn.classList.remove('active'); });
            var btn = document.querySelector('[data-tab="' + tab + '"]') || document.querySelector('.tab-button[onclick*="'+ tab +'"]');
            if (btn) btn.classList.add('active');

            // Mostrar/ocultar containers conhecidos
            var containers = { 'active':'rncsContainer', 'engenharia':'rncsContainer', 'finalized':'rncsContainer', 'lev1415':'lev1415Container', 'charts':'chartsContainer' };
            Object.keys(containers).forEach(function(key){
              var el = document.getElementById(containers[key]);
              if (el) el.style.display = 'none';
            });
            var targetId = containers[tab];
            if (targetId) {
              var target = document.getElementById(targetId);
              if (target) target.style.display = 'block';
            }

            // Atualiza variável global se existir
            if (typeof window.currentTab !== 'undefined') window.currentTab = tab;

            // Tenta carregar dados correspondentes à aba
            if (typeof window.loadRNCs === 'function') {
              window.loadRNCs(tab);
            }
          } catch (e) {
            try { console.error('Falha em switchTab fallback:', e); } catch(_) {}
          }
        };
      })();
    </script>
    <link rel="preload" as="image" href="{{ asset_url('logo.png') }}" imagesrcset="{{ asset_url('logo.png') }} 1x" imagesizes="100vw">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        
        .main-container {
            display: flex;
            height: 100vh;
            min-height: 100vh;
        }
        
        .left-section {
            flex: 1;
            padding: 20px;
            background: white;
            overflow-y: auto;
            overflow-x: hidden;
            min-width: 0;
            border-radius: 0 20px 20px 0;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            width: 100%;
        }
        
        .right-section {
            width: 350px;
            min-width: 350px;
            background: #f8f9fa;
            border-left: 1px solid #dee2e6;
            padding: 20px;
            overflow-y: auto;
            border-radius: 20px 0 0 20px;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e9ecef;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .logo img {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            object-fit: contain;
        }
        
        .logo h1 {
            color: #dc3545;
            font-size: 24px;
            font-weight: 700;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
            background: #f8f9fa;
            padding: 10px 15px;
            border-radius: 10px;
            border: 1px solid #dee2e6;
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #dc3545, #b21f35);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 18px;
        }
        
        .user-details h3 {
            font-size: 16px;
        }
        
        /* Estilos para notificações */
        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #dc3545;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes slideOutRight {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
        
        .user-details p {
            font-size: 12px;
            color: #666;
        }
        
        /* Sistema de Abas */
        .tabs-container {
            margin-bottom: 30px;
        }
        
        .tabs-header {
            display: flex;
            background: #f8f9fa;
            border-radius: 10px;
            padding: 5px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .tab-button {
            flex: 1;
            padding: 12px 20px;
            border: none;
            background: transparent;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s ease;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .tab-button.active {
            background: linear-gradient(135deg, #dc3545, #b21f35);
            color: white;
            box-shadow: 0 4px 15px rgba(220,53,69,0.3);
        }
        
        .tab-button:hover:not(.active) {
            background: #e9ecef;
            transform: translateY(-1px);
        }
        
        .tab-button .count {
            background: rgba(255,255,255,0.2);
            color: inherit;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .tab-button.active .count {
            background: rgba(255,255,255,0.3);
        }
        
        /* Cards de RNC */
        
        /* Estilos para Gráficos */
        .charts-container {
            margin-top: 20px;
        }
        
        .charts-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .charts-header h3 {
            color: #333;
            font-size: 18px;
            font-weight: 600;
        }
        
        .chart-controls select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            background: white;
            font-size: 14px;
            cursor: pointer;
        }
        
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .chart-card {
            background: linear-gradient(145deg, #ffffff 0%, #f8f9fa 100%);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.12);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid rgba(255,255,255,0.8);
            position: relative;
            overflow: hidden;
        }
        
        .chart-card:before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #007bff, #28a745, #ffc107, #dc3545);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .chart-card:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
        }
        
        .chart-card:hover:before {
            opacity: 1;
        }
        
        .chart-card h4 {
            color: #2c3e50;
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 20px;
            text-align: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .chart-card canvas {
            width: 100% !important;
            height: 280px !important;
            max-height: 320px;
            border-radius: 12px;
            transition: all 0.3s ease;
            background: linear-gradient(145deg, #ffffff 0%, #f8fafc 100%);
            box-shadow: inset 0 2px 8px rgba(0,0,0,0.05);
            position: relative;
            z-index: 1;
        }
        
        .chart-card canvas:hover {
            transform: scale(1.01);
            box-shadow: inset 0 4px 12px rgba(0,0,0,0.08), 0 0 20px rgba(255,255,255,0.3);
        }
        
        /* Canvas específicos para gráficos especiais */
        .performance-chart canvas,
        .radar-chart canvas {
            background: rgba(255,255,255,0.1) !important;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
        }
        
        .performance-chart canvas:hover,
        .radar-chart canvas:hover {
            box-shadow: inset 0 4px 12px rgba(0,0,0,0.1), 0 0 25px rgba(255,255,255,0.4);
        }
        
        /* ===== ESTILOS APRIMORADOS PARA OS NOVOS ELEMENTOS ===== */
        
        /* KPI Dashboard */
        .kpi-dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .kpi-card {
            padding: 25px;
            border-radius: 16px;
            text-align: center;
            box-shadow: 0 6px 20px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .kpi-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, transparent 30%, rgba(255,255,255,0.1) 50%, transparent 70%);
            opacity: 0;
            transition: opacity 0.3s ease;
            transform: translateX(-100%);
        }

        .kpi-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
        }

        .kpi-card:hover::before {
            opacity: 1;
            transform: translateX(100%);
            transition: transform 0.6s ease;
        }

        /* Controles Aprimorados */
        .chart-controls {
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
        }

        .chart-controls select {
            padding: 10px 14px !important;
            border: 1px solid #ddd !important;
            border-radius: 8px !important;
            background: #fff !important;
            color: #555 !important;
            font-size: 14px !important;
            min-width: 150px;
            transition: all 0.3s ease;
        }

        .chart-controls select:hover {
            border-color: #667eea;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.15);
        }

        .chart-controls button {
            padding: 10px 16px;
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .chart-controls button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        /* Botões dos Cards */
        .chart-card button {
            padding: 8px 14px;
            border: none;
            border-radius: 20px;
            color: white;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .chart-card button:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        /* Animações de Entrada */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .chart-card {
            animation: fadeInUp 0.6s ease-out;
        }

        .chart-card:nth-child(1) { animation-delay: 0.1s; }
        .chart-card:nth-child(2) { animation-delay: 0.2s; }
        .chart-card:nth-child(3) { animation-delay: 0.3s; }
        .chart-card:nth-child(4) { animation-delay: 0.4s; }
        .chart-card:nth-child(5) { animation-delay: 0.5s; }
        .chart-card:nth-child(6) { animation-delay: 0.6s; }

        /* Modal Aprimorado */
        .chart-modal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.8);
            backdrop-filter: blur(5px);
        }

        .chart-modal-content {
            background-color: #fff;
            margin: 3% auto;
            padding: 30px;
            border-radius: 20px;
            width: 90%;
            max-width: 1200px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-50px) scale(0.9);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .chart-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .chart-modal-header h2 {
            margin: 0;
            color: #2c3e50;
            font-size: 24px;
            font-weight: 700;
        }

        .chart-modal-close {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 50%;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .chart-modal-close:hover {
            background: #c0392b;
            transform: rotate(90deg);
        }

        .chart-modal-body {
            position: relative;
            height: 600px;
        }

        /* Indicadores de Loading */
        .chart-loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
            color: #666;
            font-size: 16px;
        }

        .chart-loading::before {
            content: '';
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsividade Aprimorada */
        @media (max-width: 768px) {
            .kpi-dashboard {
                grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
                gap: 15px;
            }

            .chart-controls {
                flex-direction: column;
                align-items: stretch;
            }

            .chart-controls select,
            .chart-controls button {
                width: 100%;
                margin-bottom: 10px;
            }

            .chart-modal-content {
                width: 95%;
                margin: 10% auto;
                padding: 20px;
            }

            .chart-modal-body {
                height: 400px;
            }
            
            .charts-header {
                flex-direction: column;
                gap: 10px;
                text-align: center;
            }
        }
        
        /* Estilos específicos para gráficos especiais */
        .performance-chart {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            position: relative;
            overflow: hidden;
        }
        
        .performance-chart:before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 1px, transparent 1px);
            background-size: 30px 30px;
            animation: float 20s linear infinite;
            opacity: 0.3;
        }
        
        .performance-chart:after {
            content: '⚡';
            position: absolute;
            top: -10px;
            right: -10px;
            font-size: 60px;
            opacity: 0.1;
            transform: rotate(15deg);
            animation: pulse 3s ease-in-out infinite;
        }
        
        .performance-chart h4 {
            color: white !important;
            -webkit-text-fill-color: white !important;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
            position: relative;
            z-index: 2;
        }
        
        .radar-chart {
            background: linear-gradient(135deg, #ff6b6b 0%, #ffa726 100%);
            color: white;
            position: relative;
            overflow: hidden;
        }
        
        .radar-chart:before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 2px, transparent 2px);
            background-size: 40px 40px;
            animation: float 25s linear infinite reverse;
            opacity: 0.3;
        }
        
        .radar-chart:after {
            content: '🎯';
            position: absolute;
            top: -10px;
            right: -10px;
            font-size: 60px;
            opacity: 0.1;
            transform: rotate(-15deg);
            animation: bounce 4s ease-in-out infinite;
        }
        
        .radar-chart h4 {
            color: white !important;
            -webkit-text-fill-color: white !important;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
            position: relative;
            z-index: 2;
        }
        
        @keyframes float {
            0% { transform: translate(0, 0) rotate(0deg); }
            33% { transform: translate(30px, -30px) rotate(120deg); }
            66% { transform: translate(-20px, 20px) rotate(240deg); }
            100% { transform: translate(0, 0) rotate(360deg); }
        }
        
        @keyframes pulse {
            0%, 100% { transform: rotate(15deg) scale(1); opacity: 0.1; }
            50% { transform: rotate(15deg) scale(1.1); opacity: 0.2; }
        }
        
        @keyframes bounce {
            0%, 100% { transform: rotate(-15deg) translateY(0); }
            50% { transform: rotate(-15deg) translateY(-10px); }
        }
        .rnc-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        /* Quando estiver na aba finalizados, usar layout de tabela */
        .rnc-grid.table-mode {
            display: block;
            grid-template-columns: none;
            gap: 0;
        }
        
        .rnc-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
            border: 2px solid transparent;
            position: relative;
            overflow: hidden;
        }
        
        .rnc-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.15);
        }
        
        .rnc-card.finalized {
            border-color: #28a745;
            background: linear-gradient(135deg, #f8fff9 0%, #ffffff 100%);
        }
        
        /* Estilos antigos para 'deleted' removidos (mantidos vazios para evitar referências) */
        
        .rnc-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }
        
        .rnc-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: white;
            font-weight: bold;
        }
        
        .rnc-icon.active {
            background: linear-gradient(135deg, #dc3545, #b21f35);
        }
        
        .rnc-icon.finalized {
            background: linear-gradient(135deg, #28a745, #1e7e34);
        }
        
        /* Ícone 'deleted' removido */
        
        .rnc-number {
            font-size: 14px;
            font-weight: bold;
            color: #dc3545;
            margin-bottom: 5px;
        }
        
        .rnc-title {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin-bottom: 10px;
            line-height: 1.3;
        }
        
        .rnc-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .detail-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            color: #666;
        }
        
        .detail-item .icon {
            width: 16px;
            height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 3px;
            font-size: 10px;
        }
        
        .priority-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
            text-transform: uppercase;
        }
        
        .priority-baixa { background: #d4edda; color: #155724; }
        .priority-média { background: #fff3cd; color: #856404; }
        .priority-alta { background: #f8d7da; color: #721c24; }
        .priority-crítica { background: #f5c6cb; color: #721c24; }
        
        .rnc-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .action-btn {
            padding: 8px 12px;
            border: none;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 5px;
            text-decoration: none;
            color: white;
        }
        
        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        /* Ensure primary/secondary mapped classes also follow IPPEL red */
        .action-btn.btn-primary,
        .action-btn.btn-secondary {
            background: linear-gradient(135deg, #dc3545, #b21f35);
            color: #fff;
        }
        
        /* Tema vermelho IPPEL para botões principais */
        .btn-view,
        .btn-chat,
        .btn-edit,
        .btn-reply {
            background: linear-gradient(135deg, #dc3545, #b21f35);
            color: #fff;
        }
        .btn-view:hover,
        .btn-chat:hover,
        .btn-edit:hover,
        .btn-reply:hover {
            background: linear-gradient(135deg, #b21f35, #8b1538);
        }
        .btn-finalize { background: #28a745; }
        .btn-delete { background: #dc3545; }
        /* Botões de lixeira removidos */
        
        /* Status específicos */
        .days-remaining {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #dc3545;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
        }
        
        .finalized-date {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #28a745;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
        }
        
        /* Loading e estados vazios */
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }
        
        .empty-state .icon {
            font-size: 48px;
            margin-bottom: 20px;
            opacity: 0.5;
        }
        
        .empty-state h3 {
            margin-bottom: 10px;
            color: #333;
        }
        
        .empty-state p {
            color: #666;
            line-height: 1.5;
        }
        
        /* Estilos para os filtros */
        .filters-container {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            border: 1px solid #dee2e6;
        }
        
        .filters-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .filters-header h3 {
            color: #333;
            font-size: 16px;
            font-weight: 600;
            margin: 0;
        }
        
        .clear-filters-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .clear-filters-btn:hover {
            background: #5a6268;
            transform: translateY(-1px);
        }
        
        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
        }
        
        .filter-group label {
            font-size: 12px;
            font-weight: 600;
            color: #495057;
            margin-bottom: 5px;
        }
        
        .filter-group input {
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        .filter-group input:focus {
            outline: none;
            border-color: #dc3545;
            box-shadow: 0 0 0 3px rgba(220,53,69,0.15);
        }
        
        /* Estilos para a tabela de RNCs finalizados */
        .table-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
            overflow: hidden;
            margin-top: 20px;
            width: 100%;
            max-width: 100%;
            min-width: 100%;
        }
        
        .rnc-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
            table-layout: fixed;
        }
        
        .rnc-table thead {
            background: linear-gradient(135deg, #dc3545, #b21f35);
            color: white;
        }
        
        .rnc-table th {
            padding: 15px 12px;
            text-align: left;
            font-weight: 600;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        /* Definir larguras específicas para cada coluna */
        .rnc-table th:nth-child(1) { width: 8%; } /* ID */
        .rnc-table th:nth-child(2) { width: 12%; } /* N° RNC */
        .rnc-table th:nth-child(3) { width: 18%; } /* Título */
        .rnc-table th:nth-child(4) { width: 12%; } /* Cliente */
        .rnc-table th:nth-child(5) { width: 12%; } /* Equipamento */
        .rnc-table th:nth-child(6) { width: 10%; } /* Área Responsável */
        .rnc-table th:nth-child(7) { width: 10%; } /* Setor */
        .rnc-table th:nth-child(8) { width: 10%; } /* Responsável */
        .rnc-table th:nth-child(9) { width: 10%; } /* Data Emissão */
        .rnc-table th:nth-child(10) { width: 6%; } /* Ações */
        
        .rnc-table tbody tr {
            border-bottom: 1px solid #e9ecef;
            transition: all 0.3s ease;
        }
        
        .rnc-table tbody tr:hover {
            background: #f8f9fa;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .rnc-table td {
            padding: 12px;
            vertical-align: middle;
        }
        
        .rnc-number-cell {
            font-weight: 600;
            color: #dc3545;
            font-family: 'Courier New', monospace;
        }
        
        .rnc-title-cell {
            font-weight: 500;
            color: #333;
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .rnc-client-cell,
        .rnc-equipment-cell,
        .rnc-department-cell,
        .rnc-user-cell {
            color: #666;
            font-size: 13px;
        }
        
        .rnc-date-cell {
            color: #28a745;
            font-weight: 500;
            font-size: 13px;
        }
        
        .rnc-actions-cell {
            text-align: center;
            white-space: nowrap;
        }
        
        .rnc-actions-cell .action-btn {
            padding: 6px 8px;
            margin: 0 2px;
            font-size: 12px;
            border-radius: 6px;
            text-decoration: none;
            display: inline-block;
            transition: all 0.3s ease;
        }
        
        .rnc-actions-cell .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        
        .btn-print {
            background: linear-gradient(135deg, #dc3545, #b21f35);
            color: white;
        }
        
        /* Estilos para ordenação */
        .sortable {
            cursor: pointer;
            user-select: none;
            position: relative;
        }
        
        .sortable:hover {
            background: rgba(255,255,255,0.1);
        }
        
        .sort-icon {
            font-size: 10px;
            margin-left: 5px;
            opacity: 0.7;
        }
        
        .sortable.asc .sort-icon::after {
            content: "↑";
        }
        
        .sortable.desc .sort-icon::after {
            content: "↓";
        }
        
        /* Responsividade da tabela */
        @media (max-width: 1200px) {
            .rnc-table {
                font-size: 12px;
            }
            
            .rnc-table th,
            .rnc-table td {
                padding: 8px 6px;
            }
            
            .rnc-title-cell {
                max-width: 150px;
            }
        }
        
        @media (max-width: 768px) {
            .table-container {
                overflow-x: auto;
                margin: 10px -10px;
                border-radius: 8px;
            }
            
            .rnc-table {
                min-width: 800px;
                font-size: 11px;
            }
            
            .rnc-table th,
            .rnc-table td {
                padding: 6px 4px;
            }
        }
        
        /* Responsividade */
        @media (max-width: 768px) {
            .main-container {
                flex-direction: column;
            }
            
            .right-section {
                width: 100%;
                min-width: auto;
                border-left: none;
                border-top: 1px solid #dee2e6;
            }
            
            .rnc-grid {
                grid-template-columns: 1fr;
            }
            
            .tabs-header {
                flex-direction: column;
                gap: 5px;
            }
            
            .tab-button {
                width: 100%;
            }
        }
        
        /* Animações */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .rnc-card {
            animation: fadeIn 0.5s ease-out;
        }
        
        /* Estatísticas */
        .stats-container {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
        }
        
        .stat-item {
            text-align: center;
            padding: 15px;
            border-radius: 10px;
            background: #f8f9fa;
        }
        
        .stat-number {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
        }
        
    .stat-active .stat-number { color: #dc3545; }
        .stat-finalized .stat-number { color: #28a745; }
        
    </style>
</head>
<body>
        <!-- jsPDF para exportação de relatórios -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
        <script>
            // Logo safety: ensure preferred IPPEL logo is used everywhere
            (function(){
                function applyLogo(img){
                    if(!img) return;
                    if(!img.dataset.logoPrimary){
                        img.dataset.logoPrimary = '/LOGOIPPEL.JPEG';
                        img.dataset.logoFallback1 = '/IPPELLOGO.jpg';
                        img.dataset.logoFallback2 = (typeof flaskUrlForStatic !== 'undefined') ? flaskUrlForStatic('LOGOSQI.jpg') : '/static/LOGOSQI.jpg';
                    }
                    if(!/LOGOIPPEL\.JPEG$/i.test(img.src)){
                        img.src = img.dataset.logoPrimary;
                    }
                    img.onerror = function(){
                        if(this.dataset.try1!=='1'){ this.dataset.try1='1'; this.src=this.dataset.logoFallback1; }
                        else if(this.dataset.try2!=='1'){ this.dataset.try2='1'; this.src=this.dataset.logoFallback2; }
                        else { this.style.display='none'; }
                    };
                }
                window.addEventListener('DOMContentLoaded', function(){
                    // Apply the auto-swap logic ONLY to explicitly marked images,
                    // so we can show multiple logos (e.g., IPPEL + SQI) side by side without overriding.
                    document.querySelectorAll('img.apply-logo, img[data-apply-logo="1"]').forEach(applyLogo);
                });
            })();
        </script>

    <div class="main-container">
        <div class="left-section">
            <!-- Header -->
            <div class="header">
                <div class="logo">
                    <!-- SQI logo (à esquerda) -->
                    <img src="{{ url_for('static', filename='LOGOSQI.jpg') }}" alt="SQI Logo">
                    <!-- IPPEL logo (à direita da SQI) -->
                    <img class="apply-logo" src="/IPPELLOGO.jpg"
                        alt="IPPEL Logo"
                        data-logo-primary="/IPPELLOGO.jpg"
                        data-logo-fallback1="/IPPELLOGO.jpg"
                        data-logo-fallback2="{{ url_for('static', filename='LOGOSQI.jpg') }}"
                        onerror="if(this.dataset.try1!=='1'){this.dataset.try1='1'; this.src=this.dataset.logoFallback1;} else if(this.dataset.try2!=='1'){this.dataset.try2='1'; this.src=this.dataset.logoFallback2;} else {this.style.display='none';}">
                    <h1>IPPEL RNC System</h1>
                </div>
                <div style="display: flex; align-items: center; gap: 15px;">
                    <!-- Botão de Notificações -->
                    <div style="position: relative; cursor: pointer;" onclick="toggleNotifications()">
                        <div style="
                            width: 40px;
                            height: 40px;
                            background: linear-gradient(135deg, #ffc107, #ff8c00);
                            border-radius: 50%;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            color: white;
                            font-size: 18px;
                            box-shadow: 0 2px 10px rgba(255,193,7,0.3);
                            transition: all 0.3s ease;
                        ">🔔</div>
                        <div id="notificationBadge" class="notification-badge" style="display: none;">0</div>
                    </div>
                    
                    <div class="user-info">
                        <div class="user-avatar ava ava-ippel" id="userAvatar" title="Clique para trocar seu avatar" data-initial="1" role="button" tabindex="0" onclick="if(window.IPPELAvatar){ IPPELAvatar.show(); } else { window.__OPEN_AVATAR_ON_READY__=true; }" onkeydown="if(event.key==='Enter'||event.key===' '){ event.preventDefault(); if(window.IPPELAvatar){ IPPELAvatar.show(); } else { window.__OPEN_AVATAR_ON_READY__=true; }}">U</div>
                        <div class="user-details">
                            <h3 id="userName">Carregando...</h3>
                            <p id="userDepartment">Departamento</p>
                        </div>
                        <button onclick="logout()" style="background: #dc3545; color: white; border: none; padding: 8px 15px; border-radius: 8px; cursor: pointer;">
                            🚪 Sair
                        </button>
                    </div>
                </div>
            </div>
            <div id="avatarModal"></div>
            
            <!-- Sistema de Abas -->
            <div class="tabs-container">
                <div class="tabs-header">
                    <button class="tab-button active" data-tab="active" onclick="switchTab('active')">
                        📋 Ativos
                        <span class="count" id="count-active">0</span>
                    </button>
                    {% if user_permissions.canViewEngineeringRncs %}
                    <button class="tab-button" data-tab="setores" onclick="switchTab('setores')">
                        📊 RNCs Mensais por Setor
                    </button>
                    {% endif %}
                    {% if user_permissions.canViewFinalizedRncs %}
                    <button class="tab-button" data-tab="finalized" onclick="switchTab('finalized')">
                        ✅ Finalizados
                        <span class="count" id="count-finalized">0</span>
                    </button>
                    {% endif %}
                    {% if user_permissions.canViewCharts %}
                    <button class="tab-button" data-tab="evidencias" onclick="switchTab('evidencias')">
                        📊 Evidências
                    </button>
                    {% endif %}
                    {% if user_permissions.canViewLevantamento1415 %}
                    <button class="tab-button" data-tab="lev1415" onclick="switchTab('lev1415')">
                        📑 Levantamento 14-15
                    </button>
                    {% endif %}
                </div>
                
                <!-- Filtros para aba Finalizados -->
                <div id="filtersContainer" class="filters-container" style="display: none;">
                    <div class="filters-header">
                        <h3>🔍 Filtros de Pesquisa</h3>
                        <div style="display:flex; gap:8px; align-items:center;">
                            <label style="font-size:12px; color:#495057;">De:</label>
                            <input type="date" id="filterDateStart" onchange="applyFilters()" style="padding:6px 8px; border:1px solid #ddd; border-radius:6px;">
                            <label style="font-size:12px; color:#495057;">Até:</label>
                            <input type="date" id="filterDateEnd" onchange="applyFilters()" style="padding:6px 8px; border:1px solid #ddd; border-radius:6px;">
                            <select id="pageSizeSelect" onchange="changePageSize(this.value)" style="padding:6px 8px; border:1px solid #ddd; border-radius:6px;">
                                <option value="10">10 por página</option>
                                <option value="25">25 por página</option>
                                <option value="50">50 por página</option>
                                <option value="100">100 por página</option>
                            </select>
                            <button onclick="exportCSV()" class="clear-filters-btn" style="background:#198754">Exportar CSV</button>
                            <button onclick="clearFilters()" class="clear-filters-btn">Limpar Filtros</button>
                        </div>
                    </div>
                    <div class="filters-grid">
                        <div class="filter-group">
                            <label for="filterRncNumber">N° RNC:</label>
                            <input type="text" id="filterRncNumber" placeholder="Digite o número do RNC" onkeyup="applyFilters()">
                        </div>
                        <div class="filter-group">
                            <label for="filterClient">Cliente:</label>
                            <input type="text" id="filterClient" placeholder="Digite o nome do cliente" onkeyup="applyFilters()">
                        </div>
                        <div class="filter-group">
                            <label for="filterEquipment">Equipamento:</label>
                            <input type="text" id="filterEquipment" placeholder="Digite o equipamento" onkeyup="applyFilters()">
                        </div>
                        <div class="filter-group">
                            <label for="filterDepartment">Setor:</label>
                            <input type="text" id="filterDepartment" placeholder="Digite o setor" onkeyup="applyFilters()">
                        </div>
                        <div class="filter-group">
                            <label for="filterPriority">Prioridade:</label>
                            <input type="text" id="filterPriority" placeholder="Baixa/Média/Alta/Crítica" onkeyup="applyFilters()">
                        </div>
                        <div class="filter-group">
                            <label for="filterResponsible">Responsável:</label>
                            <input type="text" id="filterResponsible" placeholder="Nome do responsável" onkeyup="applyFilters()">
                        </div>
                    </div>
                </div>
                
                <!-- Estatísticas -->
                <div class="stats-container">
                    <div class="stats-grid">
                        <div class="stat-item stat-active">
                            <div class="stat-number" id="stat-active">0</div>
                            <div class="stat-label">Ativos</div>
                        </div>
                        {% if user_permissions.canViewFinalizedRncs %}
                        <div class="stat-item stat-finalized">
                            <div class="stat-number" id="stat-finalized">0</div>
                            <div class="stat-label">Finalizados</div>
                        </div>
                        {% endif %}
                        
                    </div>
                </div>
                


                <!-- Aba Evidências (Percentuais mensais por responsável) -->
                <div id="evidenciasContainer" class="charts-container" style="display:none;">
                    <!-- Cabeçalho com gradiente e estatísticas -->
                    <div style="background:linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius:8px; padding:16px; margin-bottom:16px; color:white; box-shadow:0 4px 15px rgba(102,126,234,0.4);">
                        <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:12px;">
                            <div>
                                <h3 style="margin:0 0 4px 0; font-size:18px; font-weight:600;">📊 Evidências - Percentuais por Mês</h3>
                                <p id="evidenciasSubtitle" style="margin:0; font-size:12px; opacity:0.9;">Relatório de Não Conformidades - Engenharia</p>
                            </div>
                            <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
                                <select id="evidenciasYearSelect" style="padding:8px 12px; border:none; border-radius:6px; font-size:13px; background:rgba(255,255,255,0.95); cursor:pointer; font-weight:500;">
                                <option value="">Todos os Anos</option>
                            </select>
                                <button onclick="printEvidencias()" style="padding:8px 14px; border:none; border-radius:6px; background:#fff; color:#667eea; cursor:pointer; font-size:13px; font-weight:600; transition:all 0.3s; box-shadow:0 2px 8px rgba(0,0,0,0.15);" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">🖨️ Imprimir</button>
                                <button onclick="exportEvidenciasCSV()" style="padding:8px 14px; border:none; border-radius:6px; background:#198754; color:#fff; cursor:pointer; font-size:13px; font-weight:600; transition:all 0.3s;" onmouseover="this.style.background='#157347'" onmouseout="this.style.background='#198754'">📥 CSV</button>
                                <button onclick="refreshEvidencias()" style="padding:8px 14px; border:none; border-radius:6px; background:rgba(255,255,255,0.2); color:#fff; cursor:pointer; font-size:13px; font-weight:600; transition:all 0.3s; backdrop-filter:blur(10px);" onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">🔄 Atualizar</button>
                        </div>
                    </div>
                    
                        <!-- Cards de estatísticas rápidas -->
                        <div id="evidenciasStats" style="display:grid; grid-template-columns:repeat(auto-fit, minmax(140px, 1fr)); gap:10px; margin-top:16px;">
                            <!-- Será preenchido dinamicamente -->
                        </div>
                    </div>
                    
                    <!-- Info do Indicador (compacta e estilizada) -->
                    <div class="no-print" style="background:linear-gradient(to right, #f8f9fa, #e9ecef); border-left:4px solid #667eea; border-radius:6px; padding:10px 12px; margin-bottom:12px; font-size:11px; display:grid; grid-template-columns:repeat(auto-fit, minmax(140px, 1fr)); gap:10px; box-shadow:0 1px 3px rgba(0,0,0,0.1);">
                        <div><strong style="color:#667eea;">📋 Indicador:</strong> <span style="color:#495057;">RNC - Não Conformidade</span></div>
                        <div><strong style="color:#667eea;">🏢 Departamento:</strong> <span style="color:#495057;">Engenharia</span></div>
                        <div><strong style="color:#667eea;">👤 Responsável:</strong> <span style="color:#495057;">Guilherme / Cíntia</span></div>
                        <div><strong style="color:#667eea;">🎯 Meta:</strong> <span style="color:#495057;">30 RNCs/mês</span></div>
                        <div><strong style="color:#667eea;">💡 Objetivo:</strong> <span style="color:#495057;">Apontar não conformidades</span></div>
                        <div><strong style="color:#667eea;">📊 Parâmetro:</strong> <span style="color:#495057;">Quando - Melhor</span></div>
                    </div>
                    
                    <!-- Tabela de Evidências Mensais (compacta e moderna) -->
                    <div id="evidenciasTable" style="background:white; border-radius:8px; padding:16px; box-shadow:0 2px 12px rgba(0,0,0,0.08); overflow-x:auto;">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                            <h4 style="margin:0; color:#2c3e50; font-size:15px; font-weight:600;">📋 Percentuais de Cumprimento por Mês</h4>
                            <span id="evidenciasTableCount" style="background:#e9ecef; padding:4px 10px; border-radius:12px; font-size:11px; color:#495057; font-weight:600;"></span>
                        </div>
                        <div id="evidenciasTableContent">
                            <!-- Conteúdo será gerado dinamicamente -->
                        </div>
                    </div>
                    
                    <!-- Nova seção: Gráficos por Funcionário (compacto e moderno) -->
                    <div class="no-print" style="background:white; border-radius:8px; padding:16px; margin-top:12px; box-shadow:0 2px 12px rgba(0,0,0,0.08);">
                        <!-- Cabeçalho compacto -->
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px; flex-wrap:wrap; gap:10px;">
                            <div>
                                <h4 style="margin:0; color:#2c3e50; font-size:15px; font-weight:600;">👥 Desempenho por Funcionário</h4>
                                <p style="margin:2px 0 0 0; color:#6c757d; font-size:11px;">Análise individual de produtividade</p>
                            </div>
                            <div style="display:flex; gap:6px; align-items:center; flex-wrap:wrap;">
                                <select id="employeeYearSelect" onchange="loadEmployeePerformance()" style="padding:6px 10px; border:1px solid #dee2e6; border-radius:6px; font-size:12px; background:#fff; cursor:pointer;">
                                    <option value="">Carregando anos...</option>
                                </select>
                                <select id="employeeMonthSelect" onchange="loadEmployeePerformance()" style="padding:6px 10px; border:1px solid #dee2e6; border-radius:6px; font-size:12px; background:#fff; cursor:pointer;">
                                    <option value="">Carregando meses...</option>
                                </select>
                                <button onclick="loadEmployeePerformance()" style="padding:6px 12px; border:none; border-radius:6px; background:linear-gradient(135deg,#667eea,#764ba2); color:#fff; cursor:pointer; font-size:12px; font-weight:600; transition:all 0.3s;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">🔄</button>
                                <button onclick="forceUpdateSelectors()" style="padding:6px 12px; border:none; border-radius:6px; background:#28a745; color:#fff; cursor:pointer; font-size:12px; font-weight:600; transition:all 0.3s;" onmouseover="this.style.background='#218838'" onmouseout="this.style.background='#28a745'" title="Forçar atualização dos seletores de ano e mês">📅</button>
                            </div>
                        </div>
                        
                        <!-- Gráfico de Barras Horizontais com Percentuais (compacto) -->
                        <div style="margin-bottom:16px; background:#f8f9fa; border-radius:6px; padding:12px;">
                            <canvas id="employeePerformanceChart" height="250"></canvas>
                        </div>
                        
                        <!-- Tabela de dados detalhados (compacta) -->
                        <div id="employeePerformanceTable" style="margin-top:16px;">
                            <!-- Será preenchida dinamicamente -->
                        </div>
                    </div>
                    
                    <!-- Gráfico de Evolução (compacto) -->
                    <div class="no-print" style="background:white; border-radius:6px; padding:12px; margin-top:12px; box-shadow:0 2px 8px rgba(0,0,0,0.1);">
                        <h4 style="margin:0 0 12px 0; color:#333; font-size:14px;">📈 Evolução dos Percentuais</h4>
                        <canvas id="evidenciasChart" style="max-height:300px;"></canvas>
                    </div>
                </div>

                <!-- Aba Levantamento 14-15 (dashboard dinâmico) -->
                <div id="lev1415Container" class="charts-container" style="display:none;">
                    <div class="charts-header">
                        <h3>📑 Levantamento RNC 2014-2015</h3>
                        <div class="chart-controls" style="display:flex; gap:8px; align-items:center;">
                            <button onclick="exportLev1415CSV()" style="padding:8px 10px; border:none; border-radius:6px; background:#198754; color:#fff; cursor:pointer;">Exportar CSV</button>
                        </div>
                    </div>
                    <div class="charts-grid">
                        <div class="chart-card">
                            <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
                                <h4 style="margin:0;">💰 Total por Mês</h4>
                                <div style="display:flex; align-items:center; gap:8px;">
                                    <label for="levYearSelect" style="font-size:12px; color:#666; margin-right:6px;">Ano:</label>
                                    <select id="levYearSelect" onchange="loadLevByYear()" style="padding:6px 8px; border:1px solid #dee2e6; border-radius:6px;"></select>
                                    <button onclick="resetLevView()" style="padding:6px 10px; border:1px solid #6c757d; border-radius:6px; background:#f8f9fa; color:#6c757d; font-size:11px; cursor:pointer;" title="Voltar para visualização 2014-2015">
                                        🔄 Reset
                                    </button>
                                </div>
                            </div>
                            <canvas id="levTotalMes"></canvas>
                        </div>
                        <div class="chart-card">
                            <h4>🏭 Por Departamento (mês selecionado)</h4>
                            <canvas id="levPorDept"></canvas>
                        </div>
                    </div>
                    <!-- Nova seção para o gráfico de porcentagens anuais -->
                    <div class="charts-grid" style="margin-top:20px;">
                        <div class="chart-card">
                            <h4 id="deptPercentTitle">📊 Porcentagem por Departamento - Ano Completo</h4>
                            <div id="deptPercentLegend" style="display:flex; flex-wrap:wrap; margin:10px 0; gap:10px; justify-content:center; font-size:12px;"></div>
                            <canvas id="deptPercentChart" style="max-height:280px;"></canvas>
                        </div>
                        <div class="chart-card">
                            <h4>📈 Distribuição de RNCs por Departamento</h4>
                            <div id="deptPercentStats" style="font-size:14px; padding:10px;"></div>
                        </div>
                    </div>
                    <div class="chart-card" style="margin-top:12px;">
                        <h4 id="levTableTitle">📋 Tabela de Dados</h4>
                        <div id="lev1415TableWrap" style="overflow:auto;"></div>
                    </div>
                </div>

                <!-- Modal informações do Levantamento -->
                <div id="levInfoModal" class="modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.45); z-index:3000;">
                    <div style="background:#fff; border-radius:12px; width:90%; max-width:720px; margin:6% auto; box-shadow:0 10px 30px rgba(0,0,0,0.25);">
                        <div style="display:flex; justify-content:space-between; align-items:center; padding:14px 18px; border-bottom:1px solid #e9ecef;">
                            <h3 style="margin:0; color:#333;">📄 Informações — Levantamento RNC e Garantias 14-15</h3>
                            <button onclick="closeLevInfo()" style="background:#dc3545; color:#fff; border:none; border-radius:6px; padding:6px 10px; cursor:pointer;">Fechar</button>
                        </div>
                        <div id="levInfoBody" style="padding:16px; max-height:60vh; overflow:auto; color:#495057; line-height:1.6;">
                             <div id="levInfoPlaceholder" style="text-align:center; color:#6c757d;">Nenhuma informação cadastrada. Clique em "Editar" ou em "Carregar TXT".</div>
                        </div>
                        <div style="display:flex; justify-content:flex-end; gap:8px; padding:12px 16px; border-top:1px solid #e9ecef;">
                            <button onclick="editLevInfo()" style="background:linear-gradient(135deg,#dc3545,#b21f35); color:#fff; border:none; border-radius:6px; padding:8px 12px; cursor:pointer;">Editar</button>
                            <button onclick="exportLevInfo()" style="background:#198754; color:#fff; border:none; border-radius:6px; padding:8px 12px; cursor:pointer;">Exportar TXT</button>
                        </div>
                    </div>
                </div>

                <!-- Modal de detalhes/gráficos do Levantamento -->
                <div id="levDetailModal" class="modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:4000;">
                    <div style="background:#fff; border-radius:14px; width:95%; max-width:900px; margin:4% auto; box-shadow:0 20px 60px rgba(0,0,0,0.3);">
                        <div style="display:flex; justify-content:space-between; align-items:center; padding:14px 18px; border-bottom:1px solid #e9ecef;">
                            <h3 id="levDetailTitle" style="margin:0; color:#333;">Detalhes do Levantamento</h3>
                            <button onclick="closeLevDetail()" style="background:#dc3545; color:#fff; border:none; border-radius:6px; padding:6px 10px; cursor:pointer;">Fechar</button>
                        </div>
                        <div style="padding:16px; max-height:70vh; overflow:auto;">
                            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap:16px;">
                                <div style="background:#f8f9fa; border:1px solid #e9ecef; border-radius:10px; padding:12px;">
                                    <h4 style="margin:0 0 8px 0; color:#495057;">Status</h4>
                                    <canvas id="levStatusChart"></canvas>
                                </div>
                                <div style="background:#f8f9fa; border:1px solid #e9ecef; border-radius:10px; padding:12px;">
                                    <h4 style="margin:0 0 8px 0; color:#495057;">Prioridade</h4>
                                    <canvas id="levPriorityChart"></canvas>
                                </div>
                                <div style="grid-column: 1 / -1; background:#f8f9fa; border:1px solid #e9ecef; border-radius:10px; padding:12px;">
                                    <h4 style="margin:0 0 8px 0; color:#495057;">RNCs por Mês</h4>
                                    <canvas id="levMonthlyChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Charts específicos da aba RNCs por Setor (acima da tabela) -->
            <div id="setoresCharts" style="display:none; margin:10px 0 18px 0;">
                <!-- Seletor de Setor -->
                <div style="background:#fff; border-radius:12px; padding:14px 16px; box-shadow:0 2px 10px rgba(0,0,0,0.06); margin-bottom:14px;">
                    <div style="display:flex; gap:10px; align-items:center;">
                        <label for="setorSelect" style="font-weight:600; font-size:14px; color:#333;">📊 Selecione o Setor:</label>
                        <select id="setorSelect" style="padding:8px 12px; border:1px solid #ccc; border-radius:8px; font-size:14px; flex:1; max-width:300px;" onchange="loadSetorData()">
                            <option value="">Selecione...</option>
                            <option value="engenharia">🔧 Engenharia</option>
                            <option value="producao">🏭 Produção</option>
                            <option value="pcp">📋 PCP</option>
                            <option value="qualidade">✅ Qualidade</option>
                            <option value="compras">🛒 Compras</option>
                            <option value="comercial">💼 Comercial</option>
                            <option value="terceiros">🤝 Terceiros</option>
                            <optgroup label="Setores de Produção">
                                <option value="usinagem_plana">🔨 Usinagem Plana</option>
                                <option value="usin_cilindrica_cnc">⚙️ Usin. Cilíndrica CNC</option>
                                <option value="usin_cilindrica_convencional">🔧 Usin. Cilíndrica Convencional</option>
                                <option value="caldeiraria_carbono">🔥 Caldeiraria de Carbono</option>
                                <option value="caldeiraria_inox">✨ Caldeiraria de Inox</option>
                                <option value="corte">✂️ Corte</option>
                                <option value="montagem">🔩 Montagem</option>
                                <option value="pintura">🎨 Pintura</option>
                                <option value="balanceamento">⚖️ Balanceamento</option>
                            </optgroup>
                        </select>
                    </div>
                </div>
                
                <!-- Bloco de Informações do Indicador (exibido acima dos gráficos) -->
                <div id="setorIndicadorInfo" style="background:#fff; border-radius:12px; padding:10px 14px; box-shadow:0 2px 8px rgba(0,0,0,0.05); margin-bottom:12px; font-size:12px; line-height:1.3; color:#333; display:none; flex-wrap:wrap; gap:14px;">
                    <div style="min-width:120px;"><strong>Indicador:</strong><br>RNC - Relatório de Não Conformidade</div>
                    <div style="min-width:160px;"><strong>Objetivo:</strong><br>Apontar a quantidade de não conformidades e revisões</div>
                    <div style="min-width:110px;"><strong>Departamento:</strong><br><span id="setorNome">-</span></div>
                    <div style="min-width:90px;"><strong>Área:</strong><br>Corporativo</div>
                    <div style="min-width:80px;"><strong>Unidade:</strong><br>UN</div>
                    <div style="min-width:70px;"><strong>Meta:</strong><br><span id="setorMeta">30</span></div>
                    <div style="min-width:90px;" id="setorInfoRealizado"><strong>Realizado:</strong><br><span id="setorInfoRealizadoVal">--</span></div>
                    <div style="min-width:90px;" id="setorInfoVariacao"><strong>Variação:</strong><br><span id="setorInfoVariacaoVal">--</span></div>
                </div>
                
                <!-- Gráfico Mensal -->
                <div id="setorChartsContainer" style="display:none;">
                <div style="background:#fff; border-radius:12px; padding:14px 16px; box-shadow:0 2px 10px rgba(0,0,0,0.06); margin-bottom:14px;">
                    <div style="display:flex; flex-wrap:wrap; gap:10px; justify-content:space-between; align-items:center;">
                            <h3 style="margin:0; display:flex; align-items:center; gap:8px; font-size:16px; color:#333;">
                                <span id="setorTitle">📊 RNCs Mensais por Setor</span>
                                <span style="font-size:11px; font-weight:400; color:#666;">(Barra=Realizado • Verde=Meta • Azul=Acum.)</span>
                            </h3>
                        <div style="display:flex; gap:6px; align-items:center; font-size:12px;">
                                <label for="setorMonthSelect" style="color:#555;">Mês:</label>
                                <select id="setorMonthSelect" style="padding:4px 6px; border:1px solid #ccc; border-radius:6px; font-size:12px;" onchange="updateSetorMonth()">
                                <option value="">Todos</option>
                            </select>
                                <button onclick="resetSetorSelection()" style="padding:4px 8px; border:none; background:linear-gradient(135deg,#dc3545,#b21f35); color:#fff; border-radius:6px; font-size:12px; cursor:pointer;">Reset</button>
                        </div>
                    </div>
                        <canvas id="setorMonthlyChart" height="170"></canvas>
                </div>
                <div style="background:#fff; border-radius:12px; padding:14px 16px; box-shadow:0 2px 10px rgba(0,0,0,0.06); display:grid; gap:12px;">
                    <h3 style="margin:0; font-size:16px; color:#333;">📊 Acumulado vs Meta</h3>
                        <canvas id="setorAccumChart" height="170"></canvas>
                    <div style="border-top:1px solid #eee; margin-top:8px; padding-top:8px;">
                        <h4 style="margin:0 0 6px 0; font-size:13px; color:#444;">🔍 Detalhe do Mês Selecionado (dias)</h4>
                            <canvas id="setorMonthDetailChart" height="110"></canvas>
                    </div>
                        <div id="setorMonthInfo" style="font-size:12px; color:#555; line-height:1.4;"></div>
                    </div>
                </div>
            </div>
            <!-- Grid de RNCs -->
            <div id="rncGrid" class="rnc-grid">
                <div class="loading">
                    <div>🔄 Carregando RNCs...</div>
                </div>
            </div>
        </div>
        
        <div class="right-section">
            <h2 style="margin-bottom: 20px; color: #333;">📊 Dashboard</h2>
            
            <!-- Notificações -->
            <div id="notificationsContainer" style="margin-bottom: 20px; display: none;">
                <div style="background: white; border-radius: 12px; padding: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <h3 style="color: #333; font-size: 16px;">🔔 Notificações</h3>
                        <button onclick="markAllNotificationsRead()" style="
                            background: #6c757d;
                            color: white;
                            border: none;
                            padding: 5px 10px;
                            border-radius: 5px;
                            font-size: 12px;
                            cursor: pointer;
                        ">Marcar todas</button>
                    </div>
                    <div id="notificationsList" style="max-height: 200px; overflow-y: auto;">
                        <!-- Notificações serão inseridas aqui -->
                    </div>
                </div>
            </div>
            
            <!-- Botões de Ação -->
            <div style="margin-bottom: 30px; display: flex; flex-direction: column; gap: 10px;">
                {% if user_permissions and user_permissions.canCreateRnc %}
                <button onclick="window.location.href='/form'" style="
                    width: 100%;
                    padding: 15px;
                    background: linear-gradient(135deg, #dc3545, #b21f35);
                    color: white;
                    border: none;
                    border-radius: 12px;
                    font-size: 16px;
                    font-weight: 600;
                    cursor: pointer;
                    transition: all 0.3s ease;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    gap: 10px;
                ">
                    ➕ Novo RNC
                </button>
                {% endif %}
                {% if user_permissions and user_permissions.canViewCharts %}
                <button onclick="window.location.href='/chat'" style="
                    width: 100%;
                    padding: 15px;
                    background: linear-gradient(135deg, #dc3545, #b21f35);
                    color: white;
                    border: none;
                    border-radius: 12px;
                    font-size: 16px;
                    font-weight: 600;
                    cursor: pointer;
                    transition: all 0.3s ease;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    gap: 10px;
                ">
                    💬 Mensagens
                </button>
                {% endif %}
                
                <!-- Botão de Atualizar sempre visível -->
                <button onclick="forceRefreshDashboard()" style="
                    width: 100%;
                    padding: 12px;
                    background: linear-gradient(135deg, #6c757d, #495057);
                    color: white;
                    border: none;
                    border-radius: 12px;
                    font-size: 14px;
                    font-weight: 600;
                    cursor: pointer;
                    transition: all 0.3s ease;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    gap: 8px;
                ">
                    🔄 Atualizar Dashboard
                </button>
            </div>
            
            <!-- Informações do Sistema -->
            <div style="background: white; border-radius: 12px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                <h3 style="margin-bottom: 15px; color: #333;">ℹ️ Informações</h3>
                <div style="font-size: 14px; line-height: 1.6; color: #666;">
                    <p><strong>RNCs Finalizados:</strong> Movidos para histórico após conclusão</p>
                    <p><strong>Exclusão:</strong> Agora é definitiva (sem lixeira)</p>
                </div>
            </div>

            
            
            <!-- Ações Rápidas -->
            <div style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                <h3 style="margin-bottom: 15px; color: #333;">⚡ Ações Rápidas</h3>
                <div style="display: flex; flex-direction: column; gap: 10px;">
                    <button id="manageUsersBtn" onclick="window.location.href='/admin/users'" style="
                        padding: 10px;
                        background: #17a2b8;
                        color: white;
                        border: none;
                        border-radius: 8px;
                        cursor: pointer;
                        font-size: 14px;
                        display: flex;
                        align-items: center;
                        gap: 8px;
                        display: none;
                    ">
                        👥 Gerenciar Usuários
                    </button>
                    <button id="manageGroupsBtn" onclick="window.location.href='/admin/groups'" style="
                        padding: 10px;
                        background: #28a745;
                        color: white;
                        border: none;
                        border-radius: 8px;
                        cursor: pointer;
                        font-size: 14px;
                        display: flex;
                        align-items: center;
                        gap: 8px;
                        display: none;
                    ">
                        👥 Gerenciar Grupos
                    </button>
                    <button id="managePermissionsBtn" onclick="window.location.href='/admin/permissions'" style="
                        padding: 10px;
                        background: linear-gradient(135deg, #6f42c1, #563d7c);
                        color: white;
                        border: none;
                        border-radius: 10px;
                        cursor: pointer;
                        font-size: 14px;
                        display: flex;
                        align-items: center;
                        gap: 8px;
                        box-shadow: 0 8px 20px rgba(111, 66, 193, 0.25);
                        transition: transform .15s ease, box-shadow .15s ease;
                        display: none;
                    " onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 10px 22px rgba(111,66,193,.3)';" onmouseout="this.style.transform=''; this.style.boxShadow='0 8px 20px rgba(111,66,193,.25)';">
                        🔐 Gerenciar Permissões
                    </button>
                    <button id="manageFieldLocksBtn" onclick="window.location.href='/admin/field-locks/'" style="
                        padding: 10px;
                        background: linear-gradient(135deg, #e74c3c, #c0392b);
                        color: white;
                        border: none;
                        border-radius: 10px;
                        cursor: pointer;
                        font-size: 14px;
                        display: none;
                        align-items: center;
                        gap: 8px;
                        box-shadow: 0 8px 20px rgba(231, 76, 60, 0.25);
                        transition: transform .15s ease, box-shadow .15s ease;
                    " onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 10px 22px rgba(231,76,60,.3)';" onmouseout="this.style.transform=''; this.style.boxShadow='0 8px 20px rgba(231,76,60,.25)';">
                        🔒 Gerenciar Permissões Criação RNC
                    </button>
                    <button id="manageClientsBtn" onclick="window.location.href='/admin/clients'" style="
                        padding: 10px;
                        background: #8b1538;
                        color: white;
                        border: none;
                        border-radius: 8px;
                        cursor: pointer;
                        font-size: 14px;
                        display: flex;
                        align-items: center;
                        gap: 8px;
                        display: none;
                    ">
                        🏷️ Cadastro de Clientes
                    </button>
                    <button id="manageOperatorsBtn" onclick="window.location.href='/admin/operators'" style="
                        padding: 10px;
                        background: #5b21b6;
                        color: white;
                        border: none;
                        border-radius: 8px;
                        cursor: pointer;
                        font-size: 14px;
                        display: flex;
                        align-items: center;
                        gap: 8px;
                        display: none;
                    ">
                        ⏱️ Cadastro de Operador
                    </button>
                    <button id="manageAreasBtn" onclick="window.location.href='/admin/areas'" style="
                        padding: 10px;
                        background: linear-gradient(135deg, #6f42c1, #4b2ca1);
                        color: white;
                        border: none;
                        border-radius: 10px;
                        cursor: pointer;
                        font-size: 14px;
                        display: flex;
                        align-items: center;
                        gap: 8px;
                        box-shadow: 0 8px 20px rgba(111, 66, 193, 0.25);
                        transition: transform .15s ease, box-shadow .15s ease;
                        display: none;
                    " onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 10px 22px rgba(111,66,193,.3)';" onmouseout="this.style.transform=''; this.style.boxShadow='0 8px 20px rgba(111,66,193,.25)';">
                        🧭 Cadastro de Área
                    </button>
                    <button id="manageSectorsBtn" onclick="window.location.href='/admin/sectors'" style="
                        padding: 10px;
                        background: linear-gradient(135deg, #5b21b6, #4c1d95);
                        color: white;
                        border: none;
                        border-radius: 10px;
                        cursor: pointer;
                        font-size: 14px;
                        display: flex;
                        align-items: center;
                        gap: 8px;
                        box-shadow: 0 8px 20px rgba(91, 33, 182, 0.25);
                        transition: transform .15s ease, box-shadow .15s ease;
                        display: none;
                    " onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 10px 22px rgba(91,33,182,.3)';" onmouseout="this.style.transform=''; this.style.boxShadow='0 8px 20px rgba(91,33,182,.25)';">
                        🏗️ Cadastro de Setor
                    </button>
                                                <button id="generateReportBtn" onclick="window.location.href='/reports/menu'" style="
                        padding: 10px;
                        background: linear-gradient(135deg, #dc3545, #c82333);
                        color: white;
                        border: none;
                        border-radius: 10px;
                        cursor: pointer;
                        font-size: 14px;
                        display: none;
                        align-items: center;
                        gap: 8px;
                        box-shadow: 0 8px 20px rgba(220, 53, 69, 0.25);
                        transition: transform .15s ease, box-shadow .15s ease;
                    " onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 10px 22px rgba(220,53,69,.3)';" onmouseout="this.style.transform=''; this.style.boxShadow='0 8px 20px rgba(220,53,69,.25)';">
                        📊 Gerar Relatório
                    </button>
                    <button id="expensesReportBtn" onclick="window.location.href='/dashboard/expenses'" style="
                        padding: 10px;
                        background: linear-gradient(135deg, #28a745, #20c997);
                        color: white;
                        border: none;
                        border-radius: 10px;
                        cursor: pointer;
                        font-size: 14px;
                        display: none;
                        align-items: center;
                        gap: 8px;
                        box-shadow: 0 8px 20px rgba(40, 167, 69, 0.25);
                        transition: transform .15s ease, box-shadow .15s ease;
                    " onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 10px 22px rgba(40,167,69,.3)';" onmouseout="this.style.transform=''; this.style.boxShadow='0 8px 20px rgba(40,167,69,.25)';">
                        💰 Gastos por Funcionário
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
            async function loadLevFromTxt() {
                try {
                    const base = window.location.origin.replace(/^https:/,'http:');
                    const resp = await fetch(base + '/api/levantamentos/ano-sumario?file=' + encodeURIComponent('relatorio rnc 14-15.txt'), { credentials: 'include' });
                    const data = await resp.json();
                    if (!data.success) throw new Error('Falha ao carregar levantamento');
                    renderLevInfo(data.data);
                    // Preencher tabela com dados agregados
                    const cont = document.getElementById('levTableContainer');
                    const d = data.data || {};
                    const status = d.por_status || {};
                    const prioridade = d.por_prioridade || {};
                    const porMes = d.por_mes || {};
                    const rows = [];
                    rows.push(`<tr><th style="text-align:left; padding:6px;">Período</th><td style="padding:6px;">${d.periodo || '—'}</td></tr>`);
                    rows.push(`<tr><th style="text-align:left; padding:6px;">Total RNCs</th><td style="padding:6px;">${d.total || 0}</td></tr>`);
                    rows.push(`<tr><th style="text-align:left; padding:6px;">Por Status</th><td style="padding:6px;">${Object.keys(status).map(k=>`${k}: ${status[k]}`).join(' | ') || '—'}</td></tr>`);
                    rows.push(`<tr><th style="text-align:left; padding:6px;">Por Prioridade</th><td style="padding:6px;">${Object.keys(prioridade).map(k=>`${k}: ${prioridade[k]}`).join(' | ') || '—'}</td></tr>`);
                    rows.push(`<tr><th style="text-align:left; padding:6px;">Por Mês</th><td style="padding:6px;">${Object.keys(porMes).map(k=>`${k}: ${porMes[k]}`).join(' | ') || '—'}</td></tr>`);
                    cont.innerHTML = `<div style="overflow:auto;"><table style="width:100%; border-collapse:collapse; font-size:14px;"><tbody>${rows.join('')}</tbody></table></div>`;
                    showLevTable();
                    renderLevCards(d);
                } catch (e) {
                    alert('Erro ao carregar TXT: ' + (e && e.message ? e.message : e));
                }
            }
            
            function renderLevInfo(d) {
                const el = document.getElementById('levInfoBody');
                const ph = document.getElementById('levInfoPlaceholder');
                if (!d) { if (ph) ph.style.display='block'; return; }
                if (ph) ph.style.display='none';
                const status = d.por_status || {};
                const prioridade = d.por_prioridade || {};
                const porMes = d.por_mes || {};
                el.innerHTML = `
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px;">
                        <div style="background:#f8f9fa; border:1px solid #e9ecef; border-radius:8px; padding:10px;">
                            <div><strong>Período:</strong> ${d.periodo || '—'}</div>
                            <div><strong>Total RNCs:</strong> ${d.total || 0}</div>
                        </div>
                        <div style="background:#f8f9fa; border:1px solid #e9ecef; border-radius:8px; padding:10px;">
                            <div><strong>Por Status:</strong></div>
                            <div>${Object.keys(status).map(k=>`<span style='display:inline-block; margin:2px 6px 2px 0; padding:3px 8px; background:#e9ecef; border-radius:999px;'>${k}: ${status[k]}</span>`).join('')}</div>
                            <div style="margin-top:6px;"><strong>Por Prioridade:</strong></div>
                            <div>${Object.keys(prioridade).map(k=>`<span style='display:inline-block; margin:2px 6px 2px 0; padding:3px 8px; background:#e9ecef; border-radius:999px;'>${k}: ${prioridade[k]}</span>`).join('')}</div>
                        </div>
                        <div style="grid-column: 1 / -1; background:#f8f9fa; border:1px solid #e9ecef; border-radius:8px; padding:10px;">
                            <div style="margin-bottom:6px;"><strong>Por Mês:</strong></div>
                            <div>${Object.keys(porMes).map(k=>`<span style='display:inline-block; margin:2px 6px 2px 0; padding:3px 8px; background:#e9ecef; border-radius:999px;'>${k}: ${porMes[k]}</span>`).join('')}</div>
                        </div>
                    </div>
                `;
            }
            function renderLevCards(d) {
                const grid = document.getElementById('levCardsGrid');
                if (!grid) return;
                const status = d.por_status || {};
                const prioridade = d.por_prioridade || {};
                const total = d.total || 0;
                const periodo = d.periodo || '—';
                const cards = [];
                cards.push(`
                    <div class="rnc-card completed" onclick="openLevDetail()">
                        <div class="card-header">
                            <div class="profile-icon">📑</div>
                            <div class="card-info">
                                <div class="card-name" title="Levantamento Anual">Levantamento Anual</div>
                                <div class="card-dept" title="Período">📅 ${periodo}</div>
                                <div class="card-assigned" title="Total RNCs">📊 Total: ${total}</div>
                            </div>
                            <div class="card-status status-completed">Levantamento</div>
                        </div>
                        <div class="card-details">
                            <div class="detail-row"><span class="detail-label">Status:</span>
                                <span class="detail-value">${Object.keys(status).map(k=>`${k}: ${status[k]}`).join(' | ') || '—'}</span></div>
                            <div class="detail-row"><span class="detail-label">Prioridade:</span>
                                <span class="detail-value">${Object.keys(prioridade).map(k=>`${k}: ${prioridade[k]}`).join(' | ') || '—'}</span></div>
                        </div>
                        <div class="card-actions">
                            <button onclick="event.stopPropagation(); openLevDetail()" class="action-btn btn-primary">👁️ Ver Detalhes</button>
                            <button onclick="event.stopPropagation(); openLevInfo()" class="action-btn btn-secondary">ℹ️ Informações</button>
                        </div>
                    </div>
                `);
                grid.innerHTML = cards.join('');
            }
            function openLevDetail() {
                const modal = document.getElementById('levDetailModal');
                if (!modal) return; modal.style.display = 'block';
                try {
                    const base = window.location.origin.replace(/^https:/,'http:');
                    fetch(base + '/api/levantamentos/ano-sumario?file=' + encodeURIComponent('relatorio rnc 14-15.txt'), { credentials: 'include' })
                        .then(r => r.json()).then(({data}) => { if (data) createLevCharts(data); });
                } catch {}
            }
            function closeLevDetail() { const modal = document.getElementById('levDetailModal'); if (modal) modal.style.display = 'none'; }
            function createLevCharts(d) {
                const status = d.por_status || {};
                const prioridade = d.por_prioridade || {};
                const months = d.por_mes || {};
                if (window._levStatus) window._levStatus.destroy();
                if (window._levPriority) window._levPriority.destroy();
                if (window._levMonthly) window._levMonthly.destroy();
                const stx = document.getElementById('levStatusChart')?.getContext('2d');
                if (stx) window._levStatus = new Chart(stx, { type: 'doughnut', data:{ labels:Object.keys(status), datasets:[{ data:Object.values(status), backgroundColor:['#ffc107','#17a2b8','#007bff','#28a745','#6c757d'] }] }, options:{ responsive:true, maintainAspectRatio:false } });
                const ptx = document.getElementById('levPriorityChart')?.getContext('2d');
                if (ptx) window._levPriority = new Chart(ptx, { type: 'bar', data:{ labels:Object.keys(prioridade), datasets:[{ data:Object.values(prioridade), backgroundColor:['#28a745','#ffc107','#fd7e14','#dc3545'] }] }, options:{ responsive:true, maintainAspectRatio:false } });
                const mtx = document.getElementById('levMonthlyChart')?.getContext('2d');
                if (mtx) window._levMonthly = new Chart(mtx, { type: 'line', data:{ labels:Object.keys(months), datasets:[{ label:'RNCs', data:Object.values(months), borderColor:'#0d6efd', backgroundColor:'rgba(13,110,253,0.1)', tension:.4 }] }, options:{ responsive:true, maintainAspectRatio:false } });
            }
        let currentTab = 'active';
        let rncsData = { 
            active: [], 
            {% if user_permissions.canViewEngineeringRncs %}
            engenharia: [], 
            {% endif %}
            finalized: [] 
        };
        
        // Variáveis para filtros
        let currentFilters = {
            rncNumber: '',
            client: '',
            equipment: '',
            department: ''
        };
        let filteredRNCs = [];
        
        // Carregar informações do usuário
        async function loadUserInfo() {
            console.log('👤 Iniciando carregamento de informações do usuário...');
            try {
                console.log('📡 Fazendo requisição para /api/user/info...');
                const response = await fetch('/api/user/info', { credentials: 'include' });
                console.log(`📊 Resposta recebida - Status: ${response.status}`);
                
                const data = await response.json();
                console.log('📋 Dados do usuário recebidos:', data);
                
                if (data && data.success) {
                    console.log(`✅ Usuário carregado: ${data.user.name} (${data.user.department})`);
                    
                    const userNameElement = document.getElementById('userName');
                    const userDepartmentElement = document.getElementById('userDepartment');
                    const userAvatarElement = document.getElementById('userAvatar');
                    
                    if (userNameElement) userNameElement.textContent = data.user.name;
                    if (userDepartmentElement) userDepartmentElement.textContent = data.user.department;
                    if (userAvatarElement) {
                        window.__USER_NAME__ = data.user.name || '';
                        const avKey = (data.user.avatar || 'ava-ippel');
                        const avPrefs = (data.user.avatarPrefs || null);
                        // Aplicar avatar animado se o helper estiver disponível
                        if (window.IPPELAvatar && typeof IPPELAvatar.applyToHeader === 'function') {
                            IPPELAvatar.applyToHeader(avKey, avPrefs);
                        } else {
                            // Fallback: ajustar classes manualmente
                            userAvatarElement.className = 'user-avatar ava ' + avKey;
                            userAvatarElement.textContent = (window.__USER_NAME__||'U').charAt(0).toUpperCase();
                        }
                    }
                    
                    // Verificar permissões para mostrar botões específicos
                    const role = (data.user.role || '').toLowerCase();
                    const perms = (data.user.permissions || []).map(p => (p || '').toLowerCase());
                    if (role === 'admin' || perms.includes('manage_users')) {
                        const manageUsersBtn = document.getElementById('manageUsersBtn');
                        const manageGroupsBtn = document.getElementById('manageGroupsBtn');
                        const managePermissionsBtn = document.getElementById('managePermissionsBtn');
                        const manageFieldLocksBtn = document.getElementById('manageFieldLocksBtn');
                        const manageClientsBtn = document.getElementById('manageClientsBtn');
                        const manageAreasBtn = document.getElementById('manageAreasBtn');
                        const manageOperatorsBtn = document.getElementById('manageOperatorsBtn');
                        const manageSectorsBtn = document.getElementById('manageSectorsBtn');
                        const generateReportBtn = document.getElementById('generateReportBtn');
                        const expensesReportBtn = document.getElementById('expensesReportBtn');
                        
                        if (manageUsersBtn) manageUsersBtn.style.display = 'flex';
                        if (manageGroupsBtn) manageGroupsBtn.style.display = 'flex';
                        if (managePermissionsBtn) managePermissionsBtn.style.display = 'flex';
                        if (manageFieldLocksBtn) {
                            manageFieldLocksBtn.style.display = 'flex';
                            console.log('✅ Botão Permissões Criação RNC ativado');
                        } else {
                            console.log('❌ Botão manageFieldLocksBtn não encontrado');
                        }
                        if (manageClientsBtn) manageClientsBtn.style.display = 'flex';
                        if (manageAreasBtn) manageAreasBtn.style.display = 'flex';
                        if (manageOperatorsBtn) manageOperatorsBtn.style.display = 'flex';
                        if (manageSectorsBtn) manageSectorsBtn.style.display = 'flex';
                        if (generateReportBtn) generateReportBtn.style.display = 'flex';
                        if (expensesReportBtn) expensesReportBtn.style.display = 'flex';
                        
                        console.log('🔐 Usuário tem permissões de administrador');
                    }
                    // Flag global e permissões detalhadas para uso em botões/ações
                    window.isAdmin = (role === 'admin' || perms.includes('manage_users'));
                    window.currentUserId = data.user.id;
                    window.userPerms = (data.user.departmentPermissions || {});
                    // Mostrar botões adicionais conforme permissões não-admin
                    if (perms.includes('view_clients_admin') || perms.includes('view_operators_admin') || perms.includes('manage_areas') || perms.includes('view_areas_admin') || perms.includes('manage_sectors') || perms.includes('view_sectors_admin')) {
                        const manageClientsBtn = document.getElementById('manageClientsBtn');
                        const manageAreasBtn = document.getElementById('manageAreasBtn');
                        const manageOperatorsBtn = document.getElementById('manageOperatorsBtn');
                        const manageSectorsBtn = document.getElementById('manageSectorsBtn');
                        if (manageClientsBtn && perms.includes('view_clients_admin')) manageClientsBtn.style.display = 'flex';
                        if (manageOperatorsBtn && perms.includes('view_operators_admin')) manageOperatorsBtn.style.display = 'flex';
                        if (manageAreasBtn && (perms.includes('manage_areas') || perms.includes('view_areas_admin'))) manageAreasBtn.style.display = 'flex';
                        if (manageSectorsBtn && (perms.includes('manage_sectors') || perms.includes('view_sectors_admin'))) manageSectorsBtn.style.display = 'flex';
                    }
                } else {
                    console.error('❌ Erro na resposta da API:', data && data.message);
                    // evita loop de redirect se sessão não existir
                    const el = document.getElementById('userName');
                    if (el) el.textContent = 'Não autenticado';
                }
            } catch (error) {
                console.error('❌ Erro ao carregar informações do usuário:', error);
                const el = document.getElementById('userName');
                if (el) el.textContent = 'Não autenticado';
            }
        }
        

        

        
    // Estado de paginação do dashboard melhorado
    let __nextCursor = null;
    let __hasMore = false;
    let __isLoading = false;
    const __PAGE_LIMIT = 50000;

    // Carregar RNCs
    async function loadRNCs(tab = 'finalized', forceRefresh = false) {
            console.log(`🔄 Carregando RNCs para aba: ${tab} ${forceRefresh ? '(FORCE REFRESH)' : ''}`);
            currentTab = tab;
            
            try {
                // Se for aba Setores, não carregar nada até selecionar um setor
                if (tab === 'setores') {
                    console.log('📊 Aba setores ativada. Aguardando seleção de setor...');
                    rncsData[tab] = [];
                    updateTotalCount(0);
                    renderRNCs(tab);
                    return;
                }
                
                // Se for aba Engenharia (legado), redirecionar para setores
                    if (tab === 'engenharia') {
                        console.log('🔧 Carregando dados específicos da engenharia...');
                        try {
                            const engineeringResponse = await fetch('/api/indicadores/engenharia');
                        console.log('🔧 [DEBUG] Response status:', engineeringResponse.status);
                            const engineeringData = await engineeringResponse.json();
                        console.log('🔧 [DEBUG] Dados recebidos:', engineeringData);
                            
                            if (engineeringData.success) {
                                console.log('📊 Dados da engenharia recebidos:', engineeringData);
                            console.log('📊 [DEBUG] Total RNCs engenharia:', engineeringData.rncs_count);
                            
                            // Construir gráficos
                                buildEngineeringCharts(engineeringData);
                            
                            // IMPORTANTE: Usar APENAS os dados da API de engenharia
                                rncsData[tab] = engineeringData.rncs || [];
                            console.log(`✅ ${rncsData[tab].length} RNCs da engenharia carregados`);
                            
                            // Atualizar contador no topo da página
                            updateTotalCount(rncsData[tab].length);
                            
                            // Renderizar tabela
                            renderRNCs(tab);
                            
                            // Atualizar TODOS os badges (incluindo engenharia)
                                    updateCounts();
                            
                            // GARANTIR que o badge de engenharia está correto (após updateCounts)
                                    const badge = document.getElementById('count-engenharia');
                            if (badge) {
                                badge.textContent = rncsData[tab].length;
                                console.log(`✅ Badge de engenharia atualizado para: ${rncsData[tab].length}`);
                                    }
                            } else {
                                console.error('❌ Erro ao carregar dados da engenharia:', engineeringData.message);
                                rncsData[tab] = [];
                            updateTotalCount(0);
                            renderRNCs(tab);
                            }
                        } catch (error) {
                            console.error('❌ Erro na API da engenharia:', error);
                            rncsData[tab] = [];
                        updateTotalCount(0);
                        renderRNCs(tab);
                    }
                    return; // Sair da função, não continuar com /api/rnc/list
                }
                
                // Para outras abas, usar /api/rnc/list
                const apiTab = tab;
                console.log(`📡 Fazendo requisição para: /api/rnc/list?tab=${apiTab}&limit=${__PAGE_LIMIT}`);
                const url = `/api/rnc/list?tab=${encodeURIComponent(apiTab)}&limit=${__PAGE_LIMIT}${forceRefresh ? '&_t=' + Date.now() : ''}`;
                const response = await fetch(url, { 
                    credentials: 'include',
                    cache: forceRefresh ? 'no-cache' : 'default',
                    headers: forceRefresh ? {
                        'Cache-Control': 'no-cache, no-store, must-revalidate',
                        'Pragma': 'no-cache',
                        'Expires': '0'
                    } : {}
                });
                console.log(`📊 Resposta recebida - Status: ${response.status}`);
                
                const data = await response.json();
                console.log(`📋 Dados recebidos:`, data);
                
                if (data.success) {
                    __nextCursor = data.next_cursor || null;
                    __hasMore = !!data.has_more;
                        rncsData[tab] = data.rncs;
                        console.log(`✅ RNCs carregados para ${tab}: ${data.rncs.length} itens`);
                    
                    // Debug adicional: verificar tipos de dados carregados
                    if (data.rncs.length > 0) {
                        const sample = data.rncs[0];
                        console.log(`📋 Amostra de dados para ${tab}:`, {
                            id: sample.id,
                            status: sample.status,
                            finalized_at: sample.finalized_at
                        });
                    }
                    
                    // Salvar no cache
                    if (data.rncs && data.rncs.length >= 0) {
                        saveDashboardCache({ user: null, rncs: rncsData });
                    }
                    
                    // Aplicar filtros se necessário
                    if (tab === 'finalized' && (currentFilters.rncNumber || currentFilters.client || currentFilters.equipment || currentFilters.department)) {
                        console.log(`🔍 Aplicando filtros para aba finalizados`);
                        applyFilters();
                    } else {
                        console.log(`🎨 Renderizando RNCs para aba ${tab}`);
                        renderRNCs(tab);
                        renderImprovedLoadMore();
                    }
                    updateCounts();
                } else {
                    console.error('❌ Erro ao carregar RNCs:', data.message);
                    if (!rncsData[tab] || rncsData[tab].length === 0) {
                        try { renderRNCs(tab, []); } catch (_) {}
                    }
                    renderImprovedLoadMore();
                }
            } catch (error) {
                console.error('❌ Erro ao carregar RNCs:', error);
                if (!rncsData[tab] || rncsData[tab].length === 0) {
                    try { renderRNCs(tab, []); } catch (_) {}
                }
                renderImprovedLoadMore();
            }
        }
        
        // Expor loadRNCs globalmente
        window.loadRNCs = loadRNCs;

        async function loadMoreImproved() {
            if (!__hasMore || __isLoading) return;
            __isLoading = true;
            renderImprovedLoadMore();
            const apiTab = currentTab === 'engenharia' ? 'finalized' : currentTab;
            const url = `/api/rnc/list?tab=${encodeURIComponent(apiTab)}&limit=${__PAGE_LIMIT}${__nextCursor ? `&cursor=${encodeURIComponent(__nextCursor)}` : ''}`;
            try {
                const resp = await fetch(url, { credentials: 'include' });
                const data = await resp.json();
                if (data && data.success) {
                    __nextCursor = data.next_cursor || null;
                    __hasMore = !!data.has_more;
                    const chunk = currentTab === 'engenharia'
                        ? (data.rncs || []).filter(r => {
                            // Usar o mesmo filtro da função loadRNCs
                            const isEngineering = (
                                (r.responsavel && r.responsavel.toLowerCase().includes('guilherme')) ||
                                (r.responsavel && r.responsavel.toLowerCase().includes('cintia')) ||
                                (r.responsavel && r.responsavel.toLowerCase().includes('cíntia')) ||
                                (r.area_responsavel && r.area_responsavel.toLowerCase().includes('engenharia')) ||
                                (r.department && r.department.toLowerCase().includes('engenharia')) ||
                                (r.setor && r.setor.toLowerCase().includes('engenharia')) ||
                                (r.finalized_at !== null && r.finalized_at !== undefined)
                            );
                            return isEngineering;
                        })
                        : (data.rncs || []);
                    rncsData[currentTab] = (rncsData[currentTab] || []).concat(chunk);
                    renderRNCs(currentTab);
                    updateCounts();
                }
            } catch (e) {
                console.error('Falha no load more', e);
            } finally {
                __isLoading = false;
                renderImprovedLoadMore();
            }
        }

        function renderImprovedLoadMore() {
            const el = document.getElementById('improvedLoadMore');
            if (!el) return;
            if (__isLoading) { el.innerHTML = '<div class="load-more-info">Carregando...</div>'; return; }
            if (!__hasMore) { el.innerHTML = ''; return; }
            el.innerHTML = '<div class="load-more-wrap"><button class="btn btn-primary" onclick="loadMoreImproved()">Carregar mais</button></div>';
        }

        // Função para forçar refresh completo
        async function forceRefreshDashboard() {
            console.log('🔄 Iniciando refresh completo do dashboard...');
            
            try {
                // 1. Limpar cache do servidor
                console.log('🗑️ Limpando cache do servidor...');
                await fetch('/api/cache/clear', {
                    method: 'POST',
                    credentials: 'include'
                });
                
                // 2. Limpar cache local
                localStorage.removeItem('dashboardCacheV1');
                console.log('🗑️ Cache local limpo');
                
                // 3. Limpar dados em memória
                rncsData = { 
                    active: [], 
                    {% if user_permissions.canViewEngineeringRncs %}
                    engenharia: [], 
                    {% endif %}
                    finalized: [] 
                };
                
                // 4. Recarregar todas as abas com forceRefresh
                console.log('📋 Recarregando aba ativa...');
                await loadRNCs('finalized', true);
                
                {% if user_permissions.canViewEngineeringRncs %}
                console.log('🔧 Recarregando aba engenharia...');
                await loadRNCs('engenharia', true);
                {% endif %}
                
                console.log('📋 Recarregando aba finalizados...');
                await loadRNCs('finalized', true);
                
                console.log('👤 Recarregando informações do usuário...');
                await loadUserInfo();
                
                console.log('✅ Refresh completo concluído!');
                
                // Mostrar notificação de sucesso
                showNotification('✅ Dashboard atualizado com sucesso!', 'success');
                
            } catch (error) {
                console.error('❌ Erro durante refresh:', error);
                showNotification('❌ Erro ao atualizar dashboard', 'error');
            }
        }
        
        // Expor função globalmente
        window.forceRefreshDashboard = forceRefreshDashboard;

        // Função de debug para verificar contagens reais
        async function debugRNCCount() {
            try {
                const response = await fetch('/api/debug/rnc-count', { credentials: 'include' });
                const data = await response.json();
                
                if (data.success) {
                    console.log('🔍 CONTAGENS REAIS DO BANCO:', data.counts);
                    alert(`CONTAGENS REAIS:
Total: ${data.counts.total}
Finalizados: ${data.counts.finalizados}
Finalizados Ativos: ${data.counts.finalizados_ativos}
Ativos: ${data.counts.ativos}`);
                } else {
                    console.error('Erro no debug:', data.message);
                }
            } catch (error) {
                console.error('Erro ao buscar debug:', error);
            }
        }
        
        // Expor função de debug globalmente
        window.debugRNCCount = debugRNCCount;

        // Função de debug para verificar RNCs do usuário atual
        async function debugUserRNCs() {
            try {
                const response = await fetch('/api/debug/user-rncs', { credentials: 'include' });
                const data = await response.json();
                
                if (data.success) {
                    console.log('🔍 RNCs DO USUÁRIO:', data);
                    alert(`RNCs de ${data.user_name} (ID: ${data.user_id}):

Criados por mim: ${data.counts.created_by_user}
Atribuídos a mim: ${data.counts.assigned_to_user}
Ativos (total): ${data.counts.active_total}
Finalizados (total): ${data.counts.finalized_total}

Exemplos recentes:
${data.examples.map(ex => 
  `${ex.rnc_number}: ${ex.title} (${ex.status}) ${ex.is_creator ? '[CRIADO]' : ''} ${ex.is_assigned ? '[ATRIBUÍDO]' : ''}`
).join('\n')}`);
                } else {
                    console.error('Erro no debug:', data.message);
                }
            } catch (error) {
                console.error('Erro ao buscar debug do usuário:', error);
            }
        }
        
        // Expor função de debug do usuário globalmente
        window.debugUserRNCs = debugUserRNCs;

        // Função de debug para verificar compartilhamentos
        async function debugUserShares() {
            try {
                const response = await fetch('/api/debug/user-shares', { credentials: 'include' });
                const data = await response.json();
                
                if (data.success) {
                    console.log('🔍 COMPARTILHAMENTOS DO USUÁRIO:', data);
                    alert(`Compartilhamentos de ${data.user_name} (ID: ${data.user_id}):

📥 Compartilhadas COMIGO: ${data.totals.shared_with_me}
📤 Compartilhadas POR MIM: ${data.totals.shared_by_me}

Últimas compartilhadas comigo:
${data.shared_with_me.map(share => 
  `${share.rnc_number}: ${share.title} (${share.status}) - Por: ${share.shared_by}`
).join('\n') || 'Nenhuma'}

Últimas compartilhadas por mim:
${data.shared_by_me.map(share => 
  `${share.rnc_number}: ${share.title} (${share.status}) - Para: ${share.shared_with}`
).join('\n') || 'Nenhuma'}`);
                } else {
                    console.error('Erro no debug:', data.message);
                }
            } catch (error) {
                console.error('Erro ao buscar debug de compartilhamentos:', error);
            }
        }
        
        // Expor função de debug de compartilhamentos globalmente
        window.debugUserShares = debugUserShares;

        // Função de debug para verificar assinaturas de uma RNC específica
        async function debugRNCSignatures(rncId) {
            try {
                const response = await fetch(`/api/debug/rnc-signatures/${rncId}`, { credentials: 'include' });
                const data = await response.json();
                
                if (data.success) {
                    console.log('🔍 ASSINATURAS DA RNC:', data);
                    alert(`Assinaturas da RNC ${data.rnc_number}:

INSPEÇÃO (Coluna 1):
Nome: "${data.signatures.inspection_name || 'VAZIO'}"
Data: "${data.signatures.inspection_date || 'VAZIO'}"
Status: ${data.debug_info.inspection_empty ? '❌ VAZIO' : '✅ PREENCHIDO'}

ENGENHARIA (Coluna 2):
Nome: "${data.signatures.engineering_name || 'VAZIO'}"
Data: "${data.signatures.engineering_date || 'VAZIO'}"
Status: ${data.debug_info.engineering_empty ? '❌ VAZIO' : '✅ PREENCHIDO'}

INSPEÇÃO 2 (Coluna 3):
Nome: "${data.signatures.inspection2_name || 'VAZIO'}"
Data: "${data.signatures.inspection2_date || 'VAZIO'}"
Status: ${data.debug_info.inspection2_empty ? '❌ VAZIO' : '✅ PREENCHIDO'}`);
                } else {
                    console.error('Erro no debug:', data.message);
                    alert('Erro: ' + data.message);
                }
            } catch (error) {
                console.error('Erro ao buscar debug de assinaturas:', error);
                alert('Erro ao buscar debug de assinaturas');
            }
        }
        
        // Expor função de debug de assinaturas globalmente
        window.debugRNCSignatures = debugRNCSignatures;

        // Sistema de debounce para evitar requisições múltiplas
        const loadingStates = {};
        function debounceLoad(key, fn, delay = 300) {
            if (loadingStates[key]) {
                console.log(`⏳ ${key} já está carregando, ignorando...`);
                return Promise.resolve();
            }
            
            loadingStates[key] = true;
            return fn().finally(() => {
                setTimeout(() => {
                    loadingStates[key] = false;
                }, delay);
            });
        }

        // Preload crítico - carregar dados essenciais imediatamente
        function preloadCriticalData() {
            const promises = [];
            
            // Preload dados essenciais de forma sequencial para evitar sobrecarga
            promises.push(loadUserInfo().catch(() => {}));
            
            // Carregar dados ativos E finalizados separadamente para garantir dados corretos
            promises.push(
                loadRNCs('active', false).then(() => {
                    console.log('✅ Dados ativos carregados:', rncsData.active?.length || 0);
                }).catch(() => {})
            );
            
            promises.push(
                loadRNCs('finalized', false).then(() => {
                    console.log('✅ Dados finalizados carregados:', rncsData.finalized?.length || 0);
                }).catch(() => {})
            );
            
            {% if user_permissions.canViewEngineeringRncs %}
            // Carregar dados de engenharia apenas se o usuário tiver permissão
            promises.push(loadRNCs('engenharia', false).catch(() => {}));
            {% endif %}
            
            return Promise.allSettled(promises);
        }

        // Renderizar RNCs
        function renderRNCs(tab, rncsArray = null) {
            if (typeof window.isAdmin === 'undefined') {
                window.isAdmin = false;
            }
            const grid = document.getElementById('rncGrid');
            const rncs = rncsArray || rncsData[tab];
            
            // Ajustar classe do grid baseado na aba
            if (tab === 'finalized' || tab === 'engenharia') {
                grid.classList.add('table-mode');
            } else {
                grid.classList.remove('table-mode');
            }
            
            if (!rncs || rncs.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">${getEmptyStateIcon(tab)}</div>
                        <h3>${getEmptyStateTitle(tab)}</h3>
                        <p>${getEmptyStateMessage(tab)}</p>
                    </div>
                `;
                return;
            }
            
            // Se for a aba finalizados ou engenharia, mostrar como tabela
            if (tab === 'finalized' || tab === 'engenharia') {
                grid.innerHTML = createRNCTable(rncs, tab);
            } else {
                // Aplicar filtros extras para 'active' também
                const filtered = tab === 'active' ? filterActive(rncs) : rncs;
                grid.innerHTML = filtered.map(rnc => safeCreateRNCCard(rnc, tab)).join('');
            }
        }
        function safeCreateRNCCard(rnc, tab) {
            try {
                if (!rnc) return '';
                if (!rnc.priority) rnc.priority = 'N/A';
                return createRNCCard(rnc, tab);
            } catch (e) {
                console.error('Falha ao criar card RNC', rnc && rnc.id, e);
                return '';
            }
        }
        
        // Criar tabela de RNCs finalizados
        function createRNCTable(rncs, tab) {
            const total = rncs.length;
            const pageSize = currentPageSize;
            const totalPages = Math.max(1, Math.ceil(total / pageSize));
            if (currentPage > totalPages) currentPage = totalPages;
            const startIndex = (currentPage - 1) * pageSize;
            const pageItems = rncs.slice(startIndex, startIndex + pageSize);
            return `
                <div class="table-container">
                    <table class="rnc-table">
                        <thead>
                            <tr>
                                <th class="sortable" onclick="sortTable('id')">
                                    ID <span class="sort-icon">↕️</span>
                                </th>
                                <th class="sortable" onclick="sortTable('rnc_number')">
                                    N° RNC <span class="sort-icon">↕️</span>
                                </th>
                                <th class="sortable" onclick="sortTable('title')">
                                    Título <span class="sort-icon">↕️</span>
                                </th>
                                <th class="sortable" onclick="sortTable('client')">
                                    Cliente <span class="sort-icon">↕️</span>
                                </th>
                                <th class="sortable" onclick="sortTable('equipment')">
                                    Equipamento <span class="sort-icon">↕️</span>
                                </th>
                                <th class="sortable" onclick="sortTable('department')">
                                    Área Responsável <span class="sort-icon">↕️</span>
                                </th>
                                <th class="sortable" onclick="sortTable('setor')">
                                    Setor <span class="sort-icon">↕️</span>
                                </th>
                                <th class="sortable" onclick="sortTable('user_name')">
                                    Responsável <span class="sort-icon">↕️</span>
                                </th>
                                <th class="sortable" onclick="sortTable('created_at')">
                                    Data Emissão <span class="sort-icon">↕️</span>
                                </th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${pageItems.map(rnc => createRNCTableRow(rnc, tab)).join('')}
                        </tbody>
                    </table>
                    ${renderPagination(total, currentPage, totalPages)}
                </div>
            `;
        }
        
        // Criar linha da tabela
        function createRNCTableRow(rnc, tab) {
            const createdDate = rnc.created_at ? new Date(rnc.created_at).toLocaleDateString('pt-BR') : 'N/A';
            
            // Limpar título removendo "RNC XXXXX - " no início
            let cleanTitle = rnc.title || '';
            if (cleanTitle.includes(' - ')) {
                // Remove a parte "RNC 34461 - " e mantém apenas "Rebobinadeira / ..."
                const parts = cleanTitle.split(' - ');
                if (parts.length > 1) {
                    cleanTitle = parts.slice(1).join(' - ');
                }
            }
            
            // Limpar número RNC removendo "RNC-" e deixando apenas os números
            let cleanRncNumber = rnc.rnc_number || '';
            if (cleanRncNumber.startsWith('RNC-')) {
                cleanRncNumber = cleanRncNumber.replace('RNC-', '');
            }

            // Preparar identificação de criador e atribuído
            const creatorName = rnc.user_name || 'N/I';
            const assignedName = (rnc.assigned_user_name && rnc.assigned_user_name !== rnc.user_name)
                ? ` → ${rnc.assigned_user_name}`
                : '';
            
            return `
                <tr class="rnc-table-row" data-rnc-id="${rnc.id}" id="rnc-${rnc.id}">
                    <td class="rnc-id-cell">${rnc.id}</td>
                    <td class="rnc-number-cell"><a href="/rnc/${rnc.id}" title="Abrir RNC">${cleanRncNumber}</a></td>
                    <td class="rnc-title-cell">${cleanTitle}</td>
                    <td class="rnc-client-cell">${rnc.client || 'N/A'}</td>
                    <td class="rnc-equipment-cell">${rnc.equipment || 'N/A'}</td>
                    <td class="rnc-department-cell">${rnc.area_responsavel || 'N/A'}</td>
                    <td class="rnc-setor-cell">${rnc.setor || 'N/A'}</td>
                    <td class="rnc-user-cell">${creatorName}${assignedName}</td>
                    <td class="rnc-date-cell">${createdDate}</td>
                    <td class="rnc-actions-cell">
                        <a href="/rnc/${rnc.id}" class="action-btn btn-view" title="Ver RNC">👁️</a>
                        <!-- botão imprimir removido -->
                    </td>
                </tr>
            `;
        }
        
        // Criar card de RNC
        function createRNCCard(rnc, tab) {
            const statusClass = tab === 'finalized' ? 'finalized' : 'active';
            const iconClass = statusClass;
            
            let statusBadge = '';
            if (tab === 'finalized' && rnc.finalized_at) {
                const date = new Date(rnc.finalized_at).toLocaleDateString('pt-BR');
                statusBadge = `<div class="finalized-date">Finalizado em ${date}</div>`;
            }
            
            const actions = getActionsForTab(rnc, tab);
            
            return `
                <div class="rnc-card ${statusClass}" data-rnc-id="${rnc.id}" id="rnc-${rnc.id}">
                    ${statusBadge}
                    <div class="rnc-header">
                        <div>
                            <div class="rnc-number">${rnc.rnc_number}</div>
                            <div class="rnc-title">${rnc.title}</div>
                        </div>
                        <div class="rnc-icon ${iconClass}">R</div>
                    </div>
                    
                    <div class="rnc-details">
                        <div class="detail-item">
                            <div class="icon">⚡</div>
                            <span class="priority-badge priority-${(rnc.priority || 'N/A').toLowerCase()}">${rnc.priority || 'N/A'}</span>
                        </div>
                        <div class="detail-item">
                            <div class="icon">�</div>
                            <span>${rnc.created_at ? new Date(rnc.created_at).toLocaleDateString('pt-BR') : 'N/A'}</span>
                        </div>
                        <div class="detail-item">
                            <div class="icon">�🔧</div>
                            <span>${rnc.equipment || 'N/A'}</span>
                        </div>
                        <div class="detail-item">
                            <div class="icon">🏢</div>
                            <span>${rnc.client || 'N/A'}</span>
                        </div>
                        <div class="detail-item">
                            <div class="icon">👤</div>
                            <span>${rnc.user_name || rnc.assigned_user_name || 'Sistema'}</span>
                        </div>
                    </div>
                    
                    <div class="rnc-actions">
                        ${actions}
                    </div>
                </div>
            `;
        }

        // Paginação e Exportação para Finalizados
        let currentPage = 1;
        let currentPageSize = 10;
        function changePage(page) { currentPage = page; renderRNCs(currentTab); }
        function changePageSize(size) { currentPageSize = parseInt(size, 10) || 10; currentPage = 1; if (currentTab === 'finalized') renderRNCs('finalized'); }
        function renderPagination(total, page, totalPages) {
            if (total <= currentPageSize) return '';
            const btn = (p, lbl, active=false) => `<button onclick=\"changePage(${p})\" style=\"margin:6px 4px; padding:6px 10px; border:1px solid #dee2e6; background:${active?'#dc3545':'#fff'}; color:${active?'#fff':'#333'}; border-radius:6px; cursor:pointer;\">${lbl}</button>`;
            let html = '<div style="display:flex; justify-content:center; padding:10px;">';
            html += btn(Math.max(1, page-1), '‹');
            const start = Math.max(1, page-2);
            const end = Math.min(totalPages, start+4);
            for (let p=start; p<=end; p++) html += btn(p, p, p===page);
            html += btn(Math.min(totalPages, page+1), '›');
            html += '</div>';
            return html;
        }

        function exportCSV() {
            const rows = currentTab === 'finalized'
                ? ((filteredRNCs.length > 0 ? filteredRNCs : rncsData.finalized) || [])
                : currentTab === 'engenharia'
                {% if user_permissions.canViewEngineeringRncs %}
                ? (rncsData.engenharia || [])
                {% else %}
                ? []
                {% endif %}
                : (filterActive(rncsData.active) || []);
            if (!rows.length) { alert('Nenhum RNC para exportar.'); return; }
            const header = ['ID','N° RNC','Título','Cliente','Equipamento','Área Responsável','Setor','Responsável','Data Finalização'];
            const csvRows = [header.join(';')];
            rows.forEach(r => {
                const finalizedDate = r.finalized_at ? new Date(r.finalized_at).toLocaleDateString('pt-BR') : '';
                csvRows.push([
                    r.id,
                    r.rnc_number,
                    (r.title || '').replace(/;/g, ','),
                    (r.client || '').replace(/;/g, ','),
                    (r.equipment || '').replace(/;/g, ','),
                    (r.area_responsavel || '').replace(/;/g, ','),
                    (r.setor || '').replace(/;/g, ','),
                    (r.responsavel || '').replace(/;/g, ','),
                    finalizedDate
                ].join(';'));
            });
            const blob = new Blob(["\ufeff" + csvRows.join('\n')], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            const ts = new Date().toISOString().slice(0,10);
            const name = currentTab === 'finalized' ? 'rnc_finalizados' : 'rnc_ativos';
            a.download = `${name}_${ts}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        // Obter ações baseadas na aba
        function getActionsForTab(rnc, tab) {
            // Para aba de finalizados, manter ações mínimas
            if (tab !== 'active') {
                return `
                    <button onclick="window.location.href='/rnc/${rnc.id}'" class="action-btn btn-view">👁️ Ver</button>
                    <button onclick="window.location.href='/rnc/${rnc.id}/chat'" class="action-btn btn-chat">💬 Chat</button>
                    <button onclick="window.location.href='/rnc/${rnc.id}/reply'" class="action-btn btn-reply">↩️ Responder</button>
                `;
            }

            const isCreator = rnc.is_creator || (window.currentUserId && rnc.user_id && String(rnc.user_id) === String(window.currentUserId));
            const perms = window.userPerms || {};

                        // Admin vê tudo
            if (window.isAdmin) {
                return `
                    <a href="/rnc/${rnc.id}" class="action-btn btn-view">👁️ Ver</a>
                    <a href="/rnc/${rnc.id}/chat" class="action-btn btn-chat">💬 Chat</a>
                    <a href="/rnc/${rnc.id}/reply" class="action-btn btn-reply">↩️ Responder</a>
                    <button onclick="finalizeRNC(${rnc.id})" class="action-btn btn-finalize">✅ Finalizar</button>
                    <button onclick="deleteRNC(${rnc.id})" class="action-btn btn-delete">🗑️ Excluir</button>
                `;
            }

            const actions = [];
            actions.push(`<button onclick=\"window.location.href='/rnc/${rnc.id}'\" class=\"action-btn btn-view\">👁️ Ver</button>`);
            actions.push(`<button onclick=\"window.location.href='/rnc/${rnc.id}/chat'\" class=\"action-btn btn-chat\">💬 Chat</button>`);
            // Responder: disponível para qualquer usuário autenticado
            actions.push(`<button onclick=\"window.location.href='/rnc/${rnc.id}/reply'\" class=\"action-btn btn-reply\">↩️ Responder</button>`);
            // Finalizar
            if (perms.canFinalizeRnc) {
                actions.push(`<button onclick="finalizeRNC(${rnc.id})" class="action-btn btn-finalize">✅ Finalizar</button>`);
            }
            // Excluir
            if (perms.canDeleteRncs) {
                actions.push(`<button onclick="deleteRNC(${rnc.id})" class="action-btn btn-delete">🗑️ Excluir</button>`);
            }

            return actions.join('\n');
        }
        
        // Funções de ação
        async function finalizeRNC(rncId) {
            if (!confirm('Tem certeza que deseja finalizar este RNC?')) return;
            
            try {
                const response = await fetch(`/api/rnc/${rncId}/finalize`, { method: 'POST' });
                const data = await response.json();
                
                if (data.success) {
                    alert('RNC finalizado com sucesso!');
                    loadRNCs(currentTab);
                } else {
                    alert('Erro ao finalizar RNC: ' + data.message);
                }
            } catch (error) {
                console.error('Erro:', error);
                alert('Erro ao conectar com o servidor');
            }
        }

        async function replyRNCFromList(rncId) {
            try {
                const resp = await fetch(`/api/rnc/${rncId}/reply`, { method: 'POST' });
                const data = await resp.json();
                if (data.success) {
                    alert('RNC reenviada com sucesso!');
                    loadRNCs(currentTab, true);
                } else {
                    alert('Erro: ' + (data.message || 'Falha ao responder RNC'));
                }
            } catch (e) {
                alert('Erro ao conectar com o servidor');
            }
        }
        
        async function deleteRNC(rncId) {
            if (!confirm('Tem certeza que deseja excluir definitivamente este RNC? Esta ação não poderá ser desfeita.')) return;
            
            console.log(`🗑️ Excluindo RNC ${rncId}...`);
            
            try {
                // 1. REMOÇÃO IMEDIATA da interface (otimistic update)
                removeRNCFromInterface(rncId);
                
                // 2. Fazer requisição para o servidor
                const base = window.location.origin.replace(/^https:/, 'http:');
                const response = await fetch(`${base}/api/rnc/${rncId}/delete`, { 
                    method: 'DELETE',
                    credentials: 'include'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    console.log(`✅ RNC ${rncId} excluído com sucesso no servidor`);
                    
                    // 3. Atualizar dados locais imediatamente
                    if (rncsData.active) {
                        rncsData.active = rncsData.active.filter(rnc => rnc.id != rncId);
                    }
                    {% if user_permissions.canViewEngineeringRncs %}
                    if (rncsData.engenharia) {
                        rncsData.engenharia = rncsData.engenharia.filter(rnc => rnc.id != rncId);
                    }
                    {% endif %}
                    if (rncsData.finalized) {
                        rncsData.finalized = rncsData.finalized.filter(rnc => rnc.id != rncId);
                    }
                    
                    // 4. Atualizar contadores imediatamente
                    updateCounts();
                    
                    // 5. Mostrar notificação de sucesso
                    showNotification('RNC excluído definitivamente!', 'success');
                    
                    console.log('🔄 RNC removido instantaneamente da interface');
                    
                } else {
                    console.error(`❌ Erro ao excluir RNC ${rncId}:`, data.message);
                    
                    // 6. Em caso de erro, recarregar a lista para restaurar
                    showNotification(`Erro ao excluir: ${data.message}`, 'error');
                    loadRNCs(currentTab); // Recarregar para mostrar estado real
                }
                
            } catch (error) {
                console.error(`❌ Erro de rede ao excluir RNC ${rncId}:`, error);
                showNotification('Erro de conexão. Verifique sua internet.', 'error');
                
                // Em caso de erro de rede, recarregar para mostrar estado real
                loadRNCs(currentTab);
            }
        }
        
        function removeRNCFromInterface(rncId) {
            console.log(`🎨 Removendo RNC ${rncId} da interface...`);
            
            // Encontrar o elemento da RNC na interface
            const rncElement = document.querySelector(`[data-rnc-id="${rncId}"]`) || 
                              document.querySelector(`#rnc-${rncId}`) ||
                              Array.from(document.querySelectorAll('.rnc-card')).find(card => 
                                  card.textContent.includes(`RNC-${rncId}`) || 
                                  card.innerHTML.includes(`deleteRNC(${rncId})`)
                              );
            
            if (rncElement) {
                // Animação suave de remoção
                rncElement.style.transition = 'all 0.3s ease-out';
                rncElement.style.transform = 'translateX(-100%)';
                rncElement.style.opacity = '0';
                
                // Remover elemento após animação
                setTimeout(() => {
                    rncElement.remove();
                    console.log(`🎨 Elemento RNC ${rncId} removido da DOM`);
                }, 300);
            } else {
                console.log(`⚠️ Elemento RNC ${rncId} não encontrado na interface`);
            }
        }
        
        // Função para mostrar notificações modernas
        function showNotification(message, type = 'info') {
            // Remover notificação existente se houver
            const existing = document.querySelector('.notification-toast');
            if (existing) {
                existing.remove();
            }
            
            // Criar elemento de notificação
            const notification = document.createElement('div');
            notification.className = `notification-toast ${type}`;
            notification.innerHTML = `
                <div class="notification-content">
                    <span class="notification-icon">
                        ${type === 'success' ? '✅' : type === 'error' ? '❌' : type === 'warning' ? '⚠️' : 'ℹ️'}
                    </span>
                    <span class="notification-message">${message}</span>
                    <button class="notification-close" onclick="this.parentElement.parentElement.remove()">×</button>
                </div>
            `;
            
            // Adicionar estilos
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                z-index: 10000;
                background: ${type === 'success' ? '#28a745' : type === 'error' ? '#dc3545' : type === 'warning' ? '#ffc107' : '#17a2b8'};
                color: white;
                padding: 15px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                transform: translateX(400px);
                transition: transform 0.3s ease-out;
                max-width: 400px;
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            `;
            
            notification.querySelector('.notification-content').style.cssText = `
                display: flex;
                align-items: center;
                gap: 10px;
            `;
            
            notification.querySelector('.notification-close').style.cssText = `
                background: none;
                border: none;
                color: white;
                font-size: 18px;
                cursor: pointer;
                padding: 0;
                margin-left: auto;
                opacity: 0.7;
            `;
            
            // Adicionar ao DOM
            document.body.appendChild(notification);
            
            // Animar entrada
            setTimeout(() => {
                notification.style.transform = 'translateX(0)';
            }, 10);
            
            // Auto-remover após 4 segundos
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.style.transform = 'translateX(400px)';
                    setTimeout(() => {
                        if (notification.parentElement) {
                            notification.remove();
                        }
                    }, 300);
                }
            }, 4000);
        }
        
        // Funções de restauração, exclusão permanente e limpeza foram removidas (lixeira desativada)
        
        // Atualizar contadores
        function updateCounts() {
            const countActiveEl = document.getElementById('count-active');
            const countEngenhariaEl = document.getElementById('count-engenharia');
            const countFinalizedEl = document.getElementById('count-finalized');
            const statActiveEl = document.getElementById('stat-active');
            const statFinalizedEl = document.getElementById('stat-finalized');
            
            // Debug: verificar dados antes de atualizar
            console.log('🔢 Atualizando contadores:', {
                active: rncsData.active?.length || 0,
                finalized: rncsData.finalized?.length || 0,
                engenharia: rncsData.engenharia?.length || 0
            });
            
            if (countActiveEl) countActiveEl.textContent = rncsData.active?.length || 0;
            {% if user_permissions.canViewEngineeringRncs %}
            if (countEngenhariaEl) countEngenhariaEl.textContent = rncsData.engenharia?.length || 0;
            {% else %}
            if (countEngenhariaEl) countEngenhariaEl.textContent = 0;
            {% endif %}
            if (countFinalizedEl) countFinalizedEl.textContent = rncsData.finalized?.length || 0;
            
            // Corrigir: usar dados corretos para cada contador
            if (statActiveEl) statActiveEl.textContent = rncsData.active?.length || 0;
            if (statFinalizedEl) statFinalizedEl.textContent = rncsData.finalized?.length || 0;
        }
        
        // Funções auxiliares
        function getEmptyStateIcon(tab) {
            switch(tab) {
                case 'active': return '📋';
                case 'engenharia': return '🔧';
                case 'finalized': return '✅';
                
                default: return '📄';
            }
        }
        
        function getEmptyStateTitle(tab) {
            switch(tab) {
                case 'active': return 'Nenhum RNC Ativo';
                case 'engenharia': return 'Nenhum RNC de Engenharia';
                case 'finalized': return 'Nenhum RNC Finalizado';
                
                default: return 'Nenhum RNC';
            }
        }
        
        function getEmptyStateMessage(tab) {
            switch(tab) {
                case 'active': return 'Crie seu primeiro RNC para começar a trabalhar.';
                case 'engenharia': return 'RNCs específicos do setor de Engenharia aparecerão aqui.';
                case 'finalized': return 'RNCs finalizados aparecerão aqui para consulta.';
                
                default: return 'Nenhum RNC encontrado.';
            }
        }
        
        async function logout() {
            try {
                const base = window.location.origin.replace(/^https:/,'http:');
                const response = await fetch(base + '/api/logout', { credentials: 'include' });
                const data = await response.json();
                
                if (data.success) {
                    window.location.href = '/';
                }
            } catch (error) {
                console.error('Erro no logout:', error);
                window.location.href = '/';
            }
        }
        
        // Sistema de notificações
        let notifications = [];
        let notificationCount = 0;
        
        // Carregar notificações não lidas
        async function loadNotifications() {
            try {
                const base = window.location.origin.replace(/^https:/,'http:');
                const response = await fetch(base + '/api/notifications/unread', { credentials: 'include' });
                const data = await response.json();
                
                if (data.success) {
                    notifications = data.notifications;
                    notificationCount = data.count;
                    renderNotifications();
                }
            } catch (error) {
                console.error('Erro ao carregar notificações:', error);
            }
        }
        
        // Renderizar notificações
        function renderNotifications() {
            const container = document.getElementById('notificationsContainer');
            const list = document.getElementById('notificationsList');
            
            if (notificationCount === 0) {
                container.style.display = 'none';
                updateNotificationBadge();
                return;
            }
            
            container.style.display = 'block';
            list.innerHTML = '';
            
            notifications.forEach(notification => {
                const notificationElement = document.createElement('div');
                notificationElement.style.cssText = `
                    padding: 10px;
                    margin-bottom: 8px;
                    background: ${notification.is_read ? '#f8f9fa' : '#fff3cd'};
                    border-left: 4px solid ${notification.is_read ? '#6c757d' : '#ffc107'};
                    border-radius: 5px;
                    font-size: 12px;
                    cursor: pointer;
                    transition: all 0.3s ease;
                `;
                
                notificationElement.innerHTML = `
                    <div style="font-weight: 600; margin-bottom: 3px;">${notification.title}</div>
                    <div style="color: #666; margin-bottom: 5px;">${notification.message}</div>
                    <div style="font-size: 10px; color: #999;">
                        ${new Date(notification.created_at).toLocaleString('pt-BR')}
                    </div>
                `;
                
                notificationElement.onclick = () => {
                    if (notification.rnc_id) {
                        window.location.href = `/rnc/${notification.rnc_id}/chat`;
                    }
                };
                
                list.appendChild(notificationElement);
            });
            
            updateNotificationBadge();
        }
        
        // Marcar todas as notificações como lidas
        async function markAllNotificationsRead() {
            if (notifications.length === 0) return;
            
            try {
                const notificationIds = notifications.map(n => n.id);
                const response = await fetch('/api/notifications/mark-read', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ notification_ids: notificationIds })
                });
                
                const data = await response.json();
                if (data.success) {
                    notifications = [];
                    notificationCount = 0;
                    renderNotifications();
                    updateNotificationBadge();
                }
            } catch (error) {
                console.error('Erro ao marcar notificações como lidas:', error);
            }
        }
        
        // Mostrar notificação do navegador
        function showBrowserNotification(notification) {
            if ('Notification' in window && Notification.permission === 'granted') {
                new Notification(notification.title, {
                    body: notification.message,
                    icon: '/LOGOIPPEL.JPEG',
                    tag: `notification-${notification.id}`
                });
            }
        }
        
        // Solicitar permissão para notificações
        function requestNotificationPermission() {
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission();
            }
        }
        
        // Variáveis para controle de notificações
        let notificationSound = null;
        let lastNotificationCount = 0;
        let notificationPollingInterval = null;
        
        // Carregar som de notificação
        function loadNotificationSound() {
            try {
                notificationSound = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIG2m98OScTgwOUarm7blmGgU7k9n1unEiBC13yO/eizEIHWq+8+OWT');
            } catch (e) {
                console.log('Som de notificação não pôde ser carregado');
            }
        }
        
        // Tocar som de notificação
        function playNotificationSound() {
            if (notificationSound) {
                notificationSound.currentTime = 0;
                notificationSound.play().catch(e => console.log('Erro ao tocar som:', e));
            }
        }
        
        // Polling automático para notificações
        function startNotificationPolling() {
            // Verificar novas notificações a cada 10 segundos
            notificationPollingInterval = setInterval(async () => {
                try {
                    const response = await fetch('/api/notifications/unread');
                    const data = await response.json();
                    
                    if (data.success) {
                        const newCount = data.count;
                        
                        // Se há novas notificações
                        if (newCount > lastNotificationCount) {
                            const newNotifications = data.notifications.slice(0, newCount - lastNotificationCount);
                            
                            // Adicionar novas notificações
                            newNotifications.forEach(notification => {
                                notifications.unshift(notification);
                                notificationCount++;
                                
                                // Tocar som
                                playNotificationSound();
                                
                                // Mostrar notificação toast
                                showToastNotification(notification);
                                
                                // Mostrar notificação do navegador
                                showBrowserNotification(notification);
                            });
                            
                            renderNotifications();
                            updateNotificationBadge();
                        }
                        
                        lastNotificationCount = newCount;
                    }
                } catch (error) {
                    console.error('Erro ao verificar notificações:', error);
                }
            }, 10000); // 10 segundos
        }
        
        // Atualizar badge de notificações
        function updateNotificationBadge() {
            const badge = document.getElementById('notificationBadge');
            if (badge) {
                if (notificationCount > 0) {
                    badge.textContent = notificationCount;
                    badge.style.display = 'block';
                    badge.style.animation = 'pulse 1s infinite';
                } else {
                    badge.style.display = 'none';
                }
            }
        }
        
        // Alternar visibilidade das notificações
        function toggleNotifications() {
            const container = document.getElementById('notificationsContainer');
            if (container.style.display === 'none' || container.style.display === '') {
                container.style.display = 'block';
                // Marcar todas como lidas quando abrir
                if (notificationCount > 0) {
                    markAllNotificationsRead();
                }
            } else {
                container.style.display = 'none';
            }
        }
        
        // ===== FUNÇÃO GLOBAL PARA ALTERNAR ABAS =====
        // Declarada globalmente para ser acessível pelos eventos onclick
        function switchTab(tab) {
            console.log(`🔄 Alternando para aba: ${tab}`);
            
            // Remover classe active de todos os botões
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Adicionar classe active ao botão clicado
            const activeButton = document.querySelector(`[data-tab="${tab}"]`);
            if (activeButton) {
                activeButton.classList.add('active');
                console.log(`✅ Botão ${tab} ativado`);
            } else {
                console.error(`❌ Botão ${tab} não encontrado`);
            }
            
            // Atualizar variável global da aba atual
            currentTab = tab;
            
            // Mostrar/ocultar filtros baseado na aba
            const filtersContainer = document.getElementById('filtersContainer');
            if (filtersContainer) {
                if (tab === 'finalized') {
                    filtersContainer.style.display = 'block';
                    console.log(`🔍 Filtros mostrados para aba finalizados`);
                } else {
                    filtersContainer.style.display = 'none';
                    if (typeof clearFilters === 'function') clearFilters();
                    console.log(`🔍 Filtros ocultados para aba ${tab}`);
                }
            } else {
                console.error(`❌ Container de filtros não encontrado`);
            }
            
            // Mostrar/ocultar contêineres baseado na aba
            const containers = {
                'active': 'rncsContainer',
                'finalized': 'rncsContainer', 
                'setores': 'rncsContainer',
                'evidencias': 'evidenciasContainer',
                'lev1415': 'lev1415Container'
            };
            
            // Ocultar todos os contêineres
            Object.values(containers).forEach(containerId => {
                const container = document.getElementById(containerId);
                if (container) {
                    container.style.display = 'none';
                }
            });
            
            // Mostrar contêiner da aba ativa
            const activeContainerId = containers[tab];
            const activeContainer = document.getElementById(activeContainerId);
            if (activeContainer) {
                activeContainer.style.display = 'block';
                console.log(`👁️ Container ${activeContainerId} exibido`);
            }
            
            // Mostrar/ocultar gráficos de setores
            const setoresCharts = document.getElementById('setoresCharts');
            if (setoresCharts) {
                if (tab === 'setores') {
                    setoresCharts.style.display = 'block';
                    console.log('📊 Área de setores exibida');
                } else {
                    setoresCharts.style.display = 'none';
                    console.log('📊 Área de setores ocultada');
                }
            }
            
            // Ações específicas por aba
            if (tab === 'evidencias') {
                console.log('📊 Carregando evidências mensais...');
                if (typeof loadEvidencias === 'function') {
                    loadEvidencias();
                } else {
                    console.error('❌ Função loadEvidencias não disponível!');
                }
                // Carregar gráfico de funcionários
                setTimeout(() => {
                    if (typeof loadEmployeePerformance === 'function') {
                        loadEmployeePerformance();
                    }
                }, 500);
            } else if (tab === 'lev1415') {
                console.log('📑 Carregando levantamento 14-15...');
                if (typeof fillYearSelect === 'function') fillYearSelect();
                if (typeof loadLev1415 === 'function') loadLev1415();
                if (typeof loadLevByYear === 'function') loadLevByYear();
            } else {
                // Carregar RNCs para abas active/finalized
                console.log(`📋 Carregando RNCs para aba ${tab}`);
                if (typeof loadRNCs === 'function') {
                    loadRNCs(tab);
                }
            }
        }
        
        // Função para resetar a visualização para 2014-2015
        function resetLevView() {
            console.log('🔄 Resetando visualização para 2014-2015...');
            
            // Limpar seleção do ano
            const yearSelect = document.getElementById('levYearSelect');
            if (yearSelect) {
                yearSelect.value = '';
            }
            
            // Restaurar título da tabela
            const tableTitle = document.getElementById('levTableTitle');
            if (tableTitle) {
                tableTitle.textContent = '📋 Tabela 2014-2015 (Histórico)';
            }
            
            // Restaurar título do gráfico de porcentagens
            const percentTitle = document.getElementById('deptPercentTitle');
            if (percentTitle) {
                percentTitle.textContent = '📊 Porcentagem por Departamento - Anos Combinados';
            }
            
            // Recarregar dados padrão 2014-2015
            if (typeof loadLev1415 === 'function') {
                loadLev1415();
            }
        }
        
        // Função para renderizar o gráfico de porcentagem por departamento
        function renderDepartmentPercentChart(departamentos, totais, porcentagens, year, isDadosReais, grandTotalValue) {
            // Destruir gráfico existente se houver
            if (window._deptPercentChart) {
                window._deptPercentChart.destroy();
            }
            
            // Calcular o total geral se não for fornecido
            const grandTotal = grandTotalValue || departamentos.reduce((sum, dept) => sum + (totais[dept] || 0), 0);
            
            // Cores para cada departamento
            const coresDepartamentos = {
                'Produção': '#0d6efd',     // Azul
                'Engenharia': '#fd7e14',   // Laranja
                'Terceiros': '#dc3545',    // Vermelho
                'Compras': '#198754',      // Verde
                'Comercial': '#ffc107',    // Amarelo
                'Cliente': '#17a2b8',      // Azul claro
                'PCP': '#6610f2',          // Roxo
                'Expedição': '#20c997',    // Verde água
                'Qualidade': '#d63384',    // Rosa
                'Transporte': '#6c757d',   // Cinza
                'Não definido': '#343a40'  // Cinza escuro
            };
            
            // Preparar dados para o gráfico
            const cores = departamentos.map(dept => coresDepartamentos[dept] || '#000000');
            const valores = departamentos.map(dept => totais[dept]);
            const labels = departamentos.map(dept => `${dept}: ${porcentagens[dept]}%`);
            
            // Renderizar gráfico de pizza
            const ctx = document.getElementById('deptPercentChart');
            if (ctx) {
                window._deptPercentChart = new Chart(ctx.getContext('2d'), {
                    type: 'pie',
                    data: {
                        labels: departamentos,
                        datasets: [{
                            data: valores,
                            backgroundColor: cores,
                            borderColor: '#ffffff',
                            borderWidth: 1.5,
                            hoverOffset: 15
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false // Não mostrar legenda aqui - vamos criar uma personalizada
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const dept = context.label;
                                        const value = context.raw;
                                        const percent = porcentagens[dept];
                                        const isMonetary = isDadosReais && value > 1000;
                                        
                                        if (isMonetary) {
                                            return `${dept}: ${percent}% (R$ ${value.toLocaleString('pt-BR', {minimumFractionDigits: 2})})`;
                                        } else {
                                            return `${dept}: ${percent}% (${value} RNCs)`;
                                        }
                                    }
                                }
                            }
                        }
                    }
                });
            }
            
            // Criar legenda personalizada
            const legendEl = document.getElementById('deptPercentLegend');
            if (legendEl) {
                legendEl.innerHTML = departamentos.map((dept, i) => {
                    return `
                        <div style="display:flex; align-items:center; margin-right:8px;">
                            <div style="width:12px; height:12px; background:${cores[i]}; margin-right:4px; border-radius:2px;"></div>
                            <span>${dept}: <b>${porcentagens[dept]}%</b></span>
                        </div>
                    `;
                }).join('');
            }
            
            // Exibir estatísticas mais detalhadas
            const statsEl = document.getElementById('deptPercentStats');
            if (statsEl) {
                // Ordenar departamentos por porcentagem (do maior para o menor)
                const isMonetary = isDadosReais && Math.max(...Object.values(totais)) > 1000;
                const ordenados = [...departamentos].sort((a, b) => totais[b] - totais[a]);
                
                let html = `
                    <h4 style="margin-top:0;">📈 ${year} - Top Departamentos</h4>
                    <div style="margin-bottom:15px;">
                        <div style="color:#666; margin-bottom:6px;">
                            ${isMonetary ? 
                                'Ranking com base nos valores financeiros totais:' : 
                                'Ranking com base na quantidade total de RNCs:'}
                        </div>
                        <div style="font-weight:bold; font-size:16px; color:#198754;">
                            Líder: ${ordenados[0]} (${porcentagens[ordenados[0]]}%)
                        </div>
                    </div>
                `;
                
                // Mostrar tabela de ranking
                html += `
                    <table style="width:100%; border-collapse:collapse; font-size:13px;">
                        <thead>
                            <tr>
                                <th style="text-align:left; padding:6px; border-bottom:1px solid #e9ecef;">Rank</th>
                                <th style="text-align:left; padding:6px; border-bottom:1px solid #e9ecef;">Departamento</th>
                                <th style="text-align:right; padding:6px; border-bottom:1px solid #e9ecef;">%</th>
                                <th style="text-align:right; padding:6px; border-bottom:1px solid #e9ecef;">Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${ordenados.map((dept, i) => `
                                <tr>
                                    <td style="text-align:left; padding:6px; border-bottom:1px solid #f8f9fa;">#${i+1}</td>
                                    <td style="text-align:left; padding:6px; border-bottom:1px solid #f8f9fa;">${dept}</td>
                                    <td style="text-align:right; padding:6px; border-bottom:1px solid #f8f9fa; font-weight:bold;">${porcentagens[dept]}%</td>
                                    <td style="text-align:right; padding:6px; border-bottom:1px solid #f8f9fa;">
                                        ${isMonetary ? 
                                            `R$ ${totais[dept].toLocaleString('pt-BR', {minimumFractionDigits: 2})}` : 
                                            `${totais[dept]} RNCs`}
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    <div style="margin-top:15px; font-size:12px; color:#6c757d; text-align:center;">
                        ${isMonetary ? 'Valores totais do ano ' : 'RNCs totais do ano '} ${year}: 
                        <b>${isMonetary ? 
                            `R$ ${grandTotal.toLocaleString('pt-BR', {minimumFractionDigits: 2})}` : 
                            `${grandTotal} RNCs`}</b>
                    </div>
                `;
                
                statsEl.innerHTML = html;
            }
        }
        
        // Teste de disponibilidade da função
        console.log('🔧 switchTab function available:', typeof switchTab === 'function');
        
        // Renderização imediata a partir do cache local e prefetch paralelo
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 Iniciando dashboard...');
            
            // Inicializar AdvancedCharts
            console.log('📊 Inicializando AdvancedCharts...');
            if (typeof AdvancedCharts !== 'undefined') {
                window.advancedCharts = new AdvancedCharts();
                
                // Criar funções globais para compatibilidade
                window.createHeatmap = function(canvasId, data, options) {
                    return window.advancedCharts.createHeatmapChart(canvasId, data, options);
                };
                
                window.createGauge = function(canvasId, value, options) {
                    return window.advancedCharts.createGaugeChart(canvasId, value, options);
                };
                
                window.createAdvancedRadar = function(canvasId, data, options) {
                    return window.advancedCharts.createAdvancedRadarChart(canvasId, data, options);
                };
                
                console.log('✅ AdvancedCharts inicializado com sucesso');
            } else {
                console.error('❌ AdvancedCharts não disponível!');
            }
            
            try {
                // 1) Pintar imediatamente a partir do cache (se houver)
                const dc = loadDashboardCache();
                if (dc) {
                    console.log('⚡ Pintando UI com cache local');
                    if (dc.user) {
                        const userNameElement = document.getElementById('userName');
                        const userDepartmentElement = document.getElementById('userDepartment');
                        if (userNameElement) userNameElement.textContent = dc.user.name || 'Usuário';
                        if (userDepartmentElement) userDepartmentElement.textContent = dc.user.department || '';
                    }
                    if (dc.rncs) {
                        rncsData.active = dc.rncs.active || [];
                        rncsData.finalized = dc.rncs.finalized || [];
                        {% if user_permissions.canViewEngineeringRncs %}
                        rncsData.engenharia = dc.rncs.engenharia || [];
                        {% endif %}
                        // SEMPRE renderizar aba ativa primeiro
                        currentTab = 'active';
                        renderRNCs('active');
                        updateCounts();
                    }
                }

                // 2) Preload crítico primeiro, depois dados secundários
                console.log('🚀 Iniciando preload crítico...');
                
                preloadCriticalData().then(results => {
                    console.log('✅ Dados críticos carregados:', results);
                    saveDashboardCache({ user: null, rncs: rncsData });
                    
                    // Carregar dados secundários após dados críticos
                    setTimeout(() => {
                        loadNotifications().catch(err => console.warn('Erro ao carregar notificações:', err));
                    }, 100);
                });
                
                // Configurações assíncronas (não bloqueantes)
                setTimeout(() => {
                    requestNotificationPermission();
                    loadNotificationSound();
                    startNotificationPolling();
                }, 100);
                
                // Atualizar contadores após carregamento completo
                setTimeout(() => {
                    console.log('� Atualizando contadores finais...');
                        updateCounts();
                        saveDashboardCache({ user: null, rncs: rncsData });
                    console.log('✅ Contadores atualizados');
                    
                }, 300);
                
                // Garantir que a aba ativa seja mostrada IMEDIATAMENTE
                console.log('🎯 Forçando exibição da aba ATIVOS...');
                switchTab('active');
                
                // Inicializar seletores de ano e mês para desempenho por funcionário
                console.log('📅 Inicializando seletores de ano e mês...');
                setTimeout(() => {
                    initializeEmployeeSelectors();
                }, 500);
                
            } catch (error) {
                console.error('❌ Erro na inicialização:', error);
            }
            
            // Conectar ao WebSocket para notificações em tempo real
            if (typeof io !== 'undefined') {
                const socket = io();
                
                socket.on('notification', function(data) {
                    // Adicionar nova notificação
                    notifications.unshift(data);
                    notificationCount++;
                    renderNotifications();
                    updateNotificationBadge();
                    
                    // Tocar som
                    playNotificationSound();
                    
                    // Mostrar notificação do navegador
                    showBrowserNotification(data);
                    
                    // Mostrar notificação toast
                    showToastNotification(data);
                });
                
                socket.on('global_notification', function(data) {
                    // Adicionar nova notificação global
                    notifications.unshift(data);
                    notificationCount++;
                    renderNotifications();
                    updateNotificationBadge();
                    
                    // Tocar som
                    playNotificationSound();
                    
                    // Mostrar notificação do navegador
                    showBrowserNotification(data);
                    
                    // Mostrar notificação toast
                    showToastNotification(data);
                });
            }
            
            // Limpar intervalo quando a página for fechada
            window.addEventListener('beforeunload', () => {
                if (notificationPollingInterval) {
                    clearInterval(notificationPollingInterval);
                }
            });
        });
        
        // Mostrar notificação toast
        function showToastNotification(notification) {
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, #dc3545, #b21f35);
                color: white;
                padding: 15px 20px;
                border-radius: 10px;
                box-shadow: 0 4px 15px rgba(220,53,69,0.3);
                z-index: 3000;
                animation: slideInRight 0.3s ease-out;
                max-width: 300px;
                cursor: pointer;
            `;
            
            toast.innerHTML = `
                <div style="font-weight: 600; margin-bottom: 5px;">${notification.title}</div>
                <div style="font-size: 0.9rem;">${notification.message}</div>
            `;
            
            toast.onclick = () => {
                if (notification.rnc_id) {
                    window.location.href = `/rnc/${notification.rnc_id}/chat`;
                }
            };
            
            document.body.appendChild(toast);
            
            // Remover após 5 segundos
            setTimeout(() => {
                toast.style.animation = 'slideOutRight 0.3s ease-in';
                setTimeout(() => {
                    if (document.body.contains(toast)) {
                        document.body.removeChild(toast);
                    }
                }, 300);
            }, 5000);
        }
        

        
        // Função para aplicar filtros
        function applyFilters() {
            const rncNumber = document.getElementById('filterRncNumber').value.toLowerCase();
            const client = document.getElementById('filterClient').value.toLowerCase();
            const equipment = document.getElementById('filterEquipment').value.toLowerCase();
            const department = document.getElementById('filterDepartment').value.toLowerCase();
            const priority = document.getElementById('filterPriority') ? document.getElementById('filterPriority').value.toLowerCase() : '';
            const responsible = document.getElementById('filterResponsible') ? document.getElementById('filterResponsible').value.toLowerCase() : '';
            const dateStart = document.getElementById('filterDateStart') ? document.getElementById('filterDateStart').value : '';
            const dateEnd = document.getElementById('filterDateEnd') ? document.getElementById('filterDateEnd').value : '';
            
            currentFilters = {
                rncNumber,
                client,
                equipment,
                department,
                priority,
                responsible,
                dateStart,
                dateEnd
            };
            
            // Filtrar RNCs finalizados
            if (currentTab === 'finalized' && rncsData.finalized) {
                filteredRNCs = rncsData.finalized.filter(rnc => {
                    const matchesRncNumber = !rncNumber || rnc.rnc_number.toLowerCase().includes(rncNumber);
                    const matchesClient = !client || (rnc.client && rnc.client.toLowerCase().includes(client));
                    const matchesEquipment = !equipment || (rnc.equipment && rnc.equipment.toLowerCase().includes(equipment));
                    const matchesDepartment = !department || (rnc.user_department && rnc.user_department.toLowerCase().includes(department));
                    let matchesDate = true;
                    if (dateStart || dateEnd) {
                        const d = rnc.finalized_at ? new Date(rnc.finalized_at) : null;
                        if (!d) {
                            matchesDate = false;
                        } else {
                            if (dateStart) {
                                const s = new Date(dateStart); s.setHours(0,0,0,0);
                                if (d < s) matchesDate = false;
                            }
                            if (dateEnd) {
                                const e = new Date(dateEnd); e.setHours(23,59,59,999);
                                if (d > e) matchesDate = false;
                            }
                        }
                    }
                    
                    return matchesRncNumber && matchesClient && matchesEquipment && matchesDepartment && matchesDate;
                });
                
                // Usar a função de tabela para RNCs finalizados
                const grid = document.getElementById('rncGrid');
                grid.innerHTML = createRNCTable(filteredRNCs, 'finalized');
                
                // Mostrar contador de resultados filtrados
                showFilteredResultsCount(filteredRNCs.length, rncsData.finalized.length);
            }
        }

        function filterActive(list) {
            const f = currentFilters || {};
            return (list || []).filter(rnc => {
                const matchesNumber = !f.rncNumber || rnc.rnc_number?.toLowerCase().includes(f.rncNumber);
                const matchesClient = !f.client || (rnc.client && rnc.client.toLowerCase().includes(f.client));
                const matchesEquip = !f.equipment || (rnc.equipment && rnc.equipment.toLowerCase().includes(f.equipment));
                const matchesDept = !f.department || (rnc.user_department && rnc.user_department.toLowerCase().includes(f.department));
                const matchesPriority = !f.priority || (rnc.priority && rnc.priority.toLowerCase().includes(f.priority));
                const matchesResp = !f.responsible || (rnc.user_name && rnc.user_name.toLowerCase().includes(f.responsible));
                return matchesNumber && matchesClient && matchesEquip && matchesDept && matchesPriority && matchesResp;
            });
        }
        
        // Função para mostrar contador de resultados filtrados
        function showFilteredResultsCount(filteredCount, totalCount) {
            const filtersContainer = document.getElementById('filtersContainer');
            let resultsCounter = filtersContainer.querySelector('.results-counter');
            
            if (!resultsCounter) {
                resultsCounter = document.createElement('div');
                resultsCounter.className = 'results-counter';
                resultsCounter.style.cssText = `
                    text-align: center;
                    padding: 10px;
                    background: #e9ecef;
                    border-radius: 6px;
                    margin-top: 10px;
                    font-size: 14px;
                    color: #495057;
                `;
                filtersContainer.appendChild(resultsCounter);
            }
            
            if (filteredCount !== totalCount) {
                if (filteredCount === 0) {
                    resultsCounter.textContent = `Nenhum RNC encontrado com os filtros aplicados`;
                    resultsCounter.style.background = '#f8d7da';
                    resultsCounter.style.color = '#721c24';
                } else {
                    resultsCounter.textContent = `Mostrando ${filteredCount} de ${totalCount} RNCs finalizados`;
                    resultsCounter.style.background = '#e9ecef';
                    resultsCounter.style.color = '#495057';
                }
                resultsCounter.style.display = 'block';
            } else {
                resultsCounter.style.display = 'none';
            }
        }
        
        // Variáveis para ordenação
        let currentSortColumn = '';
        let currentSortDirection = 'asc';
        
        // Função para ordenar tabela
        function sortTable(column) {
            const rncs = currentTab === 'finalized' ? (filteredRNCs.length > 0 ? filteredRNCs : rncsData.finalized) : rncsData[currentTab];
            
            if (!rncs || rncs.length === 0) return;
            
            // Alternar direção se clicar na mesma coluna
            if (currentSortColumn === column) {
                currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                currentSortColumn = column;
                currentSortDirection = 'asc';
            }
            
            // Ordenar os dados
            const sortedRNCs = [...rncs].sort((a, b) => {
                let aValue = a[column] || '';
                let bValue = b[column] || '';
                
                // Converter para string para comparação
                aValue = String(aValue).toLowerCase();
                bValue = String(bValue).toLowerCase();
                
                if (currentSortDirection === 'asc') {
                    return aValue.localeCompare(bValue);
                } else {
                    return bValue.localeCompare(aValue);
                }
            });
            
            // Atualizar dados
            if (currentTab === 'finalized') {
                if (filteredRNCs.length > 0) {
                    filteredRNCs = sortedRNCs;
                } else {
                    rncsData.finalized = sortedRNCs;
                }
            } else {
                rncsData[currentTab] = sortedRNCs;
            }
            
            // Re-renderizar tabela
            renderRNCs(currentTab);
            
            // Atualizar ícones de ordenação
            updateSortIcons(column, currentSortDirection);
        }
        
        // Função para atualizar ícones de ordenação
        function updateSortIcons(activeColumn, direction) {
            const headers = document.querySelectorAll('.sortable');
            headers.forEach(header => {
                header.classList.remove('asc', 'desc');
                if (header.onclick.toString().includes(activeColumn)) {
                    header.classList.add(direction);
                }
            });
        }
        
        // Função para limpar filtros
        function clearFilters() {
            document.getElementById('filterRncNumber').value = '';
            document.getElementById('filterClient').value = '';
            document.getElementById('filterEquipment').value = '';
            document.getElementById('filterDepartment').value = '';
            
            currentFilters = {
                rncNumber: '',
                client: '',
                equipment: '',
                department: ''
            };
            
            filteredRNCs = [];
            
            // Esconder contador de resultados
            const filtersContainer = document.getElementById('filtersContainer');
            const resultsCounter = filtersContainer.querySelector('.results-counter');
            if (resultsCounter) {
                resultsCounter.style.display = 'none';
            }
            
            // Recarregar RNCs sem filtros
            if (currentTab === 'finalized') {
                loadRNCs('finalized');
            }
        }
        
        // ===== FUNÇÕES PARA GRÁFICOS =====
        
        // Função para atualizar contador de RNCs
        function updateTotalCount(count) {
            // Atualizar badges de contadores se existirem
            const badges = document.querySelectorAll('.rnc-count-badge');
            badges.forEach(badge => {
                if (badge && currentTab) {
                    badge.textContent = count;
                }
            });
        }
        
        // ===== SISTEMA DE GRÁFICOS AVANÇADO =====
        let charts = {};
        let chartsData = null;
        let autoRefreshInterval = null;
        let isAutoRefreshing = false;

        function initializeCharts() {
            console.log('🎯 INICIANDO SISTEMA DE GRÁFICOS...');
            
            // Verificar se estamos na aba correta
            const chartsContainer = document.getElementById('chartsContainer');
            if (!chartsContainer) {
                console.error('❌ Container de gráficos não encontrado!');
                return;
            }
            
            console.log('✅ Container de gráficos encontrado');
            console.log('🔍 Estado atual do container:', chartsContainer.style.display);
            
            if (chartsContainer.style.display === 'none' || chartsContainer.style.display === '') {
                console.log('📊 Container estava oculto, exibindo...');
                chartsContainer.style.display = 'block';
                console.log('📊 Container agora está visível:', chartsContainer.style.display);
            }
            
            // Verificar se os elementos de canvas existem
            const canvasElements = [
                'trendChart', 'statusChart', 'priorityChart', 'usersChart', 'equipmentChart',
                'areaChart', 'scatterChart', 'stackedChart', 'heatmapChart', 'gaugeChart', 'radarChart'
            ];
            
            console.log('🔍 Verificando elementos de canvas:');
            canvasElements.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    console.log(`  ✅ ${id}: encontrado`);
                } else {
                    console.error(`  ❌ ${id}: NÃO encontrado`);
                }
            });
            
            // Delay para garantir renderização
            console.log('⏰ Aguardando renderização...');
            setTimeout(() => {
                console.log('🚀 Iniciando carregamento de dados...');
                loadChartData();
                updateKPIs();
            }, 200);
        }

        function updateKPIs() {
            fetch('/dashboard/api/kpis')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('kpi-total').textContent = data.total.toLocaleString();
                    document.getElementById('kpi-avgtime').textContent = data.avgTime + ' dias';
                    document.getElementById('kpi-resolution').textContent = data.resolution + '%';
                    document.getElementById('kpi-efficiency').textContent = data.efficiency + '%';
                    
                    // Mudanças percentuais
                    updateKPIChange('kpi-total-change', data.totalChange);
                    updateKPIChange('kpi-avgtime-change', data.avgTimeChange);
                    updateKPIChange('kpi-resolution-change', data.resolutionChange);
                    updateKPIChange('kpi-efficiency-change', data.efficiencyChange);
                })
                .catch(error => {
                    console.log('KPIs usando dados simulados');
                    // Dados simulados
                    document.getElementById('kpi-total').textContent = '2,856';
                    document.getElementById('kpi-avgtime').textContent = '7.2 dias';
                    document.getElementById('kpi-resolution').textContent = '87%';
                    document.getElementById('kpi-efficiency').textContent = '92%';
                    
                    updateKPIChange('kpi-total-change', 12);
                    updateKPIChange('kpi-avgtime-change', -8);
                    updateKPIChange('kpi-resolution-change', 5);
                    updateKPIChange('kpi-efficiency-change', 3);
                });
        }

        function updateKPIChange(elementId, change) {
            const element = document.getElementById(elementId);
            if (change > 0) {
                element.innerHTML = `↗️ +${change}%`;
                element.style.color = '#4ade80';
            } else if (change < 0) {
                element.innerHTML = `↘️ ${change}%`;
                element.style.color = '#f87171';
            } else {
                element.innerHTML = '→ Estável';
                element.style.color = '#64748b';
            }
        }

        // Função para carregar dados dos gráficos APRIMORADA
        function loadChartData() {
            const period = document.getElementById('chartPeriod').value;
            const department = document.getElementById('chartDepartment').value;
            console.log(`📊 Carregando dados avançados para ${period} dias, departamento: ${department}`);
            
            const params = new URLSearchParams({
                period: period,
                department: department
            });

            // Tentar carregar dados reais primeiro
            fetch(`/api/charts/simple-data?${params}`)
                .then(r => r.json())
                .then(resp => {
                    if (!resp || resp.success === false) {
                        console.log('API não disponível, usando dados simulados');
                        loadSimulatedData();
                        return;
                    }
                    const data = resp.data || resp;
                    console.log('✅ Dados dos gráficos avançados:', data);
                    console.log('🔍 Verificando dados específicos:');
                    console.log('  - users:', data.users);
                    console.log('  - equipment:', data.equipment);
                    createAdvancedCharts(data);
                })
                .catch(error => {
                    console.log('API não disponível, usando dados simulados:', error);
                    loadSimulatedData();
                });
        }

        // Expor loadChartData globalmente
        window.loadChartData = loadChartData;

        function loadSimulatedData() {
            console.log('📊 Carregando dados simulados para gráficos');
            // Dados simulados mais realistas baseados no banco
            const simulatedData = {
                trend: Array.from({length: 30}, (_, i) => ({
                    date: new Date(Date.now() - (29-i) * 24 * 60 * 60 * 1000).toISOString(),
                    count: Math.floor(Math.random() * 15) + 5
                })),
                status: [
                    { label: 'Aberta', count: 125, color: '#ff6b6b' },
                    { label: 'Em Análise', count: 89, color: '#4ecdc4' },
                    { label: 'Aguardando', count: 34, color: '#45b7d1' },
                    { label: 'Finalizada', count: 342, color: '#96ceb4' }
                ],
                priority: [
                    { label: 'Baixa', count: 180, color: '#4ade80' },
                    { label: 'Média', count: 250, color: '#fbbf24' },
                    { label: 'Alta', count: 120, color: '#f97316' },
                    { label: 'Crítica', count: 40, color: '#ef4444' }
                ],
                users: [
                    { label: 'João Silva', count: 25 },
                    { label: 'Maria Santos', count: 18 },
                    { label: 'Carlos Lima', count: 22 },
                    { label: 'Ana Costa', count: 15 },
                    { label: 'Pedro Rocha', count: 12 }
                ],
                equipment: [
                    { label: 'Torno CNC', count: 8 },
                    { label: 'Prensa Hidráulica', count: 12 },
                    { label: 'Soldadora MIG', count: 6 },
                    { label: 'Compressor', count: 9 },
                    { label: 'Fresa', count: 7 }
                ],
                kpis: { total: 590, resolved: 512 },
                departments: [
                    { label: 'Produção', count: 45, efficiency: 85 },
                    { label: 'Qualidade', count: 32, efficiency: 92 },
                    { label: 'Manutenção', count: 28, efficiency: 78 },
                    { label: 'Comercial', count: 15, efficiency: 95 }
                ],
                heatmap: [],
                area: {
                    dates: ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun'],
                    datasets: [
                        { label: 'Abertas', data: [20, 25, 18, 30, 22, 28] },
                        { label: 'Em Análise', data: [15, 20, 12, 25, 18, 22] },
                        { label: 'Finalizadas', data: [35, 40, 30, 45, 38, 42] }
                    ]
                },
                scatter: {
                    data: [
                        { x: 1, y: 5 }, { x: 2, y: 8 }, { x: 3, y: 12 }, { x: 4, y: 15 },
                        { x: 1, y: 3 }, { x: 2, y: 6 }, { x: 3, y: 9 }, { x: 4, y: 18 }
                    ]
                },
                stacked: {
                    labels: ['Produção', 'Qualidade', 'Manutenção', 'Comercial'],
                    datasets: [
                        { label: 'Abertas', data: [12, 8, 15, 6] },
                        { label: 'Em Análise', data: [8, 12, 10, 4] },
                        { label: 'Finalizadas', data: [25, 18, 22, 12] }
                    ]
                }
            };

            // Gerar dados do heatmap
            for (let day = 0; day < 7; day++) {
                for (let hour = 0; hour < 24; hour++) {
                    simulatedData.heatmap.push({
                        x: hour,
                        y: day,
                        v: Math.floor(Math.random() * 20) + 1
                    });
                }
            }

            createAdvancedCharts(simulatedData);
        }

        // Função para criar todos os gráficos APRIMORADA
        function createAdvancedCharts(data) {
            console.log('🎯 Iniciando criação de gráficos avançados:', data);
            console.log('🎯 Tipo de dados recebidos:', typeof data);
            console.log('🎯 Data é objeto?', data && typeof data === 'object');
            
            chartsData = data;
            
            // Destruir gráficos anteriores
            console.log('🧹 Destruindo gráficos existentes...');
            Object.values(charts).forEach(c => { 
                try { 
                    if (c && c.destroy) {
                        console.log('🗑️ Destruindo gráfico:', c);
                        c.destroy();
                    }
                } catch(e){
                    console.log('❌ Erro ao destruir gráfico:', e);
                } 
            });
            charts = {};

            // Verificar se Chart.js está disponível
            if (typeof Chart === 'undefined') {
                console.error('❌ Chart.js não está carregado!');
                return;
            }
            console.log('✅ Chart.js disponível:', Chart.version);

            // Verificar se elementos existem
            console.log('🔍 Verificando elementos de canvas...');
            const elements = ['trendChart', 'statusChart', 'priorityChart', 'usersChart', 'equipmentChart', 'areaChart', 'scatterChart', 'stackedChart', 'heatmapChart', 'gaugeChart', 'radarChart'];
            let foundElements = 0;
            elements.forEach(id => {
                const el = document.getElementById(id);
                if (!el) {
                    console.error(`❌ Elemento ${id} não encontrado!`);
                } else {
                    console.log(`✅ Elemento ${id} encontrado`);
                    foundElements++;
                }
            });
            
            console.log(`📊 Total de elementos encontrados: ${foundElements}/${elements.length}`);
            
            if (foundElements === 0) {
                console.error('❌ NENHUM elemento de canvas foi encontrado! Os gráficos não podem ser criados.');
                return;
            }

            console.log('🚀 Iniciando criação individual dos gráficos...');

            // 1. Gráfico de Tendência Aprimorado
            console.log('📈 Criando gráfico de tendência...');
            createTrendChart(data);
            
            // 2. Gráfico de Status
            console.log('📊 Criando gráfico de status...');
            createStatusChart(data);
            
            // 3. Gráfico de Prioridade
            createPriorityChart(data);
            
            // 4. Gráfico de Usuários
            console.log('🔵 Chamando createUsersChart com data:', data);
            createUsersChart(data);
            
            // 5. Gráfico de Equipamentos
            console.log('🔵 Chamando createEquipmentChart com data:', data);
            createEquipmentChart(data);
            
            // 6. Gráfico de Área
            createAreaChart(data);
            
            // 7. Scatter Plot
            createScatterChart(data);
            
            // 8. Gráfico Empilhado
            createStackedChart(data);
            
            // 9. Heatmap
            createHeatmapChart(data);
            
            // 10. Gauge
            createGaugeChart(data);
            
            // 11. Radar
            createRadarChart(data);
            
            console.log('🎯 Gráficos criados:', Object.keys(charts));
        }

        function createTrendChart(data) {
            console.log('📈 INICIANDO createTrendChart');
            const ctx = document.getElementById('trendChart');
            if (!ctx) {
                console.error('❌ Elemento trendChart não encontrado!');
                return;
            }
            console.log('✅ Canvas trendChart encontrado');
            
            if (!data || !data.trend) {
                console.error('❌ Dados de tendência não disponíveis:', data);
                return;
            }
            console.log('✅ Dados de tendência disponíveis:', data.trend);
            
            try {
            charts.trendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.trend.map(it => new Date(it.date).toLocaleDateString('pt-BR')),
                    datasets: [{
                        label: 'RNCs por Período',
                        data: data.trend.map(it => it.count),
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: '#667eea',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointRadius: 6,
                        pointHoverRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: '#fff',
                            bodyColor: '#fff',
                            borderColor: '#667eea',
                            borderWidth: 1,
                            cornerRadius: 8
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: 'rgba(0, 0, 0, 0.1)' },
                            ticks: { font: { size: 12 } }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { font: { size: 12 } }
                        }
                    },
                    animation: {
                        duration: 1000,
                        easing: 'easeInOutQuart'
                    }
                }
            });
            
            console.log('✅ Gráfico de tendência criado com sucesso:', charts.trendChart);
            
        } catch (error) {
            console.error('❌ Erro ao criar gráfico de tendência:', error);
            console.error('❌ Stack trace:', error.stack);
        }
        }

        function createStatusChart(data) {
            const ctx = document.getElementById('statusChart');
            if (!ctx) return;
            
            charts.statusChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: data.status.map(it => it.label),
                    datasets: [{
                        data: data.status.map(it => it.count),
                        backgroundColor: data.status.map(it => it.color),
                        borderWidth: 0,
                        hoverOffset: 10
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { 
                                usePointStyle: true, 
                                padding: 20,
                                font: { size: 12 }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((context.parsed * 100) / total).toFixed(1);
                                    return `${context.label}: ${context.parsed} (${percentage}%)`;
                                }
                            }
                        }
                    },
                    animation: {
                        animateRotate: true,
                        duration: 1500
                    }
                }
            });
        }

        function createPriorityChart(data) {
            const ctx = document.getElementById('priorityChart');
            if (!ctx) return;
            
            charts.priorityChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.priority.map(it => it.label),
                    datasets: [{
                        data: data.priority.map(it => it.count),
                        backgroundColor: data.priority.map(it => it.color),
                        borderRadius: 8,
                        borderSkipped: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: '#fff',
                            bodyColor: '#fff'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: 'rgba(0, 0, 0, 0.1)' }
                        },
                        x: {
                            grid: { display: false }
                        }
                    },
                    animation: {
                        delay: (context) => context.dataIndex * 100,
                        duration: 800
                    }
                }
            });
        }

        function createUsersChart(data) {
            console.log('🔵 Iniciando createUsersChart com data:', data);
            const ctx = document.getElementById('usersChart');
            if (!ctx) {
                console.error('❌ Elemento usersChart não encontrado!');
                return;
            }
            
            const context = ctx.getContext('2d');
            if (!context) {
                console.error('❌ Contexto 2D não disponível para usersChart!');
                return;
            }
            
            console.log('✅ Criando gráfico de usuários:', data.users);
            console.log('✅ Canvas usersChart encontrado e contexto 2D disponível');
            
            charts.usersChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.users ? data.users.map(it => it.label) : ['Sem dados'],
                    datasets: [{
                        data: data.users ? data.users.map(it => it.count) : [0],
                        backgroundColor: '#6f42c1',
                        borderRadius: 6,
                        borderSkipped: false
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            grid: { color: 'rgba(0, 0, 0, 0.1)' }
                        },
                        y: {
                            grid: { display: false }
                        }
                    }
                }
            });
            console.log('✅ Gráfico de usuários criado com sucesso!', charts.usersChart);
        }

        function createEquipmentChart(data) {
            console.log('🔵 Iniciando createEquipmentChart com data:', data);
            const ctx = document.getElementById('equipmentChart');
            if (!ctx) {
                console.error('❌ Elemento equipmentChart não encontrado!');
                return;
            }
            
            const context = ctx.getContext('2d');
            if (!context) {
                console.error('❌ Contexto 2D não disponível para equipmentChart!');
                return;
            }
            
            console.log('✅ Criando gráfico de equipamentos:', data.equipment);
            console.log('✅ Canvas equipmentChart encontrado e contexto 2D disponível');
            
            charts.equipmentChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: data.equipment ? data.equipment.map(it => it.label) : ['Sem dados'],
                    datasets: [{
                        data: data.equipment ? data.equipment.map(it => it.count) : [0],
                        backgroundColor: ['#fd7e14', '#20c997', '#6610f2', '#e83e8c', '#ffc107'],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { 
                                usePointStyle: true, 
                                padding: 15,
                                font: { size: 11 }
                            }
                        }
                    }
                }
            });
            console.log('✅ Gráfico de equipamentos criado com sucesso!', charts.equipmentChart);
        }

        function createAreaChart(data) {
            const ctx = document.getElementById('areaChart');
            if (!ctx) return;
            
            const colors = ['#ff6b6b', '#4ecdc4', '#45b7d1'];
            
            charts.areaChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.area.dates,
                    datasets: data.area.datasets.map((dataset, index) => ({
                        label: dataset.label,
                        data: dataset.data,
                        backgroundColor: colors[index] + '30',
                        borderColor: colors[index],
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }))
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { intersect: false },
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: { usePointStyle: true }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            stacked: true,
                            grid: { color: 'rgba(0, 0, 0, 0.1)' }
                        },
                        x: {
                            grid: { display: false }
                        }
                    }
                }
            });
        }

        function createScatterChart(data) {
            const ctx = document.getElementById('scatterChart');
            if (!ctx) return;
            
            charts.scatterChart = new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'RNCs',
                        data: data.scatter.data,
                        backgroundColor: '#e83e8c',
                        borderColor: '#e83e8c',
                        pointRadius: 8,
                        pointHoverRadius: 12
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `Prioridade: ${context.parsed.x}, Tempo: ${context.parsed.y} dias`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            type: 'linear',
                            position: 'bottom',
                            title: { display: true, text: 'Prioridade (1-4)' },
                            min: 0,
                            max: 5
                        },
                        y: {
                            title: { display: true, text: 'Tempo (dias)' },
                            min: 0
                        }
                    }
                }
            });
        }

        function createStackedChart(data) {
            const ctx = document.getElementById('stackedChart');
            if (!ctx) return;
            
            const colors = ['#ff6b6b', '#4ecdc4', '#45b7d1'];
            
            charts.stackedChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.stacked.labels,
                    datasets: data.stacked.datasets.map((dataset, index) => ({
                        label: dataset.label,
                        data: dataset.data,
                        backgroundColor: colors[index],
                        borderRadius: {
                            topLeft: index === data.stacked.datasets.length - 1 ? 6 : 0,
                            topRight: index === data.stacked.datasets.length - 1 ? 6 : 0,
                            bottomLeft: index === 0 ? 6 : 0,
                            bottomRight: index === 0 ? 6 : 0
                        }
                    }))
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { stacked: true },
                        y: { 
                            stacked: true,
                            beginAtZero: true
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: { usePointStyle: true }
                        }
                    }
                }
            });
        }

        function createHeatmapChart(data) {
            const ctx = document.getElementById('heatmapChart');
            if (!ctx) {
                console.error('❌ Elemento heatmapChart não encontrado!');
                return;
            }
            
            console.log('✅ Criando heatmap:', data.heatmap.length, 'pontos');
            
            const departments = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb'];
            const hours = Array.from({length:24}, (_, i) => `${i}h`);
            
            charts.heatmapChart = new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'RNCs',
                        data: data.heatmap,
                        backgroundColor: function(context) {
                            const value = context.parsed.v || 0;
                            const alpha = Math.min(1, Math.max(0.2, value / 20));
                            return `rgba(102, 126, 234, ${alpha})`;
                        },
                        pointRadius: function(context) {
                            return Math.max(8, Math.min(20, (context.parsed.v || 0) * 1.5));
                        }
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            type: 'linear',
                            position: 'bottom',
                            ticks: {
                                callback: function(value) {
                                    return hours[Math.round(value)] || '';
                                },
                                stepSize: 2,
                                max: 23,
                                min: 0
                            },
                            title: { display: true, text: 'Hora do Dia' }
                        },
                        y: {
                            type: 'linear',
                            ticks: {
                                callback: function(value) {
                                    return departments[Math.round(value)] || '';
                                },
                                stepSize: 1,
                                max: 6,
                                min: 0
                            },
                            title: { display: true, text: 'Dia da Semana' }
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                title: function(context) {
                                    const point = context[0];
                                    const dayIndex = Math.round(point.parsed.y);
                                    const hourIndex = Math.round(point.parsed.x);
                                    return `${departments[dayIndex]} - ${hours[hourIndex]}`;
                                },
                                label: function(context) {
                                    return `RNCs: ${context.parsed.v || 0}`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function createGaugeChart(data) {
            const ctx = document.getElementById('gaugeChart');
            if (!ctx) return;
            
            const total = Math.max(1, parseInt(data.kpis.total || 0, 10));
            const resolved = Math.max(0, parseInt(data.kpis.resolved || 0, 10));
            const value = Math.round((resolved/total)*100);
            
            charts.gaugeChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    datasets: [{
                        data: [value, 100 - value],
                        backgroundColor: ['#4ade80', 'rgba(255, 255, 255, 0.2)'],
                        borderWidth: 0,
                        cutout: '75%'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    rotation: -90,
                    circumference: 180,
                    plugins: {
                        legend: { display: false },
                        tooltip: { enabled: false }
                    }
                },
                plugins: [{
                    beforeDraw: function(chart) {
                        const ctx = chart.ctx;
                        ctx.save();
                        
                        const centerX = chart.chartArea.left + (chart.chartArea.right - chart.chartArea.left) / 2;
                        const centerY = chart.chartArea.top + (chart.chartArea.bottom - chart.chartArea.top) / 2;
                        
                        ctx.font = 'bold 24px Arial';
                        ctx.fillStyle = '#fff';
                        ctx.textAlign = 'center';
                        ctx.fillText(`${value}%`, centerX, centerY + 10);
                        
                        ctx.restore();
                    }
                }]
            });
        }

        function createRadarChart(data) {
            const ctx = document.getElementById('radarChart');
            if (!ctx) return;
            
            charts.radarChart = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: data.departments.map(d => d.label),
                    datasets: [{
                        label: 'Performance',
                        data: data.departments.map(d => d.efficiency),
                        borderColor: 'rgba(255, 255, 255, 0.8)',
                        backgroundColor: 'rgba(255, 255, 255, 0.2)',
                        borderWidth: 2,
                        pointBackgroundColor: '#fff',
                        pointBorderColor: 'rgba(255, 255, 255, 0.8)',
                        pointRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        r: {
                            angleLines: { color: 'rgba(255, 255, 255, 0.3)' },
                            grid: { color: 'rgba(255, 255, 255, 0.3)' },
                            pointLabels: { color: '#fff', font: { size: 12 } },
                            ticks: { 
                                color: 'rgba(255, 255, 255, 0.7)',
                                backdropColor: 'transparent'
                            },
                            min: 0,
                            max: 100
                        }
                    }
                }
            });
        }

        function toggleChartType(chartId) {
            const chart = charts[chartId];
            if (!chart) return;
            
            const currentType = chart.config.type;
            const newType = currentType === 'line' ? 'bar' : 'line';
            
            chart.config.type = newType;
            chart.update();
        }

        function autoRefreshCharts() {
            const btn = document.getElementById('autoRefreshBtn');
            
            if (isAutoRefreshing) {
                clearInterval(autoRefreshInterval);
                isAutoRefreshing = false;
                btn.innerHTML = '🔄 Auto';
                btn.style.background = '#17a2b8';
            } else {
                autoRefreshInterval = setInterval(() => {
                    loadChartData();
                    updateKPIs();
                }, 30000); // 30 segundos
                isAutoRefreshing = true;
                btn.innerHTML = '⏸️ Parar';
                btn.style.background = '#dc3545';
            }
        }

        function updateHeatmap() {
            const period = document.getElementById('heatmapPeriod').value;
            loadChartData(); // Recarregar com novo período
        }
        
        // Função para carregar dados dos gráficos
        function loadChartData() {
            const period = document.getElementById('chartPeriod').value;
            console.log(`📊 Carregando dados (enhanced) para ${period} dias`);
            
            fetch(`/api/charts/simple-data?period=${period}`)
                .then(r => r.json())
                .then(resp => {
                    if (!resp || resp.success === false) {
                        console.error('❌ Erro ao carregar dados dos gráficos:', resp && (resp.message || resp.error));
                        return;
                    }
                    const data = resp.data || resp; // compatibilidade
                    console.log('✅ Dados dos gráficos (enhanced):', data);
                    createCharts(data);
                })
                .catch(error => {
                    console.error('❌ Erro ao carregar dados dos gráficos:', error);
                });
        }
        
        // Função para criar todos os gráficos
        function createCharts(data) {
            chartsData = data;
            
            // Destruir gráficos Chart.js anteriores de forma mais robusta
            Object.values(charts).forEach(c => { 
                try { 
                    if (c && typeof c.destroy === 'function') {
                        c.destroy(); 
                    }
                } catch(e){
                    console.warn('Erro ao destruir gráfico Chart.js:', e);
                } 
            });
            charts = {};
            
            // Destruir gráficos avançados de forma mais robusta
            try { 
                if (window.advancedCharts && typeof window.advancedCharts.destroyChart === 'function') { 
                    ['heatmapChart','gaugeChart','radarChart','sankeyChart','treemapChart'].forEach(id => {
                        try {
                            advancedCharts.destroyChart(id);
                        } catch(e) {
                            console.warn(`Erro ao destruir gráfico avançado ${id}:`, e);
                        }
                    }); 
                } 
            } catch(e){
                console.warn('Erro ao destruir gráficos avançados:', e);
            }

            // Tendência
            if (data.trend && data.trend.length) {
                const el = document.getElementById('trendChart');
                if (el) {
                    charts.trendChart = new Chart(el, {
                        type: 'line',
                        data: {
                            labels: data.trend.map(it => new Date(it.date).toLocaleDateString('pt-BR')),
                            datasets: [{
                                label: 'RNCs Criados',
                                data: data.trend.map(it => it.count),
                                borderColor: '#0d6efd',
                                backgroundColor: 'rgba(13, 110, 253, .12)',
                                borderWidth: 3,
                                tension: .35,
                                fill: true
                            }]
                        },
                        options: { responsive:true, maintainAspectRatio:false, plugins:{ legend:{ display:false } }, scales:{ y:{ beginAtZero:true } } }
                    });
                }
            }

            // Status
            if (data.status && data.status.length) {
                const el = document.getElementById('statusChart');
                if (el) {
                    const colors = data.status.map(it => it.color || '#6c757d');
                    charts.statusChart = new Chart(el, {
                        type: 'doughnut',
                        data: { labels: data.status.map(it => it.label), datasets: [{ data: data.status.map(it => it.count), backgroundColor: colors, borderWidth: 2, borderColor: '#fff' }] },
                        options: { responsive:true, maintainAspectRatio:false, plugins:{ legend:{ position:'bottom', labels:{ usePointStyle:true, padding:16 } } } }
                    });
                }
            }

            // Prioridade
            if (data.priority && data.priority.length) {
                const el = document.getElementById('priorityChart');
                if (el) {
                    const colors = data.priority.map(it => it.color || '#6c757d');
                    charts.priorityChart = new Chart(el, {
                        type: 'bar',
                        data: { labels: data.priority.map(it => it.label), datasets: [{ label:'RNCs', data: data.priority.map(it => it.count), backgroundColor: colors }] },
                        options: { responsive:true, maintainAspectRatio:false, plugins:{ legend:{ display:false } }, scales:{ y:{ beginAtZero:true } } }
                    });
                }
            }

            // Heatmap (departamentos vs tempo) — construir matriz 7x24
            if (data.heatmap && data.heatmap.length && window.createHeatmap) {
                const yLabels = ['Dom','Seg','Ter','Qua','Qui','Sex','Sáb'];
                const xLabels = Array.from({length:24},(_,h)=> `${h}h`);
                const values = Array.from({length:7},()=> Array.from({length:24},()=>0));
                data.heatmap.forEach(p => {
                    const y = Math.max(0, Math.min(6, parseInt(p.y||0,10)));
                    const x = Math.max(0, Math.min(23, parseInt(p.x||0,10)));
                    const v = parseInt(p.v||0,10);
                    values[y][x] = v;
                });
                
                // Criar heatmap garantindo destruição prévia e sem concorrência
                try {
                    if (window.advancedCharts && typeof window.advancedCharts.destroyChart === 'function') {
                        window.advancedCharts.destroyChart('heatmapChart');
                    }
                } catch(_){}
                setTimeout(() => {
                    try {
                        createHeatmap('heatmapChart', { xLabels, yLabels, values }, {});
                    } catch (error) {
                        console.error('Erro ao criar heatmap:', error);
                    }
                }, 50);
            }

            // Gauge — taxa de resolução
            if (data.kpis && typeof data.kpis.resolved !== 'undefined') {
                const total = Math.max(1, parseInt(data.kpis.total || 0, 10));
                const resolved = Math.max(0, parseInt(data.kpis.resolved || 0, 10));
                const value = Math.round((resolved/total)*100);
                if (window.createGauge) {
                    // Destruir o gráfico anterior se existir para evitar sobreposição
                    try {
                        if (window.advancedCharts && typeof window.advancedCharts.destroyChart === 'function') {
                            window.advancedCharts.destroyChart('gaugeChart');
                        }
                    } catch(_){}
                    
                    // Usar await para aguardar a criação do gráfico
                    (async () => {
                        try {
                            await createGauge('gaugeChart', value, { 
                                title: 'Taxa de Resolução', 
                                label: `${resolved}/${total} resolvidos`, 
                                unit: '%',
                                animation: {
                                    animateRotate: true,
                                    duration: 2000,
                                    easing: 'easeInOutQuart'
                                },
                                colors: {
                                    track: 'rgba(255,255,255,0.2)',
                                    progress: value >= 80 ? '#28a745' : value >= 60 ? '#ffc107' : '#dc3545',
                                    background: 'rgba(255,255,255,0.1)'
                                },
                                fontSize: 28,
                                valueSize: 72,
                                shadow: {
                                    shadowColor: 'rgba(0,0,0,0.3)',
                                    shadowBlur: 15,
                                    shadowOffsetX: 0,
                                    shadowOffsetY: 5
                                }
                            });
                        } catch (error) {
                            console.error('Erro ao criar gauge:', error);
                        }
                    })();
                }
            }

            // Radar — performance por departamento (quantidade vs eficiência)
            if (data.departments && data.departments.length && window.createAdvancedRadar) {
                const labels = data.departments.map(d => d.label || d.department || '');
                const ds = [
                    { 
                        label: 'Quantidade', 
                        data: data.departments.map(d => d.count),
                        backgroundColor: 'rgba(102, 126, 234, 0.25)',
                        borderColor: '#667eea',
                        pointBackgroundColor: '#667eea',
                        pointBorderColor: '#ffffff',
                        pointBorderWidth: 3
                    },
                    { 
                        label: 'Eficiência', 
                        data: data.departments.map(d => Math.round(d.efficiency || 0)),
                        backgroundColor: 'rgba(118, 75, 162, 0.25)',
                        borderColor: '#764ba2',
                        pointBackgroundColor: '#764ba2',
                        pointBorderColor: '#ffffff',
                        pointBorderWidth: 3
                    }
                ];
                // Destruir o gráfico anterior se existir para evitar sobreposição
                const oldChart = window.advancedCharts && window.advancedCharts.charts.get('radarChart');
                if (oldChart) {
                    oldChart.destroy();
                    window.advancedCharts.charts.delete('radarChart');
                }
                
                // Usar await para aguardar a criação do gráfico
                (async () => {
                    try {
                        await createAdvancedRadar('radarChart', { labels, datasets: ds }, { 
                            maxValue: 100,
                            animation: {
                                duration: 2000,
                                easing: 'easeInOutElastic'
                            },
                            plugins: {
                                legend: {
                                    position: 'bottom',
                                    labels: {
                                        color: 'white',
                                        font: {
                                            size: 14,
                                            weight: 'bold'
                                        },
                                        padding: 20,
                                        usePointStyle: true
                                    }
                                },
                                tooltip: {
                                    backgroundColor: 'rgba(0,0,0,0.8)',
                                    titleColor: 'white',
                                    bodyColor: 'white',
                                    borderColor: 'rgba(255,255,255,0.3)',
                                    borderWidth: 1
                        }
                    },
                    scales: {
                        r: {
                            ticks: {
                                stepSize: 20,
                                showLabelBackdrop: false,
                                backdropColor: 'rgba(255, 255, 255, 0.1)',
                                color: 'rgba(255,255,255,0.8)',
                                font: {
                                    size: 12,
                                    weight: 'bold'
                                }
                            },
                            grid: {
                                color: 'rgba(255,255,255,0.3)',
                                lineWidth: 2
                            },
                            angleLines: {
                                color: 'rgba(255,255,255,0.4)',
                                lineWidth: 2
                            },
                            pointLabels: {
                                color: 'white',
                                font: {
                                    size: 13,
                                    weight: 'bold'
                                }
                            }
                        }
                    }
                        });
                    } catch (error) {
                        console.error('Erro ao criar radar chart:', error);
                    }
                })();
            }
        }

        // Funções para o modal de ampliação de gráficos
        let currentModalChart = null;
        
        function openChartModal(title, chartId) {
            // Definir o título do modal
            document.getElementById('chartModalTitle').textContent = title;
            
            // Exibir o modal
            document.getElementById('chartModal').style.display = 'block';
            
            // Destruir gráfico anterior se existir
            if (currentModalChart) {
                currentModalChart.destroy();
                currentModalChart = null;
            }
            
            // Criar uma cópia ampliada do gráfico
            const canvas = document.getElementById('chartModalCanvas');
            const ctx = canvas.getContext('2d');
            
            // Verificar o tipo de gráfico e recriar no modal
            if (chartId === 'heatmapChart' && window.createHeatmap && chartsData.heatmap) {
                const yLabels = ['Dom','Seg','Ter','Qua','Qui','Sex','Sáb'];
                const xLabels = Array.from({length:24},(_,h)=> `${h}h`);
                const values = Array.from({length:7},()=> Array.from({length:24},()=>0));
                chartsData.heatmap.forEach(p => {
                    const y = Math.max(0, Math.min(6, parseInt(p.y||0,10)));
                    const x = Math.max(0, Math.min(23, parseInt(p.x||0,10)));
                    const v = parseInt(p.v||0,10);
                    values[y][x] = v;
                });
                
                (async () => {
                    try {
                        currentModalChart = await createHeatmap('chartModalCanvas', { xLabels, yLabels, values }, {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Mapa de Calor - RNCs por Período',
                            font: {
                                size: 18,
                                weight: 'bold'
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.data[context.dataIndex]} RNCs`;
                                }
                            }
                        }
                    }
                        });
                    } catch (error) {
                        console.error('Erro ao criar heatmap modal:', error);
                    }
                })();
                
            } else if (chartId === 'gaugeChart' && window.createGauge && chartsData.kpis) {
                const total = Math.max(1, parseInt(chartsData.kpis.total || 0, 10));
                const resolved = Math.max(0, parseInt(chartsData.kpis.resolved || 0, 10));
                const value = Math.round((resolved/total)*100);
                
                (async () => {
                    try {
                        currentModalChart = await createGauge('chartModalCanvas', value, { 
                    title: 'Taxa de Resolução', 
                    label: `${resolved}/${total} resolvidos`, 
                    unit: '%',
                    animation: {
                        animateRotate: true,
                        duration: 2500,
                        easing: 'easeInOutBounce'
                    },
                    colors: {
                        track: 'rgba(200,200,200,0.3)',
                        progress: value >= 80 ? '#28a745' : value >= 60 ? '#ffc107' : '#dc3545',
                        background: '#f8f9fa'
                    },
                    fontSize: 32,
                    valueSize: 80,
                    shadow: {
                        shadowColor: 'rgba(0,0,0,0.2)',
                        shadowBlur: 20,
                        shadowOffsetX: 0,
                        shadowOffsetY: 8
                    }
                        });
                    } catch (error) {
                        console.error('Erro ao criar gauge modal:', error);
                    }
                })();
                
            } else if (chartId === 'radarChart' && window.createAdvancedRadar && chartsData.departments) {
                const labels = chartsData.departments.map(d => d.label);
                const ds = [
                    { 
                        label: 'Quantidade', 
                        data: chartsData.departments.map(d => d.count),
                        backgroundColor: 'rgba(102, 126, 234, 0.3)',
                        borderColor: '#667eea',
                        borderWidth: 3,
                        pointBackgroundColor: '#667eea',
                        pointBorderColor: '#ffffff',
                        pointBorderWidth: 4,
                        pointRadius: 8
                    },
                    { 
                        label: 'Eficiência', 
                        data: chartsData.departments.map(d => Math.round(d.efficiency || 0)),
                        backgroundColor: 'rgba(118, 75, 162, 0.3)',
                        borderColor: '#764ba2',
                        borderWidth: 3,
                        pointBackgroundColor: '#764ba2',
                        pointBorderColor: '#ffffff',
                        pointBorderWidth: 4,
                        pointRadius: 8
                    }
                ];
                
                (async () => {
                    try {
                        currentModalChart = await createAdvancedRadar('chartModalCanvas', { labels, datasets: ds }, { 
                            maxValue: 100,
                            animation: {
                                duration: 2500,
                                easing: 'easeInOutElastic'
                            },
                            plugins: {
                                legend: {
                                    position: 'bottom',
                                    labels: {
                                        font: {
                                            size: 16,
                                            weight: 'bold'
                                        },
                                        padding: 25,
                                        usePointStyle: true
                                    }
                                },
                                tooltip: {
                                    backgroundColor: 'rgba(0,0,0,0.9)',
                                    titleColor: 'white',
                                    bodyColor: 'white',
                                    borderColor: 'rgba(255,255,255,0.3)',
                                    borderWidth: 2,
                                    cornerRadius: 10
                                },
                                title: {
                                    display: true,
                                    text: 'Análise Comparativa de Departamentos',
                                    font: {
                                        size: 22,
                                        weight: 'bold'
                                    },
                                    padding: 25
                                }
                            },
                            scales: {
                                r: {
                                    ticks: {
                                        stepSize: 20,
                                        showLabelBackdrop: false,
                                        backdropColor: 'rgba(255, 255, 255, 0.1)',
                                        font: {
                                            size: 14,
                                            weight: 'bold'
                                        }
                                    },
                                    grid: {
                                        color: 'rgba(0,0,0,0.2)',
                                        lineWidth: 2
                                    },
                                    angleLines: {
                                        color: 'rgba(0,0,0,0.3)',
                                        lineWidth: 2
                                    },
                                    pointLabels: {
                                        font: {
                                            size: 15,
                                            weight: 'bold'
                                        }
                                    }
                                }
                            }
                        });
                    } catch (error) {
                        console.error('Erro ao criar radar modal:', error);
                    }
                })();
                
            } else {
                // Para gráficos Chart.js padrão (tendência, status, prioridade)
                const originalChart = charts[chartId];
                if (originalChart) {
                    // Clonar configurações do gráfico original
                    const config = {
                        type: originalChart.config.type,
                        data: JSON.parse(JSON.stringify(originalChart.config.data)),
                        options: JSON.parse(JSON.stringify(originalChart.config.options))
                    };
                    
                    // Melhorar as opções para o modal
                    config.options.responsive = true;
                    config.options.maintainAspectRatio = false;
                    
                    // Aumentar tamanho das fontes
                    if (config.options.plugins && config.options.plugins.legend) {
                        config.options.plugins.legend.labels = config.options.plugins.legend.labels || {};
                        config.options.plugins.legend.labels.font = { size: 16 };
                        config.options.plugins.legend.labels.padding = 20;
                    } else {
                        config.options.plugins = config.options.plugins || {};
                        config.options.plugins.legend = {
                            position: 'bottom',
                            labels: {
                                font: { size: 16 },
                                padding: 20
                            }
                        };
                    }
                    
                    // Adicionar título
                    config.options.plugins.title = {
                        display: true,
                        text: title,
                        font: {
                            size: 20,
                            weight: 'bold'
                        },
                        padding: 20
                    };
                    
                    // Melhorar animações
                    config.options.animation = {
                        duration: 1500,
                        easing: 'easeOutQuart'
                    };
                    
                    // Criar o gráfico no modal
                    currentModalChart = new Chart(ctx, config);
                }
            }
        }
        
        function closeChartModal() {
            document.getElementById('chartModal').style.display = 'none';
            if (currentModalChart) {
                currentModalChart.destroy();
                currentModalChart = null;
            }
        }
        
        // Fechar o modal ao clicar fora do conteúdo
        window.onclick = function(event) {
            const modal = document.getElementById('chartModal');
            if (event.target === modal) {
                closeChartModal();
            }
        };
        
        // ===== Exportação de Gráficos =====
        function exportChartsPDF() {
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('p', 'mm', 'a4');
                const margin = 12;
                let y = margin;

                // Cabeçalho
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(16);
                doc.text('Relatório de Gráficos - IPPEL RNC', 105, y, { align: 'center' });
                y += 8;
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(10);
                const period = document.getElementById('chartPeriod').value;
                const dateStr = new Date().toLocaleString('pt-BR');
                doc.text(`Período: últimos ${period} dias | Gerado em: ${dateStr}`, 105, y, { align: 'center' });
                y += 10;

                // Resumo (se disponível)
                if (chartsData && chartsData.status && chartsData.status.length) {
                    doc.setFont('helvetica', 'bold');
                    doc.text('Resumo por Status', margin, y);
                    y += 6;
                    doc.setFont('helvetica', 'normal');
                    chartsData.status.forEach(item => {
                        doc.text(`- ${item.label}: ${item.count}`, margin, y);
                        y += 5;
                    });
                }

                // Função para inserir um gráfico por página
                const addChart = (chart, title) => {
                    if (!chart) return;
                    const img = chart.toBase64Image();
                    doc.addPage();
                    doc.setFont('helvetica', 'bold');
                    doc.setFontSize(14);
                    doc.text(title, 105, 14, { align: 'center' });
                    // Ajustar imagem mantendo margens
                    const imgWidth = 180; // mm
                    const imgHeight = 110; // proporcional para caber
                    doc.addImage(img, 'PNG', (210 - imgWidth) / 2, 22, imgWidth, imgHeight);
                };

                addChart(charts.statusChart, 'Status dos RNCs');
                addChart(charts.trendChart, 'Tendência Temporal');
                addChart(charts.clientChart, 'RNCs por Cliente');
                addChart(charts.equipmentChart, 'RNCs por Equipamento');
                addChart(charts.departmentChart, 'RNCs por Departamento');
                addChart(charts.priorityChart, 'RNCs por Prioridade');
                addChart(charts.dispositionChart, 'Disposição dos RNCs');
                addChart(charts.userChart, 'RNCs por Usuário');

                doc.save(`Relatorio_Graficos_RNC.pdf`);
            } catch (e) {
                console.error('Erro ao exportar PDF:', e);
                alert('Erro ao exportar PDF');
            }
        }

        function downloadURI(uri, filename) {
            const link = document.createElement('a');
            link.href = uri;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function exportChartsPNGs() {
            try {
                const items = [
                    { c: charts.trendChart, n: 'tendencia' },
                    { c: charts.statusChart, n: 'status' },
                    { c: charts.priorityChart, n: 'prioridade' },
                ];
                const ts = new Date().toISOString().slice(0,19).replace(/[:T]/g,'-');
                items.forEach(it => {
                    if (it.c && typeof it.c.toBase64Image === 'function') {
                        const uri = it.c.toBase64Image();
                        downloadURI(uri, `grafico_${it.n}_${ts}.png`);
                    }
                });
                // Avançados: export via canvas toDataURL
                ['heatmapChart','gaugeChart','radarChart'].forEach(id => {
                    const canvas = document.getElementById(id);
                    if (canvas) {
                        const uri = canvas.toDataURL('image/png');
                        downloadURI(uri, `grafico_${id}_${ts}.png`);
                    }
                });
            } catch (e) {
                console.error('Erro ao exportar PNGs:', e);
                alert('Erro ao exportar PNGs');
            }
        }
        
        // Modificar a função switchTab para incluir gráficos APRIMORADOS
        const originalSwitchTab = switchTab;
        switchTab = function(tab) {
            originalSwitchTab(tab);
            
            // Mostrar/ocultar container de gráficos
            const chartsContainer = document.getElementById('chartsContainer');
            if (chartsContainer) {
                if (tab === 'charts') {
                    chartsContainer.style.display = 'block';
                    console.log('📊 Inicializando sistema de gráficos avançado...');
                    setTimeout(() => {
                        initializeCharts();
                    }, 100); // Pequeno delay para garantir que os elementos estejam visíveis
                } else {
                    chartsContainer.style.display = 'none';
                    // Parar atualização automática quando sair da aba
                    if (isAutoRefreshing) {
                        autoRefreshCharts();
                    }
                }
            }
            
            // Mostrar/ocultar Levantamento 14-15
            const lev1415 = document.getElementById('lev1415Container');
            if (lev1415) {
                lev1415.style.display = (tab === 'lev1415') ? 'block' : 'none';
                if (tab === 'lev1415') {
                    if (typeof fillYearSelect === 'function') fillYearSelect();
                    if (typeof loadLev1415 === 'function') loadLev1415();
                    if (typeof loadLevByYear === 'function') loadLevByYear();
                }
            }
        };
        
        // ===== Aba Levantamento: exibir imagem enviada =====
        let levZoom = 1;
        function levZoomIn() { levZoom = Math.min(2.5, levZoom + 0.1); applyLevZoom(); }
        function levZoomOut() { levZoom = Math.max(0.5, levZoom - 0.1); applyLevZoom(); }
        function levZoomReset() { levZoom = 1; applyLevZoom(); }
        function applyLevZoom() {
            const img = document.getElementById('levantamentoImage');
            if (img) img.style.transform = `scale(${levZoom})`;
        }
        function downloadLevImage() {
            const a = document.createElement('a');
            a.href = document.getElementById('levantamentoImage').src;
            a.download = 'levantamento_rnc.png';
            document.body.appendChild(a); a.click(); document.body.removeChild(a);
        }

        // Upload/erro de imagem do Levantamento (client-side only)
        function triggerLevUpload() {
            const input = document.getElementById('levUpload');
            if (input) input.click();
        }
        function handleLevUpload(evt) {
            const file = evt.target.files && evt.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = e => {
                const img = document.getElementById('levantamentoImage');
                if (img) img.src = e.target.result;
                const msg = document.getElementById('levEmptyMsg');
                if (msg) msg.style.display = 'none';
            };
            reader.readAsDataURL(file);
        }
        function levImageError() {
            const msg = document.getElementById('levEmptyMsg');
            if (msg) msg.style.display = 'block';
        }

        // CSV -> Tabela (para ver os dados clicando)
        function openLevCsv() {
            const input = document.getElementById('levCsvUpload');
            if (input) input.click();
        }
        function handleLevCsvUpload(evt) {
            const file = evt.target.files && evt.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = e => {
                const text = e.target.result || '';
                const rows = text.split(/\r?\n/).filter(l => l.trim().length > 0).map(l => l.split(/;|\t|,/));
                renderLevTable(rows);
            };
            reader.readAsText(file, 'utf-8');
        }
        function renderLevTable(rows) {
            const tableDiv = document.getElementById('levTableContainer');
            const imgDiv = document.getElementById('levImageWrapper');
            if (!rows || rows.length === 0) {
                tableDiv.style.display = 'block';
                imgDiv.style.display = 'none';
                tableDiv.innerHTML = '<div style="padding:14px; color:#666; text-align:center;">CSV vazio</div>';
                return;
            }
            const header = rows[0];
            const body = rows.slice(1);
            const html = `
                <table style="width:100%; border-collapse:collapse; font-size:12px;">
                  <thead>
                    <tr>${header.map(h => `<th style="position:sticky; top:0; background:#f8f9fa; border-bottom:1px solid #e9ecef; padding:8px; text-align:left;">${h}</th>`).join('')}</tr>
                  </thead>
                  <tbody>
                    ${body.map(r => `<tr>${r.map(c => `<td style=\"border-top:1px solid #f1f3f5; padding:8px; white-space:nowrap;\">${c}</td>`).join('')}</tr>`).join('')}
                  </tbody>
                </table>`;
            tableDiv.innerHTML = html;
            tableDiv.style.display = 'block';
            imgDiv.style.display = 'none';
        }
        function showLevTable() {
            const tableDiv = document.getElementById('levTableContainer');
            const imgDiv = document.getElementById('levImageWrapper');
            tableDiv.style.display = 'block';
            imgDiv.style.display = 'none';
        }
        function showLevImage() {
            const tableDiv = document.getElementById('levTableContainer');
            const imgDiv = document.getElementById('levImageWrapper');
            tableDiv.style.display = 'none';
            imgDiv.style.display = 'block';
        }

        // Modal de informações do Levantamento (conteúdo local em memória)
        let levInfoText = '';
        function openLevInfo() {
            document.getElementById('levInfoModal').style.display = 'block';
            const body = document.getElementById('levInfoBody');
            body.innerHTML = levInfoText
                ? `<div style=\"white-space:pre-wrap;\">${levInfoText}</div>`
                : '<div style="text-align:center; color:#6c757d;">Nenhuma informação cadastrada. Clique em "Editar" para inserir.</div>';
        }
        function closeLevInfo() {
            document.getElementById('levInfoModal').style.display = 'none';
        }
        function editLevInfo() {
            const current = levInfoText || '';
            const hint = 'Digite/cole abaixo as informações do levantamento (texto livre).';
            const next = prompt(hint, current);
            if (next !== null) {
                levInfoText = next.trim();
                openLevInfo();
            }
        }

        // ===== Levantamento 2014-2015 (dados fixos) =====
        const LEV1415_HEADER = ['Data','Produção','Engenharia','Terceiros','Compras','Comercial','Cliente','PCP','Expedição','Qualidade','Transporte','Não definido','Total'];
        const LEV1415_ROWS = [
            ['01/14','R$ 3,489.00','R$ 16,198.42','R$ 1,285.00','R$ 0.00','R$ 0.00','R$ 10.00','R$ 0.00','R$ 0.00','R$ 0.00','R$ 20,982.42'],
            ['02/14','R$ 5,141.00','R$ 4,037.50','R$ 3,922.50','R$ 1,040.00','R$ 0.00','R$ 170.00','R$ 0.00','R$ 0.00','R$ 0.00','R$ 14,311.00'],
            ['03/14','R$ 11,737.23','R$ 43,226.84','R$ 4,858.00','R$ 12.50','R$ 0.00','R$ 25.00','R$ 0.00','R$ 0.00','R$ 0.00','R$ 59,859.57'],
            ['04/14','R$ 12,414.55','R$ 3,886.94','R$ 1,110.00','R$ 0.00','R$ 0.00','R$ 0.00','R$ 5,200.00','R$ 0.00','R$ 0.00','R$ 22,611.49'],
            ['05/14','R$ 4,692.44','R$ 7,957.66','R$ 826.48','R$ 125.63','R$ 0.00','R$ 0.00','R$ 0.00','R$ 0.00','R$ 0.00','R$ 13,602.21'],
            ['06/14','R$ 7,253.83','R$ 3,355.55','R$ 410.00','R$ 642.17','R$ 0.00','R$ 0.00','R$ 0.00','R$ 25.00','R$ 45.00','R$ 11,731.55'],
            ['07/14','R$ 5,660.89','R$ 3,568.30','R$ 2,827.50','R$ 0.00','R$ 0.00','R$ 0.00','R$ 0.00','R$ 0.00','R$ 0.00','R$ 12,056.69'],
            ['08/14','R$ 5,485.08','R$ 3,439.44','R$ 565.00','R$ 25.00','R$ 0.00','R$ 0.00','R$ 0.00','R$ 0.00','R$ 0.00','R$ 9,514.52'],
            ['09/14','R$ 6,670.13','R$ 5,804.72','R$ 715.00','R$ 50.00','R$ 0.00','R$ 0.00','R$ 0.00','R$ 0.00','R$ 0.00','R$ 13,239.85'],
            ['10/14','R$ 5,288.41','R$ 3,392.45','R$ 4,050.15','R$ 0.00','R$ 0.00','R$ 25.00','R$ 0.00','R$ 0.00','R$ 0.00','R$ 12,756.01'],
            ['11/14','R$ 5,542.73','R$ 5,124.36','R$ 445.00','R$ 135.70','R$ 0.00','R$ 0.00','R$ 0.00','R$ 0.00','R$ 0.00','R$ 11,247.79'],
            ['12/14','R$ 4,162.06','R$ 2,188.26','R$ 524.00','R$ 0.00','R$ 0.00','R$ 0.00','R$ 0.00','R$ 0.00','R$ 0.00','R$ 6,874.32'],
            ['Total ano:','R$ 208,787.42','','','','','','','','','']
        ];
        const LEV1515_ROWS = [
            ['01/15','R$ 5,568.84','R$ 13,800.60','R$ 485.00','R$ 0.00','R$ 0.00','R$ 0.00','R$ 0.00','R$ 0.00','R$ 0.00','R$ 19,854.44'],
            ['02/15','R$ 6,910.13','R$ 9,794.85','R$ 930.00','R$ 0.00','R$ 0.00','R$ 0.00','R$ 0.00','R$ 0.00','R$ 0.00','R$ 17,634.98'],
            ['03/15','R$ 5,861.84','R$ 13,610.00','R$ 1,495.00','R$ 40.00','R$ 0.00','R$ 0.00','R$ 0.00','R$ 0.00','R$ 0.00','R$ 21,006.84'],
            ['04/15','R$ 5,619.41','R$ 7,847.50','R$ 3,120.00','R$ 100.00','R$ 0.00','R$ 0.00','R$ 0.00','R$ 0.00','R$ 0.00','R$ 16,686.91'],
            ['05/15','R$ 7,179.15','R$ 18,663.29','R$ 4,485.00','R$ 0.00','R$ 0.00','R$ 0.00','R$ 0.00','R$ 0.00','R$ 0.00','R$ 30,327.44'],
            ['06/15','R$ 6,060.86',' R$ 21,383.46 ','R$ 4,153.82','R$ 0.00','R$ 0.00','R$ 0.00','R$ 0.00','R$ 0.00','R$ 0.00','R$ 31,598.14'],
            ['07/15','R$ 6,779.85','R$ 5,282.84','R$ 505.00','R$ 0.00','R$ 25.00','R$ 0.00','R$ 0.00','R$ 0.00','R$ 0.00','R$ 12,592.69'],
            ['08/15','R$ 4,540.19','R$ 3,879.49','R$ 460.00','R$ 0.00','R$ 0.00','R$ 0.00','R$ 0.00','R$ 0.00','R$ 0.00','R$ 8,879.68'],
            ['09/15','R$ 1,812.38','R$ 927.50','R$ 215.53','R$ 0.00','R$ 0.00','R$ 100.00','R$ 0.00','R$ 0.00','R$ 0.00','R$ 3,055.41'],
            ['10/15','R$ 42,897.78','R$ 1,165.64','R$ 295.00','R$ 0.00','R$ 0.00','R$ 0.00','R$ 0.00','R$ 0.00','R$ 0.00','R$ 44,358.42'],
            ['11/15','R$ 3,198.75','R$ 1,257.83','R$ 215.00','R$ 0.00','R$ 0.00','R$ 0.00','R$ 0.00','R$ 0.00','R$ 0.00','R$ 4,671.58'],
            ['12/15','R$ 1,099.10','R$ 1,898.02','R$ 25.00','R$ 0.00','R$ 0.00','R$ 0.00','R$ 0.00','R$ 0.00','R$ 50.00','R$ 3,072.12']
        ];
        function renderLev1415(data2014 = [], data2015 = [], selectedYear = null) {
            const wrap = document.getElementById('lev1415TableWrap');
            if (!wrap) return;
            
            const makeTable = (rows) => `
                <table style="width:100%; border-collapse:collapse; font-size:12px;">
                  <thead>
                    <tr>${LEV1415_HEADER.map(h => `<th style="position:sticky; top:0; background:#f8f9fa; border-bottom:1px solid #e9ecef; padding:8px; text-align:left;">${h}</th>`).join('')}</tr>
                  </thead>
                  <tbody>
                    ${rows.map(r => `<tr>${r.map((c,i) => `<td style=\"border-top:1px solid #f1f3f5; padding:8px; white-space:nowrap; ${i===0?'font-weight:600;':''}\">${c}</td>`).join('')}</tr>`).join('')}
                  </tbody>
                </table>`;
            
            // Se um ano específico foi selecionado, mostrar apenas esse ano
            if (selectedYear && selectedYear >= 2016) {
                wrap.innerHTML = `
                  <h4 style="margin:6px 0;">📊 Ano ${selectedYear}</h4>
                  ${makeTable(data2014)}
                `;
            } else if (selectedYear) {
                // Para anos 2013-2015, mostrar dados simulados
                wrap.innerHTML = `
                  <h4 style="margin:6px 0;">📊 Ano ${selectedYear} (Dados Simulados)</h4>
                  ${makeTable(data2014)}
                `;
            } else {
                // Exibição padrão dos anos 2014 e 2015
                wrap.innerHTML = `
                  <h4 style="margin:6px 0;">📊 Ano 2014</h4>
                  ${makeTable(LEV1415_ROWS)}
                  <h4 style="margin:18px 0 6px;">📊 Ano 2015</h4>
                  ${makeTable(LEV1515_ROWS)}
                `;
            }
        }
        // Carregar dados fixos (14-15) inicialmente; ao trocar o ano mostrar somente o ano escolhido
        let _levTotalMesChart, _levPorDeptChart;
        
                function fillYearSelect() {
            const sel = document.getElementById('levYearSelect');
            if (!sel) return;
            
            sel.innerHTML = '';
            
            // Carregar anos dinamicamente da API
            loadAvailableYears(sel);
        }
        
        function parseCurrency(v){
            if (typeof v !== 'string') return Number(v||0);
            const s = v.replace(/R\$|\s/g,'').replace(/\./g,'').replace(',', '.');
            const n = parseFloat(s); return isNaN(n)?0:n;
        }
        
        // Funções da aba Indicadores removidas - funcionalidade descontinuada
        
        function loadAvailableYears(selectElement) {
            console.log('📅 Carregando anos disponíveis da API...');
            
            fetch('/api/available-years')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        console.log('📅 Anos disponíveis recebidos:', data.years);
                        
                        // Limpar opções existentes
                        selectElement.innerHTML = '';
                        
                        // Adicionar opção "Todos os anos"
                        const allOption = document.createElement('option');
                        allOption.value = '';
                        allOption.textContent = 'Todos os anos';
                        selectElement.appendChild(allOption);
                        
                        // Adicionar anos da API
                        data.years.forEach(year => {
                            const option = document.createElement('option');
                            option.value = year;
                            option.textContent = year;
                            
                            // Selecionar o ano atual por padrão
                            if (year === data.current_year) {
                                option.selected = true;
                            }
                            
                            selectElement.appendChild(option);
                        });
                        
                        console.log(`✅ ${data.years.length} anos carregados dinamicamente`);
                    } else {
                        console.error('❌ Erro na API de anos:', data.message);
                        loadYearsFallback(selectElement);
                    }
                })
                .catch(error => {
                    console.error('❌ Erro ao carregar anos da API:', error);
                    loadYearsFallback(selectElement);
                });
        }
        
        function loadAvailableMonths(selectElement) {
            console.log('📅 Carregando meses disponíveis da API...');
            
            fetch('/api/available-months')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        console.log('📅 Meses disponíveis recebidos:', data.months);
                        
                        // Limpar opções existentes
                        selectElement.innerHTML = '';
                        
                        // Adicionar opção "Todos os meses"
                        const allOption = document.createElement('option');
                        allOption.value = '';
                        allOption.textContent = 'Todos os meses';
                        selectElement.appendChild(allOption);
                        
                        // Adicionar meses da API
                        data.months.forEach(month => {
                            const option = document.createElement('option');
                            option.value = month.value;
                            option.textContent = month.name;
                            selectElement.appendChild(option);
                        });
                        
                        console.log(`✅ ${data.months.length} meses carregados dinamicamente`);
                    } else {
                        console.error('❌ Erro na API de meses:', data.message);
                        loadMonthsFallback(selectElement);
                    }
                })
                .catch(error => {
                    console.error('❌ Erro ao carregar meses da API:', error);
                    loadMonthsFallback(selectElement);
                });
        }
        
        function loadYearsFallback(selectElement) {
            console.log('📅 Carregando anos de fallback...');
            
            // Fallback com anos padrão (2013-2025)
            const fallbackYears = [2025, 2024, 2023, 2022, 2021, 2020, 2019, 2018, 2017, 2016, 2015, 2014, 2013];
            
            selectElement.innerHTML = '';
            
            // Opção "Todos os anos"
            const allOption = document.createElement('option');
            allOption.value = '';
            allOption.textContent = 'Todos os anos';
            selectElement.appendChild(allOption);
            
            // Anos de fallback
            fallbackYears.forEach(year => {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                if (year === 2025) option.selected = true;
                selectElement.appendChild(option);
            });
        }
        
        function loadMonthsFallback(selectElement) {
            console.log('📅 Carregando meses de fallback...');
            
            // Fallback com meses padrão
            const fallbackMonths = [
                {value: '01', name: 'Janeiro'},
                {value: '02', name: 'Fevereiro'},
                {value: '03', name: 'Março'},
                {value: '04', name: 'Abril'},
                {value: '05', name: 'Maio'},
                {value: '06', name: 'Junho'},
                {value: '07', name: 'Julho'},
                {value: '08', name: 'Agosto'},
                {value: '09', name: 'Setembro'},
                {value: '10', name: 'Outubro'},
                {value: '11', name: 'Novembro'},
                {value: '12', name: 'Dezembro'}
            ];
            
            selectElement.innerHTML = '';
            
            // Opção "Todos os meses"
            const allOption = document.createElement('option');
            allOption.value = '';
            allOption.textContent = 'Todos os meses';
            selectElement.appendChild(allOption);
            
            // Meses de fallback
            fallbackMonths.forEach(month => {
                const option = document.createElement('option');
                option.value = month.value;
                option.textContent = month.name;
                selectElement.appendChild(option);
            });
        }
        
        
        // Todas as funções dos indicadores foram removidas - funcionalidade descontinuada
        
        function refreshIndicadores() {
            console.log('⚠️ Função removida - funcionalidade de indicadores descontinuada');
        }
        
        function exportIndicadoresCSV() {
            console.log('⚠️ Função removida - funcionalidade de indicadores descontinuada');
        }
        
        // ================== FUNÇÕES DA ABA EVIDÊNCIAS ==================
        let evidenciasData = null;
        let evidenciasChart = null;
        
        function loadEvidencias() {
            console.log('📊 Carregando evidências mensais...');
            
            // Buscar dados das RNCs finalizadas para calcular percentuais
            // Tentar primeiro dados de engenharia, depois finalizadas, depois todas
            let sourceData = [];
            
            // CORREÇÃO CRÍTICA: Usar TODAS as RNCs finalizadas (3694), não apenas engenharia (2763)
            if (rncsData && rncsData.finalized && rncsData.finalized.length > 0) {
                sourceData = rncsData.finalized;
                console.log('✅ Usando TODAS as RNCs Finalizadas para Evidências:', sourceData.length);
            } else if (rncsData && rncsData.engenharia && rncsData.engenharia.length > 0) {
                sourceData = rncsData.engenharia;
                console.log('⚠️ Fallback: Usando apenas dados de Engenharia:', sourceData.length);
            } else if (rncsData && rncsData.active && rncsData.active.length > 0) {
                sourceData = rncsData.active;
                console.log('⚠️ Fallback: Usando dados de RNCs Ativas:', sourceData.length);
            } else {
                console.log('⏳ Aguardando dados de RNCs...');
                setTimeout(loadEvidencias, 1000);
                return;
            }
            
            try {
                const allRncs = sourceData;
                console.log(`📊 Processando ${allRncs.length} RNCs para Evidências`);
                
                // Agrupar por mês/ano e responsável usando finalized_at
                const byMonth = {};
                const byResponsible = {};
                
                // CORREÇÃO: Meta dinâmica baseada no histórico real
                const meta = Math.max(30, Math.ceil(allRncs.length / 12)); // Mínimo 30 ou média mensal
                console.log(`📊 Meta calculada: ${meta} RNCs/mês (total: ${allRncs.length} RNCs)`)
                
                allRncs.forEach(rnc => {
                    const date = rnc.finalized_at || rnc.created_at || rnc.updated_at;
                    if (!date) return;
                    
                    const d = new Date(date);
                    if (isNaN(d)) return;
                    
                    const key = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
                    // CORRIGIDO: Usar o campo 'responsavel' da RNC que contém o nome do responsável
                    const responsible = rnc.responsavel || rnc.assigned_user_name || rnc.user_name || 'Não Informado';
                    
                    // Agrupar por mês
                    if (!byMonth[key]) {
                        byMonth[key] = { 
                            count: 0, 
                            year: d.getFullYear(), 
                            month: d.getMonth() + 1,
                            responsibles: {}
                        };
                    }
                    byMonth[key].count++;
                    
                    // Agrupar por responsável dentro do mês
                    if (!byMonth[key].responsibles[responsible]) {
                        byMonth[key].responsibles[responsible] = 0;
                    }
                    byMonth[key].responsibles[responsible]++;
                    
                    // Agrupar totais por responsável
                    if (!byResponsible[responsible]) {
                        byResponsible[responsible] = 0;
                    }
                    byResponsible[responsible]++;
                });
                
                // Calcular percentuais e organizar dados
                const months = Object.keys(byMonth).sort();
                evidenciasData = {
                    months: months.map(key => {
                        const data = byMonth[key];
                        const percentage = Math.round((data.count / meta) * 100);
                        const monthNames = ['JAN', 'FEV', 'MAR', 'ABR', 'MAI', 'JUN', 'JUL', 'AGO', 'SET', 'OUT', 'NOV', 'DEZ'];
                        
                        return {
                            key,
                            year: data.year,
                            month: data.month,
                            monthName: monthNames[data.month - 1],
                            count: data.count,
                            meta,
                            percentage,
                            status: percentage >= 100 ? 'acima' : percentage >= 80 ? 'adequado' : 'abaixo',
                            responsibles: data.responsibles
                        };
                    }),
                    responsibles: byResponsible
                };
                
                populateEvidenciasYearSelect();
                generateEvidenciasTable();
                generateResponsiblesTable();
                createEvidenciasChart();
                
                console.log('✅ Evidências carregadas com sucesso!');
            } catch (error) {
                console.error('❌ Erro ao carregar evidências:', error);
            }
        }
        
        function populateEvidenciasYearSelect() {
            const select = document.getElementById('evidenciasYearSelect');
            if (!select || !evidenciasData || !evidenciasData.months) return;
            
            // Limpar opções existentes (manter "Todos os Anos")
            while (select.children.length > 1) {
                select.removeChild(select.lastChild);
            }
            
            // Obter anos únicos
            const years = [...new Set(evidenciasData.months.map(item => item.year))].sort((a, b) => b - a);
            
            years.forEach(year => {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                select.appendChild(option);
            });
            
            // Adicionar event listener
            select.onchange = () => {
                generateEvidenciasTable();
                generateResponsiblesTable();
                createEvidenciasChart();
            };
        }
        
        function generateEvidenciasTable() {
            const container = document.getElementById('evidenciasTableContent');
            if (!container || !evidenciasData || !evidenciasData.months) return;
            
            const yearFilter = document.getElementById('evidenciasYearSelect')?.value;
            let filteredData = evidenciasData.months;
            
            if (yearFilter) {
                filteredData = evidenciasData.months.filter(item => item.year == yearFilter);
            }
            
            if (filteredData.length === 0) {
                container.innerHTML = '<p style="text-align:center; color:#666;">Nenhum dado encontrado.</p>';
                return;
            }
            
            // Atualizar contador
            const countEl = document.getElementById('evidenciasTableCount');
            if (countEl) {
                countEl.textContent = `${filteredData.length} ${filteredData.length === 1 ? 'mês' : 'meses'}`;
            }
            
            // Calcular estatísticas
            let totalRNCs = 0;
            let totalMeta = 0;
            let acima = 0;
            let adequado = 0;
            let abaixo = 0;
            
            filteredData.forEach(item => {
                totalRNCs += item.count || 0;
                totalMeta += item.meta || 0;
                if (item.status === 'acima') acima++;
                else if (item.status === 'adequado') adequado++;
                else if (item.status === 'abaixo') abaixo++;
            });
            
            const mediaPercentual = filteredData.length > 0 ? Math.round(filteredData.reduce((sum, item) => sum + (item.percentage || 0), 0) / filteredData.length) : 0;
            
            // Atualizar cards de estatísticas
            const statsEl = document.getElementById('evidenciasStats');
            if (statsEl) {
                statsEl.innerHTML = `
                    <div style="background:rgba(255,255,255,0.15); backdrop-filter:blur(10px); border-radius:8px; padding:12px; border:1px solid rgba(255,255,255,0.2);">
                        <div style="font-size:11px; opacity:0.85; margin-bottom:4px;">Total RNCs</div>
                        <div style="font-size:24px; font-weight:700;">${totalRNCs}</div>
                    </div>
                    <div style="background:rgba(255,255,255,0.15); backdrop-filter:blur(10px); border-radius:8px; padding:12px; border:1px solid rgba(255,255,255,0.2);">
                        <div style="font-size:11px; opacity:0.85; margin-bottom:4px;">Meta Total</div>
                        <div style="font-size:24px; font-weight:700;">${totalMeta}</div>
                    </div>
                    <div style="background:rgba(255,255,255,0.15); backdrop-filter:blur(10px); border-radius:8px; padding:12px; border:1px solid rgba(255,255,255,0.2);">
                        <div style="font-size:11px; opacity:0.85; margin-bottom:4px;">Média %</div>
                        <div style="font-size:24px; font-weight:700;">${mediaPercentual}%</div>
                    </div>
                    <div style="background:rgba(255,255,255,0.15); backdrop-filter:blur(10px); border-radius:8px; padding:12px; border:1px solid rgba(255,255,255,0.2);">
                        <div style="font-size:11px; opacity:0.85; margin-bottom:4px;">🟢 Acima</div>
                        <div style="font-size:20px; font-weight:700;">${acima} <span style="font-size:12px; opacity:0.8;">| 🟡 ${adequado} | 🔴 ${abaixo}</span></div>
                    </div>
                `;
            }
            
            // Criar cabeçalho da tabela (moderna e compacta)
            let html = `
                <table style="width:100%; border-collapse:collapse; font-size:11px; border-radius:6px; overflow:hidden;">
                    <thead>
                        <tr style="background:linear-gradient(135deg, #667eea 0%, #764ba2 100%); color:white;">
                            <th style="padding:10px 8px; text-align:left; border:none; font-size:11px; font-weight:600;">Mês</th>
                            <th style="padding:10px 8px; text-align:center; border:none; font-size:11px; font-weight:600;">RNCs</th>
                            <th style="padding:10px 8px; text-align:center; border:none; font-size:11px; font-weight:600;">Meta</th>
                            <th style="padding:10px 8px; text-align:center; border:none; font-size:11px; font-weight:600;">%</th>
                            <th style="padding:10px 8px; text-align:center; border:none; font-size:11px; font-weight:600;">Status</th>
                            <th style="padding:10px 8px; text-align:left; border:none; font-size:11px; font-weight:600;">Responsáveis</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            // Adicionar linhas de dados
            filteredData.forEach(item => {
                const bgColor = item.status === 'acima' ? '#d1f2eb' : 
                               item.status === 'adequado' ? '#fff3cd' : '#f8d7da';
                const textColor = item.status === 'acima' ? '#0c5460' : 
                                 item.status === 'adequado' ? '#856404' : '#721c24';
                
                // Criar string dos responsáveis
                let responsiblesStr = '';
                if (item.responsibles && Object.keys(item.responsibles).length > 0) {
                    responsiblesStr = Object.entries(item.responsibles)
                        .sort((a, b) => b[1] - a[1])
                        .map(([name, count]) => `${name}: ${count}`)
                        .join('<br>');
                } else {
                    responsiblesStr = 'Não informado';
                }
                
                const rowIndex = filteredData.indexOf(item);
                const isEven = rowIndex % 2 === 0;
                const rowBg = isEven ? '#ffffff' : '#f8f9fa';
                
                html += `
                    <tr style="background:${rowBg}; transition:all 0.2s;" onmouseover="this.style.background='#e7f3ff'" onmouseout="this.style.background='${rowBg}'">
                        <td style="padding:8px 10px; border:none; border-bottom:1px solid #e9ecef; font-weight:600; font-size:11px; color:#2c3e50;">
                            ${item.monthName} ${item.year}
                        </td>
                        <td style="padding:8px 10px; text-align:center; border:none; border-bottom:1px solid #e9ecef; font-size:11px; font-weight:600; color:#495057;">
                            ${item.count}
                        </td>
                        <td style="padding:8px 10px; text-align:center; border:none; border-bottom:1px solid #e9ecef; font-size:11px; color:#6c757d;">
                            ${item.meta}
                        </td>
                        <td style="padding:8px 10px; text-align:center; border:none; border-bottom:1px solid #e9ecef;">
                            <span style="display:inline-block; padding:4px 10px; border-radius:12px; background:${bgColor}; color:${textColor}; font-weight:700; font-size:11px;">
                            ${item.percentage}%
                            </span>
                        </td>
                        <td style="padding:8px 10px; text-align:center; border:none; border-bottom:1px solid #e9ecef; font-size:16px;">
                            ${item.status === 'acima' ? '🟢' : item.status === 'adequado' ? '🟡' : '🔴'}
                        </td>
                        <td style="padding:8px 10px; border:none; border-bottom:1px solid #e9ecef; font-size:10px; line-height:1.5; color:#495057;">
                            ${responsiblesStr}
                        </td>
                    </tr>
                `;
            });
            
            // Adicionar rodapé com totais
            html += `
                    </tbody>
                    <tfoot>
                        <tr style="background:linear-gradient(135deg, #667eea 0%, #764ba2 100%); color:white; font-weight:700;">
                            <td style="padding:10px 10px; border:none; font-size:12px;">TOTAL</td>
                            <td style="padding:10px 10px; text-align:center; border:none; font-size:12px;">${totalRNCs}</td>
                            <td style="padding:10px 10px; text-align:center; border:none; font-size:12px;">${totalMeta}</td>
                            <td style="padding:10px 10px; text-align:center; border:none; font-size:12px;">${mediaPercentual}%</td>
                            <td style="padding:10px 10px; text-align:center; border:none; font-size:11px;">🟢${acima} 🟡${adequado} 🔴${abaixo}</td>
                            <td style="padding:10px 10px; border:none; font-size:11px;">${filteredData.length} ${filteredData.length === 1 ? 'mês' : 'meses'} analisados</td>
                        </tr>
                    </tfoot>
                </table>
            `;
            container.innerHTML = html;
        }
        
        function generateResponsiblesTable() {
            // Remover resumo anterior se existir
            const existingSummary = document.querySelector('#responsiblesSummary');
            if (existingSummary) {
                existingSummary.remove();
            }
            
            const summaryContainer = document.getElementById('evidenciasTableContent');
            if (!summaryContainer || !evidenciasData || !evidenciasData.responsibles) return;
            
            const yearFilter = document.getElementById('evidenciasYearSelect')?.value;
            let responsiblesData = evidenciasData.responsibles;
            
            // Se há filtro de ano, recalcular para o ano específico
            if (yearFilter) {
                responsiblesData = {};
                const filteredMonths = evidenciasData.months.filter(item => item.year == yearFilter);
                
                filteredMonths.forEach(month => {
                    if (month.responsibles) {
                        Object.entries(month.responsibles).forEach(([name, count]) => {
                            if (!responsiblesData[name]) responsiblesData[name] = 0;
                            responsiblesData[name] += count;
                        });
                    }
                });
            }
            
            // Criar resumo por responsável
            const responsiblesSorted = Object.entries(responsiblesData)
                .sort((a, b) => b[1] - a[1])
                .filter(([name, count]) => name !== 'Não Informado');
            
            if (responsiblesSorted.length > 0) {
                let summaryHtml = `
                    <div id="responsiblesSummary" style="margin-top:20px; padding:15px; background:#f8f9fa; border-radius:8px;">
                        <h4 style="margin:0 0 15px 0; color:#495057;">� Resumo por Responsável</h4>
                        <div style="display:flex; gap:20px; flex-wrap:wrap;">
                `;
                
                responsiblesSorted.forEach(([name, count]) => {
                    summaryHtml += `
                        <div style="background:white; padding:12px 16px; border-radius:6px; border:1px solid #dee2e6; min-width:150px;">
                            <div style="font-weight:600; color:#495057; margin-bottom:4px;">${name}</div>
                            <div style="font-size:18px; font-weight:700; color:#dc3545;">${count} RNCs</div>
                            <div style="font-size:12px; color:#6c757d;">Total no período</div>
                        </div>
                    `;
                });
                
                summaryHtml += '</div></div>';
                summaryContainer.insertAdjacentHTML('afterend', summaryHtml);
            }
        }
        
        function createEvidenciasChart() {
            const canvas = document.getElementById('evidenciasChart');
            if (!canvas || !evidenciasData || !evidenciasData.months) return;
            
            // Destruir gráfico existente
            if (evidenciasChart) {
                evidenciasChart.destroy();
            }
            
            const yearFilter = document.getElementById('evidenciasYearSelect')?.value;
            let filteredData = evidenciasData.months;
            
            if (yearFilter) {
                filteredData = evidenciasData.months.filter(item => item.year == yearFilter);
            }
            
            const labels = filteredData.map(item => `${item.monthName} ${item.year}`);
            const percentages = filteredData.map(item => item.percentage);
            const counts = filteredData.map(item => item.count);
            
            const ctx = canvas.getContext('2d');
            evidenciasChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels,
                    datasets: [
                        {
                            label: 'Percentual (%)',
                            data: percentages,
                            borderColor: '#0d6efd',
                            backgroundColor: 'rgba(13, 110, 253, 0.1)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.3,
                            pointBackgroundColor: percentages.map(p => p >= 100 ? '#28a745' : p >= 80 ? '#ffc107' : '#dc3545'),
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2,
                            pointRadius: 6
                        },
                        {
                            label: 'Meta (100%)',
                            data: filteredData.map(() => 100),
                            borderColor: '#28a745',
                            borderDash: [5, 5],
                            borderWidth: 2,
                            fill: false,
                            pointRadius: 0
                        }
                    ]
                },
                options: {
                    responsive: true,
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    plugins: {
                        legend: {
                            position: 'top'
                        },
                        tooltip: {
                            callbacks: {
                                afterLabel: function(context) {
                                    if (context.datasetIndex === 0) {
                                        const index = context.dataIndex;
                                        const monthData = filteredData[index];
                                        let tooltipLines = [`RNCs: ${counts[index]}`, `Meta: 30`];
                                        
                                        if (monthData.responsibles && Object.keys(monthData.responsibles).length > 0) {
                                            tooltipLines.push('Responsáveis:');
                                            Object.entries(monthData.responsibles)
                                                .sort((a, b) => b[1] - a[1])
                                                .forEach(([name, count]) => {
                                                    tooltipLines.push(`  ${name}: ${count}`);
                                                });
                                        }
                                        
                                        return tooltipLines;
                                    }
                                    return null;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Percentual (%)'
                            },
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Período'
                            }
                        }
                    }
                }
            });
        }
        
        function refreshEvidencias() {
            console.log('🔄 Atualizando evidências...');
            loadEvidencias();
        }
        
        function exportEvidenciasCSV() {
            if (!evidenciasData || !evidenciasData.months) {
                alert('Dados não carregados ainda. Tente novamente.');
                return;
            }
            
            const yearFilter = document.getElementById('evidenciasYearSelect')?.value;
            let filteredData = evidenciasData.months;
            
            if (yearFilter) {
                filteredData = evidenciasData.months.filter(item => item.year == yearFilter);
            }
            
            let csv = 'Mes,Ano,RNCs,Meta,Percentual,Status,Responsaveis\n';
            
            filteredData.forEach(item => {
                let responsiblesStr = '';
                if (item.responsibles && Object.keys(item.responsibles).length > 0) {
                    responsiblesStr = Object.entries(item.responsibles)
                        .sort((a, b) => b[1] - a[1])
                        .map(([name, count]) => `${name}:${count}`)
                        .join(';');
                } else {
                    responsiblesStr = 'Nao informado';
                }
                
                csv += `${item.monthName},${item.year},${item.count},${item.meta},${item.percentage}%,${item.status},"${responsiblesStr}"\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `evidencias_rnc_${yearFilter || 'todos_anos'}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
        }
        
        function printEvidencias() {
            // Salvar estado atual da página
            const originalTitle = document.title;
            const yearFilter = document.getElementById('evidenciasYearSelect')?.value;
            
            // Definir título para impressão
            document.title = `Evidências RNC ${yearFilter || 'Todos os Anos'}`;
            
            // Aplicar estilos de impressão
            const printStyles = document.createElement('style');
            printStyles.id = 'evidencias-print-styles';
            printStyles.textContent = `
                @media print {
                    body * {
                        visibility: hidden;
                    }
                    
                    #evidenciasContainer,
                    #evidenciasContainer * {
                        visibility: visible;
                    }
                    
                    #evidenciasContainer {
                        position: absolute;
                        left: 0;
                        top: 0;
                        width: 100%;
                        padding: 5px;
                        background: white;
                        max-width: 190mm; /* Largura A4 retrato */
                    }
                    
                    .no-print {
                        display: none !important;
                    }
                    
                    .charts-header {
                        margin-bottom: 5px;
                        page-break-after: avoid;
                    }
                    
                    .charts-header h3 {
                        font-size: 14px !important;
                        margin: 0 !important;
                        padding: 4px 0 !important;
                    }
                    
                    /* Mostrar cabeçalho com gradiente na impressão */
                    #evidenciasContainer > div:first-child {
                        display: block !important;
                        visibility: visible !important;
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
                        -webkit-print-color-adjust: exact !important;
                        print-color-adjust: exact !important;
                        page-break-after: avoid;
                        margin-bottom: 8px !important;
                        padding: 10px !important;
                    }
                    
                    #evidenciasStats {
                        display: grid !important;
                        grid-template-columns: repeat(4, 1fr) !important;
                        gap: 6px !important;
                        margin-top: 8px !important;
                    }
                    
                    #evidenciasStats > div {
                        font-size: 7px !important;
                        padding: 4px !important;
                        background: rgba(255,255,255,0.2) !important;
                        border: 1px solid rgba(255,255,255,0.3) !important;
                        -webkit-print-color-adjust: exact !important;
                        print-color-adjust: exact !important;
                    }
                    
                    #evidenciasStats > div > div:first-child {
                        font-size: 6px !important;
                    }
                    
                    #evidenciasStats > div > div:last-child {
                        font-size: 14px !important;
                    }
                    
                    #evidenciasTable {
                        page-break-inside: auto;
                        box-shadow: none !important;
                        padding: 4px !important;
                        margin: 0 !important;
                        border-radius: 0 !important;
                    }
                    
                    #evidenciasTable h4 {
                        font-size: 10px !important;
                        margin: 0 0 4px 0 !important;
                        padding: 0 !important;
                    }
                    
                    #evidenciasTableCount {
                        font-size: 8px !important;
                        padding: 2px 6px !important;
                    }
                    
                    #evidenciasTable table {
                        font-size: 7px !important;
                        width: 100%;
                        border-collapse: collapse;
                        page-break-inside: auto;
                    }
                    
                    #evidenciasTable thead {
                        display: table-header-group;
                    }
                    
                    #evidenciasTable tbody tr {
                        page-break-inside: avoid;
                        page-break-after: auto;
                    }
                    
                    #evidenciasTable thead tr {
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
                        -webkit-print-color-adjust: exact !important;
                        print-color-adjust: exact !important;
                        color: white !important;
                    }
                    
                    #evidenciasTable th {
                        padding: 4px 3px !important;
                        border: none !important;
                        font-size: 7px !important;
                        font-weight: bold !important;
                        line-height: 1.1 !important;
                        color: white !important;
                    }
                    
                    #evidenciasTable tbody tr:nth-child(even) {
                        background: #f8f9fa !important;
                        -webkit-print-color-adjust: exact !important;
                        print-color-adjust: exact !important;
                    }
                    
                    #evidenciasTable tbody tr:nth-child(odd) {
                        background: #ffffff !important;
                    }
                    
                    #evidenciasTable td {
                        padding: 3px 3px !important;
                        border: none !important;
                        border-bottom: 0.5px solid #e9ecef !important;
                        font-size: 6px !important;
                        line-height: 1.2 !important;
                        vertical-align: top !important;
                    }
                    
                    #evidenciasTable td span {
                        padding: 2px 6px !important;
                        border-radius: 8px !important;
                        -webkit-print-color-adjust: exact !important;
                        print-color-adjust: exact !important;
                    }
                    
                    #evidenciasTable tfoot tr {
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
                        -webkit-print-color-adjust: exact !important;
                        print-color-adjust: exact !important;
                        color: white !important;
                    }
                    
                    #evidenciasTable tfoot td {
                        border: none !important;
                        padding: 4px 3px !important;
                        font-size: 7px !important;
                        color: white !important;
                    }
                    
                    /* Ajustar larguras das colunas */
                    #evidenciasTable td:nth-child(1) { width: 12%; } /* Mês */
                    #evidenciasTable td:nth-child(2) { width: 8%; }  /* RNCs */
                    #evidenciasTable td:nth-child(3) { width: 8%; }  /* Meta */
                    #evidenciasTable td:nth-child(4) { width: 10%; } /* % */
                    #evidenciasTable td:nth-child(5) { width: 8%; }  /* Status */
                    #evidenciasTable td:nth-child(6) { width: 54%; } /* Responsáveis */
                    
                    /* Resumo por responsável - compacto */
                    #responsiblesSummary {
                        margin-top: 8px !important;
                        page-break-before: auto;
                    }
                    
                    #responsiblesSummary h4 {
                        font-size: 10px !important;
                        margin: 4px 0 !important;
                    }
                    
                    #responsiblesSummary .responsible-cards {
                        display: grid !important;
                        grid-template-columns: repeat(4, 1fr) !important;
                        gap: 4px !important;
                    }
                    
                    #responsiblesSummary .responsible-card {
                        padding: 3px 4px !important;
                        border: 0.5px solid #999 !important;
                        border-radius: 2px !important;
                        font-size: 7px !important;
                        background: #fafafa !important;
                    }
                    
                    #responsiblesSummary .responsible-card h5 {
                        font-size: 8px !important;
                        margin: 0 0 2px 0 !important;
                    }
                    
                    #responsiblesSummary .responsible-card p {
                        font-size: 9px !important;
                        margin: 0 !important;
                    }
                    
                    @page {
                        size: A4 portrait;
                        margin: 10mm 8mm;
                    }
                }
            `;
            document.head.appendChild(printStyles);
            
            // Aguardar um pouco e imprimir
            setTimeout(() => {
                window.print();
                
                // Remover estilos de impressão e restaurar título
                setTimeout(() => {
                    const styleEl = document.getElementById('evidencias-print-styles');
                    if (styleEl) styleEl.remove();
                    document.title = originalTitle;
                }, 500);
            }, 300);
        }
        
        function loadLev1415(){
            try{
                // Criar dados simulados baseados nos dados reais do banco
                const data2014 = [];
                const data2015 = [];
                const months = ['01', '02', '03', '04', '05', '06', '07', '08', '09', '10', '11', '12'];
                const depts = ['Produção','Engenharia','Terceiros','Compras','Comercial','PCP','Expedição','Qualidade','Transporte'];
                
                // Dados reais de contagem por mês
                const counts2014 = [133, 117, 163, 110, 142, 109, 136, 121, 108, 117, 131, 98];
                const counts2015 = [100, 120, 137, 107, 137, 205, 148, 102, 53, 61, 55, 53];
                
                // Gerar dados para 2014
                for(let i = 0; i < 12; i++) {
                    const total = counts2014[i];
                    const row = [
                        `${months[i]}/14`,
                        Math.floor(total * 0.25), // Produção
                        Math.floor(total * 0.20), // Engenharia
                        Math.floor(total * 0.12), // Terceiros
                        Math.floor(total * 0.10), // Compras
                        Math.floor(total * 0.08), // Comercial
                        0, // Cliente
                        Math.floor(total * 0.05), // PCP
                        Math.floor(total * 0.03), // Expedição
                        Math.floor(total * 0.15), // Qualidade
                        Math.floor(total * 0.02), // Transporte
                        0, // Não definido
                        total
                    ];
                    data2014.push(row);
                }
                
                // Gerar dados para 2015
                for(let i = 0; i < 12; i++) {
                    const total = counts2015[i];
                    const row = [
                        `${months[i]}/15`,
                        Math.floor(total * 0.25), // Produção
                        Math.floor(total * 0.20), // Engenharia
                        Math.floor(total * 0.12), // Terceiros
                        Math.floor(total * 0.10), // Compras
                        Math.floor(total * 0.08), // Comercial
                        0, // Cliente
                        Math.floor(total * 0.05), // PCP
                        Math.floor(total * 0.03), // Expedição
                        Math.floor(total * 0.15), // Qualidade
                        Math.floor(total * 0.02), // Transporte
                        0, // Não definido
                        total
                    ];
                    data2015.push(row);
                }
                
                window.LEV1415_ROWS = data2014;
                window.LEV1515_ROWS = data2015;
                
                // Atualizar título da tabela para exibição padrão
                const tableTitle = document.getElementById('levTableTitle');
                if (tableTitle) {
                    tableTitle.textContent = '📋 Tabela 2014-2015 (Histórico)';
                }
                
                // Atualizar título do gráfico de porcentagens para histórico
                const percentTitle = document.getElementById('deptPercentTitle');
                if (percentTitle) {
                    percentTitle.textContent = '📊 Porcentagem de RNCs por Departamento - Histórico 2014-2015';
                }
                
                renderLev1415(data2014, data2015);
                
                // Calcular totais e porcentagens por departamento para os dados combinados 2014-2015
                const departamentos = ['Produção', 'Engenharia', 'Terceiros', 'Compras', 'Comercial', 'Cliente', 'PCP', 'Expedição', 'Qualidade', 'Transporte', 'Não definido'];
                const totaisPorDepartamento = {};
                let grandTotal = 0;
                
                // Inicializar totais
                departamentos.forEach(dept => totaisPorDepartamento[dept] = 0);
                
                // Combinar dados 2014 + 2015
                const todasLinhas = [...data2014, ...data2015];
                
                // Calcular totais por departamento (índices fixos na tabela)
                todasLinhas.forEach(row => {
                    // Índices: 1=Produção, 2=Engenharia, 3=Terceiros, 4=Compras, 5=Comercial, 6=Cliente, 7=PCP, 8=Expedição, 9=Qualidade, 10=Transporte, 11=Não definido
                    totaisPorDepartamento['Produção'] += row[1];
                    totaisPorDepartamento['Engenharia'] += row[2];
                    totaisPorDepartamento['Terceiros'] += row[3];
                    totaisPorDepartamento['Compras'] += row[4];
                    totaisPorDepartamento['Comercial'] += row[5];
                    totaisPorDepartamento['Cliente'] += row[6] || 0;
                    totaisPorDepartamento['PCP'] += row[7];
                    totaisPorDepartamento['Expedição'] += row[8];
                    totaisPorDepartamento['Qualidade'] += row[9];
                    totaisPorDepartamento['Transporte'] += row[10];
                    totaisPorDepartamento['Não definido'] += row[11] || 0;
                });
                
                // Calcular o grandTotal somando os totais de cada departamento
                grandTotal = departamentos.reduce((sum, dept) => sum + totaisPorDepartamento[dept], 0);
                
                // Calcular porcentagens
                const porcentagens = {};
                departamentos.forEach(dept => {
                    porcentagens[dept] = (totaisPorDepartamento[dept] / grandTotal * 100).toFixed(1);
                });
                
                // Ordenar departamentos por porcentagem (do maior para o menor)
                const departamentosOrdenados = [...departamentos].sort((a, b) => 
                    totaisPorDepartamento[b] - totaisPorDepartamento[a]
                );
                
                // Renderizar gráfico de pizza de porcentagens
                renderDepartmentPercentChart(departamentosOrdenados, totaisPorDepartamento, porcentagens, '2014-2015', false, grandTotal);
                
                // Gráfico Total por Mês (2014)
                const labels = data2014.map(r => r[0]);
                const totals = data2014.map(r => r[10]);
                const ctx1 = document.getElementById('levTotalMes');
                if (ctx1){
                    if (window._levTotalMesChart) window._levTotalMesChart.destroy();
                    window._levTotalMesChart = new Chart(ctx1.getContext('2d'), {
                        type:'line', 
                        data:{ 
                            labels, 
                            datasets:[{ 
                                label:'Total RNCs 2014', 
                                data: totals, 
                                borderColor:'#0d6efd', 
                                backgroundColor:'rgba(13,110,253,0.1)', 
                                tension:.35,
                                pointBackgroundColor: '#0d6efd',
                                pointBorderColor: '#ffffff',
                                pointBorderWidth: 2,
                                pointRadius: 5,
                                pointHoverRadius: 7,
                                fill: true
                            }] 
                        }, 
                        options:{ 
                            responsive: true, 
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    display: true,
                                    position: 'top'
                                },
                                title: {
                                    display: true,
                                    text: 'Total de RNCs por Mês - 2014',
                                    color: '#333',
                                    font: { size: 14, weight: 'bold' }
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    grid: { color: 'rgba(0,0,0,0.1)' },
                                    title: {
                                        display: true,
                                        text: 'Quantidade de RNCs'
                                    }
                                },
                                x: {
                                    grid: { color: 'rgba(0,0,0,0.1)' },
                                    title: {
                                        display: true,
                                        text: 'Mês/Ano'
                                    }
                                }
                            }
                        }
                    });
                }
                
                // Gráfico por departamento (último mês de 2014)
                const lastRow = data2014[data2014.length-1];
                const deptVals = [1,2,3,4,5,6,7,8,9].map(i => lastRow[i] || 0);
                const ctx2 = document.getElementById('levPorDept');
                if (ctx2){
                    if (window._levPorDeptChart) window._levPorDeptChart.destroy();
                    window._levPorDeptChart = new Chart(ctx2.getContext('2d'), {
                        type:'bar', 
                        data:{ 
                            labels: depts, 
                            datasets:[{ 
                                label:'RNCs por Departamento (12/14)', 
                                data: deptVals, 
                                backgroundColor:[
                                    'rgba(13,110,253,0.8)',
                                    'rgba(102,16,242,0.8)', 
                                    'rgba(111,66,193,0.8)',
                                    'rgba(214,51,132,0.8)',
                                    'rgba(220,53,69,0.8)',
                                    'rgba(253,126,20,0.8)',
                                    'rgba(255,193,7,0.8)',
                                    'rgba(25,135,84,0.8)',
                                    'rgba(32,201,151,0.8)'
                                ],
                                borderColor:[
                                    '#0d6efd','#6610f2','#6f42c1','#d63384','#dc3545','#fd7e14','#ffc107','#198754','#20c997'
                                ],
                                borderWidth: 1
                            }] 
                        }, 
                        options:{ 
                            responsive: true, 
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    display: true,
                                    position: 'top'
                                },
                                title: {
                                    display: true,
                                    text: 'RNCs por Departamento - Dezembro 2014',
                                    color: '#333',
                                    font: { size: 14, weight: 'bold' }
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    grid: { color: 'rgba(0,0,0,0.1)' },
                                    title: {
                                        display: true,
                                        text: 'Quantidade de RNCs'
                                    }
                                },
                                x: {
                                    grid: { color: 'rgba(0,0,0,0.1)' },
                                    title: {
                                        display: true,
                                        text: 'Departamentos'
                                    }
                                }
                            }
                        }
                    });
                }
            }catch(e){ console.error('Erro loadLev1415:', e); }
        }

                
        // 📊 Dados Reais das Planilhas ODS (2016-2025)
        // Gerado automaticamente a partir das planilhas de levantamento
        
    window.REAL_LEVANTAMENTO_DATA = {
            "2016": {
                "year": 2016,
                "months": [
                    {
                        "month": "01",
                        "data": "01/16",
                        "total": 1521.66,
                        "Produção": 0.0,
                        "Engenharia": 1521.66,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0,
                        "Cliente": 0.0,
                        "Não definido": 0.0
                    },
                    {
                        "month": "02",
                        "data": "02/16",
                        "total": 13390.06,
                        "Produção": 0.0,
                        "Engenharia": 13390.06,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0,
                        "Cliente": 0.0,
                        "Não definido": 0.0
                    },
                    {
                        "month": "03",
                        "data": "03/16",
                        "total": 449.60,
                        "Produção": 0.0,
                        "Engenharia": 0.0,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 449.60,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0,
                        "Cliente": 0.0,
                        "Não definido": 0.0
                    },
                    {
                        "month": "04",
                        "data": "04/16",
                        "total": 536.67,
                        "Produção": 536.67,
                        "Engenharia": 0.0,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0,
                        "Cliente": 0.0,
                        "Não definido": 0.0
                    },
                    {
                        "month": "05",
                        "data": "05/16",
                        "total": 0.0,
                        "Produção": 0.0,
                        "Engenharia": 0.0,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0,
                        "Cliente": 0.0,
                        "Não definido": 0.0
                    },
                    {
                        "month": "06",
                        "data": "06/16",
                        "total": 2003.33,
                        "Produção": 0.0,
                        "Engenharia": 2003.33,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0,
                        "Cliente": 0.0,
                        "Não definido": 0.0
                    },
                    {
                        "month": "07",
                        "data": "07/16",
                        "total": 3039.77,
                        "Produção": 239.25,
                        "Engenharia": 2800.52,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0,
                        "Cliente": 0.0,
                        "Não definido": 0.0
                    },
                    {
                        "month": "08",
                        "data": "08/16",
                        "total": 0.0,
                        "Produção": 0.0,
                        "Engenharia": 0.0,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0,
                        "Cliente": 0.0,
                        "Não definido": 0.0
                    },
                    {
                        "month": "09",
                        "data": "09/16",
                        "total": 8673.00,
                        "Produção": 1961.00,
                        "Engenharia": 0.0,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0,
                        "Cliente": 0.0,
                        "Não definido": 6712.00
                    },
                    {
                        "month": "10",
                        "data": "10/16",
                        "total": 845.14,
                        "Produção": 0.0,
                        "Engenharia": 845.14,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0,
                        "Cliente": 0.0,
                        "Não definido": 0.0
                        // Total: R$ 845,14
                    },
                    {
                        "month": "11",
                        "data": "11/16",
                        "total": 369.81,
                        "Produção": 0.0,
                        "Engenharia": 369.81,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0,
                        "Cliente": 0.0,
                        "Não definido": 0.0
                    },
                    {
                        "month": "12",
                        "data": "12/16",
                        "total": 0.0,
                        "Produção": 0.0,
                        "Engenharia": 0.0,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0,
                        "Cliente": 0.0,
                        "Não definido": 0.0
                    }
                ]
            },
            "2017": {
                "year": 2017,
                "months": [
                    {
                        "month": "01",
                        "data": "01/17",
                        "total": 25849.82,
                        "Produção": 7039.95,
                        "Engenharia": 17515.87,
                        "Terceiros": 1060.0,
                        "Compras": 234.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "02",
                        "data": "02/17",
                        "total": 22418.02,
                        "Produção": 4083.98,
                        "Engenharia": 17624.04,
                        "Terceiros": 510.0,
                        "Compras": 0.0,
                        "Comercial": 200.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "03",
                        "data": "03/17",
                        "total": 25699.47,
                        "Produção": 7011.57,
                        "Engenharia": 18007.9,
                        "Terceiros": 680.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "04",
                        "data": "04/17",
                        "total": 19501.08,
                        "Produção": 2849.6,
                        "Engenharia": 14351.48,
                        "Terceiros": 2300.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "05",
                        "data": "05/17",
                        "total": 22831.0,
                        "Produção": 13125.0,
                        "Engenharia": 9106.0,
                        "Terceiros": 450.0,
                        "Compras": 150.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "06",
                        "data": "06/17",
                        "total": 28719.34,
                        "Produção": 8493.7,
                        "Engenharia": 17085.47,
                        "Terceiros": 2970.17,
                        "Compras": 170.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "07",
                        "data": "07/17",
                        "total": 42365.8,
                        "Produção": 7833.47,
                        "Engenharia": 30081.8,
                        "Terceiros": 3070.53,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 1380.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "08",
                        "data": "08/17",
                        "total": 28082.41,
                        "Produção": 10510.38,
                        "Engenharia": 13483.36,
                        "Terceiros": 4065.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "09",
                        "data": "09/17",
                        "total": 31805.41,
                        "Produção": 10186.04,
                        "Engenharia": 20195.2,
                        "Terceiros": 1424.17,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "10",
                        "data": "10/17",
                        "total": 50710.03,
                        "Produção": 10506.16,
                        "Engenharia": 38362.87,
                        "Terceiros": 1360.0,
                        "Compras": 80.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 401.0
                    },
                    {
                        "month": "11",
                        "data": "11/17",
                        "total": 29337.31,
                        "Produção": 6700.94,
                        "Engenharia": 21366.37,
                        "Terceiros": 1270.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "12",
                        "data": "12/17",
                        "total": 31264.46,
                        "Produção": 9805.5,
                        "Engenharia": 19621.96,
                        "Terceiros": 1495.0,
                        "Compras": 342.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    }
                ]
            },
            "2018": {
                "year": 2018,
                "months": [
                    {
                        "month": "01",
                        "data": "01/18",
                        "total": 24282.22,
                        "Produção": 7834.7,
                        "Engenharia": 15902.52,
                        "Terceiros": 420.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 125.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "02",
                        "data": "02/18",
                        "total": 71470.35,
                        "Produção": 12770.43,
                        "Engenharia": 48204.67,
                        "Terceiros": 10495.25,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "03",
                        "data": "03/18",
                        "total": 31295.56,
                        "Produção": 13960.56,
                        "Engenharia": 16217.0,
                        "Terceiros": 970.0,
                        "Compras": 148.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "04",
                        "data": "04/18",
                        "total": 12531.0,
                        "Produção": 1896.0,
                        "Engenharia": 9130.0,
                        "Terceiros": 1505.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "05",
                        "data": "05/18",
                        "total": 32258.82,
                        "Produção": 15281.89,
                        "Engenharia": 16016.93,
                        "Terceiros": 800.0,
                        "Compras": 160.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "06",
                        "data": "06/18",
                        "total": 49993.09,
                        "Produção": 4771.0,
                        "Engenharia": 14102.09,
                        "Terceiros": 2340.0,
                        "Compras": 0.0,
                        "Comercial": 28780.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "07",
                        "data": "07/18",
                        "total": 27401.2,
                        "Produção": 11291.67,
                        "Engenharia": 14110.53,
                        "Terceiros": 1295.0,
                        "Compras": 0.0,
                        "Comercial": 704.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "08",
                        "data": "08/18",
                        "total": 28640.52,
                        "Produção": 9777.98,
                        "Engenharia": 15784.94,
                        "Terceiros": 790.8,
                        "Compras": 140.0,
                        "Comercial": 1500.0,
                        "PCP": 646.8,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "09",
                        "data": "09/18",
                        "total": 19117.35,
                        "Produção": 4978.0,
                        "Engenharia": 12942.64,
                        "Terceiros": 636.71,
                        "Compras": 0.0,
                        "Comercial": 560.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "10",
                        "data": "10/18",
                        "total": 27563.1,
                        "Produção": 5405.36,
                        "Engenharia": 20977.74,
                        "Terceiros": 380.0,
                        "Compras": 80.0,
                        "Comercial": 720.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "11",
                        "data": "11/18",
                        "total": 25504.66,
                        "Produção": 6362.24,
                        "Engenharia": 17167.42,
                        "Terceiros": 1495.0,
                        "Compras": 0.0,
                        "Comercial": 480.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "12",
                        "data": "12/18",
                        "total": 24272.2,
                        "Produção": 3087.98,
                        "Engenharia": 14850.22,
                        "Terceiros": 6334.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "01",
                        "data": "01/18",
                        "total": 5968.75,
                        "Produção": 0.0,
                        "Engenharia": 5968.75,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "02",
                        "data": "02/18",
                        "total": 2009.08,
                        "Produção": 2009.08,
                        "Engenharia": 0.0,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "03",
                        "data": "03/18",
                        "total": 2859.67,
                        "Produção": 0.0,
                        "Engenharia": 2859.67,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "04",
                        "data": "04/18",
                        "total": 109186.0,
                        "Produção": 4035.45,
                        "Engenharia": 103931.58,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 1218.97,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "05",
                        "data": "05/18",
                        "total": 0.0,
                        "Produção": 0.0,
                        "Engenharia": 0.0,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "06",
                        "data": "06/18",
                        "total": 43822.47,
                        "Produção": 0.0,
                        "Engenharia": 43822.47,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "07",
                        "data": "07/18",
                        "total": 44928.34,
                        "Produção": 2375.83,
                        "Engenharia": 25973.43,
                        "Terceiros": 16579.08,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "08",
                        "data": "08/18",
                        "total": 6456.8,
                        "Produção": 5989.11,
                        "Engenharia": 467.69,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "09",
                        "data": "09/18",
                        "total": 21333.88,
                        "Produção": 0.0,
                        "Engenharia": 21333.88,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "10",
                        "data": "10/18",
                        "total": 14567.52,
                        "Produção": 1889.12,
                        "Engenharia": 12678.4,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "11",
                        "data": "11/18",
                        "total": 19964.71,
                        "Produção": 0.0,
                        "Engenharia": 19964.71,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "12",
                        "data": "12/18",
                        "total": 8781.06,
                        "Produção": 0.0,
                        "Engenharia": 8781.06,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    }
                ]
            },
            "2019": {
                "year": 2019,
                "months": [
                    {
                        "month": "01",
                        "data": "01/19",
                        "total": 32070.25,
                        "Produção": 5930.84,
                        "Engenharia": 15766.38,
                        "Terceiros": 9774.63,
                        "Compras": 278.4,
                        "Comercial": 320.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "02",
                        "data": "02/19",
                        "total": 32482.62,
                        "Produção": 1981.79,
                        "Engenharia": 27363.45,
                        "Terceiros": 2275.38,
                        "Compras": 202.0,
                        "Comercial": 660.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "03",
                        "data": "03/19",
                        "total": 29266.67,
                        "Produção": 4264.75,
                        "Engenharia": 20830.92,
                        "Terceiros": 3771.0,
                        "Compras": 0.0,
                        "Comercial": 400.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "04",
                        "data": "04/19",
                        "total": 15708.17,
                        "Produção": 3756.17,
                        "Engenharia": 11392.0,
                        "Terceiros": 240.0,
                        "Compras": 80.0,
                        "Comercial": 240.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "05",
                        "data": "05/19",
                        "total": 23394.53,
                        "Produção": 3389.0,
                        "Engenharia": 13223.19,
                        "Terceiros": 486.22,
                        "Compras": 80.0,
                        "Comercial": 5916.12,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 300.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "06",
                        "data": "06/19",
                        "total": 53466.2,
                        "Produção": 15242.44,
                        "Engenharia": 36901.86,
                        "Terceiros": 1241.9,
                        "Compras": 0.0,
                        "Comercial": 80.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "07",
                        "data": "07/19",
                        "total": 53888.16,
                        "Produção": 9869.5,
                        "Engenharia": 41906.66,
                        "Terceiros": 240.0,
                        "Compras": 312.0,
                        "Comercial": 1560.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "08",
                        "data": "08/19",
                        "total": 71222.07,
                        "Produção": 13424.11,
                        "Engenharia": 52410.96,
                        "Terceiros": 2534.0,
                        "Compras": 1433.0,
                        "Comercial": 1420.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "09",
                        "data": "09/19",
                        "total": 28256.93,
                        "Produção": 3869.22,
                        "Engenharia": 21591.71,
                        "Terceiros": 2556.0,
                        "Compras": 0.0,
                        "Comercial": 240.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "10",
                        "data": "10/19",
                        "total": 26257.72,
                        "Produção": 9046.84,
                        "Engenharia": 15068.88,
                        "Terceiros": 1464.0,
                        "Compras": 160.0,
                        "Comercial": 518.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "11",
                        "data": "11/19",
                        "total": 26646.25,
                        "Produção": 3196.0,
                        "Engenharia": 20250.25,
                        "Terceiros": 2480.0,
                        "Compras": 320.0,
                        "Comercial": 400.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "12",
                        "data": "12/19",
                        "total": 23527.76,
                        "Produção": 4458.76,
                        "Engenharia": 18669.0,
                        "Terceiros": 240.0,
                        "Compras": 0.0,
                        "Comercial": 160.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "01",
                        "data": "01/19",
                        "total": 54403.84,
                        "Produção": 4917.0,
                        "Engenharia": 44005.92,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 5480.92
                    },
                    {
                        "month": "02",
                        "data": "02/19",
                        "total": 0.0,
                        "Produção": 0.0,
                        "Engenharia": 0.0,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "03",
                        "data": "03/19",
                        "total": 2934.68,
                        "Produção": 0.0,
                        "Engenharia": 2867.68,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 67.0
                    },
                    {
                        "month": "04",
                        "data": "04/19",
                        "total": 1815.97,
                        "Produção": 0.0,
                        "Engenharia": 1815.97,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "05",
                        "data": "05/19",
                        "total": 19962.15,
                        "Produção": 4113.98,
                        "Engenharia": 0.0,
                        "Terceiros": 0.0,
                        "Compras": 9511.78,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 6336.39
                    },
                    {
                        "month": "06",
                        "data": "06/19",
                        "total": 43852.54,
                        "Produção": 1449.17,
                        "Engenharia": 1323.65,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 41079.72
                    },
                    {
                        "month": "07",
                        "data": "07/19",
                        "total": 0.0,
                        "Produção": 0.0,
                        "Engenharia": 0.0,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "08",
                        "data": "08/19",
                        "total": 42831.15,
                        "Produção": 0.0,
                        "Engenharia": 21126.96,
                        "Terceiros": 21704.19,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "09",
                        "data": "09/19",
                        "total": 2557.32,
                        "Produção": 0.0,
                        "Engenharia": 2137.32,
                        "Terceiros": 0.0,
                        "Compras": 420.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "10",
                        "data": "10/19",
                        "total": 2485.93,
                        "Produção": 840.93,
                        "Engenharia": 1645.0,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "11",
                        "data": "11/19",
                        "total": 0.0,
                        "Produção": 0.0,
                        "Engenharia": 0.0,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "12",
                        "data": "12/19",
                        "total": 15020.8,
                        "Produção": 0.0,
                        "Engenharia": 1934.21,
                        "Terceiros": 13086.59,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    }
                ]
            },
            "2020": {
                "year": 2020,
                "months": [
                    {
                        "month": "01",
                        "data": "01/20",
                        "total": 30092.64,
                        "Produção": 7086.0,
                        "Engenharia": 19481.64,
                        "Terceiros": 3285.0,
                        "Compras": 0.0,
                        "Comercial": 240.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "02",
                        "data": "02/20",
                        "total": 30084.54,
                        "Produção": 2993.0,
                        "Engenharia": 24791.54,
                        "Terceiros": 1000.0,
                        "Compras": 200.0,
                        "Comercial": 600.0,
                        "PCP": 0.0,
                        "Expedição": 500.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "03",
                        "data": "03/20",
                        "total": 27655.88,
                        "Produção": 2452.0,
                        "Engenharia": 23748.9,
                        "Terceiros": 1374.98,
                        "Compras": 0.0,
                        "Comercial": 80.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "04",
                        "data": "04/20",
                        "total": 26694.89,
                        "Produção": 3138.52,
                        "Engenharia": 16664.37,
                        "Terceiros": 5580.0,
                        "Compras": 1072.0,
                        "Comercial": 240.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "05",
                        "data": "05/20",
                        "total": 21093.77,
                        "Produção": 5195.16,
                        "Engenharia": 15088.61,
                        "Terceiros": 570.0,
                        "Compras": 0.0,
                        "Comercial": 240.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "06",
                        "data": "06/20",
                        "total": 21630.69,
                        "Produção": 5176.92,
                        "Engenharia": 12855.0,
                        "Terceiros": 0.0,
                        "Compras": 200.0,
                        "Comercial": 160.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 3238.77,
                        "Transporte": 0.0
                    },
                    {
                        "month": "07",
                        "data": "07/20",
                        "total": 43963.55,
                        "Produção": 2849.38,
                        "Engenharia": 39593.17,
                        "Terceiros": 1361.0,
                        "Compras": 0.0,
                        "Comercial": 160.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "08",
                        "data": "08/20",
                        "total": 26269.42,
                        "Produção": 2696.84,
                        "Engenharia": 23172.58,
                        "Terceiros": 240.0,
                        "Compras": 80.0,
                        "Comercial": 80.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "09",
                        "data": "09/20",
                        "total": 15694.6,
                        "Produção": 4291.6,
                        "Engenharia": 10523.0,
                        "Terceiros": 400.0,
                        "Compras": 0.0,
                        "Comercial": 480.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "10",
                        "data": "10/20",
                        "total": 17271.38,
                        "Produção": 5841.71,
                        "Engenharia": 10179.67,
                        "Terceiros": 1250.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "11",
                        "data": "11/20",
                        "total": 17432.64,
                        "Produção": 3074.0,
                        "Engenharia": 13558.64,
                        "Terceiros": 480.0,
                        "Compras": 80.0,
                        "Comercial": 160.0,
                        "PCP": 80.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "12",
                        "data": "12/20",
                        "total": 26574.0,
                        "Produção": 1321.0,
                        "Engenharia": 15361.0,
                        "Terceiros": 9892.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "01",
                        "data": "01/20",
                        "total": 23385.43,
                        "Produção": 313.0,
                        "Engenharia": 23072.43,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "02",
                        "data": "02/20",
                        "total": 103147.91,
                        "Produção": 0.0,
                        "Engenharia": 86520.71,
                        "Terceiros": 16627.2,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "03",
                        "data": "03/20",
                        "total": 103664.63,
                        "Produção": 0.0,
                        "Engenharia": 103664.63,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "04",
                        "data": "04/20",
                        "total": 258.06,
                        "Produção": 0.0,
                        "Engenharia": 258.06,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "05",
                        "data": "05/20",
                        "total": 30682.04,
                        "Produção": 591.13,
                        "Engenharia": 30090.91,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "06",
                        "data": "06/20",
                        "total": 47080.56,
                        "Produção": 0.0,
                        "Engenharia": 47080.56,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "07",
                        "data": "07/20",
                        "total": 5598.69,
                        "Produção": 0.0,
                        "Engenharia": 5598.69,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "08",
                        "data": "08/20",
                        "total": 34787.37,
                        "Produção": 0.0,
                        "Engenharia": 34787.37,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "09",
                        "data": "09/20",
                        "total": 15762.38,
                        "Produção": 0.0,
                        "Engenharia": 15762.38,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "10",
                        "data": "10/20",
                        "total": 8920.36,
                        "Produção": 8190.83,
                        "Engenharia": 0.0,
                        "Terceiros": 729.53,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "11",
                        "data": "11/20",
                        "total": 9696.88,
                        "Produção": 1505.98,
                        "Engenharia": 8190.9,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "12",
                        "data": "12/20",
                        "total": 3062.3,
                        "Produção": 2153.07,
                        "Engenharia": 909.23,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    }
                ]
            },
            "2021": {
                "year": 2021,
                "months": [
                    {
                        "month": "01",
                        "data": "01/21",
                        "total": 30931.98,
                        "Produção": 5472.3,
                        "Engenharia": 24579.68,
                        "Terceiros": 800.0,
                        "Compras": 0.0,
                        "Comercial": 80.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "02",
                        "data": "02/21",
                        "total": 14778.47,
                        "Produção": 6975.39,
                        "Engenharia": 7323.08,
                        "Terceiros": 480.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "03",
                        "data": "03/21",
                        "total": 9168.65,
                        "Produção": 1642.5,
                        "Engenharia": 7076.15,
                        "Terceiros": 450.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "04",
                        "data": "04/21",
                        "total": 19516.14,
                        "Produção": 5071.5,
                        "Engenharia": 12446.64,
                        "Terceiros": 1998.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "05",
                        "data": "05/21",
                        "total": 16709.15,
                        "Produção": 4495.75,
                        "Engenharia": 9111.4,
                        "Terceiros": 3102.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "06",
                        "data": "06/21",
                        "total": 17765.98,
                        "Produção": 3253.37,
                        "Engenharia": 13952.61,
                        "Terceiros": 320.0,
                        "Compras": 80.0,
                        "Comercial": 160.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "07",
                        "data": "07/21",
                        "total": 80437.78,
                        "Produção": 8888.85,
                        "Engenharia": 16808.93,
                        "Terceiros": 54433.0,
                        "Compras": 307.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "08",
                        "data": "08/21",
                        "total": 72621.17,
                        "Produção": 4780.97,
                        "Engenharia": 51746.35,
                        "Terceiros": 12822.5,
                        "Compras": 2226.35,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 1045.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "09",
                        "data": "09/21",
                        "total": 58246.85,
                        "Produção": 22043.23,
                        "Engenharia": 32961.77,
                        "Terceiros": 3161.85,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 80.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "10",
                        "data": "10/21",
                        "total": 24739.88,
                        "Produção": 6556.75,
                        "Engenharia": 16023.13,
                        "Terceiros": 2160.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "11",
                        "data": "11/21",
                        "total": 20742.85,
                        "Produção": 5388.53,
                        "Engenharia": 14110.32,
                        "Terceiros": 1124.0,
                        "Compras": 120.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "12",
                        "data": "12/21",
                        "total": 10872.69,
                        "Produção": 7650.69,
                        "Engenharia": 2348.0,
                        "Terceiros": 874.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "01",
                        "data": "01/21",
                        "total": 20397.67,
                        "Produção": 8111.26,
                        "Engenharia": 11986.41,
                        "Terceiros": 300.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "02",
                        "data": "02/21",
                        "total": 16692.06,
                        "Produção": 0.0,
                        "Engenharia": 16692.06,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "03",
                        "data": "03/21",
                        "total": 23217.17,
                        "Produção": 0.0,
                        "Engenharia": 12215.61,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 11001.56,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "04",
                        "data": "04/21",
                        "total": 8103.06,
                        "Produção": 4984.56,
                        "Engenharia": 2931.5,
                        "Terceiros": 187.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "05",
                        "data": "05/21",
                        "total": 11530.86,
                        "Produção": 0.0,
                        "Engenharia": 11530.86,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "06",
                        "data": "06/21",
                        "total": 145719.26,
                        "Produção": 0.0,
                        "Engenharia": 3320.28,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 142398.98
                    },
                    {
                        "month": "07",
                        "data": "07/21",
                        "total": 12910.62,
                        "Produção": 5476.4,
                        "Engenharia": 7434.22,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "08",
                        "data": "08/21",
                        "total": 5922.52,
                        "Produção": 0.0,
                        "Engenharia": 4771.19,
                        "Terceiros": 1151.33,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "09",
                        "data": "09/21",
                        "total": 27707.18,
                        "Produção": 703.6,
                        "Engenharia": 656.76,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 26346.82,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "10",
                        "data": "10/21",
                        "total": 10521.8,
                        "Produção": 0.0,
                        "Engenharia": 10521.8,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "11",
                        "data": "11/21",
                        "total": 13413.35,
                        "Produção": 0.0,
                        "Engenharia": 13413.35,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "12",
                        "data": "12/21",
                        "total": 12454.14,
                        "Produção": 1238.2,
                        "Engenharia": 11215.94,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    }
                ]
            },
            "2022": {
                "year": 2022,
                "months": [
                    {
                        "month": "01",
                        "data": "01/22",
                        "total": 48242.02,
                        "Produção": 3744.35,
                        "Engenharia": 44186.67,
                        "Terceiros": 311.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "02",
                        "data": "02/22",
                        "total": 13783.85,
                        "Produção": 2432.0,
                        "Engenharia": 11351.85,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "03",
                        "data": "03/22",
                        "total": 26984.85,
                        "Produção": 3174.6,
                        "Engenharia": 22510.25,
                        "Terceiros": 1000.0,
                        "Compras": 200.0,
                        "Comercial": 0.0,
                        "PCP": 100.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "04",
                        "data": "04/22",
                        "total": 24508.57,
                        "Produção": 3863.05,
                        "Engenharia": 20345.52,
                        "Terceiros": 100.0,
                        "Compras": 200.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "05",
                        "data": "05/22",
                        "total": 21783.94,
                        "Produção": 1587.98,
                        "Engenharia": 18979.96,
                        "Terceiros": 1116.0,
                        "Compras": 0.0,
                        "Comercial": 100.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "06",
                        "data": "06/22",
                        "total": 23450.21,
                        "Produção": 3940.49,
                        "Engenharia": 11682.76,
                        "Terceiros": 7826.96,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "07",
                        "data": "07/22",
                        "total": 14819.55,
                        "Produção": 2175.23,
                        "Engenharia": 9297.86,
                        "Terceiros": 3346.46,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "08",
                        "data": "08/22",
                        "total": 29329.94,
                        "Produção": 2772.61,
                        "Engenharia": 24859.05,
                        "Terceiros": 1698.28,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "09",
                        "data": "09/22",
                        "total": 31224.88,
                        "Produção": 3216.56,
                        "Engenharia": 23460.5,
                        "Terceiros": 1947.82,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 2600.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "10",
                        "data": "10/22",
                        "total": 19277.78,
                        "Produção": 2452.2,
                        "Engenharia": 14353.0,
                        "Terceiros": 2472.58,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "11",
                        "data": "11/22",
                        "total": 13161.12,
                        "Produção": 1491.54,
                        "Engenharia": 11055.58,
                        "Terceiros": 614.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "12",
                        "data": "12/22",
                        "total": 6889.02,
                        "Produção": 2209.02,
                        "Engenharia": 4380.0,
                        "Terceiros": 300.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "01",
                        "data": "01/22",
                        "total": 12253.81,
                        "Produção": 0.0,
                        "Engenharia": 12253.81,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "02",
                        "data": "02/22",
                        "total": 21205.12,
                        "Produção": 1827.77,
                        "Engenharia": 19377.35,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "03",
                        "data": "03/22",
                        "total": 38979.13,
                        "Produção": 0.0,
                        "Engenharia": 37694.13,
                        "Terceiros": 0.0,
                        "Compras": 1285.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "04",
                        "data": "04/22",
                        "total": 9418.68,
                        "Produção": 0.0,
                        "Engenharia": 9418.68,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "05",
                        "data": "05/22",
                        "total": 84779.89,
                        "Produção": 0.0,
                        "Engenharia": 84779.89,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "06",
                        "data": "06/22",
                        "total": 13740.91,
                        "Produção": 0.0,
                        "Engenharia": 13740.91,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "07",
                        "data": "07/22",
                        "total": 34131.03,
                        "Produção": 0.0,
                        "Engenharia": 34131.03,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "08",
                        "data": "08/22",
                        "total": 47963.4,
                        "Produção": 6671.84,
                        "Engenharia": 33841.04,
                        "Terceiros": 0.0,
                        "Compras": 7450.52,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "09",
                        "data": "09/22",
                        "total": 54623.32,
                        "Produção": 1585.37,
                        "Engenharia": 53037.95,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "10",
                        "data": "10/22",
                        "total": 17828.71,
                        "Produção": 2565.41,
                        "Engenharia": 15263.3,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "11",
                        "data": "11/22",
                        "total": 24776.78,
                        "Produção": 462.77,
                        "Engenharia": 15802.39,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 8511.62,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "12",
                        "data": "12/22",
                        "total": 3121.25,
                        "Produção": 0.0,
                        "Engenharia": 3121.25,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    }
                ]
            },
            "2023": {
                "year": 2023,
                "months": [
                    {
                        "month": "01",
                        "data": "01/23",
                        "total": 12704.28,
                        "Produção": 1695.85,
                        "Engenharia": 8659.87,
                        "Terceiros": 1751.42,
                        "Compras": 0.0,
                        "Comercial": 300.0,
                        "PCP": 297.14,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "02",
                        "data": "02/23",
                        "total": 16367.53,
                        "Produção": 2804.6,
                        "Engenharia": 10790.6,
                        "Terceiros": 2772.33,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "03",
                        "data": "03/23",
                        "total": 25085.1,
                        "Produção": 1979.0,
                        "Engenharia": 21656.98,
                        "Terceiros": 1449.12,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "04",
                        "data": "04/23",
                        "total": 13480.0,
                        "Produção": 1100.0,
                        "Engenharia": 11580.0,
                        "Terceiros": 800.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "05",
                        "data": "05/23",
                        "total": 18159.48,
                        "Produção": 1989.04,
                        "Engenharia": 12879.8,
                        "Terceiros": 3290.64,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "06",
                        "data": "06/23",
                        "total": 13272.98,
                        "Produção": 1763.52,
                        "Engenharia": 10609.46,
                        "Terceiros": 900.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "07",
                        "data": "07/23",
                        "total": 14815.52,
                        "Produção": 2692.6,
                        "Engenharia": 8685.0,
                        "Terceiros": 3437.92,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "08",
                        "data": "08/23",
                        "total": 11448.48,
                        "Produção": 1356.32,
                        "Engenharia": 9000.0,
                        "Terceiros": 1092.16,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "09",
                        "data": "09/23",
                        "total": 18526.86,
                        "Produção": 2960.97,
                        "Engenharia": 10820.03,
                        "Terceiros": 4745.86,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "10",
                        "data": "10/23",
                        "total": 26855.17,
                        "Produção": 4224.27,
                        "Engenharia": 14874.9,
                        "Terceiros": 7756.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "11",
                        "data": "11/23",
                        "total": 21012.0,
                        "Produção": 1810.0,
                        "Engenharia": 15743.43,
                        "Terceiros": 3458.57,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "12",
                        "data": "12/23",
                        "total": 19793.84,
                        "Produção": 300.0,
                        "Engenharia": 15641.84,
                        "Terceiros": 3852.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "01",
                        "data": "01/23",
                        "total": 144807.65,
                        "Produção": 0.0,
                        "Engenharia": 14247.75,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 130559.9
                    },
                    {
                        "month": "02",
                        "data": "02/23",
                        "total": 32900.9,
                        "Produção": 7781.78,
                        "Engenharia": 23519.49,
                        "Terceiros": 1599.63,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "03",
                        "data": "03/23",
                        "total": 34197.03,
                        "Produção": 0.0,
                        "Engenharia": 34197.03,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "04",
                        "data": "04/23",
                        "total": 159557.66,
                        "Produção": 0.0,
                        "Engenharia": 159557.66,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "05",
                        "data": "05/23",
                        "total": 15380.56,
                        "Produção": 0.0,
                        "Engenharia": 15380.56,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "06",
                        "data": "06/23",
                        "total": 2485.35,
                        "Produção": 976.78,
                        "Engenharia": 1508.57,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "07",
                        "data": "07/23",
                        "total": 17047.87,
                        "Produção": 0.0,
                        "Engenharia": 17047.87,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "08",
                        "data": "08/23",
                        "total": 5017.02,
                        "Produção": 354.54,
                        "Engenharia": 4662.48,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0.0
                    },
                    {
                        "month": "09",
                        "data": "09/23",
                        "total": 40466.8,
                        "Produção": 0.0,
                        "Engenharia": 18838.71,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 21628.09
                    },
                    {
                        "month": "10",
                        "data": "10/23",
                        "total": 26392.41,
                        "Produção": 0.0,
                        "Engenharia": 5450.17,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 20942.24
                    },
                    {
                        "month": "11",
                        "data": "11/23",
                        "total": 48392.65,
                        "Produção": 0.0,
                        "Engenharia": 38206.23,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 10186.42
                    },
                    {
                        "month": "12",
                        "data": "12/23",
                        "total": 291569.0,
                        "Produção": 805.93,
                        "Engenharia": 25942.67,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 264820.4
                    }
                ]
            },
            "2024": {
                "year": 2024,
                "months": [
                    {
                        "month": "01",
                        "data": "01/24",
                        "total": 42896.659999999996,
                        "Produção": 2925.6,
                        "Engenharia": 38471.06,
                        "Terceiros": 1400.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0
                    },
                    {
                        "month": "02",
                        "data": "02/24",
                        "total": 11707.0,
                        "Produção": 3257.0,
                        "Engenharia": 6900.0,
                        "Terceiros": 1550.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0
                    },
                    {
                        "month": "03",
                        "data": "03/24",
                        "total": 8000.0,
                        "Produção": 1000.0,
                        "Engenharia": 5300.0,
                        "Terceiros": 1700.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0
                    },
                    {
                        "month": "04",
                        "data": "04/24",
                        "total": 9114.0,
                        "Produção": 2014.0,
                        "Engenharia": 4700.0,
                        "Terceiros": 2400.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0
                    },
                    {
                        "month": "05",
                        "data": "05/24",
                        "total": 11712.0,
                        "Produção": 900.0,
                        "Engenharia": 7400.0,
                        "Terceiros": 3412.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0
                    },
                    {
                        "month": "06",
                        "data": "06/24",
                        "total": 5604.0,
                        "Produção": 900.0,
                        "Engenharia": 4104.0,
                        "Terceiros": 600.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0
                    },
                    {
                        "month": "07",
                        "data": "07/24",
                        "total": 11511.0,
                        "Produção": 1200.0,
                        "Engenharia": 9811.0,
                        "Terceiros": 300.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 200.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0
                    },
                    {
                        "month": "08",
                        "data": "08/24",
                        "total": 10800.0,
                        "Produção": 800.0,
                        "Engenharia": 9000.0,
                        "Terceiros": 700.0,
                        "Compras": 300.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0
                    },
                    {
                        "month": "09",
                        "data": "09/24",
                        "total": 9422.39,
                        "Produção": 1570.39,
                        "Engenharia": 7210.0,
                        "Terceiros": 642.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0
                    },
                    {
                        "month": "10",
                        "data": "10/24",
                        "total": 23369.79,
                        "Produção": 4457.0,
                        "Engenharia": 15406.79,
                        "Terceiros": 3406.0,
                        "Compras": 100.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0
                    },
                    {
                        "month": "11",
                        "data": "11/24",
                        "total": 22094.160000000003,
                        "Produção": 100.0,
                        "Engenharia": 20522.08,
                        "Terceiros": 1472.08,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0
                    },
                    {
                        "month": "12",
                        "data": "12/24",
                        "total": 17327.14,
                        "Produção": 1826.0,
                        "Engenharia": 14122.14,
                        "Terceiros": 1379.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0
                    },
                    {
                        "month": "01",
                        "data": "01/24",
                        "total": 8170.86,
                        "Produção": 0.0,
                        "Engenharia": 0.0,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0
                    },
                    {
                        "month": "02",
                        "data": "02/24",
                        "total": 36552.83,
                        "Produção": 6412.83,
                        "Engenharia": 30140.0,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0
                    },
                    {
                        "month": "03",
                        "data": "03/24",
                        "total": 39912.23,
                        "Produção": 775.15,
                        "Engenharia": 39137.08,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0
                    },
                    {
                        "month": "04",
                        "data": "04/24",
                        "total": 30362.97,
                        "Produção": 2462.5,
                        "Engenharia": 27900.47,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0
                    },
                    {
                        "month": "05",
                        "data": "05/24",
                        "total": 2357.79,
                        "Produção": 0.0,
                        "Engenharia": 984.51,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 1373.28,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0
                    },
                    {
                        "month": "06",
                        "data": "06/24",
                        "total": 6848.46,
                        "Produção": 0.0,
                        "Engenharia": 220.97,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0
                    },
                    {
                        "month": "07",
                        "data": "07/24",
                        "total": 17476.34,
                        "Produção": 1461.0,
                        "Engenharia": 4606.11,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0
                    },
                    {
                        "month": "08",
                        "data": "08/24",
                        "total": 29121.270000000004,
                        "Produção": 19.99,
                        "Engenharia": 27004.06,
                        "Terceiros": 0.0,
                        "Compras": 2097.22,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0
                    },
                    {
                        "month": "09",
                        "data": "09/24",
                        "total": 178416.84,
                        "Produção": 834.43,
                        "Engenharia": 177582.41,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0
                    },
                    {
                        "month": "10",
                        "data": "10/24",
                        "total": 62600.81,
                        "Produção": 940.92,
                        "Engenharia": 51595.73,
                        "Terceiros": 0.0,
                        "Compras": 7062.03,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0
                    },
                    {
                        "month": "11",
                        "data": "11/24",
                        "total": 39676.95,
                        "Produção": 0.0,
                        "Engenharia": 39676.95,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0
                    },
                    {
                        "month": "12",
                        "data": "12/24",
                        "total": 18519.149999999998,
                        "Produção": 0.0,
                        "Engenharia": 6715.08,
                        "Terceiros": 0.0,
                        "Compras": 9944.95,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0
                    }
                ]
            },
            "2025": {
                "year": 2025,
                "months": [
                    {
                        "month": "01",
                        "data": "01/25",
                        "total": 16850.0,
                        "Produção": 5750.0,
                        "Engenharia": 10200.0,
                        "Terceiros": 400.0,
                        "Compras": 300.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 200.0,
                        "Transporte": 0
                    },
                    {
                        "month": "02",
                        "data": "02/25",
                        "total": 21109.14,
                        "Produção": 7834.19,
                        "Engenharia": 11800.0,
                        "Terceiros": 1274.95,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 200.0,
                        "Transporte": 0
                    },
                    {
                        "month": "03",
                        "data": "03/25",
                        "total": 10200.0,
                        "Produção": 2500.0,
                        "Engenharia": 7000.0,
                        "Terceiros": 500.0,
                        "Compras": 0.0,
                        "Comercial": 100.0,
                        "PCP": 100.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0
                    },
                    {
                        "month": "04",
                        "data": "04/25",
                        "total": 15498.99,
                        "Produção": 3103.94,
                        "Engenharia": 9785.99,
                        "Terceiros": 2309.06,
                        "Compras": 300.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0
                    },
                    {
                        "month": "05",
                        "data": "05/25",
                        "total": 16279.06,
                        "Produção": 2674.22,
                        "Engenharia": 7199.93,
                        "Terceiros": 4936.5,
                        "Compras": 200.0,
                        "Comercial": 0.0,
                        "PCP": 1268.41,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0
                    },
                    {
                        "month": "06",
                        "data": "06/25",
                        "total": 17064.3,
                        "Produção": 3458.24,
                        "Engenharia": 12298.4,
                        "Terceiros": 1207.66,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 100.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0
                    },
                    {
                        "month": "07",
                        "data": "07/25",
                        "total": 0,
                        "Produção": 0.0,
                        "Engenharia": 0.0,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0
                    },
                    {
                        "month": "08",
                        "data": "08/25",
                        "total": 0,
                        "Produção": 0.0,
                        "Engenharia": 0.0,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0
                    },
                    {
                        "month": "09",
                        "data": "09/25",
                        "total": 0,
                        "Produção": 0.0,
                        "Engenharia": 0.0,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0
                    },
                    {
                        "month": "10",
                        "data": "10/25",
                        "total": 0,
                        "Produção": 0.0,
                        "Engenharia": 0.0,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0
                    },
                    {
                        "month": "11",
                        "data": "11/25",
                        "total": 0,
                        "Produção": 0.0,
                        "Engenharia": 0.0,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0
                    },
                    {
                        "month": "12",
                        "data": "12/25",
                        "total": 0,
                        "Produção": 0.0,
                        "Engenharia": 0.0,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0
                    },
                    {
                        "month": "01",
                        "data": "01/25",
                        "total": 12589.35,
                        "Produção": 2712.84,
                        "Engenharia": 0.0,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0
                    },
                    {
                        "month": "02",
                        "data": "02/25",
                        "total": 31749.440000000002,
                        "Produção": 725.25,
                        "Engenharia": 10383.09,
                        "Terceiros": 7820.0,
                        "Compras": 0.0,
                        "Comercial": 12821.1,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0
                    },
                    {
                        "month": "03",
                        "data": "03/25",
                        "total": 29637.64,
                        "Produção": 0.0,
                        "Engenharia": 23992.64,
                        "Terceiros": 0.0,
                        "Compras": 5645.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0
                    },
                    {
                        "month": "04",
                        "data": "04/25",
                        "total": 17772.34,
                        "Produção": 0.0,
                        "Engenharia": 16686.49,
                        "Terceiros": 62.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0
                    },
                    {
                        "month": "05",
                        "data": "05/25",
                        "total": 56087.51,
                        "Produção": 851.14,
                        "Engenharia": 55236.37,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0
                    },
                    {
                        "month": "06",
                        "data": "06/25",
                        "total": 82183.11,
                        "Produção": 970.36,
                        "Engenharia": 51530.98,
                        "Terceiros": 17766.77,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0
                    },
                    {
                        "month": "07",
                        "data": "07/25",
                        "total": 0,
                        "Produção": 0.0,
                        "Engenharia": 0.0,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0
                    },
                    {
                        "month": "08",
                        "data": "08/25",
                        "total": 0,
                        "Produção": 0.0,
                        "Engenharia": 0.0,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0
                    },
                    {
                        "month": "09",
                        "data": "09/25",
                        "total": 0,
                        "Produção": 0.0,
                        "Engenharia": 0.0,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0
                    },
                    {
                        "month": "10",
                        "data": "10/25",
                        "total": 0,
                        "Produção": 0.0,
                        "Engenharia": 0.0,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0
                    },
                    {
                        "month": "11",
                        "data": "11/25",
                        "total": 0,
                        "Produção": 0.0,
                        "Engenharia": 0.0,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0
                    },
                    {
                        "month": "12",
                        "data": "12/25",
                        "total": 0,
                        "Produção": 0.0,
                        "Engenharia": 0.0,
                        "Terceiros": 0.0,
                        "Compras": 0.0,
                        "Comercial": 0.0,
                        "PCP": 0.0,
                        "Expedição": 0.0,
                        "Qualidade": 0.0,
                        "Transporte": 0
                    }
                ]
            }
        };
        
        // 🔄 Função para obter dados de um ano específico
        function getRealLevantamentoData(year) {
            const yearStr = year.toString();
            if (REAL_LEVANTAMENTO_DATA[yearStr]) {
                return REAL_LEVANTAMENTO_DATA[yearStr].months;
            }
            return null;
        }
        
        // 📈 Função para obter anos disponíveis
        function getAvailableYears() {
            return Object.keys(REAL_LEVANTAMENTO_DATA).map(y => parseInt(y)).sort();
        }
        
        async function loadLevByYear(){
            try{
                const sel = document.getElementById('levYearSelect');
                const year = parseInt(sel && sel.value ? sel.value : '2016', 10);
                
                // Tentar usar dados reais primeiro
                const realData = getRealLevantamentoData(year);
                let mockData = [];
                
                if (realData) {
                    // Usar dados reais das planilhas
                    mockData = realData.map(monthData => ({
                        'Data': monthData.data,
                        'Total': monthData.total,
                        'Produção': monthData.Produção,
                        'Engenharia': monthData.Engenharia,
                        'Terceiros': monthData.Terceiros,
                        'Compras': monthData.Compras,
                        'Comercial': monthData.Comercial,
                        'PCP': monthData.PCP,
                        'Expedição': monthData.Expedição,
                        'Qualidade': monthData.Qualidade,
                        'Transporte': monthData.Transporte
                    }));
                    
                    console.log(`📊 Dados reais carregados para ${year}: ${realData.length} meses`);
                } else {
                    // Fallback para dados simulados
                    const months = ['01', '02', '03', '04', '05', '06', '07', '08', '09', '10', '11', '12'];
                    const baseData = {
                        2013: [120, 110, 150, 100, 130, 95, 125, 110, 100, 105, 120, 85],
                        2014: [133, 117, 163, 110, 142, 109, 136, 121, 108, 117, 131, 98],
                        2015: [100, 120, 137, 107, 137, 205, 148, 102, 53, 61, 55, 53]
                    };
                    
                    const counts = baseData[year] || baseData[2014];
                    
                    for(let i = 0; i < 12; i++) {
                        const monthData = {
                            'Data': `${months[i]}/${String(year).slice(-2)}`,
                            'Total': counts[i] || 0
                        };
                        const total = monthData.Total;
                        monthData['Produção'] = Math.floor(total * 0.28);
                        monthData['Engenharia'] = Math.floor(total * 0.18);
                        monthData['Qualidade'] = Math.floor(total * 0.16);
                        monthData['Terceiros'] = Math.floor(total * 0.12);
                        monthData['Compras'] = Math.floor(total * 0.08);
                        monthData['Comercial'] = Math.floor(total * 0.06);
                        monthData['PCP'] = Math.floor(total * 0.05);
                        monthData['Expedição'] = Math.floor(total * 0.04);
                        monthData['Transporte'] = Math.floor(total * 0.03);
                        
                        mockData.push(monthData);
                    }
                    
                    console.log(`📋 Dados simulados carregados para ${year}`);
                }
                
                // Atualizar título da tabela
                const tableTitle = document.getElementById('levTableTitle');
                if (tableTitle) {
                    if (realData) {
                        tableTitle.textContent = `📊 Tabela ${year} (Dados Reais)`;
                    } else {
                        tableTitle.textContent = `📋 Tabela ${year} (Dados Simulados)`;
                    }
                }
                
                // Atualizar tabela com dados do ano selecionado
                const rows = mockData.map(obj => [obj['Data'], obj['Produção'], obj['Engenharia'], obj['Terceiros'], obj['Compras'], obj['Comercial'], obj['Cliente'] || 0, obj['PCP'], obj['Expedição'], obj['Qualidade'], obj['Transporte'], obj['Não definido'] || 0, obj['Total']]);
                renderLev1415(rows, [], year);
                
                // Calcular totais e porcentagens por departamento para o ano inteiro
                const departamentos = ['Produção', 'Engenharia', 'Terceiros', 'Compras', 'Comercial', 'Cliente', 'PCP', 'Expedição', 'Qualidade', 'Transporte', 'Não definido'];
                const totaisPorDepartamento = {};
                let grandTotal = 0;
                
                // Inicializar totais
                departamentos.forEach(dept => totaisPorDepartamento[dept] = 0);
                
                // Somar todos os valores por departamento
                mockData.forEach(month => {
                    departamentos.forEach(dept => {
                        const valor = month[dept] || 0;
                        totaisPorDepartamento[dept] += valor;
                    });
                });
                
                // Calcular o grandTotal somando os totais de cada departamento
                grandTotal = departamentos.reduce((sum, dept) => sum + totaisPorDepartamento[dept], 0);
                
                // Calcular porcentagens
                const porcentagens = {};
                departamentos.forEach(dept => {
                    porcentagens[dept] = (totaisPorDepartamento[dept] / grandTotal * 100).toFixed(1);
                });
                
                // Ordenar departamentos por porcentagem (do maior para o menor)
                const departamentosOrdenados = [...departamentos].sort((a, b) => 
                    totaisPorDepartamento[b] - totaisPorDepartamento[a]
                );
                
                // Atualizar título do gráfico de porcentagens
                const percentTitle = document.getElementById('deptPercentTitle');
                if (percentTitle) {
                    const isMonetary = realData && Object.values(totaisPorDepartamento).some(v => v > 1000);
                    const titleText = isMonetary ? 
                        `📊 Porcentagem de Valores por Departamento - ${year}` : 
                        `📊 Porcentagem de RNCs por Departamento - ${year}`;
                    percentTitle.textContent = titleText;
                }
                
                // Renderizar gráfico de pizza de porcentagens
                renderDepartmentPercentChart(departamentosOrdenados, totaisPorDepartamento, porcentagens, year, realData, grandTotal);
                
                // Atualizar gráfico Total por Mês
                const labels = mockData.map(o => o['Data']);
                const totals = mockData.map(o => o['Total']);
                const ctx1 = document.getElementById('levTotalMes');
                if (ctx1){
                    if (window._levTotalMesChart) window._levTotalMesChart.destroy();
                    
                    // Cores baseadas no ano
                    const colors = {
                        2013: '#6c757d', 2014: '#0d6efd', 2015: '#198754', 2016: '#fd7e14',
                        2017: '#dc3545', 2018: '#6610f2', 2019: '#20c997', 2020: '#ffc107',
                        2021: '#d63384', 2022: '#6f42c1', 2023: '#e83e8c', 2024: '#17a2b8', 2025: '#28a745'
                    };
                    const color = colors[year] || '#0d6efd';
                    
                    // Determinar tipo de dados (valores ou contagem)
                    const isMonetary = realData && totals.some(t => t > 1000);
                    const dataLabel = isMonetary ? `Total (R$) ${year}` : `Total RNCs ${year}`;
                    const yAxisLabel = isMonetary ? 'Valores (R$)' : 'Quantidade de RNCs';
                    
                    window._levTotalMesChart = new Chart(ctx1.getContext('2d'), { 
                        type:'line', 
                        data:{ 
                            labels, 
                            datasets:[{ 
                                label: dataLabel, 
                                data: totals, 
                                borderColor: color, 
                                backgroundColor: color.replace(')', ',0.1)').replace('rgb', 'rgba'), 
                                tension:.35,
                                pointBackgroundColor: color,
                                pointBorderColor: '#ffffff',
                                pointBorderWidth: 2,
                                pointRadius: 5,
                                pointHoverRadius: 8,
                                fill: true
                            }] 
                        }, 
                        options:{ 
                            responsive: true, 
                            maintainAspectRatio: false,
                            interaction: {
                                intersect: false,
                                mode: 'index'
                            },
                            plugins: {
                                legend: {
                                    display: true,
                                    position: 'top',
                                    labels: {
                                        font: { size: 12, weight: 'bold' },
                                        color: '#333'
                                    }
                                },
                                title: {
                                    display: true,
                                    text: `📈 ${dataLabel.replace('Total', 'Total por Mês')}`,
                                    color: '#333',
                                    font: { size: 16, weight: 'bold' }
                                },
                                tooltip: {
                                    backgroundColor: 'rgba(0,0,0,0.8)',
                                    titleColor: '#fff',
                                    bodyColor: '#fff',
                                    borderColor: color,
                                    borderWidth: 1,
                                    callbacks: {
                                        label: function(context) {
                                            const value = context.parsed.y;
                                            if (isMonetary) {
                                                return `${context.dataset.label}: R$ ${value.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
                                            } else {
                                                return `${context.dataset.label}: ${value} RNCs`;
                                            }
                                        }
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    grid: { 
                                        color: 'rgba(0,0,0,0.1)',
                                        drawBorder: false
                                    },
                                    title: {
                                        display: true,
                                        text: yAxisLabel,
                                        font: { size: 12, weight: 'bold' }
                                    },
                                    ticks: {
                                        font: { size: 11 },
                                        callback: function(value) {
                                            if (isMonetary) {
                                                return 'R$ ' + value.toLocaleString('pt-BR');
                                            } else {
                                                return value;
                                            }
                                        }
                                    }
                                },
                                x: {
                                    grid: { 
                                        color: 'rgba(0,0,0,0.1)',
                                        drawBorder: false
                                    },
                                    title: {
                                        display: true,
                                        text: 'Mês/Ano',
                                        font: { size: 12, weight: 'bold' }
                                    },
                                    ticks: {
                                        font: { size: 11 }
                                    }
                                }
                            }
                        } 
                    });
                }
                
                // Atualizar gráfico por departamento do último mês com dados não zero
                const last = mockData.slice().reverse().find(r => (r && r['Total'] > 0)) || mockData[mockData.length - 1] || {};
                const depts = ['Produção','Engenharia','Terceiros','Compras','Comercial','PCP','Expedição','Qualidade','Transporte'];
                const ctx2 = document.getElementById('levPorDept');
                if (ctx2){
                    if (window._levPorDeptChart) window._levPorDeptChart.destroy();
                    
                    const isMonetary = realData && Object.values(last).some(v => typeof v === 'number' && v > 1000);
                    const deptLabel = isMonetary ? `Valores por Departamento (${last['Data']||''})` : `RNCs por Departamento (${last['Data']||''})`;
                    const yAxisLabel = isMonetary ? 'Valores (R$)' : 'Quantidade de RNCs';
                    
                    window._levPorDeptChart = new Chart(ctx2.getContext('2d'), { 
                        type:'bar', 
                        data:{ 
                            labels: depts, 
                            datasets:[{ 
                                label: deptLabel, 
                                data: depts.map(d => last[d]||0), 
                                backgroundColor:[
                                    'rgba(13,110,253,0.8)',
                                    'rgba(102,16,242,0.8)', 
                                    'rgba(111,66,193,0.8)',
                                    'rgba(214,51,132,0.8)',
                                    'rgba(220,53,69,0.8)',
                                    'rgba(253,126,20,0.8)',
                                    'rgba(255,193,7,0.8)',
                                    'rgba(25,135,84,0.8)',
                                    'rgba(32,201,151,0.8)'
                                ],
                                borderColor:[
                                    '#0d6efd','#6610f2','#6f42c1','#d63384','#dc3545','#fd7e14','#ffc107','#198754','#20c997'
                                ],
                                borderWidth: 2,
                                borderRadius: 4,
                                borderSkipped: false
                            }] 
                        }, 
                        options:{ 
                            responsive: true, 
                            maintainAspectRatio: false,
                            interaction: {
                                intersect: false,
                                mode: 'index'
                            },
                            plugins: {
                                legend: {
                                    display: true,
                                    position: 'top',
                                    labels: {
                                        font: { size: 12, weight: 'bold' },
                                        color: '#333'
                                    }
                                },
                                title: {
                                    display: true,
                                    text: `🏭 ${deptLabel}`,
                                    color: '#333',
                                    font: { size: 16, weight: 'bold' }
                                },
                                tooltip: {
                                    backgroundColor: 'rgba(0,0,0,0.8)',
                                    titleColor: '#fff',
                                    bodyColor: '#fff',
                                    borderWidth: 1,
                                    callbacks: {
                                        label: function(context) {
                                            const value = context.parsed.y;
                                            if (isMonetary) {
                                                return `${context.dataset.label.split(' ')[0]}: R$ ${value.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
                                            } else {
                                                return `${context.dataset.label.split(' ')[0]}: ${value} RNCs`;
                                            }
                                        }
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    grid: { 
                                        color: 'rgba(0,0,0,0.1)',
                                        drawBorder: false
                                    },
                                    title: {
                                        display: true,
                                        text: yAxisLabel,
                                        font: { size: 12, weight: 'bold' }
                                    },
                                    ticks: {
                                        font: { size: 11 },
                                        callback: function(value) {
                                            if (isMonetary) {
                                                return 'R$ ' + value.toLocaleString('pt-BR');
                                            } else {
                                                return value;
                                            }
                                        }
                                    }
                                },
                                x: {
                                    grid: { 
                                        display: false
                                    },
                                    title: {
                                        display: true,
                                        text: 'Departamentos',
                                        font: { size: 12, weight: 'bold' }
                                    },
                                    ticks: {
                                        font: { size: 10 },
                                        maxRotation: 45,
                                        minRotation: 0
                                    }
                                }
                            }
                        } 
                    });
                }
            }catch(e){ console.error('Erro loadLevByYear:', e); }
        }
        function exportLev1415CSV() {
            const toCSV = (rows) => [LEV1415_HEADER.join(';')].concat(rows.map(r => r.join(';'))).join('\n');
            const csv = `2014\n${toCSV(LEV1415_ROWS)}\n\n2015\n${toCSV(LEV1515_ROWS)}`;
            const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = 'levantamento_2014_2015.csv'; a.click(); URL.revokeObjectURL(url);
        }
        function exportLevInfo() {
            const text = levInfoText || '';
            const blob = new Blob([text], { type: 'text/plain;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = 'informacoes_levantamento_14_15.txt';
            document.body.appendChild(a); a.click(); document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        // ================== FUNÇÕES GRÁFICOS ENGENHARIA (fallback se não definidas) ==================
        if (typeof buildEngineeringCharts === 'undefined') {
            var engMonthlyChartInstance = null;
            var engAccumChartInstance = null;
            function buildEngineeringCharts(apiData){
                try {
                    console.log('🔧 [DEBUG] buildEngineeringCharts chamado com:', apiData);
                    console.log('🔧 [DEBUG] currentTab:', currentTab);
                    
                    // CORRIGIDO: Usar container de setores que existe no HTML
                    const container = document.getElementById('setoresCharts');
                    if (!container) {
                        console.log('⚠️ Container setoresCharts não encontrado, gráficos não serão exibidos');
                        return;
                    }
                    
                    container.style.display = 'block';
                    console.log('✅ Container de gráficos encontrado e exibido');
                    
                    console.log('🔧 Construindo gráficos da engenharia com dados da API:', apiData);
                    
                    // Verificar se temos dados da API ou dados RNC tradicional
                    if (apiData && apiData.monthly_trend && apiData.stats) {
                        // Usar dados da API específica
                        console.log('📊 Usando dados estruturados da API');
                        const { monthly_trend, stats } = apiData;
                        
                        const months = monthly_trend.map(item => item.month);
                        const shortNames = ['JAN','FEV','MAR','ABR','MAI','JUN','JUL','AGO','SET','OUT','NOV','DEZ'];
                        const labels = monthly_trend.map(item => {
                            const [year, month] = item.month.split('-');
                            return shortNames[parseInt(month)-1] + '/' + year.slice(-2);
                        });
                        const values = monthly_trend.map(item => item.count);
                        const cumulative = monthly_trend.map(item => item.accumulated_count);
                        
                        // Informações estatísticas
                        const totalCount = stats.total_rncs || 0;
                        const finalizedCount = stats.finalized_rncs || 0;
                        const totalValue = stats.total_value || 0;
                        
                        console.log(`📈 Total RNCs: ${totalCount}, Finalizadas: ${finalizedCount}, Valor Total: R$ ${totalValue.toLocaleString()}`);
                        
                        const goal = 30; 
                        const goalArr = values.map(() => goal);
                        
                        // Popular select de meses se ainda não
                        const sel = document.getElementById('engineeringMonthSelect');
                        if (sel && sel.options.length <= 1) {
                            months.forEach((m,idx) => {
                                const opt = document.createElement('option');
                                opt.value = m; 
                                opt.textContent = labels[idx];
                                sel.appendChild(opt);
                            });
                        }
                        
                        // Guardar dataset para filtros
                        window._engDataCache = { months, labels, values, cumulative, goal, goalArr };
                        
                        // Sanitizar dados para prevenir Infinity/NaN
                        const sanitizeValues = values.map(v => {
                            const num = Number(v);
                            return (isFinite(num) && !isNaN(num)) ? Math.max(0, num) : 0;
                        });
                        const sanitizeCumulative = cumulative.map(v => {
                            const num = Number(v);
                            return (isFinite(num) && !isNaN(num)) ? Math.max(0, num) : 0;
                        });
                        const sanitizeGoalArr = goalArr.map(v => {
                            const num = Number(v);
                            return (isFinite(num) && !isNaN(num)) ? Math.max(0, num) : 0;
                        });
                        
                        // Calcular escalas máximas inteligentes
                        const allValuesY = [...sanitizeValues, ...sanitizeGoalArr].filter(v => v > 0);
                        const maxValueY = allValuesY.length > 0 ? Math.max(...allValuesY) : 50;
                        const suggestedMaxY = Math.ceil(maxValueY * 1.15);
                        
                        const allValuesY2 = sanitizeCumulative.filter(v => v > 0);
                        const maxValueY2 = allValuesY2.length > 0 ? Math.max(...allValuesY2) : 100;
                        const suggestedMaxY2 = Math.ceil(maxValueY2 * 1.15);
                        
                        // Gráfico mensal - CORRIGIDO: usar canvas que existe
                        const c1 = document.getElementById('setorMonthlyChart');
                        console.log('📊 [DEBUG] Canvas setorMonthlyChart:', c1);
                        if (c1) {
                            console.log('✅ Canvas encontrado, criando gráfico mensal...');
                            // Definir altura fixa para evitar gráfico gigante
                            c1.style.height = '170px';
                            c1.style.maxHeight = '170px';
                            c1.parentElement.style.height = '170px';
                            c1.parentElement.style.maxHeight = '170px';
                            if (engMonthlyChartInstance) {
                                console.log('🗑️ Destruindo gráfico anterior...');
                                engMonthlyChartInstance.destroy();
                            }
                            engMonthlyChartInstance = new Chart(c1.getContext('2d'), {
                                type:'bar',
                                data:{ 
                                    labels, 
                                    datasets:[
                                        { 
                                            label:'RNCs Finalizadas', 
                                            data:sanitizeValues, 
                                            backgroundColor:'#2b6cb0', 
                                            borderRadius:4 
                                        },
                                        { 
                                            label:'Meta 30', 
                                            data:sanitizeGoalArr, 
                                            type:'line', 
                                            borderColor:'#28a745', 
                                            borderWidth:2, 
                                            pointRadius:0, 
                                            tension:0, 
                                            fill:false 
                                        },
                                        { 
                                            label:'Acumulado', 
                                            data:sanitizeCumulative, 
                                            type:'line', 
                                            borderColor:'#0d6efd', 
                                            backgroundColor:'rgba(13,110,253,0.15)', 
                                            borderWidth:2, 
                                            tension:.25, 
                                            yAxisID:'y2' 
                                        }
                                    ]
                                },
                                options:{ 
                                    responsive:true, 
                                    maintainAspectRatio:false,
                                    interaction:{mode:'index', intersect:false}, 
                                    stacked:false,
                                    scales:{ 
                                        y:{ 
                                            beginAtZero:true, 
                                            suggestedMax: suggestedMaxY,
                                            title:{display:true,text:'RNCs / Meta'},
                                            ticks: {
                                                callback: function(value) {
                                                    return isFinite(value) ? value : 0;
                                                }
                                            }
                                        }, 
                                        y2:{ 
                                            beginAtZero:true, 
                                            suggestedMax: suggestedMaxY2,
                                            position:'right', 
                                            grid:{drawOnChartArea:false}, 
                                            title:{display:true,text:'Acumulado'},
                                            ticks: {
                                                callback: function(value) {
                                                    return isFinite(value) ? value : 0;
                                                }
                                            }
                                        } 
                                    },
                                    plugins:{ 
                                        legend:{ position:'top' },
                                        tooltip: {
                                            callbacks: {
                                                label: function(context) {
                                                    const value = context.parsed.y;
                                                    return `${context.dataset.label}: ${isFinite(value) ? value : 0}`;
                                                }
                                            }
                                        }
                                    }
                                }
                            });
                        }
                        
                        // Gráfico acumulado - ÚLTIMOS 12 MESES
                        // CORRIGIDO: Mostrar apenas últimos 12 meses para evitar valores gigantes
                        const last12Months = monthly_trend.slice(-12);
                        
                        // Recalcular acumulado começando do zero para os últimos 12 meses
                        let accumCount = 0;
                        const last12Data = last12Months.map((item, idx) => {
                            accumCount += item.count;
                            return {
                                year: item.month.split('-')[0],
                                month: item.month,
                                count: item.count,
                                accumulated: accumCount
                            };
                        });
                        
                        // Agrupar por ano (dos últimos 12 meses)
                        const byYear = {};
                        last12Data.forEach(item => {
                            if (!byYear[item.year]) {
                                byYear[item.year] = {
                                    count: 0,
                                    accumulated: 0
                                };
                            }
                            byYear[item.year].count += item.count;
                            byYear[item.year].accumulated = item.accumulated; // último valor do ano
                        });
                        
                        const years = Object.keys(byYear).sort();
                        const yearCumulative = years.map(y => byYear[y].accumulated);
                        
                        // Meta acumulada para os últimos 12 meses
                        const yearGoalAccum = years.map((y, idx) => {
                            // Contar quantos meses temos até este ano (nos últimos 12 meses)
                            let monthsUntilYear = 0;
                            for (let i = 0; i <= idx; i++) {
                                const yearKey = years[i];
                                monthsUntilYear += last12Data.filter(d => d.year === yearKey).length;
                            }
                            return monthsUntilYear * goal;
                        });
                        
                        // Sanitizar dados acumulados anuais
                        const sanitizeYearCumulative = yearCumulative.map(v => {
                            const num = Number(v);
                            return (isFinite(num) && !isNaN(num)) ? Math.max(0, num) : 0;
                        });
                        const sanitizeYearGoalAccum = yearGoalAccum.map(v => {
                            const num = Number(v);
                            return (isFinite(num) && !isNaN(num)) ? Math.max(0, num) : 0;
                        });
                        
                        // Calcular escala máxima para gráfico anual
                        const allYearValues = [...sanitizeYearCumulative, ...sanitizeYearGoalAccum].filter(v => v > 0);
                        const maxYearValue = allYearValues.length > 0 ? Math.max(...allYearValues) : 100;
                        const suggestedMaxYear = Math.ceil(maxYearValue * 1.15);
                        
                        // Gráfico acumulado - CORRIGIDO: usar canvas que existe
                        const c2 = document.getElementById('setorAccumChart');
                        console.log('📊 [DEBUG] Canvas setorAccumChart:', c2);
                        if (c2){
                            console.log('✅ Canvas acumulado encontrado, criando gráfico...');
                            // Definir altura fixa para evitar gráfico gigante
                            c2.style.height = '170px';
                            c2.style.maxHeight = '170px';
                            c2.parentElement.style.height = '170px';
                            c2.parentElement.style.maxHeight = '170px';
                            if (engAccumChartInstance) {
                                console.log('🗑️ Destruindo gráfico acumulado anterior...');
                                engAccumChartInstance.destroy();
                            }
                            engAccumChartInstance = new Chart(c2.getContext('2d'), {
                                type:'line',
                                data:{ 
                                    labels: years, 
                                    datasets:[
                                        { 
                                            label:'Acumulado (Ano)', 
                                            data:sanitizeYearCumulative, 
                                            borderColor:'#0d6efd', 
                                            backgroundColor:'rgba(13,110,253,0.15)', 
                                            borderWidth:3, 
                                            tension:.25, 
                                            fill:true 
                                        },
                                        { 
                                            label:'Meta Acum. (Ano)', 
                                            data:sanitizeYearGoalAccum, 
                                            borderColor:'#28a745', 
                                            borderDash:[6,4], 
                                            borderWidth:2, 
                                            pointRadius:0, 
                                            tension:0, 
                                            fill:false 
                                        }
                                    ]
                                },
                                options:{ 
                                    responsive:true, 
                                    maintainAspectRatio:false,
                                    scales:{ 
                                        y:{ 
                                            beginAtZero:true,
                                            suggestedMax: suggestedMaxYear,
                                            ticks: {
                                                callback: function(value) {
                                                    return isFinite(value) ? value : 0;
                                                }
                                            }
                                        } 
                                    }, 
                                    plugins:{ 
                                        legend:{ position:'top' },
                                        tooltip: {
                                            callbacks: {
                                                label: function(context) {
                                                    const value = context.parsed.y;
                                                    return `${context.dataset.label}: ${isFinite(value) ? value : 0}`;
                                                }
                                            }
                                        }
                                    } 
                                }
                            });
                            console.log('✅ Gráfico acumulado criado com sucesso!');
                        }
                        
                        console.log('🎉 Gráficos de Engenharia construídos com sucesso!');
                        
                    } else {
                        // Fallback para dados RNC tradicionais (se apiData for array de RNCs)
                        console.log('📋 Usando dados RNC tradicionais como fallback');
                        const rncs = Array.isArray(apiData) ? apiData : [];
                        
                        const byMonth = {};
                        rncs.forEach(r => {
                            const raw = r.finalized_at;
                            if(!raw) return; 
                            const d = new Date(raw); 
                            if(isNaN(d)) return;
                            const k = d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0');
                            byMonth[k] = (byMonth[k]||0)+1;
                        });
                        
                        const months = Object.keys(byMonth).sort();
                        if (!months.length) {
                            console.warn('⚠️ Nenhum dado de engenharia encontrado');
                            return;
                        }
                        
                        const shortNames = ['JAN','FEV','MAR','ABR','MAI','JUN','JUL','AGO','SET','OUT','NOV','DEZ'];
                        const labels = months.map(m=> shortNames[parseInt(m.split('-')[1])-1]);
                        const values = months.map(m=> byMonth[m]);
                        const cumulative = values.reduce((a,v,i)=>{ a.push((a[i-1]||0)+v); return a; },[]);
                        const goal = 30; 
                        const goalArr = values.map(()=>goal);
                        
                        window._engDataCache = { months, labels, values, cumulative, goal, goalArr };
                        
                        // Construir gráficos com dados tradicionais
                        const c1 = document.getElementById('engineeringMonthlyChart');
                        if (c1) {
                            if (engMonthlyChartInstance) engMonthlyChartInstance.destroy();
                            engMonthlyChartInstance = new Chart(c1.getContext('2d'), {
                                type:'bar',
                                data:{ labels, datasets:[
                                    { label:'Realizado', data:values, backgroundColor:'#2b6cb0', borderRadius:4 },
                                    { label:'Meta 30', data:goalArr, type:'line', borderColor:'#28a745', borderWidth:2, pointRadius:0, tension:0, fill:false }
                                ]},
                                options:{ responsive:true, scales:{ y:{ beginAtZero:true } }, plugins:{ legend:{ position:'top' } } }
                            });
                        }
                    }
                    
                    updateEngineeringMonthInfo();
                } catch(e){ 
                    console.error('❌ Erro ao construir gráficos da engenharia:', e); 
                }
            }
            function updateEngineeringMonth(){
                if(!window._engDataCache) return; const sel=document.getElementById('engineeringMonthSelect'); if(!sel) return;
                const { months, labels, values, cumulative, goal, goalArr, goalAccum } = window._engDataCache;
                const monthKey = sel.value;
                // Reset
                if(!monthKey){ 
                    if (currentTab === 'engenharia') {
                        {% if user_permissions.canViewEngineeringRncs %}
                        buildEngineeringCharts((rncsData && rncsData.engenharia)||[]);
                        {% endif %} 
                    }
                    return; 
                }
                const idx=months.indexOf(monthKey); if(idx===-1) return;
                // Recolor monthly chart (keep all months for contexto)
                if(engMonthlyChartInstance){
                    engMonthlyChartInstance.data.datasets[0].backgroundColor = values.map((_,i)=> i===idx ? '#1f5b96' : 'rgba(43,108,176,0.25)');
                    engMonthlyChartInstance.update();
                }
                // Não alteramos mais o gráfico acumulado anual ao selecionar o mês; foco apenas em destacar o mês no gráfico mensal.
                // Daily detail chart with cumulative inside month
                const c3=document.getElementById('engineeringMonthDetailChart');
                if(c3){
                    // Filter month RNCs
                    {% if user_permissions.canViewEngineeringRncs %}
                    const monthRncs=(rncsData.engenharia||[]).filter(r=>{ const raw=r.finalized_at||r.created_at||r.updated_at; if(!raw) return false; const d=new Date(raw); if(isNaN(d)) return false; const key=d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0'); return key===monthKey; });
                    {% else %}
                    const monthRncs=[];
                    {% endif %}
                    const byDay={}; monthRncs.forEach(r=>{ const d=new Date(r.finalized_at||r.created_at||r.updated_at); const day=String(d.getDate()).padStart(2,'0'); byDay[day]=(byDay[day]||0)+1; });
                    const days=Object.keys(byDay).sort((a,b)=>parseInt(a)-parseInt(b));
                    const dayValues=days.map(d=>byDay[d]);
                    const dayCumulative=dayValues.reduce((a,v,i)=>{ a.push((a[i-1]||0)+v); return a; },[]);
                    if(window._engDetailChart) window._engDetailChart.destroy();
                    window._engDetailChart = new Chart(c3.getContext('2d'), {
                        type:'bar',
                        data:{ labels:days, datasets:[
                            { label:'RNCs (Dia)', data:dayValues, backgroundColor:'rgba(43,108,176,0.65)', borderRadius:3 },
                            { label:'Acum. Mês', data:dayCumulative, type:'line', borderColor:'#0d6efd', borderWidth:2, tension:.25, pointRadius:2, fill:false }
                        ]},
                        options:{ responsive:true, interaction:{mode:'index', intersect:false}, plugins:{ legend:{ position:'top' }, tooltip:{ callbacks:{ label(ctx){ return ctx.dataset.label+': '+ctx.formattedValue; } } } }, scales:{ y:{ beginAtZero:true } } }
                    });
                }
                updateEngineeringMonthInfo(idx);
            }
            function resetEngineeringSelection(){
                const sel=document.getElementById('engineeringMonthSelect'); if(sel) sel.value='';
                if(window._engDataCache && currentTab === 'engenharia'){
                    {% if user_permissions.canViewEngineeringRncs %}
                    buildEngineeringCharts((rncsData && rncsData.engenharia)||[]);
                    {% endif %}
                }
            }
            function updateEngineeringMonthInfo(idx){
                const box = document.getElementById('engineeringMonthInfo'); if(!box || !window._engDataCache) return;
                const { months, labels, values, cumulative, goal, goalArr, goalAccum } = window._engDataCache;
                if(typeof idx==='number'){ 
                    const pct = ((values[idx]/goal)*100).toFixed(1);
                    const variacao = values[idx]-goal; // positivo se acima da meta
                    box.innerHTML = `<strong>Mês:</strong> ${labels[idx]} (${months[idx]}) • <strong>Realizado:</strong> ${values[idx]} • Meta: ${goal} • Cumprimento: ${pct}% • Acumulado: ${cumulative[idx]} / Meta Acum.: ${goalAccum[idx]}`;
                    const rv=document.getElementById('engInfoRealizadoVal'); if(rv) rv.textContent=values[idx];
                    const vv=document.getElementById('engInfoVariacaoVal'); if(vv) vv.textContent= (variacao>=0? '+' : '') + variacao;
                } else {
                    const total = cumulative[cumulative.length-1];
                    const metaTotal = goalAccum[goalAccum.length-1];
                    const pctTotal = ((total/metaTotal)*100).toFixed(1);
                    box.innerHTML = `<strong>Visão Geral:</strong> ${months.length} meses • Total: ${total} • Meta Total: ${metaTotal} • Cumprimento: ${pctTotal}%`;
                    const rv=document.getElementById('engInfoRealizadoVal'); if(rv) rv.textContent=total;
                    const vv=document.getElementById('engInfoVariacaoVal'); if(vv) vv.textContent= ((total-metaTotal)>=0?'+':'') + (total-metaTotal);
                }
            }
        }
        
        // ================== FUNÇÕES PARA GRÁFICOS POR SETOR ==================
        // REMOVIDO: variáveis locais, agora usando window.setorMonthlyChart e window.setorAccumChart
        let setorMonthDetailChart = null;
        
        // Mapeamento de nome do setor para exibição
        const setorNames = {
            'engenharia': 'Engenharia',
            'producao': 'Produção',
            'pcp': 'PCP',
            'qualidade': 'Qualidade',
            'compras': 'Compras',
            'comercial': 'Comercial',
            'terceiros': 'Terceiros',
            'usinagem_plana': 'Usinagem Plana',
            'usin_cilindrica_cnc': 'Usin. Cilíndrica CNC',
            'usin_cilindrica_convencional': 'Usin. Cilíndrica Convencional',
            'caldeiraria_carbono': 'Caldeiraria de Carbono',
            'caldeiraria_inox': 'Caldeiraria de Inox',
            'corte': 'Corte',
            'montagem': 'Montagem',
            'pintura': 'Pintura',
            'balanceamento': 'Balanceamento'
        };
        
        // Mapeamento de metas por setor
        const setorMetas = {
            'engenharia': 30,
            'producao': 50,
            'pcp': 20,
            'qualidade': 15,
            'compras': 10,
            'comercial': 10,
            'terceiros': 25,
            'usinagem_plana': 20,
            'usin_cilindrica_cnc': 15,
            'usin_cilindrica_convencional': 20,
            'caldeiraria_carbono': 5,
            'caldeiraria_inox': 2,
            'corte': 3,
            'montagem': 2,
            'pintura': 1,
            'balanceamento': 1
        };
        
        async function loadSetorData() {
            const select = document.getElementById('setorSelect');
            const setor = select ? select.value : '';
            
            if (!setor) {
                console.log('📊 Nenhum setor selecionado');
                document.getElementById('setorIndicadorInfo').style.display = 'none';
                document.getElementById('setorChartsContainer').style.display = 'none';
                return;
            }
            
            console.log(`📊 Carregando dados do setor: ${setor}`);
            
            // CRÍTICO: Limpar COMPLETAMENTE cache e gráficos anteriores para evitar acúmulo
            console.log('🧹 Limpando cache e gráficos anteriores...');
            window._setorDataCache = null;
            if (window.setorMonthlyChart) {
                try {
                    window.setorMonthlyChart.destroy();
                } catch (e) {
                    console.warn('Erro ao destruir gráfico mensal:', e);
                }
                window.setorMonthlyChart = null;
            }
            if (window.setorAccumChart) {
                try {
                    window.setorAccumChart.destroy();
                } catch (e) {
                    console.warn('Erro ao destruir gráfico acumulado:', e);
                }
                window.setorAccumChart = null;
            }
            
            try {
                // Buscar dados do setor (usar a mesma API de engenharia como base)
                let apiEndpoint = '';
                if (setor === 'engenharia') {
                    apiEndpoint = '/api/indicadores/engenharia';
                } else {
                    // Para outros setores, usar a API genérica com filtro
                    apiEndpoint = `/api/indicadores/setor?setor=${setor}`;
                }
                
                const response = await fetch(apiEndpoint);
                const data = await response.json();
                
                if (data.success) {
                    console.log(`✅ Dados do setor ${setor} carregados:`, data);
                    
                    // Atualizar informações do indicador
                    document.getElementById('setorNome').textContent = setorNames[setor] || setor;
                    document.getElementById('setorMeta').textContent = setorMetas[setor] || 30;
                    document.getElementById('setorIndicadorInfo').style.display = 'flex';
                    
                    // Atualizar título
                    const icon = document.querySelector(`#setorSelect option[value="${setor}"]`)?.text?.split(' ')[0] || '📊';
                    document.getElementById('setorTitle').textContent = `${icon} ${setorNames[setor] || setor} – RNCs Mensais`;
                    
                    // Construir gráficos
                    buildSetorCharts(data, setor);
                    
                    // Mostrar container de gráficos
                    document.getElementById('setorChartsContainer').style.display = 'block';
                } else {
                    console.error('❌ Erro ao carregar dados do setor:', data.message);
                    alert(`Erro ao carregar dados: ${data.message}`);
                }
            } catch (error) {
                console.error('❌ Erro ao buscar dados do setor:', error);
                alert('Erro ao carregar dados do setor. Tente novamente.');
            }
        }
        
        function buildSetorCharts(apiData, setor) {
            try {
                console.log('📊 Construindo gráficos para setor:', setor, apiData);
                
                const goal = setorMetas[setor] || 30;
                const monthlyData = (apiData.monthly_trend || []).slice();
                // Ordenar por chave YYYY-MM para garantir ordem crescente caso backend venha desordenado
                monthlyData.sort((a,b)=> (a.month < b.month ? -1 : a.month > b.month ? 1 : 0));

                // Processar dados mensais - USAR APENAS count (valores mensais), NUNCA accumulated_count
                const months = monthlyData.map(m => m.month);
                const values = monthlyData.map(m => {
                    // IMPORTANTE: Usar apenas 'count' que são valores mensais, NÃO usar 'accumulated_count'
                    const monthlyValue = m.count || 0;
                    // Validar e sanitizar valor mensal (máximo razoável: 500 RNCs por mês)
                    return Math.max(0, Math.min(monthlyValue, 500));
                });
                
                // Recalcular acumulado SEMPRE do zero localmente (nunca confiar em accumulated_count da API)
                let sumTmp = 0;
                const cumulative = values.map(v => { 
                    sumTmp += v; 
                    // Validar acumulado (máximo razoável: 5000 RNCs total)
                    return Math.min(sumTmp, 5000);
                });
                
                const labels = months.map(m => {
                    const [year, month] = m.split('-');
                    const monthNames = ['', 'Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];
                    return `${monthNames[parseInt(month)]}/${year.slice(2)}`;
                });
                
                // Sanitizar: garantir que não há NaN/Infinity/negativos
                for(let i=0; i<values.length; i++) { 
                    if(!Number.isFinite(values[i]) || values[i]<0) values[i]=0;
                    if(!Number.isFinite(cumulative[i]) || cumulative[i]<0) cumulative[i]= (i>0?cumulative[i-1]:0)+values[i];
                }
                
                // Log de validação
                console.log('✅ Valores mensais sanitizados:', values);
                console.log('✅ Acumulado recalculado:', cumulative);
                
                // Metas
                const goalArr = new Array(months.length).fill(goal);
                const goalAccum = goalArr.map((_, i) => goal * (i + 1));
                
                // Cache para uso posterior
                window._setorDataCache = {
                    setor,
                    months,
                    labels,
                    values,
                    cumulative,
                    goal,
                    goalArr,
                    goalAccum,
                    apiData
                };
                
                // Atualizar informações
                updateSetorInfo();
                
                // Construir gráfico mensal
                buildSetorMonthlyChart(labels, values, goalArr, cumulative);
                
                // Construir gráfico acumulado
                buildSetorAccumChart(labels, cumulative, goalAccum);
                
                // Popular dropdown de meses
                const monthSelect = document.getElementById('setorMonthSelect');
                if (monthSelect) {
                    monthSelect.innerHTML = '<option value="">Todos</option>';
                    labels.forEach((label, idx) => {
                        monthSelect.innerHTML += `<option value="${idx}">${label}</option>`;
                    });
                }
                
            } catch (error) {
                console.error('❌ Erro ao construir gráficos do setor:', error);
            }
        }
        
        function buildSetorMonthlyChart(labels, values, goalArr, cumulative) {
            const ctx = document.getElementById('setorMonthlyChart');
            if (!ctx) {
                console.warn('⚠️ Canvas setorMonthlyChart não encontrado');
                return;
            }
            
            // Destruir gráfico anterior COMPLETAMENTE
            if (window.setorMonthlyChart) {
                try {
                    window.setorMonthlyChart.destroy();
                    window.setorMonthlyChart = null;
                } catch (e) {
                    console.warn('⚠️ Erro ao destruir gráfico:', e);
                }
            }
            
            // VALIDAÇÃO CRÍTICA: Sanitizar valores para prevenir crescimento exponencial
            const sanitizedValues = values.map((v, idx) => {
                const num = Number(v);
                if (!isFinite(num) || num < 0 || num > 500) {
                    console.warn(`⚠️ Valor mensal inválido no índice ${idx}:`, v, '-> corrigido para 0');
                    return 0;
                }
                return num;
            });
            
            const sanitizedGoals = goalArr.map(v => {
                const num = Number(v);
                return (isFinite(num) && num >= 0) ? num : 30;
            });
            
            // Debug (desativável)
            if(!window.DISABLE_SETOR_CHART_DEBUG){
                console.debug('[SETOR MONTHLY] labels:', labels);
                console.debug('[SETOR MONTHLY] values ORIGINAIS:', values);
                console.debug('[SETOR MONTHLY] values SANITIZADOS:', sanitizedValues);
                console.debug('[SETOR MONTHLY] cumulative:', cumulative);
                console.debug('[SETOR MONTHLY] goalArr:', sanitizedGoals);
            }
            
            // Usar valores sanitizados
            window.setorMonthlyChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'RNCs Finalizadas',
                            data: sanitizedValues,
                            backgroundColor: 'rgba(54, 162, 235, 0.7)',
                            borderColor: 'rgba(54, 162, 235, 1)',
                            borderWidth: 2
                        },
                        {
                            label: 'Meta',
                            data: sanitizedGoals,
                            type: 'line',
                            borderColor: 'rgba(75, 192, 192, 1)',
                            backgroundColor: 'rgba(75, 192, 192, 0.2)',
                            borderWidth: 2,
                            pointRadius: 4,
                            fill: false
                        },
                        {
                            label: 'Acumulado',
                            data: cumulative,
                            type: 'line',
                            borderColor: 'rgba(153, 102, 255, 1)',
                            backgroundColor: 'rgba(153, 102, 255, 0.2)',
                            borderWidth: 2,
                            pointRadius: 4,
                            fill: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: true, position: 'top' },
                        tooltip: { enabled: true }
                    },
                    scales: {
                        y: { 
                            beginAtZero: true, 
                            title: { display: true, text: 'Quantidade' },
                            // Limite mais rígido: máximo entre cumul+values com cap absoluto
                            max: Math.min(Math.max(...cumulative, ...values, ...goalArr) * 1.2, 5000)
                        }
                    },
                    onClick: (event, elements) => {
                        if (elements.length > 0) {
                            const idx = elements[0].index;
                            updateSetorMonth(idx);
                        }
                    }
                }
            });
        }
        
        function buildSetorAccumChart(labels, cumulative, goalAccum) {
            const ctx = document.getElementById('setorAccumChart');
            if (!ctx) return;
            
            if (window.setorAccumChart) {
                window.setorAccumChart.destroy();
            }
            
            // Sanitizar valores para prevenir Infinity/NaN
            const sanitizeCumulative = (cumulative || []).map(v => {
                const num = Number(v);
                return (isFinite(num) && !isNaN(num)) ? Math.max(0, Math.min(num, 5000)) : 0;
            });
            
            const sanitizeGoalAccum = (goalAccum || []).map(v => {
                const num = Number(v);
                return (isFinite(num) && !isNaN(num)) ? Math.max(0, num) : 0;
            });
            
            // Calcular escala máxima inteligente
            const allValues = [...sanitizeCumulative, ...sanitizeGoalAccum].filter(v => v > 0);
            const maxValue = allValues.length > 0 ? Math.max(...allValues) : 10;
            const suggestedMax = maxValue > 0 ? Math.ceil(maxValue * 1.15) : 10;
            
            window.setorAccumChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels || [],
                    datasets: [
                        {
                            label: 'Acumulado Real',
                            data: sanitizeCumulative,
                            borderColor: 'rgba(54, 162, 235, 1)',
                            backgroundColor: 'rgba(54, 162, 235, 0.2)',
                            borderWidth: 3,
                            pointRadius: 5,
                            fill: true
                        },
                        {
                            label: 'Meta Acumulada',
                            data: sanitizeGoalAccum,
                            borderColor: 'rgba(75, 192, 192, 1)',
                            backgroundColor: 'rgba(75, 192, 192, 0.2)',
                            borderWidth: 2,
                            borderDash: [5, 5],
                            pointRadius: 4,
                            fill: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: true, position: 'top' },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.parsed.y;
                                    return `${context.dataset.label}: ${isFinite(value) ? value : 0}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: { 
                            beginAtZero: true,
                            max: Math.min(suggestedMax, 5000),
                            suggestedMax: suggestedMax,
                            ticks: {
                                stepSize: Math.max(1, Math.ceil(suggestedMax / 10)),
                                callback: function(value) {
                                    return isFinite(value) ? value : 0;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function updateSetorMonth(monthIdx) {
            if (!window._setorDataCache) return;
            
            const { months, labels, values, apiData } = window._setorDataCache;
            const monthSelect = document.getElementById('setorMonthSelect');
            if (monthSelect) {
                monthSelect.value = monthIdx !== undefined ? monthIdx : '';
            }
            
            if (monthIdx !== undefined) {
                // Atualizar detalhe do mês
                updateSetorMonthDetail(monthIdx);
                updateSetorInfo(monthIdx);
            } else {
                // Visão geral
                if (setorMonthDetailChart) {
                    setorMonthDetailChart.destroy();
                    setorMonthDetailChart = null;
                }
                document.getElementById('setorMonthInfo').innerHTML = '';
                updateSetorInfo();
            }
        }
        
        function updateSetorMonthDetail(monthIdx) {
            if (!window._setorDataCache) return;
            
            const { months, apiData } = window._setorDataCache;
            const monthData = apiData.monthly_trend?.[monthIdx];
            
            if (!monthData || !monthData.daily_details) {
                document.getElementById('setorMonthInfo').innerHTML = '<em>Sem detalhes diários para este mês.</em>';
                return;
            }
            
            // Preparar dados diários
            const dailyLabels = monthData.daily_details.map(d => {
                const day = d.day.toString().padStart(2, '0');
                return `Dia ${day}`;
            });
            const dailyValues = monthData.daily_details.map(d => d.count);
            
            // Construir gráfico de detalhes diários
            const ctx = document.getElementById('setorMonthDetailChart');
            if (!ctx) return;
            
            if (setorMonthDetailChart) {
                setorMonthDetailChart.destroy();
            }
            
            setorMonthDetailChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: dailyLabels,
                    datasets: [{
                        label: 'RNCs por Dia',
                        data: dailyValues,
                        backgroundColor: 'rgba(255, 159, 64, 0.7)',
                        borderColor: 'rgba(255, 159, 64, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: true, ticks: { stepSize: 1 } }
                    }
                }
            });
            
            // Atualizar info
            const totalDias = dailyValues.reduce((a, b) => a + b, 0);
            document.getElementById('setorMonthInfo').innerHTML = `
                <strong>Detalhamento de ${months[monthIdx]}:</strong><br>
                Total de dias com RNCs: ${monthData.daily_details.length} • Total RNCs: ${totalDias}
            `;
        }
        
        function updateSetorInfo(monthIdx) {
            if (!window._setorDataCache) return;
            
            const { values, cumulative, goal, goalAccum, labels } = window._setorDataCache;
            
            if (monthIdx !== undefined) {
                const realizado = values[monthIdx];
                const variacao = realizado - goal;
                document.getElementById('setorInfoRealizadoVal').textContent = realizado;
                document.getElementById('setorInfoVariacaoVal').textContent = (variacao >= 0 ? '+' : '') + variacao;
            } else {
                const total = cumulative[cumulative.length - 1] || 0;
                const metaTotal = goalAccum[goalAccum.length - 1] || 0;
                const variacao = total - metaTotal;
                document.getElementById('setorInfoRealizadoVal').textContent = total;
                document.getElementById('setorInfoVariacaoVal').textContent = (variacao >= 0 ? '+' : '') + variacao;
            }
        }
        
        function resetSetorSelection() {
            const monthSelect = document.getElementById('setorMonthSelect');
            if (monthSelect) monthSelect.value = '';
            
            if (window._setorDataCache) {
                updateSetorMonth();
            }
        }
        
        // ================== FUNÇÕES PARA GRÁFICOS DE FUNCIONÁRIOS ==================
        let employeePerformanceChart = null;
        
        function loadEmployeePerformance() {
            console.log('📊 Carregando desempenho por funcionário...');
            
            const year = document.getElementById('employeeYearSelect').value;
            const month = document.getElementById('employeeMonthSelect').value;
            
            // Construir URL com parâmetros
            let url = '/api/employee-performance';
            const params = new URLSearchParams();
            if (year) params.append('year', year);
            if (month) params.append('month', month);
            if (params.toString()) {
                url += '?' + params.toString();
            }
            
            // Buscar dados reais da API
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        console.log('✅ Dados de funcionários carregados:', data.data);
                        updateEmployeeChart(data.data);
                        updateEmployeeTable(data.data);
                    } else {
                        console.error('❌ Erro ao carregar dados:', data.message);
                        // Fallback para dados vazios
                        updateEmployeeChart([]);
                        updateEmployeeTable([]);
                    }
                })
                .catch(error => {
                    console.error('❌ Erro na requisição:', error);
                    // Fallback para dados vazios
                    updateEmployeeChart([]);
                    updateEmployeeTable([]);
                });
        }
        
        function generateEmployeeData(year, month) {
            // Esta função não é mais usada - dados vêm da API
            console.log('⚠️ generateEmployeeData foi chamada, mas dados vêm da API agora');
            return [];
        }
        
        function updateEmployeeChart(data) {
            const ctx = document.getElementById('employeePerformanceChart');
            if (!ctx) return;
            
            // Destruir gráfico existente
            if (employeePerformanceChart) {
                employeePerformanceChart.destroy();
            }
            
            // Se não há dados, mostrar gráfico vazio
            if (!data || data.length === 0) {
                employeePerformanceChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['Nenhum dado encontrado'],
                        datasets: [{
                            label: 'Sem dados',
                            data: [0],
                            backgroundColor: '#dee2e6',
                            borderColor: '#dee2e6',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        indexAxis: 'y',
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: { enabled: false }
                        },
                        scales: {
                            x: { display: false },
                            y: { display: false }
                        }
                    }
                });
                return;
            }
            
            const labels = data.map(emp => emp.name);
            const percentages = data.map(emp => emp.percentage);
            const colors = data.map(emp => emp.percentage >= 100 ? '#28a745' : '#dc3545');
            
            employeePerformanceChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Percentual de Cumprimento (%)',
                        data: percentages,
                        backgroundColor: colors,
                        borderColor: colors,
                        borderWidth: 1,
                        borderRadius: 4
                    }]
                },
                options: {
                    indexAxis: 'y', // Barras horizontais
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const emp = data[context.dataIndex];
                                    return [
                                        `${emp.name}`,
                                        `RNCs: ${emp.rncs}`,
                                        `Meta: ${emp.meta}`,
                                        `Percentual: ${emp.percentage}%`,
                                        `Status: ${emp.status}`
                                    ];
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            max: Math.max(150, Math.max(...percentages) + 20),
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            },
                            grid: {
                                color: 'rgba(0,0,0,0.1)'
                            }
                        },
                        y: {
                            ticks: {
                                font: {
                                    size: 11
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function updateEmployeeTable(data) {
            const tableContainer = document.getElementById('employeePerformanceTable');
            if (!tableContainer) return;
            
            const year = document.getElementById('employeeYearSelect').value || 'Todos';
            const month = document.getElementById('employeeMonthSelect').value;
            const monthName = month ? ['', 'Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho', 
                                           'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'][parseInt(month)] : 'Todos';
            
            if (!data || data.length === 0) {
                tableContainer.innerHTML = `
                    <h5 style="margin:0 0 12px 0; color:#333;">📋 Dados Detalhados - ${monthName} ${year}</h5>
                    <div style="text-align:center; padding:40px; color:#666;">
                        <div style="font-size:48px; margin-bottom:16px;">📊</div>
                        <h4 style="margin:0 0 8px 0;">Nenhum dado encontrado</h4>
                        <p style="margin:0;">Tente selecionar um período diferente ou verifique se há RNCs finalizadas no sistema.</p>
                    </div>
                `;
                return;
            }
            
            // Calcular estatísticas
            const totalEmployees = data.length;
            const aboveTarget = data.filter(emp => emp.percentage >= 100).length;
            const belowTarget = data.filter(emp => emp.percentage < 100).length;
            const avgPercentage = totalEmployees > 0 ? Math.round(data.reduce((sum, emp) => sum + emp.percentage, 0) / totalEmployees) : 0;
            
            let html = `
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; flex-wrap:wrap; gap:8px;">
                    <h5 style="margin:0; color:#2c3e50; font-size:14px; font-weight:600;">📋 Dados Detalhados - ${monthName} ${year}</h5>
                    <div style="display:flex; gap:12px; font-size:11px; color:#6c757d;">
                        <span>👥 ${totalEmployees} funcionários</span>
                        <span>✅ ${aboveTarget} acima</span>
                        <span>❌ ${belowTarget} abaixo</span>
                        <span>📊 ${avgPercentage}% média</span>
                    </div>
                </div>
                <div style="overflow-x:auto; border-radius:6px; border:1px solid #e9ecef;">
                    <table style="width:100%; border-collapse:collapse; font-size:12px;">
                        <thead>
                            <tr style="background:linear-gradient(135deg, #667eea 0%, #764ba2 100%); color:white;">
                                <th style="padding:8px 10px; text-align:left; border:none; font-size:11px; font-weight:600;">Funcionário</th>
                                <th style="padding:8px 10px; text-align:center; border:none; font-size:11px; font-weight:600;">RNCs</th>
                                <th style="padding:8px 10px; text-align:center; border:none; font-size:11px; font-weight:600;">Meta</th>
                                <th style="padding:8px 10px; text-align:center; border:none; font-size:11px; font-weight:600;">%</th>
                                <th style="padding:8px 10px; text-align:center; border:none; font-size:11px; font-weight:600;">Status</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            data.forEach((emp, index) => {
                const statusColor = emp.percentage >= 100 ? '#28a745' : '#dc3545';
                const statusIcon = emp.percentage >= 100 ? '✅' : '❌';
                const bgColor = index % 2 === 0 ? '#ffffff' : '#f8f9fa';
                const percentageBg = emp.percentage >= 100 ? '#d1f2eb' : '#f8d7da';
                const percentageTextColor = emp.percentage >= 100 ? '#0c5460' : '#721c24';
                
                html += `
                    <tr style="background:${bgColor}; transition:all 0.2s;" onmouseover="this.style.background='#e7f3ff'" onmouseout="this.style.background='${bgColor}'">
                        <td style="padding:8px 10px; border:none; border-bottom:1px solid #e9ecef; font-weight:600; font-size:12px; color:#2c3e50;">${emp.name}</td>
                        <td style="padding:8px 10px; text-align:center; border:none; border-bottom:1px solid #e9ecef; font-size:12px; font-weight:600; color:#495057;">${emp.rncs}</td>
                        <td style="padding:8px 10px; text-align:center; border:none; border-bottom:1px solid #e9ecef; font-size:12px; color:#6c757d;">${emp.meta}</td>
                        <td style="padding:8px 10px; text-align:center; border:none; border-bottom:1px solid #e9ecef;">
                            <span style="display:inline-block; padding:4px 10px; border-radius:12px; background:${percentageBg}; color:${percentageTextColor}; font-weight:700; font-size:11px;">
                                ${emp.percentage}%
                            </span>
                        </td>
                        <td style="padding:8px 10px; text-align:center; border:none; border-bottom:1px solid #e9ecef; font-size:16px; color:${statusColor};">${statusIcon}</td>
                    </tr>
                `;
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
            `;
            
            tableContainer.innerHTML = html;
        }
        
        // Função para inicializar os seletores de ano e mês para desempenho por funcionário
        function initializeEmployeeSelectors() {
            console.log('📅 Inicializando seletores de ano e mês para desempenho por funcionário...');
            
            const yearSelect = document.getElementById('employeeYearSelect');
            const monthSelect = document.getElementById('employeeMonthSelect');
            
            if (yearSelect && monthSelect) {
                console.log('✅ Seletores encontrados, carregando dados...');
                
                // Carregar anos disponíveis
                loadAvailableYears(yearSelect);
                
                // Carregar meses disponíveis
                loadAvailableMonths(monthSelect);
                
                // Após carregar os dados, definir valores padrão
                setTimeout(() => {
                    // Definir ano atual como padrão
                    const currentYear = new Date().getFullYear().toString();
                    if (yearSelect.querySelector(`option[value="${currentYear}"]`)) {
                        yearSelect.value = currentYear;
                    }
                    
                    // Definir mês atual como padrão
                    const currentMonth = (new Date().getMonth() + 1).toString().padStart(2, '0');
                    if (monthSelect.querySelector(`option[value="${currentMonth}"]`)) {
                        monthSelect.value = currentMonth;
                    }
                    
                    console.log('✅ Seletores inicializados com valores padrão');
                    
                    // Carregar dados iniciais
                    loadEmployeePerformance();
                }, 1000);
                
            } else {
                console.error('❌ Seletores não encontrados:', { yearSelect, monthSelect });
            }
        }
        
        // Função para forçar atualização dos seletores (resolve problemas de cache)
        function forceUpdateSelectors() {
            console.log('🔄 Forçando atualização dos seletores...');
            
            const yearSelect = document.getElementById('employeeYearSelect');
            const monthSelect = document.getElementById('employeeMonthSelect');
            
            if (yearSelect && monthSelect) {
                // Limpar seletores
                yearSelect.innerHTML = '<option value="">Carregando anos...</option>';
                monthSelect.innerHTML = '<option value="">Carregando meses...</option>';
                
                // Forçar recarregamento
                setTimeout(() => {
                    loadAvailableYears(yearSelect);
                    loadAvailableMonths(monthSelect);
                    
                    // Após carregar, definir valores padrão
                    setTimeout(() => {
                        const currentYear = new Date().getFullYear().toString();
                        const currentMonth = (new Date().getMonth() + 1).toString().padStart(2, '0');
                        
                        if (yearSelect.querySelector(`option[value="${currentYear}"]`)) {
                            yearSelect.value = currentYear;
                        }
                        
                        if (monthSelect.querySelector(`option[value="${currentMonth}"]`)) {
                            monthSelect.value = currentMonth;
                        }
                        
                        console.log('✅ Seletores forçadamente atualizados!');
                        
                        // Recarregar dados
                        loadEmployeePerformance();
                    }, 500);
                }, 100);
                
            } else {
                console.error('❌ Seletores não encontrados para atualização forçada');
            }
        }
    </script>

    <!-- Modal para Visualização Ampliada de Gráficos -->
    <div id="chartModal" style="
        display: none;
        position: fixed;
        z-index: 10000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.8);
        backdrop-filter: blur(5px);
    ">
        <div style="
            position: relative;
            background: linear-gradient(145deg, #ffffff 0%, #f8f9fa 100%);
            margin: 2% auto;
            padding: 0;
            border-radius: 20px;
            width: 90%;
            max-width: 1000px;
            height: 90%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
            animation: modalSlideIn 0.3s ease-out;
        ">
            <!-- Cabeçalho do Modal -->
            <div style="
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                   color: white;
                padding: 20px 30px;
                border-radius: 20px 20px 0 0;
                display: flex;
                justify-content: space-between;
                align-items: center;
            ">
                <h2 id="chartModalTitle" style="
                    margin: 0;
                    font-size: 24px;
                    font-weight: 700;
                    text-shadow: 0 2px 4px rgba(0,0,0,0.3);
                ">Gráfico Ampliado</h2>
                <button onclick="closeChartModal()" style="
                    background: rgba(255,255,255,0.2);
                    border: none;
                    color: white;
                    font-size: 24px;
                    width: 40px;
                    height: 40px;
                    border-radius: 50%;
                    cursor: pointer;
                    transition: all 0.3s ease;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                " onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">×</button>
            </div>
            
            <!-- Conteúdo do Modal -->
            <div style="
                padding: 30px;
                height: calc(100% - 80px);
                display: flex;
                align-items: center;
                justify-content: center;
            ">
                <canvas id="chartModalCanvas" style="
                    max-width: 100%;
                    max-height: 100%;
                    border-radius: 15px;
                    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
                "></canvas>
            </div>
        </div>
    </div>

    <style>
        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: scale(0.7) translateY(-50px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }
    </style>
</body>
</html>