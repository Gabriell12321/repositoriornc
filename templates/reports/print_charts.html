<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Relatório com Gráficos - RNCs {{ start_date }} a {{ end_date }}</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @page {
            margin: 1.5cm;
            size: A4;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Arial', sans-serif;
            font-size: 12px;
            line-height: 1.4;
            color: #333;
            background: white;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 3px solid #8b1538;
        }
        
        .logo {
            max-width: 80px;
            height: auto;
            margin: 0 auto 15px;
            display: block;
        }
        
        .header h1 {
            color: #8b1538;
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .header h2 {
            color: #666;
            font-size: 16px;
            font-weight: normal;
        }
        
        .period {
            color: #e74c3c;
            font-size: 14px;
            font-weight: bold;
            margin-top: 10px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            border: 2px solid #8b1538;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .stat-number {
            font-size: 28px;
            font-weight: bold;
            color: #8b1538;
            display: block;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 12px;
            color: #666;
            font-weight: bold;
        }
        
        .charts-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .chart-container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            page-break-inside: avoid;
        }
        
        .chart-title {
            color: #8b1538;
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 15px;
            text-align: center;
            border-bottom: 2px solid #e74c3c;
            padding-bottom: 10px;
        }
        
        .chart-canvas {
            width: 100% !important;
            height: 250px !important;
        }
        
        .full-width-chart {
            grid-column: 1 / -1;
        }
        
        .full-width-chart .chart-canvas {
            height: 300px !important;
        }
        
        .summary-section {
            margin-bottom: 30px;
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
        }
        
        .section-title {
            color: #8b1538;
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            padding-bottom: 5px;
            border-bottom: 2px solid #e74c3c;
        }
        
        .insights-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }
        
        .insight-card {
            background: white;
            padding: 15px;
            border-radius: 6px;
            border-left: 4px solid #8b1538;
        }
        
        .insight-title {
            font-weight: bold;
            color: #8b1538;
            margin-bottom: 5px;
        }
        
        .insight-text {
            color: #666;
            font-size: 11px;
        }
        
        .footer {
            position: fixed;
            bottom: 1cm;
            left: 1.5cm;
            right: 1.5cm;
            text-align: center;
            font-size: 10px;
            color: #666;
            border-top: 1px solid #ddd;
            padding-top: 10px;
        }
        
        @media print {
            .no-print {
                display: none !important;
            }
            
            body {
                print-color-adjust: exact;
                -webkit-print-color-adjust: exact;
            }
            
            .charts-grid {
                grid-template-columns: 1fr;
                gap: 30px;
            }
        }
        
        @media screen {
            body {
                padding: 20px;
                background: #f5f5f5;
            }
            
            .container {
                max-width: 210mm;
                margin: 0 auto;
                background: white;
                padding: 30px;
                box-shadow: 0 0 20px rgba(0,0,0,0.1);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Cabeçalho -->
        <div class="header">
            <img src="/IPPELLOGO.jpg" alt="IPPEL Logo" class="logo">
            <h1>RELATÓRIO COM GRÁFICOS - RNCs</h1>
            <h2>Análise Visual de Não Conformidades</h2>
            <div class="period">
                Período: {{ start_date.strftime('%d/%m/%Y') if start_date else start_date }} 
                a {{ end_date.strftime('%d/%m/%Y') if end_date else end_date }}
            </div>
        </div>
        
        <!-- Estatísticas Principais -->
        <div class="stats-grid">
            <div class="stat-card">
                <span class="stat-number">{{ stats.total_rncs }}</span>
                <div class="stat-label">Total de RNCs</div>
            </div>
            <div class="stat-card">
                <span class="stat-number">{{ stats.finalized }}</span>
                <div class="stat-label">Finalizados</div>
            </div>
            <div class="stat-card">
                <span class="stat-number">{{ stats.pending }}</span>
                <div class="stat-label">Pendentes</div>
            </div>
            <div class="stat-card">
                <span class="stat-number">{{ stats.resolution_rate }}%</span>
                <div class="stat-label">Taxa de Resolução</div>
            </div>
        </div>
        
        <!-- Gráficos -->
        <div class="charts-grid">
            <!-- Gráfico de Status -->
            <div class="chart-container">
                <div class="chart-title">Distribuição por Status</div>
                <canvas id="statusChart" class="chart-canvas"></canvas>
            </div>
            
            <!-- Gráfico de Prioridade -->
            <div class="chart-container">
                <div class="chart-title">Distribuição por Prioridade</div>
                <canvas id="priorityChart" class="chart-canvas"></canvas>
            </div>
            
            <!-- Gráfico de Departamentos -->
            <div class="chart-container full-width-chart">
                <div class="chart-title">RNCs por Departamento</div>
                <canvas id="departmentChart" class="chart-canvas"></canvas>
            </div>
        </div>
        
        <!-- Insights e Análises -->
        <div class="summary-section">
            <h3 class="section-title">Insights e Análises</h3>
            <div class="insights-grid">
                <div class="insight-card">
                    <div class="insight-title">Performance Geral</div>
                    <div class="insight-text">
                        {% if stats.resolution_rate >= 80 %}
                        Excelente taxa de resolução ({{ stats.resolution_rate }}%). O sistema está funcionando eficientemente.
                        {% elif stats.resolution_rate >= 60 %}
                        Boa taxa de resolução ({{ stats.resolution_rate }}%). Há espaço para melhorias nos processos.
                        {% else %}
                        Taxa de resolução baixa ({{ stats.resolution_rate }}%). Recomenda-se revisar os processos de resolução.
                        {% endif %}
                    </div>
                </div>
                
                <div class="insight-card">
                    <div class="insight-title">Volume de RNCs</div>
                    <div class="insight-text">
                        {% if stats.total_rncs == 0 %}
                        Nenhuma RNC registrada no período.
                        {% elif stats.total_rncs < 10 %}
                        Baixo volume de RNCs ({{ stats.total_rncs }}). Período de baixa ocorrência.
                        {% elif stats.total_rncs < 50 %}
                        Volume moderado de RNCs ({{ stats.total_rncs }}). Dentro da normalidade.
                        {% else %}
                        Alto volume de RNCs ({{ stats.total_rncs }}). Requer atenção especial.
                        {% endif %}
                    </div>
                </div>
                
                <div class="insight-card">
                    <div class="insight-title">Status Atual</div>
                    <div class="insight-text">
                        {% if stats.pending > stats.finalized %}
                        Mais RNCs pendentes ({{ stats.pending }}) que finalizadas ({{ stats.finalized }}). Priorizar resolução.
                        {% elif stats.finalized > stats.pending %}
                        Mais RNCs finalizadas ({{ stats.finalized }}) que pendentes ({{ stats.pending }}). Boa performance.
                        {% else %}
                        Equilíbrio entre RNCs finalizadas e pendentes.
                        {% endif %}
                    </div>
                </div>
                
                <div class="insight-card">
                    <div class="insight-title">Recomendações</div>
                    <div class="insight-text">
                        {% if stats.resolution_rate < 70 %}
                        • Revisar processos de resolução<br>
                        • Treinar equipe responsável<br>
                        • Implementar follow-up regular
                        {% else %}
                        • Manter padrão atual<br>
                        • Documentar boas práticas<br>
                        • Monitorar continuamente
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Footer -->
    <div class="footer">
        Relatório gerado em {{ generated_at.strftime('%d/%m/%Y às %H:%M') }} | 
        Sistema IPPEL - Relatórios de Não Conformidade | 
        Página <span id="pageNum"></span>
    </div>
    
    <script>
        // Dados para os gráficos
        const statsData = {{ stats | tojson }};
        
        // Configuração global do Chart.js
        Chart.defaults.font.family = 'Arial';
        Chart.defaults.font.size = 11;
        
        // Cores padrão
        const colors = {
            primary: '#8b1538',
            secondary: '#e74c3c',
            success: '#28a745',
            warning: '#ffc107',
            info: '#17a2b8',
            light: '#f8f9fa',
            dark: '#343a40'
        };
        
        // Função para criar gráfico de pizza
        function createPieChart(ctx, data, title) {
            const labels = Object.keys(data);
            const values = Object.values(data);
            const backgroundColors = [
                colors.primary,
                colors.secondary,
                colors.success,
                colors.warning,
                colors.info,
                '#6f42c1',
                '#fd7e14'
            ];
            
            return new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: values,
                        backgroundColor: backgroundColors.slice(0, labels.length),
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 15,
                                usePointStyle: true
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = Math.round((context.parsed / total) * 100);
                                    return `${context.label}: ${context.parsed} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // Função para criar gráfico de barras
        function createBarChart(ctx, data, title) {
            const labels = Object.keys(data);
            const values = Object.values(data);
            
            return new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Quantidade de RNCs',
                        data: values,
                        backgroundColor: colors.primary,
                        borderColor: colors.secondary,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.label}: ${context.parsed.y} RNCs`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        },
                        x: {
                            ticks: {
                                maxRotation: 45
                            }
                        }
                    }
                }
            });
        }
        
        // Criar gráficos quando a página carregar
        window.addEventListener('load', function() {
            // Aguardar um pouco para garantir que o DOM está pronto
            setTimeout(() => {
                // Gráfico de Status
                if (statsData.by_status && Object.keys(statsData.by_status).length > 0) {
                    const statusCtx = document.getElementById('statusChart').getContext('2d');
                    createPieChart(statusCtx, statsData.by_status, 'Status');
                }
                
                // Gráfico de Prioridade
                if (statsData.by_priority && Object.keys(statsData.by_priority).length > 0) {
                    const priorityCtx = document.getElementById('priorityChart').getContext('2d');
                    createPieChart(priorityCtx, statsData.by_priority, 'Prioridade');
                }
                
                // Gráfico de Departamentos
                if (statsData.by_department && Object.keys(statsData.by_department).length > 0) {
                    const departmentCtx = document.getElementById('departmentChart').getContext('2d');
                    createBarChart(departmentCtx, statsData.by_department, 'Departamentos');
                }
                
                // Configurar impressão automática se solicitado
                if (window.location.search.includes('auto_print=true')) {
                    setTimeout(() => {
                        window.print();
                    }, 1000);
                }
            }, 500);
        });
        
        // Botão para imprimir manualmente
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.key === 'p') {
                e.preventDefault();
                window.print();
            }
        });
    </script>
</body>
</html>
