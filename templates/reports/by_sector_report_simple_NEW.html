<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Relatório RNC por Setor - IPPEL - NOVO</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @page {
            size: A4;
            margin: 1.5cm;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background: white;
            padding: 20px;
        }
        
        /* Estilos específicos para impressão */
        @media print {
            @page {
                size: A4;
                margin: 1cm;
            }
            
            body {
                font-size: 11px;
                line-height: 1.4;
                padding: 10px;
            }
            
            .charts-grid {
                page-break-inside: avoid;
                margin: 15px 0;
                display: grid !important;
                grid-template-columns: 1fr 1fr !important;
                gap: 15px !important;
            }
            
            .chart-card {
                background: white !important;
                border: 1px solid #ccc !important;
                border-radius: 4px !important;
                padding: 10px !important;
                box-shadow: none !important;
                height: 250px !important;
                width: 100% !important;
            }
            
            .chart-card h3 {
                font-size: 12px !important;
                margin-bottom: 8px !important;
                text-align: center !important;
            }
            
            canvas {
                max-height: 200px !important;
                width: 100% !important;
                height: auto !important;
            }
            
            .summary-grid {
                display: grid !important;
                grid-template-columns: repeat(4, 1fr) !important;
                gap: 10px !important;
                margin: 10px 0 !important;
            }
            
            .summary-card {
                background: white !important;
                border: 1px solid #ccc !important;
                border-radius: 4px !important;
                padding: 8px !important;
                text-align: center !important;
                box-shadow: none !important;
            }
            
            .summary-card .number {
                font-size: 16px !important;
                font-weight: bold !important;
                color: #2c3e50 !important;
            }
            
            .summary-card .label {
                font-size: 10px !important;
                color: #7f8c8d !important;
            }
            
            .title {
                font-size: 20px !important;
                margin-bottom: 8px !important;
            }
            
            .subtitle {
                font-size: 12px !important;
                margin-bottom: 5px !important;
            }
            
            .generated-info {
                font-size: 10px !important;
            }
            
            .sector-item {
                font-size: 10px !important;
                padding: 3px 6px !important;
                margin: 2px !important;
            }
            
            .footer {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                font-size: 8px;
                text-align: center;
                padding: 5px;
                border-top: 1px solid #ccc;
            }
        }
        
        .header {
            text-align: center;
            border-bottom: 3px solid #2c3e50;
            padding-bottom: 20px;
            margin-bottom: 30px;
        }
        
        .title {
            font-size: 28px;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        .subtitle {
            font-size: 16px;
            color: #7f8c8d;
            margin-bottom: 5px;
        }
        
        .generated-info {
            text-align: right;
            font-size: 12px;
            color: #7f8c8d;
            margin-bottom: 20px;
        }
        
        .summary-section {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 30px;
        }
        
        .summary-title {
            font-size: 20px;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 15px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 12px;
            color: #7f8c8d;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .charts-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .chart-container {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            height: 400px;
            overflow: hidden;
            position: relative;
        }
        
        .chart-title {
            font-size: 16px;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .chart-canvas {
            max-height: 300px;
            max-width: 100%;
        }
        
        canvas {
            max-width: 100% !important;
            max-height: 320px !important;
        }
        
        .sector-section {
            margin-bottom: 30px;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .sector-header {
            background: #f8f9fa;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: bold;
            font-size: 18px;
            color: #2c3e50;
        }
        
        .sector-total {
            color: #27ae60;
            font-weight: bold;
        }
        
        .sector-stats {
            background: #f1f3f4;
            padding: 10px 20px;
            font-size: 14px;
            color: #666;
        }
        
        .rnc-list {
            padding: 0;
        }
        
        .rnc-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 20px;
            border-bottom: 1px solid #eee;
        }
        
        .rnc-item:last-child {
            border-bottom: none;
        }
        
        .rnc-item:hover {
            background: #f9f9f9;
        }
        
        .rnc-info {
            flex-grow: 1;
        }
        
        .rnc-number {
            font-weight: bold;
            color: #2c3e50;
            font-size: 16px;
            margin-bottom: 4px;
        }
        
        .rnc-details {
            font-size: 12px;
            color: #666;
        }
        
        .rnc-value {
            font-weight: bold;
            color: #27ae60;
            font-size: 16px;
            text-align: right;
            min-width: 120px;
        }
        
        .no-data {
            text-align: center;
            padding: 40px;
            color: #666;
            font-style: italic;
        }
        
        .footer {
            text-align: center;
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid #ddd;
            font-size: 12px;
            color: #666;
        }
        
        .print-controls {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }
        
        .btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            margin-left: 10px;
        }
        
        .btn:hover {
            background: #2980b9;
        }
        
        .btn-secondary {
            background: #6c757d;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
        }
        
        @media print {
            .print-controls {
                display: none;
            }
            
            body {
                padding: 0;
            }
            
            .charts-section {
                grid-template-columns: 1fr;
                page-break-inside: avoid;
            }
            
            .chart-container {
                break-inside: avoid;
                margin-bottom: 20px;
            }
            
            .summary-section {
                page-break-inside: avoid;
            }
        }
        
        @media (max-width: 768px) {
            .charts-section {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="print-controls">
        <button class="btn btn-secondary" onclick="window.history.back()">← Voltar</button>
        <button class="btn" onclick="window.print()">🖨️ Imprimir</button>
    </div>

    <div class="header">
        <h1 class="title">RELATÓRIO RNC POR SETOR</h1>
        <p class="subtitle">Sistema IPPEL - Relatório de Não Conformidades</p>
        <p class="subtitle">Período: {{ start_date }} a {{ end_date }}</p>
    </div>
    
    <div class="generated-info">
        <p>Gerado em: {{ generated_at.strftime('%d/%m/%Y às %H:%M') if generated_at else 'N/A' }}</p>
        <p>Total de RNCs: {{ stats.total_rncs if stats and stats.total_rncs else rncs|length }}</p>
    </div>
    
    {# Organizar todos os RNCs por grupo para cálculos #}
    {% set groups = {} %}
    {% set total_value = 0 %}
    
    {# Processar todos os RNCs #}
    {% for rnc in rncs %}
        {% set group = rnc.group_name or 'Sem Grupo' %}
        {% set value = rnc.price|float if rnc.price else 0 %}
        {% set total_value = total_value + value %}
        
        {# Inicializar grupo se não existir #}
        {% if group not in groups %}
            {% set _ = groups.update({group: {'rncs': [], 'total': 0, 'count': 0}}) %}
        {% endif %}
        
        {# Adicionar RNC ao grupo #}
        {% set _ = groups[group]['rncs'].append(rnc) %}
        {% set _ = groups[group].update({'total': groups[group]['total'] + value}) %}
        {% set _ = groups[group].update({'count': groups[group]['count'] + 1}) %}
    {% endfor %}
    
    <!-- Seção de Resumo -->
    <div class="summary-section">
        <h2 class="summary-title">📊 RESUMO EXECUTIVO</h2>
        
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number">{{ groups|length }}</div>
                <div class="stat-label">Setores</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">{{ rncs|length }}</div>
                <div class="stat-label">Total de RNCs</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">R$ {{ total_value|brl }}</div>
                <div class="stat-label">Valor Total</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">R$ {{ (total_value / (rncs|length if rncs|length > 0 else 1))|brl }}</div>
                <div class="stat-label">Valor Médio</div>
            </div>
        </div>
    </div>
    
    <!-- Seção de Gráficos -->
    <div class="charts-section">
        <div class="chart-container">
            <h3 class="chart-title">📈 Distribuição de RNCs por Setor</h3>
            <canvas id="rncsChart" class="chart-canvas"></canvas>
        </div>
        
        <div class="chart-container">
            <h3 class="chart-title">💰 Distribuição de Valores por Setor</h3>
            <canvas id="valuesChart" class="chart-canvas"></canvas>
        </div>
    </div>

    {# Renderizar por grupo #}
    {% for group_name, group_data in groups.items() %}
        <div class="sector-section">
            <div class="sector-header">
                <span>{{ group_name }}</span>
                <span class="sector-total">R$ {{ group_data.total|brl }}</span>
            </div>
            
            <div class="sector-stats">
                <strong>{{ group_data.count }}</strong> RNCs • 
                Valor Total: <strong>R$ {{ group_data.total|brl }}</strong> • 
                Valor Médio: <strong>R$ {{ (group_data.total / group_data.count)|brl if group_data.count > 0 else '0,00' }}</strong>
            </div>
            
            <div class="rnc-list">
                {% for rnc in group_data.rncs %}
                    <div class="rnc-item">
                        <div class="rnc-info">
                            <div class="rnc-number">RNC {{ rnc.rnc_number }}</div>
                            <div class="rnc-details">
                                {{ rnc.department or 'N/A' }} • {{ rnc.responsavel or 'N/A' }} • {{ rnc.status or 'N/A' }} • {{ rnc.created_at.split(' ')[0] if rnc.created_at else 'N/A' }}
                            </div>
                        </div>
                        <div class="rnc-value">
                            {{ rnc.price_formatted if rnc.price_formatted else ('R$ ' ~ ((rnc.price|float if rnc.price else 0)|brl)) }}
                        </div>
                    </div>
                {% endfor %}
            </div>
        </div>
    {% endfor %}
    
    {% if not groups %}
        <div class="no-data">
            <h3>Nenhum RNC encontrado</h3>
            <p>Não há RNCs no período selecionado.</p>
        </div>
    {% endif %}
    
    <div class="footer">
        <p><strong>IPPEL - Sistema de Relatórios de Não Conformidade</strong></p>
        <p>Relatório gerado automaticamente em {{ generated_at.strftime('%d/%m/%Y às %H:%M:%S') if generated_at else 'N/A' }}</p>
    </div>
    
    <script>
        // Dados dos setores (gerados pelo template)
        const sectorsData = [
            {% for group_name, group_data in groups.items() %}
            {
                name: "{{ group_name }}",
                count: {{ group_data.count }},
                total: {{ group_data.total }}
            }{{ "," if not loop.last else "" }}
            {% endfor %}
        ];
        
        // Cores para os gráficos
        const colors = [
            '#3498db', '#e74c3c', '#2ecc71', '#f39c12', '#9b59b6',
            '#1abc9c', '#34495e', '#e67e22', '#95a5a6', '#f1c40f'
        ];
        
        // Preparar dados para os gráficos
        const sectorNames = sectorsData.map(sector => sector.name);
        const rncsCount = sectorsData.map(sector => sector.count);
        const sectorValues = sectorsData.map(sector => sector.total);
        
        // Configuração do gráfico de RNCs
        const rncsCtx = document.getElementById('rncsChart').getContext('2d');
        new Chart(rncsCtx, {
            type: 'doughnut',
            data: {
                labels: sectorNames,
                datasets: [{
                    data: rncsCount,
                    backgroundColor: colors.slice(0, sectorNames.length),
                    borderWidth: 2,
                    borderColor: '#fff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                layout: {
                    padding: {
                        top: 10,
                        right: 10,
                        bottom: 10,
                        left: 10
                    }
                },
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            boxWidth: 12,
                            font: {
                                size: 11
                            }
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = Math.round((context.parsed / total) * 100);
                                return context.label + ': ' + context.parsed + ' RNCs (' + percentage + '%)';
                            }
                        }
                    }
                }
            }
        });
        
        // Configuração do gráfico de valores
        const valuesCtx = document.getElementById('valuesChart').getContext('2d');
        new Chart(valuesCtx, {
            type: 'bar',
            data: {
                labels: sectorNames,
                datasets: [{
                    label: 'Valor (R$)',
                    data: sectorValues,
                    backgroundColor: colors.slice(0, sectorNames.length).map(color => color + '80'),
                    borderColor: colors.slice(0, sectorNames.length),
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                layout: {
                    padding: {
                        top: 10,
                        right: 10,
                        bottom: 10,
                        left: 10
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return 'R$ ' + context.parsed.y.toLocaleString('pt-BR', {
                                    minimumFractionDigits: 2,
                                    maximumFractionDigits: 2
                                });
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return 'R$ ' + value.toLocaleString('pt-BR', {
                                    minimumFractionDigits: 0,
                                    maximumFractionDigits: 0
                                });
                            }
                        }
                    },
                    x: {
                        ticks: {
                            maxRotation: 45,
                            font: {
                                size: 10
                            }
                        }
                    }
                }
            }
        });
    </script>
</body>
</html>
