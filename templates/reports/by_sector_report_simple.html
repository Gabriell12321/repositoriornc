<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Relatório RNC por Setor - IPPEL</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: white;
        }
        .header {
            text-align: center;
            border-bottom: 2px solid #333;
            padding-bottom: 15px;
            margin-bottom: 30px;
        }
        .sector-section {
            margin-bottom: 30px;
            border: 1px solid #ddd;
            padding: 15px;
        }
        .sector-header {
            background: #f0f0f0;
            padding: 10px;
            font-weight: bold;
            font-size: 16px;
        }
        .rnc-item {
            padding: 5px 0;
            border-bottom: 1px solid #eee;
        }
        .debug-info {
            background: #f8f9fa;
            padding: 10px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>RELATÓRIO RNC POR GRUPO</h1>
        <p>Período: {{ start_date }} a {{ end_date }}</p>
        <p>Total de RNCs: {{ stats.total_rncs }}</p>
    </div>
    
    <div class="debug-info">
        <strong>DEBUG INFO:</strong><br>
        Total de RNCs recebidas: {{ rncs|length }}<br>
        Grupos únicos: {{ rncs|map(attribute='group_name')|unique|list|length }}<br>
        Grupos: {{ rncs|map(attribute='group_name')|unique|list }}<br>
        Departamentos: {{ rncs|map(attribute='department')|unique|list }}
    </div>
    
    {# Organizar todos os RNCs por grupo #}
    {% set groups = {} %}
    
    {# Processar todos os RNCs #}
    {% for rnc in rncs %}
        {% set group = rnc.group_name or 'Sem Grupo' %}
        {% set value = rnc.price|float if rnc.price else 0 %}
        
        {# Inicializar grupo se não existir #}
        {% if group not in groups %}
            {% set _ = groups.update({group: {'rncs': [], 'total': 0, 'count': 0}}) %}
        {% endif %}
        
        {# Adicionar RNC ao grupo #}
        {% set _ = groups[group]['rncs'].append(rnc) %}
        {% set _ = groups[group].update({'total': groups[group]['total'] + value}) %}
        {% set _ = groups[group].update({'count': groups[group]['count'] + 1}) %}
    {% endfor %}
    
    <div class="debug-info">
        <strong>GRUPOS PROCESSADOS:</strong><br>
        {% for group_name, group_data in groups.items() %}
            {{ group_name }}: {{ group_data.count }} RNCs, R$ {{ "%.2f"|format(group_data.total) }}<br>
        {% endfor %}
    </div>
    
    {# Renderizar por grupo #}
    {% for group_name, group_data in groups.items() %}
        <div class="sector-section">
            <div class="sector-header">
                {{ group_name }} - R$ {{ "%.2f"|format(group_data.total) }} ({{ group_data.count }} RNCs)
            </div>
            
            <div class="rnc-list">
                {% for rnc in group_data.rncs %}
                    <div class="rnc-item">
                        <strong>RNC {{ rnc.rnc_number }}</strong> - R$ {{ "%.2f"|format(rnc.price|float if rnc.price else 0) }}
                        <br>
                        <small>
                            Departamento: {{ rnc.department or 'N/A' }} | 
                            Responsável: {{ rnc.responsavel or 'N/A' }} | 
                            Status: {{ rnc.status or 'N/A' }} | 
                            Data: {{ rnc.created_at.split(' ')[0] if rnc.created_at else 'N/A' }}
                        </small>
                    </div>
                {% endfor %}
            </div>
        </div>
    {% endfor %}
    
    {% if not groups %}
        <div style="text-align: center; padding: 40px; color: #666;">
            <h3>Nenhum RNC encontrado</h3>
            <p>Não há RNCs no período selecionado.</p>
        </div>
    {% endif %}
</body>
</html>
