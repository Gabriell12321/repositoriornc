2<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Relat√≥rio RNC por Operador - IPPEL</title>
    <style>
        @page {
            size: A4;
            margin: 2cm;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background: white;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #333;
            padding-bottom: 15px;
            margin-bottom: 30px;
        }
        
        .logo {
            width: 120px;
            height: auto;
        }
        
        .title-section {
            text-align: center;
            flex-grow: 1;
        }
        
        .main-title {
            font-size: 24px;
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }
        
        .date-info {
            font-size: 16px;
            color: #666;
        }
        
        .generated-info {
            text-align: right;
            font-size: 12px;
            color: #7f8c8d;
            margin-bottom: 20px;
        }
        
        .department-section {
            margin-bottom: 15px;
        }
        
        .department-header {
            background: #f0f0f0;
            padding: 6px 12px;
            margin-bottom: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: bold;
            font-size: 15px;
        }
        
        .department-name {
            color: #333;
        }
        
        .department-total {
            color: #333;
            font-weight: bold;
        }
        
        .department-subtotal {
            margin-left: 20px;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }
        
        .employee-list {
            margin-left: 40px;
        }
        
        .employee-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 3px 0;
        }
        
        .employee-name {
            color: #333;
            font-size: 14px;
        }
        
        .employee-value {
            color: #333;
            font-weight: bold;
            font-size: 14px;
        }
        
        .section-divider {
            height: 1px;
            background: #ddd;
            margin: 10px 0;
            width: 100%;
        }
        
        .footer {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #dee2e6;
            text-align: center;
            font-size: 11px;
            color: #7f8c8d;
        }
        
        .page-break {
            page-break-before: always;
        }
        
        @media print {
            .no-print {
                display: none;
            }
            
            body {
                font-size: 11px;
            }
            
            .main-title {
                font-size: 20px;
            }
            
            .department-header {
                font-size: 14px;
                padding: 8px 12px;
            }
            
            .employee-item {
                font-size: 12px;
            }
        }
        
        .print-button {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            z-index: 1000;
        }
        
        .print-button:hover {
            background: #2980b9;
        }
        
        .back-button {
            position: fixed;
            top: 20px;
            right: 120px;
            background: #6c757d;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            z-index: 1000;
        }
        
        .back-button:hover {
            background: #5a6268;
        }
        
        .no-data {
            text-align: center;
            padding: 40px;
            color: #666;
            font-style: italic;
        }
    </style>
</head>
<body>
    <button class="print-button no-print" onclick="window.print()">üñ®Ô∏è Imprimir</button>
    <button class="back-button no-print" onclick="window.location.href='/reports/menu'">üìä Novo Relat√≥rio</button>
    
    <div class="header" style="margin-bottom: 15px; padding-bottom: 10px;">
        <img src="/IPPELLOGO.jpg" alt="IPPEL Logo" class="logo">
        <div class="title-section">
            <h1 class="main-title">RELAT√ìRIO RNC POR DATA</h1>
            <p class="date-info">{{ start_date.split('-')[1] }}/{{ start_date.split('-')[0] }}</p>
        </div>
    </div>
    
    <div class="generated-info" style="margin-bottom: 10px;">
        <p>Gerado em: {{ generated_at.strftime('%d/%m/%Y √†s %H:%M') }}</p>
        <p>Per√≠odo: {{ start_date }} a {{ end_date }}</p>
        <p>Total de RNCs: {{ stats.total_rncs }}</p>
    </div>

    {# Organizar todos os RNCs: Produ√ß√£o > Setor > Funcion√°rio #}
    {% set departments = {} %}

    {# Processar todos os RNCs #}
    {% for rnc in rncs %}
        {# Se for Produ√ß√£o, usar SETOR como grupo principal #}
        {% if rnc.area_responsavel and 'produ' in rnc.area_responsavel|lower %}
            {% set main_group = 'Produ√ß√£o' %}
            {% set sub_group = rnc.setor if rnc.setor else 'Setor n√£o informado' %}
        {% else %}
            {# Para outros departamentos, usar √°rea como grupo principal sem subgrupo #}
            {% set main_group = rnc.creator_department or rnc.department or 'Sem Departamento' %}
            {% set sub_group = None %}
        {% endif %}
        
        {% set employee = rnc.responsavel or rnc.creator_name or 'Sistema' %}
        {% set value = rnc.price|parse_brl if rnc.price else 0 %}

        {# Inicializar grupo principal se n√£o existir #}
        {% if main_group not in departments %}
            {% set _ = departments.update({main_group: {'subgroups': {}, 'total': 0}}) %}
        {% endif %}

        {# Se tiver subgrupo (Produ√ß√£o -> Setor) #}
        {% if sub_group %}
            {# Inicializar subgrupo se n√£o existir #}
            {% if sub_group not in departments[main_group]['subgroups'] %}
                {% set _ = departments[main_group]['subgroups'].update({sub_group: {'employees': {}, 'total': 0}}) %}
            {% endif %}
            
            {# Adicionar funcion√°rio no subgrupo #}
            {% if employee not in departments[main_group]['subgroups'][sub_group]['employees'] %}
                {% set _ = departments[main_group]['subgroups'][sub_group]['employees'].update({employee: 0}) %}
            {% endif %}
            
            {# Somar valor no funcion√°rio e subgrupo #}
            {% set _ = departments[main_group]['subgroups'][sub_group]['employees'].update({employee: departments[main_group]['subgroups'][sub_group]['employees'][employee] + value}) %}
            {% set _ = departments[main_group]['subgroups'][sub_group].update({'total': departments[main_group]['subgroups'][sub_group]['total'] + value}) %}
        {% else %}
            {# Sem subgrupo: adicionar diretamente no grupo principal #}
            {% if 'employees' not in departments[main_group] %}
                {% set _ = departments[main_group].update({'employees': {}}) %}
            {% endif %}
            
            {% if employee not in departments[main_group]['employees'] %}
                {% set _ = departments[main_group]['employees'].update({employee: 0}) %}
            {% endif %}
            
            {% set _ = departments[main_group]['employees'].update({employee: departments[main_group]['employees'][employee] + value}) %}
        {% endif %}
        
        {# Somar no total do grupo principal #}
        {% set _ = departments[main_group].update({'total': departments[main_group]['total'] + value}) %}
    {% endfor %}

    {# Calcular total geral somando todos os valores de RNCs #}
    {% set grand_total = rncs|selectattr('price')|map(attribute='price')|map('parse_brl')|sum %}
    
    <div class="department-header" style="margin-top:5px; margin-bottom:8px; background:#d4edda; font-size:16px;">
        <span class="department-name">üí∞ Total Geral</span>
        <span class="department-total">R$ {{ grand_total|brl }}</span>
    </div>
    
    {# Renderizar por departamento - ORDEM ALFAB√âTICA #}
    {% set dept_list = [] %}
    {% for name, data in departments.items() %}
        {% set _ = dept_list.append({'name': name, 'data': data, 'total': data.total}) %}
    {% endfor %}
    {% for _item in dept_list|sort(attribute='name') %}
        {% set dept_name = _item.name %}
        {% set dept_data = _item.data %}
        <div class="department-section">
            <div class="department-header">
                <span class="department-name">{{ dept_name }}</span>
                <span class="department-total">R$ {{ dept_data.total|brl }}</span>
            </div>
            <div class="department-subtotal">
                R$ {{ dept_data.total|brl }}
            </div>
            
            {# Se tiver SUBGRUPOS (Produ√ß√£o > Setores) #}
            {% if dept_data.subgroups %}
                {% for subgroup_name, subgroup_data in dept_data.subgroups|dictsort %}
                    <div style="margin-left: 20px; margin-top: 5px;">
                        <div class="department-header" style="font-size: 13px; background: #e8f4f8; padding: 4px 10px;">
                            <span class="department-name">üìÇ {{ subgroup_name }}</span>
                            <span class="department-total">R$ {{ subgroup_data.total|brl }}</span>
                        </div>
                        <div class="employee-list" style="margin-left: 20px;">
                            {# ORDEM ALFAB√âTICA dos funcion√°rios no setor #}
                            {% for employee_name, employee_value in subgroup_data.employees|dictsort %}
                                <div class="employee-item">
                                    <span class="employee-name">{{ employee_name }}</span>
                                    <span class="employee-value">R$ {{ employee_value|brl }}</span>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                {% endfor %}
            {% else %}
                {# Sem subgrupos: mostrar funcion√°rios diretamente #}
                <div class="employee-list">
                    {# ORDEM ALFAB√âTICA dos funcion√°rios #}
                    {% for employee_name, employee_value in dept_data.employees|dictsort %}
                        <div class="employee-item">
                            <span class="employee-name">{{ employee_name }}</span>
                            <span class="employee-value">R$ {{ employee_value|brl }}</span>
                        </div>
                    {% endfor %}
                </div>
            {% endif %}
        </div>
        
        {% if not loop.last %}
            <div class="section-divider"></div>
        {% endif %}
    {% endfor %}
    
    {% if not departments %}
        <div class="no-data">
            <h3>Nenhum RNC encontrado</h3>
            <p>N√£o h√° RNCs no per√≠odo selecionado.</p>
        </div>
    {% endif %}
    
    <div class="footer">
        <p>IPPEL - Sistema de Relat√≥rios de N√£o Conformidade</p>
        <p>Relat√≥rio gerado automaticamente pelo sistema</p>
        <p>P√°gina 1 de 1</p>
    </div>
</body>
</html>
