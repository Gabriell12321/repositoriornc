
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Relat√≥rio De N√£o Conformidades Internas - RNC</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'Noto Sans', 'Liberation Sans', sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji';
            background: white !important;
            padding: 0;
            margin: 0;
            min-height: 100vh;
            position: relative;
            overflow-x: hidden;
        }

        .container {
            width: 100vw;
            height: 100vh;
            margin: 0;
            background: white !important;
            padding: 35px;
            border-radius: 0;
            overflow-y: auto;
            position: relative;
        }

        .header {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 15px;
            border-bottom: none;
            padding-bottom: 0;
            position: relative;
        }

        .logos {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            margin: 0 auto;
        }

        .logo-ippel {
            width: 120px;
            height: 120px;
            background: transparent;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 15px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .logo-ippel:hover {
            transform: scale(1.05);
        }



        .title-section {
            text-align: center;
            margin: 20px 0;
        }

        .main-title {
            font-size: 30px;
            font-weight: 800;
            margin-bottom: 15px;
            color: #333 !important;
            letter-spacing: 1.5px;
            position: relative;
            text-align: center;
        }

        .main-title::after {
            display: none !important;
        }

        .main-title::before {
            display: none !important;
        }

        .subtitle {
            font-size: 18px;
            font-weight: 600;
            color: #6c757d;
            letter-spacing: 1.5px;
            margin-top: 8px;
        }

        .form-code {
            position: absolute;
            right: 20px;
            top: 120px;
            font-size: 16px;
            font-weight: bold;
        }

        .rnc-number {
            text-align: right;
            margin: 10px 0;
            font-weight: bold;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 25px;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: none !important;
            position: relative;
            backdrop-filter: none !important;
            transition: all 0.3s ease;
        }

        table:hover {
            transform: none !important;
            box-shadow: none !important;
        }

        table::before {
            display: none !important;
        }

        td, th {
            border: 2px solid #dc3545;
            padding: 8px;
            vertical-align: top;
            font-size: 12px;
            transition: border-color 0.2s ease;
        }

        table:hover td, table:hover th {
            border-color: #c82333;
        }

        .field-label {
            background: #6c757d !important;
            font-weight: 600;
            text-align: left;
            padding: 12px 15px;
            font-size: 12px;
            border: 2px solid #dc3545 !important;
            color: white !important;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .field-label::before {
            display: none !important;
        }

        .field-label:hover::before {
            display: none !important;
        }

        .field-label:hover {
            background: transparent !important;
            border-color: transparent !important;
            transform: none !important;
            box-shadow: none !important;
        }

        .input-field {
            border: 2px solid #dc3545 !important;
            width: 100% !important;
            padding: 6px !important;
            font-size: 12px !important;
            background: #dc3545 !important;
            color: white !important;
            transition: all 0.2s ease !important;
            border-radius: 2px !important;
        }

        .input-field:focus {
            background: #dc3545 !important;
            outline: none !important;
            border: 2px solid #dc3545 !important;
            box-shadow: 0 0 0 4px rgba(220, 53, 69, 0.2) !important;
            transform: translateY(-2px) scale(1.02) !important;
            color: white !important;
        }

        .input-field:hover {
            background-color: #dc3545 !important;
            transform: translateY(-0.5px) !important;
            box-shadow: 0 2px 6px rgba(220, 53, 69, 0.3) !important;
            color: white !important;
        }

        .section-title {
            background: #6c757d !important;
            color: white !important;
            text-align: center;
            font-weight: 700;
            padding: 16px 20px;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            font-size: 13px;
            box-shadow: none !important;
            position: relative;
            overflow: hidden;
            text-shadow: none !important;
        }

        .section-title::before {
            display: none !important;
        }

        .section-title::after {
            display: none !important;
        }

        .section-title:hover::before {
            display: none !important;
        }

        .section-title:hover {
            transform: none !important;
            box-shadow: none !important;
        }

        .large-text-area {
            height: 120px;
            resize: vertical;
        }

        .medium-text-area {
            height: 80px;
            resize: vertical;
        }

        /* CAMPOS DE INPUT BRANCOS (onde voc√™ digita) */
        input, select, textarea {
            background: white !important;
            color: #333 !important;
            border: 2px solid #dc3545 !important;
        }

        /* Placeholders em cinza escuro */
        input::placeholder, textarea::placeholder {
            color: #666 !important;
        }

        /* Options dos selects */
        select option {
            background: white !important;
            color: #333 !important;
        }

    /* Campos espec√≠ficos do formul√°rio */
    #title, #equipment, #client, #priority, #share_groups, #assigned_user_single, #rnc_number {
            background: white !important;
            color: #333 !important;
            border: 2px solid #dc3545 !important;
        }

        /* Textareas */
        textarea.input-field {
            background: white !important;
            color: #333 !important;
            border: 2px solid #dc3545 !important;
        }

        /* TODOS os tipos de input */
        input[type="text"], input[type="email"], input[type="password"], 
        input[type="number"], input[type="date"], input[type="datetime-local"] {
            background: white !important;
            color: #333 !important;
            border: 2px solid #dc3545 !important;
        }

        /* Todos os selects */
        select {
            background: white !important;
            color: #333 !important;
            border: 2px solid #dc3545 !important;
        }

        /* Todos os textareas */
        textarea {
            background: white !important;
            color: #333 !important;
            border: 2px solid #dc3545 !important;
        }

        /* Placeholders */
        ::placeholder {
            color: #666 !important;
        }

        /* Options */
        option {
            background: white !important;
            color: #333 !important;
        }

        /* Classe input-field */
        .input-field {
            background: white !important;
            color: #333 !important;
            border: 2px solid #dc3545 !important;
        }

        /* --- Nice cards & chips for assignee/share sections --- */
        .section-card {
            background: #fff;
            border: 1px solid rgba(139, 21, 56, 0.25);
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(139, 21, 56, 0.08);
            padding: 14px 16px;
        }
        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
        }
        .section-header--bar {
            background: linear-gradient(180deg, #6c757d 0%, #5f6770 100%);
            color: #fff;
            border-radius: 8px;
            padding: 8px 12px;
            box-shadow: inset 0 1px 0 rgba(255,255,255,0.25);
        }
        .section-title {
            font-weight: 700;
            color: #8b1538;
            font-size: 0.98rem;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        .section-header--bar .section-title {
            color: #fff;
            letter-spacing: .3px;
            text-transform: uppercase;
        }
        .help-hint {
            margin-top: 8px;
            font-size: 0.85rem;
            color: #495057;
            background: #f8f9fa;
            padding: 10px;
            border-radius: 6px;
            border-left: 4px solid #8b1538;
        }
        .fancy-select {
            width: 100%;
            padding: 12px;
            border: 2px solid #8b1538;
            border-radius: 8px;
            background: #fff;
            font-size: 14px;
            transition: box-shadow .15s ease, border-color .15s ease;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="%238b1538" d="M7 10l5 5 5-5z"/></svg>');
            background-repeat: no-repeat;
            background-position: right 10px center;
            background-size: 18px;
            padding-right: 40px;
        }
        .fancy-select:focus {
            outline: none;
            border-color: #a41b45;
            box-shadow: 0 0 0 3px rgba(164, 27, 69, 0.15);
        }
        .preview-card {
            margin-top: 8px;
            background: #fff;
            border: 1px solid rgba(139, 21, 56, 0.35);
            border-radius: 10px;
            padding: 10px 12px;
        }
        .preview-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-weight: 600;
            color: #495057;
            margin-bottom: 6px;
        }
        .chips {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }
        .chip {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            border-radius: 999px;
            border: 1px solid rgba(139, 21, 56, 0.45);
            color: #6b0f2a;
            line-height: 1.2;
            font-size: 0.86rem;
            background: rgba(139, 21, 56, 0.20);
            position: relative;
            transition: transform .18s ease, opacity .22s ease, background .2s ease, border-color .2s ease;
        }
        .chip:hover { transform: translateY(-1px); background: rgba(139, 21, 56, 0.28); }
        .chip--muted {
            background: rgba(139, 21, 56, 0.14);
            color: #5a0c24;
        }
        .chip--danger {
            background: rgba(139, 21, 56, 0.40);
            border-color: rgba(139, 21, 56, 0.60);
            color: #4d091b;
        }
        /* Estado de restaura√ß√£o (revertido), mais escuro para evidenciar */
        .chip--restored {
            background: rgba(139, 21, 56, 0.55);
            border-color: rgba(139, 21, 56, 0.85);
            color: #ffffff;
            box-shadow: 0 0 0 2px rgba(139, 21, 56, 0.18) inset;
            animation: chipRestore 360ms ease-out;
        }
        @keyframes chipRestore {
            0% { transform: scale(0.9); opacity: 0.35; }
            60% { transform: scale(1.06); opacity: 1; }
            100% { transform: scale(1); }
        }
        /* Anima√ß√£o de remo√ß√£o do chip */
        .chip--removing {
            background: rgba(139, 21, 56, 0.45);
            border-color: rgba(139, 21, 56, 0.75);
            transform: translateY(-6px) scale(0.85);
            opacity: 0;
        }
        .chip--removing::after {
            content: "";
            position: absolute;
            left: 50%; top: 50%;
            width: 6px; height: 6px;
            border-radius: 50%;
            background: #8b1538;
            transform: translate(-50%, -50%) scale(1);
            opacity: 0.7;
            animation: chipRipple 280ms ease-out forwards;
        }
        @keyframes chipRipple {
            from { transform: translate(-50%, -50%) scale(1); opacity: 0.7; }
            to   { transform: translate(-50%, -50%) scale(4.2); opacity: 0; }
        }
        .chip-remove,
        .chip-remove-group {
            cursor: pointer;
            border: none;
            background: transparent;
            color: #8b1538;
            font-weight: 700;
            padding: 0 2px;
            width: 18px; height: 18px;
            display: inline-flex;
            align-items: center; justify-content: center;
            border-radius: 50%;
        }
        .chip-remove:hover,
        .chip-remove-group:hover {
            color: #fff;
            background: #6b0f2a;
        }
        .chip-remove:active, .chip-remove-group:active { transform: scale(0.92); }

        /* Campos espec√≠ficos */
        #assinatura_gerente, #nome_responsavel, #data_emissao, #area_responsavel {
            background: white !important;
            color: #333 !important;
            border: 2px solid #dc3545 !important;
        }

        .checkbox-section {
            display: flex;
            justify-content: space-between;
            gap: 20px;
            margin-top: 15px;
        }

        .checkbox-group {
            flex: 1;
            border: 1px solid #000;
            padding: 8px;
        }

        .checkbox-title {
            font-weight: bold;
            text-align: center;
            margin-bottom: 8px;
            border-bottom: 1px solid #000;
            padding-bottom: 4px;
            font-size: 11px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            margin: 8px 0;
            font-size: 12px;
        }

        .checkbox-item input[type="checkbox"] {
            margin-right: 8px;
            transform: scale(1.0);
            accent-color: black;
        }

        .checkbox-item:hover {
            background-color: transparent;
            border-radius: 0;
            padding: 0;
        }

        .signature-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 15px;
        }

        .signature-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 5px 0;
            font-size: 12px;
        }

        .date-input {
            border: none;
            border-bottom: 1px solid #333;
            text-align: center;
            width: 80px;
            padding: 2px;
            margin: 0 5px;
        }

        .signature-line {
            border-bottom: 1px solid #333;
            flex: 1;
            height: 20px;
        }

        @media print {
            body {
                padding: 0;
                background: white;
            }
            .container {
                box-shadow: none;
                margin: 0;
                max-width: none;
            }
        }

        .item-column {
            width: 80px;
            text-align: center;
            font-weight: bold;
            background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
            color: white;
            vertical-align: middle;
            /* Remove a borda interna para unir com a c√©lula de t√≠tulo e formar uma barra √∫nica */
            border-right: none !important;
            border: 2px solid #dc3545;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
        }

        /* Garante que as c√©lulas de t√≠tulo da linha (as que acompanham o ITEM) tenham a mesma barra cont√≠nua */
        td.section-title {
            background: linear-gradient(135deg, #6c757d 0%, #495057 100%) !important;
            color: #fff !important;
            /* Remove a borda esquerda para unir visualmente com a coluna ITEM */
            border-left: none !important;
            position: relative; /* necess√°rio para o pseudo-elemento abaixo */
        }

        /* Cobre a jun√ß√£o entre ITEM e T√çTULO para n√£o aparecer faixa branca */
        table td.section-title::before {
            content: '';
            display: block !important; /* sobrep√µe o display:none de regras anteriores */
            position: absolute;
            left: -2px; /* mesma espessura da borda (2px) */
            top: -2px;
            bottom: -2px;
            width: 2px;
            background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
            z-index: 1;
        }

        /* Barra de a√ß√µes moderna (fixa no canto inferior direito) */
        .action-bar {
            position: fixed;
            right: 24px;
            bottom: 24px;
            display: flex;
            gap: 12px;
            z-index: 1200;
        }
        .action-btn {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            height: 48px;
            padding: 0 18px;
            border-radius: 9999px;
            border: none;
            cursor: pointer;
            color: #fff;
            font-weight: 600;
            letter-spacing: .2px;
            box-shadow: 0 8px 24px rgba(0,0,0,.15);
            transition: transform .15s ease, box-shadow .2s ease, filter .2s ease;
            backdrop-filter: saturate(120%);
        }
        .action-btn .icon { font-size: 1.1rem; display: inline-flex; }
        .action-btn:hover { transform: translateY(-2px); box-shadow: 0 14px 32px rgba(0,0,0,.18); filter: brightness(1.05); }
        .action-btn:active { transform: translateY(0); }

        /* Espec√≠ficos */
        .fab-btn { background: linear-gradient(90deg, #dc3545 0%, #b21f35 100%); }
        .dashboard-btn { background: linear-gradient(135deg, #6c757d 0%, #495057 100%); }
        .info-btn { background: linear-gradient(135deg, #17a2b8 0%, #138496 100%); }

        /* Estilos para campos de data modernos */
        .date-input-modern {
            transition: all 0.3s ease !important;
            outline: none !important;
        }

        .date-input-modern:focus {
            border-color: #007bff !important;
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.25) !important;
            transform: scale(1.05) !important;
        }

        .date-input-modern:hover {
            border-color: #495057 !important;
            transform: translateY(-1px) !important;
        }

        .date-input-modern:valid {
            border-color: #28a745 !important;
            background-color: #f8fff8 !important;
        }

        .date-input-modern:invalid {
            border-color: #dc3545 !important;
            background-color: #fff8f8 !important;
        }











        @media (max-width: 700px) {
            .container { padding: 8px 2px; max-width: 100vw; }
            .header { padding: 8px 8px; }
            .action-bar { right: 12px; bottom: 12px; gap: 10px; }
            .action-btn { height: 44px; padding: 0 14px; }
            .action-btn .label { display: none; } /* mostra s√≥ o √≠cone no mobile */
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header with Logo -->
        <div class="header">
            <div class="logos">
                <div class="logo-ippel">
                <img src="/LOGOIPPEL.JPEG" alt="IPPEL Logo"
                    style="width: 120px; height: 120px; border-radius: 15px; object-fit: contain; background: transparent; padding: 0; border: none;"
                    data-logo-primary="/LOGOIPPEL.JPEG"
                    data-logo-fallback1="/IPPELLOGO.jpg"
                    data-logo-fallback2="/LOGOSQI.jpg"
                    onerror="if(this.dataset.try1!=='1'){this.dataset.try1='1'; this.src=this.dataset.logoFallback1;} else if(this.dataset.try2!=='1'){this.dataset.try2='1'; this.src=this.dataset.logoFallback2;} else {this.style.display='none';}">
                    </div>
                </div>
            <div style="position: absolute; top: 20px; right: 30px; font-size: 12px; color: #6c757d; font-weight: 500; z-index: 10;"></div>
        </div>

        <!-- Title Section -->
        <div class="title-section">
            <div style="margin-bottom: 10px;">
                <div style="width: 60px; height: 2px; background: transparent !important; margin: 0 auto;"></div>
            </div>
            <div class="main-title">Relat√≥rio De N√£o Conformidades Internas ‚Äì RNC</div>
            <div class="subtitle">FABRICA√á√ÉO / RECEBIMENTO</div>
        </div>
        
        <!-- √Årea do Usu√°rio -->
        <div id="userArea" style="background: transparent !important; color: #333 !important; padding: 15px; border-radius: 10px; margin: 15px 0; border: 1px solid #ccc !important; display: none;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <span style="font-weight: 600; color: #495057;">üë§ Usu√°rio: </span>
                    <span id="userName">Carregando...</span>
                    <span style="margin-left: 15px; font-weight: 600; color: #495057;">üè¢ Departamento: </span>
                    <span id="userDepartment">Carregando...</span>
                </div>
                <div>
                    <button onclick="logout()" style="background: #dc3545; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-size: 0.9rem;">
                        üö™ Sair
                    </button>
                </div>
            </div>
            <div style="margin-top: 10px;">
                <span style="font-weight: 600; color: #495057;">üìä Meus RNCs: </span>
                <span id="userRNCs">Carregando...</span>
            </div>
        </div>
            <div style="margin-top: 15px;">
                <div style="width: 100px; height: 1px; background: transparent !important; margin: 0 auto;"></div>
        </div>

            <!-- Campos para integra√ß√£o com o sistema -->
            <div style="background: transparent !important; color: #333 !important; padding: 20px; border-radius: 10px; margin: 15px 0; border: 1px solid #ccc !important;">
                <h3 style="color: #8b1538; font-size: 1.1rem; margin-bottom: 20px; text-align: center; font-weight: 700;">üìã INFORMA√á√ïES PRINCIPAIS DO RNC</h3>
                
                <!-- Primeira linha de campos -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 20px;">
                    <div>
                        <label style="font-weight: 600; color: #8b1538; font-size: 0.95rem; display: block; margin-bottom: 8px;">üìã T√≠tulo do RNC *</label>
                        <input type="text" id="title" name="title" placeholder="Ex: Falha no equipamento de produ√ß√£o - Linha A" 
                               style="width: 100%; padding: 10px; border: 2px solid #8b1538; border-radius: 6px; margin-top: 5px; font-size: 14px;">
                        <small style="color: #6c757d; font-size: 0.8rem;">Descreva brevemente o problema identificado</small>
                    </div>
                    <div>
                        <label style="font-weight: 600; color: #8b1538; font-size: 0.95rem; display: block; margin-bottom: 8px;">üîß Equipamento/Sistema *</label>
                        <input type="text" id="equipment" name="equipment" placeholder="Ex: Linha de montagem A, M√°quina X, Sistema Y" 
                               style="width: 100%; padding: 10px; border: 2px solid #8b1538; border-radius: 6px; margin-top: 5px; font-size: 14px;">
                        <small style="color: #6c757d; font-size: 0.8rem;">Identifique o equipamento ou sistema afetado</small>
                    </div>
                    <div>
                        <label style="font-weight: 600; color: #8b1538; font-size: 0.95rem; display: block; margin-bottom: 8px;">üè¢ Cliente/Departamento *</label>
                        <select id="client" name="client" 
                                style="width: 100%; padding: 10px; border: 2px solid #8b1538; border-radius: 6px; margin-top: 5px; background: white; color: #333; font-size: 14px;">
                            <option value="" selected disabled>Selecione o cliente</option>
                        </select>
                        <small style="color: #6c757d; font-size: 0.8rem;">Departamento ou cliente respons√°vel</small>
                    </div>
                </div>

                <!-- Segunda linha de campos -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 20px;">
                    <div>
                        <label style="font-weight: 600; color: #8b1538; font-size: 0.95rem; display: block; margin-bottom: 8px;">üí≤ Custo Estimado (R$)</label>
                        <input type="number" id="price" name="price" step="0.01" min="0" placeholder="0,00"
                               style="width: 100%; padding: 10px; border: 2px solid #8b1538; border-radius: 6px; margin-top: 5px; font-size: 14px;">
                        <small style="color: #6c757d; font-size: 0.8rem;">Custo estimado para corre√ß√£o ou impacto financeiro</small>
                    </div>
                    <div>
                        <label style="font-weight: 600; color: #8b1538; font-size: 0.95rem; display: block; margin-bottom: 8px;">‚ö° N√≠vel de Urg√™ncia *</label>
                        <select id="priority" name="priority" 
                                style="width: 100%; padding: 10px; border: 2px solid #8b1538; border-radius: 6px; margin-top: 5px; font-size: 14px;">
                            <option value="Baixa">üü¢ Baixa - Pode aguardar at√© 30 dias</option>
                            <option value="M√©dia" selected>üü° M√©dia - Resolver em at√© 7 dias</option>
                            <option value="Alta">üü† Alta - Resolver em at√© 48 horas</option>
                            <option value="Cr√≠tica">üî¥ Cr√≠tica - Resolver imediatamente</option>
                        </select>
                        <small style="color: #6c757d; font-size: 0.8rem;">Impacto na opera√ß√£o e prazo para resolu√ß√£o</small>
                    </div>
                    <div>
                        <label style="font-weight: 600; color: #8b1538; font-size: 0.95rem; display: block; margin-bottom: 8px;">üìÖ Data de Detec√ß√£o</label>
                        <input type="date" id="detection_date" name="detection_date" 
                               style="width: 100%; padding: 10px; border: 2px solid #8b1538; border-radius: 6px; margin-top: 5px; font-size: 14px;">
                        <small style="color: #6c757d; font-size: 0.8rem;">Data em que o problema foi identificado</small>
                    </div>
                </div>

                <!-- Terceira linha de campos -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 20px;">
                    <div>
                        <label style="font-weight: 600; color: #8b1538; font-size: 0.95rem; display: block; margin-bottom: 8px;">üè≠ √Årea/Localiza√ß√£o</label>
                        <input type="text" id="location" name="location" placeholder="Ex: Setor de Produ√ß√£o, Galp√£o 3, Piso 2" 
                               style="width: 100%; padding: 10px; border: 2px solid #8b1538; border-radius: 6px; margin-top: 5px; font-size: 14px;">
                        <small style="color: #6c757d; font-size: 0.8rem;">Local f√≠sico onde o problema foi detectado</small>
                    </div>
                    <div>
                        <label style="font-weight: 600; color: #8b1538; font-size: 0.95rem; display: block; margin-bottom: 8px;">üë§ Respons√°vel pela Detec√ß√£o</label>
                        <input type="text" id="detected_by" name="detected_by" placeholder="Nome do funcion√°rio que detectou" 
                               style="width: 100%; padding: 10px; border: 2px solid #8b1538; border-radius: 6px; margin-top: 5px; font-size: 14px;">
                        <small style="color: #6c757d; font-size: 0.8rem;">Quem identificou o problema</small>
                    </div>
                    <div>
                        <label style="font-weight: 600; color: #8b1538; font-size: 0.95rem; display: block; margin-bottom: 8px;">üìû Contato de Emerg√™ncia</label>
                        <input type="tel" id="emergency_contact" name="emergency_contact" placeholder="(11) 99999-9999" 
                               style="width: 100%; padding: 10px; border: 2px solid #8b1538; border-radius: 6px; margin-top: 5px; font-size: 14px;">
                        <small style="color: #6c757d; font-size: 0.8rem;">Telefone para contato em caso de urg√™ncia</small>
                    </div>
                </div>

                <!-- Atribui√ß√£o e compartilhamento -->
                <div style="grid-column: 1 / -1; margin-top: 20px; display: grid; grid-template-columns: 1fr; gap: 20px;">
                    <!-- Atribuir a um usu√°rio (opcional) -->
                    <div class="section-card">
                        <div class="section-header section-header--bar">
                            <div class="section-title">üë§ Atribuir a um Usu√°rio</div>
                        </div>
                        <select id="assigned_user_single" name="assigned_user_single" class="fancy-select" style="min-height: 44px;">
                            <option value="">Carregando usu√°rios...</option>
                        </select>
                        <div class="help-hint">üí° Dica: ao selecionar grupos abaixo, a lista ser√° filtrada para mostrar apenas os usu√°rios desses grupos.</div>
                    </div>
                    <!-- Compartilhar com grupos -->
                    <div class="section-card">
                        <div class="section-header section-header--bar">
                            <div class="section-title">üë• Compartilhar com Grupos *</div>
                        </div>
                        <select id="share_groups" name="share_groups" multiple class="fancy-select" style="min-height: 120px;">
                            <option value="">Carregando grupos...</option>
                        </select>
                        <div class="help-hint">üí° <strong>Importante:</strong> Selecione os grupos que devem ter acesso a esta RNC. Eles receber√£o notifica√ß√µes e poder√£o acompanhar o progresso da resolu√ß√£o.</div>
                    </div>
                </div>

                <!-- Indicador de campos obrigat√≥rios -->
                <div style="text-align: center; margin-top: 20px; padding: 10px; background: rgba(139, 21, 56, 0.1); border-radius: 5px;">
                    <small style="color: #8b1538; font-weight: 600;">* Campos obrigat√≥rios para cria√ß√£o da RNC</small>
                </div>
            </div>
        </div>

        <!-- Form Code -->
        <div class="form-code">FQ ‚Äì 002</div>

        <!-- RNC Number -->
        <div class="rnc-number">
            <label style="font-weight: 600; color: #495057; margin-right: 10px;">RNC N¬∫.:</label>
            <input type="text" id="rnc_number" name="rnc_number" placeholder="Digite o n√∫mero do RNC" 
                   style="border: 2px solid #8b1538; border-radius: 5px; padding: 8px; width: 200px; font-weight: 600;">
        </div>

        <!-- Main Information Table -->
        <table>
            <tr>
                <td class="field-label" style="width: 40%;">DES.</td>
                <td class="field-label" style="width: 15%;">MP.</td>
                <td class="field-label" style="width: 15%;">REV.</td>
                <td class="field-label" style="width: 15%;">POS.</td>
                <td class="field-label" style="width: 15%;">CV.</td>
            </tr>
            <tr>
                <td><input type="text" id="des_field" class="input-field" placeholder="Descri√ß√£o"></td>
                <td><input type="text" class="input-field"></td>
                <td><input type="text" class="input-field"></td>
                <td><input type="text" class="input-field"></td>
                <td><input type="text" class="input-field"></td>
            </tr>
        </table>

        <table>
            <tr>
                <td class="field-label" style="width: 50%;">EQUIPAMENTO</td>
                <td class="field-label" style="width: 30%;">CONJUNTO</td>
                <td class="field-label" style="width: 20%;">MOD.</td>
            </tr>
            <tr>
                <td><input type="text" class="input-field"></td>
                <td><input type="text" class="input-field"></td>
                <td><input type="text" class="input-field"></td>
            </tr>
        </table>

        <table>
            <tr>
                <td class="field-label" style="width: 40%;">DESCRI√á√ÉO DES.</td>
                <td class="field-label" style="width: 20%;">QTDE LOTE</td>
                <td class="field-label" style="width: 20%;">CLIENTE</td>
                <td class="field-label" style="width: 20%;">MATERIAL</td>
            </tr>
            <tr>
                <td><input type="text" class="input-field"></td>
                <td><input type="text" class="input-field"></td>
                <td>
                    <select id="client_inline" class="input-field" style="background: white !important; color:#333 !important;">
                        <option value="" selected disabled>Selecione o cliente</option>
                    </select>
                </td>
                <td><input type="text" class="input-field"></td>
            </tr>
        </table>

        <table>
            <tr>
                <td class="field-label" style="width: 25%;">ASSINATURA GERENTE</td>
                <td class="field-label" style="width: 25%;">ASSINATURA L√çDER SETOR</td>
                <td class="field-label" style="width: 25%;">ORDEM DE COMPRA</td>
                <td class="field-label" style="width: 25%;">NOME RESP.</td>
            </tr>
            <tr>
                <td><input type="text" id="assinatura_gerente" class="input-field"></td>
                <td><input type="text" class="input-field"></td>
                <td><input type="text" class="input-field"></td>
                <td><input type="text" id="nome_responsavel" class="input-field"></td>
            </tr>
        </table>

        <table>
            <tr>
                <td class="field-label" style="width: 35%;">INSPETOR:</td>
                <td class="field-label" style="width: 20%;">DATA EMISS√ÉO</td>
                <td class="field-label" style="width: 30%;">√ÅREA RESPONS√ÅVEL</td>
                <td class="field-label" style="width: 15%;">ASS. RESP.</td>
            </tr>
            <tr>
                <td><input type="text" class="input-field"></td>
                <td><input type="text" id="data_emissao" class="input-field" placeholder="___/___/______" style="text-align: center;"></td>
                <td><input type="text" id="area_responsavel" class="input-field"></td>
                <td><input type="text" class="input-field"></td>
            </tr>
        </table>

        <!-- Description Section -->
        <table style="margin-bottom: 8px;">
            <tr>
                <td class="item-column">ITEM</td>
                <td class="section-title">DESCRI√á√ÉO DA N√ÉO CONFORMIDADE</td>
            </tr>
            <tr>
                <td style="width: 60px;"></td>
                <td><textarea id="description" name="description" class="input-field large-text-area" placeholder="Descreva a n√£o conformidade identificada..."></textarea></td>
            </tr>
        </table>

        <!-- Instruction Section -->
        <table style="margin-bottom: 8px;">
            <tr>
                <td class="item-column">ITEM</td>
                <td class="section-title">INSTRU√á√ÉO PARA RETRABALHO</td>
            </tr>
            <tr>
                <td style="width: 60px;"></td>
                <td><textarea class="input-field medium-text-area" placeholder="Instru√ß√µes detalhadas para corre√ß√£o..."></textarea></td>
            </tr>
        </table>

        <!-- Cause Section -->
        <table style="margin-bottom: 8px;">
            <tr>
                <td class="item-column">ITEM</td>
                <td class="section-title">CAUSA DA RNC</td>
            </tr>
            <tr>
                <td style="width: 60px;"></td>
                <td><textarea class="input-field medium-text-area" placeholder="An√°lise da causa raiz..."></textarea></td>
            </tr>
        </table>

        <!-- Action Section -->
        <table style="margin-bottom: 8px;">
            <tr>
                <td class="item-column">ITEM</td>
                <td class="section-title">A√á√ÉO A SER TOMADA</td>
            </tr>
            <tr>
                <td style="width: 60px;"></td>
                <td><textarea class="input-field medium-text-area" placeholder="A√ß√µes corretivas e preventivas..."></textarea></td>
            </tr>
        </table>

        <!-- Additional Information Section -->
        <table style="margin-bottom: 15px;">
            <tr>
                <td class="item-column">ITEM</td>
                <td class="section-title">INFORMA√á√ïES ADICIONAIS</td>
            </tr>
            <tr>
                <td style="width: 60px;"></td>
                <td><textarea class="input-field medium-text-area" placeholder="Observa√ß√µes adicionais, notas ou coment√°rios relevantes..."></textarea></td>
            </tr>
        </table>

        <!-- Header Banner -->
        <div style="width: 100%; background: transparent !important; color: #333 !important; text-align: center; padding: 12px 0; margin-bottom: 0; border-radius: 8px 8px 0 0; font-weight: bold; font-size: 14px; display: flex;">
            <div style="width: 50%; text-align: center; border-right: 2px solid white;">DISPOSI√á√ÉO DO MATERIAL N√ÉO-CONFORME</div>
            <div style="width: 50%; text-align: center;">INSPE√á√ÉO DO RETRABALHO</div>
        </div>

        <!-- Main Content Section -->
        <div style="border: 2px solid #dc3545; border-top: none; border-radius: 0 0 8px 8px; background: white; display: flex;">
            <!-- Left Section: Disposi√ß√£o do Material -->
            <div style="width: 50%; padding: 15px; border-right: 1px solid #dc3545;">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 11px; font-weight: bold;">
                    <div style="display: flex; align-items: center;">
                        <input type="checkbox" id="usar" style="margin-right: 8px; width: 16px; height: 16px; accent-color: #dc3545;">
                        <label for="usar">USAR COMO EST√Å</label>
                    </div>
                    <div style="display: flex; align-items: center;">
                        <input type="checkbox" id="sucata" style="margin-right: 8px; width: 16px; height: 16px; accent-color: #dc3545;">
                        <label for="sucata">SUCATA</label>
                    </div>
                    <div style="display: flex; align-items: center;">
                        <input type="checkbox" id="retrabalhar" style="margin-right: 8px; width: 16px; height: 16px; accent-color: #dc3545;">
                        <label for="retrabalhar">RETRABALHAR</label>
                    </div>
                    <div style="display: flex; align-items: center;">
                        <input type="checkbox" id="devolver-estoque" style="margin-right: 8px; width: 16px; height: 16px; accent-color: #dc3545;">
                        <label for="devolver-estoque">DEVOLVER AO ESTOQUE</label>
                    </div>
                    <div style="display: flex; align-items: center;">
                        <input type="checkbox" id="rejeitar" style="margin-right: 8px; width: 16px; height: 16px; accent-color: #dc3545;">
                        <label for="rejeitar">REJEITAR</label>
                    </div>
                    <div style="display: flex; align-items: center;">
                        <input type="checkbox" id="devolver-fornecedor" style="margin-right: 8px; width: 16px; height: 16px; accent-color: #dc3545;">
                        <label for="devolver-fornecedor">DEVOLVER AO FORNECEDOR</label>
                </div>
                </div>
            </div>

            <!-- Right Section: Inspe√ß√£o do Retrabalho -->
            <div style="width: 50%; padding: 15px;">
                <div style="font-size: 11px; font-weight: bold;">
                    <div style="display: flex; align-items: center; margin-bottom: 8px;">
                        <input type="checkbox" id="aprovado" style="margin-right: 8px; width: 16px; height: 16px; accent-color: #28a745;">
                        <label for="aprovado">APROVADO</label>
                    </div>
                    <div style="display: flex; align-items: center; margin-bottom: 8px;">
                        <input type="checkbox" id="reprovado" style="margin-right: 8px; width: 16px; height: 16px; accent-color: #dc3545;">
                        <label for="reprovado">REPROVADO</label>
                    </div>
                    <div style="display: flex; align-items: center;">
                        <input type="checkbox" id="ver-rnc" style="margin-right: 8px; width: 16px; height: 16px; accent-color: #ffc107;">
                        <label for="ver-rnc">VER RNC. N¬∫:</label>
                        <input type="text" style="border: none; border-bottom: 2px solid #6c757d; width: 120px; margin-left: 8px; font-size: 11px; padding: 2px; background: transparent;">
                    </div>
                </div>
                    </div>
                </div>

        <!-- Signature Section -->
        <div style="margin-top: 15px; border: 2px solid #8b1538; border-radius: 8px; background: white; box-shadow: 0 2px 8px rgba(139, 21, 56, 0.1);">
            <!-- Date Row -->
            <div style="display: flex; border-bottom: 2px solid #8b1538;">
                <div style="width: 33.33%; padding: 12px; text-align: center; font-size: 11px; font-weight: bold; border-right: 2px solid #8b1538; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);">
                    <span style="color: #495057; margin-bottom: 8px; display: block;">INSPE√á√ÉO:</span>
                    <div style="display: flex; justify-content: center; align-items: center; gap: 4px; margin-top: 8px;">
                        <input type="text" class="date-input-modern" style="width: 24px; height: 28px; text-align: center; font-size: 11px; font-weight: 600; border: 2px solid #6c757d; border-radius: 4px; background: white; color: #333; transition: all 0.3s ease;" placeholder="__" maxlength="2">
                        <span style="color: #6c757d; font-weight: bold;">/</span>
                        <input type="text" class="date-input-modern" style="width: 24px; height: 28px; text-align: center; font-size: 11px; font-weight: 600; border: 2px solid #6c757d; border-radius: 4px; background: white; color: #333; transition: all 0.3s ease;" placeholder="__" maxlength="2">
                        <span style="color: #6c757d; font-weight: bold;">/</span>
                        <input type="text" class="date-input-modern" style="width: 32px; height: 28px; text-align: center; font-size: 11px; font-weight: 600; border: 2px solid #6c757d; border-radius: 4px; background: white; color: #333; transition: all 0.3s ease;" placeholder="____" maxlength="4">
                    </div>
                </div>
                <div style="width: 33.33%; padding: 12px; text-align: center; font-size: 11px; font-weight: bold; border-right: 2px solid #8b1538; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);">
                    <span style="color: #495057; margin-bottom: 8px; display: block;">ENGENHARIA:</span>
                    <div style="display: flex; justify-content: center; align-items: center; gap: 4px; margin-top: 8px;">
                        <input type="text" class="date-input-modern" style="width: 24px; height: 28px; text-align: center; font-size: 11px; font-weight: 600; border: 2px solid #6c757d; border-radius: 4px; background: white; color: #333; transition: all 0.3s ease;" placeholder="__" maxlength="2">
                        <span style="color: #6c757d; font-weight: bold;">/</span>
                        <input type="text" class="date-input-modern" style="width: 24px; height: 28px; text-align: center; font-size: 11px; font-weight: 600; border: 2px solid #6c757d; border-radius: 4px; background: white; color: #333; transition: all 0.3s ease;" placeholder="__" maxlength="2">
                        <span style="color: #6c757d; font-weight: bold;">/</span>
                        <input type="text" class="date-input-modern" style="width: 32px; height: 28px; text-align: center; font-size: 11px; font-weight: 600; border: 2px solid #6c757d; border-radius: 4px; background: white; color: #333; transition: all 0.3s ease;" placeholder="____" maxlength="4">
                    </div>
                </div>
                <div style="width: 33.33%; padding: 12px; text-align: center; font-size: 11px; font-weight: bold; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);">
                    <span style="color: #495057; margin-bottom: 8px; display: block;">INSPE√á√ÉO:</span>
                    <div style="display: flex; justify-content: center; align-items: center; gap: 4px; margin-top: 8px;">
                        <input type="text" class="date-input-modern" style="width: 24px; height: 28px; text-align: center; font-size: 11px; font-weight: 600; border: 2px solid #6c757d; border-radius: 4px; background: white; color: #333; transition: all 0.3s ease;" placeholder="__" maxlength="2">
                        <span style="color: #6c757d; font-weight: bold;">/</span>
                        <input type="text" class="date-input-modern" style="width: 24px; height: 28px; text-align: center; font-size: 11px; font-weight: 600; border: 2px solid #6c757d; border-radius: 4px; background: white; color: #333; transition: all 0.3s ease;" placeholder="__" maxlength="2">
                        <span style="color: #6c757d; font-weight: bold;">/</span>
                        <input type="text" class="date-input-modern" style="width: 32px; height: 28px; text-align: center; font-size: 11px; font-weight: 600; border: 2px solid #6c757d; border-radius: 4px; background: white; color: #333; transition: all 0.3s ease;" placeholder="____" maxlength="4">
                    </div>
                </div>
            </div>

            <!-- Signature Row -->
            <div style="display: flex;">
                <div id="assinatura_coluna1" style="width: 33.33%; padding: 15px; text-align: center; font-size: 11px; font-weight: bold; border-right: 2px solid #ccc !important; background: transparent !important; color: #333 !important; cursor: pointer;" onclick="preencherAssinatura(this)">
                    <div id="nome_coluna1" style="margin-bottom: 25px;">NOME</div>
                    <div style="border-top: 1px solid #6c757d; padding-top: 8px;">VISTO</div>
                </div>
                <div id="assinatura_coluna2" style="width: 33.33%; padding: 15px; text-align: center; font-size: 11px; font-weight: bold; border-right: 2px solid #ccc !important; background: transparent !important; color: #333 !important; cursor: pointer;" onclick="preencherAssinatura(this)">
                    <div id="nome_coluna2" style="margin-bottom: 25px;">NOME</div>
                    <div style="border-top: 1px solid #6c757d; padding-top: 8px;">VISTO</div>
                </div>
                <div id="assinatura_coluna3" style="width: 33.33%; padding: 15px; text-align: center; font-size: 11px; font-weight: bold; background: transparent !important; color: #333 !important; cursor: pointer;" onclick="preencherAssinatura(this)">
                    <div id="nome_coluna3" style="margin-bottom: 25px;">NOME</div>
                    <div style="border-top: 1px solid #6c757d; padding-top: 8px;">VISTO</div>
                </div>
            </div>
        </div>
    </div>

    <script>
    // Conjunto de usu√°rios exclu√≠dos da lista de respons√°veis (assignee)
    let EXCLUDED_ASSIGNEE_IDS = new Set();
        // Auto-resize textareas
        document.querySelectorAll('textarea').forEach(textarea => {
            textarea.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = this.scrollHeight + 'px';
            });
        });

        // Configurar campos de data com valida√ß√£o e formata√ß√£o
        document.addEventListener('DOMContentLoaded', function() {
            const camposData = document.querySelectorAll('.date-input-modern');
            
            camposData.forEach(input => {
                // Event listener para formata√ß√£o autom√°tica
                input.addEventListener('input', function() {
                    formatarDataAutomatica(this);
                });
                
                // Event listener para valida√ß√£o ao perder foco
                input.addEventListener('blur', function() {
                    if (this.value.trim() !== '') {
                        aplicarValidacaoVisual(this);
                    }
                });
                
                // Event listener para tecla Enter (pr√≥ximo campo)
                input.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        const proximoCampo = this.parentNode.nextElementSibling?.querySelector('input') || 
                                           this.parentNode.parentNode.nextElementSibling?.querySelector('input');
                        if (proximoCampo) {
                            proximoCampo.focus();
                        }
                    }
                });
                
                // Event listener para tecla Tab (navega√ß√£o)
                input.addEventListener('keydown', function(e) {
                    if (e.key === 'Tab') {
                        // Permitir navega√ß√£o normal com Tab
                        return;
                    }
                });

                // Adicionar efeito de foco visual
                input.addEventListener('focus', function() {
                    this.style.transform = 'scale(1.05)';
                });

                input.addEventListener('blur', function() {
                    this.style.transform = 'scale(1)';
                });
            });
        });

        // Add current date to date fields when clicked
        document.querySelectorAll('.date-input').forEach(input => {
            input.addEventListener('focus', function() {
                if (!this.value) {
                    const now = new Date();
                    const day = now.getDate().toString().padStart(2, '0');
                    const month = (now.getMonth() + 1).toString().padStart(2, '0');
                    const year = now.getFullYear();
                    
                    if (this.placeholder === '___') {
                        // Check if it's day or month field based on position
                        const siblings = Array.from(this.parentNode.querySelectorAll('.date-input'));
                        const index = siblings.indexOf(this);
                        if (index === 0) {
                            this.value = day;
                        } else if (index === 1) {
                            this.value = month;
                        }
                    } else if (this.placeholder === '______') {
                        this.value = year;
                    }
                    }
                });
            });

        // Print functionality
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.key === 'p') {
                e.preventDefault();
                window.print();
            }
        });

        // Form validation
        function validateForm() {
            const requiredFields = document.querySelectorAll('input[required], textarea[required]');
            let isValid = true;
            
            requiredFields.forEach(field => {
                if (!field.value.trim()) {
                    field.style.borderColor = 'red';
                    isValid = false;
                        } else {
                    field.style.borderColor = '';
                }
            });
            
            return isValid;
        }

        // Save form data to localStorage
        function saveFormData() {
            const formData = {};
            document.querySelectorAll('input, textarea, select').forEach(field => {
                if (field.type === 'checkbox') {
                    formData[field.id] = field.checked;
                } else {
                    formData[field.name || field.id] = field.value;
                }
            });
            localStorage.setItem('rncFormData', JSON.stringify(formData));
        }

        // Load form data from localStorage
        function loadFormData() {
            const savedData = localStorage.getItem('rncFormData');
            if (savedData) {
                const formData = JSON.parse(savedData);
                Object.keys(formData).forEach(key => {
                    const field = document.getElementById(key) || document.querySelector(`[name="${key}"]`);
                    if (field) {
                        if (field.type === 'checkbox') {
                            field.checked = formData[key];
                        } else {
                            field.value = formData[key];
                        }
                    }
                });
            }
        }

        // Auto-save form data on input
        document.addEventListener('input', saveFormData);
        document.addEventListener('change', saveFormData);

        // Load saved data on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadFormData();
            loadUserInfo();
            loadClientsIntoSelects();
            // Marcar quando o campo "Respons√°vel pela Detec√ß√£o" for editado manualmente
            const detectedField = document.getElementById('detected_by');
            if (detectedField) {
                detectedField.addEventListener('input', () => {
                    detectedField.dataset.auto = '0'; // n√£o sobrescrever automaticamente ap√≥s edi√ß√£o manual
                });
            }
            // Tentar sugerir respons√°vel se j√° houver grupos selecionados carregados
            setTimeout(() => {
                try {
                    const preview = document.getElementById('group-users-preview');
                    if (preview) {
                        // Extrair nomes dos chips atuais
                        const users = Array.from(preview.querySelectorAll('.chip'))
                            .map(ch => ({ id: ch.getAttribute('data-user-id') || '', name: (ch.querySelector('span')?.textContent || '').trim() }));
                        if (users.length) maybeAutoDetectResponsavel(users);
                    }
                } catch(_) {}
            }, 700);
        });

        // Fun√ß√£o para carregar informa√ß√µes do usu√°rio
        async function loadUserInfo() {
            try {
                const response = await fetch('/api/user/info');
                const data = await response.json();
                
                if (data.success) {
                    // Mostrar √°rea do usu√°rio
                    document.getElementById('userArea').style.display = 'block';
                    
                    // Preencher informa√ß√µes
                    // Disponibilizar globalmente o usu√°rio atual para outras l√≥gicas (ex.: auto preencher respons√°vel)
                    try { window.CURRENT_USER = data.user; } catch(_) {}
                    document.getElementById('userName').textContent = data.user.name;
                    document.getElementById('userDepartment').textContent = data.user.department;
                    
                    // Preencher automaticamente os campos de assinatura
                    const assinaturaGerente = document.getElementById('assinatura_gerente');
                    const nomeResponsavel = document.getElementById('nome_responsavel');
                    
                    if (assinaturaGerente && !assinaturaGerente.value) {
                        assinaturaGerente.value = data.user.name;
                    }
                    
                    if (nomeResponsavel && !nomeResponsavel.value) {
                        nomeResponsavel.value = data.user.name;
                    }
                    
                    // Preencher data de emiss√£o automaticamente
                    const dataEmissao = document.getElementById('data_emissao');
                    if (dataEmissao && !dataEmissao.value) {
                        const hoje = new Date();
                        const dia = hoje.getDate().toString().padStart(2, '0');
                        const mes = (hoje.getMonth() + 1).toString().padStart(2, '0');
                        const ano = hoje.getFullYear();
                        dataEmissao.value = `${dia}/${mes}/${ano}`;
                    }
                    
                    // Preencher √°rea respons√°vel automaticamente
                    const areaResponsavel = document.getElementById('area_responsavel');
                    if (areaResponsavel && !areaResponsavel.value) {
                        areaResponsavel.value = data.user.department;
                    }
                    
                    // Carregar RNCs do usu√°rio
                    loadUserRNCs();
                } else {
                    // Se n√£o estiver logado, redirecionar para login
                    window.location.href = '/';
                }
            } catch (error) {
                console.error('Erro ao carregar informa√ß√µes do usu√°rio:', error);
                // Se n√£o conseguir conectar, redirecionar para login
                window.location.href = '/';
            }
        }

        // Fun√ß√£o para carregar RNCs do usu√°rio
        async function loadUserRNCs() {
            try {
                const response = await fetch('/api/rnc/list');
                const data = await response.json();
                
                if (data.success) {
                    const rncCount = data.rncs.length;
                    document.getElementById('userRNCs').textContent = `${rncCount} RNC(s) criado(s)`;
                } else {
                    document.getElementById('userRNCs').textContent = 'Erro ao carregar RNCs';
                }
            } catch (error) {
                console.error('Erro ao carregar RNCs:', error);
                document.getElementById('userRNCs').textContent = 'Erro ao carregar RNCs';
            }
        }

        // Fun√ß√£o para logout
        function logout() {
            fetch('/api/logout')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        window.location.href = '/';
                    }
                })
                .catch(error => {
                    console.error('Erro no logout:', error);
                    window.location.href = '/';
                });
        }

        // Carregar clientes e preencher selects (cliente principal e linha de tabela)
        async function loadClientsIntoSelects(){
            const sel1 = document.getElementById('client');
            const sel2 = document.getElementById('client_inline');
            const applyOptions = (list)=>{
                const opts = ['<option value="" disabled selected>Selecione o cliente</option>']
                    .concat(list.map(n=>`<option value="${n.replace(/"/g,'&quot;')}">${n}</option>`))
                    .join('');
                if(sel1) sel1.innerHTML = opts;
                if(sel2) sel2.innerHTML = opts;
            };

            // 1) Tenta via API autenticada
            try{
                const resp = await fetch('/api/clients', {credentials:'include'});
                if(resp.ok){
                    const data = await resp.json();
                    if(data && data.success && Array.isArray(data.clients)){
                        applyOptions(data.clients);
                        return;
                    }
                }
            }catch(_){ /* segue para fallback */ }

            // 2) Fallback: ler arquivo TXT local (sem depender de login)
            try{
                const txtPath = 'ARQUIVOS PARA PUXAR INFORMA√á√ïES PARA O PAINEL/clientescadastro.txt';
                const resp2 = await fetch(txtPath);
                if(resp2.ok){
                    const text = await resp2.text();
                    const lines = text.split(/\r?\n/).map(l=>l.trim()).filter(l=>l && l.toLowerCase()!=='cliente');
                    const seen = new Set();
                    const list = [];
                    for(const name of lines){ const k=name.toLowerCase(); if(!seen.has(k)){ seen.add(k); list.push(name);} }
                    if(list.length){ applyOptions(list); return; }
                }
            }catch(e){ console.warn('Fallback TXT falhou:', e); }

            // 3) Sem dados: mant√©m placeholder apenas
            applyOptions([]);
        }
    </script>

    <!-- Barra de a√ß√µes moderna -->
    <div class="action-bar">
        <button class="action-btn dashboard-btn" title="Voltar ao Dashboard" onclick="window.location.href='/dashboard'">
            <span class="icon">üè†</span>
            <span class="label">Dashboard</span>
        </button>
        <button class="action-btn fab-btn" title="Salvar RNC" onclick="saveRNCToSystem()">
            <span class="icon">üíæ</span>
            <span class="label">Salvar RNC</span>
        </button>
    </div>



    <script>


        // Fun√ß√£o para carregar grupos no select
        async function loadGroups() {
            try {
                const response = await fetch('/api/admin/groups');
                const data = await response.json();
                
                if (data.success) {
                    const select = document.getElementById('share_groups');
                    select.innerHTML = '<option value="">Selecione grupos para compartilhar...</option>';
                    
                    if (data.groups.length === 0) {
                        select.innerHTML = '<option value="">Nenhum grupo dispon√≠vel</option>';
                        return;
                    }
                    
                    data.groups.forEach(group => {
                        const option = document.createElement('option');
                        option.value = group.id;
                        option.textContent = `üìã ${group.name} (${group.user_count} usu√°rios)`;
                        option.title = `Grupo: ${group.name} - ${group.user_count} usu√°rios`;
                        select.appendChild(option);
                    });
                    
                                         // Adicionar evento para mostrar grupos selecionados
             select.addEventListener('change', function() {
                         const selectedOptions = Array.from(this.selectedOptions);
                         if (selectedOptions.length > 0) {
                             const selectedText = selectedOptions.map(opt => opt.textContent.replace('üìã ', '')).join(', ');
                             console.log(`Grupos selecionados: ${selectedText}`);
                             
                             // Mostrar preview dos grupos selecionados
                             showSelectedGroupsPreview(selectedOptions);
                 // Filtrar usu√°rios do respons√°vel conforme os grupos
                 updateAssigneeOptionsForGroups();
                         } else {
                             hideSelectedGroupsPreview();
                 // Sem grupos selecionados, volta para a lista completa de usu√°rios
                 loadUsers();
                         }
                     });
                    
                } else {
                    console.error('Erro na resposta:', data.message);
                    document.getElementById('share_groups').innerHTML = '<option value="">Erro ao carregar grupos</option>';
                }
            } catch (error) {
                console.error('Erro ao carregar grupos:', error);
                document.getElementById('share_groups').innerHTML = '<option value="">Erro ao carregar grupos</option>';
            }
        }
        
        
        // Carregar todos os usu√°rios para o select de atribui√ß√£o
        async function loadUsers() {
            try {
                const userSelect = document.getElementById('assigned_user_single');
                if (!userSelect) return;
                const resp = await fetch('/api/users/list', { credentials: 'include' });
                const data = await resp.json();
                if (!data.success) throw new Error(data.message || 'Falha ao listar usu√°rios');

                const users = (data.users || []).filter(u => !EXCLUDED_ASSIGNEE_IDS.has(String(u.id)));
                userSelect.innerHTML = '<option value="">‚Äî N√£o atribuir ‚Äî</option>' +
                    users.map(u => `<option value="${u.id}">üë§ ${u.name}${u.department ? ' (' + u.department + ')' : ''}</option>`).join('');
                userSelect.value = '';

                // Sem grupos selecionados, n√£o mostrar preview de usu√°rios
                clearGroupUsersPreview();
            } catch (err) {
                console.error('Erro ao carregar usu√°rios:', err);
                const userSelect = document.getElementById('assigned_user_single');
                if (userSelect) userSelect.innerHTML = '<option value="">Erro ao carregar usu√°rios</option>';
            }
        }

        // Atualiza usu√°rios com base nos grupos selecionados
        async function updateAssigneeOptionsForGroups() {
            const userSelect = document.getElementById('assigned_user_single');
            const groupsEl = document.getElementById('share_groups');
            if (!userSelect || !groupsEl) return;

            const selectedGroupIds = Array.from(groupsEl.selectedOptions).map(o => o.value).filter(v => v);
            if (selectedGroupIds.length === 0) { await loadUsers(); return; }

            try {
                const promises = selectedGroupIds.map(id => fetch(`/api/admin/groups/${id}/users`, { credentials: 'include' }).then(r => r.json()).catch(()=>({success:false, users:[]})));
                const results = await Promise.all(promises);
                const byId = new Map();
                for (const res of results) {
                    if (res && res.success && Array.isArray(res.users)) {
                        res.users.forEach(u => { if (!byId.has(u.id)) byId.set(u.id, u); });
                    }
                }
                const usersAll = Array.from(byId.values()).sort((a,b)=>a.name.localeCompare(b.name,'pt-BR'));
                const users = usersAll.filter(u => !EXCLUDED_ASSIGNEE_IDS.has(String(u.id)));
                userSelect.innerHTML = '<option value="">‚Äî N√£o atribuir ‚Äî</option>' +
                    users.map(u=>`<option value="${u.id}">üë§ ${u.name} ${u.department? '('+u.department+')':''}</option>`).join('');
                userSelect.value = '';

                // Renderiza preview de usu√°rios dos grupos selecionados
                renderGroupUsersPreview(usersAll);

                // Auto-preencher "Respons√°vel pela Detec√ß√£o" a partir dos grupos selecionados
                try { maybeAutoDetectResponsavel(usersAll); } catch(_) {}
            } catch (err) {
                console.error('Erro ao filtrar usu√°rios por grupos:', err);
            }
        }

        // Mostra/atualiza preview de usu√°rios dos grupos selecionados
        function renderGroupUsersPreview(users) {
            clearGroupUsersPreview();
            const container = document.createElement('div');
            container.id = 'group-users-preview';
            container.className = 'preview-card';
            const header = `<div class="preview-header">
                <span>üë§ Usu√°rios dos grupos selecionados (${users.length}):</span>
                <a href="#" id="clear-exclusions" style="font-size:0.85rem; color:#8b1538; text-decoration:underline; ${EXCLUDED_ASSIGNEE_IDS.size? '':'display:none;'}">Limpar exclus√µes</a>
            </div>`;
            const chips = users.length
                ? `<div class="chips">` + users.map(u => {
                    const excluded = EXCLUDED_ASSIGNEE_IDS.has(String(u.id));
                    let chipClass = excluded ? 'chip chip--danger' : 'chip';
                    if (!excluded && String(u.id) === String(window.JUST_RESTORED_USER_ID || '')) {
                        chipClass = 'chip chip--restored';
                    }
                    return `<span class="${chipClass}" data-user-id="${u.id}">
                        <span>${u.name}${u.department? ' ‚Ä¢ '+u.department:''}</span>
                        <button type="button" class="chip-remove" data-user-id="${u.id}" aria-label="Remover" title="Remover">√ó</button>
                    </span>`;
                }).join('') + `</div>`
                : '<em style="color:#6c757d;">Nenhum usu√°rio encontrado nos grupos selecionados.</em>';
            container.innerHTML = header + chips;

            const select = document.getElementById('share_groups');
            if (select && select.parentNode) {
                // Insere ap√≥s o select (ou substitui se j√° existir)
                select.parentNode.insertBefore(container, select.nextSibling);
            }

            const clearLink = container.querySelector('#clear-exclusions');
            if (clearLink) {
                clearLink.addEventListener('click', function(e){
                    e.preventDefault();
                    // anima todos os chips e depois limpa
                    const allChips = container.querySelectorAll('.chip');
                    allChips.forEach(ch => ch.classList.add('chip--removing'));
                    const count = allChips.length;
                    setTimeout(() => {
                        EXCLUDED_ASSIGNEE_IDS.clear();
                        updateAssigneeOptionsForGroups();
                        if (count > 0) {
                            try { mostrarNotificacao(`üë• Exclus√µes limpas (${count} usu√°rios).`, 'info'); } catch(_) {}
                        }
                    }, 260);
                });
            }
            // Delega√ß√£o: remover usu√°rio (X) ou restaurar ao clicar no chip marcado
            container.addEventListener('click', function(e){
                const btn = e.target.closest('.chip-remove');
                if (btn && btn.dataset.userId) {
                    // anima√ß√£o e notifica√ß√£o de remo√ß√£o
                    const chip = btn.closest('.chip');
                    let label = '';
                    if (chip) {
                        chip.classList.add('chip--removing');
                        const span = chip.querySelector('span');
                        if (span && span.textContent) label = span.textContent.trim();
                    }
                    setTimeout(() => {
                        excludeAssignee(btn.dataset.userId);
                        if (label) {
                            try { mostrarNotificacao(`üë§ Removido: ${label}`, 'success'); } catch(_) {}
                        }
                    }, 260);
                    return;
                }
                // Restaurar ao clicar no chip que esteja marcado (chip--danger)
                const chip = e.target.closest('.chip');
                if (chip && chip.classList.contains('chip--danger')) {
                    const uid = chip.getAttribute('data-user-id');
                    const span = chip.querySelector('span');
                    const label = span && span.textContent ? span.textContent.trim() : '';
                    // marca para re-render destacar
                    window.JUST_RESTORED_USER_ID = String(uid);
                    // leve efeito antes de atualizar
                    chip.classList.remove('chip--danger');
                    chip.classList.add('chip--restored');
                    setTimeout(() => {
                        includeAssignee(uid);
                        if (label) {
                            try { mostrarNotificacao(`‚Ü©Ô∏è Restaurado: ${label}`, 'info'); } catch(_) {}
                        }
                        // limpar flag ap√≥s 1s para n√£o manter destaque
                        setTimeout(() => { window.JUST_RESTORED_USER_ID = null; }, 1000);
                    }, 220);
                }
            });
        }

        function clearGroupUsersPreview() {
            const existing = document.getElementById('group-users-preview');
            if (existing && existing.parentNode) existing.parentNode.removeChild(existing);
        }

        // Exclui um usu√°rio espec√≠fico da lista de poss√≠veis respons√°veis (assignee)
        function excludeAssignee(userId) {
            if (!userId) return;
            EXCLUDED_ASSIGNEE_IDS.add(String(userId));
            updateAssigneeOptionsForGroups();
        }

        // Inclui novamente um usu√°rio previamente exclu√≠do
        function includeAssignee(userId) {
            if (!userId) return;
            EXCLUDED_ASSIGNEE_IDS.delete(String(userId));
            updateAssigneeOptionsForGroups();
        }

        // Tenta definir automaticamente o "Respons√°vel pela Detec√ß√£o" com base nos usu√°rios dos grupos selecionados.
        // Regras:
        // 1) Se o usu√°rio atual fizer parte da lista, preferi-lo.
        // 2) Caso contr√°rio, escolher o primeiro da lista (ordenada por nome).
        // 3) N√£o sobrescrever se o campo j√° foi editado manualmente (dataset.auto === '0')
        function maybeAutoDetectResponsavel(usersFromGroups) {
            const field = document.getElementById('detected_by');
            if (!field) return;

            // Se o usu√°rio marcou que editou manualmente, n√£o mexer
            if (field.dataset && field.dataset.auto === '0') return;

            // Se j√° h√° valor manual (n√£o vazio) e n√£o foi marcado como auto, manter
            if (field.value && (!field.dataset || field.dataset.auto !== '1')) return;

            const list = Array.isArray(usersFromGroups) ? usersFromGroups : [];
            if (list.length === 0) return;

            let chosenName = '';
            const current = (typeof window !== 'undefined' && window.CURRENT_USER) ? window.CURRENT_USER : null;
            if (current) {
                const found = list.find(u => String(u.id) === String(current.id) || (u.email && current.email && u.email.toLowerCase() === current.email.toLowerCase()) || (u.name && current.name && u.name.trim() === current.name.trim()));
                if (found) chosenName = found.name || current.name || '';
            }
            if (!chosenName) {
                chosenName = list[0]?.name || '';
            }
            if (chosenName) {
                field.value = chosenName;
                if (field.dataset) field.dataset.auto = '1';
                try { mostrarNotificacao(`üë§ Respons√°vel sugerido: ${chosenName}`, 'info'); } catch(_) {}
            }
        }

        // Fun√ß√£o para salvar RNC no sistema
        function saveRNCToSystem() {
            // Vers√£o simplificada para resolver problemas
            
            // Coletar grupos selecionados para compartilhamento
            const shareGroupsSelect = document.getElementById('share_groups');
            const selectedGroupIds = Array.from(shareGroupsSelect.selectedOptions)
                .map(option => option.value)
                .filter(value => value !== '');
            
            // Coletar dados essenciais
            const formData = {
                title: document.getElementById('title').value,
                description: document.getElementById('description').value,
                equipment: document.getElementById('equipment')?.value || '',
                client: document.getElementById('client')?.value || '',
                priority: document.getElementById('priority')?.value || 'M√©dia',
                shared_group_ids: selectedGroupIds
            };
            
            // Valida√ß√£o b√°sica
            if (!formData.title || !formData.description) {
                alert('Por favor, preencha pelo menos o t√≠tulo e a descri√ß√£o.');
                return;
            }
            
            // Validar grupos compartilhados
            if (formData.shared_group_ids.length === 0) {
                alert('Por favor, selecione pelo menos um grupo para compartilhar o RNC.');
                return;
            }
            
            // Log para depura√ß√£o
            console.log('Enviando dados:', formData);
            
            // Mostrar loading
            const saveBtn = document.querySelector('.fab-btn');
            const originalContent = saveBtn.innerHTML;
            saveBtn.disabled = true;
            saveBtn.innerHTML = '‚è≥ Salvando...';
            
            // Enviar para API
            const base = window.location.origin.replace(/^https:/, 'http:');
            fetch(base + '/api/rnc/create', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(formData)
            })
            .then(response => {
                console.log('Status da resposta:', response.status);
                return response.json();
            })
            .then(data => {
                console.log('Resposta completa:', data);
                if (data.success) {
                    alert('RNC criada com sucesso!');
                    window.location.href = '/dashboard';
                } else {
                    console.error('Erro detalhado:', data);
                    alert('Erro ao salvar RNC: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Erro na requisi√ß√£o:', error);
                alert('Erro ao conectar ao servidor.');
            })
            .finally(() => {
                // Restaurar bot√£o
                saveBtn.disabled = false;
                saveBtn.innerHTML = originalContent;
            });
        }

        // Fun√ß√£o para mostrar confirma√ß√£o de salvamento
        function showSaveConfirmation(data) {
            const confirmation = document.createElement('div');
            confirmation.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
                color: white;
                padding: 15px 20px;
                border-radius: 10px;
                box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
                z-index: 3000;
                animation: slideInRight 0.3s ease-out;
                max-width: 350px;
            `;
            
            // Obter informa√ß√µes sobre grupos compartilhados
            const selectedGroups = Array.from(document.getElementById('share_groups').selectedOptions)
                .map(option => option.textContent.replace('üìã ', ''))
                .join(', ');
            
            confirmation.innerHTML = `
                <div style="font-weight: 600; margin-bottom: 5px;">‚úÖ RNC Salvo!</div>
                <div style="font-size: 0.9rem;">N√∫mero: ${data.rnc_number}</div>
                <div style="font-size: 0.8rem; margin-top: 5px; opacity: 0.9;">
                    üë• Compartilhado com: ${selectedGroups || 'Nenhum grupo'}
                </div>
                <div style="font-size: 0.8rem; margin-top: 5px; opacity: 0.9;">
                    Redirecionando para o dashboard...
                </div>
            `;
            
            document.body.appendChild(confirmation);
            
            // Remover ap√≥s 5 segundos
            setTimeout(() => {
                confirmation.style.animation = 'slideOutRight 0.3s ease-in';
                setTimeout(() => {
                    document.body.removeChild(confirmation);
                }, 300);
            }, 5000);
        }

        // Fun√ß√£o para mostrar preview dos grupos selecionados
        function showSelectedGroupsPreview(selectedOptions) {
            // Remover preview anterior se existir
            hideSelectedGroupsPreview();
            
            const preview = document.createElement('div');
            preview.id = 'groups-preview';
            preview.className = 'preview-card';
            const groupsList = selectedOptions.map(opt => {
                const groupName = opt.textContent.replace('üìã ', '');
                const groupId = opt.value;
                return `<span class="chip chip--muted">
                    <span>${groupName}</span>
                    <button type="button" class="chip-remove-group" data-group-id="${groupId}" aria-label="Remover grupo" title="Remover grupo">√ó</button>
                </span>`;
            }).join('');
            
            preview.innerHTML = `
                <div class="preview-header">üë• Grupos selecionados:</div>
                <div class="chips">${groupsList}</div>
            `;
            
            // Inserir ap√≥s o select
            const select = document.getElementById('share_groups');
            select.parentNode.insertBefore(preview, select.nextSibling);

            // Delega√ß√£o: remover grupo (X)
            preview.addEventListener('click', function(e){
                const btn = e.target.closest('.chip-remove-group');
                if (btn && btn.dataset.groupId) {
                    const chip = btn.closest('.chip');
                    if (chip) {
                        chip.classList.add('chip--danger');
                        chip.style.opacity = '0.85';
                    }
                    setTimeout(() => deselectGroup(btn.dataset.groupId), 120);
                }
            });
        }
        
        // Fun√ß√£o para esconder preview dos grupos
        function hideSelectedGroupsPreview() {
            const existingPreview = document.getElementById('groups-preview');
            if (existingPreview) {
                existingPreview.remove();
            }
        }

        // Desmarca um grupo a partir do chip (preview)
        function deselectGroup(groupId) {
            const select = document.getElementById('share_groups');
            if (!select) return;
            const opt = Array.from(select.options).find(o => o.value === String(groupId));
            if (opt) {
                opt.selected = false;
                // Dispara o change para atualizar previews e listas
                const event = new Event('change', { bubbles: true });
                select.dispatchEvent(event);
            }
        }

        // Fun√ß√£o para limpar formul√°rio
        function clearForm() {
            document.querySelectorAll('input, textarea, select').forEach(field => {
                if (field.type === 'checkbox') {
                    field.checked = false;
                } else {
                    field.value = '';
                }
            });
            
            // Esconder previews
            hideSelectedGroupsPreview();
            clearGroupUsersPreview();
        }

        // Fun√ß√£o para carregar informa√ß√µes do usu√°rio
        async function loadUserInfo() {
            try {
                const response = await fetch('/api/user/info');
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('userName').textContent = data.user.name;
                    document.getElementById('userDepartment').textContent = data.user.department;
                    document.getElementById('userArea').style.display = 'block';
                    
                    // Carregar RNCs do usu√°rio
                    loadUserRNCs();
                } else {
                    // Redirecionar para login se n√£o autenticado
                    window.location.href = '/';
                }
            } catch (error) {
                console.error('Erro ao carregar informa√ß√µes do usu√°rio:', error);
                window.location.href = '/';
            }
        }

        // Fun√ß√£o para carregar RNCs do usu√°rio
        async function loadUserRNCs() {
            try {
                const response = await fetch('/api/rnc/list');
                const data = await response.json();
                
                if (data.success) {
                    const rncCount = data.rncs.length;
                    const pendingCount = data.rncs.filter(rnc => rnc.status === 'Pendente').length;
                    const completedCount = data.rncs.filter(rnc => rnc.status === 'Conclu√≠do').length;
                    
                    document.getElementById('userRNCs').innerHTML = `
                        <span style="color: #28a745;">‚úÖ ${completedCount} conclu√≠dos</span> | 
                        <span style="color: #ffc107;">‚è≥ ${pendingCount} pendentes</span> | 
                        <span style="color: #6c757d;">üìä ${rncCount} total</span>
                    `;
                } else {
                    document.getElementById('userRNCs').textContent = 'Erro ao carregar';
                }
            } catch (error) {
                console.error('Erro ao carregar RNCs:', error);
                document.getElementById('userRNCs').textContent = 'Erro de conex√£o';
            }
        }

        // Fun√ß√£o para logout
        async function logout() {
            try {
                const response = await fetch('/api/logout');
                const data = await response.json();
                
                if (data.success) {
                    window.location.href = '/';
                }
            } catch (error) {
                console.error('Erro no logout:', error);
                window.location.href = '/';
            }
        }

        // Carregar informa√ß√µes do usu√°rio quando a p√°gina carregar
        document.addEventListener('DOMContentLoaded', function() {
            loadUserInfo();
            loadGroups(); // Carregar lista de grupos
            loadUsers();  // Carregar lista de usu√°rios (assignee)
            
            // Configurar campo RNC Number
            const rncNumberInput = document.getElementById('rnc_number');
            if (rncNumberInput) {
                // Gerar n√∫mero autom√°tico se estiver vazio
                if (!rncNumberInput.value) {
                    rncNumberInput.value = generateRNCNumber();
                }
                
                // Permitir edi√ß√£o manual
                rncNumberInput.addEventListener('focus', function() {
                    if (this.value === generateRNCNumber()) {
                        this.select();
                    }
                });
                
                // Gerar novo n√∫mero se clicar em "Gerar"
                rncNumberInput.addEventListener('dblclick', function() {
                    this.value = generateRNCNumber();
                });
            }
        });

        // Gerar n√∫mero do RNC automaticamente
        function generateRNCNumber() {
            const year = new Date().getFullYear();
            const randomNum = Math.floor(Math.random() * 1000).toString().padStart(4, '0');
            return `RNC${year}-${randomNum}`;
        }

        // Fun√ß√£o para preencher assinatura automaticamente (com toggle do pr√≥prio usu√°rio)
        function preencherAssinatura(elemento) {
            const nomeElement = elemento.querySelector('div[id^="nome_coluna"]');
            
            fetch('/api/user/info')
                .then(response => response.json())
                .then(data => {
                    if (!data.success) {
                        mostrarNotificacao('‚ùå Erro: Usu√°rio n√£o autenticado', 'error');
                        return;
                    }
                    const nomeUsuario = data.user.name;
                    const departamento = data.user.department;
                    const assinaturaAtual = (nomeElement?.textContent || '').trim();

                    if (assinaturaAtual && assinaturaAtual !== 'NOME') {
                        // Se a assinatura for do pr√≥prio usu√°rio, permitir remover
                        if (assinaturaAtual.startsWith(nomeUsuario)) {
                            nomeElement.textContent = 'NOME';
                            // Limpar tamb√©m as datas quando remover a assinatura
                            limparDatasAssinatura(elemento);
                            mostrarNotificacao('‚Ü©Ô∏è Assinatura removida (do pr√≥prio usu√°rio).');
                        } else {
                            mostrarNotificacao('‚ùå Assinatura j√° preenchida por outro usu√°rio.', 'error');
                        }
                        return;
                    }

                    if (nomeElement) {
                        nomeElement.textContent = `${nomeUsuario} (${departamento})`;
                        // Preencher automaticamente as datas da assinatura
                        preencherDatasAssinatura(elemento);
                        elemento.style.transform = 'scale(1.02)';
                        elemento.style.transition = 'transform 0.2s ease';
                        setTimeout(() => { elemento.style.transform = 'scale(1)'; }, 200);
                        mostrarNotificacao('‚úÖ Assinatura e data preenchidas automaticamente!');
                    }
                })
                .catch(error => {
                    console.error('Erro ao buscar informa√ß√µes do usu√°rio:', error);
                    mostrarNotificacao('‚ùå Erro ao preencher assinatura', 'error');
                });
        }

        // Fun√ß√£o para preencher automaticamente as datas da assinatura
        function preencherDatasAssinatura(elemento) {
            const now = new Date();
            const day = now.getDate().toString().padStart(2, '0');
            const month = (now.getMonth() + 1).toString().padStart(2, '0');
            const year = now.getFullYear();
            
            // Identificar qual coluna de assinatura foi clicada
            const colunaId = elemento.id;
            let dataInputs = [];
            
            if (colunaId === 'assinatura_coluna1') {
                // Primeira coluna - INSPE√á√ÉO (primeira div)
                const primeiraDiv = document.querySelector('div[style*="width: 33.33%"][style*="border-right: 2px solid #8b1538"]');
                if (primeiraDiv) {
                    dataInputs = primeiraDiv.querySelectorAll('.date-input-modern');
                }
            } else if (colunaId === 'assinatura_coluna2') {
                // Segunda coluna - ENGENHARIA (segunda div)
                const segundaDiv = document.querySelectorAll('div[style*="width: 33.33%"][style*="border-right: 2px solid #8b1538"]')[1];
                if (segundaDiv) {
                    dataInputs = segundaDiv.querySelectorAll('.date-input-modern');
                }
            } else if (colunaId === 'assinatura_coluna3') {
                // Terceira coluna - INSPE√á√ÉO 2 (terceira div)
                const terceiraDiv = document.querySelectorAll('div[style*="width: 33.33%"]:not([style*="border-right"])');
                if (terceiraDiv.length > 0) {
                    dataInputs = terceiraDiv[0].querySelectorAll('.date-input-modern');
                }
            }
            
            // Preencher as datas se encontrou os campos
            if (dataInputs.length >= 3) {
                dataInputs[0].value = day;      // Dia
                dataInputs[1].value = month;    // M√™s
                dataInputs[2].value = year;     // Ano
                
                // Marcar os campos como preenchidos e desabilitar edi√ß√£o
                dataInputs.forEach(input => {
                    input.style.backgroundColor = '#f8f9fa';
                    input.style.color = '#495057';
                    input.readOnly = true;
                    input.style.borderBottom = '2px solid #28a745'; // Borda verde para indicar preenchido
                    input.setAttribute('data-original-date', input.value);
                    input.setAttribute('data-locked', 'true');
                });
                
                // Adicionar tooltip informativo
                const tooltip = document.createElement('div');
                tooltip.className = 'date-tooltip';
                tooltip.textContent = `Data preenchida: ${day}/${month}/${year}`;
                tooltip.style.cssText = `
                    position: absolute;
                    background: #28a745;
                    color: white;
                    padding: 5px 10px;
                    border-radius: 5px;
                    font-size: 12px;
                    z-index: 1000;
                    pointer-events: none;
                    opacity: 0;
                    transition: opacity 0.3s;
                `;
                document.body.appendChild(tooltip);
                
                // Mostrar tooltip temporariamente
                setTimeout(() => {
                    tooltip.style.opacity = '1';
                    setTimeout(() => {
                        tooltip.style.opacity = '0';
                        setTimeout(() => {
                            if (document.body.contains(tooltip)) {
                                document.body.removeChild(tooltip);
                            }
                        }, 300);
                    }, 2000);
                }, 100);
                
                console.log(`Datas preenchidas para ${colunaId}: ${day}/${month}/${year}`);
            } else {
                console.log(`N√£o foi poss√≠vel encontrar os campos de data para ${colunaId}`);
            }
        }

        // Fun√ß√£o para limpar as datas da assinatura
        function limparDatasAssinatura(elemento) {
            const colunaId = elemento.id;
            let dataInputs = [];
            
            if (colunaId === 'assinatura_coluna1') {
                // Primeira coluna - INSPE√á√ÉO (primeira div)
                const primeiraDiv = document.querySelector('div[style*="width: 33.33%"][style*="border-right: 2px solid #8b1538"]');
                if (primeiraDiv) {
                    dataInputs = primeiraDiv.querySelectorAll('.date-input-modern');
                }
            } else if (colunaId === 'assinatura_coluna2') {
                // Segunda coluna - ENGENHARIA (segunda div)
                const segundaDiv = document.querySelectorAll('div[style*="width: 33.33%"][style*="border-right: 2px solid #8b1538"]')[1];
                if (segundaDiv) {
                    dataInputs = segundaDiv.querySelectorAll('.date-input-modern');
                }
            } else if (colunaId === 'assinatura_coluna3') {
                // Terceira coluna - INSPE√á√ÉO 2 (terceira div)
                const terceiraDiv = document.querySelectorAll('div[style*="width: 33.33%"]:not([style*="border-right"])');
                if (terceiraDiv.length > 0) {
                    dataInputs = terceiraDiv[0].querySelectorAll('.date-input-modern');
                }
            }
            
            // Limpar e reabilitar os campos
            dataInputs.forEach(input => {
                input.value = '';
                input.style.backgroundColor = 'white';
                input.style.color = '#333';
                input.readOnly = false;
                input.style.borderBottom = '1px solid #000'; // Restaurar borda original
                input.removeAttribute('data-original-date');
                input.removeAttribute('data-locked');
            });
            
            console.log(`Datas limpas para ${colunaId}`);
        }

        // Fun√ß√£o para validar data
        function validarData(dia, mes, ano) {
            // Validar ano (entre 2000 e 2100)
            if (ano < 2000 || ano > 2100) {
                return { valido: false, erro: 'Ano deve estar entre 2000 e 2100' };
            }
            
            // Validar m√™s (1-12)
            if (mes < 1 || mes > 12) {
                return { valido: false, erro: 'M√™s deve estar entre 1 e 12' };
            }
            
            // Validar dia baseado no m√™s
            const diasNoMes = new Date(ano, mes, 0).getDate();
            if (dia < 1 || dia > diasNoMes) {
                return { valido: false, erro: `Dia deve estar entre 1 e ${diasNoMes} para o m√™s ${mes}` };
            }
            
            // Verificar se n√£o √© data futura
            const dataDigitada = new Date(ano, mes - 1, dia);
            const hoje = new Date();
            if (dataDigitada > hoje) {
                return { valido: false, erro: 'Data n√£o pode ser futura' };
            }
            
            return { valido: true };
        }

        // Fun√ß√£o para formatar data automaticamente
        function formatarDataAutomatica(input) {
            const valor = input.value.replace(/\D/g, ''); // Remove caracteres n√£o num√©ricos
            const placeholder = input.placeholder;
            
            if (placeholder === '__') {
                // Campo de dia ou m√™s
                if (valor.length > 2) {
                    input.value = valor.substring(0, 2);
                }
                
                // Valida√ß√£o espec√≠fica para dia/m√™s
                const numero = parseInt(valor);
                if (numero > 31) {
                    input.value = '31';
                }
            } else if (placeholder === '____') {
                // Campo de ano
                if (valor.length > 4) {
                    input.value = valor.substring(0, 4);
                }
            }
            
            // Aplicar valida√ß√£o visual
            aplicarValidacaoVisual(input);
        }

        // Fun√ß√£o para aplicar valida√ß√£o visual
        function aplicarValidacaoVisual(input) {
            const valor = input.value.trim();
            
            if (valor === '') {
                input.style.borderBottom = '1px solid #000';
                input.style.backgroundColor = 'white';
                return;
            }
            
            // Verificar se √© um campo de data v√°lido
            const numero = parseInt(valor);
            const placeholder = input.placeholder;
            
            if (placeholder === '__') {
                if (numero >= 1 && numero <= 31) {
                    input.style.borderBottom = '2px solid #28a745'; // Verde
                    input.style.backgroundColor = '#f8fff8';
                } else {
                    input.style.borderBottom = '2px solid #dc3545'; // Vermelho
                    input.style.backgroundColor = '#fff8f8';
                }
            } else if (placeholder === '____') {
                if (numero >= 2000 && numero <= 2100) {
                    input.style.borderBottom = '2px solid #28a745'; // Verde
                    input.style.backgroundColor = '#f8fff8';
                } else {
                    input.style.borderBottom = '2px solid #dc3545'; // Vermelho
                    input.style.backgroundColor = '#fff8f8';
                }
            }
        }

        // Fun√ß√£o para verificar se todas as datas est√£o preenchidas
        function verificarDatasCompletas() {
            const todasDatas = document.querySelectorAll('.date-input-modern');
            let datasPreenchidas = 0;
            let datasValidas = 0;
            
            todasDatas.forEach(input => {
                if (input.value.trim() !== '') {
                    datasPreenchidas++;
                    if (input.style.borderColor === '#28a745' || input.style.borderColor === 'rgb(40, 167, 69)') {
                        datasValidas++;
                    }
                }
            });
            
            return {
                preenchidas: datasPreenchidas,
                validas: datasValidas,
                total: todasDatas.length
            };
        }

        // Fun√ß√£o para mostrar status das datas
        function mostrarStatusDatas() {
            const status = verificarDatasCompletas();
            const mensagem = `üìÖ Status das Datas: ${status.preenchidas}/${status.total} preenchidas (${status.validas} v√°lidas)`;
            
            if (status.preenchidas === status.total && status.validas === status.total) {
                mostrarNotificacao(`‚úÖ ${mensagem} - Todas as datas est√£o v√°lidas!`, 'success');
            } else if (status.preenchidas > 0) {
                mostrarNotificacao(`‚ö†Ô∏è ${mensagem} - Verifique as datas inv√°lidas.`, 'warning');
            } else {
                mostrarNotificacao(`‚ÑπÔ∏è ${mensagem} - Preencha as datas das assinaturas.`, 'info');
            }
        }

        // Fun√ß√£o para validar data completa (dia/m√™s/ano)
        function validarDataCompleta(diaInput, mesInput, anoInput) {
            const dia = parseInt(diaInput.value) || 0;
            const mes = parseInt(mesInput.value) || 0;
            const ano = parseInt(anoInput.value) || 0;
            
            if (dia === 0 || mes === 0 || ano === 0) {
                return { valido: false, erro: 'Todos os campos de data devem ser preenchidos' };
            }
            
            const validacao = validarData(dia, mes, ano);
            if (!validacao.valido) {
                return validacao;
            }
            
            // Verificar se √© uma data real (ex: 31/02 n√£o existe)
            const dataTeste = new Date(ano, mes - 1, dia);
            if (dataTeste.getDate() !== dia || dataTeste.getMonth() !== mes - 1 || dataTeste.getFullYear() !== ano) {
                return { valido: false, erro: 'Data inv√°lida (ex: 31/02 n√£o existe)' };
            }
            
            return { valido: true };
        }

        // Fun√ß√£o para aplicar valida√ß√£o visual em grupo de datas
        function aplicarValidacaoVisualGrupo(diaInput, mesInput, anoInput) {
            const validacao = validarDataCompleta(diaInput, mesInput, anoInput);
            
            if (validacao.valido) {
                [diaInput, mesInput, anoInput].forEach(input => {
                    input.style.borderBottom = '2px solid #28a745';
                    input.style.backgroundColor = '#f8fff8';
                });
            } else {
                [diaInput, mesInput, anoInput].forEach(input => {
                    input.style.borderBottom = '2px solid #dc3545';
                    input.style.backgroundColor = '#fff8f8';
                });
                
                // Mostrar erro espec√≠fico
                mostrarNotificacao(`‚ùå ${validacao.erro}`, 'error');
            }
        }

        // Fun√ß√£o para mostrar notifica√ß√µes
        function mostrarNotificacao(mensagem, tipo = 'success') {
            const notificacao = document.createElement('div');
            
            let background, shadow, icon;
            if (tipo === 'error') {
                background = 'linear-gradient(135deg, #dc3545 0%, #c82333 100%)';
                shadow = 'rgba(220, 53, 69, 0.3)';
                icon = '‚ùå';
            } else if (tipo === 'warning') {
                background = 'linear-gradient(135deg, #ffc107 0%, #e0a800 100%)';
                shadow = 'rgba(255, 193, 7, 0.3)';
                icon = '‚ö†Ô∏è';
            } else if (tipo === 'info') {
                background = 'linear-gradient(135deg, #17a2b8 0%, #138496 100%)';
                shadow = 'rgba(23, 162, 184, 0.3)';
                icon = '‚ÑπÔ∏è';
            } else {
                background = 'linear-gradient(135deg, #28a745 0%, #20c997 100%)';
                shadow = 'rgba(40, 167, 69, 0.3)';
                icon = '‚úÖ';
            }
            
            notificacao.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${background};
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 15px ${shadow};
                z-index: 3000;
                animation: slideInRight 0.3s ease-out;
                font-size: 14px;
                font-weight: 500;
                max-width: 400px;
                word-wrap: break-word;
            `;
            
            notificacao.innerHTML = `<span style="margin-right: 8px;">${icon}</span>${mensagem}`;
            document.body.appendChild(notificacao);
            
            // Remover ap√≥s 4 segundos para mensagens mais longas
            const tempoExibicao = tipo === 'error' ? 5000 : 4000;
            setTimeout(() => {
                notificacao.style.animation = 'slideOutRight 0.3s ease-in';
                setTimeout(() => {
                    if (document.body.contains(notificacao)) {
                        document.body.removeChild(notificacao);
                    }
                }, 300);
            }, tempoExibicao);
        }



        // Gerar link √∫nico para RNC
        function generateRNCLink() {
            const timestamp = Date.now();
            const randomId = Math.random().toString(36).substring(2, 15);
            const rncNumber = 'RNC' + new Date().getFullYear() + '-' + Math.floor(Math.random() * 1000).toString().padStart(4, '0');
            
            // Em produ√ß√£o, isso seria um link real do sistema
            return `https://ippel.com.br/rnc/${rncNumber}?token=${randomId}&t=${timestamp}`;
        }

        // Mostrar confirma√ß√£o de envio
        function showEmailConfirmation(emailData) {
            const confirmation = document.createElement('div');
            confirmation.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
                color: white;
                padding: 15px 20px;
                border-radius: 10px;
                box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
                z-index: 3000;
                animation: slideInRight 0.3s ease-out;
                max-width: 300px;
            `;
            
            confirmation.innerHTML = `
                <div style="font-weight: 600; margin-bottom: 5px;">‚úÖ Email Enviado!</div>
                <div style="font-size: 0.9rem;">Para: ${emailData.to}</div>
                <div style="font-size: 0.8rem; margin-top: 5px; opacity: 0.9;">
                    Link √∫nico gerado e enviado
                </div>
            `;
            
            document.body.appendChild(confirmation);
            
            // Remover ap√≥s 5 segundos
            setTimeout(() => {
                confirmation.style.animation = 'slideOutRight 0.3s ease-in';
                setTimeout(() => {
                    document.body.removeChild(confirmation);
                }, 300);
            }, 5000);
        }

        // Anima√ß√µes CSS
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideInRight {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOutRight {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
        `;
        document.head.appendChild(style);

        // Fun√ß√£o para carregar dados de uma RNC existente (para edi√ß√£o/visualiza√ß√£o)
        async function loadRncData(rncId) {
            try {
                const response = await fetch(`/api/rnc/get/${rncId}`);
                const data = await response.json();
                
                if (data.success && data.rnc) {
                    const rnc = data.rnc;
                    
                    // Popular campos b√°sicos
                    document.getElementById('title').value = rnc.title || '';
                    document.getElementById('equipment').value = rnc.equipment || '';
                    document.getElementById('client').value = rnc.client || '';
                    document.getElementById('price').value = rnc.price || '';
                    document.getElementById('priority').value = rnc.priority || 'M√©dia';
                    document.getElementById('description').value = rnc.description || '';
                    document.getElementById('rnc_number').value = rnc.rnc_number || '';
                    
                    // Popular checkboxes de disposi√ß√£o
                    document.getElementById('usar').checked = rnc.disposition_usar || false;
                    document.getElementById('retrabalhar').checked = rnc.disposition_retrabalhar || false;
                    document.getElementById('rejeitar').checked = rnc.disposition_rejeitar || false;
                    document.getElementById('sucata').checked = rnc.disposition_sucata || false;
                    document.getElementById('devolver-estoque').checked = rnc.disposition_devolver_estoque || false;
                    document.getElementById('devolver-fornecedor').checked = rnc.disposition_devolver_fornecedor || false;
                    
                    // Popular checkboxes de inspe√ß√£o
                    document.getElementById('aprovado').checked = rnc.inspection_aprovado || false;
                    document.getElementById('reprovado').checked = rnc.inspection_reprovado || false;
                    
                    console.log('Dados carregados com sucesso:', rnc);
                } else {
                    console.error('Erro ao carregar dados:', data.message);
                }
            } catch (error) {
                console.error('Erro ao buscar dados da RNC:', error);
            }
        }

        // Verificar se h√° um ID de RNC na URL para carregar dados
        const urlParams = new URLSearchParams(window.location.search);
        const rncId = urlParams.get('edit') || urlParams.get('view');
        if (rncId) {
            loadRncData(rncId);
        }

        // Preencher datas automaticamente (detec√ß√£o e emiss√£o)
        document.addEventListener('DOMContentLoaded', function() {
            const detectionDateField = document.getElementById('detection_date');
            if (detectionDateField && !detectionDateField.value) {
                const todayISO = new Date().toISOString().split('T')[0];
                detectionDateField.value = todayISO; // yyyy-mm-dd
            }

            const emissaoField = document.getElementById('data_emissao');
            if (emissaoField && !emissaoField.value) {
                const d = new Date();
                const dd = String(d.getDate()).padStart(2,'0');
                const mm = String(d.getMonth()+1).padStart(2,'0');
                const yyyy = d.getFullYear();
                emissaoField.value = `${dd}/${mm}/${yyyy}`; // dd/mm/yyyy
            }
        });
    </script>
</body>
</html>

