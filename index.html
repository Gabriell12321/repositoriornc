
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Relatório De Não Conformidades Internas - RNC</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap');
            
        body {
            font-family: 'Poppins', 'Inter', system-ui, sans-serif;
            background: white !important;
            padding: 0;
            margin: 0;
            min-height: 100vh;
            position: relative;
            overflow-x: hidden;
        }

        .container {
            width: 100vw;
            height: 100vh;
            margin: 0;
            background: white !important;
            padding: 35px;
            border-radius: 0;
            overflow-y: auto;
            position: relative;
        }

        .header {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 15px;
            border-bottom: none;
            padding-bottom: 0;
            position: relative;
        }

        .logos {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            margin: 0 auto;
        }

        .logo-ippel {
            width: 120px;
            height: 120px;
            background: transparent;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 15px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .logo-ippel:hover {
            transform: scale(1.05);
        }



        .title-section {
            text-align: center;
            margin: 20px 0;
        }

        .main-title {
            font-size: 30px;
            font-weight: 800;
            margin-bottom: 15px;
            color: #333 !important;
            letter-spacing: 1.5px;
            position: relative;
            text-align: center;
        }

        .main-title::after {
            display: none !important;
        }

        .main-title::before {
            display: none !important;
        }

        .subtitle {
            font-size: 18px;
            font-weight: 600;
            color: #6c757d;
            letter-spacing: 1.5px;
            margin-top: 8px;
        }

        .form-code {
            position: absolute;
            right: 20px;
            top: 120px;
            font-size: 16px;
            font-weight: bold;
        }

        .rnc-number {
            text-align: right;
            margin: 10px 0;
            font-weight: bold;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 25px;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: none !important;
            position: relative;
            backdrop-filter: none !important;
            transition: all 0.3s ease;
        }

        table:hover {
            transform: none !important;
            box-shadow: none !important;
        }

        table::before {
            display: none !important;
        }

        td, th {
            border: 2px solid #dc3545;
            padding: 8px;
            vertical-align: top;
            font-size: 12px;
            transition: border-color 0.2s ease;
        }

        table:hover td, table:hover th {
            border-color: #c82333;
        }

        .field-label {
            background: #6c757d !important;
            font-weight: 600;
            text-align: left;
            padding: 12px 15px;
            font-size: 12px;
            border: 2px solid #dc3545 !important;
            color: white !important;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .field-label::before {
            display: none !important;
        }

        .field-label:hover::before {
            display: none !important;
        }

        .field-label:hover {
            background: transparent !important;
            border-color: transparent !important;
            transform: none !important;
            box-shadow: none !important;
        }

        .input-field {
            border: 2px solid #dc3545 !important;
            width: 100% !important;
            padding: 6px !important;
            font-size: 12px !important;
            background: #dc3545 !important;
            color: white !important;
            transition: all 0.2s ease !important;
            border-radius: 2px !important;
        }

        .input-field:focus {
            background: #dc3545 !important;
            outline: none !important;
            border: 2px solid #dc3545 !important;
            box-shadow: 0 0 0 4px rgba(220, 53, 69, 0.2) !important;
            transform: translateY(-2px) scale(1.02) !important;
            color: white !important;
        }

        .input-field:hover {
            background-color: #dc3545 !important;
            transform: translateY(-0.5px) !important;
            box-shadow: 0 2px 6px rgba(220, 53, 69, 0.3) !important;
            color: white !important;
        }

        .section-title {
            background: #6c757d !important;
            color: white !important;
            text-align: center;
            font-weight: 700;
            padding: 16px 20px;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            font-size: 13px;
            box-shadow: none !important;
            position: relative;
            overflow: hidden;
            text-shadow: none !important;
        }

        .section-title::before {
            display: none !important;
        }

        .section-title::after {
            display: none !important;
        }

        .section-title:hover::before {
            display: none !important;
        }

        .section-title:hover {
            transform: none !important;
            box-shadow: none !important;
        }

        .large-text-area {
            height: 120px;
            resize: vertical;
        }

        .medium-text-area {
            height: 80px;
            resize: vertical;
        }

        /* CAMPOS DE INPUT BRANCOS (onde você digita) */
        input, select, textarea {
            background: white !important;
            color: #333 !important;
            border: 2px solid #dc3545 !important;
        }

        /* Placeholders em cinza escuro */
        input::placeholder, textarea::placeholder {
            color: #666 !important;
        }

        /* Options dos selects */
        select option {
            background: white !important;
            color: #333 !important;
        }

    /* Campos específicos do formulário */
    #title, #equipment, #client, #priority, #share_groups, #rnc_number {
            background: white !important;
            color: #333 !important;
            border: 2px solid #dc3545 !important;
        }

        /* Textareas */
        textarea.input-field {
            background: white !important;
            color: #333 !important;
            border: 2px solid #dc3545 !important;
        }

        /* TODOS os tipos de input */
        input[type="text"], input[type="email"], input[type="password"], 
        input[type="number"], input[type="date"], input[type="datetime-local"] {
            background: white !important;
            color: #333 !important;
            border: 2px solid #dc3545 !important;
        }

        /* Todos os selects */
        select {
            background: white !important;
            color: #333 !important;
            border: 2px solid #dc3545 !important;
        }

        /* Todos os textareas */
        textarea {
            background: white !important;
            color: #333 !important;
            border: 2px solid #dc3545 !important;
        }

        /* Placeholders */
        ::placeholder {
            color: #666 !important;
        }

        /* Options */
        option {
            background: white !important;
            color: #333 !important;
        }

        /* Classe input-field */
        .input-field {
            background: white !important;
            color: #333 !important;
            border: 2px solid #dc3545 !important;
        }

        /* Campos específicos */
        #assinatura_gerente, #nome_responsavel, #data_emissao, #area_responsavel {
            background: white !important;
            color: #333 !important;
            border: 2px solid #dc3545 !important;
        }

        .checkbox-section {
            display: flex;
            justify-content: space-between;
            gap: 20px;
            margin-top: 15px;
        }

        .checkbox-group {
            flex: 1;
            border: 1px solid #000;
            padding: 8px;
        }

        .checkbox-title {
            font-weight: bold;
            text-align: center;
            margin-bottom: 8px;
            border-bottom: 1px solid #000;
            padding-bottom: 4px;
            font-size: 11px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            margin: 8px 0;
            font-size: 12px;
        }

        .checkbox-item input[type="checkbox"] {
            margin-right: 8px;
            transform: scale(1.0);
            accent-color: black;
        }

        .checkbox-item:hover {
            background-color: transparent;
            border-radius: 0;
            padding: 0;
        }

        .signature-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 15px;
        }

        .signature-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 5px 0;
            font-size: 12px;
        }

        .date-input {
            border: none;
            border-bottom: 1px solid #333;
            text-align: center;
            width: 80px;
            padding: 2px;
            margin: 0 5px;
        }

        .signature-line {
            border-bottom: 1px solid #333;
            flex: 1;
            height: 20px;
        }

        @media print {
            body {
                padding: 0;
                background: white;
            }
            .container {
                box-shadow: none;
                margin: 0;
                max-width: none;
            }
        }

        .item-column {
            width: 80px;
            text-align: center;
            font-weight: bold;
            background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
            color: white;
            vertical-align: middle;
            border-right: 2px solid #dee2e6;
            border: 2px solid #dc3545;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
        }

        /* Barra de ações moderna (fixa no canto inferior direito) */
        .action-bar {
            position: fixed;
            right: 24px;
            bottom: 24px;
            display: flex;
            gap: 12px;
            z-index: 1200;
        }
        .action-btn {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            height: 48px;
            padding: 0 18px;
            border-radius: 9999px;
            border: none;
            cursor: pointer;
            color: #fff;
            font-weight: 600;
            letter-spacing: .2px;
            box-shadow: 0 8px 24px rgba(0,0,0,.15);
            transition: transform .15s ease, box-shadow .2s ease, filter .2s ease;
            backdrop-filter: saturate(120%);
        }
        .action-btn .icon { font-size: 1.1rem; display: inline-flex; }
        .action-btn:hover { transform: translateY(-2px); box-shadow: 0 14px 32px rgba(0,0,0,.18); filter: brightness(1.05); }
        .action-btn:active { transform: translateY(0); }

        /* Específicos */
        .fab-btn { background: linear-gradient(90deg, #dc3545 0%, #b21f35 100%); }
        .dashboard-btn { background: linear-gradient(135deg, #6c757d 0%, #495057 100%); }
        .info-btn { background: linear-gradient(135deg, #17a2b8 0%, #138496 100%); }

        /* Estilos para campos de data modernos */
        .date-input-modern {
            transition: all 0.3s ease !important;
            outline: none !important;
        }

        .date-input-modern:focus {
            border-color: #007bff !important;
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.25) !important;
            transform: scale(1.05) !important;
        }

        .date-input-modern:hover {
            border-color: #495057 !important;
            transform: translateY(-1px) !important;
        }

        .date-input-modern:valid {
            border-color: #28a745 !important;
            background-color: #f8fff8 !important;
        }

        .date-input-modern:invalid {
            border-color: #dc3545 !important;
            background-color: #fff8f8 !important;
        }











        @media (max-width: 700px) {
            .container { padding: 8px 2px; max-width: 100vw; }
            .header { padding: 8px 8px; }
            .action-bar { right: 12px; bottom: 12px; gap: 10px; }
            .action-btn { height: 44px; padding: 0 14px; }
            .action-btn .label { display: none; } /* mostra só o ícone no mobile */
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header with Logo -->
        <div class="header">
            <div class="logos">
                <div class="logo-ippel">
                    <img src="/LOGOSQI.jpg" alt="SQI Logo" style="width: 120px; height: 120px; border-radius: 15px; object-fit: contain; background: transparent; padding: 0; border: none;">
                    </div>
                </div>
            <div style="position: absolute; top: 20px; right: 30px; font-size: 12px; color: #6c757d; font-weight: 500; z-index: 10;"></div>
        </div>

        <!-- Title Section -->
        <div class="title-section">
            <div style="margin-bottom: 10px;">
                <div style="width: 60px; height: 2px; background: transparent !important; margin: 0 auto;"></div>
            </div>
            <div class="main-title">Relatório De Não Conformidades Internas – RNC</div>
            <div class="subtitle">FABRICAÇÃO / RECEBIMENTO</div>
        </div>
        
        <!-- Área do Usuário -->
        <div id="userArea" style="background: transparent !important; color: #333 !important; padding: 15px; border-radius: 10px; margin: 15px 0; border: 1px solid #ccc !important; display: none;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <span style="font-weight: 600; color: #495057;">👤 Usuário: </span>
                    <span id="userName">Carregando...</span>
                    <span style="margin-left: 15px; font-weight: 600; color: #495057;">🏢 Departamento: </span>
                    <span id="userDepartment">Carregando...</span>
                </div>
                <div>
                    <button onclick="logout()" style="background: #dc3545; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-size: 0.9rem;">
                        🚪 Sair
                    </button>
                </div>
            </div>
            <div style="margin-top: 10px;">
                <span style="font-weight: 600; color: #495057;">📊 Meus RNCs: </span>
                <span id="userRNCs">Carregando...</span>
            </div>
        </div>
            <div style="margin-top: 15px;">
                <div style="width: 100px; height: 1px; background: transparent !important; margin: 0 auto;"></div>
        </div>

            <!-- Campos para integração com o sistema -->
            <div style="background: transparent !important; color: #333 !important; padding: 20px; border-radius: 10px; margin: 15px 0; border: 1px solid #ccc !important;">
                <h3 style="color: #8b1538; font-size: 1.1rem; margin-bottom: 20px; text-align: center; font-weight: 700;">📋 INFORMAÇÕES PRINCIPAIS DO RNC</h3>
                
                <!-- Primeira linha de campos -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 20px;">
                    <div>
                        <label style="font-weight: 600; color: #8b1538; font-size: 0.95rem; display: block; margin-bottom: 8px;">📋 Título do RNC *</label>
                        <input type="text" id="title" name="title" placeholder="Ex: Falha no equipamento de produção - Linha A" 
                               style="width: 100%; padding: 10px; border: 2px solid #8b1538; border-radius: 6px; margin-top: 5px; font-size: 14px;">
                        <small style="color: #6c757d; font-size: 0.8rem;">Descreva brevemente o problema identificado</small>
                    </div>
                    <div>
                        <label style="font-weight: 600; color: #8b1538; font-size: 0.95rem; display: block; margin-bottom: 8px;">🔧 Equipamento/Sistema *</label>
                        <input type="text" id="equipment" name="equipment" placeholder="Ex: Linha de montagem A, Máquina X, Sistema Y" 
                               style="width: 100%; padding: 10px; border: 2px solid #8b1538; border-radius: 6px; margin-top: 5px; font-size: 14px;">
                        <small style="color: #6c757d; font-size: 0.8rem;">Identifique o equipamento ou sistema afetado</small>
                    </div>
                    <div>
                        <label style="font-weight: 600; color: #8b1538; font-size: 0.95rem; display: block; margin-bottom: 8px;">🏢 Cliente/Departamento *</label>
                        <select id="client" name="client" 
                                style="width: 100%; padding: 10px; border: 2px solid #8b1538; border-radius: 6px; margin-top: 5px; background: white; color: #333; font-size: 14px;">
                            <option value="" selected disabled>Selecione o cliente</option>
                        </select>
                        <small style="color: #6c757d; font-size: 0.8rem;">Departamento ou cliente responsável</small>
                    </div>
                </div>

                <!-- Segunda linha de campos -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 20px;">
                    <div>
                        <label style="font-weight: 600; color: #8b1538; font-size: 0.95rem; display: block; margin-bottom: 8px;">💲 Custo Estimado (R$)</label>
                        <input type="number" id="price" name="price" step="0.01" min="0" placeholder="0,00"
                               style="width: 100%; padding: 10px; border: 2px solid #8b1538; border-radius: 6px; margin-top: 5px; font-size: 14px;">
                        <small style="color: #6c757d; font-size: 0.8rem;">Custo estimado para correção ou impacto financeiro</small>
                    </div>
                    <div>
                        <label style="font-weight: 600; color: #8b1538; font-size: 0.95rem; display: block; margin-bottom: 8px;">⚡ Nível de Urgência *</label>
                        <select id="priority" name="priority" 
                                style="width: 100%; padding: 10px; border: 2px solid #8b1538; border-radius: 6px; margin-top: 5px; font-size: 14px;">
                            <option value="Baixa">🟢 Baixa - Pode aguardar até 30 dias</option>
                            <option value="Média" selected>🟡 Média - Resolver em até 7 dias</option>
                            <option value="Alta">🟠 Alta - Resolver em até 48 horas</option>
                            <option value="Crítica">🔴 Crítica - Resolver imediatamente</option>
                        </select>
                        <small style="color: #6c757d; font-size: 0.8rem;">Impacto na operação e prazo para resolução</small>
                    </div>
                    <div>
                        <label style="font-weight: 600; color: #8b1538; font-size: 0.95rem; display: block; margin-bottom: 8px;">📅 Data de Detecção</label>
                        <input type="date" id="detection_date" name="detection_date" 
                               style="width: 100%; padding: 10px; border: 2px solid #8b1538; border-radius: 6px; margin-top: 5px; font-size: 14px;">
                        <small style="color: #6c757d; font-size: 0.8rem;">Data em que o problema foi identificado</small>
                    </div>
                </div>

                <!-- Terceira linha de campos -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 20px;">
                    <div>
                        <label style="font-weight: 600; color: #8b1538; font-size: 0.95rem; display: block; margin-bottom: 8px;">🏭 Área/Localização</label>
                        <input type="text" id="location" name="location" placeholder="Ex: Setor de Produção, Galpão 3, Piso 2" 
                               style="width: 100%; padding: 10px; border: 2px solid #8b1538; border-radius: 6px; margin-top: 5px; font-size: 14px;">
                        <small style="color: #6c757d; font-size: 0.8rem;">Local físico onde o problema foi detectado</small>
                    </div>
                    <div>
                        <label style="font-weight: 600; color: #8b1538; font-size: 0.95rem; display: block; margin-bottom: 8px;">👤 Responsável pela Detecção</label>
                        <input type="text" id="detected_by" name="detected_by" placeholder="Nome do funcionário que detectou" 
                               style="width: 100%; padding: 10px; border: 2px solid #8b1538; border-radius: 6px; margin-top: 5px; font-size: 14px;">
                        <small style="color: #6c757d; font-size: 0.8rem;">Quem identificou o problema</small>
                    </div>
                    <div>
                        <label style="font-weight: 600; color: #8b1538; font-size: 0.95rem; display: block; margin-bottom: 8px;">📞 Contato de Emergência</label>
                        <input type="tel" id="emergency_contact" name="emergency_contact" placeholder="(11) 99999-9999" 
                               style="width: 100%; padding: 10px; border: 2px solid #8b1538; border-radius: 6px; margin-top: 5px; font-size: 14px;">
                        <small style="color: #6c757d; font-size: 0.8rem;">Telefone para contato em caso de urgência</small>
                    </div>
                </div>

                <!-- Compartilhamento por grupos -->
                <div style="grid-column: 1 / -1; margin-top: 20px; display: grid; grid-template-columns: 1fr; gap: 20px;">
                    <div>
                        <label style="font-weight: 600; color: #8b1538; font-size: 0.95rem; display: block; margin-bottom: 8px;">👥 Compartilhar com Grupos *</label>
                        <select id="share_groups" name="share_groups" multiple
                                style="width: 100%; padding: 12px; border: 2px solid #8b1538; border-radius: 6px; min-height: 100px; background: white; font-size: 14px;">
                            <option value="">Carregando grupos...</option>
                        </select>
                        <div style="margin-top: 8px; font-size: 0.85rem; color: #6c757d; background: #f8f9fa; padding: 10px; border-radius: 5px; border-left: 4px solid #8b1538;">
                            💡 <strong>Importante:</strong> Selecione os grupos que devem ter acesso a esta RNC. 
                            Eles receberão notificações e poderão acompanhar o progresso da resolução.
                        </div>
                    </div>
                </div>

                <!-- Indicador de campos obrigatórios -->
                <div style="text-align: center; margin-top: 20px; padding: 10px; background: rgba(139, 21, 56, 0.1); border-radius: 5px;">
                    <small style="color: #8b1538; font-weight: 600;">* Campos obrigatórios para criação da RNC</small>
                </div>
            </div>
        </div>

        <!-- Form Code -->
        <div class="form-code">FQ – 002</div>

        <!-- RNC Number -->
        <div class="rnc-number">
            <label style="font-weight: 600; color: #495057; margin-right: 10px;">RNC Nº.:</label>
            <input type="text" id="rnc_number" name="rnc_number" placeholder="Digite o número do RNC" 
                   style="border: 2px solid #8b1538; border-radius: 5px; padding: 8px; width: 200px; font-weight: 600;">
        </div>

        <!-- Main Information Table -->
        <table>
            <tr>
                <td class="field-label" style="width: 40%;">DES.</td>
                <td class="field-label" style="width: 15%;">MP.</td>
                <td class="field-label" style="width: 15%;">REV.</td>
                <td class="field-label" style="width: 15%;">POS.</td>
                <td class="field-label" style="width: 15%;">CV.</td>
            </tr>
            <tr>
                <td><input type="text" id="des_field" class="input-field" placeholder="Descrição"></td>
                <td><input type="text" class="input-field"></td>
                <td><input type="text" class="input-field"></td>
                <td><input type="text" class="input-field"></td>
                <td><input type="text" class="input-field"></td>
            </tr>
        </table>

        <table>
            <tr>
                <td class="field-label" style="width: 50%;">EQUIPAMENTO</td>
                <td class="field-label" style="width: 30%;">CONJUNTO</td>
                <td class="field-label" style="width: 20%;">MOD.</td>
            </tr>
            <tr>
                <td><input type="text" class="input-field"></td>
                <td><input type="text" class="input-field"></td>
                <td><input type="text" class="input-field"></td>
            </tr>
        </table>

        <table>
            <tr>
                <td class="field-label" style="width: 40%;">DESCRIÇÃO DES.</td>
                <td class="field-label" style="width: 20%;">QTDE LOTE</td>
                <td class="field-label" style="width: 20%;">CLIENTE</td>
                <td class="field-label" style="width: 20%;">MATERIAL</td>
            </tr>
            <tr>
                <td><input type="text" class="input-field"></td>
                <td><input type="text" class="input-field"></td>
                <td>
                    <select id="client_inline" class="input-field" style="background: white !important; color:#333 !important;">
                        <option value="" selected disabled>Selecione o cliente</option>
                    </select>
                </td>
                <td><input type="text" class="input-field"></td>
            </tr>
        </table>

        <table>
            <tr>
                <td class="field-label" style="width: 25%;">ASSINATURA GERENTE</td>
                <td class="field-label" style="width: 25%;">ASSINATURA LÍDER SETOR</td>
                <td class="field-label" style="width: 25%;">ORDEM DE COMPRA</td>
                <td class="field-label" style="width: 25%;">NOME RESP.</td>
            </tr>
            <tr>
                <td><input type="text" id="assinatura_gerente" class="input-field"></td>
                <td><input type="text" class="input-field"></td>
                <td><input type="text" class="input-field"></td>
                <td><input type="text" id="nome_responsavel" class="input-field"></td>
            </tr>
        </table>

        <table>
            <tr>
                <td class="field-label" style="width: 35%;">INSPETOR:</td>
                <td class="field-label" style="width: 20%;">DATA EMISSÃO</td>
                <td class="field-label" style="width: 30%;">ÁREA RESPONSÁVEL</td>
                <td class="field-label" style="width: 15%;">ASS. RESP.</td>
            </tr>
            <tr>
                <td><input type="text" class="input-field"></td>
                <td><input type="text" id="data_emissao" class="input-field" placeholder="___/___/______" style="text-align: center;"></td>
                <td><input type="text" id="area_responsavel" class="input-field"></td>
                <td><input type="text" class="input-field"></td>
            </tr>
        </table>

        <!-- Description Section -->
        <table style="margin-bottom: 8px;">
            <tr>
                <td class="item-column">ITEM</td>
                <td class="section-title">DESCRIÇÃO DA NÃO CONFORMIDADE</td>
            </tr>
            <tr>
                <td style="width: 60px;"></td>
                <td><textarea id="description" name="description" class="input-field large-text-area" placeholder="Descreva a não conformidade identificada..."></textarea></td>
            </tr>
        </table>

        <!-- Instruction Section -->
        <table style="margin-bottom: 8px;">
            <tr>
                <td class="item-column">ITEM</td>
                <td class="section-title">INSTRUÇÃO PARA RETRABALHO</td>
            </tr>
            <tr>
                <td style="width: 60px;"></td>
                <td><textarea class="input-field medium-text-area" placeholder="Instruções detalhadas para correção..."></textarea></td>
            </tr>
        </table>

        <!-- Cause Section -->
        <table style="margin-bottom: 8px;">
            <tr>
                <td class="item-column">ITEM</td>
                <td class="section-title">CAUSA DA RNC</td>
            </tr>
            <tr>
                <td style="width: 60px;"></td>
                <td><textarea class="input-field medium-text-area" placeholder="Análise da causa raiz..."></textarea></td>
            </tr>
        </table>

        <!-- Action Section -->
        <table style="margin-bottom: 8px;">
            <tr>
                <td class="item-column">ITEM</td>
                <td class="section-title">AÇÃO A SER TOMADA</td>
            </tr>
            <tr>
                <td style="width: 60px;"></td>
                <td><textarea class="input-field medium-text-area" placeholder="Ações corretivas e preventivas..."></textarea></td>
            </tr>
        </table>

        <!-- Additional Information Section -->
        <table style="margin-bottom: 15px;">
            <tr>
                <td class="item-column">ITEM</td>
                <td class="section-title">INFORMAÇÕES ADICIONAIS</td>
            </tr>
            <tr>
                <td style="width: 60px;"></td>
                <td><textarea class="input-field medium-text-area" placeholder="Observações adicionais, notas ou comentários relevantes..."></textarea></td>
            </tr>
        </table>

        <!-- Header Banner -->
        <div style="width: 100%; background: transparent !important; color: #333 !important; text-align: center; padding: 12px 0; margin-bottom: 0; border-radius: 8px 8px 0 0; font-weight: bold; font-size: 14px; display: flex;">
            <div style="width: 50%; text-align: center; border-right: 2px solid white;">DISPOSIÇÃO DO MATERIAL NÃO-CONFORME</div>
            <div style="width: 50%; text-align: center;">INSPEÇÃO DO RETRABALHO</div>
        </div>

        <!-- Main Content Section -->
        <div style="border: 2px solid #dc3545; border-top: none; border-radius: 0 0 8px 8px; background: white; display: flex;">
            <!-- Left Section: Disposição do Material -->
            <div style="width: 50%; padding: 15px; border-right: 1px solid #dc3545;">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 11px; font-weight: bold;">
                    <div style="display: flex; align-items: center;">
                        <input type="checkbox" id="usar" style="margin-right: 8px; width: 16px; height: 16px; accent-color: #dc3545;">
                        <label for="usar">USAR COMO ESTÁ</label>
                    </div>
                    <div style="display: flex; align-items: center;">
                        <input type="checkbox" id="sucata" style="margin-right: 8px; width: 16px; height: 16px; accent-color: #dc3545;">
                        <label for="sucata">SUCATA</label>
                    </div>
                    <div style="display: flex; align-items: center;">
                        <input type="checkbox" id="retrabalhar" style="margin-right: 8px; width: 16px; height: 16px; accent-color: #dc3545;">
                        <label for="retrabalhar">RETRABALHAR</label>
                    </div>
                    <div style="display: flex; align-items: center;">
                        <input type="checkbox" id="devolver-estoque" style="margin-right: 8px; width: 16px; height: 16px; accent-color: #dc3545;">
                        <label for="devolver-estoque">DEVOLVER AO ESTOQUE</label>
                    </div>
                    <div style="display: flex; align-items: center;">
                        <input type="checkbox" id="rejeitar" style="margin-right: 8px; width: 16px; height: 16px; accent-color: #dc3545;">
                        <label for="rejeitar">REJEITAR</label>
                    </div>
                    <div style="display: flex; align-items: center;">
                        <input type="checkbox" id="devolver-fornecedor" style="margin-right: 8px; width: 16px; height: 16px; accent-color: #dc3545;">
                        <label for="devolver-fornecedor">DEVOLVER AO FORNECEDOR</label>
                </div>
                </div>
            </div>

            <!-- Right Section: Inspeção do Retrabalho -->
            <div style="width: 50%; padding: 15px;">
                <div style="font-size: 11px; font-weight: bold;">
                    <div style="display: flex; align-items: center; margin-bottom: 8px;">
                        <input type="checkbox" id="aprovado" style="margin-right: 8px; width: 16px; height: 16px; accent-color: #28a745;">
                        <label for="aprovado">APROVADO</label>
                    </div>
                    <div style="display: flex; align-items: center; margin-bottom: 8px;">
                        <input type="checkbox" id="reprovado" style="margin-right: 8px; width: 16px; height: 16px; accent-color: #dc3545;">
                        <label for="reprovado">REPROVADO</label>
                    </div>
                    <div style="display: flex; align-items: center;">
                        <input type="checkbox" id="ver-rnc" style="margin-right: 8px; width: 16px; height: 16px; accent-color: #ffc107;">
                        <label for="ver-rnc">VER RNC. Nº:</label>
                        <input type="text" style="border: none; border-bottom: 2px solid #6c757d; width: 120px; margin-left: 8px; font-size: 11px; padding: 2px; background: transparent;">
                    </div>
                </div>
                    </div>
                </div>

        <!-- Signature Section -->
        <div style="margin-top: 15px; border: 2px solid #8b1538; border-radius: 8px; background: white; box-shadow: 0 2px 8px rgba(139, 21, 56, 0.1);">
            <!-- Date Row -->
            <div style="display: flex; border-bottom: 2px solid #8b1538;">
                <div style="width: 33.33%; padding: 12px; text-align: center; font-size: 11px; font-weight: bold; border-right: 2px solid #8b1538; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);">
                    <span style="color: #495057; margin-bottom: 8px; display: block;">INSPEÇÃO:</span>
                    <div style="display: flex; justify-content: center; align-items: center; gap: 4px; margin-top: 8px;">
                        <input type="text" class="date-input-modern" style="width: 24px; height: 28px; text-align: center; font-size: 11px; font-weight: 600; border: 2px solid #6c757d; border-radius: 4px; background: white; color: #333; transition: all 0.3s ease;" placeholder="__" maxlength="2">
                        <span style="color: #6c757d; font-weight: bold;">/</span>
                        <input type="text" class="date-input-modern" style="width: 24px; height: 28px; text-align: center; font-size: 11px; font-weight: 600; border: 2px solid #6c757d; border-radius: 4px; background: white; color: #333; transition: all 0.3s ease;" placeholder="__" maxlength="2">
                        <span style="color: #6c757d; font-weight: bold;">/</span>
                        <input type="text" class="date-input-modern" style="width: 32px; height: 28px; text-align: center; font-size: 11px; font-weight: 600; border: 2px solid #6c757d; border-radius: 4px; background: white; color: #333; transition: all 0.3s ease;" placeholder="____" maxlength="4">
                    </div>
                </div>
                <div style="width: 33.33%; padding: 12px; text-align: center; font-size: 11px; font-weight: bold; border-right: 2px solid #8b1538; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);">
                    <span style="color: #495057; margin-bottom: 8px; display: block;">ENGENHARIA:</span>
                    <div style="display: flex; justify-content: center; align-items: center; gap: 4px; margin-top: 8px;">
                        <input type="text" class="date-input-modern" style="width: 24px; height: 28px; text-align: center; font-size: 11px; font-weight: 600; border: 2px solid #6c757d; border-radius: 4px; background: white; color: #333; transition: all 0.3s ease;" placeholder="__" maxlength="2">
                        <span style="color: #6c757d; font-weight: bold;">/</span>
                        <input type="text" class="date-input-modern" style="width: 24px; height: 28px; text-align: center; font-size: 11px; font-weight: 600; border: 2px solid #6c757d; border-radius: 4px; background: white; color: #333; transition: all 0.3s ease;" placeholder="__" maxlength="2">
                        <span style="color: #6c757d; font-weight: bold;">/</span>
                        <input type="text" class="date-input-modern" style="width: 32px; height: 28px; text-align: center; font-size: 11px; font-weight: 600; border: 2px solid #6c757d; border-radius: 4px; background: white; color: #333; transition: all 0.3s ease;" placeholder="____" maxlength="4">
                    </div>
                </div>
                <div style="width: 33.33%; padding: 12px; text-align: center; font-size: 11px; font-weight: bold; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);">
                    <span style="color: #495057; margin-bottom: 8px; display: block;">INSPEÇÃO:</span>
                    <div style="display: flex; justify-content: center; align-items: center; gap: 4px; margin-top: 8px;">
                        <input type="text" class="date-input-modern" style="width: 24px; height: 28px; text-align: center; font-size: 11px; font-weight: 600; border: 2px solid #6c757d; border-radius: 4px; background: white; color: #333; transition: all 0.3s ease;" placeholder="__" maxlength="2">
                        <span style="color: #6c757d; font-weight: bold;">/</span>
                        <input type="text" class="date-input-modern" style="width: 24px; height: 28px; text-align: center; font-size: 11px; font-weight: 600; border: 2px solid #6c757d; border-radius: 4px; background: white; color: #333; transition: all 0.3s ease;" placeholder="__" maxlength="2">
                        <span style="color: #6c757d; font-weight: bold;">/</span>
                        <input type="text" class="date-input-modern" style="width: 32px; height: 28px; text-align: center; font-size: 11px; font-weight: 600; border: 2px solid #6c757d; border-radius: 4px; background: white; color: #333; transition: all 0.3s ease;" placeholder="____" maxlength="4">
                    </div>
                </div>
            </div>

            <!-- Signature Row -->
            <div style="display: flex;">
                <div id="assinatura_coluna1" style="width: 33.33%; padding: 15px; text-align: center; font-size: 11px; font-weight: bold; border-right: 2px solid #ccc !important; background: transparent !important; color: #333 !important; cursor: pointer;" onclick="preencherAssinatura(this)">
                    <div id="nome_coluna1" style="margin-bottom: 25px;">NOME</div>
                    <div style="border-top: 1px solid #6c757d; padding-top: 8px;">VISTO</div>
                </div>
                <div id="assinatura_coluna2" style="width: 33.33%; padding: 15px; text-align: center; font-size: 11px; font-weight: bold; border-right: 2px solid #ccc !important; background: transparent !important; color: #333 !important; cursor: pointer;" onclick="preencherAssinatura(this)">
                    <div id="nome_coluna2" style="margin-bottom: 25px;">NOME</div>
                    <div style="border-top: 1px solid #6c757d; padding-top: 8px;">VISTO</div>
                </div>
                <div id="assinatura_coluna3" style="width: 33.33%; padding: 15px; text-align: center; font-size: 11px; font-weight: bold; background: transparent !important; color: #333 !important; cursor: pointer;" onclick="preencherAssinatura(this)">
                    <div id="nome_coluna3" style="margin-bottom: 25px;">NOME</div>
                    <div style="border-top: 1px solid #6c757d; padding-top: 8px;">VISTO</div>
                </div>
            </div>
        </div>
    </div>

    <script>
    // Conjunto de usuários excluídos da lista de responsáveis (assignee)
    let EXCLUDED_ASSIGNEE_IDS = new Set();
        // Auto-resize textareas
        document.querySelectorAll('textarea').forEach(textarea => {
            textarea.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = this.scrollHeight + 'px';
            });
        });

        // Configurar campos de data com validação e formatação
        document.addEventListener('DOMContentLoaded', function() {
            const camposData = document.querySelectorAll('.date-input-modern');
            
            camposData.forEach(input => {
                // Event listener para formatação automática
                input.addEventListener('input', function() {
                    formatarDataAutomatica(this);
                });
                
                // Event listener para validação ao perder foco
                input.addEventListener('blur', function() {
                    if (this.value.trim() !== '') {
                        aplicarValidacaoVisual(this);
                    }
                });
                
                // Event listener para tecla Enter (próximo campo)
                input.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        const proximoCampo = this.parentNode.nextElementSibling?.querySelector('input') || 
                                           this.parentNode.parentNode.nextElementSibling?.querySelector('input');
                        if (proximoCampo) {
                            proximoCampo.focus();
                        }
                    }
                });
                
                // Event listener para tecla Tab (navegação)
                input.addEventListener('keydown', function(e) {
                    if (e.key === 'Tab') {
                        // Permitir navegação normal com Tab
                        return;
                    }
                });

                // Adicionar efeito de foco visual
                input.addEventListener('focus', function() {
                    this.style.transform = 'scale(1.05)';
                });

                input.addEventListener('blur', function() {
                    this.style.transform = 'scale(1)';
                });
            });
        });

        // Add current date to date fields when clicked
        document.querySelectorAll('.date-input').forEach(input => {
            input.addEventListener('focus', function() {
                if (!this.value) {
                    const now = new Date();
                    const day = now.getDate().toString().padStart(2, '0');
                    const month = (now.getMonth() + 1).toString().padStart(2, '0');
                    const year = now.getFullYear();
                    
                    if (this.placeholder === '___') {
                        // Check if it's day or month field based on position
                        const siblings = Array.from(this.parentNode.querySelectorAll('.date-input'));
                        const index = siblings.indexOf(this);
                        if (index === 0) {
                            this.value = day;
                        } else if (index === 1) {
                            this.value = month;
                        }
                    } else if (this.placeholder === '______') {
                        this.value = year;
                    }
                    }
                });
            });

        // Print functionality
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.key === 'p') {
                e.preventDefault();
                window.print();
            }
        });

        // Form validation
        function validateForm() {
            const requiredFields = document.querySelectorAll('input[required], textarea[required]');
            let isValid = true;
            
            requiredFields.forEach(field => {
                if (!field.value.trim()) {
                    field.style.borderColor = 'red';
                    isValid = false;
                        } else {
                    field.style.borderColor = '';
                }
            });
            
            return isValid;
        }

        // Save form data to localStorage
        function saveFormData() {
            const formData = {};
            document.querySelectorAll('input, textarea, select').forEach(field => {
                if (field.type === 'checkbox') {
                    formData[field.id] = field.checked;
                } else {
                    formData[field.name || field.id] = field.value;
                }
            });
            localStorage.setItem('rncFormData', JSON.stringify(formData));
        }

        // Load form data from localStorage
        function loadFormData() {
            const savedData = localStorage.getItem('rncFormData');
            if (savedData) {
                const formData = JSON.parse(savedData);
                Object.keys(formData).forEach(key => {
                    const field = document.getElementById(key) || document.querySelector(`[name="${key}"]`);
                    if (field) {
                        if (field.type === 'checkbox') {
                            field.checked = formData[key];
                        } else {
                            field.value = formData[key];
                        }
                    }
                });
            }
        }

        // Auto-save form data on input
        document.addEventListener('input', saveFormData);
        document.addEventListener('change', saveFormData);

        // Load saved data on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadFormData();
            loadUserInfo();
            loadClientsIntoSelects();
        });

        // Função para carregar informações do usuário
        async function loadUserInfo() {
            try {
                const response = await fetch('/api/user/info');
                const data = await response.json();
                
                if (data.success) {
                    // Mostrar área do usuário
                    document.getElementById('userArea').style.display = 'block';
                    
                    // Preencher informações
                    document.getElementById('userName').textContent = data.user.name;
                    document.getElementById('userDepartment').textContent = data.user.department;
                    
                    // Preencher automaticamente os campos de assinatura
                    const assinaturaGerente = document.getElementById('assinatura_gerente');
                    const nomeResponsavel = document.getElementById('nome_responsavel');
                    
                    if (assinaturaGerente && !assinaturaGerente.value) {
                        assinaturaGerente.value = data.user.name;
                    }
                    
                    if (nomeResponsavel && !nomeResponsavel.value) {
                        nomeResponsavel.value = data.user.name;
                    }
                    
                    // Preencher data de emissão automaticamente
                    const dataEmissao = document.getElementById('data_emissao');
                    if (dataEmissao && !dataEmissao.value) {
                        const hoje = new Date();
                        const dia = hoje.getDate().toString().padStart(2, '0');
                        const mes = (hoje.getMonth() + 1).toString().padStart(2, '0');
                        const ano = hoje.getFullYear();
                        dataEmissao.value = `${dia}/${mes}/${ano}`;
                    }
                    
                    // Preencher área responsável automaticamente
                    const areaResponsavel = document.getElementById('area_responsavel');
                    if (areaResponsavel && !areaResponsavel.value) {
                        areaResponsavel.value = data.user.department;
                    }
                    
                    // Carregar RNCs do usuário
                    loadUserRNCs();
                } else {
                    // Se não estiver logado, redirecionar para login
                    window.location.href = '/';
                }
            } catch (error) {
                console.error('Erro ao carregar informações do usuário:', error);
                // Se não conseguir conectar, redirecionar para login
                window.location.href = '/';
            }
        }

        // Função para carregar RNCs do usuário
        async function loadUserRNCs() {
            try {
                const response = await fetch('/api/rnc/list');
                const data = await response.json();
                
                if (data.success) {
                    const rncCount = data.rncs.length;
                    document.getElementById('userRNCs').textContent = `${rncCount} RNC(s) criado(s)`;
                } else {
                    document.getElementById('userRNCs').textContent = 'Erro ao carregar RNCs';
                }
            } catch (error) {
                console.error('Erro ao carregar RNCs:', error);
                document.getElementById('userRNCs').textContent = 'Erro ao carregar RNCs';
            }
        }

        // Função para logout
        function logout() {
            fetch('/api/logout')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        window.location.href = '/';
                    }
                })
                .catch(error => {
                    console.error('Erro no logout:', error);
                    window.location.href = '/';
                });
        }

        // Carregar clientes e preencher selects (cliente principal e linha de tabela)
        async function loadClientsIntoSelects(){
            const sel1 = document.getElementById('client');
            const sel2 = document.getElementById('client_inline');
            const applyOptions = (list)=>{
                const opts = ['<option value="" disabled selected>Selecione o cliente</option>']
                    .concat(list.map(n=>`<option value="${n.replace(/"/g,'&quot;')}">${n}</option>`))
                    .join('');
                if(sel1) sel1.innerHTML = opts;
                if(sel2) sel2.innerHTML = opts;
            };

            // 1) Tenta via API autenticada
            try{
                const resp = await fetch('/api/clients', {credentials:'include'});
                if(resp.ok){
                    const data = await resp.json();
                    if(data && data.success && Array.isArray(data.clients)){
                        applyOptions(data.clients);
                        return;
                    }
                }
            }catch(_){ /* segue para fallback */ }

            // 2) Fallback: ler arquivo TXT local (sem depender de login)
            try{
                const txtPath = 'ARQUIVOS PARA PUXAR INFORMAÇÕES PARA O PAINEL/clientescadastro.txt';
                const resp2 = await fetch(txtPath);
                if(resp2.ok){
                    const text = await resp2.text();
                    const lines = text.split(/\r?\n/).map(l=>l.trim()).filter(l=>l && l.toLowerCase()!=='cliente');
                    const seen = new Set();
                    const list = [];
                    for(const name of lines){ const k=name.toLowerCase(); if(!seen.has(k)){ seen.add(k); list.push(name);} }
                    if(list.length){ applyOptions(list); return; }
                }
            }catch(e){ console.warn('Fallback TXT falhou:', e); }

            // 3) Sem dados: mantém placeholder apenas
            applyOptions([]);
        }
    </script>

    <!-- Barra de ações moderna -->
    <div class="action-bar">
        <button class="action-btn dashboard-btn" title="Voltar ao Dashboard" onclick="window.location.href='/dashboard'">
            <span class="icon">🏠</span>
            <span class="label">Dashboard</span>
        </button>
        <button class="action-btn fab-btn" title="Salvar RNC" onclick="saveRNCToSystem()">
            <span class="icon">💾</span>
            <span class="label">Salvar RNC</span>
        </button>
    </div>



    <script>


        // Função para carregar grupos no select
        async function loadGroups() {
            try {
                const response = await fetch('/api/admin/groups');
                const data = await response.json();
                
                if (data.success) {
                    const select = document.getElementById('share_groups');
                    select.innerHTML = '<option value="">Selecione grupos para compartilhar...</option>';
                    
                    if (data.groups.length === 0) {
                        select.innerHTML = '<option value="">Nenhum grupo disponível</option>';
                        return;
                    }
                    
                    data.groups.forEach(group => {
                        const option = document.createElement('option');
                        option.value = group.id;
                        option.textContent = `📋 ${group.name} (${group.user_count} usuários)`;
                        option.title = `Grupo: ${group.name} - ${group.user_count} usuários`;
                        select.appendChild(option);
                    });
                    
                                         // Adicionar evento para mostrar grupos selecionados
             select.addEventListener('change', function() {
                         const selectedOptions = Array.from(this.selectedOptions);
                         if (selectedOptions.length > 0) {
                             const selectedText = selectedOptions.map(opt => opt.textContent.replace('📋 ', '')).join(', ');
                             console.log(`Grupos selecionados: ${selectedText}`);
                             
                             // Mostrar preview dos grupos selecionados
                             showSelectedGroupsPreview(selectedOptions);
                 // Filtrar usuários do responsável conforme os grupos
                 updateAssigneeOptionsForGroups();
                         } else {
                             hideSelectedGroupsPreview();
                 // Sem grupos selecionados, volta para a lista completa de usuários
                 loadUsers();
                         }
                     });
                    
                } else {
                    console.error('Erro na resposta:', data.message);
                    document.getElementById('share_groups').innerHTML = '<option value="">Erro ao carregar grupos</option>';
                }
            } catch (error) {
                console.error('Erro ao carregar grupos:', error);
                document.getElementById('share_groups').innerHTML = '<option value="">Erro ao carregar grupos</option>';
            }
        }
        

        // Atualiza usuários com base nos grupos selecionados
        async function updateAssigneeOptionsForGroups() {
            const userSelect = null;
            const groupsEl = document.getElementById('share_groups');
            if (!userSelect || !groupsEl) return;

            const selectedGroupIds = Array.from(groupsEl.selectedOptions).map(o => o.value).filter(v => v);
            if (selectedGroupIds.length === 0) { await loadUsers(); return; }

            try {
                const promises = selectedGroupIds.map(id => fetch(`/api/admin/groups/${id}/users`, { credentials: 'include' }).then(r => r.json()).catch(()=>({success:false, users:[]})));
                const results = await Promise.all(promises);
                const byId = new Map();
                for (const res of results) {
                    if (res && res.success && Array.isArray(res.users)) {
                        res.users.forEach(u => { if (!byId.has(u.id)) byId.set(u.id, u); });
                    }
                }
                const usersAll = Array.from(byId.values()).sort((a,b)=>a.name.localeCompare(b.name,'pt-BR'));
                const users = usersAll.filter(u => !EXCLUDED_ASSIGNEE_IDS.has(String(u.id)));
                userSelect.innerHTML = '<option value="">Todos os usuários</option>' +
                    '<option value="">— Não atribuir —</option>' +
                    users.map(u=>`<option value="${u.id}">👤 ${u.name} ${u.department? '('+u.department+')':''}</option>`).join('');
                userSelect.value = '';

                // Renderiza preview de usuários dos grupos selecionados
                renderGroupUsersPreview(usersAll);
            } catch (err) {
                console.error('Erro ao filtrar usuários por grupos:', err);
            }
        }

        // Mostra/atualiza preview de usuários dos grupos selecionados
        function renderGroupUsersPreview(users) {
            clearGroupUsersPreview();
            const container = document.createElement('div');
            container.id = 'group-users-preview';
            container.style.cssText = `
                margin-top: 8px;
                padding: 8px 12px;
                background: #f8f9fa;
                border: 1px solid rgba(139, 21, 56, 0.3);
                border-radius: 5px;
                font-size: 0.85rem;
                color: #495057;
            `;
            const header = `<div style="margin-bottom: 6px; font-weight: 600; display:flex; align-items:center; justify-content:space-between;">
                <span>👤 Usuários dos grupos selecionados (${users.length}):</span>
                <a href="#" id="clear-exclusions" style="font-size:0.8rem; color:#8b1538; text-decoration:underline; ${EXCLUDED_ASSIGNEE_IDS.size? '':'display:none;'}">Limpar exclusões</a>
            </div>`;
            const chips = users.length
                ? users.map(u => {
                    const excluded = EXCLUDED_ASSIGNEE_IDS.has(String(u.id));
                    return `<span data-user-id="${u.id}" style="display:inline-flex; align-items:center; gap:6px; background:${excluded? 'rgba(139,21,56,0.15)':'rgba(139,21,56,0.08)'}; border:1px solid rgba(139,21,56,0.25); color:#8b1538; padding:2px 8px; border-radius:12px; margin:2px;">
                        <span>${u.name}${u.department? ' • '+u.department:''}</span>
                        <button type="button" class="chip-remove" data-user-id="${u.id}" aria-label="Remover" title="Remover" style="cursor:pointer; border:none; background:transparent; color:#8b1538; font-weight:bold;">×</button>
                    </span>`;
                }).join('')
                : '<em>Nenhum usuário encontrado nos grupos selecionados.</em>';
            container.innerHTML = header + chips;

            const select = document.getElementById('share_groups');
            if (select && select.parentNode) {
                // Insere após o select (ou substitui se já existir)
                select.parentNode.insertBefore(container, select.nextSibling);
            }

            const clearLink = container.querySelector('#clear-exclusions');
            if (clearLink) {
                clearLink.addEventListener('click', function(e){
                    e.preventDefault();
                    EXCLUDED_ASSIGNEE_IDS.clear();
                    updateAssigneeOptionsForGroups();
                });
            }
            // Delegação: remover usuário (X)
            container.addEventListener('click', function(e){
                const btn = e.target.closest('.chip-remove');
                if (btn && btn.dataset.userId) {
                    excludeAssignee(btn.dataset.userId);
                }
            });
        }

        function clearGroupUsersPreview() {
            const existing = document.getElementById('group-users-preview');
            if (existing && existing.parentNode) existing.parentNode.removeChild(existing);
        }

        // Exclui um usuário específico da lista de possíveis responsáveis (assignee)
        function excludeAssignee(userId) {
            if (!userId) return;
            EXCLUDED_ASSIGNEE_IDS.add(String(userId));
            updateAssigneeOptionsForGroups();
        }

        // Função para salvar RNC no sistema
        function saveRNCToSystem() {
            // Coletar dados do formulário
            const shareGroupsSelect = document.getElementById('share_groups');
            const selectedGroupIds = Array.from(shareGroupsSelect.selectedOptions)
                .map(option => option.value)
                .filter(value => value !== '');

            const formData = {
                title: document.getElementById('title').value || 'RNC sem título',
                description: document.getElementById('description').value || '',
                equipment: document.getElementById('equipment').value || '',
                client: document.getElementById('client').value || '',
                priority: document.getElementById('priority').value || 'Média',
                price: (function () { const v = (document.getElementById('price').value || '').replace(',', '.'); return v ? parseFloat(v) : 0; })(),
                location: document.getElementById('location').value || '',
                detected_by: document.getElementById('detected_by').value || '',
                emergency_contact: document.getElementById('emergency_contact').value || '',
                detection_date: document.getElementById('detection_date').value || new Date().toISOString().split('T')[0],
                shared_group_ids: selectedGroupIds,
                assinatura1: document.getElementById('nome_coluna1').textContent,
                assinatura2: document.getElementById('nome_coluna2').textContent,
                assinatura3: document.getElementById('nome_coluna3').textContent
            };

            // Função para verificar se há pelo menos uma assinatura
            function verificarAssinaturas() {
                const assinaturas = [
                    document.getElementById('nome_coluna1').textContent,
                    document.getElementById('nome_coluna2').textContent,
                    document.getElementById('nome_coluna3').textContent
                ];
                
                return assinaturas.some(assinatura => assinatura && assinatura !== 'NOME' && assinatura.trim() !== '');
            }

            // Validar dados obrigatórios
            if (!formData.title || !formData.description || !formData.equipment || !formData.client) {
                const camposFaltando = [];
                if (!formData.title) camposFaltando.push('Título');
                if (!formData.description) camposFaltando.push('Descrição');
                if (!formData.equipment) camposFaltando.push('Equipamento');
                if (!formData.client) camposFaltando.push('Cliente');
                
                mostrarNotificacao(`❌ Campos obrigatórios não preenchidos: ${camposFaltando.join(', ')}`, 'error');
                return;
            }

            // Validar grupos compartilhados
            if (formData.shared_group_ids.length === 0) {
                mostrarNotificacao('❌ Por favor, selecione pelo menos um grupo para compartilhar o RNC.', 'error');
                return;
            }
            
            // Verificar se selecionou apenas o placeholder
            if (formData.shared_group_ids.includes('')) {
                mostrarNotificacao('❌ Por favor, selecione grupos válidos (não apenas o placeholder).', 'error');
                return;
            }

            // Validar assinatura obrigatória
            if (!verificarAssinaturas()) {
                mostrarNotificacao('❌ É obrigatório preencher pelo menos uma assinatura!', 'error');
                return;
            }

            // Mostrar loading
            const saveBtn = document.querySelector('.fab-btn');
            const originalText = saveBtn.innerHTML;
            saveBtn.innerHTML = '⏳ Salvando...';
            saveBtn.disabled = true;

            // Enviar para API
            const base = window.location.origin.replace(/^https:/, 'http:');
            fetch(base + '/api/rnc/create', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(formData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Mostrar confirmação
                    showSaveConfirmation(data);
                    
                    // Limpar formulário
                    clearForm();
                    
                    // Salvar no localStorage
                    saveFormData();
                    
                    // Atualizar área do usuário
                    loadUserRNCs();
                    
                    // Redirecionar para o dashboard após 2 segundos
                    setTimeout(() => {
                        window.location.href = '/dashboard';
                    }, 2000);
                } else {
                    alert('Erro ao salvar RNC: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Erro:', error);
                alert('Erro ao conectar com o servidor. Verifique se o sistema está rodando.');
            })
            .finally(() => {
                // Restaurar botão
                saveBtn.innerHTML = originalText;
                saveBtn.disabled = false;
            });
        }

        // Função para mostrar confirmação de salvamento
        function showSaveConfirmation(data) {
            const confirmation = document.createElement('div');
            confirmation.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
                color: white;
                padding: 15px 20px;
                border-radius: 10px;
                box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
                z-index: 3000;
                animation: slideInRight 0.3s ease-out;
                max-width: 350px;
            `;
            
            // Obter informações sobre grupos compartilhados
            const selectedGroups = Array.from(document.getElementById('share_groups').selectedOptions)
                .map(option => option.textContent.replace('📋 ', ''))
                .join(', ');
            
            confirmation.innerHTML = `
                <div style="font-weight: 600; margin-bottom: 5px;">✅ RNC Salvo!</div>
                <div style="font-size: 0.9rem;">Número: ${data.rnc_number}</div>
                <div style="font-size: 0.8rem; margin-top: 5px; opacity: 0.9;">
                    👥 Compartilhado com: ${selectedGroups || 'Nenhum grupo'}
                </div>
                <div style="font-size: 0.8rem; margin-top: 5px; opacity: 0.9;">
                    Redirecionando para o dashboard...
                </div>
            `;
            
            document.body.appendChild(confirmation);
            
            // Remover após 5 segundos
            setTimeout(() => {
                confirmation.style.animation = 'slideOutRight 0.3s ease-in';
                setTimeout(() => {
                    document.body.removeChild(confirmation);
                }, 300);
            }, 5000);
        }

        // Função para mostrar preview dos grupos selecionados
        function showSelectedGroupsPreview(selectedOptions) {
            // Remover preview anterior se existir
            hideSelectedGroupsPreview();
            
            const preview = document.createElement('div');
            preview.id = 'groups-preview';
            preview.style.cssText = `
                margin-top: 8px;
                padding: 8px 12px;
                background: rgba(139, 21, 56, 0.1);
                border: 1px solid rgba(139, 21, 56, 0.3);
                border-radius: 5px;
                font-size: 0.8rem;
                color: #f8f9fa;
            `;
            const groupsList = selectedOptions.map(opt => {
                const groupName = opt.textContent.replace('📋 ', '');
                const groupId = opt.value;
                return `<span style="display:inline-flex;align-items:center; gap:6px; background: rgba(139, 21, 56, 0.2); padding: 2px 6px; border-radius: 12px; margin:2px;">
                    <span>${groupName}</span>
                    <button type="button" class="chip-remove-group" data-group-id="${groupId}" aria-label="Remover grupo" title="Remover grupo" style="cursor:pointer; border:none; background:transparent; color:#fff; font-weight:bold;">×</button>
                </span>`;
            }).join('');
            
            preview.innerHTML = `
                <div style="margin-bottom: 3px; font-weight: 600;">👥 Grupos selecionados:</div>
                ${groupsList}
            `;
            
            // Inserir após o select
            const select = document.getElementById('share_groups');
            select.parentNode.insertBefore(preview, select.nextSibling);

            // Delegação: remover grupo (X)
            preview.addEventListener('click', function(e){
                const btn = e.target.closest('.chip-remove-group');
                if (btn && btn.dataset.groupId) {
                    deselectGroup(btn.dataset.groupId);
                }
            });
        }
        
        // Função para esconder preview dos grupos
        function hideSelectedGroupsPreview() {
            const existingPreview = document.getElementById('groups-preview');
            if (existingPreview) {
                existingPreview.remove();
            }
        }

        // Desmarca um grupo a partir do chip (preview)
        function deselectGroup(groupId) {
            const select = document.getElementById('share_groups');
            if (!select) return;
            const opt = Array.from(select.options).find(o => o.value === String(groupId));
            if (opt) {
                opt.selected = false;
                // Dispara o change para atualizar previews e listas
                const event = new Event('change', { bubbles: true });
                select.dispatchEvent(event);
            }
        }

        // Função para limpar formulário
        function clearForm() {
            document.querySelectorAll('input, textarea, select').forEach(field => {
                if (field.type === 'checkbox') {
                    field.checked = false;
                } else {
                    field.value = '';
                }
            });
            
            // Esconder preview dos grupos
            hideSelectedGroupsPreview();
        }

        // Função para carregar informações do usuário
        async function loadUserInfo() {
            try {
                const response = await fetch('/api/user/info');
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('userName').textContent = data.user.name;
                    document.getElementById('userDepartment').textContent = data.user.department;
                    document.getElementById('userArea').style.display = 'block';
                    
                    // Carregar RNCs do usuário
                    loadUserRNCs();
                } else {
                    // Redirecionar para login se não autenticado
                    window.location.href = '/';
                }
            } catch (error) {
                console.error('Erro ao carregar informações do usuário:', error);
                window.location.href = '/';
            }
        }

        // Função para carregar RNCs do usuário
        async function loadUserRNCs() {
            try {
                const response = await fetch('/api/rnc/list');
                const data = await response.json();
                
                if (data.success) {
                    const rncCount = data.rncs.length;
                    const pendingCount = data.rncs.filter(rnc => rnc.status === 'Pendente').length;
                    const completedCount = data.rncs.filter(rnc => rnc.status === 'Concluído').length;
                    
                    document.getElementById('userRNCs').innerHTML = `
                        <span style="color: #28a745;">✅ ${completedCount} concluídos</span> | 
                        <span style="color: #ffc107;">⏳ ${pendingCount} pendentes</span> | 
                        <span style="color: #6c757d;">📊 ${rncCount} total</span>
                    `;
                } else {
                    document.getElementById('userRNCs').textContent = 'Erro ao carregar';
                }
            } catch (error) {
                console.error('Erro ao carregar RNCs:', error);
                document.getElementById('userRNCs').textContent = 'Erro de conexão';
            }
        }

        // Função para logout
        async function logout() {
            try {
                const response = await fetch('/api/logout');
                const data = await response.json();
                
                if (data.success) {
                    window.location.href = '/';
                }
            } catch (error) {
                console.error('Erro no logout:', error);
                window.location.href = '/';
            }
        }

        // Carregar informações do usuário quando a página carregar
        document.addEventListener('DOMContentLoaded', function() {
            loadUserInfo();
            loadGroups(); // Carregar lista de grupos
            
            // Configurar campo RNC Number
            const rncNumberInput = document.getElementById('rnc_number');
            if (rncNumberInput) {
                // Gerar número automático se estiver vazio
                if (!rncNumberInput.value) {
                    rncNumberInput.value = generateRNCNumber();
                }
                
                // Permitir edição manual
                rncNumberInput.addEventListener('focus', function() {
                    if (this.value === generateRNCNumber()) {
                        this.select();
                    }
                });
                
                // Gerar novo número se clicar em "Gerar"
                rncNumberInput.addEventListener('dblclick', function() {
                    this.value = generateRNCNumber();
                });
            }
        });

        // Gerar número do RNC automaticamente
        function generateRNCNumber() {
            const year = new Date().getFullYear();
            const randomNum = Math.floor(Math.random() * 1000).toString().padStart(4, '0');
            return `RNC${year}-${randomNum}`;
        }

        // Função para preencher assinatura automaticamente (com toggle do próprio usuário)
        function preencherAssinatura(elemento) {
            const nomeElement = elemento.querySelector('div[id^="nome_coluna"]');
            
            fetch('/api/user/info')
                .then(response => response.json())
                .then(data => {
                    if (!data.success) {
                        mostrarNotificacao('❌ Erro: Usuário não autenticado', 'error');
                        return;
                    }
                    const nomeUsuario = data.user.name;
                    const departamento = data.user.department;
                    const assinaturaAtual = (nomeElement?.textContent || '').trim();

                    if (assinaturaAtual && assinaturaAtual !== 'NOME') {
                        // Se a assinatura for do próprio usuário, permitir remover
                        if (assinaturaAtual.startsWith(nomeUsuario)) {
                            nomeElement.textContent = 'NOME';
                            // Limpar também as datas quando remover a assinatura
                            limparDatasAssinatura(elemento);
                            mostrarNotificacao('↩️ Assinatura removida (do próprio usuário).');
                        } else {
                            mostrarNotificacao('❌ Assinatura já preenchida por outro usuário.', 'error');
                        }
                        return;
                    }

                    if (nomeElement) {
                        nomeElement.textContent = `${nomeUsuario} (${departamento})`;
                        // Preencher automaticamente as datas da assinatura
                        preencherDatasAssinatura(elemento);
                        elemento.style.transform = 'scale(1.02)';
                        elemento.style.transition = 'transform 0.2s ease';
                        setTimeout(() => { elemento.style.transform = 'scale(1)'; }, 200);
                        mostrarNotificacao('✅ Assinatura e data preenchidas automaticamente!');
                    }
                })
                .catch(error => {
                    console.error('Erro ao buscar informações do usuário:', error);
                    mostrarNotificacao('❌ Erro ao preencher assinatura', 'error');
                });
        }

        // Função para preencher automaticamente as datas da assinatura
        function preencherDatasAssinatura(elemento) {
            const now = new Date();
            const day = now.getDate().toString().padStart(2, '0');
            const month = (now.getMonth() + 1).toString().padStart(2, '0');
            const year = now.getFullYear();
            
            // Identificar qual coluna de assinatura foi clicada
            const colunaId = elemento.id;
            let dataInputs = [];
            
            if (colunaId === 'assinatura_coluna1') {
                // Primeira coluna - INSPEÇÃO (primeira div)
                const primeiraDiv = document.querySelector('div[style*="width: 33.33%"][style*="border-right: 2px solid #8b1538"]');
                if (primeiraDiv) {
                    dataInputs = primeiraDiv.querySelectorAll('.date-input-modern');
                }
            } else if (colunaId === 'assinatura_coluna2') {
                // Segunda coluna - ENGENHARIA (segunda div)
                const segundaDiv = document.querySelectorAll('div[style*="width: 33.33%"][style*="border-right: 2px solid #8b1538"]')[1];
                if (segundaDiv) {
                    dataInputs = segundaDiv.querySelectorAll('.date-input-modern');
                }
            } else if (colunaId === 'assinatura_coluna3') {
                // Terceira coluna - INSPEÇÃO 2 (terceira div)
                const terceiraDiv = document.querySelectorAll('div[style*="width: 33.33%"]:not([style*="border-right"])');
                if (terceiraDiv.length > 0) {
                    dataInputs = terceiraDiv[0].querySelectorAll('.date-input-modern');
                }
            }
            
            // Preencher as datas se encontrou os campos
            if (dataInputs.length >= 3) {
                dataInputs[0].value = day;      // Dia
                dataInputs[1].value = month;    // Mês
                dataInputs[2].value = year;     // Ano
                
                // Marcar os campos como preenchidos e desabilitar edição
                dataInputs.forEach(input => {
                    input.style.backgroundColor = '#f8f9fa';
                    input.style.color = '#495057';
                    input.readOnly = true;
                    input.style.borderBottom = '2px solid #28a745'; // Borda verde para indicar preenchido
                    input.setAttribute('data-original-date', input.value);
                    input.setAttribute('data-locked', 'true');
                });
                
                // Adicionar tooltip informativo
                const tooltip = document.createElement('div');
                tooltip.className = 'date-tooltip';
                tooltip.textContent = `Data preenchida: ${day}/${month}/${year}`;
                tooltip.style.cssText = `
                    position: absolute;
                    background: #28a745;
                    color: white;
                    padding: 5px 10px;
                    border-radius: 5px;
                    font-size: 12px;
                    z-index: 1000;
                    pointer-events: none;
                    opacity: 0;
                    transition: opacity 0.3s;
                `;
                document.body.appendChild(tooltip);
                
                // Mostrar tooltip temporariamente
                setTimeout(() => {
                    tooltip.style.opacity = '1';
                    setTimeout(() => {
                        tooltip.style.opacity = '0';
                        setTimeout(() => {
                            if (document.body.contains(tooltip)) {
                                document.body.removeChild(tooltip);
                            }
                        }, 300);
                    }, 2000);
                }, 100);
                
                console.log(`Datas preenchidas para ${colunaId}: ${day}/${month}/${year}`);
            } else {
                console.log(`Não foi possível encontrar os campos de data para ${colunaId}`);
            }
        }

        // Função para limpar as datas da assinatura
        function limparDatasAssinatura(elemento) {
            const colunaId = elemento.id;
            let dataInputs = [];
            
            if (colunaId === 'assinatura_coluna1') {
                // Primeira coluna - INSPEÇÃO (primeira div)
                const primeiraDiv = document.querySelector('div[style*="width: 33.33%"][style*="border-right: 2px solid #8b1538"]');
                if (primeiraDiv) {
                    dataInputs = primeiraDiv.querySelectorAll('.date-input-modern');
                }
            } else if (colunaId === 'assinatura_coluna2') {
                // Segunda coluna - ENGENHARIA (segunda div)
                const segundaDiv = document.querySelectorAll('div[style*="width: 33.33%"][style*="border-right: 2px solid #8b1538"]')[1];
                if (segundaDiv) {
                    dataInputs = segundaDiv.querySelectorAll('.date-input-modern');
                }
            } else if (colunaId === 'assinatura_coluna3') {
                // Terceira coluna - INSPEÇÃO 2 (terceira div)
                const terceiraDiv = document.querySelectorAll('div[style*="width: 33.33%"]:not([style*="border-right"])');
                if (terceiraDiv.length > 0) {
                    dataInputs = terceiraDiv[0].querySelectorAll('.date-input-modern');
                }
            }
            
            // Limpar e reabilitar os campos
            dataInputs.forEach(input => {
                input.value = '';
                input.style.backgroundColor = 'white';
                input.style.color = '#333';
                input.readOnly = false;
                input.style.borderBottom = '1px solid #000'; // Restaurar borda original
                input.removeAttribute('data-original-date');
                input.removeAttribute('data-locked');
            });
            
            console.log(`Datas limpas para ${colunaId}`);
        }

        // Função para validar data
        function validarData(dia, mes, ano) {
            // Validar ano (entre 2000 e 2100)
            if (ano < 2000 || ano > 2100) {
                return { valido: false, erro: 'Ano deve estar entre 2000 e 2100' };
            }
            
            // Validar mês (1-12)
            if (mes < 1 || mes > 12) {
                return { valido: false, erro: 'Mês deve estar entre 1 e 12' };
            }
            
            // Validar dia baseado no mês
            const diasNoMes = new Date(ano, mes, 0).getDate();
            if (dia < 1 || dia > diasNoMes) {
                return { valido: false, erro: `Dia deve estar entre 1 e ${diasNoMes} para o mês ${mes}` };
            }
            
            // Verificar se não é data futura
            const dataDigitada = new Date(ano, mes - 1, dia);
            const hoje = new Date();
            if (dataDigitada > hoje) {
                return { valido: false, erro: 'Data não pode ser futura' };
            }
            
            return { valido: true };
        }

        // Função para formatar data automaticamente
        function formatarDataAutomatica(input) {
            const valor = input.value.replace(/\D/g, ''); // Remove caracteres não numéricos
            const placeholder = input.placeholder;
            
            if (placeholder === '__') {
                // Campo de dia ou mês
                if (valor.length > 2) {
                    input.value = valor.substring(0, 2);
                }
                
                // Validação específica para dia/mês
                const numero = parseInt(valor);
                if (numero > 31) {
                    input.value = '31';
                }
            } else if (placeholder === '____') {
                // Campo de ano
                if (valor.length > 4) {
                    input.value = valor.substring(0, 4);
                }
            }
            
            // Aplicar validação visual
            aplicarValidacaoVisual(input);
        }

        // Função para aplicar validação visual
        function aplicarValidacaoVisual(input) {
            const valor = input.value.trim();
            
            if (valor === '') {
                input.style.borderBottom = '1px solid #000';
                input.style.backgroundColor = 'white';
                return;
            }
            
            // Verificar se é um campo de data válido
            const numero = parseInt(valor);
            const placeholder = input.placeholder;
            
            if (placeholder === '__') {
                if (numero >= 1 && numero <= 31) {
                    input.style.borderBottom = '2px solid #28a745'; // Verde
                    input.style.backgroundColor = '#f8fff8';
                } else {
                    input.style.borderBottom = '2px solid #dc3545'; // Vermelho
                    input.style.backgroundColor = '#fff8f8';
                }
            } else if (placeholder === '____') {
                if (numero >= 2000 && numero <= 2100) {
                    input.style.borderBottom = '2px solid #28a745'; // Verde
                    input.style.backgroundColor = '#f8fff8';
                } else {
                    input.style.borderBottom = '2px solid #dc3545'; // Vermelho
                    input.style.backgroundColor = '#fff8f8';
                }
            }
        }

        // Função para verificar se todas as datas estão preenchidas
        function verificarDatasCompletas() {
            const todasDatas = document.querySelectorAll('.date-input-modern');
            let datasPreenchidas = 0;
            let datasValidas = 0;
            
            todasDatas.forEach(input => {
                if (input.value.trim() !== '') {
                    datasPreenchidas++;
                    if (input.style.borderColor === '#28a745' || input.style.borderColor === 'rgb(40, 167, 69)') {
                        datasValidas++;
                    }
                }
            });
            
            return {
                preenchidas: datasPreenchidas,
                validas: datasValidas,
                total: todasDatas.length
            };
        }

        // Função para mostrar status das datas
        function mostrarStatusDatas() {
            const status = verificarDatasCompletas();
            const mensagem = `📅 Status das Datas: ${status.preenchidas}/${status.total} preenchidas (${status.validas} válidas)`;
            
            if (status.preenchidas === status.total && status.validas === status.total) {
                mostrarNotificacao(`✅ ${mensagem} - Todas as datas estão válidas!`, 'success');
            } else if (status.preenchidas > 0) {
                mostrarNotificacao(`⚠️ ${mensagem} - Verifique as datas inválidas.`, 'warning');
            } else {
                mostrarNotificacao(`ℹ️ ${mensagem} - Preencha as datas das assinaturas.`, 'info');
            }
        }

        // Função para validar data completa (dia/mês/ano)
        function validarDataCompleta(diaInput, mesInput, anoInput) {
            const dia = parseInt(diaInput.value) || 0;
            const mes = parseInt(mesInput.value) || 0;
            const ano = parseInt(anoInput.value) || 0;
            
            if (dia === 0 || mes === 0 || ano === 0) {
                return { valido: false, erro: 'Todos os campos de data devem ser preenchidos' };
            }
            
            const validacao = validarData(dia, mes, ano);
            if (!validacao.valido) {
                return validacao;
            }
            
            // Verificar se é uma data real (ex: 31/02 não existe)
            const dataTeste = new Date(ano, mes - 1, dia);
            if (dataTeste.getDate() !== dia || dataTeste.getMonth() !== mes - 1 || dataTeste.getFullYear() !== ano) {
                return { valido: false, erro: 'Data inválida (ex: 31/02 não existe)' };
            }
            
            return { valido: true };
        }

        // Função para aplicar validação visual em grupo de datas
        function aplicarValidacaoVisualGrupo(diaInput, mesInput, anoInput) {
            const validacao = validarDataCompleta(diaInput, mesInput, anoInput);
            
            if (validacao.valido) {
                [diaInput, mesInput, anoInput].forEach(input => {
                    input.style.borderBottom = '2px solid #28a745';
                    input.style.backgroundColor = '#f8fff8';
                });
            } else {
                [diaInput, mesInput, anoInput].forEach(input => {
                    input.style.borderBottom = '2px solid #dc3545';
                    input.style.backgroundColor = '#fff8f8';
                });
                
                // Mostrar erro específico
                mostrarNotificacao(`❌ ${validacao.erro}`, 'error');
            }
        }

        // Função para mostrar notificações
        function mostrarNotificacao(mensagem, tipo = 'success') {
            const notificacao = document.createElement('div');
            
            let background, shadow, icon;
            if (tipo === 'error') {
                background = 'linear-gradient(135deg, #dc3545 0%, #c82333 100%)';
                shadow = 'rgba(220, 53, 69, 0.3)';
                icon = '❌';
            } else if (tipo === 'warning') {
                background = 'linear-gradient(135deg, #ffc107 0%, #e0a800 100%)';
                shadow = 'rgba(255, 193, 7, 0.3)';
                icon = '⚠️';
            } else if (tipo === 'info') {
                background = 'linear-gradient(135deg, #17a2b8 0%, #138496 100%)';
                shadow = 'rgba(23, 162, 184, 0.3)';
                icon = 'ℹ️';
            } else {
                background = 'linear-gradient(135deg, #28a745 0%, #20c997 100%)';
                shadow = 'rgba(40, 167, 69, 0.3)';
                icon = '✅';
            }
            
            notificacao.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${background};
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 15px ${shadow};
                z-index: 3000;
                animation: slideInRight 0.3s ease-out;
                font-size: 14px;
                font-weight: 500;
                max-width: 400px;
                word-wrap: break-word;
            `;
            
            notificacao.innerHTML = `<span style="margin-right: 8px;">${icon}</span>${mensagem}`;
            document.body.appendChild(notificacao);
            
            // Remover após 4 segundos para mensagens mais longas
            const tempoExibicao = tipo === 'error' ? 5000 : 4000;
            setTimeout(() => {
                notificacao.style.animation = 'slideOutRight 0.3s ease-in';
                setTimeout(() => {
                    if (document.body.contains(notificacao)) {
                        document.body.removeChild(notificacao);
                    }
                }, 300);
            }, tempoExibicao);
        }



        // Gerar link único para RNC
        function generateRNCLink() {
            const timestamp = Date.now();
            const randomId = Math.random().toString(36).substring(2, 15);
            const rncNumber = 'RNC' + new Date().getFullYear() + '-' + Math.floor(Math.random() * 1000).toString().padStart(4, '0');
            
            // Em produção, isso seria um link real do sistema
            return `https://ippel.com.br/rnc/${rncNumber}?token=${randomId}&t=${timestamp}`;
        }

        // Mostrar confirmação de envio
        function showEmailConfirmation(emailData) {
            const confirmation = document.createElement('div');
            confirmation.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
                color: white;
                padding: 15px 20px;
                border-radius: 10px;
                box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
                z-index: 3000;
                animation: slideInRight 0.3s ease-out;
                max-width: 300px;
            `;
            
            confirmation.innerHTML = `
                <div style="font-weight: 600; margin-bottom: 5px;">✅ Email Enviado!</div>
                <div style="font-size: 0.9rem;">Para: ${emailData.to}</div>
                <div style="font-size: 0.8rem; margin-top: 5px; opacity: 0.9;">
                    Link único gerado e enviado
                </div>
            `;
            
            document.body.appendChild(confirmation);
            
            // Remover após 5 segundos
            setTimeout(() => {
                confirmation.style.animation = 'slideOutRight 0.3s ease-in';
                setTimeout(() => {
                    document.body.removeChild(confirmation);
                }, 300);
            }, 5000);
        }

        // Animações CSS
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideInRight {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOutRight {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
        `;
        document.head.appendChild(style);

        // Função para carregar dados de uma RNC existente (para edição/visualização)
        async function loadRncData(rncId) {
            try {
                const response = await fetch(`/api/rnc/get/${rncId}`);
                const data = await response.json();
                
                if (data.success && data.rnc) {
                    const rnc = data.rnc;
                    
                    // Popular campos básicos
                    document.getElementById('title').value = rnc.title || '';
                    document.getElementById('equipment').value = rnc.equipment || '';
                    document.getElementById('client').value = rnc.client || '';
                    document.getElementById('price').value = rnc.price || '';
                    document.getElementById('priority').value = rnc.priority || 'Média';
                    document.getElementById('description').value = rnc.description || '';
                    document.getElementById('rnc_number').value = rnc.rnc_number || '';
                    
                    // Popular checkboxes de disposição
                    document.getElementById('usar').checked = rnc.disposition_usar || false;
                    document.getElementById('retrabalhar').checked = rnc.disposition_retrabalhar || false;
                    document.getElementById('rejeitar').checked = rnc.disposition_rejeitar || false;
                    document.getElementById('sucata').checked = rnc.disposition_sucata || false;
                    document.getElementById('devolver-estoque').checked = rnc.disposition_devolver_estoque || false;
                    document.getElementById('devolver-fornecedor').checked = rnc.disposition_devolver_fornecedor || false;
                    
                    // Popular checkboxes de inspeção
                    document.getElementById('aprovado').checked = rnc.inspection_aprovado || false;
                    document.getElementById('reprovado').checked = rnc.inspection_reprovado || false;
                    
                    console.log('Dados carregados com sucesso:', rnc);
                } else {
                    console.error('Erro ao carregar dados:', data.message);
                }
            } catch (error) {
                console.error('Erro ao buscar dados da RNC:', error);
            }
        }

        // Verificar se há um ID de RNC na URL para carregar dados
        const urlParams = new URLSearchParams(window.location.search);
        const rncId = urlParams.get('edit') || urlParams.get('view');
        if (rncId) {
            loadRncData(rncId);
        }

        // Preencher data de detecção automaticamente
        document.addEventListener('DOMContentLoaded', function() {
            const detectionDateField = document.getElementById('detection_date');
            if (detectionDateField && !detectionDateField.value) {
                const today = new Date().toISOString().split('T')[0];
                detectionDateField.value = today;
            }
        });
    </script>
</body>
</html>

